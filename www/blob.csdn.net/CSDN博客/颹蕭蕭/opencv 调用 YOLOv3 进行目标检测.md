
# opencv 调用 YOLOv3 进行目标检测 - 颹蕭蕭 - CSDN博客


2019年03月17日 19:15:30[颹蕭蕭](https://me.csdn.net/itnerd)阅读数：217


训练好的模型参数可以在这个脚本文件中找到，这是针对 coco 数据集训练得到的目标检测网络。 Common Objects in COntext 数据集是微软发布的一个大型图像数据集, 专为对象检测、分割、人体关键点检测、语义分割和字幕生成而设计。数据集中的目标种类有 80 个。
[https://github.com/spmallick/learnopencv/blob/master/ObjectDetection-YOLO/getModels.sh](https://github.com/spmallick/learnopencv/blob/master/ObjectDetection-YOLO/getModels.sh)
```bash
# 这是获取模型参数的 shell 脚本，也可以直接在浏览器下载
```
```bash
wget
```
```bash
https://pjreddie.com/media/files/yolov3.weights
```
```bash
wget
```
```bash
https://github.com/pjreddie/darknet/blob/master/cfg/yolov3.cfg?raw
```
```bash
=
```
```bash
true -O ./yolov3.cfg
```
```bash
wget
```
```bash
https://github.com/pjreddie/darknet/blob/master/data/coco.names?raw
```
```bash
=
```
```bash
true -O ./coco.names
```
```python
'''
YOLO demo
'''
```
```python
COLORS
```
```python
=
```
```python
[
```
```python
(
```
```python
255
```
```python
,
```
```python
0
```
```python
,
```
```python
0
```
```python
)
```
```python
for
```
```python
i
```
```python
in
```
```python
range
```
```python
(
```
```python
80
```
```python
)
```
```python
]
```
```python
# 这里所有种类都用蓝色，可以给不同种类用不同颜色
```
```python
with
```
```python
open
```
```python
(
```
```python
'yolo/coco.names'
```
```python
,
```
```python
'r'
```
```python
)
```
```python
as
```
```python
file
```
```python
:
```
```python
# 这是读取所有种类的名字
```
```python
LABELS
```
```python
=
```
```python
file
```
```python
.
```
```python
read
```
```python
(
```
```python
)
```
```python
.
```
```python
splitlines
```
```python
(
```
```python
)
```
```python
args
```
```python
=
```
```python
{
```
```python
"yolo"
```
```python
:
```
```python
"yolo"
```
```python
,
```
```python
#.weights 和 .cfg 文件所在的目录
```
```python
"image"
```
```python
:
```
```python
"animals.jpg"
```
```python
,
```
```python
"confidence"
```
```python
:
```
```python
0.1
```
```python
,
```
```python
# minimum bounding box confidence
```
```python
"threshold"
```
```python
:
```
```python
0.3
```
```python
,
```
```python
# NMS threshold
```
```python
}
```
```python
# derive the paths to the YOLO weights and model configuration
```
```python
weightsPath
```
```python
=
```
```python
os
```
```python
.
```
```python
path
```
```python
.
```
```python
sep
```
```python
.
```
```python
join
```
```python
(
```
```python
[
```
```python
args
```
```python
[
```
```python
"yolo"
```
```python
]
```
```python
,
```
```python
"yolov3.weights"
```
```python
]
```
```python
)
```
```python
configPath
```
```python
=
```
```python
os
```
```python
.
```
```python
path
```
```python
.
```
```python
sep
```
```python
.
```
```python
join
```
```python
(
```
```python
[
```
```python
args
```
```python
[
```
```python
"yolo"
```
```python
]
```
```python
,
```
```python
"yolov3.cfg"
```
```python
]
```
```python
)
```
```python
# load YOLO object detector trained on COCO dataset (80 classes)
```
```python
print
```
```python
(
```
```python
"[INFO] loading YOLO from disk..."
```
```python
)
```
```python
net
```
```python
=
```
```python
cv2
```
```python
.
```
```python
dnn
```
```python
.
```
```python
readNetFromDarknet
```
```python
(
```
```python
configPath
```
```python
,
```
```python
weightsPath
```
```python
)
```
```python
# load our input image and grab its spatial dimensions
```
```python
image
```
```python
=
```
```python
cv2
```
```python
.
```
```python
imread
```
```python
(
```
```python
args
```
```python
[
```
```python
"image"
```
```python
]
```
```python
)
```
```python
(
```
```python
H
```
```python
,
```
```python
W
```
```python
)
```
```python
=
```
```python
image
```
```python
.
```
```python
shape
```
```python
[
```
```python
:
```
```python
2
```
```python
]
```
```python
# determine only the *output* layer names that we need from YOLO
```
```python
ln
```
```python
=
```
```python
net
```
```python
.
```
```python
getLayerNames
```
```python
(
```
```python
)
```
```python
ln
```
```python
=
```
```python
[
```
```python
ln
```
```python
[
```
```python
i
```
```python
[
```
```python
0
```
```python
]
```
```python
-
```
```python
1
```
```python
]
```
```python
for
```
```python
i
```
```python
in
```
```python
net
```
```python
.
```
```python
getUnconnectedOutLayers
```
```python
(
```
```python
)
```
```python
]
```
```python
# construct a blob from the input image and then perform a forward
```
```python
# pass of the YOLO object detector, giving us our bounding boxes and
```
```python
# associated probabilities
```
```python
blob
```
```python
=
```
```python
cv2
```
```python
.
```
```python
dnn
```
```python
.
```
```python
blobFromImage
```
```python
(
```
```python
image
```
```python
,
```
```python
1
```
```python
/
```
```python
255.0
```
```python
,
```
```python
(
```
```python
416
```
```python
,
```
```python
416
```
```python
)
```
```python
,
```
```python
swapRB
```
```python
=
```
```python
True
```
```python
,
```
```python
crop
```
```python
=
```
```python
False
```
```python
)
```
```python
net
```
```python
.
```
```python
setInput
```
```python
(
```
```python
blob
```
```python
)
```
```python
start
```
```python
=
```
```python
time
```
```python
.
```
```python
time
```
```python
(
```
```python
)
```
```python
layerOutputs
```
```python
=
```
```python
net
```
```python
.
```
```python
forward
```
```python
(
```
```python
ln
```
```python
)
```
```python
end
```
```python
=
```
```python
time
```
```python
.
```
```python
time
```
```python
(
```
```python
)
```
```python
# show timing information on YOLO
```
```python
print
```
```python
(
```
```python
"[INFO] YOLO took {:.6f} seconds"
```
```python
.
```
```python
format
```
```python
(
```
```python
end
```
```python
-
```
```python
start
```
```python
)
```
```python
)
```
```python
boxes
```
```python
,
```
```python
confidences
```
```python
,
```
```python
classIDs
```
```python
=
```
```python
[
```
```python
]
```
```python
,
```
```python
[
```
```python
]
```
```python
,
```
```python
[
```
```python
]
```
```python
# loop over each of the layer outputs
```
```python
for
```
```python
output
```
```python
in
```
```python
layerOutputs
```
```python
:
```
```python
# loop over each of the detections
```
```python
for
```
```python
detection
```
```python
in
```
```python
output
```
```python
:
```
```python
# extract the class ID and confidence of the current object detection
```
```python
scores
```
```python
=
```
```python
detection
```
```python
[
```
```python
5
```
```python
:
```
```python
]
```
```python
classID
```
```python
=
```
```python
np
```
```python
.
```
```python
argmax
```
```python
(
```
```python
scores
```
```python
)
```
```python
confidence
```
```python
=
```
```python
scores
```
```python
[
```
```python
classID
```
```python
]
```
```python
# filter out weak predictions by ensuring the detected
```
```python
# probability is greater than the minimum probability
```
```python
if
```
```python
confidence
```
```python
>
```
```python
args
```
```python
[
```
```python
"confidence"
```
```python
]
```
```python
:
```
```python
# scale the bounding box coordinates back relative to the size of the image,
```
```python
# keeping in mind that YOLO actually returns the center (x, y)-coordinates
```
```python
# of the bounding box followed by the boxes' width and height
```
```python
box
```
```python
=
```
```python
detection
```
```python
[
```
```python
0
```
```python
:
```
```python
4
```
```python
]
```
```python
*
```
```python
np
```
```python
.
```
```python
array
```
```python
(
```
```python
[
```
```python
W
```
```python
,
```
```python
H
```
```python
,
```
```python
W
```
```python
,
```
```python
H
```
```python
]
```
```python
)
```
```python
(
```
```python
centerX
```
```python
,
```
```python
centerY
```
```python
,
```
```python
width
```
```python
,
```
```python
height
```
```python
)
```
```python
=
```
```python
box
```
```python
.
```
```python
astype
```
```python
(
```
```python
"int"
```
```python
)
```
```python
# use the center (x, y)-coordinates to derive the top and left corner of the bounding box
```
```python
x
```
```python
=
```
```python
int
```
```python
(
```
```python
centerX
```
```python
-
```
```python
(
```
```python
width
```
```python
/
```
```python
2
```
```python
)
```
```python
)
```
```python
y
```
```python
=
```
```python
int
```
```python
(
```
```python
centerY
```
```python
-
```
```python
(
```
```python
height
```
```python
/
```
```python
2
```
```python
)
```
```python
)
```
```python
# update our list of bounding box coordinates, confidences, and class IDs
```
```python
boxes
```
```python
.
```
```python
append
```
```python
(
```
```python
[
```
```python
x
```
```python
,
```
```python
y
```
```python
,
```
```python
int
```
```python
(
```
```python
width
```
```python
)
```
```python
,
```
```python
int
```
```python
(
```
```python
height
```
```python
)
```
```python
]
```
```python
)
```
```python
confidences
```
```python
.
```
```python
append
```
```python
(
```
```python
float
```
```python
(
```
```python
confidence
```
```python
)
```
```python
)
```
```python
classIDs
```
```python
.
```
```python
append
```
```python
(
```
```python
classID
```
```python
)
```
```python
idxs
```
```python
=
```
```python
cv2
```
```python
.
```
```python
dnn
```
```python
.
```
```python
NMSBoxes
```
```python
(
```
```python
boxes
```
```python
,
```
```python
confidences
```
```python
,
```
```python
args
```
```python
[
```
```python
"confidence"
```
```python
]
```
```python
,
```
```python
args
```
```python
[
```
```python
"threshold"
```
```python
]
```
```python
)
```
```python
# ensure at least one detection exists
```
```python
if
```
```python
len
```
```python
(
```
```python
idxs
```
```python
)
```
```python
>
```
```python
0
```
```python
:
```
```python
# loop over the indexes we are keeping
```
```python
for
```
```python
i
```
```python
in
```
```python
idxs
```
```python
.
```
```python
flatten
```
```python
(
```
```python
)
```
```python
:
```
```python
# extract the bounding box coordinates
```
```python
(
```
```python
x
```
```python
,
```
```python
y
```
```python
)
```
```python
=
```
```python
(
```
```python
boxes
```
```python
[
```
```python
i
```
```python
]
```
```python
[
```
```python
0
```
```python
]
```
```python
,
```
```python
boxes
```
```python
[
```
```python
i
```
```python
]
```
```python
[
```
```python
1
```
```python
]
```
```python
)
```
```python
(
```
```python
w
```
```python
,
```
```python
h
```
```python
)
```
```python
=
```
```python
(
```
```python
boxes
```
```python
[
```
```python
i
```
```python
]
```
```python
[
```
```python
2
```
```python
]
```
```python
,
```
```python
boxes
```
```python
[
```
```python
i
```
```python
]
```
```python
[
```
```python
3
```
```python
]
```
```python
)
```
```python
# draw a bounding box rectangle and label on the image
```
```python
color
```
```python
=
```
```python
[
```
```python
int
```
```python
(
```
```python
c
```
```python
)
```
```python
for
```
```python
c
```
```python
in
```
```python
COLORS
```
```python
[
```
```python
classIDs
```
```python
[
```
```python
i
```
```python
]
```
```python
]
```
```python
]
```
```python
cv2
```
```python
.
```
```python
rectangle
```
```python
(
```
```python
image
```
```python
,
```
```python
(
```
```python
x
```
```python
,
```
```python
y
```
```python
)
```
```python
,
```
```python
(
```
```python
x
```
```python
+
```
```python
w
```
```python
,
```
```python
y
```
```python
+
```
```python
h
```
```python
)
```
```python
,
```
```python
color
```
```python
,
```
```python
2
```
```python
)
```
```python
text
```
```python
=
```
```python
"{}: {:.4f}"
```
```python
.
```
```python
format
```
```python
(
```
```python
LABELS
```
```python
[
```
```python
classIDs
```
```python
[
```
```python
i
```
```python
]
```
```python
]
```
```python
,
```
```python
confidences
```
```python
[
```
```python
i
```
```python
]
```
```python
)
```
```python
cv2
```
```python
.
```
```python
putText
```
```python
(
```
```python
image
```
```python
,
```
```python
text
```
```python
,
```
```python
(
```
```python
x
```
```python
,
```
```python
y
```
```python
-
```
```python
5
```
```python
)
```
```python
,
```
```python
cv2
```
```python
.
```
```python
FONT_HERSHEY_SIMPLEX
```
```python
,
```
```python
0.5
```
```python
,
```
```python
color
```
```python
,
```
```python
2
```
```python
)
```
```python
# show the output image
```
```python
cv2
```
```python
.
```
```python
imshow
```
```python
(
```
```python
"Image"
```
```python
,
```
```python
image
```
```python
)
```
```python
cv2
```
```python
.
```
```python
waitKey
```
```python
(
```
```python
0
```
```python
)
```
结果如下，图片是从网上随便找来的：
![在这里插入图片描述](https://img-blog.csdnimg.cn/20190317190534717.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2l0bmVyZA==,size_16,color_FFFFFF,t_70)
`[INFO] loading YOLO from disk...
[INFO] YOLO took 0.996802 seconds`

