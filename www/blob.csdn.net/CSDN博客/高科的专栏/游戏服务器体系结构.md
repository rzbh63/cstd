
# 游戏服务器体系结构 - 高科的专栏 - CSDN博客

2013年01月05日 22:45:31[高科](https://me.csdn.net/pbymw8iwm)阅读数：875个人分类：[C/C++																](https://blog.csdn.net/pbymw8iwm/article/category/910215)[架构管理																](https://blog.csdn.net/pbymw8iwm/article/category/1219853)[游戏																](https://blog.csdn.net/pbymw8iwm/article/category/1252249)[
							](https://blog.csdn.net/pbymw8iwm/article/category/1219853)
[
																								](https://blog.csdn.net/pbymw8iwm/article/category/910215)


本文描述了一个我所设计的游戏服务器体系结构,其目的是实现游戏服务器的动态负载平衡,将对象从繁忙的服务器转移到相对空闲的服务器中.设计并没有经过具体的测试与验证,仅仅是将自己目前的一些想法记录下来.随着新构思的出现,可能会有所变化.
以下是服务器的逻辑视图,其中忽略了管理和监控模块
--------------------------------------------------------
|逻辑服务|碰撞服务|AOI服务|dateserver|AI|寻路|交易服务|
--------------------------------------------------------
/\      /\        /\      /\      /\  /\     /\
||      ||        ||      ||      ||  ||     ||
\/      \/        \/      \/      \/  \/     \/
---------------------------------------------------------
消息转发层
---------------------------------------------------------
/\
||
\/
------
|gate|
------
/\
||
\/
--------
|client|
--------
具体实现中消息转发层可作为单独的一组服务运行,也可以作为单独的服务器
进程中的单独一层.
目前在我的设计方案中,将其作为进程中的一个服务层实现.
--------------
|  应用层    |
-----------
|数据转发层| |
-----------
|  网络层    |
--------------
各层说明
应用层: 具体应用,例如游戏逻辑,AI,等.
数据转发层:处理消息的路由,将消息投递到正确的套接口发送队列中.
网络层:收发数据.同时支持TCP,UDP等协议.
当接收消息时,无须通过第二层,从网络层直接将接收到的完整消息投递到
应用层中.
发送消息时,从应用层将消息传进数据转发层,并且指定消息通知方式(例如通
过TCP将消息传递到某一台服务器,还是通过udp方式将消息广播出去),由转发层将消息投递到正确的套接口中.
基本消息流如下:
1)客户端发起操作
2)AOI服务,AOI处理的主要是对象的位置信息,以及各对象所关注的其它对象.
以下举例说明几种处理:
对于行走,AOI计算出能观察到此玩家的所有对象然后将这些信息一起打包，转到3.
对于攻击行为,AOI计算出此攻击将影响的对象和可以观察到此次攻击的对象,然后将信息打包，转发到3.
对于仅仅影响自己属性的消息,例如喝血,如果有对象关注你,例如组队.则将关注你对象打包,转发到4.
3)碰撞和校验,根据地图信息，校验操作的合法性，并进一步计算操作所影响对的象.例如对于行走,在没有详细地图信息的AOI中,无法知道玩家之间是否隔了一堵墙,在碰撞和校验中,将把墙另一面的所有对象从可观察对象中去除.当通过校验后,对于行走消息,将玩家的新坐标通知给所有可以观察到的对象,并更新AOI在的玩家坐标.如果是攻击动作,则把所有信息打包,并送往4.
4)逻辑处理.将处理结果通知关注的对象.
对于跨服数据的处理
服务器的设计实现了动态负载平衡,和无缝大地图,以使得在一台服务器上的对象,可以观察到并影响另一台服务器上对象的变化.以下说明跨服攻击,
假设A,与B分别处理两台不同的逻辑服务器SA,SB上.A向B发动进攻,并且已经通过了校验.当B进入A可观察范围内的时候,SB会获得一份A的基本数据的副本,对于这份副本在SB上是只读的.SB计算出此次攻击对A的影响,例如血减少多少,然后将对A的数据更改要求发送到SA.SA实际修改A的数据,并将更新广播出去,所有关注A的服务器都会处理这个更新信息,并做出合适的处理.
对于玩家间的物品交易，买卖，赠送等操作，都将交由交易服务器处理,以实现跨服的交易.
以上仅仅是概要说明,一些详细的设计将会在后续的文章中讨论.


