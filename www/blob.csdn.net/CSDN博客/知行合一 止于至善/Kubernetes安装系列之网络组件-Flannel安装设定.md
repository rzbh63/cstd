
# Kubernetes安装系列之网络组件-Flannel安装设定 - 知行合一 止于至善 - CSDN博客

2019年03月27日 07:46:03[liumiaocn](https://me.csdn.net/liumiaocn)阅读数：88标签：[kubernetes																](https://so.csdn.net/so/search/s.do?q=kubernetes&t=blog)[安装																](https://so.csdn.net/so/search/s.do?q=安装&t=blog)[flannel																](https://so.csdn.net/so/search/s.do?q=flannel&t=blog)[设定																](https://so.csdn.net/so/search/s.do?q=设定&t=blog)[k8s																](https://so.csdn.net/so/search/s.do?q=k8s&t=blog)[
							](https://so.csdn.net/so/search/s.do?q=设定&t=blog)[
																					](https://so.csdn.net/so/search/s.do?q=flannel&t=blog)个人分类：[Kubernetes																](https://blog.csdn.net/liumiaocn/article/category/6328275)
[
																					](https://so.csdn.net/so/search/s.do?q=flannel&t=blog)所属专栏：[深入浅出kubernetes](https://blog.csdn.net/column/details/12761.html)[
							](https://so.csdn.net/so/search/s.do?q=flannel&t=blog)
[
																	](https://so.csdn.net/so/search/s.do?q=安装&t=blog)
[
				](https://so.csdn.net/so/search/s.do?q=kubernetes&t=blog)
[
			](https://so.csdn.net/so/search/s.do?q=kubernetes&t=blog)

这篇文章整理以下Master节点的flannel的安装与设定方法，本文以脚本的方式进行固化，内容仍然放在github的easypack上。
# 整体操作
[https://blog.csdn.net/liumiaocn/article/details/88413428](https://blog.csdn.net/liumiaocn/article/details/88413428)
# flannel的设定文件
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
# cat /etc/flannel/flannel.conf
```
```python
FLANNELD_OPTS
```
```python
=
```
```python
"-etcd-cafile=/etc/ssl/ca/ca.pem \
  -etcd-certfile=/etc/ssl/flannel/flanneld.pem \
  -etcd-keyfile=/etc/ssl/flannel/flanneld-key.pem \
  -etcd-endpoints=https://192.168.163.131:2379 \
  -etcd-prefix=/coreos.com/network \
  -iface=enp0s3 \
  -ip-masq"
```
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
#
```
# Systemd服务配置文件
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
# cat /usr/lib/systemd/system/flanneld.service
```
```python
[
```
```python
Unit
```
```python
]
```
```python
Description
```
```python
=
```
```python
Flanneld Service
Documentation
```
```python
=
```
```python
https://github.com/coreos/flannel
After
```
```python
=
```
```python
network.target
After
```
```python
=
```
```python
network-online.target
Wants
```
```python
=
```
```python
network-online.target
After
```
```python
=
```
```python
etcd.service
Before
```
```python
=
```
```python
docker.service
```
```python
[
```
```python
Service
```
```python
]
```
```python
EnvironmentFile
```
```python
=
```
```python
-/etc/flannel/flannel.conf
ExecStart
```
```python
=
```
```python
/usr/local/bin/flanneld
```
```python
$FLANNELD_OPTS
```
```python
ExecStartPost
```
```python
=
```
```python
/usr/local/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/docker
Restart
```
```python
=
```
```python
on-failure
```
```python
[
```
```python
Install
```
```python
]
```
```python
WantedBy
```
```python
=
```
```python
multi-user.target
RequiredBy
```
```python
=
```
```python
docker.service
```
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
#
```
# 脚本示例
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
# cat step6-install-flannel.sh
```
```python
#!/bin/sh
```
```python
.
```
```python
./install.cfg
```
```python
# set cfssl tools in search path
```
```python
chmod
```
```python
755
```
```python
${ENV_HOME_CFSSL}
```
```python
/*
```
```python
if
```
```python
[
```
```python
$?
```
```python
-ne 0
```
```python
]
```
```python
;
```
```python
then
```
```python
echo
```
```python
"prepare downloaded cfssl tools in
```
```python
${ENV_HOME_CFSSL}
```
```python
in advance"
```
```python
exit
```
```python
fi
```
```python
export
```
```python
PATH
```
```python
=
```
```python
${ENV_HOME_CFSSL}
```
```python
:
```
```python
$PATH
```
```python
mkdir
```
```python
-p
```
```python
${ENV_SSL_FLANNEL_DIR}
```
```python
cd
```
```python
${ENV_SSL_FLANNEL_DIR}
```
```python
if
```
```python
[
```
```python
$?
```
```python
-ne 0
```
```python
]
```
```python
;
```
```python
then
```
```python
echo
```
```python
"failed to create dir :
```
```python
${ENV_SSL_FLANNEL_DIR}
```
```python
"
```
```python
exit
```
```python
fi
```
```python
cat
```
```python
>
```
```python
${ENV_SSL_FLANNEL_CSR}
```
```python
<<
```
```python
EOF
{
  "CN": "
```
```python
${ENV_SSL_FLANNEL_CSR_CN}
```
```python
",
  "hosts": [],
  "key": {
    "algo": "
```
```python
${ENV_SSL_KEY_ALGO}
```
```python
",
    "size":
```
```python
${ENV_SSL_KEY_SIZE}
```
```python
},
  "names": [
    {
      "C": "
```
```python
${ENV_SSL_NAMES_C}
```
```python
",
      "ST": "
```
```python
${ENV_SSL_NAMES_L}
```
```python
",
      "L": "
```
```python
${ENV_SSL_NAMES_ST}
```
```python
",
      "O": "
```
```python
${ENV_SSL_NAMES_O}
```
```python
",
      "OU": "
```
```python
${ENV_SSL_NAMES_OU}
```
```python
"
    }
  ]
}
EOF
```
```python
cfssl gencert -ca
```
```python
=
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_CA_PEM}
```
```python
\
  -ca-key
```
```python
=
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_CA_KEY}
```
```python
\
  -config
```
```python
=
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_CA_CONFIG}
```
```python
\
  -profile
```
```python
=
```
```python
${ENV_SSL_PROFILE_K8S}
```
```python
${ENV_SSL_FLANNEL_CSR}
```
```python
|
```
```python
cfssljson -bare
```
```python
${ENV_SSL_FLANNEL_CERT_PRIFIX}
```
```python
ls
```
```python
${ENV_SSL_FLANNEL_DIR}
```
```python
/*pem
ETCD_ENDPOINTS
```
```python
=
```
```python
`
```
```python
echo
```
```python
$
```
```python
{
```
```python
ENV_ETCD_HOSTS
```
```python
}
```
```python
|
```
```python
awk
```
```python
-v port
```
```python
=
```
```python
$
```
```python
{
```
```python
ENV_ETCD_CLIENT_PORT
```
```python
}
```
```python
-F
```
```python
" "
```
```python
'{
    for(cnt=1; cnt<NF; cnt++){
        printf("https://%s:%s,",
```
```python
$cnt
```
```python
,port);
    }
    printf("https://%s:%s",
```
```python
$cnt
```
```python
,port);
}'
```
```python
`
```
```python
# flannel v0.10 : not support etcd v3
```
```python
ETCDCTL_API
```
```python
=
```
```python
2 etcdctl \
  --endpoints
```
```python
=
```
```python
${ETCD_ENDPOINTS}
```
```python
\
  --ca-file
```
```python
=
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_CA_PEM}
```
```python
\
  --cert-file
```
```python
=
```
```python
${ENV_SSL_FLANNEL_DIR}
```
```python
/
```
```python
${ENV_SSL_FLANNEL_CERT_PRIFIX}
```
```python
.pem \
  --key-file
```
```python
=
```
```python
${ENV_SSL_FLANNEL_DIR}
```
```python
/
```
```python
${ENV_SSL_FLANNEL_CERT_PRIFIX}
```
```python
-key.pem \
```
```python
set
```
```python
${ENV_FLANNEL_ETCD_NETWORK_PREFIX}
```
```python
/config
```
```python
'{"Network":"'
```
```python
${ENV_KUBE_OPT_CLUSTER_IP_RANGE}
```
```python
'", "SubnetLen": 21, "Backend": {"Type": "vxlan"}}'
```
```python
echo
```
```python
-e
```
```python
"\n##  flanneld service"
```
```python
systemctl stop flanneld 2
```
```python
>
```
```python
/dev/null
```
```python
mkdir
```
```python
-p
```
```python
${ENV_FLANNEL_DIR_BIN}
```
```python
${ENV_FLANNEL_DIR_ETC}
```
```python
${ENV_FLANNEL_DIR_RUN}
```
```python
chmod
```
```python
755
```
```python
${ENV_HOME_FLANNEL}
```
```python
/
```
```python
{
```
```python
flanneld,mk-docker-opts.sh
```
```python
}
```
```python
cp
```
```python
-p
```
```python
${ENV_HOME_FLANNEL}
```
```python
/
```
```python
{
```
```python
flanneld,mk-docker-opts.sh
```
```python
}
```
```python
${ENV_FLANNEL_DIR_BIN}
```
```python
if
```
```python
[
```
```python
$?
```
```python
-ne 0
```
```python
]
```
```python
;
```
```python
then
```
```python
echo
```
```python
"please check flanneld binary file and mk-docker-opts.sh existed in
```
```python
${ENV_HOME_FLANNEL}
```
```python
/ or not"
```
```python
exit
```
```python
fi
```
```python
# create flannel configuration file
```
```python
cat
```
```python
>
```
```python
${ENV_FLANNEL_DIR_ETC}
```
```python
/
```
```python
${ENV_FLANNEL_ETC}
```
```python
<<
```
```python
EOF
FLANNELD_OPTS="-etcd-cafile=
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_CA_PEM}
```
```python
\\
  -etcd-certfile=
```
```python
${ENV_SSL_FLANNEL_DIR}
```
```python
/
```
```python
${ENV_SSL_FLANNEL_CERT_PRIFIX}
```
```python
.pem \\
  -etcd-keyfile=
```
```python
${ENV_SSL_FLANNEL_DIR}
```
```python
/
```
```python
${ENV_SSL_FLANNEL_CERT_PRIFIX}
```
```python
-key.pem \\
  -etcd-endpoints=
```
```python
${ETCD_ENDPOINTS}
```
```python
\\
  -etcd-prefix=
```
```python
${ENV_FLANNEL_ETCD_NETWORK_PREFIX}
```
```python
\\
  -iface=
```
```python
${ENV_FLANNEL_OPT_IFACE}
```
```python
\\
  -ip-masq"
EOF
```
```python
# Create flannel service.
```
```python
cat
```
```python
>
```
```python
${ENV_FLANNEL_SERVICE}
```
```python
<<
```
```python
EOF
[Unit]
Description=Flanneld Service
Documentation=https://github.com/coreos/flannel
After=network.target
After=network-online.target
Wants=network-online.target
After=etcd.service
Before=docker.service
[Service]
EnvironmentFile=-
```
```python
${ENV_FLANNEL_DIR_ETC}
```
```python
/
```
```python
${ENV_FLANNEL_ETC}
```
```python
ExecStart=
```
```python
${ENV_FLANNEL_DIR_BIN}
```
```python
/flanneld \
```
```python
$FLANNELD_OPTS
```
```python
ExecStartPost=
```
```python
${ENV_FLANNEL_DIR_BIN}
```
```python
/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d
```
```python
${ENV_FLANNEL_DIR_RUN}
```
```python
/docker
Restart=on-failure
[Install]
WantedBy=multi-user.target
RequiredBy=docker.service
EOF
```
```python
echo
```
```python
-e
```
```python
"\n##  daemon reload service "
```
```python
systemctl daemon-reload
```
```python
echo
```
```python
-e
```
```python
"\n##  start flannel service "
```
```python
systemctl start flanneld
```
```python
echo
```
```python
-e
```
```python
"\n##  enable flannel service "
```
```python
systemctl
```
```python
enable
```
```python
flanneld
```
```python
echo
```
```python
-e
```
```python
"\n##  check  flannel status"
```
```python
systemctl status flanneld
```
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
#
```
# 执行示例
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
# sh step6-install-flannel.sh
```
```python
2019/03/24 13:37:03
```
```python
[
```
```python
INFO
```
```python
]
```
```python
generate received request
2019/03/24 13:37:03
```
```python
[
```
```python
INFO
```
```python
]
```
```python
received CSR
2019/03/24 13:37:03
```
```python
[
```
```python
INFO
```
```python
]
```
```python
generating key: rsa-2048
2019/03/24 13:37:04
```
```python
[
```
```python
INFO
```
```python
]
```
```python
encoded CSR
2019/03/24 13:37:04
```
```python
[
```
```python
INFO
```
```python
]
```
```python
signed certificate with serial number 652274714063907134614492461596477882158874665465
2019/03/24 13:37:04
```
```python
[
```
```python
WARNING
```
```python
]
```
```python
This certificate lacks a
```
```python
"hosts"
```
```python
field. This makes it unsuitable
```
```python
for
```
```python
websites. For
```
```python
more
```
```python
information see the Baseline Requirements
```
```python
for
```
```python
the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum
```
```python
(
```
```python
https://cabforum.org
```
```python
)
```
```python
;
```
```python
specifically, section 10.2.3
```
```python
(
```
```python
"Information Requirements"
```
```python
)
```
```python
.
/etc/ssl/flannel/flanneld-key.pem  /etc/ssl/flannel/flanneld.pem
```
```python
{
```
```python
"Network"
```
```python
:
```
```python
"172.200.0.0/16"
```
```python
,
```
```python
"SubnetLen"
```
```python
:
```
```python
21,
```
```python
"Backend"
```
```python
:
```
```python
{
```
```python
"Type"
```
```python
:
```
```python
"vxlan"
```
```python
}
```
```python
}
```
```python
##  flanneld service
```
```python
##  daemon reload service
```
```python
##  start flannel service
```
```python
##  enable flannel service
```
```python
##  check  flannel status
```
```python
● flanneld.service - Flanneld Service
   Loaded: loaded
```
```python
(
```
```python
/usr/lib/systemd/system/flanneld.service
```
```python
;
```
```python
enabled
```
```python
;
```
```python
vendor preset: disabled
```
```python
)
```
```python
Active: active
```
```python
(
```
```python
running
```
```python
)
```
```python
since Sun 2019-03-24 13:37:04 CST
```
```python
;
```
```python
266ms ago
     Docs: https://github.com/coreos/flannel
 Main PID: 14887
```
```python
(
```
```python
flanneld
```
```python
)
```
```python
CGroup: /system.slice/flanneld.service
           └─14887 /usr/local/bin/flanneld -etcd-cafile
```
```python
=
```
```python
/etc/ssl/ca/ca.pem -etcd-certfile
```
```python
=
```
```python
/etc/ssl/flannel/flanneld.pem -etcd-keyfile
```
```python
=
```
```python
/etc/ssl/flannel/fla
```
```python
..
```
```python
.
Mar 24 13:37:04 host131 systemd
```
```python
[
```
```python
1
```
```python
]
```
```python
: Starting Flanneld Service
```
```python
..
```
```python
.
Mar 24 13:37:04 host131 systemd
```
```python
[
```
```python
1
```
```python
]
```
```python
: Started Flanneld Service.
Mar 24 13:37:04 host131 flanneld
```
```python
[
```
```python
14887
```
```python
]
```
```python
: I0324 13:37:04.868581   14887 main.go:488
```
```python
]
```
```python
Using interface with name enp0s3 and address 192.168.163.131
Mar 24 13:37:04 host131 flanneld
```
```python
[
```
```python
14887
```
```python
]
```
```python
: I0324 13:37:04.868911   14887 main.go:505
```
```python
]
```
```python
Defaulting external address to interface address
```
```python
(
```
```python
192.168.163.131
```
```python
)
```
```python
Mar 24 13:37:04 host131 flanneld
```
```python
[
```
```python
14887
```
```python
]
```
```python
: warning: ignoring ServerName
```
```python
for
```
```python
user-provided CA
```
```python
for
```
```python
backwards compatibility is deprecated
Mar 24 13:37:04 host131 flanneld
```
```python
[
```
```python
14887
```
```python
]
```
```python
: I0324 13:37:04.886022   14887 main.go:235
```
```python
]
```
```python
Created subnet manager: Etcd Local Manager with Previous Subnet: None
Mar 24 13:37:04 host131 flanneld
```
```python
[
```
```python
14887
```
```python
]
```
```python
: I0324 13:37:04.886039   14887 main.go:238
```
```python
]
```
```python
Installing signal handlers
```
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
#
```
flannel设定之后各node节点都会统一管理ip，不同容器之间的互联互通成为可能，当然calico等也是同样作用。

