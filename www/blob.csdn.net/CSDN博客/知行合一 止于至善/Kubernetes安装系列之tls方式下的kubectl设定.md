
# Kubernetes安装系列之tls方式下的kubectl设定 - 知行合一 止于至善 - CSDN博客

2019年03月30日 14:14:37[liumiaocn](https://me.csdn.net/liumiaocn)阅读数：147标签：[k8s																](https://so.csdn.net/so/search/s.do?q=k8s&t=blog)[kubernetes																](https://so.csdn.net/so/search/s.do?q=kubernetes&t=blog)[kubelet																](https://so.csdn.net/so/search/s.do?q=kubelet&t=blog)[kubeconfig																](https://so.csdn.net/so/search/s.do?q=kubeconfig&t=blog)[tls																](https://so.csdn.net/so/search/s.do?q=tls&t=blog)[
							](https://so.csdn.net/so/search/s.do?q=kubeconfig&t=blog)[
																					](https://so.csdn.net/so/search/s.do?q=kubelet&t=blog)个人分类：[Kubernetes																](https://blog.csdn.net/liumiaocn/article/category/6328275)
[
																					](https://so.csdn.net/so/search/s.do?q=kubelet&t=blog)所属专栏：[深入浅出kubernetes](https://blog.csdn.net/column/details/12761.html)[
							](https://so.csdn.net/so/search/s.do?q=kubelet&t=blog)
[
																	](https://so.csdn.net/so/search/s.do?q=kubernetes&t=blog)
[
				](https://so.csdn.net/so/search/s.do?q=k8s&t=blog)
[
			](https://so.csdn.net/so/search/s.do?q=k8s&t=blog)

这篇文章整理一下apiserver的缺省8080端口关闭的方法，以及这种发誓下kubectl的设定方式，本文以脚本的方式进行固化，内容仍然放在github的easypack上。
# 整体操作
[https://blog.csdn.net/liumiaocn/article/details/88413428](https://blog.csdn.net/liumiaocn/article/details/88413428)
# 相关参数
apiserver的insecure-port，缺省值为8080，在后续版本中将会移除，建议先行关闭。
```python
--
```
```python
insecure
```
```python
-
```
```python
port int          The port on which to serve unsecured
```
```python
,
```
```python
unauthenticated access
```
```python
.
```
```python
(
```
```python
default
```
```python
8080
```
```python
)
```
```python
(
```
```python
DEPRECATED
```
```python
:
```
```python
This flag will be removed
```
```python
in
```
```python
a future version
```
```python
.
```
```python
)
```
# insecure方式下的监听进程
使用kubectl cluster-info可以确认到使用的是8080端口
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
# kubectl cluster-info
```
```python
Kubernetes master is running at http://localhost:8080
To further debug and diagnose cluster problems, use
```
```python
'kubectl cluster-info dump'
```
```python
.
```
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
#
```
确认进程状况也会发现kube-apiserver同时在6443（TLS）和8080提供服务。
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
# netstat -tunlp |grep kube-apiserver
```
```python
tcp        0      0 192.168.163.131:6443    0.0.0.0:*               LISTEN      1210/kube-apiserver 
tcp        0      0 127.0.0.1:8080          0.0.0.0:*               LISTEN      1210/kube-apiserver
```
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
#
```
## 关闭8080端口的监听
可以通过`--insecure-port=0`将缺省的8080端口进行关闭。
重新设定并启动apiserver，确认进程状况也会发现kube-apiserver此时只在6443（TLS）提供服务。
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
# netstat -tunlp |grep kube-apiserver
```
```python
tcp        0      0 192.168.163.131:6443    0.0.0.0:*               LISTEN      2739/kube-apiserver
```
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
#
```
执行kubectl也会提示如下错误信息
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
# kubectl version
```
```python
Client Version: version.Info
```
```python
{
```
```python
Major:
```
```python
"1"
```
```python
, Minor:
```
```python
"13"
```
```python
, GitVersion:
```
```python
"v1.13.4"
```
```python
, GitCommit:
```
```python
"c27b913fddd1a6c480c229191a087698aa92f0b1"
```
```python
, GitTreeState:
```
```python
"clean"
```
```python
, BuildDate:
```
```python
"2019-02-28T13:37:52Z"
```
```python
, GoVersion:
```
```python
"go1.11.5"
```
```python
, Compiler:
```
```python
"gc"
```
```python
, Platform:
```
```python
"linux/amd64"
```
```python
}
```
```python
The connection to the server localhost:8080 was refused - did you specify the right host or port?
```
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
#
```
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
# kubectl cluster-info
```
```python
To further debug and diagnose cluster problems, use
```
```python
'kubectl cluster-info dump'
```
```python
.
```
```python
The connection to the server localhost:8080 was refused - did you specify the right host or port?
```
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
#
```
# csr文件
使用如下csr文件创建证书
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
# cat
```
```python
/
```
```python
etc
```
```python
/
```
```python
ssl
```
```python
/
```
```python
ca
```
```python
/
```
```python
admin
```
```python
-
```
```python
csr
```
```python
.
```
```python
json
```
```python
{
```
```python
"CN"
```
```python
:
```
```python
"admin"
```
```python
,
```
```python
"hosts"
```
```python
:
```
```python
[
```
```python
]
```
```python
,
```
```python
"key"
```
```python
:
```
```python
{
```
```python
"algo"
```
```python
:
```
```python
"rsa"
```
```python
,
```
```python
"size"
```
```python
:
```
```python
2048
```
```python
}
```
```python
,
```
```python
"names"
```
```python
:
```
```python
[
```
```python
{
```
```python
"C"
```
```python
:
```
```python
"CN"
```
```python
,
```
```python
"L"
```
```python
:
```
```python
"DaLian"
```
```python
,
```
```python
"ST"
```
```python
:
```
```python
"LiaoNing"
```
```python
,
```
```python
"O"
```
```python
:
```
```python
"system:masters"
```
```python
,
```
```python
"OU"
```
```python
:
```
```python
"System"
```
```python
}
```
```python
]
```
```python
}
```
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
#
```
# 脚本示例
生成证书和kubeconfig设定的脚本如下：
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
# cat step1-2-prepare-admin-cert.sh
```
```python
#!/bin/sh
```
```python
.
```
```python
./install.cfg
```
```python
# set cfssl tools in search path
```
```python
chmod
```
```python
755
```
```python
${ENV_HOME_CFSSL}
```
```python
/*
```
```python
if
```
```python
[
```
```python
$?
```
```python
-ne 0
```
```python
]
```
```python
;
```
```python
then
```
```python
echo
```
```python
"prepare downloaded cfssl tools in
```
```python
${ENV_HOME_CFSSL}
```
```python
in advance"
```
```python
exit
```
```python
fi
```
```python
export
```
```python
PATH
```
```python
=
```
```python
${ENV_HOME_CFSSL}
```
```python
:
```
```python
$PATH
```
```python
# create dir for certs when not existing
```
```python
mkdir
```
```python
-p
```
```python
${ENV_SSL_CA_DIR}
```
```python
${ENV_SSL_ETCD_DIR}
```
```python
# create csr files of admin
```
```python
cat
```
```python
<<
```
```python
EOF
```
```python
>
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_ADMIN_CSR}
```
```python
{
```
```python
"CN"
```
```python
:
```
```python
"
```
```python
${ENV_SSL_ADMIN_CN}
```
```python
"
```
```python
,
```
```python
"hosts"
```
```python
:
```
```python
[
```
```python
]
```
```python
,
```
```python
"key"
```
```python
:
```
```python
{
```
```python
"algo"
```
```python
:
```
```python
"
```
```python
${ENV_SSL_KEY_ALGO}
```
```python
"
```
```python
,
```
```python
"size"
```
```python
:
```
```python
${ENV_SSL_KEY_SIZE}
```
```python
}
```
```python
,
```
```python
"names"
```
```python
:
```
```python
[
```
```python
{
```
```python
"C"
```
```python
:
```
```python
"
```
```python
${ENV_SSL_NAMES_C}
```
```python
"
```
```python
,
```
```python
"L"
```
```python
:
```
```python
"
```
```python
${ENV_SSL_NAMES_L}
```
```python
"
```
```python
,
```
```python
"ST"
```
```python
:
```
```python
"
```
```python
${ENV_SSL_NAMES_ST}
```
```python
"
```
```python
,
```
```python
"O"
```
```python
:
```
```python
"
```
```python
${ENV_SSL_NAMES_O_MASTER}
```
```python
"
```
```python
,
```
```python
"OU"
```
```python
:
```
```python
"
```
```python
${ENV_SSL_NAMES_OU}
```
```python
"
```
```python
}
```
```python
]
```
```python
}
```
```python
EOF
ODIR
```
```python
=
```
```python
`
```
```python
pwd
```
```python
`
```
```python
cd
```
```python
${ENV_SSL_CA_DIR}
```
```python
cfssl gencert -ca
```
```python
=
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_CA_PEM}
```
```python
-ca-key
```
```python
=
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_CA_KEY}
```
```python
-config
```
```python
=
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_CA_CONFIG}
```
```python
-profile
```
```python
=
```
```python
${ENV_SSL_PROFILE_K8S}
```
```python
${ENV_SSL_FILE_ADMIN_CSR}
```
```python
|
```
```python
cfssljson -bare
```
```python
${ENV_SSL_ADMIN_CERT_PRIFIX}
```
```python
# confirm cert pem: kubeadmin-key.pem  kubeadmin.pem
```
```python
ls
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_ADMIN_CERT_PRIFIX}
```
```python
*.pem
```
```python
#echo "openssl pkcs12 -export -out ${ENV_SSL_ADMIN_CERT_PRIFIX}.pfx -inkey ${ENV_SSL_ADMIN_CERT_PRIFIX}-key.pem -in ${ENV_SSL_ADMIN_CERT_PRIFIX}.pem -certfile ${ENV_SSL_FILE_CA_PEM}"
```
```python
# Create kubectl kubeconfig file.
```
```python
kubectl config set-cluster
```
```python
${ENV_KUBECONFIG_CLUSTER}
```
```python
\
  --certificate-authority
```
```python
=
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_CA_PEM}
```
```python
\
  --embed-certs
```
```python
=
```
```python
${ENV_KUBECONFIG_EMBED_CERTS}
```
```python
\
  --server
```
```python
=
```
```python
${ENV_KUBE_MASTER_HTTPS}
```
```python
\
  --kubeconfig
```
```python
=
```
```python
${ENV_KUBECONFIG_KUBECTL}
```
```python
kubectl config set-credentials
```
```python
${ENV_KUBECONFIG_CLIENT_KUBECTL}
```
```python
\
  --client-certificate
```
```python
=
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_ADMIN_CERT_PRIFIX}
```
```python
.pem \
  --client-key
```
```python
=
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_ADMIN_CERT_PRIFIX}
```
```python
-key.pem \
  --embed-certs
```
```python
=
```
```python
${ENV_KUBECONFIG_EMBED_CERTS}
```
```python
\
  --kubeconfig
```
```python
=
```
```python
${ENV_KUBECONFIG_KUBECTL}
```
```python
kubectl config set-context
```
```python
${ENV_KUBECONFIG_CLUSTER}
```
```python
\
  --cluster
```
```python
=
```
```python
${ENV_KUBECONFIG_CLUSTER}
```
```python
\
  --user
```
```python
=
```
```python
${ENV_KUBECONFIG_CLIENT_KUBECTL}
```
```python
\
  --kubeconfig
```
```python
=
```
```python
${ENV_KUBECONFIG_KUBECTL}
```
```python
kubectl config use-context
```
```python
${ENV_KUBECONFIG_CLUSTER}
```
```python
--kubeconfig
```
```python
=
```
```python
${ENV_KUBECONFIG_KUBECTL}
```
```python
echo
```
```python
"## copy
```
```python
${ENV_KUBECONFIG_KUBECTL}
```
```python
to ~/.kube/config"
```
```python
cp
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_KUBECONFIG_KUBECTL}
```
```python
~/.kube/config
```
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
#
```
# 执行示例
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
# sh step1-2-prepare-admin-cert.sh
```
```python
2019/03/29 20:34:54
```
```python
[
```
```python
INFO
```
```python
]
```
```python
generate received request
2019/03/29 20:34:54
```
```python
[
```
```python
INFO
```
```python
]
```
```python
received CSR
2019/03/29 20:34:54
```
```python
[
```
```python
INFO
```
```python
]
```
```python
generating key: rsa-2048
2019/03/29 20:34:55
```
```python
[
```
```python
INFO
```
```python
]
```
```python
encoded CSR
2019/03/29 20:34:55
```
```python
[
```
```python
INFO
```
```python
]
```
```python
signed certificate with serial number 29307085123257831389398834028051059242701418302
2019/03/29 20:34:55
```
```python
[
```
```python
WARNING
```
```python
]
```
```python
This certificate lacks a
```
```python
"hosts"
```
```python
field. This makes it unsuitable
```
```python
for
```
```python
websites. For
```
```python
more
```
```python
information see the Baseline Requirements
```
```python
for
```
```python
the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum
```
```python
(
```
```python
https://cabforum.org
```
```python
)
```
```python
;
```
```python
specifically, section 10.2.3
```
```python
(
```
```python
"Information Requirements"
```
```python
)
```
```python
.
/etc/ssl/ca/kubeadmin-key.pem  /etc/ssl/ca/kubeadmin.pem
Cluster
```
```python
"kubernetes"
```
```python
set.
User
```
```python
"admin"
```
```python
set.
Context
```
```python
"kubernetes"
```
```python
modified.
Switched to context
```
```python
"kubernetes"
```
```python
.
```
```python
## copy kubectl.kubeconfig to ~/.kube/config
```
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
#
```
# 结果确认
执行之后，kubectl可以正常动作了，因为kubeconfig在生成的时候，选择了将证书嵌入其中，如果master节点有多个的情况，这是只需要将此文件拷贝到其他节点的~/.kube/config中即可使用。
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
# kubectl version
```
```python
Client Version: version.Info
```
```python
{
```
```python
Major:
```
```python
"1"
```
```python
, Minor:
```
```python
"13"
```
```python
, GitVersion:
```
```python
"v1.13.4"
```
```python
, GitCommit:
```
```python
"c27b913fddd1a6c480c229191a087698aa92f0b1"
```
```python
, GitTreeState:
```
```python
"clean"
```
```python
, BuildDate:
```
```python
"2019-02-28T13:37:52Z"
```
```python
, GoVersion:
```
```python
"go1.11.5"
```
```python
, Compiler:
```
```python
"gc"
```
```python
, Platform:
```
```python
"linux/amd64"
```
```python
}
```
```python
Server Version: version.Info
```
```python
{
```
```python
Major:
```
```python
"1"
```
```python
, Minor:
```
```python
"13"
```
```python
, GitVersion:
```
```python
"v1.13.4"
```
```python
, GitCommit:
```
```python
"c27b913fddd1a6c480c229191a087698aa92f0b1"
```
```python
, GitTreeState:
```
```python
"clean"
```
```python
, BuildDate:
```
```python
"2019-02-28T13:30:26Z"
```
```python
, GoVersion:
```
```python
"go1.11.5"
```
```python
, Compiler:
```
```python
"gc"
```
```python
, Platform:
```
```python
"linux/amd64"
```
```python
}
```
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
#
```
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
# kubectl cluster-info
```
```python
Kubernetes master is running at https://192.168.163.131:6443
To further debug and diagnose cluster problems, use
```
```python
'kubectl cluster-info dump'
```
```python
.
```
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
#
```

