
# 纯Python和PyTorch对比实现循环神经网络RNNCell及反向传播 - BrightLamp的博客 - CSDN博客


2018年12月15日 16:31:46[BrightLampCsdn](https://me.csdn.net/oBrightLamp)阅读数：102



## 摘要
本文使用纯 Python 和 PyTorch 对比实现循环神经网络RNNCell单元及其反向传播
## 相关
原理和详细解释, 请参考:
循环神经网络RNNCell单元详解及反向传播的梯度求导
[https://blog.csdn.net/oBrightLamp/article/details/85015325](https://blog.csdn.net/oBrightLamp/article/details/85015325)
## 正文
```python
import
```
```python
torch
```
```python
import
```
```python
numpy
```
```python
as
```
```python
np
np
```
```python
.
```
```python
random
```
```python
.
```
```python
seed
```
```python
(
```
```python
12
```
```python
)
```
```python
torch
```
```python
.
```
```python
random
```
```python
.
```
```python
manual_seed
```
```python
(
```
```python
12
```
```python
)
```
```python
np
```
```python
.
```
```python
set_printoptions
```
```python
(
```
```python
precision
```
```python
=
```
```python
6
```
```python
,
```
```python
suppress
```
```python
=
```
```python
True
```
```python
)
```
```python
class
```
```python
RNNCell
```
```python
:
```
```python
def
```
```python
__init__
```
```python
(
```
```python
self
```
```python
,
```
```python
weight_ih
```
```python
,
```
```python
weight_hh
```
```python
,
```
```python
bias_ih
```
```python
,
```
```python
bias_hh
```
```python
)
```
```python
:
```
```python
self
```
```python
.
```
```python
weight_ih
```
```python
=
```
```python
weight_ih
        self
```
```python
.
```
```python
weight_hh
```
```python
=
```
```python
weight_hh
        self
```
```python
.
```
```python
bias_ih
```
```python
=
```
```python
bias_ih
        self
```
```python
.
```
```python
bias_hh
```
```python
=
```
```python
bias_hh
        self
```
```python
.
```
```python
x_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
dx_list
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
dw_ih_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
dw_hh_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
db_ih_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
db_hh_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
prev_hidden_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
next_hidden_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
# temporary cache
```
```python
self
```
```python
.
```
```python
prev_dh
```
```python
=
```
```python
None
```
```python
def
```
```python
__call__
```
```python
(
```
```python
self
```
```python
,
```
```python
x
```
```python
,
```
```python
prev_hidden
```
```python
)
```
```python
:
```
```python
self
```
```python
.
```
```python
x_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
x
```
```python
)
```
```python
next_h
```
```python
=
```
```python
np
```
```python
.
```
```python
tanh
```
```python
(
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
x
```
```python
,
```
```python
self
```
```python
.
```
```python
weight_ih
```
```python
.
```
```python
T
```
```python
)
```
```python
+
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
prev_hidden
```
```python
,
```
```python
self
```
```python
.
```
```python
weight_hh
```
```python
.
```
```python
T
```
```python
)
```
```python
+
```
```python
self
```
```python
.
```
```python
bias_ih
```
```python
+
```
```python
self
```
```python
.
```
```python
bias_hh
```
```python
)
```
```python
self
```
```python
.
```
```python
prev_hidden_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
prev_hidden
```
```python
)
```
```python
self
```
```python
.
```
```python
next_hidden_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
next_h
```
```python
)
```
```python
# clean cache
```
```python
self
```
```python
.
```
```python
prev_dh
```
```python
=
```
```python
np
```
```python
.
```
```python
zeros
```
```python
(
```
```python
next_h
```
```python
.
```
```python
shape
```
```python
)
```
```python
return
```
```python
next_h
```
```python
def
```
```python
backward
```
```python
(
```
```python
self
```
```python
,
```
```python
dh
```
```python
)
```
```python
:
```
```python
x
```
```python
=
```
```python
self
```
```python
.
```
```python
x_stack
```
```python
.
```
```python
pop
```
```python
(
```
```python
)
```
```python
prev_hidden
```
```python
=
```
```python
self
```
```python
.
```
```python
prev_hidden_stack
```
```python
.
```
```python
pop
```
```python
(
```
```python
)
```
```python
next_hidden
```
```python
=
```
```python
self
```
```python
.
```
```python
next_hidden_stack
```
```python
.
```
```python
pop
```
```python
(
```
```python
)
```
```python
d_tanh
```
```python
=
```
```python
(
```
```python
dh
```
```python
+
```
```python
self
```
```python
.
```
```python
prev_dh
```
```python
)
```
```python
*
```
```python
(
```
```python
1
```
```python
-
```
```python
next_hidden
```
```python
**
```
```python
2
```
```python
)
```
```python
self
```
```python
.
```
```python
prev_dh
```
```python
=
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
d_tanh
```
```python
,
```
```python
self
```
```python
.
```
```python
weight_hh
```
```python
)
```
```python
dx
```
```python
=
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
d_tanh
```
```python
,
```
```python
self
```
```python
.
```
```python
weight_ih
```
```python
)
```
```python
self
```
```python
.
```
```python
dx_list
```
```python
.
```
```python
insert
```
```python
(
```
```python
0
```
```python
,
```
```python
dx
```
```python
)
```
```python
dw_ih
```
```python
=
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
d_tanh
```
```python
.
```
```python
T
```
```python
,
```
```python
x
```
```python
)
```
```python
self
```
```python
.
```
```python
dw_ih_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
dw_ih
```
```python
)
```
```python
dw_hh
```
```python
=
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
d_tanh
```
```python
.
```
```python
T
```
```python
,
```
```python
prev_hidden
```
```python
)
```
```python
self
```
```python
.
```
```python
dw_hh_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
dw_hh
```
```python
)
```
```python
self
```
```python
.
```
```python
db_ih_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
d_tanh
```
```python
)
```
```python
self
```
```python
.
```
```python
db_hh_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
d_tanh
```
```python
)
```
```python
return
```
```python
self
```
```python
.
```
```python
dx_list
```
```python
if
```
```python
__name__
```
```python
==
```
```python
'__main__'
```
```python
:
```
```python
rnn_cell_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
nn
```
```python
.
```
```python
RNNCell
```
```python
(
```
```python
4
```
```python
,
```
```python
5
```
```python
)
```
```python
.
```
```python
double
```
```python
(
```
```python
)
```
```python
rnn_cell_numpy
```
```python
=
```
```python
RNNCell
```
```python
(
```
```python
rnn_cell_tensor
```
```python
.
```
```python
weight_ih
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
,
```
```python
rnn_cell_tensor
```
```python
.
```
```python
weight_hh
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
,
```
```python
rnn_cell_tensor
```
```python
.
```
```python
bias_ih
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
,
```
```python
rnn_cell_tensor
```
```python
.
```
```python
bias_hh
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
x_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
3
```
```python
,
```
```python
4
```
```python
)
```
```python
)
```
```python
x_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
x_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
h_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
3
```
```python
,
```
```python
5
```
```python
)
```
```python
)
```
```python
h_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
h_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
dh_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
3
```
```python
,
```
```python
5
```
```python
)
```
```python
)
```
```python
dh_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
dh_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
next_h_numpy
```
```python
=
```
```python
rnn_cell_numpy
```
```python
(
```
```python
x_numpy
```
```python
,
```
```python
h_numpy
```
```python
)
```
```python
next_h_tensor
```
```python
=
```
```python
rnn_cell_tensor
```
```python
(
```
```python
x_tensor
```
```python
,
```
```python
h_tensor
```
```python
)
```
```python
rnn_cell_numpy
```
```python
.
```
```python
backward
```
```python
(
```
```python
dh_numpy
```
```python
)
```
```python
next_h_tensor
```
```python
.
```
```python
backward
```
```python
(
```
```python
dh_tensor
```
```python
)
```
```python
print
```
```python
(
```
```python
"numpy_hidden :\n"
```
```python
,
```
```python
h_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
"tensor_hidden :\n"
```
```python
,
```
```python
h_tensor
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"dx_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
array
```
```python
(
```
```python
rnn_cell_numpy
```
```python
.
```
```python
dx_list
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"dx_tensor :\n"
```
```python
,
```
```python
x_tensor
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"dw_ih_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
rnn_cell_numpy
```
```python
.
```
```python
dw_ih_stack
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"dw_ih_tensor :\n"
```
```python
,
```
```python
rnn_cell_tensor
```
```python
.
```
```python
weight_ih
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"dw_hh_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
rnn_cell_numpy
```
```python
.
```
```python
dw_hh_stack
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"dw_hh_tensor :\n"
```
```python
,
```
```python
rnn_cell_tensor
```
```python
.
```
```python
weight_hh
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"db_ih_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
rnn_cell_numpy
```
```python
.
```
```python
db_ih_stack
```
```python
,
```
```python
axis
```
```python
=
```
```python
(
```
```python
0
```
```python
,
```
```python
1
```
```python
)
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"db_hh_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
rnn_cell_numpy
```
```python
.
```
```python
db_hh_stack
```
```python
,
```
```python
axis
```
```python
=
```
```python
(
```
```python
0
```
```python
,
```
```python
1
```
```python
)
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"db_ih_tensor :\n"
```
```python
,
```
```python
rnn_cell_tensor
```
```python
.
```
```python
bias_ih
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"db_hh_tensor :\n"
```
```python
,
```
```python
rnn_cell_tensor
```
```python
.
```
```python
bias_hh
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
"""
    代码输出
    numpy_hidden :
     [[ 0.944225  0.852736  0.002259  0.521226  0.552038]
     [ 0.485377  0.768134  0.160717  0.76456   0.02081 ]
     [ 0.13521   0.116273  0.309898  0.671453  0.47123 ]]
    tensor_hidden :
     [[ 0.944225  0.852736  0.002259  0.521226  0.552038]
     [ 0.485377  0.768134  0.160717  0.76456   0.02081 ]
     [ 0.13521   0.116273  0.309898  0.671453  0.47123 ]]
    ------
    dx_numpy :
     [[[ 0.234823  0.001947 -0.221488 -0.120629]
      [ 0.399758  0.061028 -0.244361 -0.42483 ]
      [ 0.28308   0.016405 -0.252444 -0.098564]]]
    dx_tensor :
     [[ 0.234823  0.001947 -0.221488 -0.120629]
     [ 0.399758  0.061028 -0.244361 -0.42483 ]
     [ 0.28308   0.016405 -0.252444 -0.098564]]
    ------
    dw_ih_numpy :
     [[ 0.778769  0.979517  0.700974  0.842186]
     [ 0.358268  1.077404  0.969949  0.37424 ]
     [ 0.540533  1.158021  0.862288  0.676237]
     [ 0.498534  1.444171  1.151646  0.643482]
     [ 0.507196  0.819969  0.791703  0.417976]]
    dw_ih_tensor :
     [[ 0.778769  0.979517  0.700974  0.842186]
     [ 0.358268  1.077404  0.969949  0.37424 ]
     [ 0.540533  1.158021  0.862288  0.676237]
     [ 0.498534  1.444171  1.151646  0.643482]
     [ 0.507196  0.819969  0.791703  0.417976]]
    ------
    dw_hh_numpy :
     [[ 0.992737  1.002905  0.267135  1.12167   0.760192]
     [ 0.748401  0.968729  0.24167   1.044483  0.325857]
     [ 1.044248  1.140167  0.234594  1.138324  0.622972]
     [ 1.174287  1.371561  0.27636   1.355196  0.591165]
     [ 0.566084  0.729519  0.260056  0.93798   0.346813]]
    dw_hh_tensor :
     [[ 0.992737  1.002905  0.267135  1.12167   0.760192]
     [ 0.748401  0.968729  0.24167   1.044483  0.325857]
     [ 1.044248  1.140167  0.234594  1.138324  0.622972]
     [ 1.174287  1.371561  0.27636   1.355196  0.591165]
     [ 0.566084  0.729519  0.260056  0.93798   0.346813]]
    ------
    db_ih_numpy :
     [ 1.798989  1.496149  1.77515   2.042895  1.345267]
    db_hh_numpy :
     [ 1.798989  1.496149  1.77515   2.042895  1.345267]
    ------
    db_ih_tensor :
     [ 1.798989  1.496149  1.77515   2.042895  1.345267]
    db_hh_tensor :
     [ 1.798989  1.496149  1.77515   2.042895  1.345267]
    """
```

