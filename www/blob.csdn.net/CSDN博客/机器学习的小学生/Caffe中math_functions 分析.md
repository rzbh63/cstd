
# Caffe中math_functions 分析 - 机器学习的小学生 - CSDN博客


2017年04月14日 21:19:15[机器学习的小学生](https://me.csdn.net/xuluhui123)阅读数：301个人分类：[Caffe																](https://blog.csdn.net/xuluhui123/article/category/6777566)


转载自：[Caffe源码（一）：math_functions 分析](http://blog.csdn.net/seven_first/article/details/47378697\#1-caffecpugemm-%E5%87%BD%E6%95%B0)
# 目录
[目录](#目录)[主要函数](#主要函数)[caffe_cpu_gemm 函数](#1-caffecpugemm-函数)
[caffe_cpu_gemv 函数](#2-caffecpugemv-函数)
[caffe_axpy 函数](#3caffeaxpy-函数)
[caffe_set 函数](#4caffeset-函数)
[caffe_add_scalar 函数](#5caffeaddscalar-函数)
[caffe_copy 函数](#6caffecopy-函数)
[caffe_scal 函数](#7caffescal-函数)
[caffe_cpu_axpby 函数](#8caffeinecupaxpby-函数)
[caffe_add caffe_sub caffe_mul caffe_div 函数](#9caffeadd-caffesub-caffemul-caffediv-函数)
[caffe_powx caffe_sqr caffe_exp caffe_abs 函数](#10caffepowx-caffesqr-caffeexp-caffeabs-函数)
[int caffe_rng_rand 函数](#11int-cafferngrand-函数)
[caffe_nextafer 函数](#12caffenextafer-函数)
[caffe_cpu_strided_dot 函数](#13caffecpustrideddot-函数)
[caffe_cpu_hamming_distance 函数](#14caffecpuhammingdistance-函数)
[caffe_cpu_asum 函数](#15-caffecpuasum-函数)
[caffe_cpu_scale 函数](#16caffecpuscale-函数)



## 主要函数
math_function 定义了caffe 中用到的一些矩阵操作和数值计算的一些函数，这里以float类型为例做简单的分析
### 1. caffe_cpu_gemm 函数：
```python
template
```
```python
<>
```
```python
void
```
```python
caffe_cpu_gemm<
```
```python
float
```
```python
>(
```
```python
const
```
```python
CBLAS_TRANSPOSE TransA,
```
```python
const
```
```python
CBLAS_TRANSPOSE TransB,
```
```python
const
```
```python
int
```
```python
M,
```
```python
const
```
```python
int
```
```python
N,
```
```python
const
```
```python
int
```
```python
K,
```
```python
const
```
```python
float
```
```python
alpha,
```
```python
const
```
```python
float
```
```python
* A,
```
```python
const
```
```python
float
```
```python
* B,
```
```python
const
```
```python
float
```
```python
beta,
```
```python
float
```
```python
* C) {
```
```python
int
```
```python
lda = (TransA == CblasNoTrans) ? K : M;
```
```python
int
```
```python
ldb = (TransB == CblasNoTrans) ? N : K;
  cblas_sgemm(CblasRowMajor, TransA, TransB, M, N, K, alpha, A, lda, B,
      ldb, beta, C, N);
}
```
1
2
3
4
5
6
7
8
9
10
![](http://static.blog.csdn.net/images/save_snippets.png)
1
2
3
4
5
6
7
8
9
10
功能：        C=alpha*A*B+beta*C
A,B,C 是输入矩阵（一维数组格式）
CblasRowMajor :数据是行主序的（二维数据也是用一维数组储存的）
TransA, TransB：是否要对A和B做转置操作（CblasTrans   CblasNoTrans）
M：   A、C  的行数
N：   B、C  的列数
K：   A 的列数， B 的行数
lda ： A的列数（不做转置）行数（做转置）
ldb：  B的列数（不做转置）行数（做转置）
### 2.  caffe_cpu_gemv 函数：
```python
template
```
```python
<>
```
```python
void
```
```python
caffe_cpu_gemv<
```
```python
float
```
```python
>(
```
```python
const
```
```python
CBLAS_TRANSPOSE TransA,
```
```python
const
```
```python
int
```
```python
M,
```
```python
const
```
```python
int
```
```python
N,
```
```python
const
```
```python
float
```
```python
alpha,
```
```python
const
```
```python
float
```
```python
* A,
```
```python
const
```
```python
float
```
```python
* x,
```
```python
const
```
```python
float
```
```python
beta,
```
```python
float
```
```python
* y) {
  cblas_sgemv(CblasRowMajor, TransA, M, N, alpha, A, N, x,
```
```python
1
```
```python
, beta, y,
```
```python
1
```
```python
);
}
```
1
2
3
4
5
6
![](http://static.blog.csdn.net/images/save_snippets.png)
1
2
3
4
5
6
功能：       y=alpha*A*x+beta*y
其中X和Y是向量，A 是矩阵
M：A 的行数
N：A  的列数
cblas_sgemv 中的 参数1 表示对X和Y的每个元素都进行操作
### 3.caffe_axpy 函数：
```python
template
```
```python
<>
```
```python
void
```
```python
caffe_axpy<
```
```python
float
```
```python
>(
```
```python
const
```
```python
int
```
```python
N,
```
```python
const
```
```python
float
```
```python
alpha,
```
```python
const
```
```python
float
```
```python
* X,
```
```python
float
```
```python
* Y) { cblas_saxpy(N, alpha, X,
```
```python
1
```
```python
, Y,
```
```python
1
```
```python
); }
```
1
2
3
![](http://static.blog.csdn.net/images/save_snippets.png)
1
2
3
功能：       Y=alpha*X+Y
N：为X和Y中element的个数
### 4.caffe_set 函数：
```python
template
```
```python
<
```
```python
typename
```
```python
Dtype>
```
```python
void
```
```python
caffe_set(
```
```python
const
```
```python
int
```
```python
N,
```
```python
const
```
```python
Dtype alpha, Dtype* Y) {
```
```python
if
```
```python
(alpha ==
```
```python
0
```
```python
) {
```
```python
memset
```
```python
(Y,
```
```python
0
```
```python
,
```
```python
sizeof
```
```python
(Dtype) * N);
```
```python
// NOLINT(caffe/alt_fn)
```
```python
return
```
```python
;
  }
```
```python
for
```
```python
(
```
```python
int
```
```python
i =
```
```python
0
```
```python
; i < N; ++i) {
    Y[i] = alpha; 
  }
}
```
1
2
3
4
5
6
7
8
9
10
![](http://static.blog.csdn.net/images/save_snippets.png)
1
2
3
4
5
6
7
8
9
10
功能：用常数 alpha 对 Y 进行初始化
函数 void *memset(void *buffer, char c, unsigned count)  一般为新申请的内存做初始化，功能是将buffer所指向内存中的每个字节的内容全部设置为c指定的ASCII值, count为块的大小
### 5.caffe_add_scalar 函数：
```python
template
```
```python
<>
```
```python
void
```
```python
caffe_add_scalar(
```
```python
const
```
```python
int
```
```python
N,
```
```python
const
```
```python
float
```
```python
alpha,
```
```python
float
```
```python
* Y) {
```
```python
for
```
```python
(
```
```python
int
```
```python
i =
```
```python
0
```
```python
; i < N; ++i) {
    Y[i] += alpha;
  }
}
```
1
2
3
4
5
6
![](http://static.blog.csdn.net/images/save_snippets.png)
1
2
3
4
5
6
功能：       给 Y 的每个 element 加上常数 alpha
### 6.caffe_copy 函数：
```python
template
```
```python
<
```
```python
typename
```
```python
Dtype>
```
```python
void
```
```python
caffe_copy(
```
```python
const
```
```python
int
```
```python
N,
```
```python
const
```
```python
Dtype* X, Dtype* Y) {
```
```python
if
```
```python
(X != Y) {
```
```python
if
```
```python
(Caffe::mode() == Caffe::GPU) {
```
```python
#ifndef CPU_ONLY
```
```python
// NOLINT_NEXT_LINE(caffe/alt_fn)
```
```python
CUDA_CHECK(cudaMemcpy(Y, X,
```
```python
sizeof
```
```python
(Dtype) * N, cudaMemcpyDefault));
```
```python
#else
```
```python
NO_GPU;
```
```python
#endif
```
```python
}
```
```python
else
```
```python
{
```
```python
memcpy
```
```python
(Y, X,
```
```python
sizeof
```
```python
(Dtype) * N);
```
```python
// NOLINT(caffe/alt_fn)
```
```python
}
  }
}
```
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
![](http://static.blog.csdn.net/images/save_snippets.png)
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
函数 void *memcpy(void *dest, void *src, unsigned int count) 把src所指向的内存区域 copy到dest所指向的内存区域, count为块的大小
### 7.caffe_scal 函数：
```python
template
```
```python
<>
```
```python
void
```
```python
caffe_scal<
```
```python
float
```
```python
>(
```
```python
const
```
```python
int
```
```python
N,
```
```python
const
```
```python
float
```
```python
alpha,
```
```python
float
```
```python
*X) {
  cblas_sscal(N, alpha, X,
```
```python
1
```
```python
);
}
```
1
2
3
4
5
![](http://static.blog.csdn.net/images/save_snippets.png)
1
2
3
4
5
功能：X = alpha*X
N： X中element的个数
### 8.caffe_cpu_axpby 函数：
```python
template
```
```python
<>
```
```python
void
```
```python
caffe_cpu_axpby<
```
```python
float
```
```python
>(
```
```python
const
```
```python
int
```
```python
N,
```
```python
const
```
```python
float
```
```python
alpha,
```
```python
const
```
```python
float
```
```python
* X,
```
```python
const
```
```python
float
```
```python
beta,
```
```python
float
```
```python
* Y) {
  cblas_saxpby(N, alpha, X,
```
```python
1
```
```python
, beta, Y,
```
```python
1
```
```python
);
}
```
1
2
3
4
5
![](http://static.blog.csdn.net/images/save_snippets.png)
1
2
3
4
5
功能：Y= alpha*X+beta*Y
### 9.caffe_add、 caffe_sub、 caffe_mul、 caffe_div 函数：
```python
template
```
```python
<>
```
```python
void
```
```python
caffe_add<
```
```python
float
```
```python
>(
```
```python
const
```
```python
int
```
```python
n,
```
```python
const
```
```python
float
```
```python
* a,
```
```python
const
```
```python
float
```
```python
* b,
```
```python
float
```
```python
* y) {
  vsAdd(n, a, b, y);
}
```
```python
template
```
```python
<>
```
```python
void
```
```python
caffe_sub<
```
```python
float
```
```python
>(
```
```python
const
```
```python
int
```
```python
n,
```
```python
const
```
```python
float
```
```python
* a,
```
```python
const
```
```python
float
```
```python
* b,
```
```python
float
```
```python
* y) {
  vsSub(n, a, b, y);
}
```
```python
template
```
```python
<>
```
```python
void
```
```python
caffe_mul<
```
```python
float
```
```python
>(
```
```python
const
```
```python
int
```
```python
n,
```
```python
const
```
```python
float
```
```python
* a,
```
```python
const
```
```python
float
```
```python
* b,
```
```python
float
```
```python
* y) {
  vsMul(n, a, b, y);
}
```
```python
template
```
```python
<>
```
```python
void
```
```python
caffe_div<
```
```python
float
```
```python
>(
```
```python
const
```
```python
int
```
```python
n,
```
```python
const
```
```python
float
```
```python
* a,
```
```python
const
```
```python
float
```
```python
* b,
```
```python
float
```
```python
* y) {
  vsDiv(n, a, b, y);
}
```
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
![](http://static.blog.csdn.net/images/save_snippets.png)
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
功能：这四个函数分别实现element-wise的加减乘除（y[i] = a[i] + -  *  \  b[i]）
### 10.caffe_powx、 caffe_sqr、 caffe_exp、 caffe_abs 函数：
```python
template
```
```python
<>
```
```python
void
```
```python
caffe_powx<
```
```python
float
```
```python
>(
```
```python
const
```
```python
int
```
```python
n,
```
```python
const
```
```python
float
```
```python
* a,
```
```python
const
```
```python
float
```
```python
b,
```
```python
float
```
```python
* y) {
  vsPowx(n, a, b, y);
}
```
```python
template
```
```python
<>
```
```python
void
```
```python
caffe_sqr<
```
```python
float
```
```python
>(
```
```python
const
```
```python
int
```
```python
n,
```
```python
const
```
```python
float
```
```python
* a,
```
```python
float
```
```python
* y) {
  vsSqr(n, a, y);
}
```
```python
template
```
```python
<>
```
```python
void
```
```python
caffe_exp<
```
```python
float
```
```python
>(
```
```python
const
```
```python
int
```
```python
n,
```
```python
const
```
```python
float
```
```python
* a,
```
```python
float
```
```python
* y) {
  vsExp(n, a, y);
}
```
```python
template
```
```python
<>
```
```python
void
```
```python
caffe_abs<
```
```python
float
```
```python
>(
```
```python
const
```
```python
int
```
```python
n,
```
```python
const
```
```python
float
```
```python
* a,
```
```python
float
```
```python
* y) {
    vsAbs(n, a, y);
}
```
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
![](http://static.blog.csdn.net/images/save_snippets.png)
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
功能 : 同样是element-wise操作，分别是y[i] = a[i] ^ b， y[i] = a[i]^2，y[i] = exp(a[i] )，y[i] = |a[i] |
### 11.int caffe_rng_rand 函数：
```python
unsigned
```
```python
int
```
```python
caffe_rng_rand() {
```
```python
return
```
```python
(
```
```python
*caffe_rng
```
```python
())();
}
```
1
2
3
![](http://static.blog.csdn.net/images/save_snippets.png)
1
2
3
功能：返回一个随机数
### 12.caffe_nextafer 函数：
```python
template <typename
```
```python
Dtype
```
```python
>
```
```python
Dtype
```
```python
caffe_nextafter(const
```
```python
Dtype
```
```python
b) {
```
```python
return
```
```python
boost:
```
```python
:math
```
```python
:
```
```python
:nextafter<Dtype>
```
```python
(
      b,
```
```python
std:
```
```python
:numeric_limits<Dtype>
```
```python
:
```
```python
:max
```
```python
());
}
```
1
2
3
4
5
![](http://static.blog.csdn.net/images/save_snippets.png)
1
2
3
4
5
功能 ： 返回 b 最大方向上可以表示的最接近的数值。
### 13.caffe_cpu_strided_dot 函数：
```python
template
```
```python
<>
```
```python
double
```
```python
caffe_cpu_strided_dot<
```
```python
double
```
```python
>(
```
```python
const
```
```python
int
```
```python
n,
```
```python
const
```
```python
double
```
```python
* x,
```
```python
const
```
```python
int
```
```python
incx,
```
```python
const
```
```python
double
```
```python
* y,
```
```python
const
```
```python
int
```
```python
incy) {
```
```python
return
```
```python
cblas_ddot(n, x, incx, y, incy);
}
```
1
2
3
4
5
![](http://static.blog.csdn.net/images/save_snippets.png)
1
2
3
4
5
功能： 返回 vector X 和 vector Y 的内积。
incx， incy ： 步长，即每隔incx 或 incy 个element 进行操作。
### 14.caffe_cpu_hamming_distance 函数：
```python
template
```
```python
<>
```
```python
int
```
```python
caffe_cpu_hamming_distance<
```
```python
float
```
```python
>(
```
```python
const
```
```python
int
```
```python
n,
```
```python
const
```
```python
float
```
```python
* x,
```
```python
const
```
```python
float
```
```python
* y) {
```
```python
int
```
```python
dist =
```
```python
0
```
```python
;
```
```python
for
```
```python
(
```
```python
int
```
```python
i =
```
```python
0
```
```python
; i < n; ++i) {
    dist += __builtin_popcount(
```
```python
static_cast
```
```python
<uint32_t>(x[i]) ^
```
```python
static_cast
```
```python
<uint32_t>(y[i]));
  }
```
```python
return
```
```python
dist;
}
```
1
2
3
4
5
6
7
8
9
10
11
![](http://static.blog.csdn.net/images/save_snippets.png)
1
2
3
4
5
6
7
8
9
10
11
功能：返回 x 和 y 之间的海明距离。（两个等长字符串之间的海明距离是两个字符串对应位置的不同字符的个数。）
### 15. caffe_cpu_asum 函数：
```python
template
```
```python
<>
```
```python
float
```
```python
caffe_cpu_asum<
```
```python
float
```
```python
>(
```
```python
const
```
```python
int
```
```python
n,
```
```python
const
```
```python
float
```
```python
* x) {
```
```python
return
```
```python
cblas_sasum(n, x,
```
```python
1
```
```python
);
}
```
1
2
3
4
5
![](http://static.blog.csdn.net/images/save_snippets.png)
1
2
3
4
5
功能：计算 vector x 的所有element的绝对值之和。
### 16.caffe_cpu_scale 函数：
```python
template
```
```python
<>
```
```python
void
```
```python
caffe_cpu_scale<
```
```python
float
```
```python
>(
```
```python
const
```
```python
int
```
```python
n,
```
```python
const
```
```python
float
```
```python
alpha,
```
```python
const
```
```python
float
```
```python
*x,
```
```python
float
```
```python
* y) {
  cblas_scopy(n, x,
```
```python
1
```
```python
, y,
```
```python
1
```
```python
);
  cblas_sscal(n, alpha, y,
```
```python
1
```
```python
);
}
```
1
2
3
4
5
6
![](http://static.blog.csdn.net/images/save_snippets.png)
1
2
3
4
5
6
功能：y = alpha*x



