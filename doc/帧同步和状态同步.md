# 帧同步和状态同步



去英雄互娱面试突然说到了对游戏中的网络实现问题，面试官告诉我两个名词：帧同步和状态同步 
小白并不懂所以开贴记录下来



## 帧同步：

帧同步，根据wiki百科的定义是，一种对同步源进行像素级同步显示的处理技术，对于网络上的多个接入者，一个信号将会通过主机同步发送给其他人，并同步显示在各个终端上。同步信号可以是每帧的像素数据，也可以是影响数据变化的关键事件信息。

帧同步常被RTS(即时战略)游戏常采用。在游戏中同步的是玩家的操作指令，操作指令包含当前的帧索引。一般的流程是客户端上传操作到服务器， 服务器收到后并不计算游戏行为， 而是转发到所有客户端。这里最重要的概念就是 相同的输入 + 相同的时机 = 相同的输出。

实现帧同步的流程一般是：

1. 同步随机数种子。(一般游戏中都设计随机数的使用， 通过同步随机数种子，可以保持随机数一致性)
2. 客户端上传操作指令。(指令包括游戏操作和当前帧索引)
3. 服务器广播所有客户端的操作。(如果没有操作， 也要广播空指令来驱动游戏帧前进)。

因为帧同步的特性， 我们可以很方便的做出战斗回放：服务器记录所有操作， 客户端请求到操作文件再执行一次即可。

帧同步的特性导致客户端的逻辑实现和表现实现必须完全分离。Unity中的一些方法接口(如 Invoke， Update、动画系统等)是不可靠的，所有要自己实现一套物理引擎、数学库，做到逻辑和表现分离。 这样即使Unity的渲染是不同步的，但是逻辑跑出来是同步的。

我曾经参与过一个飞机类弹幕游戏的项目，它的同步方案就是帧同步， 可以完美的播放回放， 并实现服务器上加速验算。



## 状态同步

状态同步：同步的是游戏中的各种状态。一般的流程是客户端上传操作到服务器，服务器收到后计算游戏行为的结果，然后以广播的方式下发游戏中各种状态，客户端收到状态后再根据状态显示内容。状态同步最广泛的应用应该是在回合制游戏中。

状态同步其实是一种不严谨的同步。它的思想中，不同玩家屏幕上的表现的一致性并不是重要指标， 只要每次操作的结果相同即可。所以状态同步对网络延迟的要求并不高。像玩RPG游戏，200-300ms的延迟也可以接受。 但是在RTS游戏中，50ms的延迟也会很受伤。

举个移动的例子，在状态同步中， 客户端甲上操作要求从A点移动到B点，但在客户端乙上， 甲对象从A移动到C，然后从C点移动到了B。这是因为， 客户端乙收到A的移动状态时， 已经经过了一个延迟。这个过程中，需要客户端乙本地做一些平滑的处理，最终达到移动到B点的结果。

所以国产RPG游戏中，动画的特效一般做的比较绚丽(大)， 攻击的时候给人感觉是击中了。放技能之前一般也有一个动画前摇，同时将攻击请求提交给服务器。等服务器结果返回时，动画也播放完毕了，之后就是统一的伤害效果和结算。



状态同步和帧同步的比较和选择：
比较：

状态同步	帧同步
流量	相对高	相对低
回放	记录文件大	记录文件小
安全性	服务器实现逻辑，安全性高	逻辑在客户端，反外挂压力大、无法避免开图挂
服务器压力	大	小
战斗校验	协议加密，内存混肴，误差校验，无法彻底解决。	服务器可以重启跑一遍战斗。
网络卡顿的表现	瞬移，回位，莫名掉血	战斗卡顿
实现	调优状态同步方式，客户端需要做插值处理。	客户端按照单机方式开发，保证逻辑层和表现层分离。逻辑层不要用到浮点数，不要用不确定顺序的逻辑结构。对于物理引擎和浮点数计算要不能使用Unity的。
选择：对于单位比较多的即时策略游戏，帧同步是很好的选择。反过来，如果玩家比较多，状态同步更合适，安全性更高。



 

## 自我理解

面试官问我魔兽世界和魔兽争霸的不同，通过上述的描述就可以比较清楚的知道：

针对魔兽争霸来说用的是帧同步，首先因为魔兽来说单位特别多，全部都占用服务器资源会很伤，只是广播玩家的操作，不需要计算，对于实时性也会很好，计算需求都在客户端使用。这也体现了我在玩赤潮下的一个问题，赤潮万到后期6个人超多个单位，所有计算都在手机上，渲染什么的都非常卡，特别影响体验，技能也丢不出去，这也是我后来不玩赤潮的主要原因之一。在想后期出安卓版的赤潮，有多少手机带不动。

针对魔兽世界来说用的是状态同步，实时性不是很好，并且占用服务器的资源，但是对于玩家来说屏幕的一致性并不是重要指标，我的每次操作都可以得到正确的结果，对游戏的体验性会好很多。但是在网络环境较差的情况下，使用状态同步，会造成我明明向前走了很多步，突然就会回退到前面的位置，服务器因为网络延迟没有收到你中间的一系列的操作指令。

[参考1](http://blog.csdn.net/david_dai_1108/article/details/73437736) <http://blog.csdn.net/david_dai_1108/article/details/73437736> 
[参考2](http://blog.sina.com.cn/s/blog_674f1bd20101omv7.html) <http://blog.sina.com.cn/s/blog_674f1bd20101omv7.html>







