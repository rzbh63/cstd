# 人脸美妆之唇色检测算法研究

2015年08月27日 20:15:07

 

Trent1985

 

阅读数：6430

更多

所属专栏： [数字图像处理课题研究](https://blog.csdn.net/column/details/imagesharp.html)



版权声明：本文为博主原创文章，未经博主允许不得转载。	https://blog.csdn.net/Trent1985/article/details/46330847

# 人脸美妆之唇色检测算法研究

目前，随着人脸检测识别技术的日趋成熟，人脸美化技术的竞争也愈演愈烈，诸如移动设备应用类中的美咖相机，美图秀秀，Perfect 365，天天P图等等，这些应用无疑都在给人们的感官生活带来新的乐趣与新的体验，今天，我在这里给大家介绍一下，这些人脸美妆技术中一个必不可少的内容—-唇彩。

## **唇彩的实现分为以下几个步骤**：

- **嘴唇粗略检测**
- **嘴唇精确检测**
- **嘴唇涂色**

------

### **嘴唇粗略检测**

嘴唇粗略检测的方法包括两种： 
\- 1. 手动标记 
手动标记往往是让用户自己移动特征点来定位嘴唇区域。这种方式略繁琐。 
\- 2. 自动标记 
自动标记往往是通过人脸识别技术，获取嘴唇的大概位置。人脸识别的技术目前已经日趋成熟，市面上诸如Face++等等，我们可以直接调用。 
一般而言，目前的美妆软件中，首先使用自动标记，得到嘴唇的大概位置，如果无法检测到人脸，那么，会进一步让用户手动标记，这样给用户一种友好的用户体验。

### **嘴唇精确检测**

嘴唇精确位置检测，关系到唇彩的准确度，进而影响美妆的整体效果。这里我介绍两种简单的嘴唇检测算法： 
\- 1. 基于YIQ颜色空间的唇色检测算法 
-参考论文：基于肤色和唇色信息的人脸检测方法的研究

```
算法原理：在YIQ颜色空间中，Y表示亮度信号，I和Q表示色度信号，Q分量代表的颜色变化正好覆盖了嘴唇的颜色范围，因此，通过对嘴唇样本的分析，得到嘴唇区域在YIQ颜色空间中的分布范围，以此来判断唇色。
YIQ颜色空间与RGB颜色空间对应关系如下：
 Y  = 0.299 * r + 0.587 * g + 0.114 * b;
 I  = 0.596 * r - 0.275 * g - 0.321 * b;
 Q  = 0.212 * r - 0.523 * g + 0.311 * b;
12345
```

唇色统计的分布结果：

| 分量 | 范围     |
| ---- | -------- |
| Y    | [80,220] |
| I    | [12,78]  |
| Q    | [7,25]   |

对于当前像素P(x,y)，先转换为YIQ，然后分辨判断YIQ分量是否符合上述唇色分布结果，如果符合，则该像素为唇色像素。 
-2. 基于R,G分量分析的唇色检测算法 
-参考文献：一种快速鲁棒的唇部检测方法 
这个算法主要是提出了一个唇色判断公式： 



logG(B0.391∗R0.609)<Tlog⁡G(B0.391∗R0.609)<T

这个公式的由来，是作者根据另外一篇文献TW Lewis.Lip feature extraction using ed exclusion.改进而来，至于原因什么的我们不用关心，我们关心的是如何最简单的理解与实现效果呵呵。

 

这篇论文中并没有给出T的取值，这里我给一个经验值:T= - 0.15;

 

公式中的B,R自然就是RGB颜色空间的对应分量了，对应于某个像素P(x,y)，如果符合这个公式，那么，这个像素就是唇色像素了。

 

-3. 算法效果

 

以上两种算法的效果如下所示：

 



 

以上两种方法是基于颜色空间唇色统计的方法，具有速度快，计算简单的特点，但是，由于统计的结果只代表大多数，并非全部，因此，这两种像素都不可能完全判断各种条件下的唇色像素，尤其是不同环境光条件下，容易出现误判。对于这个缺点，一般，我们会在人脸识别后，得到嘴唇的大概位置，在这个大概位置中，使用这些算法，这样一般就可以检测到相对准确的嘴唇区域了，后期在结合一些形态学算子，就可以得到准确的嘴唇区域了，对于唇彩涂色，也就完成了关键的一步了。



### **嘴唇涂色**

嘴唇涂色就是根据嘴唇检测得到的准确区域，结合颜色Color的RGB值对其进行上色的过程。 
嘴唇涂色一般使用YUV颜色空间，Y表示灰度值，UV表示颜色特征。假设嘴唇区域某像素P(x,y)，涂色值Color(R,G,B),我们先计算P的Y值，然后计算Color的UV值，这样我们就得到了涂色之后的目标YUV，在将这个YUV映射到RGB即可。

### **主要代码**

这里放上嘴唇检测的代码程序，供大家参考：

```csharp
        public Bitmap LipsDetectBmp(Bitmap src)
        {
            Bitmap a = new Bitmap(src);
            int w = a.Width;
            int h = a.Height;
            BitmapData srcData = a.LockBits(new Rectangle(0, 0, a.Width, a.Height), ImageLockMode.ReadWrite, PixelFormat.Format32bppArgb);
            byte* p = (byte*)srcData.Scan0;
            int r = 0, g = 0, b = 0, offset = srcData.Stride - w * 4;
            double Y = 0, I = 0, Q = 0;
            double k = 0;
            for (int j = 0; j < h; j++)
            {
                for (int i = 0; i < w; i++)
                {
                    b = p[0];
                    g = p[1];
                    r = p[2];
                    ////////////////Process image...
                    //算法1
                    Y = 0.299 * r + 0.587 * g + 0.114 * b;
                    I = 0.596 * r - 0.275 * g - 0.321 * b;
                    Q = 0.212 * r - 0.523 * g + 0.311 * b;
                    if ((Y >= 80 && Y <= 220 && I >= 12 && I <= 78 && Q >= 7 && Q <= 25))
                    {
                        p[0] = (byte)255;
                        p[1] = 0;
                        p[2] = (byte)255;
                    }
                    //算法2
                    //k = Math.Log((double)g / (Math.Pow((double)b, 0.391) * Math.Pow((double)r, 0.609)));//使用算法                    ////2时把算法1注释掉即可
                    //if (k < -0.15)
                    //{
                    //    p[0] = (byte)255;
                    //    p[1] = 0;
                    //    p[2] = (byte)255;
                    //}
                    p += 4;
                }
                p += offset;
            }
            a.UnlockBits(srcData);
            return a;
        }
```

## **总结**

以上就是美妆算法中的唇彩算法过程了，跟大家分享一下，共勉！有什么不明白的可以给我留言或邮件dongtingyue@163.com 
最后，分享一个专业的图像处理网站，里面有很多源代码下载： 
<http://www.zealpixel.com/portal.php>