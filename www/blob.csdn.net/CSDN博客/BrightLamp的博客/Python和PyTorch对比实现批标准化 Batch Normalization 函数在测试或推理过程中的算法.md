
# Python和PyTorch对比实现批标准化 Batch Normalization 函数在测试或推理过程中的算法 - BrightLamp的博客 - CSDN博客


2018年12月30日 15:45:48[BrightLampCsdn](https://me.csdn.net/oBrightLamp)阅读数：125



## 摘要
本文使用Python和PyTorch对比实现批标准化 Batch Normalization 函数在测试或推理过程中的算法.
## 相关
*原理及详细解释, 请参考文章 :*
Batch Normalization的测试或推理过程及样本参数更新方法.
*系列文章索引 :*
[https://blog.csdn.net/oBrightLamp/article/details/85067981](https://blog.csdn.net/oBrightLamp/article/details/85067981)
## 正文
## 1. Batch Normalization 类
文件目录 : vanilla_nn/batch_normalization.py
```python
import
```
```python
numpy
```
```python
as
```
```python
np
```
```python
class
```
```python
BatchNorm1d
```
```python
:
```
```python
def
```
```python
__init__
```
```python
(
```
```python
self
```
```python
,
```
```python
train
```
```python
=
```
```python
True
```
```python
,
```
```python
momentum
```
```python
=
```
```python
0.1
```
```python
,
```
```python
eps
```
```python
=
```
```python
1e
```
```python
-
```
```python
5
```
```python
)
```
```python
:
```
```python
self
```
```python
.
```
```python
train
```
```python
=
```
```python
train
        self
```
```python
.
```
```python
momentum
```
```python
=
```
```python
momentum
        self
```
```python
.
```
```python
eps
```
```python
=
```
```python
eps
        self
```
```python
.
```
```python
weight
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
bias
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
std
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
dw
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
db
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
sqrt
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
std
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
running_mean
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
running_var
```
```python
=
```
```python
None
```
```python
def
```
```python
__call__
```
```python
(
```
```python
self
```
```python
,
```
```python
x
```
```python
)
```
```python
:
```
```python
if
```
```python
self
```
```python
.
```
```python
train
```
```python
is
```
```python
True
```
```python
:
```
```python
mean
```
```python
=
```
```python
np
```
```python
.
```
```python
mean
```
```python
(
```
```python
x
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
,
```
```python
keepdims
```
```python
=
```
```python
True
```
```python
)
```
```python
var
```
```python
=
```
```python
np
```
```python
.
```
```python
var
```
```python
(
```
```python
x
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
,
```
```python
keepdims
```
```python
=
```
```python
True
```
```python
)
```
```python
sqrt
```
```python
=
```
```python
np
```
```python
.
```
```python
sqrt
```
```python
(
```
```python
var
```
```python
+
```
```python
self
```
```python
.
```
```python
eps
```
```python
)
```
```python
std
```
```python
=
```
```python
(
```
```python
x
```
```python
-
```
```python
mean
```
```python
)
```
```python
/
```
```python
sqrt
            self
```
```python
.
```
```python
sqrt
```
```python
=
```
```python
sqrt
            self
```
```python
.
```
```python
std
```
```python
=
```
```python
std
```
```python
if
```
```python
self
```
```python
.
```
```python
running_mean
```
```python
is
```
```python
None
```
```python
:
```
```python
self
```
```python
.
```
```python
running_mean
```
```python
=
```
```python
np
```
```python
.
```
```python
zeros_like
```
```python
(
```
```python
mean
```
```python
)
```
```python
self
```
```python
.
```
```python
running_var
```
```python
=
```
```python
np
```
```python
.
```
```python
ones_like
```
```python
(
```
```python
var
```
```python
)
```
```python
num
```
```python
=
```
```python
np
```
```python
.
```
```python
shape
```
```python
(
```
```python
x
```
```python
)
```
```python
[
```
```python
0
```
```python
]
```
```python
self
```
```python
.
```
```python
running_mean
```
```python
=
```
```python
(
```
```python
1
```
```python
-
```
```python
self
```
```python
.
```
```python
momentum
```
```python
)
```
```python
*
```
```python
self
```
```python
.
```
```python
running_mean
            self
```
```python
.
```
```python
running_mean
```
```python
+=
```
```python
self
```
```python
.
```
```python
momentum
```
```python
*
```
```python
mean
            self
```
```python
.
```
```python
running_var
```
```python
=
```
```python
(
```
```python
1
```
```python
-
```
```python
self
```
```python
.
```
```python
momentum
```
```python
)
```
```python
*
```
```python
self
```
```python
.
```
```python
running_var
            self
```
```python
.
```
```python
running_var
```
```python
+=
```
```python
self
```
```python
.
```
```python
momentum
```
```python
*
```
```python
var
```
```python
*
```
```python
num
```
```python
/
```
```python
(
```
```python
num
```
```python
-
```
```python
1
```
```python
)
```
```python
else
```
```python
:
```
```python
mean
```
```python
=
```
```python
self
```
```python
.
```
```python
running_mean
            var
```
```python
=
```
```python
self
```
```python
.
```
```python
running_var
            sqrt
```
```python
=
```
```python
np
```
```python
.
```
```python
sqrt
```
```python
(
```
```python
var
```
```python
+
```
```python
self
```
```python
.
```
```python
eps
```
```python
)
```
```python
std
```
```python
=
```
```python
(
```
```python
x
```
```python
-
```
```python
mean
```
```python
)
```
```python
/
```
```python
sqrt
        out
```
```python
=
```
```python
std
```
```python
*
```
```python
self
```
```python
.
```
```python
weight
```
```python
+
```
```python
self
```
```python
.
```
```python
bias
```
```python
return
```
```python
out
```
```python
def
```
```python
backward
```
```python
(
```
```python
self
```
```python
,
```
```python
d_loss
```
```python
)
```
```python
:
```
```python
std_t
```
```python
=
```
```python
self
```
```python
.
```
```python
std
```
```python
.
```
```python
T
        shape_t
```
```python
=
```
```python
np
```
```python
.
```
```python
shape
```
```python
(
```
```python
std_t
```
```python
)
```
```python
r
```
```python
=
```
```python
np
```
```python
.
```
```python
zeros
```
```python
(
```
```python
[
```
```python
shape_t
```
```python
[
```
```python
0
```
```python
]
```
```python
,
```
```python
shape_t
```
```python
[
```
```python
1
```
```python
]
```
```python
,
```
```python
shape_t
```
```python
[
```
```python
1
```
```python
]
```
```python
]
```
```python
)
```
```python
shift_eye
```
```python
=
```
```python
np
```
```python
.
```
```python
eye
```
```python
(
```
```python
shape_t
```
```python
[
```
```python
1
```
```python
]
```
```python
)
```
```python
*
```
```python
shape_t
```
```python
[
```
```python
1
```
```python
]
```
```python
-
```
```python
1
```
```python
for
```
```python
i
```
```python
in
```
```python
range
```
```python
(
```
```python
shape_t
```
```python
[
```
```python
0
```
```python
]
```
```python
)
```
```python
:
```
```python
r
```
```python
[
```
```python
i
```
```python
]
```
```python
=
```
```python
std_t
```
```python
[
```
```python
i
```
```python
]
```
```python
[
```
```python
:
```
```python
,
```
```python
np
```
```python
.
```
```python
newaxis
```
```python
]
```
```python
*
```
```python
std_t
```
```python
[
```
```python
i
```
```python
]
```
```python
[
```
```python
np
```
```python
.
```
```python
newaxis
```
```python
,
```
```python
:
```
```python
]
```
```python
r
```
```python
[
```
```python
i
```
```python
]
```
```python
=
```
```python
shift_eye
```
```python
-
```
```python
r
```
```python
[
```
```python
i
```
```python
]
```
```python
u
```
```python
=
```
```python
self
```
```python
.
```
```python
weight
```
```python
/
```
```python
shape_t
```
```python
[
```
```python
1
```
```python
]
```
```python
/
```
```python
self
```
```python
.
```
```python
sqrt
        u
```
```python
=
```
```python
u
```
```python
.
```
```python
T
        y
```
```python
=
```
```python
r
```
```python
*
```
```python
u
```
```python
[
```
```python
:
```
```python
,
```
```python
np
```
```python
.
```
```python
newaxis
```
```python
]
```
```python
dx
```
```python
=
```
```python
np
```
```python
.
```
```python
zeros
```
```python
(
```
```python
shape_t
```
```python
)
```
```python
for
```
```python
i
```
```python
in
```
```python
range
```
```python
(
```
```python
shape_t
```
```python
[
```
```python
0
```
```python
]
```
```python
)
```
```python
:
```
```python
dx
```
```python
[
```
```python
i
```
```python
]
```
```python
=
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
d_loss
```
```python
.
```
```python
T
```
```python
[
```
```python
i
```
```python
]
```
```python
,
```
```python
y
```
```python
[
```
```python
i
```
```python
]
```
```python
)
```
```python
dx
```
```python
=
```
```python
dx
```
```python
.
```
```python
T
        self
```
```python
.
```
```python
dw
```
```python
=
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
self
```
```python
.
```
```python
std
```
```python
*
```
```python
d_loss
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
self
```
```python
.
```
```python
db
```
```python
=
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
d_loss
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
return
```
```python
dx
```
## 2. Batch Normalization 推理测试
```python
import
```
```python
torch
```
```python
import
```
```python
numpy
```
```python
as
```
```python
np
```
```python
from
```
```python
vanilla_nn
```
```python
.
```
```python
batch_normalization
```
```python
import
```
```python
BatchNorm1d
np
```
```python
.
```
```python
set_printoptions
```
```python
(
```
```python
precision
```
```python
=
```
```python
8
```
```python
,
```
```python
suppress
```
```python
=
```
```python
True
```
```python
,
```
```python
linewidth
```
```python
=
```
```python
120
```
```python
)
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
seed
```
```python
(
```
```python
123
```
```python
)
```
```python
torch
```
```python
.
```
```python
random
```
```python
.
```
```python
manual_seed
```
```python
(
```
```python
123
```
```python
)
```
```python
nums
```
```python
=
```
```python
3
```
```python
x_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
array
```
```python
(
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
nums
```
```python
,
```
```python
3
```
```python
,
```
```python
5
```
```python
)
```
```python
)
```
```python
,
```
```python
dtype
```
```python
=
```
```python
np
```
```python
.
```
```python
float64
```
```python
)
```
```python
weight_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
array
```
```python
(
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
5
```
```python
,
```
```python
)
```
```python
)
```
```python
,
```
```python
dtype
```
```python
=
```
```python
np
```
```python
.
```
```python
float64
```
```python
)
```
```python
bias_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
array
```
```python
(
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
5
```
```python
,
```
```python
)
```
```python
)
```
```python
,
```
```python
dtype
```
```python
=
```
```python
np
```
```python
.
```
```python
float64
```
```python
)
```
```python
x_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
x_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
weight_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
weight_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
bias_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
bias_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
batch_norm_numpy
```
```python
=
```
```python
BatchNorm1d
```
```python
(
```
```python
momentum
```
```python
=
```
```python
0.2
```
```python
)
```
```python
batch_norm_numpy
```
```python
.
```
```python
weight
```
```python
=
```
```python
weight_numpy
batch_norm_numpy
```
```python
.
```
```python
bias
```
```python
=
```
```python
bias_numpy
batch_norm_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
nn
```
```python
.
```
```python
BatchNorm1d
```
```python
(
```
```python
5
```
```python
,
```
```python
momentum
```
```python
=
```
```python
0.2
```
```python
)
```
```python
.
```
```python
double
```
```python
(
```
```python
)
```
```python
batch_norm_tensor
```
```python
.
```
```python
weight
```
```python
=
```
```python
torch
```
```python
.
```
```python
nn
```
```python
.
```
```python
Parameter
```
```python
(
```
```python
weight_tensor
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
batch_norm_tensor
```
```python
.
```
```python
bias
```
```python
=
```
```python
torch
```
```python
.
```
```python
nn
```
```python
.
```
```python
Parameter
```
```python
(
```
```python
bias_tensor
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
print
```
```python
(
```
```python
"output_numpy"
```
```python
)
```
```python
for
```
```python
i
```
```python
in
```
```python
range
```
```python
(
```
```python
nums
```
```python
)
```
```python
:
```
```python
output_numpy
```
```python
=
```
```python
batch_norm_numpy
```
```python
(
```
```python
x_numpy
```
```python
[
```
```python
i
```
```python
]
```
```python
)
```
```python
print
```
```python
(
```
```python
output_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
"output_tensor"
```
```python
)
```
```python
for
```
```python
i
```
```python
in
```
```python
range
```
```python
(
```
```python
nums
```
```python
)
```
```python
:
```
```python
output_tensor
```
```python
=
```
```python
batch_norm_tensor
```
```python
(
```
```python
x_tensor
```
```python
[
```
```python
i
```
```python
]
```
```python
)
```
```python
print
```
```python
(
```
```python
output_tensor
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"eval_numpy"
```
```python
)
```
```python
batch_norm_numpy
```
```python
.
```
```python
train
```
```python
=
```
```python
False
```
```python
for
```
```python
i
```
```python
in
```
```python
range
```
```python
(
```
```python
nums
```
```python
)
```
```python
:
```
```python
output_numpy
```
```python
=
```
```python
batch_norm_numpy
```
```python
(
```
```python
x_numpy
```
```python
[
```
```python
i
```
```python
]
```
```python
)
```
```python
print
```
```python
(
```
```python
output_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
"eval_tensor"
```
```python
)
```
```python
batch_norm_tensor
```
```python
.
```
```python
eval
```
```python
(
```
```python
)
```
```python
for
```
```python
i
```
```python
in
```
```python
range
```
```python
(
```
```python
nums
```
```python
)
```
```python
:
```
```python
output_tensor
```
```python
=
```
```python
batch_norm_tensor
```
```python
(
```
```python
x_tensor
```
```python
[
```
```python
i
```
```python
]
```
```python
)
```
```python
print
```
```python
(
```
```python
output_tensor
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
"""
output_numpy
[[ 0.46641115  0.18851114 -0.57237571  0.99333476  1.2092339 ]
 [ 0.01389322  1.35696463  1.83911376  0.82492271 -0.10234434]
 [-0.11841836  0.93354663  0.54244234 -0.18305345 -0.07859806]]
[[ 0.36607296  0.34287603 -0.19635263  0.74842757 -0.41712586]
 [ 0.21899343  1.48596725  1.99143145  1.05458233  1.08250983]
 [-0.22318039  0.65017912  0.01410157 -0.16780589  0.36290753]]
[[-0.16707033  1.17972157  0.14300413  0.26912336 -0.20601642]
 [ 0.08560938  1.15577836  1.97239442  1.27262803  0.03626041]
 [ 0.44334695  0.14352248 -0.30621817  0.09345263  1.19804751]]
output_tensor
[[ 0.46641115  0.18851114 -0.57237571  0.99333476  1.2092339 ]
 [ 0.01389322  1.35696463  1.83911376  0.82492271 -0.10234434]
 [-0.11841836  0.93354663  0.54244234 -0.18305345 -0.07859806]]
[[ 0.36607296  0.34287603 -0.19635263  0.74842757 -0.41712586]
 [ 0.21899343  1.48596725  1.99143145  1.05458233  1.08250983]
 [-0.22318039  0.65017912  0.01410157 -0.16780589  0.36290753]]
[[-0.16707033  1.17972157  0.14300413  0.26912336 -0.20601642]
 [ 0.08560938  1.15577836  1.97239442  1.27262803  0.03626041]
 [ 0.44334695  0.14352248 -0.30621817  0.09345263  1.19804751]]
eval_numpy
[[ 0.28282795  0.86633722  0.60257693  0.76006332  0.70923752]
 [ 0.18949885  1.31733272  1.21007392  0.71038713  0.43339924]
 [ 0.16221038  1.15390335  0.88341938  0.41306631  0.43839332]]
[[ 0.29700547  0.79904247  0.53439649  0.74611433  0.55112404]
 [ 0.26163716  1.23206321  1.26263629  0.80220571  0.71174387]
 [ 0.15530735  0.91545366  0.60444962  0.57824888  0.63467022]]
[[ 0.07649121  0.96214393  0.87319294  0.71938833  0.46180685]
 [ 0.15165504  0.95737192  1.48672289  1.03733326  0.52585261]
 [ 0.2580701   0.75562397  0.72253546  0.66372978  0.83297043]]
eval_tensor
[[ 0.28282795  0.86633722  0.60257693  0.76006332  0.70923752]
 [ 0.18949885  1.31733272  1.21007392  0.71038713  0.43339924]
 [ 0.16221038  1.15390335  0.88341938  0.41306631  0.43839332]]
[[ 0.29700547  0.79904247  0.53439649  0.74611433  0.55112404]
 [ 0.26163716  1.23206321  1.26263629  0.80220571  0.71174387]
 [ 0.15530735  0.91545366  0.60444962  0.57824888  0.63467022]]
[[ 0.07649121  0.96214393  0.87319294  0.71938833  0.46180685]
 [ 0.15165504  0.95737192  1.48672289  1.03733326  0.52585261]
 [ 0.2580701   0.75562397  0.72253546  0.66372978  0.83297043]]
"""
```

