
# linux input&&uevent使用 - 嵌入式Linux - CSDN博客

2016年01月06日 11:34:02[写代码的篮球球痴](https://me.csdn.net/weiqifa0)阅读数：1355



## input 输入子系统
在应用层使用的时候，容易出现找不到UEventObserver.java 这时候就要导入jar包
导入classes.jar这个jar包
```python
weiqifa
```
```python
@weiqifa
```
```python
-
```
```python
Inspiron
```
```python
-
```
```python
3847
```
```python
:~/weiqifa/tm100
```
```python
$
```
```python
ls out/target/common/obj/
```
```python
JAVA_LIBRARIES
```
```python
/framework_intermediates/
classes  classes.dex  classes-full-debug.jar  classes.jar  classes-jarjar.jar  emma_out  javalib.jar  noproguard.classes.jar  noproguard.classes-with-local.dex
weiqifa
```
```python
@weiqifa
```
```python
-
```
```python
Inspiron
```
```python
-
```
```python
3847
```
```python
:~/weiqifa/tm100
```
```python
$
```
**问题：最近我自己比较了这两个的作用，我们以前经常用这个来获取底层上报的值，用来做usb插入，键盘输入等**
**区别： input 如果上报的值是1 ,在framework里面就一直获取这个键值，这个是按键的特性**
```python
D/WindowManager(
```
```python
632
```
```python
): interceptKeyTi keyCode=
```
```python
42
```
```python
down=
```
```python
true
```
```python
repeatCount=
```
```python
1427
```
```python
keyguardOn=
```
```python
true
```
```python
mHomePressed=
```
```python
false
```
```python
canceled=
```
```python
false
```
```python
metaState:
```
```python
0
```
```python
D/WindowManager(
```
```python
632
```
```python
): interceptKeyTi keyCode=
```
```python
42
```
```python
down=
```
```python
true
```
```python
repeatCount=
```
```python
1428
```
```python
keyguardOn=
```
```python
true
```
```python
mHomePressed=
```
```python
false
```
```python
canceled=
```
```python
false
```
```python
metaState:
```
```python
0
```
```python
D/WindowManager(
```
```python
632
```
```python
): interceptKeyTi keyCode=
```
```python
42
```
```python
down=
```
```python
true
```
```python
repeatCount=
```
```python
1429
```
```python
keyguardOn=
```
```python
true
```
```python
mHomePressed=
```
```python
false
```
```python
canceled=
```
```python
false
```
```python
metaState:
```
```python
0
```
```python
D/WindowManager(
```
```python
632
```
```python
): interceptKeyTi keyCode=
```
```python
42
```
```python
down=
```
```python
true
```
```python
repeatCount=
```
```python
1430
```
```python
keyguardOn=
```
```python
true
```
```python
mHomePressed=
```
```python
false
```
```python
canceled=
```
```python
false
```
```python
metaState:
```
```python
0
```
```python
D/WindowManager(
```
```python
632
```
```python
): interceptKeyTi keyCode=
```
```python
42
```
```python
down=
```
```python
true
```
```python
repeatCount=
```
```python
1431
```
```python
keyguardOn=
```
```python
true
```
```python
mHomePressed=
```
```python
false
```
```python
canceled=
```
```python
false
```
```python
metaState:
```
```python
0
```
## linux uevent
**这个就是比input区别在于输入的时候不会一直上报1,使用也比较方便**
**底层发送的关键代码**
```python
char
```
```python
*envp
```
```python
[
```
```python
2
```
```python
];
```
```python
int
```
```python
ret;
```
```python
if
```
```python
(work_flag==true)
    {
        envp[
```
```python
0
```
```python
]=
```
```python
"CAMERA=close"
```
```python
;
        envp[
```
```python
1
```
```python
]=NULL;
```
```python
//
```
```python
关键是kobj这个kobj 要从生成dev的地方去找到
        ret = kobject_uevent_env(&hdyrodent_hall_class_dev->kobj, KOBJ_CHANGE,envp);
```
```python
if
```
```python
(ret<
```
```python
0
```
```python
){
            printk(
```
```python
"
```
```python
%s
```
```python
kobject error\n"
```
```python
,__func_
```
```python
_
```
```python
);  
        }
```
```python
else
```
```python
{
            printk(
```
```python
"
```
```python
%s
```
```python
kobject uevent report close success!!!\n"
```
```python
,__func_
```
```python
_
```
```python
);     
        }   
        printk(
```
```python
"------------>
```
```python
%s
```
```python
<------------
```
```python
%s
```
```python
\n"
```
```python
,__FUNCTION_
```
```python
_
```
```python
,kobject_get_path(&hdyrodent_hall_class_dev->kobj,GFP_KERNEL));
    }
```
**Android接收**
**event.get(“CAMERA”); 这个是上报的=号前面的，然后就可以获取来比较就可以了**
```python
//weiqifa modify for the hall uevent
```
```python
private
```
```python
UEventObserver mHALLObserver =
```
```python
new
```
```python
UEventObserver() {
        @Override
```
```python
public
```
```python
void
```
```python
onUEvent
```
```python
(UEventObserver.UEvent
```
```python
event
```
```python
) {
            String camera =
```
```python
event
```
```python
.
```
```python
get
```
```python
(
```
```python
"CAMERA"
```
```python
);
            Slog.d(TAG,
```
```python
"------------------------------->camera="
```
```python
+ camera);
```
```python
if
```
```python
(
```
```python
"open"
```
```python
.equals(
```
```python
event
```
```python
.
```
```python
get
```
```python
(
```
```python
"CAMERA"
```
```python
))){
```
```python
//磁铁离开的时候这时候应该是打开摄像头的时候
```
```python
Slog.d(TAG,
```
```python
"------------------------------->Open the camera app!!!!="
```
```python
+ camera);
                Intent intent =
```
```python
new
```
```python
Intent(
```
```python
"com.key.android.KEY_CAMERA_OPEN"
```
```python
);
                mContext.sendBroadcast(intent);
                startAPP(
```
```python
"com.android.gallery3d"
```
```python
);
            }
```
```python
else
```
```python
if
```
```python
(
```
```python
"close"
```
```python
.equals(
```
```python
event
```
```python
.
```
```python
get
```
```python
(
```
```python
"CAMERA"
```
```python
))){
```
```python
//磁铁接触的时候就会一直发送down 过来 这时候应该是关闭摄像头的
```
```python
Slog.d(TAG,
```
```python
"------------------------------->Close the camera app!!!!="
```
```python
+ camera);
                Intent intent =
```
```python
new
```
```python
Intent(
```
```python
"com.key.android.KEY_CAMERA_CLOSE"
```
```python
);
                mContext.sendBroadcast(intent);
                stopAPP(
```
```python
"com.android.gallery3d"
```
```python
);
                WriteInt(
```
```python
"/sys/class/hdyrodent/cameraflash"
```
```python
,
```
```python
0
```
```python
);
```
```python
//关闭闪光灯
```
```python
}           
        }
    };
```
**然后再找个地方运行一下这句代码**
```python
//weiqifa modify
```
```python
add
```
```python
mHALLObserver
```
```python
.startObserving
```
```python
(
```
```python
"DEVPATH=/devices/virtual/hdyrodent_hall_class/hdyrodent_hall"
```
```python
)
```
```python
;
```
**/devices/virtual/hdyrodent_hall_class/hdyrodent_hall  这个是我们在驱动下面生成的，驱动上报的时候我用个函数把它打印出来了，前面的DEVPATH=这个是一定要加的。**
**然后我还是写一下这个目录是怎么来的，看下面的代码**
```python
//weiqifa modify for hall
```
```python
hdyrodent_hall_
```
```python
class
```
```python
=
```
```python
class_create
```
```python
(THIS_MODULE,
```
```python
"hdyrodent_hall_class"
```
```python
)
```
```python
;
```
```python
if
```
```python
(IS_ERR(hdyrodent_hall_class)) {
               pr_err(
```
```python
"%s: class_create() failed hdyrodent_hall_class\n"
```
```python
, __func__);
            class_destroy(hdyrodent_hall_class);
    }
```
```python
//add device to class
```
```python
hdyrodent_hall_class_dev = device_create(hdyrodent_hall_class, NULL,
                  hdyrodent_hall_device_no, NULL,
```
```python
"hdyrodent_hall"
```
```python
);
```
```python
if
```
```python
(!hdyrodent_hall_class_dev) {
        pr_err(
```
```python
"%s: class_device_create failed hdyrodent_hall \n"
```
```python
, __func__);
        device_destroy(hdyrodent_hall_class, hdyrodent_hall_device_no);
    }
```
```python
//weiqifa modify for hall end
```
底层例子
```python
/*
 * drivers/leds/leds-mt65xx.c
 *
 * This file is subject to the terms and conditions of the GNU General Public
 * License.  See the file COPYING in the main directory of this archive for
 * more details.
 *
 * Hydrodent weiqifa modify add
 *
 */
```
```python
#include <linux/module.h>
```
```python
#include <linux/delay.h>
```
```python
#include <linux/device.h>
```
```python
#include <linux/input.h>
```
```python
#include <mach/upmu_hw.h>
```
```python
#include <mach/mt_boot.h>
```
```python
#include <mach/mt_gpio.h>
```
```python
#include <mach/eint.h>
```
```python
#include <cust_eint.h>
```
```python
#include "cust_gpio_usage.h"
```
```python
#include <mach/mt_pm_ldo.h>
```
```python
#include <linux/workqueue.h>
```
```python
extern
```
```python
void
```
```python
mt_eint_unmask(
```
```python
unsigned
```
```python
int
```
```python
eint_num);
```
```python
extern
```
```python
void
```
```python
mt_eint_set_polarity(
```
```python
unsigned
```
```python
int
```
```python
eint_num,
```
```python
unsigned
```
```python
int
```
```python
pol);
```
```python
extern
```
```python
void
```
```python
mt_eint_set_hw_debounce(
```
```python
unsigned
```
```python
int
```
```python
eintno,
```
```python
unsigned
```
```python
int
```
```python
ms);
```
```python
extern
```
```python
unsigned
```
```python
int
```
```python
mt_eint_set_sens(
```
```python
unsigned
```
```python
int
```
```python
eintno,
```
```python
unsigned
```
```python
int
```
```python
sens);
```
```python
extern
```
```python
void
```
```python
mt_eint_registration(
```
```python
unsigned
```
```python
int
```
```python
eint_num,
```
```python
unsigned
```
```python
int
```
```python
flag,
```
```python
void
```
```python
(EINT_FUNC_PTR) (
```
```python
void
```
```python
),
```
```python
unsigned
```
```python
int
```
```python
is_auto_umask);
```
```python
//struct input_dev *hdy_input_dev;
```
```python
static
```
```python
struct
```
```python
class
```
```python
*hdyrodent_hall_class = NULL;
```
```python
//weiqifa modify add
```
```python
static
```
```python
dev_t hdyrodent_hall_device_no;
```
```python
//weiqifa modify add
```
```python
struct
```
```python
device *hdyrodent_hall_class_dev;
```
```python
//weiqifa modify add
```
```python
struct
```
```python
work_struct hall_work;
```
```python
struct
```
```python
workqueue_struct *hall_wq;
```
```python
static
```
```python
bool
```
```python
work_flag=
```
```python
false
```
```python
;
```
```python
void
```
```python
hall_func(
```
```python
struct
```
```python
work_struct *work)
{
```
```python
char
```
```python
*envp[
```
```python
2
```
```python
];
```
```python
int
```
```python
ret;
```
```python
if
```
```python
(work_flag==
```
```python
true
```
```python
)
    {
        envp[
```
```python
0
```
```python
]=
```
```python
"CAMERA=close"
```
```python
;
        envp[
```
```python
1
```
```python
]=NULL;
        ret = kobject_uevent_env(&hdyrodent_hall_class_dev->kobj, KOBJ_CHANGE,envp);
```
```python
if
```
```python
(ret<
```
```python
0
```
```python
){
            printk(
```
```python
"%s kobject error\n"
```
```python
,__func__);  
        }
```
```python
else
```
```python
{
            printk(
```
```python
"%s kobject uevent report close success!!!\n"
```
```python
,__func__);     
        }   
        printk(
```
```python
"------------>%s<------------%s\n"
```
```python
,__FUNCTION__,kobject_get_path(&hdyrodent_hall_class_dev->kobj,GFP_KERNEL));
    }
```
```python
else
```
```python
if
```
```python
(work_flag==
```
```python
false
```
```python
)
    {
        envp[
```
```python
0
```
```python
]=
```
```python
"CAMERA=open"
```
```python
;
        envp[
```
```python
1
```
```python
]=NULL;
        ret = kobject_uevent_env(&hdyrodent_hall_class_dev->kobj, KOBJ_CHANGE,envp);
```
```python
if
```
```python
(ret<
```
```python
0
```
```python
){
            printk(
```
```python
"%s kobject error\n"
```
```python
,__func__);  
        }
```
```python
else
```
```python
{
            printk(
```
```python
"%s kobject uevent report open success!!!\n"
```
```python
,__func__);      
        }
        printk(
```
```python
"------------>%s<------------%s\n"
```
```python
,__FUNCTION__,kobject_get_path(&hdyrodent_hall_class_dev->kobj,GFP_KERNEL));
    }   
}
```
```python
//中断服务函数
```
```python
void
```
```python
hal_eint_interrupt_handler(
```
```python
void
```
```python
)
{
```
```python
char
```
```python
*envp[
```
```python
2
```
```python
];
```
```python
int
```
```python
ret;
    printk(
```
```python
"------------>%s<------------ GPIO_MHALL_EINT_PIN value=%d\n"
```
```python
,__FUNCTION__,mt_get_gpio_in(GPIO_MHALL_EINT_PIN));
```
```python
/*设置中断触发方式，打开摄像头后产生了一次中断，然后改变中断触发方式，关闭摄像头后又会产生一次关闭摄像头的中断*/
```
```python
if
```
```python
(mt_get_gpio_in(GPIO_MHALL_EINT_PIN))
    {
        mt_eint_set_polarity(CUST_EINT_MHALL_NUM, MT_EINT_POL_NEG);
```
```python
//中断触发方式设置成下降沿  关闭摄像头
```
```python
queue_work(hall_wq, &hall_work);
        work_flag=
```
```python
false
```
```python
;
    }
```
```python
else
```
```python
{
        mt_eint_set_polarity(CUST_EINT_MHALL_NUM, MT_EINT_POL_POS);
```
```python
//中断触发方式设置成上升沿  打开摄像头
```
```python
queue_work(hall_wq, &hall_work);
        work_flag=
```
```python
true
```
```python
;     
    }
    mt_eint_unmask(CUST_EINT_MHALL_NUM);    
}
```
```python
static
```
```python
int
```
```python
__init hdyrodent_hall_init(
```
```python
void
```
```python
)
{
```
```python
int
```
```python
err = -
```
```python
1
```
```python
;
```
```python
//int r=0;
```
```python
hall_wq=create_workqueue(
```
```python
"hall_wq"
```
```python
);
    printk(
```
```python
"%s mhall_pin value=%d start\n"
```
```python
,__FUNCTION__,mt_get_gpio_in(GPIO_MHALL_EINT_PIN));
```
```python
//weiqifa modify for hall
```
```python
hdyrodent_hall_class = class_create(THIS_MODULE,
```
```python
"hdyrodent_hall_class"
```
```python
);
```
```python
if
```
```python
(IS_ERR(hdyrodent_hall_class)) {
               pr_err(
```
```python
"%s: class_create() failed hdyrodent_hall_class\n"
```
```python
, __func__);
            class_destroy(hdyrodent_hall_class);
    }
```
```python
//add device to class
```
```python
hdyrodent_hall_class_dev = device_create(hdyrodent_hall_class, NULL,
                  hdyrodent_hall_device_no, NULL,
```
```python
"hdyrodent_hall"
```
```python
);
```
```python
if
```
```python
(!hdyrodent_hall_class_dev) {
        pr_err(
```
```python
"%s: class_device_create failed hdyrodent_hall \n"
```
```python
, __func__);
        device_destroy(hdyrodent_hall_class, hdyrodent_hall_device_no);
    }
```
```python
//weiqifa modify for hall end
```
```python
//霍尔开关电源控制
```
```python
if
```
```python
(hwPowerOn(MT6323_POWER_LDO_VIBR, VOL_2800,
```
```python
"VIBR"
```
```python
)) {
        printk(
```
```python
"Success: open the MT65XX_POWER_LDO_VIBR 2.8V\n"
```
```python
);
    }
```
```python
//Init the irq gpio1_interrupt
```
```python
mt_set_gpio_mode(GPIO_MHALL_EINT_PIN, GPIO_MHALL_EINT_PIN_M_EINT);
    mt_set_gpio_dir(GPIO_MHALL_EINT_PIN, GPIO_DIR_IN);
    mt_set_gpio_pull_enable(GPIO_MHALL_EINT_PIN, GPIO_PULL_ENABLE);
    mt_set_gpio_pull_select(GPIO_MHALL_EINT_PIN, GPIO_PULL_UP);
    msleep(
```
```python
50
```
```python
);
```
```python
/*
    mt_eint_set_hw_debounce
    设置抖动
    mt_eint_registration
    第一个是中断号，触发极性，第二个是设定是否开启抖动，第三个是绑定中断函数，第四个关闭中断
    mt_eint_unmask
    屏蔽中断    
    */
```
```python
mt_eint_set_hw_debounce(CUST_EINT_MHALL_NUM, CUST_EINT_MHALL_DEBOUNCE_CN);
    mt_eint_registration(CUST_EINT_MHALL_NUM, CUST_EINT_MHALL_TYPE, hal_eint_interrupt_handler,
```
```python
0
```
```python
);
    mt_eint_unmask(CUST_EINT_MHALL_NUM);
```
```python
//工作队列
```
```python
INIT_WORK(&hall_work, hall_func);
    printk(
```
```python
"%s end\n"
```
```python
, __FUNCTION__);
```
```python
return
```
```python
0
```
```python
;
}
```
```python
static
```
```python
void
```
```python
__exit hdyrodent_hall_exit(
```
```python
void
```
```python
)
{
    class_destroy(hdyrodent_hall_class);
    device_destroy(hdyrodent_hall_class, hdyrodent_hall_device_no);
    printk(
```
```python
"hdyrodent module cleanup OK!\n"
```
```python
);
}
MODULE_AUTHOR(
```
```python
"329410527@qq.com"
```
```python
);
MODULE_DESCRIPTION(
```
```python
"HDYRODENT HALL MODULE"
```
```python
);
MODULE_LICENSE(
```
```python
"GPL"
```
```python
);
MODULE_VERSION(
```
```python
"ver0.1"
```
```python
);
module_init(hdyrodent_hall_init);
module_exit(hdyrodent_hall_exit);
```

