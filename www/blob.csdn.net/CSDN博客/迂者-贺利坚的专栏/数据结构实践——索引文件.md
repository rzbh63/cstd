
# 数据结构实践——索引文件 - 迂者-贺利坚的专栏 - CSDN博客

2015年12月10日 08:05:38[迂者-贺利坚](https://me.csdn.net/sxhelijian)阅读数：4295


本文是针对[[数据结构基础系列(11)：文件](http://edu.csdn.net/course/detail/1789)]中的实践项目。
【项目】索引文件
有若干学生的成绩数据如下，将这些数据保存到st数组中：
```python
学号     姓名    年龄 性别 语文 数学 英语
    1      陈华    20   男   78   90   84
    5      张明    21   男   78   68   92
    8      王英    20   女   86   81   86
    3      刘丽    21   女   78   92   88
    2      许可    20   男   80   83   78
    4      陈军    20   男   78   88   82
    7      马胜    21   男   56   67   75
    6      曾强    20   男   78   89   82
```
基于这些数据，编程序实现下面的功能：
(1)将st数组中学生记录写入stud.dat文件作为主文件
(2)输出主文件中的学生记录
(3)建立与主文件相对应的索引文件，其中每个记录由两个字段组成：学号和该学生记录在数据文件中的位移量（例：上面列出数据中学号为2的学生许可，其位移量是5。由于本例用定长文件，可以根据位移量计算记录在主文件中的相对地址）。索引文件按学号有序。
(4)输出索引文件中的全部记录
(5)根据用户输入的学号，利用索引文件，用二分查找法找到对应的记录号，再通过主文件输出该记录
(6)是否有想法，将这个项目再扩充了？加大数据量、哈希文件、多关键字文件……
[参考解答]
```python
#include <stdio.h>
```
```python
#include <string.h>
```
```python
#include <malloc.h>
```
```python
#define MaxRec 100
```
```python
//最多的记录个数
```
```python
typedef
```
```python
struct
```
```python
Index
```
```python
//定义索引文件结构
```
```python
{
```
```python
int
```
```python
no;
```
```python
//学号
```
```python
long
```
```python
offset;
```
```python
//主文件中的记录号
```
```python
} Index;
```
```python
typedef
```
```python
struct
```
```python
{
```
```python
int
```
```python
no;
```
```python
//学号
```
```python
char
```
```python
name[
```
```python
10
```
```python
];
```
```python
//姓名
```
```python
int
```
```python
age;
```
```python
//年龄
```
```python
char
```
```python
sex[
```
```python
3
```
```python
];
```
```python
//性别
```
```python
int
```
```python
deg1,deg2,deg3;
```
```python
//课程1-课程3成绩
```
```python
} StudType;
```
```python
void
```
```python
InsertSort(Index R[],
```
```python
int
```
```python
n)
```
```python
//采用直接插入排序法对R[0..n-1]按学号递增排序
```
```python
{
```
```python
int
```
```python
i,j;
    Index temp;
```
```python
for
```
```python
(i=
```
```python
1
```
```python
; i<n; i++)
    {
        temp=R[i];
        j=i-
```
```python
1
```
```python
;
```
```python
while
```
```python
(j>=
```
```python
0
```
```python
&& temp.no<R[j].no)
        {
            R[j+
```
```python
1
```
```python
]=R[j];
```
```python
//将关键字大于R[i].key的记录后移
```
```python
j--;
        }
        R[j+
```
```python
1
```
```python
]=temp;
```
```python
//在j+1处插入R[i]
```
```python
}
}
```
```python
void
```
```python
CreatIdxFile()
```
```python
//建立索引文件
```
```python
{
    FILE *mfile,*idxfile;
    Index idx[MaxRec];
    StudType st;
```
```python
int
```
```python
n=
```
```python
0
```
```python
,i;
```
```python
if
```
```python
((mfile=fopen(
```
```python
"stud.dat"
```
```python
,
```
```python
"rb"
```
```python
))==NULL)
    {
```
```python
printf
```
```python
(
```
```python
"  提示:不能打开主文件\n"
```
```python
);
```
```python
return
```
```python
;
    }
```
```python
if
```
```python
((idxfile=fopen(
```
```python
"index.dat"
```
```python
,
```
```python
"wb"
```
```python
))==NULL)
    {
```
```python
printf
```
```python
(
```
```python
"  提示:不能建立索引文件\n"
```
```python
);
```
```python
return
```
```python
;
    }
    i=
```
```python
0
```
```python
;
```
```python
while
```
```python
((fread(&st,
```
```python
sizeof
```
```python
(StudType),
```
```python
1
```
```python
,mfile)))
    {
        idx[i].no=st.no;
        idx[i].offset=++n;
        i++;
    }
    InsertSort(idx,n);
```
```python
//对idx数组按no值排序
```
```python
rewind(idxfile);
```
```python
for
```
```python
(i=
```
```python
0
```
```python
; i<n; i++)
        fwrite(&idx[i],
```
```python
sizeof
```
```python
(Index),
```
```python
1
```
```python
,idxfile);
    fclose(mfile);
    fclose(idxfile);
```
```python
printf
```
```python
(
```
```python
"  提示:索引文件建立完毕\n"
```
```python
);
}
```
```python
void
```
```python
OutputMainFile()
```
```python
//输出主文件全部记录
```
```python
{
    FILE *mfile;
    StudType st;
```
```python
int
```
```python
i=
```
```python
1
```
```python
;
```
```python
if
```
```python
((mfile=fopen(
```
```python
"stud.dat"
```
```python
,
```
```python
"rb"
```
```python
))==NULL)
    {
```
```python
printf
```
```python
(
```
```python
"  提示:不能读主文件\n"
```
```python
);
```
```python
return
```
```python
;
    }
```
```python
printf
```
```python
(
```
```python
"                ----学生成绩表----\n"
```
```python
);
```
```python
printf
```
```python
(
```
```python
"记录号  学号     姓名   年龄 性别 语文 数学 英语\n"
```
```python
);
```
```python
while
```
```python
((fread(&st,
```
```python
sizeof
```
```python
(StudType),
```
```python
1
```
```python
,mfile))==
```
```python
1
```
```python
)
    {
```
```python
printf
```
```python
(
```
```python
"%6d%5d%10s%6d%5s%5d%5d%5d\n"
```
```python
,i,st.no,st.name,st.age,st.sex,st.deg1,st.deg2,st.deg3);
        i++;
    }
    fclose(mfile);
}
```
```python
void
```
```python
OutputIdxFile()
```
```python
//输出索引文件全部记录
```
```python
{
    FILE *idxfile;
    Index irec;
```
```python
printf
```
```python
(
```
```python
"     ----学生索引表----\n"
```
```python
);
```
```python
printf
```
```python
(
```
```python
"\t学号  记录号\n"
```
```python
);
```
```python
if
```
```python
((idxfile=fopen(
```
```python
"index.dat"
```
```python
,
```
```python
"rb"
```
```python
))==NULL)
    {
```
```python
printf
```
```python
(
```
```python
"  提示:不能读索引文件\n"
```
```python
);
```
```python
return
```
```python
;
    }
```
```python
while
```
```python
((fread(&irec,
```
```python
sizeof
```
```python
(Index),
```
```python
1
```
```python
,idxfile))==
```
```python
1
```
```python
)
```
```python
printf
```
```python
(
```
```python
"\t%5d%6ld\n"
```
```python
,irec.no,irec.offset);
    fclose(idxfile);
}
```
```python
void
```
```python
ReadIndexFile(Index idx[MaxRec],
```
```python
int
```
```python
&n)
```
```python
//读索引文件数据存入idx数组中
```
```python
{
```
```python
int
```
```python
j;
    FILE *idxfile;
```
```python
if
```
```python
((idxfile=fopen(
```
```python
"index.dat"
```
```python
,
```
```python
"rb"
```
```python
))==NULL)
    {
```
```python
printf
```
```python
(
```
```python
"  提示:索引文件不能打开\n"
```
```python
);
```
```python
return
```
```python
;
    }
    fseek(idxfile,
```
```python
0
```
```python
,
```
```python
2
```
```python
);
    j=ftell(idxfile);
```
```python
//j求出文件长度
```
```python
rewind(idxfile);
    n=j/
```
```python
sizeof
```
```python
(Index);
```
```python
//n求出文件中的记录个数
```
```python
fread(idx,
```
```python
sizeof
```
```python
(Index),n,idxfile);
    fclose(idxfile);
}
```
```python
int
```
```python
SearchNum(Index idx[],
```
```python
int
```
```python
n,
```
```python
int
```
```python
no)
```
```python
//在含有n个记录的索引文件idx中查找学号为no的记录对应的记录号
```
```python
{
```
```python
int
```
```python
mid,low=
```
```python
0
```
```python
,high=n-
```
```python
1
```
```python
;
```
```python
while
```
```python
(low<=high)
```
```python
//二分查找
```
```python
{
        mid=(low+high)/
```
```python
2
```
```python
;
```
```python
if
```
```python
(idx[mid].no>no)
            high=mid-
```
```python
1
```
```python
;
```
```python
else
```
```python
if
```
```python
(idx[mid].no<no)
            low=mid+
```
```python
1
```
```python
;
```
```python
else
```
```python
//idx[mid].no==no
```
```python
return
```
```python
idx[mid].offset;
    }
```
```python
return
```
```python
-
```
```python
1
```
```python
;
}
```
```python
void
```
```python
FindStudent()
```
```python
//输出指定学号的记录
```
```python
{
```
```python
int
```
```python
no;
    FILE *mfile;
    Index idx[MaxRec];
    StudType st;
```
```python
int
```
```python
i,n;
```
```python
if
```
```python
((mfile=fopen(
```
```python
"stud.dat"
```
```python
,
```
```python
"rb+"
```
```python
))==NULL)
    {
```
```python
printf
```
```python
(
```
```python
"  提示:主文件中没有任何记录\n"
```
```python
);
```
```python
return
```
```python
;
    }
    ReadIndexFile(idx,n);
```
```python
//读取索引数组idx
```
```python
printf
```
```python
(
```
```python
"输入学号:"
```
```python
);
```
```python
scanf
```
```python
(
```
```python
"%d"
```
```python
,&no);
    i=SearchNum(idx,n,no);
```
```python
//在idx中查找
```
```python
if
```
```python
(i==-
```
```python
1
```
```python
)
```
```python
printf
```
```python
(
```
```python
"  提示:学号%d不存在\n"
```
```python
,no);
```
```python
else
```
```python
{
        fseek(mfile,(i-
```
```python
1
```
```python
)*
```
```python
sizeof
```
```python
(StudType),SEEK_SET);
```
```python
//由记录号直接跳到主文件中对应的记录
```
```python
fread(&st,
```
```python
sizeof
```
```python
(StudType),
```
```python
1
```
```python
,mfile);
```
```python
printf
```
```python
(
```
```python
"%5d%10s%6d%5s%5d%5d%5d\n"
```
```python
,st.no,st.name,st.age,st.sex,st.deg1,st.deg2,st.deg3);
    }
    fclose(mfile);
}
```
```python
void
```
```python
WriteFile(StudType st[],
```
```python
int
```
```python
n)
```
```python
//将st数组中的n个学生记录写入stud.dat文件中
```
```python
{
```
```python
int
```
```python
i;
    FILE *fp;
```
```python
if
```
```python
((fp=fopen(
```
```python
"stud.dat"
```
```python
,
```
```python
"wb"
```
```python
))==NULL)
    {
```
```python
printf
```
```python
(
```
```python
"\t提示:不能创建stud.dat文件\n"
```
```python
);
```
```python
return
```
```python
;
    }
```
```python
for
```
```python
(i=
```
```python
0
```
```python
; i<n; i++)
        fwrite(&st[i],
```
```python
1
```
```python
,
```
```python
sizeof
```
```python
(StudType),fp);
    fclose(fp);
```
```python
printf
```
```python
(
```
```python
"  提示:文件stud.dat创建完毕\n"
```
```python
);
}
```
```python
int
```
```python
main()
{
```
```python
int
```
```python
n=
```
```python
8
```
```python
,sel;
```
```python
//n为实际学生人数
```
```python
StudType st[]= {{
```
```python
1
```
```python
,
```
```python
"陈华"
```
```python
,
```
```python
20
```
```python
,
```
```python
"男"
```
```python
,
```
```python
78
```
```python
,
```
```python
90
```
```python
,
```
```python
84
```
```python
},
        {
```
```python
5
```
```python
,
```
```python
"张明"
```
```python
,
```
```python
21
```
```python
,
```
```python
"男"
```
```python
,
```
```python
78
```
```python
,
```
```python
68
```
```python
,
```
```python
92
```
```python
},
        {
```
```python
8
```
```python
,
```
```python
"王英"
```
```python
,
```
```python
20
```
```python
,
```
```python
"女"
```
```python
,
```
```python
86
```
```python
,
```
```python
81
```
```python
,
```
```python
86
```
```python
},
        {
```
```python
3
```
```python
,
```
```python
"刘丽"
```
```python
,
```
```python
21
```
```python
,
```
```python
"女"
```
```python
,
```
```python
78
```
```python
,
```
```python
92
```
```python
,
```
```python
88
```
```python
},
        {
```
```python
2
```
```python
,
```
```python
"许可"
```
```python
,
```
```python
20
```
```python
,
```
```python
"男"
```
```python
,
```
```python
80
```
```python
,
```
```python
83
```
```python
,
```
```python
78
```
```python
},
        {
```
```python
4
```
```python
,
```
```python
"陈军"
```
```python
,
```
```python
20
```
```python
,
```
```python
"男"
```
```python
,
```
```python
78
```
```python
,
```
```python
88
```
```python
,
```
```python
82
```
```python
},
        {
```
```python
7
```
```python
,
```
```python
"马胜"
```
```python
,
```
```python
21
```
```python
,
```
```python
"男"
```
```python
,
```
```python
56
```
```python
,
```
```python
67
```
```python
,
```
```python
75
```
```python
},
        {
```
```python
6
```
```python
,
```
```python
"曾强"
```
```python
,
```
```python
20
```
```python
,
```
```python
"男"
```
```python
,
```
```python
78
```
```python
,
```
```python
89
```
```python
,
```
```python
82
```
```python
}
    };
```
```python
printf
```
```python
(
```
```python
"建立主文件\n"
```
```python
);
    WriteFile(st,n);
```
```python
//建立主文件
```
```python
do
```
```python
{
```
```python
printf
```
```python
(
```
```python
"1:输出主文件 2:建索引文件 3:输出索引文件 4:按学号查找 0:退出:"
```
```python
);
```
```python
scanf
```
```python
(
```
```python
"%d"
```
```python
,&sel);
```
```python
switch
```
```python
(sel)
        {
```
```python
case
```
```python
1
```
```python
:
            OutputMainFile();
```
```python
break
```
```python
;
```
```python
case
```
```python
2
```
```python
:
            CreatIdxFile();
```
```python
break
```
```python
;
```
```python
case
```
```python
3
```
```python
:
            OutputIdxFile();
```
```python
break
```
```python
;
```
```python
case
```
```python
4
```
```python
:
            FindStudent();
```
```python
break
```
```python
;
        }
    }
```
```python
while
```
```python
(sel!=
```
```python
0
```
```python
);
```
```python
return
```
```python
0
```
```python
;
}
```

