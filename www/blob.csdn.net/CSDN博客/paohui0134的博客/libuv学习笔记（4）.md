
# libuv学习笔记（4） - paohui0134的博客 - CSDN博客


2016年06月11日 21:35:10[paohui0134](https://me.csdn.net/paohui0134)阅读数：894


# libuv学习笔记（4）
## uv_req_t 基本请求的定义以及相关函数
### 结构体定义
与uv_handlt_t结构体类似，将通用的数据结构定义为UV_REQ_FIELDS宏，每种类型的请求都在相同位置（开始）包含该宏，所以任何req类型的指针都能转换为uv_req_t*，实现了类似继承的效果。
```python
typedef
```
```python
struct
```
```python
uv_req_s uv_req_t;
```
```python
struct
```
```python
uv_req_s 
{
```
```python
//UV_REQ_FIELDS宏展开：
```
```python
/* 指向用户自定义数据 */
```
```python
void
```
```python
* data;
```
```python
/* 请求类型，只读 */
```
```python
uv_req_type type;
```
```python
/* 私有数据 */
```
```python
void
```
```python
* active_queue[
```
```python
2
```
```python
];
```
```python
void
```
```python
* reserved[
```
```python
4
```
```python
];
```
```python
//UV_REQ_PRIVATE_FIELDS 宏展开（在uv-win.h中定义，平台相关） :
```
```python
union
```
```python
{
```
```python
/* i/o操作，iocp用到 */
```
```python
struct
```
```python
{                                                                 
      OVERLAPPED overlapped;                                                
      size_t queued_bytes;                                                  
    } io;                                                                   
  } u;
```
```python
struct
```
```python
uv_req_s* next_req;
```
```python
//指向下一个请求
```
```python
};
```
请求类型包括（宏展开后）：
```python
typedef
```
```python
enum
```
```python
{
  UV_UNKNOWN_REQ =
```
```python
0
```
```python
,
  UV_REQ,
  UV_CONNECT,
```
```python
//连接
```
```python
UV_WRITE,
```
```python
//写
```
```python
UV_SHUTDOWN,
```
```python
//关闭
```
```python
UV_UDP_SEND,
```
```python
//发送udp数据
```
```python
UV_FS,
```
```python
//文件操作
```
```python
UV_WORK,
```
```python
//在线程池中运行
```
```python
UV_GETADDRINFO,
```
```python
//获取地址
```
```python
UV_GETNAMEINFO,
```
```python
//获取主机名
```
```python
//内部请求类型
```
```python
UV_ACCPTE,
```
```python
//接受连接
```
```python
UV_FS_EVENT_REQ,
```
```python
//文件事件
```
```python
UV_POLL_REQ,
```
```python
//轮询
```
```python
UV_PROCESS_EXIT,
```
```python
//关闭进程
```
```python
UV_READ,
```
```python
//读取
```
```python
UV_UDP_RECV,
```
```python
//udp socket接收数据
```
```python
UV_WAKEUP,
```
```python
//
```
```python
UV_SIGNAL_REQ,
```
```python
//信号
```
```python
UV_REQ_TYPE_MAX
} uv_req_type;
```
### 相关函数
#### 1.取消请求，导出函数，uv.h中声明，threadpool.c中定义
```python
int uv_cancel(uv_req_t* req) 
{
  struct uv__work* wreq;
  uv_loop_t*
```
```python
loop
```
```python
;
```
```python
//
```
```python
根据请求类型获取对应的请求指针，只支持取消通过线程池处理的请求（
```
```python
4
```
```python
类）
```
```python
switch
```
```python
(req->type) {
```
```python
case
```
```python
UV_FS
```
```python
:
```
```python
loop
```
```python
=
```
```python
((uv_fs_t*) req)
```
```python
->
```
```python
loop
```
```python
;
    wreq = &
```
```python
((uv_fs_t*) req)
```
```python
->
```
```python
work_req;
```
```python
break
```
```python
;
```
```python
case
```
```python
UV_GETADDRINFO
```
```python
:
```
```python
loop
```
```python
=
```
```python
((uv_getaddrinfo_t*) req)
```
```python
->
```
```python
loop
```
```python
;
    wreq = &
```
```python
((uv_getaddrinfo_t*) req)
```
```python
->
```
```python
work_req;
```
```python
break
```
```python
;
```
```python
case
```
```python
UV_GETNAMEINFO
```
```python
:
```
```python
loop
```
```python
=
```
```python
((uv_getnameinfo_t*) req)
```
```python
->
```
```python
loop
```
```python
;
    wreq = &
```
```python
((uv_getnameinfo_t*) req)
```
```python
->
```
```python
work_req;
```
```python
break
```
```python
;
```
```python
case
```
```python
UV_WORK
```
```python
:
```
```python
loop
```
```python
=
```
```python
((uv_work_t*) req)
```
```python
->
```
```python
loop
```
```python
;
    wreq = &
```
```python
((uv_work_t*) req)
```
```python
->
```
```python
work_req;
```
```python
break
```
```python
;
```
```python
default
```
```python
:
```
```python
return
```
```python
UV_EINVAL;
  }
```
```python
//
```
```python
调用内部函数
```
```python
return
```
```python
uv__work_cancel(
```
```python
loop
```
```python
, req, wreq);
}
```
内部函数 uv__work_cancel
```python
static int uv__work_cancel(uv_loop_t
```
```python
*
```
```python
loop
```
```python
, uv_req_t
```
```python
*
```
```python
req, struct uv__work
```
```python
*
```
```python
w) 
{
  int cancelled;
```
```python
//互斥量锁定（内部通过临界区实现），然后移除请求对象（req）的工作项（w）
```
```python
uv_mutex_lock(
```
```python
&
```
```python
mutex);
  uv_mutex_lock(
```
```python
&
```
```python
w
```
```python
->
```
```python
loop
```
```python
->
```
```python
wq_mutex);
  cancelled
```
```python
=
```
```python
!
```
```python
QUEUE_EMPTY(
```
```python
&
```
```python
w
```
```python
->
```
```python
wq)
```
```python
&&
```
```python
w
```
```python
->
```
```python
work
```
```python
!=
```
```python
NULL
```
```python
;
```
```python
if
```
```python
(cancelled)
    QUEUE_REMOVE(
```
```python
&
```
```python
w
```
```python
->
```
```python
wq);
  uv_mutex_unlock(
```
```python
&
```
```python
w
```
```python
->
```
```python
loop
```
```python
->
```
```python
wq_mutex);
  uv_mutex_unlock(
```
```python
&
```
```python
mutex);
```
```python
if
```
```python
(
```
```python
!
```
```python
cancelled)
```
```python
return
```
```python
UV_EBUSY;
```
```python
//工作函数设为uv__cancelled，后面loop会根据这个值判断请求是否是取消的（uv__work_done）
```
```python
w
```
```python
->
```
```python
work
```
```python
=
```
```python
uv__cancelled;
  uv_mutex_lock(
```
```python
&
```
```python
loop
```
```python
->
```
```python
wq_mutex);
```
```python
//将请求添加到loop的完成请求的列表
```
```python
QUEUE_INSERT_TAIL(
```
```python
&
```
```python
loop
```
```python
->
```
```python
wq,
```
```python
&
```
```python
w
```
```python
->
```
```python
wq);
```
```python
//发送异步消息，wakeup loop
```
```python
uv_async_send(
```
```python
&
```
```python
loop
```
```python
->
```
```python
wq_async);
  uv_mutex_unlock(
```
```python
&
```
```python
loop
```
```python
->
```
```python
wq_mutex);
```
```python
return
```
```python
0
```
```python
;
}
```
不同类型的请求会有不同的API，将会在之后具体分析。

