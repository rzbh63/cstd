
# 模板分离编译模式和工厂模式 - 机器学习的小学生 - CSDN博客


2017年03月30日 16:44:36[机器学习的小学生](https://me.csdn.net/xuluhui123)阅读数：1051



## caffe中的模板分离编译模式和工厂模式
1.caffe中模板分离编译模式的实现方式是在每一个模板源文件的最后添加一条类似于下面的语句：
```python
INSTANTIATE_CLASS(PowerLayer)
```
```python
;
```
该方法属于文献[1]中所说的显示实例化方法。
2.caffe中工厂模式的实现，是通过在每一个模板源文件的最后添加一条类似于下面的语句：
```python
REGISTER_LAYER_CLASS(
```
```python
Power
```
```python
);
```
其通过全局静态对象利用构造函数的形式，往静态map对象中添加类对象生成信息，如一个string类型的名称和一个创建“名称”类对象的函数。
**下面给出具体的引用过程**：
power_lay.hpp和power_lay.cpp分别类PowerLayer的声明和实现。
在模板的定义cpp中，即power_lay.cpp中最后：
```python
INSTANTIATE_CLASS(PowerLayer)
```
```python
;
```
```python
REGISTER_LAYER_CLASS(Power)
```
```python
;
```
common.hpp中：
```python
#define INSTANTIATE_CLASS(classname) \
```
```python
char gInstantiationGuard
```
```python
##classname; \
```
```python
template
```
```python
class
```
```python
classname
```
```python
<
```
```python
float
```
```python
>;
```
```python
\
  template
```
```python
class
```
```python
classname
```
```python
<
```
```python
double
```
```python
>
```
layer_factory.hpp中，最后
```python
#define REGISTER_LAYER_CREATOR(
```
```python
type
```
```python
,
```
```python
creator
```
```python
)                                  \
```
```python
static
```
```python
LayerRegisterer<float> g_creator_f_##
```
```python
type
```
```python
(
```
```python
#
```
```python
type
```
```python
,
```
```python
creator
```
```python
<
```
```python
float
```
```python
>);     \
```
```python
static
```
```python
LayerRegisterer<double> g_creator_d_##
```
```python
type
```
```python
(
```
```python
#
```
```python
type
```
```python
,
```
```python
creator
```
```python
<
```
```python
double
```
```python
>)    \
```
```python
#define REGISTER_LAYER_CLASS(
```
```python
type
```
```python
)                                             \
```
```python
template <typename Dtype>                                                    \
  shared_ptr<Layer<Dtype> > Creator_##
```
```python
type
```
```python
##
```
```python
Layer
```
```python
(
```
```python
const LayerParameter& param) \
  {                                                                            \
```
```python
return
```
```python
shared_ptr<Layer<Dtype> >(
```
```python
new
```
```python
type
```
```python
##
```
```python
Layer
```
```python
<
```
```python
Dtype
```
```python
>(
```
```python
param));           \
  }                                                                            \
  REGISTER_LAYER_CREATOR(
```
```python
type
```
```python
,
```
```python
Creator_
```
```python
##
```
```python
type
```
```python
##
```
```python
Layer
```
```python
)
```
```python
}
```
例如，对于pow_layer层，调用形式为：
```python
INSTANTIATE_CLASS(PowerLayer)
```
```python
;
```
```python
REGISTER_LAYER_CLASS(Power)
```
```python
;
```
等价于：
```python
char
```
```python
gInstantiationGuardPowerLayer;
```
```python
template
```
```python
class
```
```python
PowerLayer<
```
```python
float
```
```python
>;
```
```python
template
```
```python
class
```
```python
PowerLayer<
```
```python
double
```
```python
>;
```
```python
template
```
```python
<
```
```python
typename
```
```python
Dtype>
```
```python
shared_ptr
```
```python
<Layer<Dtype> > Creator_PowerLayer(
```
```python
const
```
```python
LayerParameter& param) 
  {
```
```python
return
```
```python
shared_ptr
```
```python
<Layer<Dtype> >(
```
```python
new
```
```python
PowerLayer<Dtype>(param));           
  }
```
```python
static
```
```python
LayerRegisterer<
```
```python
float
```
```python
> g_creator_f_Power(“Power”, Creator_PowerLayer<
```
```python
float
```
```python
>);
```
```python
static
```
```python
LayerRegisterer<
```
```python
double
```
```python
> g_creator_d_Power(“Power”, Creator_PowerLayer<
```
```python
double
```
```python
>);
```
其中,LayerRegisterer 类的构造函数声明为：
```python
LayerRegisterer(
```
```python
const
```
```python
string
```
```python
& type,
```
```python
shared_ptr
```
```python
<Layer<Dtype> > (*creator)(
```
```python
const
```
```python
LayerParameter&));
```
定义为：
```python
template <typename D
```
```python
type
```
```python
>
LayerRegisterer<D
```
```python
type
```
```python
>::LayerRegisterer(
    const string&
```
```python
type
```
```python
,
    shared_ptr<Layer<D
```
```python
type
```
```python
> > (*creator)(const LayerParameter&)) {
  // LOG(INFO) <<
```
```python
"Registering layer type: "
```
```python
<<
```
```python
type
```
```python
;
  LayerRegistry<D
```
```python
type
```
```python
>::AddCreator(
```
```python
type
```
```python
, creator);
}
```
AddCreator函数的定义为：
```python
template
```
```python
<
```
```python
typename Dtype
```
```python
>
```
```python
void
```
```python
LayerRegistry
```
```python
<
```
```python
Dtype
```
```python
>
```
```python
::AddCreator
```
```python
(const
```
```python
string
```
```python
&
```
```python
type
```
```python
, Creator creator) {
  CreatorRegistry
```
```python
&
```
```python
registry
```
```python
=
```
```python
Registry();
  CHECK_EQ(registry
```
```python
.
```
```python
count(
```
```python
type
```
```python
),
```
```python
0
```
```python
)
```
```python
<<
```
```python
"Layer type "
```
```python
<<
```
```python
type
```
```python
<<
```
```python
" already registered."
```
```python
;
  registry
```
```python
[
```
```python
type
```
```python
]
```
```python
= creator;
}
```
其中：
```python
typedef
```
```python
shared_ptr
```
```python
<Layer<Dtype> > (*Creator)(
```
```python
const
```
```python
LayerParameter&);
```
```python
//函数指针
```
```python
typedef
```
```python
std
```
```python
::
```
```python
map
```
```python
<
```
```python
string
```
```python
, Creator>
```
```python
CreatorRegistry;
```
```python
//map
```
Registry函数为：
```python
template
```
```python
<
```
```python
typename
```
```python
Dtype>
```
```python
typename
```
```python
LayerRegistry<Dtype>::CreatorRegistry&
LayerRegistry<Dtype>::Registry() {
```
```python
static
```
```python
CreatorRegistry* g_registry_ =
```
```python
new
```
```python
CreatorRegistry();
```
```python
return
```
```python
*g_registry_;
}
```
## 为了理解仿写的测试代码：
**person.hpp**
```python
#ifndef PERSON_HPP_
```
```python
#
```
```python
define
```
```python
PERSON_HPP_
```
```python
#include <string>
```
```python
using
```
```python
std::
```
```python
string
```
```python
;
```
```python
struct
```
```python
PersonParameter
{
```
```python
string
```
```python
name;
```
```python
string
```
```python
type;
```
```python
//student ,teacher,worker
```
```python
};

template<typename Dtype> class  Person
{
```
```python
public
```
```python
:
```
```python
Person
```
```python
() :
```
```python
name_
```
```python
(""),
```
```python
type_
```
```python
("") {};
    Person(
```
```python
const
```
```python
PersonParameter &pp):name_(pp.name),type_(pp.type){}
    ~Person() {}
```
```python
virtual
```
```python
string
```
```python
getName() =
```
```python
0
```
```python
;
```
```python
virtual
```
```python
void
```
```python
setName(
```
```python
string
```
```python
name) =
```
```python
0
```
```python
;
```
```python
protected
```
```python
:
```
```python
string
```
```python
name_;
```
```python
string
```
```python
type_;
};
template<typename Dtype> class Student :
```
```python
public
```
```python
Person<Dtype>
{
```
```python
public
```
```python
:
```
```python
Student
```
```python
(
```
```python
const
```
```python
PersonParameter &pp) :
```
```python
Person
```
```python
(pp) {};
```
```python
virtual
```
```python
string
```
```python
getName();
```
```python
virtual
```
```python
void
```
```python
setName(
```
```python
string
```
```python
name);
};
template<typename Dtype> class Teacher :
```
```python
public
```
```python
Person<Dtype>
{
```
```python
public
```
```python
:
```
```python
Teacher
```
```python
(
```
```python
const
```
```python
PersonParameter &pp) :
```
```python
Person
```
```python
(pp) {};
```
```python
virtual
```
```python
string
```
```python
getName();
```
```python
virtual
```
```python
void
```
```python
setName(
```
```python
string
```
```python
name);
};
template<typename Dtype> class Worker :
```
```python
public
```
```python
Person<Dtype>
{
```
```python
public
```
```python
:
```
```python
Worker
```
```python
(
```
```python
const
```
```python
PersonParameter &pp) :
```
```python
Person
```
```python
(pp) {};
```
```python
virtual
```
```python
string
```
```python
getName();
```
```python
virtual
```
```python
void
```
```python
setName(
```
```python
string
```
```python
name);
};
```
```python
#
```
```python
endif
```
**person.cpp**
```python
#include"person.hpp"
```
```python
#include"person_factory.hpp"
```
```python
#include<iostream>
```
```python
using
```
```python
std
```
```python
::
```
```python
cout
```
```python
;
```
```python
using
```
```python
std
```
```python
::endl;
```
```python
template
```
```python
<
```
```python
typename
```
```python
Dtype>
```
```python
string
```
```python
Student<Dtype>::getName()
{
```
```python
cout
```
```python
<<
```
```python
"Student getName():"
```
```python
<< endl;
```
```python
return
```
```python
name_;
};
```
```python
template
```
```python
<
```
```python
typename
```
```python
Dtype>
```
```python
void
```
```python
Student<Dtype>::setName(
```
```python
string
```
```python
name)
{
```
```python
cout
```
```python
<<
```
```python
"Student setName():"
```
```python
<< endl;
    name_ = name;
}
```
```python
//
```
```python
template
```
```python
<
```
```python
typename
```
```python
Dtype>
```
```python
string
```
```python
Teacher<Dtype>::getName()
{
```
```python
cout
```
```python
<<
```
```python
"Teacher getName():"
```
```python
<< endl;
```
```python
return
```
```python
name_;
};
```
```python
template
```
```python
<
```
```python
typename
```
```python
Dtype>
```
```python
void
```
```python
Teacher<Dtype>::setName(
```
```python
string
```
```python
name)
{
```
```python
cout
```
```python
<<
```
```python
"Teacher setName():"
```
```python
<< endl;
    name_ = name;
}
```
```python
//
```
```python
template
```
```python
<
```
```python
typename
```
```python
Dtype>
```
```python
string
```
```python
Worker<Dtype>::getName()
{
```
```python
cout
```
```python
<<
```
```python
"Worker getName():"
```
```python
<< endl;
```
```python
return
```
```python
name_;
};
```
```python
template
```
```python
<
```
```python
typename
```
```python
Dtype>
```
```python
void
```
```python
Worker<Dtype>::setName(
```
```python
string
```
```python
name)
{
```
```python
cout
```
```python
<<
```
```python
"Worker setName():"
```
```python
<< endl;
    name_ = name;
}
```
```python
template
```
```python
class
```
```python
Student<
```
```python
float
```
```python
>;
```
```python
template
```
```python
class
```
```python
Student<
```
```python
double
```
```python
>;
```
```python
template
```
```python
class
```
```python
Teacher<
```
```python
float
```
```python
>;
```
```python
template
```
```python
class
```
```python
Teacher<
```
```python
double
```
```python
>;
```
```python
template
```
```python
class
```
```python
Worker<
```
```python
float
```
```python
>;
```
```python
template
```
```python
class
```
```python
Worker<
```
```python
double
```
```python
>;

REGISTER_PERSON_CLASS(Student);
REGISTER_PERSON_CLASS(Teacher);
REGISTER_PERSON_CLASS(Worker);
```
**person_factory.hpp**
```python
#include"person.hpp"
```
```python
#include<string>
```
```python
#include<map>
```
```python
#include<vector>
```
```python
#include<iostream>
```
```python
using
```
```python
namespace
```
```python
std
```
```python
;
```
```python
template
```
```python
<
```
```python
typename
```
```python
Dtype>
```
```python
class
```
```python
PersonRegistry
{
```
```python
public
```
```python
:
```
```python
typedef
```
```python
Person<Dtype>* (*Creator)(
```
```python
const
```
```python
PersonParameter&);
```
```python
// 函数指针
```
```python
typedef
```
```python
std
```
```python
::
```
```python
map
```
```python
<
```
```python
string
```
```python
, Creator>
```
```python
CreatorRegistry;
```
```python
//存储注册信息
```
```python
static
```
```python
CreatorRegistry& Registry();
```
```python
static
```
```python
void
```
```python
AddCreator(
```
```python
const
```
```python
string
```
```python
& type, Creator creator);
```
```python
// Get a person using a PeronParameter.
```
```python
static
```
```python
Person<Dtype>* CreatePerson(
```
```python
const
```
```python
PersonParameter& param);
```
```python
static
```
```python
vector
```
```python
<
```
```python
string
```
```python
>
```
```python
PersonTypeList();
```
```python
private
```
```python
:
```
```python
//将构造函数设置为private,不同通过其他方式创建该对象，所有的操作使用静态方法和变量。
```
```python
PersonRegistry();
```
```python
static
```
```python
string
```
```python
PersonTypeListString();
};
```
```python
// PersonRegisterer 是PersonRegistry的对外管理接口
```
```python
template
```
```python
<
```
```python
typename
```
```python
Dtype>
```
```python
class
```
```python
PersonRegisterer {
```
```python
public
```
```python
:
    PersonRegisterer(
```
```python
const
```
```python
string
```
```python
& type,
        Person<Dtype>* (*creator)(
```
```python
const
```
```python
PersonParameter&));
};
```
```python
// 定义静态对象，静态对象利用其构造函数，将自己的“type”和"creator"添加到静态分配的map对象中。
```
```python
#define REGISTER_PERSON_CREATOR(type, creator)                                  \
```
```python
static
```
```python
PersonRegisterer<
```
```python
float
```
```python
> g_creator_f_
```
```python
##type(#type, creator<float>);     \
```
```python
static
```
```python
PersonRegisterer<
```
```python
double
```
```python
> g_creator_d_
```
```python
##type(#type, creator<double>)    \
```
```python
// REGISTER_PERSON_CLASS 对外调用，每一个PERSON子类实现cpp中调用该宏。
```
```python
#define REGISTER_PERSON_CLASS(type)                                             \
```
```python
template
```
```python
<
```
```python
typename
```
```python
Dtype>                                                    \
  Person<Dtype>*  Creator_
```
```python
##type(const PersonParameter& param) \
```
```python
{                                                                            \
```
```python
return
```
```python
(
```
```python
new
```
```python
type<Dtype>(param));           \
  }                                                                             \
  REGISTER_PERSON_CREATOR(type, Creator_
```
```python
##type)
```
**person_factory.cpp**
```python
#include "person_factory.hpp"
```
```python
// CreatorRegistry 的实现
```
```python
template
```
```python
<
```
```python
typename
```
```python
Dtype>
```
```python
typename
```
```python
PersonRegistry<Dtype>::CreatorRegistry & PersonRegistry<Dtype>::Registry()
{
```
```python
//静态指针，指向动态申请的内存
```
```python
static
```
```python
CreatorRegistry * g_registry_ =
```
```python
new
```
```python
CreatorRegistry();
```
```python
//map<string,Creator>
```
```python
return
```
```python
*g_registry_;
```
```python
//返回map<string,Creator>引用
```
```python
}
```
```python
// PersonRegisterer的构造函数调用。
```
```python
template
```
```python
<
```
```python
typename
```
```python
Dtype>
```
```python
void
```
```python
PersonRegistry<Dtype>::AddCreator(
```
```python
const
```
```python
string
```
```python
&type,Creator creator)
{
    CreatorRegistry& registry = Registry();
```
```python
//动态申请一个map,静态对象不会被创建第二次。
```
```python
//检查map<string,Creator>中是否已经注册。
```
```python
if
```
```python
(registry.count(type) !=
```
```python
0
```
```python
)
    {
```
```python
cerr
```
```python
<<
```
```python
"Person type "
```
```python
<< type<<
```
```python
" already registered."
```
```python
;
    }
```
```python
//添加键值对，将<type,creator>添加到map中
```
```python
registry[type] = creator;
}
```
```python
template
```
```python
<
```
```python
typename
```
```python
Dtype> Person<Dtype>*  PersonRegistry<Dtype>::CreatePerson(
```
```python
const
```
```python
PersonParameter & param)
{
```
```python
//实例化一个对象，如Student ,Worker,Teacher
```
```python
const
```
```python
string
```
```python
& type = param.type;
    CreatorRegistry& registry = Registry();
```
```python
//检查map中是否存在该类型(如Student ,Worker,Teacher),如果该map找不到，说明我们算法没有实现。
```
```python
if
```
```python
(registry.count(type) !=
```
```python
1
```
```python
)
    {
```
```python
cerr
```
```python
<<
```
```python
"Unknown Person type: "
```
```python
<< type
            <<
```
```python
" (known types: "
```
```python
<< PersonTypeListString() <<
```
```python
")"
```
```python
;
    }
```
```python
return
```
```python
registry[type](param);
```
```python
//调用该类型的函数，动态创建改类型的对象。
```
```python
}
```
```python
template
```
```python
<
```
```python
typename
```
```python
Dtype>
```
```python
vector
```
```python
<
```
```python
string
```
```python
>
```
```python
PersonRegistry<Dtype>::PersonTypeList()
{
    CreatorRegistry& registry = Registry();
```
```python
//遍历map容器
```
```python
vector
```
```python
<
```
```python
string
```
```python
>
```
```python
person_types;
```
```python
for
```
```python
(
```
```python
typename
```
```python
CreatorRegistry::iterator iter = registry.begin();
        iter != registry.end(); ++iter) {
        person_types.push_back(iter->first);
    }
```
```python
return
```
```python
person_types;
}
```
```python
template
```
```python
<
```
```python
typename
```
```python
Dtype>
```
```python
string
```
```python
PersonRegistry<Dtype>::PersonTypeListString()
{
```
```python
vector
```
```python
<
```
```python
string
```
```python
>
```
```python
person_types = PersonTypeList();
```
```python
string
```
```python
person_types_str;
```
```python
//将所有type串联成一个string 返回
```
```python
for
```
```python
(
```
```python
vector
```
```python
<
```
```python
string
```
```python
>
```
```python
::iterator iter = person_types.begin();
        iter != person_types.end(); ++iter) {
```
```python
if
```
```python
(iter != person_types.begin()) {
            person_types_str +=
```
```python
", "
```
```python
;
        }
        person_types_str += *iter;
    }
```
```python
return
```
```python
person_types_str;
}
```
```python
// LayerRegisterer 类的实现
```
```python
template
```
```python
<
```
```python
typename
```
```python
Dtype>
PersonRegisterer<Dtype>::PersonRegisterer(
```
```python
const
```
```python
string
```
```python
& type,
    Person<Dtype>* (*creator)(
```
```python
const
```
```python
PersonParameter&)) {
```
```python
cout
```
```python
<<
```
```python
"Registering person type: "
```
```python
<< type << endl;
```
```python
//调用LayerRigistry类的AddCreator函数增加一个到map
```
```python
PersonRegistry<Dtype>::AddCreator(type, creator);
}
```
```python
// 为了让编译器看到两个模板类：LayerRegisterer，CreatorRegistry
```
```python
template
```
```python
class
```
```python
PersonRegisterer<
```
```python
float
```
```python
>;
```
```python
//声明
```
```python
template
```
```python
class
```
```python
PersonRegisterer<
```
```python
double
```
```python
>;
```
```python
template
```
```python
class
```
```python
PersonRegistry<
```
```python
float
```
```python
>;
```
```python
template
```
```python
class
```
```python
PersonRegistry<
```
```python
double
```
```python
>;
```
```python
//上述等价于于下面的caffe中的代码：
```
```python
//INSTANTIATE_CLASS(LayerRegistry);
```
```python
//INSTANTIATE_CLASS(LayerRegisterer);
```
**test_template.cpp**
```python
#include"stdafx.h"
```
```python
#include"person.hpp"
```
```python
#include"person_factory.hpp"
```
```python
void
```
```python
main()
{
```
```python
//registor : map<string,creator>
```
```python
PersonRegistry<
```
```python
float
```
```python
>::CreatorRegistry &registor = PersonRegistry<
```
```python
float
```
```python
>::Registry();
    PersonParameter pp;
    pp.type =
```
```python
"Student"
```
```python
;
    pp.name =
```
```python
"zhangsan"
```
```python
;
```
```python
//调用map中Student键对应的ceator函数，创建Student 对象。
```
```python
Person<
```
```python
float
```
```python
> *student = registor[
```
```python
"Student"
```
```python
](pp);
    cout << student->getName()<< endl;
}
```
下载地址：
参考文献：
[http://blog.csdn.net/k346k346/article/details/49500635](http://blog.csdn.net/k346k346/article/details/49500635)[模板与分离编译模式]

