
# 参看caffe中三通道彩色图像的卷积过程 - 机器学习的小学生 - CSDN博客


2017年04月08日 15:51:45[机器学习的小学生](https://me.csdn.net/xuluhui123)阅读数：2815


E:\caffe-windows-lib\matlab\hdf5creation\predict_label_testdata_for_analysis.m
代码：
```python
clearvars;close all;
```
```python
if
```
```python
~exist(
```
```python
'ttest_data'
```
```python
,
```
```python
'var'
```
```python
)||~exist(
```
```python
'means'
```
```python
,
```
```python
'var'
```
```python
)
    test_data = load(
```
```python
'ttest_data.mat'
```
```python
); % load ttest_data
    test_data = test_data.ttest_data;
    means = load(
```
```python
'mean_file.mat'
```
```python
);
    means = means.means;
```
```python
end
```
```python
n = length(test_data);
% rand_ind = randperm(n);
rand_ind =
```
```python
1
```
```python
:n
```
```python
;
ttest_data = test_data(rand_ind(
```
```python
1
```
```python
:
```
```python
1
```
```python
));
ntest = length(ttest_data);
ttest_label = zeros(
```
```python
1
```
```python
,
```
```python
1
```
```python
,
```
```python
2
```
```python
,ntest);
face_size = [
```
```python
100
```
```python
100
```
```python
]; % height width
% width height  channels nsamples
ttest_feature = zeros(face_size(
```
```python
1
```
```python
),face_size(
```
```python
2
```
```python
),
```
```python
3
```
```python
,ntest);
isShow =
```
```python
false
```
```python
;
tic;
```
```python
for
```
```python
i =
```
```python
1
```
```python
:ntest
```
```python
img = imread( ttest_data(i).imgPath);
    bbox = ttest_data(i).bbox;
    face_img = img(bbox(
```
```python
2
```
```python
)
```
```python
:bbox
```
```python
(
```
```python
2
```
```python
)+bbox(
```
```python
4
```
```python
),bbox(
```
```python
1
```
```python
)
```
```python
:bbox
```
```python
(
```
```python
1
```
```python
)+bbox(
```
```python
3
```
```python
),
```
```python
:
```
```python
);
    res_img = imresize(face_img,face_size);
```
```python
if
```
```python
isShow
        figure;
        imshow(face_img);
        pause;
```
```python
end
```
```python
ttest_label(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
1
```
```python
,i) = ttest_data(i).poseId +
```
```python
2
```
```python
; %
```
```python
0
```
```python
1
```
```python
2
```
```python
3
```
```python
4
```
```python
ttest_label(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
2
```
```python
,i) = ttest_data(i).smile ;
    ttest_feature(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
:
```
```python
,i) = res_img;
```
```python
end
```
```python
f_time = toc;
disp([
```
```python
'feature_time :'
```
```python
num2str(f_time)]);
% change rgb to bgr
ttest_feature = ttest_feature(
```
```python
:
```
```python
,
```
```python
:
```
```python
,[
```
```python
3
```
```python
2
```
```python
1
```
```python
],
```
```python
:
```
```python
);
% permute width height
ttest_feature = permute(ttest_feature,[
```
```python
2
```
```python
1
```
```python
3
```
```python
4
```
```python
]);
% subtract mean_file
ttest_feature = ttest_feature - means;
ttest_feature = ttest_feature ./
```
```python
255
```
```python
;

net_model =
```
```python
'deploy_1.prototxt'
```
```python
;
net_weights =
```
```python
'lenet_iter_10000.caffemodel'
```
```python
;
phase =
```
```python
'test'
```
```python
;
```
```python
if
```
```python
exist(
```
```python
'../+caffe'
```
```python
,
```
```python
'dir'
```
```python
)
    addpath(
```
```python
'..'
```
```python
);
```
```python
else
```
```python
error(
```
```python
'Please run this demo from caffe/matlab/demo'
```
```python
);
```
```python
end
```
```python
net = caffe.
```
```python
Net
```
```python
(net_model, net_weights, phase);
% input_feature must be a cell
scores = net.forward({ttest_feature});
```
```python
%% 获取网络中的blob
input_img = net.blobs('data').get_data();
conv1 = net.blobs('conv_all').get_data();
%
```
```python
input_image
```
```python
:
```
```python
w * h * c * n
```
```python
:
```
```python
为
```
```python
255
```
```python
*
```
```python
255
```
```python
*
```
```python
3
```
```python
%
```
```python
conv1:
```
```python
w * h * c * n
```
```python
:
```
```python
为
```
```python
96
```
```python
*
```
```python
96
```
```python
*
```
```python
50
```
```python
,
% change w*h*c to h*w*c 即rows * cols * c
input_img = permute(input_img,[
```
```python
2
```
```python
1
```
```python
3
```
```python
]);
% change bgr to rgb
input_img = input_img(
```
```python
:
```
```python
,
```
```python
:
```
```python
,[
```
```python
3
```
```python
2
```
```python
1
```
```python
]);
ind1 =
```
```python
6
```
```python
;
ind2 =
```
```python
2
```
```python
;
conv11 = conv1(
```
```python
:
```
```python
,
```
```python
:
```
```python
,ind1);
conv11_img = permute(conv11,[
```
```python
2
```
```python
,
```
```python
1
```
```python
,
```
```python
3
```
```python
]);
```
```python
%%
conv12 = conv1(:,:,ind2);
conv12_img = permute(conv12,[2,1,3]);
figure;
subplot(221);
imshow(res_img);
title('原图像');
subplot(222);
imshow(input_img,[]);
title('输入图像(减去均值)');
subplot(223);
imshow(conv11_img,[]);
title('响应map1');
subplot(224);
imshow(conv12_img,[]);
title('响应map2');
%
```
```python
% 权重的可视化
w = net.layers(
```
```python
'conv_all'
```
```python
).params(
```
```python
1
```
```python
).get_data();
disp(size(w));
b = net.layers(
```
```python
'conv_all'
```
```python
).params(
```
```python
2
```
```python
).get_data();
disp(size(b));
% change width
```
```python
and
```
```python
height
w = permute(w,[
```
```python
2
```
```python
1
```
```python
3
```
```python
4
```
```python
]);
% change bgr to rgb
w = w(
```
```python
:
```
```python
,
```
```python
:
```
```python
,[
```
```python
3
```
```python
2
```
```python
1
```
```python
],
```
```python
:
```
```python
);
w11 = w(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
1
```
```python
,ind1);
w12 = w(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
2
```
```python
,ind1);
w13 = w(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
3
```
```python
,ind1);
figure(
```
```python
2
```
```python
);
% red channel
subplot(
```
```python
221
```
```python
);
imshow(w11,[]);
title(
```
```python
'第一个滤波器的R通道'
```
```python
);
% green channel
subplot(
```
```python
222
```
```python
);
imshow(w12,[]);
title(
```
```python
'第一个滤波器的G通道'
```
```python
);
% blue channel
subplot(
```
```python
223
```
```python
);
imshow(w13,[]);
title(
```
```python
'第一个滤波器的B通道'
```
```python
);
```
```python
%% 参看是如何计算的
%
```
```python
using:
```
```python
input_img ,w11 w12 w13 ,conv11_img
% figure(
```
```python
4
```
```python
);
% imshow(input_img,[]);
figure(
```
```python
3
```
```python
);
% mean_img
subplot(
```
```python
441
```
```python
);
imshow(input_img(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
1
```
```python
),[]);
title({[
```
```python
'大小为:'
```
```python
num2str(size(input_img(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
1
```
```python
)))];
```
```python
'均值图像的R通道'
```
```python
});
subplot(
```
```python
445
```
```python
);
imshow(input_img(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
2
```
```python
),[]);
title(
```
```python
'均值图像的G通道'
```
```python
);
subplot(
```
```python
449
```
```python
);
imshow(input_img(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
3
```
```python
),[]);
title(
```
```python
'均值图像的B通道'
```
```python
);
% filter
subplot(
```
```python
442
```
```python
);
imshow(w11,[]);
title({[
```
```python
'大小为:'
```
```python
num2str(size(w11))];
```
```python
'滤波器的R通道'
```
```python
});
subplot(
```
```python
446
```
```python
);
imshow(w12,[]);
title(
```
```python
'滤波器的G通道'
```
```python
);
subplot(
```
```python
4
```
```python
,
```
```python
4
```
```python
,
```
```python
10
```
```python
);
imshow(w13,[]);
title(
```
```python
'滤波器的B通道'
```
```python
);
% map1
subplot(
```
```python
447
```
```python
);
imshow(conv11_img,[]);
title({[
```
```python
'大小为:'
```
```python
num2str(size(conv11_img))];
```
```python
'响应map'
```
```python
});
```
```python
%% check 计算过程:
%
```
```python
using:
```
```python
input_img ,w11 w12 w13 ,conv11_img
% 因为matlab卷积进行了旋转
```
```python
180
```
```python
度。
w11 = rot9
```
```python
0
```
```python
(w11,
```
```python
2
```
```python
);
w12 = rot9
```
```python
0
```
```python
(w12,
```
```python
2
```
```python
);
w13 = rot9
```
```python
0
```
```python
(w13,
```
```python
2
```
```python
);
mapr = conv2(input_img(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
1
```
```python
),w11,
```
```python
'valid'
```
```python
);%valid 只取有效部分
mapg = conv2(input_img(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
2
```
```python
),w12,
```
```python
'valid'
```
```python
);
mapb = conv2(input_img(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
3
```
```python
),w13,
```
```python
'valid'
```
```python
);
map = mapr + mapg + mapb;
map = map + b(ind1);
%因为代码中带了个relu层
map(find(map<
```
```python
0
```
```python
)) =
```
```python
0
```
```python
;
subplot(
```
```python
448
```
```python
)
imshow(map,[]);
title({[
```
```python
'大小为:'
```
```python
num2str(size(map))];
```
```python
'计算的map'
```
```python
});
```
运行结果：
![这里写图片描述](https://img-blog.csdn.net/20170408154155532?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcmFieV9neWw=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)[ ](https://img-blog.csdn.net/20170408154155532?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcmFieV9neWw=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)
图中，左边三张图像是输入单个图像的三个通道（已经减去均值的图像）,从左第2栏是三个通道对应的学习的滤波器权重(额外的一个偏置，不能画出来），第三栏是Caffe给出的卷积层+relu的结果（因为我们卷积层后面跟着一个in place relu操作），最后一栏是模拟caffe操作形成的同样的结果。
[
](https://img-blog.csdn.net/20170408154155532?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcmFieV9neWw=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)在caffe中的卷积层的训练参数为如下，我们没有设置卷积层的group参数，默认为1,即将所有通道看成一组。因此操作为：
[
](https://img-blog.csdn.net/20170408154155532?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcmFieV9neWw=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)**conv_oper= w11 * img_r + w12 * img_g+w13 * img__b + bias**
[
](https://img-blog.csdn.net/20170408154155532?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcmFieV9neWw=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)img_r,img_g,img_b是img的三个通道图像,bias是偏置。
[

](https://img-blog.csdn.net/20170408154155532?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcmFieV9neWw=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)
```python
layer
```
```python
{
```
```python
name
```
```python
:
```
```python
"conv_all"
```
```python
type:
```
```python
"Convolution"
```
```python
bottom:
```
```python
"data"
```
```python
top:
```
```python
"conv_all"
```
```python
convolution_param {
    num_output:
```
```python
50
```
```python
kernel_size:
```
```python
5
```
```python
stride:
```
```python
1
```
```python
weight_filler {
      type:
```
```python
"xavier"
```
```python
}
```
```python
bias_filler
```
```python
{
```
```python
type
```
```python
:
```
```python
"constant"
```
```python
}
  }
}
```
```python
layer
```
```python
{
```
```python
name
```
```python
:
```
```python
"relu_all"
```
```python
type:
```
```python
"ReLU"
```
```python
bottom:
```
```python
"conv_all"
```
```python
top:
```
```python
"conv_all"
```
```python
}
```
[
](https://img-blog.csdn.net/20170408154155532?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcmFieV9neWw=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)实验代码2：
[

](https://img-blog.csdn.net/20170408154155532?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcmFieV9neWw=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)
```python
clearvars;close all;
```
```python
if
```
```python
~exist(
```
```python
'ttest_data'
```
```python
,
```
```python
'var'
```
```python
)||~exist(
```
```python
'means'
```
```python
,
```
```python
'var'
```
```python
)
    test_data = load(
```
```python
'ttest_data.mat'
```
```python
); % load ttest_data
    test_data = test_data.ttest_data;
    means = load(
```
```python
'mean_file.mat'
```
```python
);
    means = means.means;
```
```python
end
```
```python
n = length(test_data);
% rand_ind = randperm(n);
rand_ind =
```
```python
1
```
```python
:n
```
```python
;
ttest_data = test_data(rand_ind(
```
```python
1
```
```python
:
```
```python
1
```
```python
));
ntest = length(ttest_data);
ttest_label = zeros(
```
```python
1
```
```python
,
```
```python
1
```
```python
,
```
```python
2
```
```python
,ntest);
face_size = [
```
```python
100
```
```python
100
```
```python
]; % height width
% width height  channels nsamples
ttest_feature = zeros(face_size(
```
```python
1
```
```python
),face_size(
```
```python
2
```
```python
),
```
```python
3
```
```python
,ntest);
isShow =
```
```python
false
```
```python
;
tic;
```
```python
for
```
```python
i =
```
```python
1
```
```python
:ntest
```
```python
img = imread( ttest_data(i).imgPath);
    bbox = ttest_data(i).bbox;
    face_img = img(bbox(
```
```python
2
```
```python
)
```
```python
:bbox
```
```python
(
```
```python
2
```
```python
)+bbox(
```
```python
4
```
```python
),bbox(
```
```python
1
```
```python
)
```
```python
:bbox
```
```python
(
```
```python
1
```
```python
)+bbox(
```
```python
3
```
```python
),
```
```python
:
```
```python
);
    res_img = imresize(face_img,face_size);
```
```python
if
```
```python
isShow
        figure;
        imshow(face_img);
        pause;
```
```python
end
```
```python
ttest_label(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
1
```
```python
,i) = ttest_data(i).poseId +
```
```python
2
```
```python
; %
```
```python
0
```
```python
1
```
```python
2
```
```python
3
```
```python
4
```
```python
ttest_label(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
2
```
```python
,i) = ttest_data(i).smile ;
    ttest_feature(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
:
```
```python
,i) = res_img;
```
```python
end
```
```python
f_time = toc;
disp([
```
```python
'feature_time :'
```
```python
num2str(f_time)]);
% change rgb to bgr
ttest_feature = ttest_feature(
```
```python
:
```
```python
,
```
```python
:
```
```python
,[
```
```python
3
```
```python
2
```
```python
1
```
```python
],
```
```python
:
```
```python
);
% permute width height
ttest_feature = permute(ttest_feature,[
```
```python
2
```
```python
1
```
```python
3
```
```python
4
```
```python
]);
% subtract mean_file
ttest_feature = ttest_feature - means;
ttest_feature = ttest_feature ./
```
```python
255
```
```python
;

net_model =
```
```python
'deploy.prototxt'
```
```python
;
net_weights =
```
```python
'lenet_iter_10000.caffemodel'
```
```python
;
phase =
```
```python
'test'
```
```python
;
```
```python
if
```
```python
exist(
```
```python
'../+caffe'
```
```python
,
```
```python
'dir'
```
```python
)
    addpath(
```
```python
'..'
```
```python
);
```
```python
else
```
```python
error(
```
```python
'Please run this demo from caffe/matlab/demo'
```
```python
);
```
```python
end
```
```python
net = caffe.
```
```python
Net
```
```python
(net_model, net_weights, phase);
% input_feature must be a cell
scores = net.forward({ttest_feature});
```
```python
%% 获取网络中的blob
input_img = net.blobs('data').get_data();
conv1 = net.blobs('conv_all').get_data();
%
```
```python
input_image
```
```python
:
```
```python
w * h * c * n
```
```python
:
```
```python
为
```
```python
255
```
```python
*
```
```python
255
```
```python
*
```
```python
3
```
```python
%
```
```python
conv1:
```
```python
w * h * c * n
```
```python
:
```
```python
为
```
```python
96
```
```python
*
```
```python
96
```
```python
*
```
```python
60
```
```python
,
% change w*h*c to h*w*c 即rows * cols * c
input_img = permute(input_img,[
```
```python
2
```
```python
1
```
```python
3
```
```python
]);
% change bgr to rgb
input_img = input_img(
```
```python
:
```
```python
,
```
```python
:
```
```python
,[
```
```python
3
```
```python
2
```
```python
1
```
```python
]);
ind1 =
```
```python
6
```
```python
;
% change width to height
conv1 = permute(conv1,[
```
```python
2
```
```python
,
```
```python
1
```
```python
,
```
```python
3
```
```python
,
```
```python
4
```
```python
]);
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%% point1 
conv1b = conv1(:,:,1); %
```
```python
blue
conv1g = conv1(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
21
```
```python
); % green
conv1r = conv1(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
41
```
```python
); % red
figure;
subplot(
```
```python
121
```
```python
);
imshow(res_img);
title(
```
```python
'原图像'
```
```python
);
subplot(
```
```python
122
```
```python
);
imshow(input_img,[]);
title(
```
```python
'输入图像(减去均值)'
```
```python
);
```
```python
%% 权重的可视化
w = net.layers('conv_all').params(1).get_data();%
```
```python
5
```
```python
*
```
```python
5
```
```python
*
```
```python
1
```
```python
*
```
```python
60
```
```python
disp(size(w));
b = net.layers(
```
```python
'conv_all'
```
```python
).params(
```
```python
2
```
```python
).get_data(); %
```
```python
60
```
```python
*
```
```python
1
```
```python
disp(size(b));
% change width
```
```python
and
```
```python
height
w = permute(w,[
```
```python
2
```
```python
1
```
```python
3
```
```python
4
```
```python
]);
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
point
```
```python
2
```
```python
w1b = w(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
1
```
```python
,
```
```python
1
```
```python
);
w1g = w(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
1
```
```python
,
```
```python
21
```
```python
);
w1r = w(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
1
```
```python
,
```
```python
41
```
```python
);
figure(
```
```python
2
```
```python
);
% red channel
subplot(
```
```python
221
```
```python
);
imshow(w1b,[]);
title(
```
```python
'第一个滤波器的b通道'
```
```python
);
% green channel
subplot(
```
```python
222
```
```python
);
imshow(w1g,[]);
title(
```
```python
'第一个滤波器的G通道'
```
```python
);
% blue channel
subplot(
```
```python
223
```
```python
);
imshow(w1r,[]);
title(
```
```python
'第一个滤波器的r通道'
```
```python
);
```
```python
%% 参看是如何计算的
%
```
```python
using:
```
```python
input_img ,w11 w12 w13 ,conv11_img
% figure(
```
```python
4
```
```python
);
% imshow(input_img,[]);
figure(
```
```python
3
```
```python
);
% mean_img
subplot(
```
```python
441
```
```python
);
imshow(input_img(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
1
```
```python
),[]);
title({[
```
```python
'大小为:'
```
```python
num2str(size(input_img(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
1
```
```python
)))];
```
```python
'均值图像的R通道'
```
```python
});
subplot(
```
```python
445
```
```python
);
imshow(input_img(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
2
```
```python
),[]);
title(
```
```python
'均值图像的G通道'
```
```python
);
subplot(
```
```python
449
```
```python
);
imshow(input_img(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
3
```
```python
),[]);
title(
```
```python
'均值图像的B通道'
```
```python
);
% filter
subplot(
```
```python
442
```
```python
);
imshow(w1r,[]);
title({[
```
```python
'大小为:'
```
```python
num2str(size(w1b))];
```
```python
'滤波器的r通道：41'
```
```python
});
subplot(
```
```python
446
```
```python
);
imshow(w1g,[]);
title(
```
```python
'滤波器的G通道:21'
```
```python
);
subplot(
```
```python
4
```
```python
,
```
```python
4
```
```python
,
```
```python
10
```
```python
);
imshow(w1b,[]);
title(
```
```python
'滤波器的b通道:1'
```
```python
);
% map1
subplot(
```
```python
443
```
```python
);
imshow(conv1r,[]);
title({[
```
```python
'大小为:'
```
```python
num2str(size(conv1b))];
```
```python
'conv1r'
```
```python
});
subplot(
```
```python
447
```
```python
);
imshow(conv1g,[]);
title(
```
```python
'conv1g'
```
```python
);
subplot(
```
```python
4
```
```python
,
```
```python
4
```
```python
,
```
```python
11
```
```python
);
imshow(conv1b,[]);
title(
```
```python
'conv1b'
```
```python
);
```
```python
%% check 计算过程:
%
```
```python
using:
```
```python
input_img ,w11 w12 w13 ,conv11_img
% 因为matlab卷积进行了旋转
```
```python
180
```
```python
度。
w1b = rot9
```
```python
0
```
```python
(w1b,
```
```python
2
```
```python
);
w1g = rot9
```
```python
0
```
```python
(w1g,
```
```python
2
```
```python
);
w1r = rot9
```
```python
0
```
```python
(w1r,
```
```python
2
```
```python
);
mapr = conv2(input_img(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
1
```
```python
),w1r,
```
```python
'valid'
```
```python
);%valid 只取有效部分
mapg = conv2(input_img(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
2
```
```python
),w1g,
```
```python
'valid'
```
```python
);
mapb = conv2(input_img(
```
```python
:
```
```python
,
```
```python
:
```
```python
,
```
```python
3
```
```python
),w1b,
```
```python
'valid'
```
```python
);
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
%%%
```
```python
point
```
```python
3
```
```python
mapb = mapb + b(
```
```python
1
```
```python
);
mapg = mapg + b(
```
```python
21
```
```python
);
mapr = mapr + b(
```
```python
41
```
```python
);

%因为代码中带了个relu层
mapb(find(mapb<
```
```python
0
```
```python
)) =
```
```python
0
```
```python
;
mapg(find(mapg<
```
```python
0
```
```python
)) =
```
```python
0
```
```python
;
mapr(find(mapr<
```
```python
0
```
```python
)) =
```
```python
0
```
```python
;
subplot(
```
```python
444
```
```python
)
imshow(mapr,[]);
title({[
```
```python
'大小为:'
```
```python
num2str(size(mapb))];
```
```python
'计算的mapr'
```
```python
});
subplot(
```
```python
448
```
```python
)
imshow(mapg,[]);
title(
```
```python
'计算的mapg'
```
```python
);
subplot(
```
```python
4
```
```python
,
```
```python
4
```
```python
,
```
```python
12
```
```python
)
imshow(mapb,[]);
title(
```
```python
'计算的mapb'
```
```python
);
```
```python
%%%
```
```python
我们可以检查数据
```
```python
:
```
```python
mapb == conv1b? mapr == conv1r? mapg == conv1g?
```
[
](https://img-blog.csdn.net/20170408154155532?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcmFieV9neWw=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)实验中，我们将第一个conv1层的group设置为3，输入数据为三通道的彩色图像(采用测试时跟踪数据的流向）.
部分deploy.prototxt协议如下：
```python
# 数据输入
```
```python
layer
```
```python
{
```
```python
name
```
```python
:
```
```python
"data"
```
```python
type:
```
```python
"Input"
```
```python
top:
```
```python
"data"
```
```python
input_param{shape:{dim:
```
```python
1
```
```python
dim:
```
```python
3
```
```python
dim:
```
```python
100
```
```python
dim:
```
```python
100
```
```python
}}
}
# 第一个卷积层
```
```python
layer
```
```python
{
```
```python
name
```
```python
:
```
```python
"conv_all"
```
```python
type:
```
```python
"Convolution"
```
```python
bottom:
```
```python
"data"
```
```python
top:
```
```python
"conv_all"
```
```python
convolution_param {
    num_output:
```
```python
60
```
```python
kernel_size:
```
```python
5
```
```python
stride:
```
```python
1
```
```python
group:
```
```python
3
```
```python
weight_filler {
      type:
```
```python
"xavier"
```
```python
}
```
```python
bias_filler
```
```python
{
```
```python
type
```
```python
:
```
```python
"constant"
```
```python
}
  }
}
```
结果图像：
![这里写图片描述](https://img-blog.csdn.net/20170410153712769?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcmFieV9neWw=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)
执行过程如下图：
![这里写图片描述](https://img-blog.csdn.net/20170410155814394?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcmFieV9neWw=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)
说明，对于单图像的预测，首先将输入图像减去均值图像，然后分离出三个通道b,g,r，然后首先将b通道图像与20个滤波器卷积，然后将g通道与20个滤波器卷积,r亦如此。所以为了演示三个通道的卷积过程，会采用下标1,21,41的访问形式。

