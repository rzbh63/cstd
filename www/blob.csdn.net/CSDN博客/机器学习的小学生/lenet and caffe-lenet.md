
# lenet and caffe-lenet - 机器学习的小学生 - CSDN博客


2017年04月12日 11:09:58[机器学习的小学生](https://me.csdn.net/xuluhui123)阅读数：254个人分类：[Caffe																](https://blog.csdn.net/xuluhui123/article/category/6777566)



## 方法1：代码测试
下面的代码测试caffe-lenet中权重w,b以及bottom,up数据大小变化的情况。理解caffe-lenet中的具体实现。并对mnist数据集进行了测试。对于caffe生成的mean.binaryproto文件其在matlab中同样遵循[width * height *c]以及bgr模式。
实现需要的文件:
mnist数据集的 ：mean.binaryproto文件,mnist_test 和mnist_test_label。
```python
clearvars;close all;
```
```python
if
```
```python
exist(
```
```python
'../+caffe'
```
```python
,
```
```python
'dir'
```
```python
)
    addpath(
```
```python
'..'
```
```python
);
```
```python
else
```
```python
error(
```
```python
'Please run this demo from caffe/matlab/demo'
```
```python
);
```
```python
end
```
```python
%% load mnist_test_data and mean_file
```
```python
% width * height * c  and bgr
```
```python
mean_file =
```
```python
caffe.
```
```python
io.
```
```python
read_mean(
```
```python
'mean.binaryproto'
```
```python
);
load
```
```python
mnist_test.
```
```python
mat;
```
```python
%  mnist_test
```
```python
load
```
```python
mnist_test_labels.
```
```python
mat;
```
```python
% mnist_test_labels
```
```python
tnum =
```
```python
6
```
```python
;
```
```python
% test_num
```
```python
true_label = mnist_test_labels(
```
```python
1
```
```python
:tnum)
```
```python
';
test_img = reshape(mnist_test,[size(mnist_test,1) 28 28]);
test_img = permute(test_img,[3 2 1]); %交互三个维度。
test_img = test_img(:,:,1:tnum); % 可显示化的,height *　width * nsamples
% convert [h * w * n] to [w * h * n]
test_img = permute(test_img,[2 1 3]);
% 减去均值文件
test_img = bsxfun(@minus,test_img,mean_file);
% 尺度化
test_img = test_img * 0.00390625; % 除以 255
%convert [w * h * n] to [w * h * c * n]
test_img = reshape(test_img,[size(test_img,1) size(test_img,2) 1 size(test_img,3)]);
%% 预测
net_model = '
```
```python
lenet.
```
```python
prototxt'
```
```python
;
net_weights =
```
```python
'1lenet_iter_10000.caffemodel'
```
```python
;
phase =
```
```python
'test'
```
```python
;
net =
```
```python
caffe.
```
```python
Net(net_model, net_weights, phase);
```
```python
% input_feature must be a cell
```
```python
scores =
```
```python
net.
```
```python
forward(
```
```python
{test_img}
```
```python
);
scores = scores
```
```python
{
```
```python
1
```
```python
}
```
```python
;
```
```python
[~,max_label]
```
```python
= max(scores);
pre_label = max_label -
```
```python
1
```
```python
;
```
```python
% 0 1 2 3 4 5 6 7 8 9
```
```python
disp
```
```python
(
```
```python
'pre_label:'
```
```python
);
```
```python
disp
```
```python
(pre_label);
```
```python
disp
```
```python
(
```
```python
'true_label:'
```
```python
);
```
```python
disp
```
```python
(true_label);
```
```python
%% 将层的权重和偏移，以及输入，输出数据的大小打印出来。
```
```python
% conv1 ==> bottom: "data"  top: "conv1"
```
```python
% pool1 ==> bottom: "conv1" top: "pool1"
```
```python
% conv2 ==> bottom: "pool1" top: "conv2"
```
```python
% pool2 ==> bottom: "conv2" top: "pool2"
```
```python
% ip1   ==> bottom: "pool2" top: "ip1"
```
```python
% relu1 ==> bottom: "ip1"   top: "ip1
```
```python
% ip2   ==> bottom: "ip1"   top: "ip2"
```
```python
% prob  ==> bottom: "ip2"   top: "prob"
```
```python
params = cell(
```
```python
8
```
```python
,
```
```python
3
```
```python
);
params
```
```python
{
```
```python
1
```
```python
,
```
```python
1
```
```python
}
```
```python
=
```
```python
'conv1'
```
```python
; params
```
```python
{
```
```python
1
```
```python
,
```
```python
2
```
```python
}
```
```python
=
```
```python
'data'
```
```python
;  params
```
```python
{
```
```python
1
```
```python
,
```
```python
3
```
```python
}
```
```python
=
```
```python
'conv1'
```
```python
;
params
```
```python
{
```
```python
2
```
```python
,
```
```python
1
```
```python
}
```
```python
=
```
```python
'pool1'
```
```python
; params
```
```python
{
```
```python
2
```
```python
,
```
```python
2
```
```python
}
```
```python
=
```
```python
'conv1'
```
```python
; params
```
```python
{
```
```python
2
```
```python
,
```
```python
3
```
```python
}
```
```python
=
```
```python
'pool1'
```
```python
;
params
```
```python
{
```
```python
3
```
```python
,
```
```python
1
```
```python
}
```
```python
=
```
```python
'conv2'
```
```python
; params
```
```python
{
```
```python
3
```
```python
,
```
```python
2
```
```python
}
```
```python
=
```
```python
'pool1'
```
```python
; params
```
```python
{
```
```python
3
```
```python
,
```
```python
3
```
```python
}
```
```python
=
```
```python
'conv2'
```
```python
;
params
```
```python
{
```
```python
4
```
```python
,
```
```python
1
```
```python
}
```
```python
=
```
```python
'pool2'
```
```python
; params
```
```python
{
```
```python
4
```
```python
,
```
```python
2
```
```python
}
```
```python
=
```
```python
'conv2'
```
```python
; params
```
```python
{
```
```python
4
```
```python
,
```
```python
3
```
```python
}
```
```python
=
```
```python
'pool2'
```
```python
;
params
```
```python
{
```
```python
5
```
```python
,
```
```python
1
```
```python
}
```
```python
=
```
```python
'ip1'
```
```python
;   params
```
```python
{
```
```python
5
```
```python
,
```
```python
2
```
```python
}
```
```python
=
```
```python
'pool2'
```
```python
; params
```
```python
{
```
```python
5
```
```python
,
```
```python
3
```
```python
}
```
```python
=
```
```python
'ip1'
```
```python
;
params
```
```python
{
```
```python
6
```
```python
,
```
```python
1
```
```python
}
```
```python
=
```
```python
'relu1'
```
```python
; params
```
```python
{
```
```python
6
```
```python
,
```
```python
2
```
```python
}
```
```python
=
```
```python
'ip1'
```
```python
;   params
```
```python
{
```
```python
6
```
```python
,
```
```python
3
```
```python
}
```
```python
=
```
```python
'ip1'
```
```python
;
params
```
```python
{
```
```python
7
```
```python
,
```
```python
1
```
```python
}
```
```python
=
```
```python
'ip2'
```
```python
;   params
```
```python
{
```
```python
7
```
```python
,
```
```python
2
```
```python
}
```
```python
=
```
```python
'ip1'
```
```python
;   params
```
```python
{
```
```python
7
```
```python
,
```
```python
3
```
```python
}
```
```python
=
```
```python
'ip2'
```
```python
;
params
```
```python
{
```
```python
8
```
```python
,
```
```python
1
```
```python
}
```
```python
=
```
```python
'prob'
```
```python
;  params
```
```python
{
```
```python
8
```
```python
,
```
```python
2
```
```python
}
```
```python
=
```
```python
'ip2'
```
```python
;   params
```
```python
{
```
```python
8
```
```python
,
```
```python
3
```
```python
}
```
```python
=
```
```python
'prob'
```
```python
;
matlab_show = true;
```
```python
% matlab中 权重w,偏置b，bottom和top数据格式如下,group = 1(default):
```
```python
% w = [width * height * c * num_output1]  [width * height * num_output1 * num_output2] ...
```
```python
% b = [num_output 1];
```
```python
% bottom and top : [width * height * c * nsamples] [width * height *　num_output1 * nsamples]...
```
```python
disp
```
```python
(
```
```python
'------------------------------------------------'
```
```python
);
```
```python
for
```
```python
i
```
```python
=
```
```python
1
```
```python
:
```
```python
size
```
```python
(params,
```
```python
1
```
```python
)
```
```python
if
```
```python
strcmp(params
```
```python
{i,
```
```python
1
```
```python
}
```
```python
(
```
```python
1
```
```python
:
```
```python
end
```
```python
-
```
```python
1
```
```python
),
```
```python
'conv'
```
```python
)  ||  strcmp(params
```
```python
{i,
```
```python
1
```
```python
}
```
```python
(
```
```python
1
```
```python
:
```
```python
end
```
```python
-
```
```python
1
```
```python
),
```
```python
'ip'
```
```python
)
        conv1_layer_w =
```
```python
net.
```
```python
layers(params
```
```python
{i,
```
```python
1
```
```python
}
```
```python
).params(
```
```python
1
```
```python
).get_data();
        conv1_layer_b =
```
```python
net.
```
```python
layers(params
```
```python
{i,
```
```python
1
```
```python
}
```
```python
).params(
```
```python
2
```
```python
).get_data();
```
```python
if
```
```python
matlab_show == false
```
```python
% convert [width * height * c * n] to [n * c * height * witdh]
```
```python
conv1_layer_w =
```
```python
permute
```
```python
(conv1_layer_w,
```
```python
[
```
```python
4
```
```python
3
```
```python
2
```
```python
1
```
```python
]
```
```python
);
```
```python
end
```
```python
elseif
```
```python
strcmp(params
```
```python
{i,
```
```python
1
```
```python
}
```
```python
(
```
```python
1
```
```python
:
```
```python
end
```
```python
-
```
```python
1
```
```python
),
```
```python
'pool'
```
```python
)
```
```python
%conv1_layer_w = net.layers(params{i,1}).params(1).get_data();
```
```python
end
```
```python
bottom  =
```
```python
net.
```
```python
blobs(params
```
```python
{i,
```
```python
2
```
```python
}
```
```python
).get_data();
    top =
```
```python
net.
```
```python
blobs(params
```
```python
{i,
```
```python
3
```
```python
}
```
```python
).get_data();
```
```python
if
```
```python
matlab_show == false
```
```python
% convert [width * height * c * n] to [n * c * height * witdh]
```
```python
bottom =
```
```python
permute
```
```python
(bottom,
```
```python
[
```
```python
4
```
```python
3
```
```python
2
```
```python
1
```
```python
]
```
```python
);
        top =
```
```python
permute
```
```python
(top,
```
```python
[
```
```python
4
```
```python
3
```
```python
2
```
```python
1
```
```python
]
```
```python
);
```
```python
end
```
```python
if
```
```python
strcmp(params
```
```python
{i,
```
```python
1
```
```python
}
```
```python
(
```
```python
1
```
```python
:
```
```python
end
```
```python
-
```
```python
1
```
```python
),
```
```python
'conv'
```
```python
)  || strcmp(params
```
```python
{i,
```
```python
1
```
```python
}
```
```python
(
```
```python
1
```
```python
:
```
```python
end
```
```python
-
```
```python
1
```
```python
),
```
```python
'ip'
```
```python
)
```
```python
disp
```
```python
(
```
```python
[params{i,
```
```python
1
```
```python
}
```
```python
'_layer: w: ['
```
```python
num2str(size(conv1_layer_w))
```
```python
'] ;b: ['
```
```python
num2str(size(conv1_layer_b))
```
```python
'] '
```
```python
]
```
```python
);
```
```python
end
```
```python
disp
```
```python
(
```
```python
[ params{i,
```
```python
2
```
```python
}
```
```python
': ['
```
```python
num2str(size(bottom))
```
```python
'] ;'
```
```python
params{i,
```
```python
3
```
```python
}
```
```python
': ['
```
```python
num2str(size(top))
```
```python
']'
```
```python
]
```
```python
);
```
```python
disp
```
```python
(
```
```python
'------------------------------------------------'
```
```python
);
```
```python
end
```
输出：
![这里写图片描述](https://img-blog.csdn.net/20170412172914787?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcmFieV9neWw=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)
输出结果给出了测试的6个样本的预测标签和正确标签。以及各个层的参数大小和数据的大小。打印的方式采用matlab数据的存储方式。我们可以看到经过池化层后的数据为：pool2 : [4 4 50 6]，紧接着是全连接层ip1_layer: w :[800 500]，这里在prototxt中设置的num_output为500。我们可以看到： 800 = 4 * 4 * 50 ，因此是所有神经元都进行了连接，而没有像很多博客给的文中全连接层是通过进一步的卷积核(例如5*5（当然这里肯定不行)或者其他大小的卷积核)卷积实现的。
## 方法二：可视化工具
将下面的test协议复制到在线可视化工具，可以看到每个blob的大小。
```python
name
```
```python
: "
```
```python
LeNet
```
```python
"
```
```python
layer
```
```python
{
```
```python
name
```
```python
:
```
```python
"data"
```
```python
type:
```
```python
"Input"
```
```python
top:
```
```python
"data"
```
```python
input_param { shape: { dim:
```
```python
6
```
```python
dim:
```
```python
1
```
```python
dim:
```
```python
28
```
```python
dim:
```
```python
28
```
```python
} }
}
```
```python
layer
```
```python
{
```
```python
name
```
```python
:
```
```python
"conv1"
```
```python
type:
```
```python
"Convolution"
```
```python
bottom:
```
```python
"data"
```
```python
top:
```
```python
"conv1"
```
```python
param {
    lr_mult:
```
```python
1
```
```python
}
```
```python
param
```
```python
{
```
```python
lr_mult
```
```python
:
```
```python
2
```
```python
}
```
```python
convolution_param
```
```python
{
```
```python
num_output
```
```python
:
```
```python
20
```
```python
kernel_size:
```
```python
5
```
```python
stride:
```
```python
1
```
```python
weight_filler {
      type:
```
```python
"xavier"
```
```python
}
```
```python
bias_filler
```
```python
{
```
```python
type
```
```python
:
```
```python
"constant"
```
```python
}
  }
}
```
```python
layer
```
```python
{
```
```python
name
```
```python
:
```
```python
"pool1"
```
```python
type:
```
```python
"Pooling"
```
```python
bottom:
```
```python
"conv1"
```
```python
top:
```
```python
"pool1"
```
```python
pooling_param {
    pool: MAX
    kernel_size:
```
```python
2
```
```python
stride:
```
```python
2
```
```python
}
}
```
```python
layer
```
```python
{
```
```python
name
```
```python
:
```
```python
"conv2"
```
```python
type:
```
```python
"Convolution"
```
```python
bottom:
```
```python
"pool1"
```
```python
top:
```
```python
"conv2"
```
```python
param {
    lr_mult:
```
```python
1
```
```python
}
```
```python
param
```
```python
{
```
```python
lr_mult
```
```python
:
```
```python
2
```
```python
}
```
```python
convolution_param
```
```python
{
```
```python
num_output
```
```python
:
```
```python
50
```
```python
kernel_size:
```
```python
5
```
```python
stride:
```
```python
1
```
```python
weight_filler {
      type:
```
```python
"xavier"
```
```python
}
```
```python
bias_filler
```
```python
{
```
```python
type
```
```python
:
```
```python
"constant"
```
```python
}
  }
}
```
```python
layer
```
```python
{
```
```python
name
```
```python
:
```
```python
"pool2"
```
```python
type:
```
```python
"Pooling"
```
```python
bottom:
```
```python
"conv2"
```
```python
top:
```
```python
"pool2"
```
```python
pooling_param {
    pool: MAX
    kernel_size:
```
```python
2
```
```python
stride:
```
```python
2
```
```python
}
}
```
```python
layer
```
```python
{
```
```python
name
```
```python
:
```
```python
"ip1"
```
```python
type:
```
```python
"InnerProduct"
```
```python
bottom:
```
```python
"pool2"
```
```python
top:
```
```python
"ip1"
```
```python
param {
    lr_mult:
```
```python
1
```
```python
}
```
```python
param
```
```python
{
```
```python
lr_mult
```
```python
:
```
```python
2
```
```python
}
```
```python
inner_product_param
```
```python
{
```
```python
num_output
```
```python
:
```
```python
500
```
```python
weight_filler {
      type:
```
```python
"xavier"
```
```python
}
```
```python
bias_filler
```
```python
{
```
```python
type
```
```python
:
```
```python
"constant"
```
```python
}
  }
}
```
```python
layer
```
```python
{
```
```python
name
```
```python
:
```
```python
"relu1"
```
```python
type:
```
```python
"ReLU"
```
```python
bottom:
```
```python
"ip1"
```
```python
top:
```
```python
"ip1"
```
```python
}
```
```python
layer
```
```python
{
```
```python
name
```
```python
:
```
```python
"ip2"
```
```python
type:
```
```python
"InnerProduct"
```
```python
bottom:
```
```python
"ip1"
```
```python
top:
```
```python
"ip2"
```
```python
param {
    lr_mult:
```
```python
1
```
```python
}
```
```python
param
```
```python
{
```
```python
lr_mult
```
```python
:
```
```python
2
```
```python
}
```
```python
inner_product_param
```
```python
{
```
```python
num_output
```
```python
:
```
```python
10
```
```python
weight_filler {
      type:
```
```python
"xavier"
```
```python
}
```
```python
bias_filler
```
```python
{
```
```python
type
```
```python
:
```
```python
"constant"
```
```python
}
  }
}
```
```python
layer
```
```python
{
```
```python
name
```
```python
:
```
```python
"prob"
```
```python
type:
```
```python
"Softmax"
```
```python
bottom:
```
```python
"ip2"
```
```python
top:
```
```python
"prob"
```
```python
}
```
![这里写图片描述](https://img-blog.csdn.net/20170412192520253?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcmFieV9neWw=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)

