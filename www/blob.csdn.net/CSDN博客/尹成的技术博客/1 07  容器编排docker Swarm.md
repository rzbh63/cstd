
# 1.07  容器编排docker Swarm - 尹成的技术博客 - CSDN博客

2018年12月10日 09:34:26[尹成](https://me.csdn.net/yincheng01)阅读数：83个人分类：[GO语言](https://blog.csdn.net/yincheng01/article/category/7679307)[区块链](https://blog.csdn.net/yincheng01/article/category/7618299)[](https://blog.csdn.net/yincheng01/article/category/7679307)



**1.编排swarm简介**
学习怎么将docker用于生产环境，前面学的是用于本地测试环境
之前学的是通过docker客户端连接安装好docker的linux机器，如下图
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153544464.png)
生产环境下机器和容器都非常多，怎么去管理容器？怎么横向扩展？如果容器down了怎么恢复？如何更新容器不影响业务？如何监控容器？如何调度容器的创建？如何保护隐私数据？
swarm是内置于docker的容器编排工具
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153551166.png)
swarm集群架构图，有manager和worker两种角色
manager至少有两个，内置分布式存储数据库实现数据同步，这里是通过Raft进行数据同步的，不会出现脑裂的情况，最终实现HA
worker之间通过gossip的网络做数据同步
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153558316.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTA5ODY3NzY=,size_16,color_FFFFFF,t_70)
service和replicas，部署nginx的service，实际部署产生三个容器，三个容器通过调度系统，调度到不同的节点
也就是部署时，最初是不知道扩展节点会部署到哪里的，由swarm通过调度算法去算的，看哪个机器目前空闲
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153608830.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTA5ODY3NzY=,size_16,color_FFFFFF,t_70)
服务创建和调度
在swarm manage做决策，决定将worker部署到哪里
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153618290.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTA5ODY3NzY=,size_16,color_FFFFFF,t_70)
2.三节点swarm集群的搭建
准备三台装好docker的机器，这里做一个manager，两个worker
在主节点node01初始化swarm
运行完生成一行命令，子节点加入时，复制这一行代码执行就可以
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153635910.png)
node02和node03分别作为worker加入
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153641615.png)
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153646666.png)
查看当前swarm节点
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153653919.png)
节点退出swarm集群
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153658487.png)
快速部署：
地址：[https://labs.play-with-docker.com/](https://labs.play-with-docker.com/)
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153707332.png)
执行上面的步骤
3.创建维护Service并扩展
创建service
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153713852.png)
查看service状态
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153719892.png)
查看service创建的container的情况
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153726614.png)
然后在对应节点可以查看进程
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153733120.png)
将service横向扩展
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153739274.png)
查看一共有5个demo实例
![在这里插入图片描述](https://img-blog.csdnimg.cn/2018120515374480.png)
不同节点查看进程，5个service平均分配到manager和workder
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153749219.png)
node02中，删除一个容器
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153754784.png)
删完立刻去主节点查看，少了一个demo实例
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153801475.png)
主节点查看，会自动恢复
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153809902.png)
主节点删除service
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153814930.png)
4.使用DockerStack部署VotingApp
进入之前的/home/voting-example目录，将之前的docker-compose.yml内容删掉
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153820655.png)
swarm模式编译运行
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153826452.png)
查看运行状态
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153833550.png)
查看运行详细情况，多次执行，直到部署好
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153840252.png)
访问IP：5000是投票的页面
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205153848303.png)
访问IP：5001是查看结果的页面
![](https://img-blog.csdnimg.cn/20181205153859332.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTA5ODY3NzY=,size_16,color_FFFFFF,t_70)
集群运行状态下，将vote扩展为3个
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154217938.png)
查看到多了一个实例
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154223303.png)
停止并删除所有service
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154227963.png)
5.使用DockerStack部署可视化应用
创建目录
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154233458.png)
部署服务
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154238164.png)
查看stack部署情况
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154243802.png)
浏览器访问任意节点的9001端口
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154250158.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTA5ODY3NzY=,size_16,color_FFFFFF,t_70)
查看stack实例
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154256910.png)
集群运行状态下，将stack-demo_portainer扩展为3个
![在这里插入图片描述](https://img-blog.csdnimg.cn/2018120515431059.png)
浏览器访问任意节点的9001端口，此时stack-demo_portainer变为了3个实例
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154316478.png)
删除stack实例
![在这里插入图片描述](https://img-blog.csdnimg.cn/2018120515432346.png)
6.使用并管理DockerSecret
secret可以是用户名和密码，也可以是SSH key，可以是任何不想让别人看到的数据
docker swarm的架构如下，manager节点有基于raft的内置的分布式存储，是加密后存储的，worker信息也是加密是，也是分布式存储的
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154332192.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTA5ODY3NzY=,size_16,color_FFFFFF,t_70)
随意创建一个文件
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154338705.png)
创建secret
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154342777.png)
此时密码已经存储到manager的分布式存储中了
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154348341.png)
查看secret
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154352818.png)
也可以从标准输入创建
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154359489.png)
再次查看secret
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154406940.png)
删除secret
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154411829.png)
创建mysql的service
![在这里插入图片描述](https://img-blog.csdnimg.cn/2018120515441610.png)
查看进程运行的节点，这里看到是node03运行的
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154459268.png)
node03中查看进程
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154506250.png)
node03中交互运行mysql
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154512397.png)
交互运行时可以查看密码，然后用这个密码登录mysql
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154521364.png)
![在这里插入图片描述](https://img-blog.csdnimg.cn/2018120515452627.png)
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154532137.png)
[](https://img-blog.csdnimg.cn/2018120515452627.png)7.更新service版本
[](https://img-blog.csdnimg.cn/2018120515452627.png)创建demo网络
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154541851.png)
查看网络
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154547782.png)
创建service，可以去dockerHub查看nginx版本
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154553169.png)
访问80端口，会返回一个欢迎页
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154558718.png)
在node01写一个脚本，不停访问
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154604935.png)
在另一个会话，更新service的版本到1.13
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154610508.png)
node02访问业务，自动切换到新版本
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154615826.png)
在另一个会话，更新访问端口
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154620343.png)
node02访问，查看效果
![在这里插入图片描述](https://img-blog.csdnimg.cn/20181205154626953.png)
学院Go语言视频主页
[https://edu.csdn.net/lecturer/1928](https://edu.csdn.net/lecturer/1928)
[清华团队带你实战区块链开发]
([https://ke.qq.com/course/344443?tuin=3d17195d](https://ke.qq.com/course/344443?tuin=3d17195d))
扫码获取海量视频及源码   QQ群：
721929980
![在这里插入图片描述](https://img-blog.csdnimg.cn/2018111611182187.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lpbmNoZW5nMDE=,size_16,color_FFFFFF,t_70)

