
# Tensorflow源码解析4 -- 图的节点 - Operation - 谢杨易的博客 - CSDN博客

2018年11月16日 16:27:22[谢杨易](https://me.csdn.net/u013510838)阅读数：1055


Tensorflow源码解读系列文章，欢迎阅读
[带你深入AI（1） - 深度学习模型训练痛点及解决方法](https://blog.csdn.net/u013510838/article/details/79835563)
[自然语言处理1 – 分词](https://blog.csdn.net/u013510838/article/details/81673016)
[Tensorflow源码解析1 – 内核架构和源码结构](https://blog.csdn.net/u013510838/article/details/84103503)
[Tensorflow源码解析2 – 前后端连接的桥梁 - Session](https://blog.csdn.net/u013510838/article/details/84111031)
[Tensorflow源码解析3 – TensorFlow核心对象 - Graph](https://blog.csdn.net/u013510838/article/details/84139986)
[Tensorflow源码解析4 – 图的节点 - Operation](https://blog.csdn.net/u013510838/article/details/84141538)
[Tensorflow源码解析5 – 图的边 - Tensor](https://blog.csdn.net/u013510838/article/details/84144238)
[Tensorflow源码解析6 – TensorFlow本地运行时](https://blog.csdn.net/u013510838/article/details/84202248)
[Tensorflow源码解析7 – TensorFlow分布式运行时](https://blog.csdn.net/u013510838/article/details/84203683)
# 1 概述
上文讲述了TensorFlow的核心对象，计算图Graph。Graph包含两大成员，节点和边。节点即为计算算子Operation，边则为计算数据Tensor。由起始节点Source出发，按照Graph的拓扑顺序，依次执行节点的计算，即可完成整图的计算，最后结束于终止节点Sink，并输出计算结果。
本文会对节点Operation进行详细讲解。

# 2 前端节点数据结构
在Python前端中，Operation表示Graph的节点，Tensor表示Graph的边。Operation包含OpDef和NodeDef两个主要成员变量。其中OpDef描述了op的静态属性信息，例如op入参列表，出参列表等。而NodeDef则描述op的动态属性信息，例如op运行的设备信息，用户给op设置的name等。
先来看Operation的数据结构，只列出重要代码。
```python
@tf_export
```
```python
(
```
```python
"Operation"
```
```python
)
```
```python
class
```
```python
Operation
```
```python
(
```
```python
object
```
```python
)
```
```python
:
```
```python
def
```
```python
__init__
```
```python
(
```
```python
self
```
```python
,
```
```python
node_def
```
```python
,
```
```python
g
```
```python
,
```
```python
inputs
```
```python
=
```
```python
None
```
```python
,
```
```python
output_types
```
```python
=
```
```python
None
```
```python
,
```
```python
control_inputs
```
```python
=
```
```python
None
```
```python
,
```
```python
input_types
```
```python
=
```
```python
None
```
```python
,
```
```python
original_op
```
```python
=
```
```python
None
```
```python
,
```
```python
op_def
```
```python
=
```
```python
None
```
```python
)
```
```python
:
```
```python
# graph引用，通过它可以拿到Operation所注册到的Graph
```
```python
self
```
```python
.
```
```python
_graph
```
```python
=
```
```python
g
```
```python
# inputs
```
```python
if
```
```python
inputs
```
```python
is
```
```python
None
```
```python
:
```
```python
inputs
```
```python
=
```
```python
[
```
```python
]
```
```python
#  input types
```
```python
if
```
```python
input_types
```
```python
is
```
```python
None
```
```python
:
```
```python
input_types
```
```python
=
```
```python
[
```
```python
i
```
```python
.
```
```python
dtype
```
```python
.
```
```python
base_dtype
```
```python
for
```
```python
i
```
```python
in
```
```python
inputs
```
```python
]
```
```python
# control_input_ops
```
```python
control_input_ops
```
```python
=
```
```python
[
```
```python
]
```
```python
# node_def和op_def是两个最关键的成员
```
```python
if
```
```python
not
```
```python
self
```
```python
.
```
```python
_graph
```
```python
.
```
```python
_c_graph
```
```python
:
```
```python
self
```
```python
.
```
```python
_inputs_val
```
```python
=
```
```python
list
```
```python
(
```
```python
inputs
```
```python
)
```
```python
# Defensive copy.
```
```python
self
```
```python
.
```
```python
_input_types_val
```
```python
=
```
```python
input_types
      self
```
```python
.
```
```python
_control_inputs_val
```
```python
=
```
```python
control_input_ops
```
```python
# NodeDef，深复制
```
```python
self
```
```python
.
```
```python
_node_def_val
```
```python
=
```
```python
copy
```
```python
.
```
```python
deepcopy
```
```python
(
```
```python
node_def
```
```python
)
```
```python
# OpDef
```
```python
self
```
```python
.
```
```python
_op_def_val
```
```python
=
```
```python
op_def
```
```python
# outputs输出
```
```python
self
```
```python
.
```
```python
_outputs
```
```python
=
```
```python
[
```
```python
Tensor
```
```python
(
```
```python
self
```
```python
,
```
```python
i
```
```python
,
```
```python
output_type
```
```python
)
```
```python
for
```
```python
i
```
```python
,
```
```python
output_type
```
```python
in
```
```python
enumerate
```
```python
(
```
```python
output_types
```
```python
)
```
```python
]
```
下面来看Operation的属性方法，通过属性方法我们可以拿到Operation的两大成员，即OpDef和NodeDef。
```python
@
```
```python
property
```
```python
def
```
```python
name
```
```python
(
```
```python
self
```
```python
)
```
```python
:
```
```python
# Operation的name，注意要嵌套name_scope
```
```python
return
```
```python
self
```
```python
.
```
```python
_node_def_val
```
```python
.
```
```python
name
  @
```
```python
property
```
```python
def
```
```python
_id
```
```python
(
```
```python
self
```
```python
)
```
```python
:
```
```python
# Operation的唯一标示，id
```
```python
return
```
```python
self
```
```python
.
```
```python
_id_value
  @
```
```python
property
```
```python
def
```
```python
device
```
```python
(
```
```python
self
```
```python
)
```
```python
:
```
```python
# Operation的设备信息
```
```python
return
```
```python
self
```
```python
.
```
```python
_node_def_val
```
```python
.
```
```python
device
    
  @
```
```python
property
```
```python
def
```
```python
graph
```
```python
(
```
```python
self
```
```python
)
```
```python
:
```
```python
# graph引用
```
```python
return
```
```python
self
```
```python
.
```
```python
_graph
  @
```
```python
property
```
```python
def
```
```python
node_def
```
```python
(
```
```python
self
```
```python
)
```
```python
:
```
```python
# NodeDef成员，获取Operation的动态属性信息，例如Operation分配到的设备信息，Operation的name等
```
```python
return
```
```python
self
```
```python
.
```
```python
_node_def_val
  @
```
```python
property
```
```python
def
```
```python
op_def
```
```python
(
```
```python
self
```
```python
)
```
```python
:
```
```python
# OpDef，获取Operation的静态属性信息，例如Operation入参列表，出参列表等
```
```python
return
```
```python
self
```
```python
.
```
```python
_op_def_val
```
# 3 后端节点数据结构
在C++后端中，Graph图也包含两部分，即边Edge和节点Node。同样，节点Node用来表示计算算子，而边Edge则表示计算数据或者Node间依赖关系。Node数据结构如下所示。
```python
class Node
```
```python
{
```
```python
public
```
```python
:
```
```python
// NodeDef,节点算子Operation的信息，比如op分配到哪个设备上了等，运行时有可能变化。
```
```python
const
```
```python
NodeDef
```
```python
&
```
```python
def
```
```python
(
```
```python
)
```
```python
const
```
```python
;
```
```python
// OpDef, 节点算子Operation的元数据，不会变的。比如Operation的入参个数，名字等
```
```python
const
```
```python
OpDef
```
```python
&
```
```python
op_def
```
```python
(
```
```python
)
```
```python
const
```
```python
;
```
```python
private
```
```python
:
```
```python
// 输入边，传递数据给节点。可能有多条
```
```python
EdgeSet in_edges_
```
```python
;
```
```python
// 输出边，节点计算后得到的数据。可能有多条
```
```python
EdgeSet out_edges_
```
```python
;
```
```python
}
```
节点Node中包含的主要数据有输入边和输出边的集合，从而能够由Node找到跟他关联的所有边。Node中还包含NodeDef和OpDef两个成员。NodeDef表示节点算子的动态属性，创建Node时会new一个NodeDef对象。OpDef表示节点算子的静态属性，运行时不会变，创建Node时不需要new OpDef，只需要从OpDef仓库中取出即可。因为元信息是确定的，比如Operation的入参列表，出参列表等。
Tensorflow源码解读系列文章，欢迎阅读
[带你深入AI（1） - 深度学习模型训练痛点及解决方法](https://blog.csdn.net/u013510838/article/details/79835563)
[自然语言处理1 – 分词](https://blog.csdn.net/u013510838/article/details/81673016)
[Tensorflow源码解析1 – 内核架构和源码结构](https://blog.csdn.net/u013510838/article/details/84103503)
[Tensorflow源码解析2 – 前后端连接的桥梁 - Session](https://blog.csdn.net/u013510838/article/details/84111031)
[Tensorflow源码解析3 – TensorFlow核心对象 - Graph](https://blog.csdn.net/u013510838/article/details/84139986)
[Tensorflow源码解析4 – 图的节点 - Operation](https://blog.csdn.net/u013510838/article/details/84141538)
[Tensorflow源码解析5 – 图的边 - Tensor](https://blog.csdn.net/u013510838/article/details/84144238)
[Tensorflow源码解析6 – TensorFlow本地运行时](https://blog.csdn.net/u013510838/article/details/84202248)
[Tensorflow源码解析7 – TensorFlow分布式运行时](https://blog.csdn.net/u013510838/article/details/84203683)

