
# 纯Python和PyTorch对比实现门控循环单元GRU及反向传播 - BrightLamp的博客 - CSDN博客


2018年12月19日 22:46:45[BrightLampCsdn](https://me.csdn.net/oBrightLamp)阅读数：148



## 摘要
本文使用纯 Python 和 PyTorch 对比实现门控循环单元GRU及其反向传播.
## 相关
*原理和详细解释, 请参考: :*
门控循环单元GRUCell详解及反向传播的梯度求导
*文章索引 :*
[https://blog.csdn.net/oBrightLamp/article/details/85067981](https://blog.csdn.net/oBrightLamp/article/details/85067981)
## 正文
### 1. GRUCell 类
文件目录 : vanilla_nn/grucell.py
```python
import
```
```python
numpy
```
```python
as
```
```python
np
```
```python
def
```
```python
sigmoid
```
```python
(
```
```python
x
```
```python
)
```
```python
:
```
```python
return
```
```python
1
```
```python
/
```
```python
(
```
```python
1
```
```python
+
```
```python
np
```
```python
.
```
```python
exp
```
```python
(
```
```python
-
```
```python
x
```
```python
)
```
```python
)
```
```python
class
```
```python
GRUCell
```
```python
:
```
```python
def
```
```python
__init__
```
```python
(
```
```python
self
```
```python
,
```
```python
weight_ih
```
```python
,
```
```python
weight_hh
```
```python
,
```
```python
bias_ih
```
```python
,
```
```python
bias_hh
```
```python
)
```
```python
:
```
```python
self
```
```python
.
```
```python
weight_ih
```
```python
=
```
```python
weight_ih
        self
```
```python
.
```
```python
weight_hh
```
```python
=
```
```python
weight_hh
        self
```
```python
.
```
```python
bias_ih
```
```python
=
```
```python
bias_ih
        self
```
```python
.
```
```python
bias_hh
```
```python
=
```
```python
bias_hh
        self
```
```python
.
```
```python
dh_prev
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
weight_ih_grad_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
weight_hh_grad_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
bias_ih_grad_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
bias_hh_grad_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
x_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
dx_list
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
h_prev_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
h_next_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
dh_prev_list
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
reset_gate_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
update_gate_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
cell_gate_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
def
```
```python
__call__
```
```python
(
```
```python
self
```
```python
,
```
```python
x
```
```python
,
```
```python
h_prev
```
```python
)
```
```python
:
```
```python
xw_vector
```
```python
=
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
x
```
```python
,
```
```python
self
```
```python
.
```
```python
weight_ih
```
```python
.
```
```python
T
```
```python
)
```
```python
+
```
```python
self
```
```python
.
```
```python
bias_ih
        hv_vector
```
```python
=
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
h_prev
```
```python
,
```
```python
self
```
```python
.
```
```python
weight_hh
```
```python
.
```
```python
T
```
```python
)
```
```python
+
```
```python
self
```
```python
.
```
```python
bias_hh
        h_size
```
```python
=
```
```python
np
```
```python
.
```
```python
shape
```
```python
(
```
```python
h_prev
```
```python
)
```
```python
[
```
```python
1
```
```python
]
```
```python
reset_gate
```
```python
=
```
```python
sigmoid
```
```python
(
```
```python
xw_vector
```
```python
[
```
```python
:
```
```python
,
```
```python
h_size
```
```python
*
```
```python
0
```
```python
:
```
```python
h_size
```
```python
*
```
```python
1
```
```python
]
```
```python
+
```
```python
hv_vector
```
```python
[
```
```python
:
```
```python
,
```
```python
h_size
```
```python
*
```
```python
0
```
```python
:
```
```python
h_size
```
```python
*
```
```python
1
```
```python
]
```
```python
)
```
```python
update_gate
```
```python
=
```
```python
sigmoid
```
```python
(
```
```python
xw_vector
```
```python
[
```
```python
:
```
```python
,
```
```python
h_size
```
```python
*
```
```python
1
```
```python
:
```
```python
h_size
```
```python
*
```
```python
2
```
```python
]
```
```python
+
```
```python
hv_vector
```
```python
[
```
```python
:
```
```python
,
```
```python
h_size
```
```python
*
```
```python
1
```
```python
:
```
```python
h_size
```
```python
*
```
```python
2
```
```python
]
```
```python
)
```
```python
cell_gate
```
```python
=
```
```python
np
```
```python
.
```
```python
tanh
```
```python
(
```
```python
xw_vector
```
```python
[
```
```python
:
```
```python
,
```
```python
h_size
```
```python
*
```
```python
2
```
```python
:
```
```python
]
```
```python
+
```
```python
hv_vector
```
```python
[
```
```python
:
```
```python
,
```
```python
h_size
```
```python
*
```
```python
2
```
```python
:
```
```python
]
```
```python
*
```
```python
reset_gate
```
```python
)
```
```python
h_next
```
```python
=
```
```python
(
```
```python
1
```
```python
-
```
```python
update_gate
```
```python
)
```
```python
*
```
```python
cell_gate
```
```python
+
```
```python
update_gate
```
```python
*
```
```python
h_prev
        self
```
```python
.
```
```python
x_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
x
```
```python
)
```
```python
self
```
```python
.
```
```python
reset_gate_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
reset_gate
```
```python
)
```
```python
self
```
```python
.
```
```python
update_gate_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
update_gate
```
```python
)
```
```python
self
```
```python
.
```
```python
cell_gate_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
cell_gate
```
```python
)
```
```python
self
```
```python
.
```
```python
h_prev_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
h_prev
```
```python
)
```
```python
self
```
```python
.
```
```python
h_next_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
h_next
```
```python
)
```
```python
self
```
```python
.
```
```python
dh_prev
```
```python
=
```
```python
np
```
```python
.
```
```python
zeros_like
```
```python
(
```
```python
h_next
```
```python
)
```
```python
return
```
```python
h_next
```
```python
def
```
```python
backward
```
```python
(
```
```python
self
```
```python
,
```
```python
dh_next
```
```python
)
```
```python
:
```
```python
x
```
```python
=
```
```python
self
```
```python
.
```
```python
x_stack
```
```python
.
```
```python
pop
```
```python
(
```
```python
)
```
```python
h_prev
```
```python
=
```
```python
self
```
```python
.
```
```python
h_prev_stack
```
```python
.
```
```python
pop
```
```python
(
```
```python
)
```
```python
reset_gate
```
```python
=
```
```python
self
```
```python
.
```
```python
reset_gate_stack
```
```python
.
```
```python
pop
```
```python
(
```
```python
)
```
```python
update_gate
```
```python
=
```
```python
self
```
```python
.
```
```python
update_gate_stack
```
```python
.
```
```python
pop
```
```python
(
```
```python
)
```
```python
cell_gate
```
```python
=
```
```python
self
```
```python
.
```
```python
cell_gate_stack
```
```python
.
```
```python
pop
```
```python
(
```
```python
)
```
```python
h_size
```
```python
=
```
```python
np
```
```python
.
```
```python
shape
```
```python
(
```
```python
dh_next
```
```python
)
```
```python
[
```
```python
1
```
```python
]
```
```python
wr
```
```python
=
```
```python
self
```
```python
.
```
```python
weight_ih
```
```python
[
```
```python
h_size
```
```python
*
```
```python
0
```
```python
:
```
```python
h_size
```
```python
*
```
```python
1
```
```python
,
```
```python
:
```
```python
]
```
```python
wu
```
```python
=
```
```python
self
```
```python
.
```
```python
weight_ih
```
```python
[
```
```python
h_size
```
```python
*
```
```python
1
```
```python
:
```
```python
h_size
```
```python
*
```
```python
2
```
```python
,
```
```python
:
```
```python
]
```
```python
wc
```
```python
=
```
```python
self
```
```python
.
```
```python
weight_ih
```
```python
[
```
```python
h_size
```
```python
*
```
```python
2
```
```python
:
```
```python
,
```
```python
:
```
```python
]
```
```python
vr
```
```python
=
```
```python
self
```
```python
.
```
```python
weight_hh
```
```python
[
```
```python
h_size
```
```python
*
```
```python
0
```
```python
:
```
```python
h_size
```
```python
*
```
```python
1
```
```python
,
```
```python
:
```
```python
]
```
```python
vu
```
```python
=
```
```python
self
```
```python
.
```
```python
weight_hh
```
```python
[
```
```python
h_size
```
```python
*
```
```python
1
```
```python
:
```
```python
h_size
```
```python
*
```
```python
2
```
```python
,
```
```python
:
```
```python
]
```
```python
vc
```
```python
=
```
```python
self
```
```python
.
```
```python
weight_hh
```
```python
[
```
```python
h_size
```
```python
*
```
```python
2
```
```python
:
```
```python
,
```
```python
:
```
```python
]
```
```python
bc
```
```python
=
```
```python
self
```
```python
.
```
```python
bias_hh
```
```python
[
```
```python
h_size
```
```python
*
```
```python
2
```
```python
:
```
```python
]
```
```python
dh
```
```python
=
```
```python
dh_next
```
```python
+
```
```python
self
```
```python
.
```
```python
dh_prev
        d_update_gate
```
```python
=
```
```python
dh
```
```python
*
```
```python
(
```
```python
h_prev
```
```python
-
```
```python
cell_gate
```
```python
)
```
```python
d_cell_gate
```
```python
=
```
```python
dh
```
```python
*
```
```python
(
```
```python
1
```
```python
-
```
```python
update_gate
```
```python
)
```
```python
d_au
```
```python
=
```
```python
d_update_gate
```
```python
*
```
```python
update_gate
```
```python
*
```
```python
(
```
```python
1
```
```python
-
```
```python
update_gate
```
```python
)
```
```python
d_ac
```
```python
=
```
```python
d_cell_gate
```
```python
*
```
```python
(
```
```python
1
```
```python
-
```
```python
np
```
```python
.
```
```python
square
```
```python
(
```
```python
cell_gate
```
```python
)
```
```python
)
```
```python
d_reset_gate
```
```python
=
```
```python
d_ac
```
```python
*
```
```python
(
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
h_prev
```
```python
,
```
```python
vc
```
```python
.
```
```python
T
```
```python
)
```
```python
+
```
```python
bc
```
```python
)
```
```python
d_ar
```
```python
=
```
```python
d_reset_gate
```
```python
*
```
```python
reset_gate
```
```python
*
```
```python
(
```
```python
1
```
```python
-
```
```python
reset_gate
```
```python
)
```
```python
dh_prev
```
```python
=
```
```python
dh
```
```python
*
```
```python
update_gate
```
```python
+
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
d_ar
```
```python
,
```
```python
vr
```
```python
)
```
```python
dh_prev
```
```python
+=
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
d_au
```
```python
,
```
```python
vu
```
```python
)
```
```python
+
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
d_ac
```
```python
*
```
```python
reset_gate
```
```python
,
```
```python
vc
```
```python
)
```
```python
self
```
```python
.
```
```python
dh_prev_list
```
```python
.
```
```python
insert
```
```python
(
```
```python
0
```
```python
,
```
```python
dh_prev
```
```python
)
```
```python
self
```
```python
.
```
```python
dh_prev
```
```python
=
```
```python
dh_prev
        dx
```
```python
=
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
d_ar
```
```python
,
```
```python
wr
```
```python
)
```
```python
+
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
d_au
```
```python
,
```
```python
wu
```
```python
)
```
```python
+
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
d_ac
```
```python
,
```
```python
wc
```
```python
)
```
```python
self
```
```python
.
```
```python
dx_list
```
```python
.
```
```python
insert
```
```python
(
```
```python
0
```
```python
,
```
```python
dx
```
```python
)
```
```python
dw
```
```python
=
```
```python
np
```
```python
.
```
```python
vstack
```
```python
(
```
```python
[
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
d_ar
```
```python
.
```
```python
T
```
```python
,
```
```python
x
```
```python
)
```
```python
,
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
d_au
```
```python
.
```
```python
T
```
```python
,
```
```python
x
```
```python
)
```
```python
,
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
d_ac
```
```python
.
```
```python
T
```
```python
,
```
```python
x
```
```python
)
```
```python
]
```
```python
)
```
```python
self
```
```python
.
```
```python
weight_ih_grad_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
dw
```
```python
)
```
```python
dv
```
```python
=
```
```python
np
```
```python
.
```
```python
vstack
```
```python
(
```
```python
[
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
d_ar
```
```python
.
```
```python
T
```
```python
,
```
```python
h_prev
```
```python
)
```
```python
,
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
d_au
```
```python
.
```
```python
T
```
```python
,
```
```python
h_prev
```
```python
)
```
```python
,
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
(
```
```python
d_ac
```
```python
*
```
```python
reset_gate
```
```python
)
```
```python
.
```
```python
T
```
```python
,
```
```python
h_prev
```
```python
)
```
```python
]
```
```python
)
```
```python
self
```
```python
.
```
```python
weight_hh_grad_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
dv
```
```python
)
```
```python
self
```
```python
.
```
```python
bias_ih_grad_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
np
```
```python
.
```
```python
hstack
```
```python
(
```
```python
[
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
d_ar
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
d_au
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
d_ac
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
]
```
```python
)
```
```python
)
```
```python
self
```
```python
.
```
```python
bias_hh_grad_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
np
```
```python
.
```
```python
hstack
```
```python
(
```
```python
[
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
d_ar
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
d_au
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
d_ac
```
```python
*
```
```python
reset_gate
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
]
```
```python
)
```
```python
)
```
```python
return
```
```python
dh_prev
```
### 2. GRUCell 测试
```python
import
```
```python
torch
```
```python
import
```
```python
numpy
```
```python
as
```
```python
np
```
```python
from
```
```python
vanilla_nn
```
```python
.
```
```python
grucell
```
```python
import
```
```python
GRUCell
np
```
```python
.
```
```python
random
```
```python
.
```
```python
seed
```
```python
(
```
```python
123
```
```python
)
```
```python
torch
```
```python
.
```
```python
random
```
```python
.
```
```python
manual_seed
```
```python
(
```
```python
123
```
```python
)
```
```python
np
```
```python
.
```
```python
set_printoptions
```
```python
(
```
```python
precision
```
```python
=
```
```python
6
```
```python
,
```
```python
suppress
```
```python
=
```
```python
True
```
```python
,
```
```python
linewidth
```
```python
=
```
```python
80
```
```python
)
```
```python
grucell_torch
```
```python
=
```
```python
torch
```
```python
.
```
```python
nn
```
```python
.
```
```python
GRUCell
```
```python
(
```
```python
3
```
```python
,
```
```python
4
```
```python
)
```
```python
.
```
```python
double
```
```python
(
```
```python
)
```
```python
grucell_numpy
```
```python
=
```
```python
GRUCell
```
```python
(
```
```python
grucell_torch
```
```python
.
```
```python
weight_ih
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
,
```
```python
grucell_torch
```
```python
.
```
```python
weight_hh
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
,
```
```python
grucell_torch
```
```python
.
```
```python
bias_ih
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
,
```
```python
grucell_torch
```
```python
.
```
```python
bias_hh
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
x_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
2
```
```python
,
```
```python
3
```
```python
)
```
```python
)
```
```python
x_torch
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
x_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
h_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
2
```
```python
,
```
```python
4
```
```python
)
```
```python
)
```
```python
h_torch
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
h_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
next_h_numpy
```
```python
=
```
```python
grucell_numpy
```
```python
(
```
```python
x_numpy
```
```python
,
```
```python
h_numpy
```
```python
)
```
```python
next_h_torch
```
```python
=
```
```python
grucell_torch
```
```python
(
```
```python
x_torch
```
```python
,
```
```python
h_torch
```
```python
)
```
```python
dh_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
2
```
```python
,
```
```python
4
```
```python
)
```
```python
)
```
```python
dh_torch
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
dh_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
dh_numpy
```
```python
=
```
```python
grucell_numpy
```
```python
.
```
```python
backward
```
```python
(
```
```python
dh_numpy
```
```python
)
```
```python
next_h_torch
```
```python
.
```
```python
backward
```
```python
(
```
```python
dh_torch
```
```python
)
```
```python
print
```
```python
(
```
```python
"--- 代码输出 ---"
```
```python
)
```
```python
print
```
```python
(
```
```python
"out_numpy :\n"
```
```python
,
```
```python
next_h_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
"out_torch :\n"
```
```python
,
```
```python
next_h_torch
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"---------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"dh_numpy :\n"
```
```python
,
```
```python
dh_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
"dh_torch :\n"
```
```python
,
```
```python
h_torch
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"---------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"dx_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
array
```
```python
(
```
```python
grucell_numpy
```
```python
.
```
```python
dx_list
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"dx_torch :\n"
```
```python
,
```
```python
x_torch
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"---------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"w_ih_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
grucell_numpy
```
```python
.
```
```python
weight_ih_grad_stack
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"w_ih_torch :\n"
```
```python
,
```
```python
grucell_torch
```
```python
.
```
```python
weight_ih
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"---------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"w_hh_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
grucell_numpy
```
```python
.
```
```python
weight_hh_grad_stack
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"w_hh_torch :\n"
```
```python
,
```
```python
grucell_torch
```
```python
.
```
```python
weight_hh
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"---------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"b_ih_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
grucell_numpy
```
```python
.
```
```python
bias_ih_grad_stack
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"b_ih_torch :\n"
```
```python
,
```
```python
grucell_torch
```
```python
.
```
```python
bias_ih
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"---------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"b_hh_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
grucell_numpy
```
```python
.
```
```python
bias_hh_grad_stack
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"b_hh_torch :\n"
```
```python
,
```
```python
grucell_torch
```
```python
.
```
```python
bias_hh
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
"""
--- 代码输出 ---
out_numpy :
 [[ 0.537654  0.419409  0.334602  0.552652]
 [ 0.23298   0.546675  0.322881  0.331436]]
out_torch :
 [[ 0.537654  0.419409  0.334602  0.552652]
 [ 0.23298   0.546675  0.322881  0.331436]]
---------
dh_numpy :
 [[ 0.134685  0.262583  0.150232  0.011796]
 [ 0.29401   0.209619  0.38664   0.512479]]
dh_torch :
 [[ 0.134685  0.262583  0.150232  0.011796]
 [ 0.29401   0.209619  0.38664   0.512479]]
---------
dx_numpy :
 [[[ 0.100331  0.206714 -0.235714]
  [ 0.172891  0.255504 -0.155857]]]
dx_torch :
 [[ 0.100331  0.206714 -0.235714]
 [ 0.172891  0.255504 -0.155857]]
---------
w_ih_numpy :
 [[ 0.000184  0.002742  0.001377]
 [-0.063094 -0.039634 -0.027325]
 [-0.009026 -0.012194 -0.007132]
 [ 0.015227  0.016667  0.010103]
 [ 0.087729  0.052286  0.036599]
 [ 0.076196  0.052676  0.035376]
 [ 0.027772  0.029146  0.017808]
 [-0.084754 -0.101578 -0.060585]
 [ 0.247172  0.215229  0.136668]
 [ 0.432748  0.299664  0.20116 ]
 [ 0.239466  0.250673  0.153232]
 [ 0.122349  0.134346  0.081388]]
w_ih_torch :
 [[ 0.000184  0.002742  0.001377]
 [-0.063094 -0.039634 -0.027325]
 [-0.009026 -0.012194 -0.007132]
 [ 0.015227  0.016667  0.010103]
 [ 0.087729  0.052286  0.036599]
 [ 0.076196  0.052676  0.035376]
 [ 0.027772  0.029146  0.017808]
 [-0.084754 -0.101578 -0.060585]
 [ 0.247172  0.215229  0.136668]
 [ 0.432748  0.299664  0.20116 ]
 [ 0.239466  0.250673  0.153232]
 [ 0.122349  0.134346  0.081388]]
---------
w_hh_numpy :
 [[-0.002084  0.001193  0.00044  -0.001252]
 [-0.076799 -0.06724  -0.045178 -0.028548]
 [-0.005254 -0.012093 -0.007229 -0.000766]
 [ 0.012294  0.018921  0.011737  0.003278]
 [ 0.109266  0.092423  0.062486  0.041131]
 [ 0.088518  0.083027  0.055124  0.032029]
 [ 0.023524  0.034034  0.02126   0.006616]
 [-0.060689 -0.108654 -0.066362 -0.013765]
 [ 0.089854  0.108185  0.069158  0.028726]
 [ 0.262026  0.239856  0.159908  0.095748]
 [ 0.078294  0.109812  0.068845  0.022568]
 [ 0.071772  0.108447  0.067409  0.019455]]
w_hh_torch :
 [[-0.002084  0.001193  0.00044  -0.001252]
 [-0.076799 -0.06724  -0.045178 -0.028548]
 [-0.005254 -0.012093 -0.007229 -0.000766]
 [ 0.012294  0.018921  0.011737  0.003278]
 [ 0.109266  0.092423  0.062486  0.041131]
 [ 0.088518  0.083027  0.055124  0.032029]
 [ 0.023524  0.034034  0.02126   0.006616]
 [-0.060689 -0.108654 -0.066362 -0.013765]
 [ 0.089854  0.108185  0.069158  0.028726]
 [ 0.262026  0.239856  0.159908  0.095748]
 [ 0.078294  0.109812  0.068845  0.022568]
 [ 0.071772  0.108447  0.067409  0.019455]]
---------
b_ih_numpy :
 [ 0.001392 -0.096389 -0.016547  0.026264  0.13283   0.118438  0.047374 -0.149915
  0.402955  0.672871  0.408214  0.211218]
b_ih_torch :
 [ 0.001392 -0.096389 -0.016547  0.026264  0.13283   0.118438  0.047374 -0.149915
  0.402955  0.672871  0.408214  0.211218]
---------
b_hh_numpy :
 [ 0.001392 -0.096389 -0.016547  0.026264  0.13283   0.118438  0.047374 -0.149915
  0.151978  0.342735  0.153074  0.15066 ]
b_hh_torch :
 [ 0.001392 -0.096389 -0.016547  0.026264  0.13283   0.118438  0.047374 -0.149915
  0.151978  0.342735  0.153074  0.15066 ]
"""
```
### 3. GRU 测试
```python
import
```
```python
torch
```
```python
import
```
```python
numpy
```
```python
as
```
```python
np
```
```python
from
```
```python
vanilla_nn
```
```python
.
```
```python
grucell
```
```python
import
```
```python
GRUCell
np
```
```python
.
```
```python
random
```
```python
.
```
```python
seed
```
```python
(
```
```python
123
```
```python
)
```
```python
torch
```
```python
.
```
```python
random
```
```python
.
```
```python
manual_seed
```
```python
(
```
```python
123
```
```python
)
```
```python
np
```
```python
.
```
```python
set_printoptions
```
```python
(
```
```python
precision
```
```python
=
```
```python
6
```
```python
,
```
```python
suppress
```
```python
=
```
```python
True
```
```python
,
```
```python
linewidth
```
```python
=
```
```python
80
```
```python
)
```
```python
gru_torch
```
```python
=
```
```python
torch
```
```python
.
```
```python
nn
```
```python
.
```
```python
GRU
```
```python
(
```
```python
4
```
```python
,
```
```python
5
```
```python
,
```
```python
1
```
```python
)
```
```python
.
```
```python
double
```
```python
(
```
```python
)
```
```python
gru_numpy
```
```python
=
```
```python
GRUCell
```
```python
(
```
```python
gru_torch
```
```python
.
```
```python
all_weights
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
0
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
,
```
```python
gru_torch
```
```python
.
```
```python
all_weights
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
1
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
,
```
```python
gru_torch
```
```python
.
```
```python
all_weights
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
2
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
,
```
```python
gru_torch
```
```python
.
```
```python
all_weights
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
3
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
x_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
3
```
```python
,
```
```python
3
```
```python
,
```
```python
4
```
```python
)
```
```python
)
```
```python
x_torch
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
x_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
h_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
1
```
```python
,
```
```python
3
```
```python
,
```
```python
5
```
```python
)
```
```python
)
```
```python
h_torch
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
h_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
dh_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
3
```
```python
,
```
```python
3
```
```python
,
```
```python
5
```
```python
)
```
```python
)
```
```python
dh_torch
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
dh_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
out_torch
```
```python
,
```
```python
hn_torch
```
```python
=
```
```python
gru_torch
```
```python
(
```
```python
x_torch
```
```python
,
```
```python
h_torch
```
```python
)
```
```python
out_torch
```
```python
.
```
```python
backward
```
```python
(
```
```python
dh_torch
```
```python
)
```
```python
h0_numpy
```
```python
=
```
```python
h_numpy
```
```python
[
```
```python
0
```
```python
]
```
```python
for
```
```python
i
```
```python
in
```
```python
range
```
```python
(
```
```python
3
```
```python
)
```
```python
:
```
```python
h0_numpy
```
```python
=
```
```python
gru_numpy
```
```python
(
```
```python
x_numpy
```
```python
[
```
```python
i
```
```python
]
```
```python
,
```
```python
h0_numpy
```
```python
)
```
```python
for
```
```python
i
```
```python
in
```
```python
reversed
```
```python
(
```
```python
range
```
```python
(
```
```python
3
```
```python
)
```
```python
)
```
```python
:
```
```python
gru_numpy
```
```python
.
```
```python
backward
```
```python
(
```
```python
dh_numpy
```
```python
[
```
```python
i
```
```python
]
```
```python
)
```
```python
print
```
```python
(
```
```python
"--- 代码输出 ---"
```
```python
)
```
```python
print
```
```python
(
```
```python
"out_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
array
```
```python
(
```
```python
gru_numpy
```
```python
.
```
```python
h_next_stack
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"out_torch :\n"
```
```python
,
```
```python
out_torch
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"--- 代码输出 ---"
```
```python
)
```
```python
print
```
```python
(
```
```python
"dx_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
array
```
```python
(
```
```python
gru_numpy
```
```python
.
```
```python
dx_list
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"dx_torch :\n"
```
```python
,
```
```python
x_torch
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"--- 代码输出 ---"
```
```python
)
```
```python
print
```
```python
(
```
```python
"dw_ih_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
gru_numpy
```
```python
.
```
```python
weight_ih_grad_stack
```
```python
,
```
```python
0
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"dw_ih_torch :\n"
```
```python
,
```
```python
gru_torch
```
```python
.
```
```python
all_weights
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
0
```
```python
]
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"--- 代码输出 ---"
```
```python
)
```
```python
print
```
```python
(
```
```python
"dw_hh_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
gru_numpy
```
```python
.
```
```python
weight_hh_grad_stack
```
```python
,
```
```python
0
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"dw_hh_torch :\n"
```
```python
,
```
```python
gru_torch
```
```python
.
```
```python
all_weights
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
1
```
```python
]
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"--- 代码输出 ---"
```
```python
)
```
```python
print
```
```python
(
```
```python
"db_ih_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
gru_numpy
```
```python
.
```
```python
bias_ih_grad_stack
```
```python
,
```
```python
0
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"db_ih_torch :\n"
```
```python
,
```
```python
gru_torch
```
```python
.
```
```python
all_weights
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
2
```
```python
]
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"--- 代码输出 ---"
```
```python
)
```
```python
print
```
```python
(
```
```python
"db_hh_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
gru_numpy
```
```python
.
```
```python
bias_hh_grad_stack
```
```python
,
```
```python
0
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"db_hh_torch :\n"
```
```python
,
```
```python
gru_torch
```
```python
.
```
```python
all_weights
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
3
```
```python
]
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
"""
--- 代码输出 ---
out_numpy :
 [[[ 0.307578  0.38917   0.868305  0.226222  0.190614]
  [ 0.073207  0.063558  0.439481  0.389793 -0.115967]
  [ 0.342953  0.445099  0.494275  0.18942  -0.11399 ]]
 [[ 0.262178  0.124979  0.753652 -0.024015 -0.082316]
  [ 0.053777 -0.031063  0.358107  0.072536 -0.212627]
  [ 0.208464  0.104906  0.509116  0.026988 -0.162194]]
 [[ 0.141425 -0.034831  0.656582 -0.071536 -0.178199]
  [-0.001007 -0.050403  0.306474 -0.05571  -0.174536]
  [ 0.096458 -0.031054  0.448428 -0.061591 -0.166288]]]
out_torch :
 [[[ 0.307578  0.38917   0.868305  0.226222  0.190614]
  [ 0.073207  0.063558  0.439481  0.389793 -0.115967]
  [ 0.342953  0.445099  0.494275  0.18942  -0.11399 ]]
 [[ 0.262178  0.124979  0.753652 -0.024015 -0.082316]
  [ 0.053777 -0.031063  0.358107  0.072536 -0.212627]
  [ 0.208464  0.104906  0.509116  0.026988 -0.162194]]
 [[ 0.141425 -0.034831  0.656582 -0.071536 -0.178199]
  [-0.001007 -0.050403  0.306474 -0.05571  -0.174536]
  [ 0.096458 -0.031054  0.448428 -0.061591 -0.166288]]]
--- 代码输出 ---
dx_numpy :
 [[[-0.099959  0.125734 -0.100467  0.057584]
  [-0.175371  0.278181 -0.08639  -0.081519]
  [ 0.05688   0.215838  0.006216 -0.02745 ]]
 [[-0.030292  0.117966 -0.023817 -0.078948]
  [-0.041677  0.158772  0.007034  0.036202]
  [-0.028633  0.213837  0.008546 -0.06969 ]]
 [[-0.077594  0.189323 -0.042506 -0.126031]
  [-0.021397  0.159047  0.027051 -0.110323]
  [ 0.014817  0.163531  0.020699 -0.00104 ]]]
dx_torch :
 [[[-0.099959  0.125734 -0.100467  0.057584]
  [-0.175371  0.278181 -0.08639  -0.081519]
  [ 0.05688   0.215838  0.006216 -0.02745 ]]
 [[-0.030292  0.117966 -0.023817 -0.078948]
  [-0.041677  0.158772  0.007034  0.036202]
  [-0.028633  0.213837  0.008546 -0.06969 ]]
 [[-0.077594  0.189323 -0.042506 -0.126031]
  [-0.021397  0.159047  0.027051 -0.110323]
  [ 0.014817  0.163531  0.020699 -0.00104 ]]]
--- 代码输出 ---
dw_ih_numpy :
 [[ 0.054313  0.040754  0.046713  0.056132]
 [ 0.143938  0.086123  0.133868  0.142727]
 [-0.012153 -0.020432 -0.025273 -0.01912 ]
 [ 0.250502  0.158463  0.181569  0.266292]
 [ 0.089863  0.081379  0.079555  0.086468]
 [ 0.380143  0.288339  0.288571  0.369766]
 [ 0.421876  0.260856  0.32739   0.447516]
 [ 0.095548  0.049706  0.056802  0.111859]
 [ 0.518252  0.359941  0.455362  0.608289]
 [ 0.466701  0.236542  0.426777  0.473724]
 [ 1.355748  1.005534  1.19756   1.463865]
 [ 1.438667  0.910484  1.333382  1.454368]
 [ 0.813703  0.66155   0.821699  0.913758]
 [ 1.679467  1.182209  1.29286   1.748798]
 [ 1.473526  1.200475  1.428137  1.480017]]
dw_ih_torch :
 [[ 0.054313  0.040754  0.046713  0.056132]
 [ 0.143938  0.086123  0.133868  0.142727]
 [-0.012153 -0.020432 -0.025273 -0.01912 ]
 [ 0.250502  0.158463  0.181569  0.266292]
 [ 0.089863  0.081379  0.079555  0.086468]
 [ 0.380143  0.288339  0.288571  0.369766]
 [ 0.421876  0.260856  0.32739   0.447516]
 [ 0.095548  0.049706  0.056802  0.111859]
 [ 0.518252  0.359941  0.455362  0.608289]
 [ 0.466701  0.236542  0.426777  0.473724]
 [ 1.355748  1.005534  1.19756   1.463865]
 [ 1.438667  0.910484  1.333382  1.454368]
 [ 0.813703  0.66155   0.821699  0.913758]
 [ 1.679467  1.182209  1.29286   1.748798]
 [ 1.473526  1.200475  1.428137  1.480017]]
--- 代码输出 ---
dw_hh_numpy :
 [[ 0.029407  0.040854  0.067315  0.028967  0.006582]
 [ 0.065199  0.106626  0.161274  0.110149  0.040565]
 [-0.00217   0.002182 -0.009461 -0.011639  0.012655]
 [ 0.154114  0.269694  0.300844  0.181655  0.08886 ]
 [ 0.041277  0.04673   0.102476  0.038294 -0.006607]
 [ 0.22554   0.374378  0.425336  0.237448  0.09482 ]
 [ 0.251627  0.479232  0.472401  0.366764  0.17784 ]
 [ 0.066873  0.099892  0.162182  0.052397  0.031526]
 [ 0.313399  0.564707  0.579177  0.443881  0.153558]
 [ 0.212389  0.407104  0.504583  0.422809  0.217823]
 [ 0.224363  0.357882  0.464804  0.271478  0.07211 ]
 [ 0.242434  0.376752  0.565195  0.340365  0.105577]
 [ 0.20171   0.312777  0.443363  0.292979  0.040601]
 [ 0.442316  0.728961  0.869799  0.489859  0.181804]
 [ 0.333121  0.456453  0.815045  0.469363  0.037041]]
dw_hh_torch :
 [[ 0.029407  0.040854  0.067315  0.028967  0.006582]
 [ 0.065199  0.106626  0.161274  0.110149  0.040565]
 [-0.00217   0.002182 -0.009461 -0.011639  0.012655]
 [ 0.154114  0.269694  0.300844  0.181655  0.08886 ]
 [ 0.041277  0.04673   0.102476  0.038294 -0.006607]
 [ 0.22554   0.374378  0.425336  0.237448  0.09482 ]
 [ 0.251627  0.479232  0.472401  0.366764  0.17784 ]
 [ 0.066873  0.099892  0.162182  0.052397  0.031526]
 [ 0.313399  0.564707  0.579177  0.443881  0.153558]
 [ 0.212389  0.407104  0.504583  0.422809  0.217823]
 [ 0.224363  0.357882  0.464804  0.271478  0.07211 ]
 [ 0.242434  0.376752  0.565195  0.340365  0.105577]
 [ 0.20171   0.312777  0.443363  0.292979  0.040601]
 [ 0.442316  0.728961  0.869799  0.489859  0.181804]
 [ 0.333121  0.456453  0.815045  0.469363  0.037041]]
--- 代码输出 ---
db_ih_numpy :
 [ 0.106404  0.257179 -0.039206  0.442932  0.181347  0.660625  0.72062   0.218483
  0.946051  0.759723  2.604006  2.604498  1.66155   3.041845  2.817076]
db_ih_torch :
 [ 0.106404  0.257179 -0.039206  0.442932  0.181347  0.660625  0.72062   0.218483
  0.946051  0.759723  2.604006  2.604498  1.66155   3.041845  2.817076]
--- 代码输出 ---
db_hh_numpy :
 [ 0.106404  0.257179 -0.039206  0.442932  0.181347  0.660625  0.72062   0.218483
  0.946051  0.759723  0.763548  0.904376  0.79913   1.342985  1.467562]
db_hh_torch :
 [ 0.106404  0.257179 -0.039206  0.442932  0.181347  0.660625  0.72062   0.218483
  0.946051  0.759723  0.763548  0.904376  0.79913   1.342985  1.467562]
"""
```

