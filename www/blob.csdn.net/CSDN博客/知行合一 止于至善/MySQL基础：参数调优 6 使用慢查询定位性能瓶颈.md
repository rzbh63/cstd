
# MySQL基础：参数调优:6:使用慢查询定位性能瓶颈 - 知行合一 止于至善 - CSDN博客

2019年03月21日 05:34:35[liumiaocn](https://me.csdn.net/liumiaocn)阅读数：62标签：[mysql																](https://so.csdn.net/so/search/s.do?q=mysql&t=blog)[慢查询																](https://so.csdn.net/so/search/s.do?q=慢查询&t=blog)[设定方式																](https://so.csdn.net/so/search/s.do?q=设定方式&t=blog)[slow_query_log																](https://so.csdn.net/so/search/s.do?q=slow_query_log&t=blog)[调优																](https://so.csdn.net/so/search/s.do?q=调优&t=blog)[
							](https://so.csdn.net/so/search/s.do?q=slow_query_log&t=blog)[
																					](https://so.csdn.net/so/search/s.do?q=设定方式&t=blog)个人分类：[数据库																](https://blog.csdn.net/liumiaocn/article/category/6328292)
[
																								](https://so.csdn.net/so/search/s.do?q=设定方式&t=blog)
[
				](https://so.csdn.net/so/search/s.do?q=慢查询&t=blog)
[
			](https://so.csdn.net/so/search/s.do?q=慢查询&t=blog)
[
		](https://so.csdn.net/so/search/s.do?q=mysql&t=blog)

MySQL提供了慢查询可以快速定位性能瓶颈，这篇文章通过具体的示例来介绍一下如何设定方法。
# 基础知识
慢查询是MySQL的一种基本日志，详细信息可参看。
[https://blog.csdn.net/liumiaocn/article/details/88524180](https://blog.csdn.net/liumiaocn/article/details/88524180)
# 使用示例
接下来在一个具体的调优示例中展示一下如何使用慢查询
## 确认慢查询状态
可以看到缺省状态下，慢查询是关闭的状态。
```python
mysql
```
```python
>
```
```python
show
```
```python
variables
```
```python
like
```
```python
'slow_query_log'
```
```python
;
```
```python
+
```
```python
----------------+-------+
```
```python
|
```
```python
Variable_name
```
```python
|
```
```python
Value
```
```python
|
```
```python
+
```
```python
----------------+-------+
```
```python
|
```
```python
slow_query_log
```
```python
|
```
```python
OFF
```
```python
|
```
```python
+
```
```python
----------------+-------+
```
```python
1
```
```python
row
```
```python
in
```
```python
set
```
```python
(
```
```python
0.01
```
```python
sec
```
```python
)
```
```python
mysql
```
```python
>
```
## 打开慢查询
通过执行set global slow_query_log=1则打开了慢查询日志
```python
mysql
```
```python
>
```
```python
set
```
```python
global
```
```python
slow_query_log
```
```python
=
```
```python
1
```
```python
;
```
```python
Query OK
```
```python
,
```
```python
0
```
```python
rows
```
```python
affected
```
```python
(
```
```python
0.02
```
```python
sec
```
```python
)
```
```python
mysql
```
```python
>
```
```python
show
```
```python
variables
```
```python
like
```
```python
'slow_query_log'
```
```python
;
```
```python
+
```
```python
----------------+-------+
```
```python
|
```
```python
Variable_name
```
```python
|
```
```python
Value
```
```python
|
```
```python
+
```
```python
----------------+-------+
```
```python
|
```
```python
slow_query_log
```
```python
|
```
```python
ON
```
```python
|
```
```python
+
```
```python
----------------+-------+
```
```python
1
```
```python
row
```
```python
in
```
```python
set
```
```python
(
```
```python
0.01
```
```python
sec
```
```python
)
```
```python
mysql
```
```python
>
```
而查询日志的详细信息保存在slow_query_log_file所设定的文件里
```python
mysql
```
```python
>
```
```python
show
```
```python
variables
```
```python
like
```
```python
'slow_query_log_file'
```
```python
;
```
```python
+
```
```python
---------------------+--------------------------------------+
```
```python
|
```
```python
Variable_name
```
```python
|
```
```python
Value
```
```python
|
```
```python
+
```
```python
---------------------+--------------------------------------+
```
```python
|
```
```python
slow_query_log_file
```
```python
|
```
```python
/
```
```python
var
```
```python
/
```
```python
lib
```
```python
/
```
```python
mysql
```
```python
/
```
```python
6436
```
```python
efce6f31
```
```python
-
```
```python
slow
```
```python
.
```
```python
log
```
```python
|
```
```python
+
```
```python
---------------------+--------------------------------------+
```
```python
1
```
```python
row
```
```python
in
```
```python
set
```
```python
(
```
```python
0.00
```
```python
sec
```
```python
)
```
```python
mysql
```
```python
>
```
此文件缺省状况下会放到mysql数据目录下，名称为hostname-slow.log，由于本文示例的mysql在容器中运行，所以显示的日志名称为6436efce6f31-slow.log，此时刚刚打开，可以确认已经生成了如下内容：
```python
# cat /var/lib/mysql/6436efce6f31-slow.log
```
```python
mysqld, Version: 5.7.16
```
```python
(
```
```python
MySQL Community Server
```
```python
(
```
```python
GPL
```
```python
))
```
```python
. started with:
Tcp port: 3306  Unix socket: /var/run/mysqld/mysqld.sock
Time                 Id Command    Argument
```
```python
#
```
## 设定阈值
从生成的慢查询日志并未看到有用的信息，慢查询的定义，多慢算慢，则是通过long_query_time来确认的，该值的单位为秒。
```python
mysql
```
```python
>
```
```python
show
```
```python
variables
```
```python
like
```
```python
'long_query_time'
```
```python
;
```
```python
+
```
```python
-----------------+-----------+
```
```python
|
```
```python
Variable_name
```
```python
|
```
```python
Value
```
```python
|
```
```python
+
```
```python
-----------------+-----------+
```
```python
|
```
```python
long_query_time
```
```python
|
```
```python
10.000000
```
```python
|
```
```python
+
```
```python
-----------------+-----------+
```
```python
1
```
```python
row
```
```python
in
```
```python
set
```
```python
(
```
```python
0.01
```
```python
sec
```
```python
)
```
```python
mysql
```
```python
>
```
由于缺省值设定为10秒，对于数据库操作超过10秒的非常之少，所以没有看到有用的信息，接下来我们将此值设定为200毫秒，即0.2
```python
mysql
```
```python
>
```
```python
set
```
```python
global
```
```python
long_query_time
```
```python
=
```
```python
0.2
```
```python
;
```
```python
Query OK
```
```python
,
```
```python
0
```
```python
rows
```
```python
affected
```
```python
(
```
```python
0.00
```
```python
sec
```
```python
)
```
```python
mysql
```
```python
>
```
退出当前的mysql终端，重新进入并确认，发现已经生效
```python
mysql
```
```python
>
```
```python
show
```
```python
variables
```
```python
like
```
```python
'long_query_time'
```
```python
;
```
```python
+
```
```python
-----------------+----------+
```
```python
|
```
```python
Variable_name
```
```python
|
```
```python
Value
```
```python
|
```
```python
+
```
```python
-----------------+----------+
```
```python
|
```
```python
long_query_time
```
```python
|
```
```python
0.200000
```
```python
|
```
```python
+
```
```python
-----------------+----------+
```
```python
1
```
```python
row
```
```python
in
```
```python
set
```
```python
(
```
```python
0.00
```
```python
sec
```
```python
)
```
```python
mysql
```
```python
>
```
# 设定建议
修改配置文件
> 为了能够持久化的保持，而不至于重启或者容器重新生成后恢复默认状态，需要设定到配置文件中。

> 官方的mysql镜像配置文件：/etc/mysql/mysql.conf.d/mysqld.cnf
建议设定示例（数据库操作超过100毫秒认为是慢查询，可根据需要进行设定，如果过多，可逐步设定，比如先行设定为2秒，逐渐降低来确认瓶颈所在）
```python
# slow query setting
```
```python
slow_query_log
```
```python
=
```
```python
1
long_query_time
```
```python
=
```
```python
0.1
```

