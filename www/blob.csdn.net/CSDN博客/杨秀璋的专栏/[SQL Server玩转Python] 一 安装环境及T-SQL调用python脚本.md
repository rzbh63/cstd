
# [SQL Server玩转Python] 一.安装环境及T-SQL调用python脚本 - 杨秀璋的专栏 - CSDN博客

2018年11月11日 23:41:41[Eastmount](https://me.csdn.net/Eastmount)阅读数：1040所属专栏：[知识图谱、web数据挖掘及NLP](https://blog.csdn.net/column/details/eastmount-kgdmnlp.html)



在开发项目过程中，更多的是通过Python访问SQL Server数据库接口，进行数据挖掘的操作；而SQL Server2016版本之后，嵌入了强大的R、Python、Machine Learning等功能，尤其是Python代码置于存储过程中，可以实现一些便捷数据分析功能。
本系列文章主要讲解SQL Server 2017实现Python数据分析的文章，同时对比两者的优劣。第一篇文章主要讲解SQL Server开发Python环境的安装过程及基本的数据分析代码实现。基础性文章，自己也在不断学习中，希望对你有所帮助。
PS：2019年1~2月作者参加了CSDN2018年博客评选，希望您能投出宝贵的一票。我是59号，Eastmount，杨秀璋。投票地址：[https://bss.csdn.net/m/topic/blog_star2018/index](https://bss.csdn.net/m/topic/blog_star2018/index)
![](https://img-blog.csdnimg.cn/20190104155648543.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)[
](https://img-blog.csdnimg.cn/20190104155648543.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)五年来写了314篇博客，12个专栏，是真的热爱分享，热爱CSDN这个平台，也想帮助更多的人，专栏包括Python、数据挖掘、网络爬虫、图像处理、C\#、Android等。现在也当了两年老师，更是觉得有义务教好每一个学生，让贵州学子好好写点代码，学点技术，"师者，传到授业解惑也"，提前祝大家新年快乐。2019我们携手共进，为爱而生。
---

# 一. 安装SQL Server
**(一) 安装SQL Server 2017**
本文安装的软件为：cn_sql_server_2017_developer_x64_dvd_11296175.iso
下载地址：
1.选择“全新 SQL Server 独立安装或向现有安装添加功能”。
![](https://img-blog.csdnimg.cn/20181111222434667.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)[
](https://img-blog.csdnimg.cn/20181111222434667.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)2.安装所需功能，注意机器学习服务、R、Python均需要安装。
![](https://img-blog.csdnimg.cn/20181111222750951.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)[
](https://img-blog.csdnimg.cn/20181111222750951.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)3.选择默认实例“MSSQLSERVER”。
![](https://img-blog.csdnimg.cn/20181111222919573.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)[
](https://img-blog.csdnimg.cn/20181111222919573.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)4.选择混合性模型，包括SQL Server身份验证（sa）和Windows身份验证，同时添加当前用户。
![](https://img-blog.csdnimg.cn/20181111223344245.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)[
](https://img-blog.csdnimg.cn/20181111223344245.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)5.安装。
![](https://img-blog.csdnimg.cn/20181111223514392.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)[
](https://img-blog.csdnimg.cn/20181111223514392.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)安装成功之后，你会发现仍然不能编写SQL Server代码，这是因为还需要安装SQL Server管理工具。
**(二) 安装SQL Server Management Studio**
微软官方下载地址：[https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-2017](https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-2017)
作者上传下载地址：
安装过程如下图所示。
![](https://img-blog.csdnimg.cn/2018111122414899.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)[
	](https://img-blog.csdnimg.cn/2018111122414899.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)![](https://img-blog.csdnimg.cn/20181111224247788.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)[
](https://img-blog.csdnimg.cn/20181111224247788.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)[
](https://img-blog.csdnimg.cn/2018111122414899.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)安装成功之后即可使用SQL Server编写代码了。
[
](https://img-blog.csdnimg.cn/2018111122414899.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)![](https://img-blog.csdnimg.cn/20181111224259117.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)[
](https://img-blog.csdnimg.cn/20181111224259117.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)
---

# 二. 配置Python和R开发环境
安装成功之后我们新建一个数据库test01，可以发现SQL语句可以编写，但编写Python或R代码仍然会报错。
推荐文章：
[https://docs.microsoft.com/zh-tw/sql/advanced-analytics/tutorials/run-python-using-t-sql?view=sql-server-2017](https://docs.microsoft.com/zh-tw/sql/advanced-analytics/tutorials/run-python-using-t-sql?view=sql-server-2017)
解决方法：
[http://www.cnblogs.com/OpenCoder/p/7090370.html](http://www.cnblogs.com/OpenCoder/p/7090370.html)
[http://www.kodyaz.com/t-sql/enable-external-script-on-sql-server-for-r-python.aspx](http://www.kodyaz.com/t-sql/enable-external-script-on-sql-server-for-r-python.aspx)
![](https://img-blog.csdnimg.cn/20181111224854759.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)[
](https://img-blog.csdnimg.cn/20181111224854759.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)1.查看Python是否已经启用，查看SQL Server环境下是否有Python可执行文件。如：C:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\PYTHON_SERVICES。
注意，Scripts文件夹下可以通过pip安装其他Python库。
![](https://img-blog.csdnimg.cn/20181111225408494.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)[
](https://img-blog.csdnimg.cn/20181111225408494.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)2.检查是否已启用外部指令，代码如下：
```python
--查看外部指令
```
```python
sp_configure
```
```python
'external scripts enabled'
```
```python
--启用外部脚本，设置config_value为1
```
```python
EXEC
```
```python
sp_configure
```
```python
'external scripts enabled'
```
```python
,
```
```python
1
```
```python
RECONFIGURE
```
```python
WITH
```
```python
OVERRIDE
```
如果run_value为1，则机器学习功能已经安装成功并且可供使用。否则设置config_value为1。
![](https://img-blog.csdnimg.cn/20181111225043358.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)[
](https://img-blog.csdnimg.cn/20181111225043358.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)3.此时如果执行Python代码，可能会提示错误“此 SQL Server 实例已禁用 sp_execute_external_script，请使用 sp_configure 的已启用的外部脚本对其进行启用。” 这表示run_value仍然为0，此时需要开启服务。开启方法如下：
**1) 开启SQL Server实例数据库引擎服务**
**2) 开启SQL Server实例Lanuchpad服务**
注意执行完后要重启数据库引擎服务和SQL Server Lanuchpad服务才会正式生效：
![](https://img-blog.csdnimg.cn/20181111230546178.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)[
](https://img-blog.csdnimg.cn/20181111230546178.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)4.重启电脑和数据库引擎服务。
![](https://img-blog.csdnimg.cn/20181111231650450.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)[
](https://img-blog.csdnimg.cn/20181111231650450.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)5.添加最简单的Python和R语言代码，并执行。
**Pyhton代码**
```python
EXEC sp_execute_external_script @language
```
```python
=
```
```python
N
```
```python
'Python'
```
```python
,
```
```python
@script
```
```python
=
```
```python
N
```
```python
'print(3+4)'
```
运行结果如下：
![](https://img-blog.csdnimg.cn/20181111232305421.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)[
](https://img-blog.csdnimg.cn/20181111232305421.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)**R代码**
```python
exec sp_execute_external_script  @language =N'R',   
 @script=N'OutputDataSet<-InputDataSet',     
 @input_data_1 =N'select 1 as hello'   
 with result sets (([hello] int not null));   
 go
```
运行结果如下：
![](https://img-blog.csdnimg.cn/20181111232403154.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)[
](https://img-blog.csdnimg.cn/20181111232403154.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)
---

# 三. T-SQL调用Python数据分析入门
脚本语言的基本语法如下，推荐官方文章[sp_execute_external_script (TRANSACT-SQL) ](https://docs.microsoft.com/zh-cn/sql/relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql?view=sql-server-2017)。
```python
sp_execute_external_script   
    @language
```
```python
=
```
```python
N
```
```python
'language'
```
```python
,
```
```python
@script
```
```python
=
```
```python
N
```
```python
'script'
```
```python
[
```
```python
,
```
```python
@input_data_1
```
```python
=
```
```python
N
```
```python
'input_data_1'
```
```python
]
```
```python
[
```
```python
,
```
```python
@input_data_1_name
```
```python
=
```
```python
N
```
```python
'input_data_1_name'
```
```python
]
```
```python
[
```
```python
,
```
```python
@output_data_1_name
```
```python
=
```
```python
N
```
```python
'output_data_1_name'
```
```python
]
```
```python
[
```
```python
,
```
```python
@parallel
```
```python
=
```
```python
0
```
```python
|
```
```python
1
```
```python
]
```
```python
[
```
```python
,
```
```python
@params
```
```python
=
```
```python
N
```
```python
'@parameter_name data_type [ OUT | OUTPUT ] [ ,...n ]'
```
```python
]
```
```python
[
```
```python
,
```
```python
@parameter1
```
```python
=
```
```python
'value1'
```
```python
[
```
```python
OUT
```
```python
|
```
```python
OUTPUT
```
```python
]
```
```python
[
```
```python
,
```
```python
.
```
```python
.
```
```python
.
```
```python
n
```
```python
]
```
```python
]
```
推荐这篇文章供大家学习基础知识：[使用 T-SQL 執行 Python](https://docs.microsoft.com/zh-tw/sql/advanced-analytics/tutorials/run-python-using-t-sql?view=sql-server-2017)
**1.程序一 调用包**
```python
execute sp_execute_external_script 
@language
```
```python
=
```
```python
N
```
```python
'Python'
```
```python
,
```
```python
@script
```
```python
=
```
```python
N'
```
```python
import
```
```python
math
a
```
```python
=
```
```python
1
```
```python
b
```
```python
=
```
```python
2
```
```python
c
```
```python
=
```
```python
a
```
```python
*
```
```python
b
```
```python
print
```
```python
(
```
```python
a
```
```python
,
```
```python
b
```
```python
,
```
```python
c
```
```python
)
```
```python
d
```
```python
=
```
```python
math
```
```python
.
```
```python
pi
```
```python
/
```
```python
6
```
```python
print
```
```python
(
```
```python
math
```
```python
.
```
```python
sin
```
```python
(
```
```python
d
```
```python
)
```
```python
)
```
```python
'
```
输出结果如下所示：
![](https://img-blog.csdnimg.cn/20181111233750461.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)[
](https://img-blog.csdnimg.cn/20181111233750461.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)**2.程序二 回归预测**
```python
execute sp_execute_external_script 
@language
```
```python
=
```
```python
N
```
```python
'Python'
```
```python
,
```
```python
@script
```
```python
=
```
```python
N'
```
```python
from
```
```python
sklearn
```
```python
import
```
```python
linear_model
```
```python
import
```
```python
matplotlib
```
```python
.
```
```python
pyplot
```
```python
as
```
```python
plt
```
```python
import
```
```python
numpy
```
```python
as
```
```python
np
```
```python
#X表示匹萨尺寸 Y表示匹萨价格
```
```python
X
```
```python
=
```
```python
[
```
```python
[
```
```python
6
```
```python
]
```
```python
,
```
```python
[
```
```python
8
```
```python
]
```
```python
,
```
```python
[
```
```python
10
```
```python
]
```
```python
,
```
```python
[
```
```python
14
```
```python
]
```
```python
,
```
```python
[
```
```python
18
```
```python
]
```
```python
]
```
```python
Y
```
```python
=
```
```python
[
```
```python
[
```
```python
7
```
```python
]
```
```python
,
```
```python
[
```
```python
9
```
```python
]
```
```python
,
```
```python
[
```
```python
13
```
```python
]
```
```python
,
```
```python
[
```
```python
17.5
```
```python
]
```
```python
,
```
```python
[
```
```python
18
```
```python
]
```
```python
]
```
```python
print
```
```python
(
```
```python
X
```
```python
)
```
```python
print
```
```python
(
```
```python
Y
```
```python
)
```
```python
#回归训练
```
```python
clf
```
```python
=
```
```python
linear_model
```
```python
.
```
```python
LinearRegression
```
```python
(
```
```python
)
```
```python
clf
```
```python
.
```
```python
fit
```
```python
(
```
```python
X
```
```python
,
```
```python
Y
```
```python
)
```
```python
res
```
```python
=
```
```python
clf
```
```python
.
```
```python
predict
```
```python
(
```
```python
np
```
```python
.
```
```python
array
```
```python
(
```
```python
[
```
```python
12
```
```python
]
```
```python
)
```
```python
.
```
```python
reshape
```
```python
(
```
```python
-
```
```python
1
```
```python
,
```
```python
1
```
```python
)
```
```python
)
```
```python
[
```
```python
0
```
```python
]
```
```python
print
```
```python
(
```
```python
u
```
```python
"预测一张12英寸匹萨价格：$%.2f"
```
```python
%
```
```python
res
```
```python
)
```
```python
#预测结果
```
```python
X2
```
```python
=
```
```python
[
```
```python
[
```
```python
0
```
```python
]
```
```python
,
```
```python
[
```
```python
10
```
```python
]
```
```python
,
```
```python
[
```
```python
14
```
```python
]
```
```python
,
```
```python
[
```
```python
25
```
```python
]
```
```python
]
```
```python
Y2
```
```python
=
```
```python
clf
```
```python
.
```
```python
predict
```
```python
(
```
```python
X2
```
```python
)
```
```python
'
```
输出结果可以看到线性回归预测的价格。
![](https://img-blog.csdnimg.cn/20181111233915963.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)[
](https://img-blog.csdnimg.cn/20181111233915963.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0Vhc3Rtb3VudA==,size_16,color_FFFFFF,t_70)后续文章将结合存储过程详细讲解SQL Server玩转Python的过程，比如这篇文章。
[https://docs.microsoft.com/zh-cn/sql/advanced-analytics/tutorials/sqldev-py5-train-and-save-a-model-using-t-sql?view=sql-server-2017](https://docs.microsoft.com/zh-cn/sql/advanced-analytics/tutorials/sqldev-py5-train-and-save-a-model-using-t-sql?view=sql-server-2017)
希望文章对大家有所帮助，如果有错误或不足之处，还请海涵。最近经历的事情太多，有喜有悲，关闭了朋友圈，希望通过不断学习和写文章来忘记烦劳，将忧郁转换为动力，每周学习都记录下来。
（By：Eastmount 2018-11-12 晚上12点[https://blog.csdn.net/Eastmount/）](https://blog.csdn.net/Eastmount/%EF%BC%89)

