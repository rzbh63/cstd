# 离线识别SDK 安卓-SDK-v1.0说明



# 版本日志

| 版本   | 日期       | 更新说明                                                     |
| :----- | :--------- | :----------------------------------------------------------- |
| v1.1.0 | 2018.09.03 | 1、增加离线证件照特征抽取模型，可有效处理芯片照、证件照比对需求 2、增加离线人脸属性模型，支持性别、年龄等属性分析 3、增加多线程支持 4、增加离线激活支持，可导入授权文件无网激活 5、增加对奥比中光Astra Pro深度图镜头模组支持 6、增加对华捷艾米深度镜头模组支持 7、其他细节优化及已知bug修复 |
| v1.0.1 | 2018.08.03 | 1、修复设备指纹发生变化bug 2、替换近红外活体模型，优化效果 3、修复批量注册人脸到人脸库，失败问题 4、修复注册、图片人脸检测、视频返回图片抽取特征失败，经常出现检测不到人脸问题 |
| v1.0.0 | 2018.06.29 | 初版，包括离线人脸采集、离线活体检测、离线对比识别、离线人脸库管理等功能 |

# 目录

```
1、简介
   1.1 SDK基础信息
       1.1.1 产品概述
       1.1.2 规格信息
       1.1.3 兼容性
       1.1.4 授权方式
       1.1.5 产品定价
   1.2 功能介绍
       1.2.1 人脸检测与追踪
       1.2.2 质量控制
       1.2.3 人脸采集
       1.2.4 离线RGB可见光活体检测
       1.2.5 离线NIR近红外活体检测
       1.2.6 离线Depth深度图像（3D结构光）活体检测
       1.2.7 离线1：1对比
       1.2.8 离线1：N搜索
       1.2.9 离线人脸库管理
   1.3 业务逻辑
   	   1.3.1 通用流程概述
   	   1.3.2 活体检测
   	   1.3.3 人脸对比
   	   1.3.4 人脸搜索
   1.4 设备选型
       1.4.1 镜头模组选择
       1.4.2 开发板选择
   1.5 方案选型
       1.5.1 使用离线SDK
       1.5.2 使用采集SDK+API
       1.5.3 使用离线SDK+API
2、集成指南
   2.1 准备工作
       2.1.1 注册开发者
       2.1.2 设备激活
   2.2 代码结构
       2.2.1 核心库介绍
       2.2.2 示例代码介绍
   2.3 开始集成
       2.3.1 人脸库集成
       2.3.2 SDK初始化
       2.3.3 按设备授权
       2.3.4 多线程说明
       2.3.5 特征模型设置
       2.3.6 活体检测设置
       2.3.7 人脸注册
       2.3.8 人脸对比（图片vs图片）
       2.3.9 人脸对比（视频流vs图片）
       2.3.10 人脸搜索（视频流vs人脸库）
   2.4 核心类
       2.4.1 FaceSDKManager
       2.4.2 FaceDetector
       2.4.3 FaceFeature
       2.4.4 FaceLiveness
       2.4.5 FaceEnvironment
       2.4.6 FaceDetectManager
3、常见问题
```

# 1、简介

## 1.1 SDK基础信息

### 1.1.1 产品概述

人脸离线识别SDK，包含人脸采集、活体检测、人脸对比/识别、人脸库管理等能力，并全部离线化、本地化。此SDK一经授权激活，可完全在无网环境下工作，所有数据皆在设备本地运行处理，可根据业务需要进行灵活的上层业务开发。核心能力分布如下图所示，后文会详细介绍。

![img](https://ai.baidu.com/file/AEA3D2CEA8234648AFE943CB6B5397B4)

**适用场景特点**

- **网络**：无网、局域网等情况，无法连接公网。如政府单位、金融保险、教育机构等。
- **安全**：行业特点所带来的人脸数据敏感性，即使可以连接公网也不可请求。
- **速度**：由于各地网络线路、机房部署等诸多原因，网络请求速度存在不可控因素。
- **稳定**：需要尽可能避免网络抖动、机房故障等影响，进一步控制可用性影响因素。

### 1.1.2 规格信息

- 包大小：~ 100M
- 最小人脸检测大小：50px * 50px
- 可识别人脸角度：yaw ≤ ±30°, pitch ≤ ±30°
- 检测速度：100ms 720p*
- 追踪速度：30ms 720p*
- 人脸检测耗时：< 100ms
- RGB图片特征抽取耗时：< 300ms
- RGB活体检测耗时：< 200ms
- 近红外活体检测耗时：< 50ms
- 3D结构光活体检测耗时：< 50ms
- 1万本地人脸库检索速度：< 400ms

> 备注：以上指标，由最新版SDK运行在真实设备上，采用真实数据集所得，但**算法性能受实际运行设备、实际数据集等情况影响**，以上数字仅供参考。

### 1.1.3 兼容性

**Android 4.4+**

硬件适配情况请详见后文：1.4 硬件选型

### 1.1.4 授权方式

**按设备授权**

离线识别SDK授权方式为以设备维度为主，每台硬件设备需要一个独立的授权，此授权的校验是基于设备的硬件指纹（指纹的获取SDK初始化时会自动读取并展示），被授权的设备，将在有效期内可以运行SDK。

重新拉取授权的情况：设备授权不变，仅需要重新激活而已。

- 删除SDK或基于SDK开发的应用
- 刷安卓系统

授权失效的情况：需要重新购买序列号，之前的序列号失效。

- 激活一台设备后，此设备硬件变更
- 硬件损坏

**序列号**

序列号为管理授权的依据。每台被授权的设备，都将对应一个序列号，用于标识对应的设备信息及授权记录。序列号的形式为16位随机英文数字组合，如：`3G59-M5JK-889A-7LQA`。您在[管理后台](https://console.bce.baidu.com/ai/#/ai/face/offline/index)购买SDK授权时，购买成功后系统将会发放对应数量的序列号。序列号不限制平台版本，任何开发平台的离线SDK，都可以使用此序列号激活。序列号不限制账号，可供任何设备激活使用。

**激活**

已购买的序列号，是用于激活的唯一凭证，激活流程主要是将序列号与具体的硬件进行绑定（硬件指纹），从而生成对应硬件设备的授权文件（License），SDK运行前，将会校验授权文件是否和实际硬件信息相匹配。

> **注意**：激活时，设备系统时间需要和当前时间一致，如果差距太大（例如偏差5min以上），激活则无法完成。

**联网激活**

此种激活方式，适用于设备可首次联网的情况，优势在于激活过程极为简单。您只需将SDK安装到需要激活的设备上，然后填写已经购买的序列号，在界面上点击激活即可（为使用方便，我们为您设计了一个简单的激活用户界面）

![img](https://ai.bdstatic.com/file/52A1EAB07F60475C84CF349FD8BDDE0B)

1. 获取序列号：从[管理后台](https://console.bce.baidu.com/ai/#/ai/face/offline/index)购买获取序列号。
2. SDK中填写序列号：将序列号填写到SDK的可视化界面中。
3. 启动激活：点击「激活」按钮。
4. SDK自动激活：SDK自动拉取授权文件并完成授权，激活完毕。

如激活成功，将会立即在界面上有明确的弹窗提示，请留意查看；如激活失败，也会反馈具体的错误信息。

**离线激活（安卓后续版本支持）**

此种激活方式，适用于设备完全不可联网的情况，优势在于可避免联网激活，满足业务对网络的严格要求，以及设备批量注册需求。您需要在后台配置好硬件指纹并完成和序列号的绑定，然后将授权文件放到SDK的指定位置。

![img](https://ai.baidu.com/file/8D7AA3D41A0147D6B3738246908957D2)

1. 获取序列号：从[管理后台](https://console.bce.baidu.com/ai/#/ai/face/offline/index)购买获取序列号。
2. 采集硬件指纹：将SDK置于设备上，运行激活程序，获取硬件指纹。
3. 配置授权：在后台将硬件指纹绑定到具体序列号上。
4. 下载授权文件：绑定成功后下载授权文件。
5. 设备激活：将授权文件放到SDK中，并初始化SDK完成授权。

**授权有效期**

申请通过后，每个账户给**2个测试序列号**，用于激活及SDK试用，有效期为**自激活日期后的3个月**。这两个序列号在有效期内完全免费，您可以用于进行产品试用。试用期到期后也可以在后台申请延期，填写具体延期理由即可。

**正式购买**

正式购买的序列号，试用期限为**永久有效**。此「永久」是指绑定到具体设备维度，但如已绑定的硬件设备变更后，授权则可能会失效。

### 1.1.5 定价方式

离线SDK的授权基于设备维度，每个序列号仅可以授权一台设备。每个账号购买的序列号会累计计算，**累计购买量**越多，单价越便宜。具体如下所示：

| 累计购买授权数量 | 每个授权单价 |
| :--------------- | :----------- |
| 0~1000           | 299元/个     |
| 1001~5000        | 249元/个     |
| >5000            | 199元/个     |

[立即去购买](https://console.bce.baidu.com/ai/#/ai/face/offline/index)

## 1.2 功能介绍

### 1.2.1 人脸检测与追踪

可在设备端，离线实时检测视频流中的人脸。同时支持处理静态图片或者视频流，并对当前检测到的人脸持续跟踪，动态定位人脸轮廓，稳定贴合人脸。

### 1.2.2 质量控制

在人脸检测及追踪过程中，实时校验人脸的姿态角度、遮挡、清晰度、光照条件，符合质量条件的人脸图片才会被采集。

### 1.2.3 人脸采集

针对视频流实时完成人脸图片采集，并输出满足质量过滤条件的人脸图片，可自定义采集人脸大小，采集频率，采集质量等设置。

### 1.2.4 离线RGB可见光活体检测

针对视频流/图片，通过采集人像的破绽（摩尔纹、成像畸形等）来判断目标对象是否为活体，可有效防止屏幕二次翻拍等作弊攻击，可使用单张或多张判断逻辑。

### 1.2.5 离线NIR近红外活体检测

针对视频流/图片，利用近红外成像原理，实现夜间或无自然光条件下的活体判断。其成像特点（如屏幕无法成像，不同材质反射率不同等）可以实现高鲁棒性的活体判断。

### 1.2.6 离线Depth深度图像（3D结构光）活体检测

通过3D建模判断目标对象是否为活体，基于3D结构光成像原理，可强效防御图片、视频、屏幕、模具等攻击。

### 1.2.7 离线1：1对比

提供本地化的1：1人脸对比功能，高鲁棒性算法，可对应各种姿态、肤色、光照等场景，可有效应用于人证比对、身份核验等场景。

示例工程中包含：

- 图片与图片的比对：两张人脸图片的1：1对比，并返回相似度分值。
- 图片与视频流比对：一张预设的人脸图片，和摄像头实时采集的符合条件的人脸图片进行对比。

### 1.2.8 离线1：N搜索

本地数据库中保留所有人脸特征值（如需要保留原图，可根据业务需要自行修改工程）。

- 视频流采集的人脸在人脸库中搜索：视频流中实时采集人脸，并与人脸库中预设的人脸库进行一一对比，返回相似度最高的user及对应分值。

### 1.2.9 离线人脸库管理

**人脸数量不做上限，可根据业务需要适当调整**，支持人脸库、人脸组、用户、Face几个维度的增删改查设置。

## 1.3 业务流程

### 1.3.1 通用流程概述

![img](https://ai.baidu.com/file/DDFC906B6C094F5D9CC563272313EE38)

如上图所示，人脸识别的核心业务流程可以分为三个步骤。

1. 检测采集：通过视频流实时检测跟踪，并采集到符合质量要求的人脸图片，用于后续的识别。
2. 活体判断：为可选步骤，主要保障业务操作者为真人，避免业务作弊。加上这步的校验，即只有满足活体判断通过，人脸图片才会被采集。
3. 对比识别：1：1对比主要是判断「你是你」，用于核实身份的真实性；1：N搜索主要判断「你是谁」，用于明确身份的具体所属。

### 1.3.2 活体检测

**1.3.2.1 基础原理**

- RGB可见光活体：主要基于图片破绽，判断目标对象是否为活体。例如图像中的屏幕反光、成像畸形等，最主要的应用情形为屏幕的二次翻拍等攻击防御。此种活体对于待检测图片的要求，主要需要满足画面中除了人脸以外，要尽可能保留一些背景内容，用于查找破绽，通常建议人脸与屏幕的长宽比为1：3。为控制达到此比例，建议通过调整最小检测人脸参数，控制采集的人脸不可过大，避免人脸面积占比过高，而导致图片中没有多少背景信息。同时RGB活体受光线影响较大，所以在强光、暗光等场景，容易数值波动较大，主要影响的是「通过率」，产品策略上需要通过适当的补光、使用宽动态镜头抵消逆光等方式缓解。
- NIR近红外活体：主要基于近红外光线反射成像原理，通过人脸呈现来判断是否为活体。即使是夜间或者没有自然光的情况下，依然可以判断活体。因为其成像特点，对于屏幕、图片等攻击形式，基本可以达到近似于100%的活体防御。同时近红外设备的成本，相对性价比更高。
- Depth深度活体（3D结构光）：结构光原理是通过主动光发射，在物体上形成光栅，并接受此信息进行活体分析。同样可以不需要自然光。3D结构光的成像更为稳定，抗攻击能力更强，对图像噪声的抗干扰能力也更强，是相对更加安全和稳定的方案，但相应的硬件设备造价也较高，需要根据实际业务成本预算，进行综合考虑。

以上，无论活体是否可以通过，我们业务的最终目的，还是要进行「对比识别」，所以**拿到合适的RGB图像还是最为关键**，保障符合条件的RGB图像获取也是需要在活体判断同时，最为需要关注的事情。

在实际业务场景中，需要根据场景特点，灵活组合使用以上几种活体方案。当然，实际业务中，**没有绝对100%的安全**，在应用过程中，还需要根据业务流程特点，指定一系列的辅助措施，如证件信息读取、密码、其他生物特征识别等，达到刚安全的核验。

**1.3.2.2 产品应用策略**

活体判断逻辑简单理解为：满足活体条件才可以采集图片，否则一直反复判断，直到满足活体条件为止。因为我们最终送去识别的图片是RGB图片，所以需要**保证活体通过时，在同一时间采集RGB图片，才可真正防止作弊攻击**。当多种活体叠加使用时，需要满足所有活体都通过，才能出发此操作，如果有任一活体没有通过，都不可进入识别步骤。

![img](https://ai.baidu.com/file/D02E480CC8664D66AAFA29CC1B0E8F06)

![img](https://ai.baidu.com/file/2A938C1C533040E5AFCDB2E4CE58A522)

![img](https://ai.baidu.com/file/85D6870943854A3DBF34A48832130404)

**1.3.2.3 场景及应用方案**

- 通行场景：此场景通常保障通行速度为主，确保不影响通行秩序和效率。所以建议无需使用三重活体检测，可仅用NIR活体或Depth活体，保障效率同时仍可保证安全性。
- 身份核验场景：此场景通常保障业务安全性为主，可尽可能提供更加安全的活体方案。如RGB+NIR，或者RGB+Depth，乃至RGB+NIR+Depth，最大程度确保对攻击的拒绝率较高。
- 强光/暗光场景：光线较强的场景，RGB活体会受影响比较严重，建议使用NIR或者Depth活体，同时尽量通过产品策略避免这两种情况的光线，例如添加补光灯、配备遮光板等。

**1.3.2.4 应用方案及模组选择**

- 无需活体：如有人值守的场景下，活体检测并无太大的必要（活体检测也会增加额外的业务耗时），现有设备的单目USB摄像头即可。
- 仅用RGB可见光活体：如果您的设备已经配备了USB单目摄像头，则无需更换，输出的RGB图像可直接用于RGB可见光活体算法识别。
- RGB可见光+NIR近红外活体：需要配备能够同时获取RGB、NIR近红外数据的镜头使用。
- RGB可见光+Depth深度活体：需要配备能够同时获取RGB、Depth深度图像数据的镜头使用。
- RGB可见光+NIR近红外+Depth深度活体：此种方式安全度最高，目前SDK正在模组适配中，后续会陆续推出已适配的模组方案，敬请期待。

**1.3.2.4 指标**

活体检测存在几个标准的指标，如下所示：

- 拒绝率（TRR）：如99%，代表100次作弊假体攻击，会有99次被拒绝。
- 误拒率（FRR）：如0.5%，指1000次真人请求，会有5次因为活体分数低于阈值被错误拒绝。
- 通过率（TAR）：如99%，指100次真人请求，会有99次因为活体分数高于阈值而通过。
- 阈值（Threshold）：高于此数值，则可判断为活体。

温馨提示：此SDK涉及多种离线活体检测模型，加上镜头模组效果各异，使用环境也较为复杂，以下给出综合测试值，仅供参考：

- 拒绝率：> 99.5%
- 误拒率：< 1%
- 通过率：> 99%

**1.3.2.4 阈值选择推荐**

活体分值区间为[0~1]，大部分情况的活体攻击，活体分值近似于接近0.0，建议阈值如下，高于此阈值的即可判断为活体。

- RGB可见光活体：0.8
- NIR近红外活体：0.8
- Depth深度活体（3D结构光）：0.8

### 1.3.3 人脸1：1对比

人脸对比分为两种常见形态，具体如下：

**1.3.3.1 对比类型：图片vs图片**

如果有两张待对比的图片（如证件图片、以事先获取到的人脸生活照等），则可以直接通过离线SDK进行对比，业务流程如下图所示：

![img](https://ai.bdstatic.com/file/2E8961C3709546DB8BA347D2C073A496)

**1.3.3.2 对比类型：实时视频流vs图片**

这是最为常见的1：1对比类型，一张事先获取的图片（通常为身份证芯片照、证件照片等），与现场人脸采集的图片进行对比。如果需要为无人看守，则需要配备活体检测保障业务真实性和安全性。

![img](https://ai.bdstatic.com/file/53EA4733AC6A4AC3955B32D683897422)

### 1.3.4 人脸1：N搜索

将需要识别的人脸图片集注册到本地人脸库中，当有用户需要识别身份时，从视频流中实时采集人脸图片，与人脸库中的人脸集合对比，得到搜索结果。如果需要为无人看守，则需要配备活体检测保障业务真实性和安全性。

![img](https://ai.bdstatic.com/file/8CF7F52E9EE34D3194E9C4D71FE81F58)

## 1.4 设备选型

### 1.4.1 镜头模组选择

**1.4.1.1 无活体或仅用RGB单目活体**

uvc免驱单目USB摄像头，推荐**视派尔**单目摄像头，默认为3mm焦距镜头，可以选择6mm镜头，可以检测识别更远的人脸。

- **视派尔C-EP28WD400**，[[产品规格书\]](https://ai.baidu.com/file/A924CBBE997B451BA3851E65089CE8F4)

**1.4.1.2 RGB可见光+NIR近红外活体**

推荐使用如下品牌的近红外摄像头，可根据场景举例选择合适焦距摄像头。

- **迪威泰DV-BD4044S305AD**，[[产品规格书\]](https://ai.bdstatic.com/file/41B13101144243D585A607B811EB0ED1)；联系人：杨先生；联系电话：18643209187
- **迪威泰DV-BD4053S305AD**，[[产品规格书\]](https://ai.bdstatic.com/file/8054E892E1D746B1A31CA6CADEA077DF)；联系人：杨先生；联系电话：18643209187
- **视派尔C-EP35WDLDIR**，[[产品规格书\]](https://ai.baidu.com/file/8336871C093844AFB7D432A78FC54015)；联系人：焦先生；联系电话：18676660044

NIR近红外实际检测效果回显示例：

![img](https://ai.baidu.com/file/A077D0EC78F1481D88A9D4A792FBC334)

**1.4.1.3 RGB可见光+Depth深度活体（3D结构光）**

推荐使用如下品牌的深度摄像头，可根据场景举例选择合适焦距摄像头。

- **奥比中光Astra Mini / Mini S**，[[产品规格书\]](https://ai.baidu.com/file/9A1E423F4D134257A04BF4C56BE8117E)；[[AI市场购买链接\]](http://ai.baidu.com/market/product/1cda17db-b965-48a8-bf99-8877ba52d75a)
- **奥比中光Astra Pro / Pro S**，[[产品规格书\]](https://ai.baidu.com/file/D6BD868D70D0436C84491BCE55BF4130)；[[AI市场购买链接\]](http://ai.baidu.com/market/product/ac6aea03-6002-43ee-a953-cbb3e69e6129)
- **华捷艾米A100S+MINI**，[[产品规格书\]](https://ai.baidu.com/file/F3DB9ABB0F68493DBC71FEE52260592A)；[[AI市场购买链接\]](http://ai.baidu.com/market/product/b61d5bd2-505b-461c-a7e7-7ac7d7bd827e)

Depth实际检测效果回显示例：

![img](https://ai.bdstatic.com/file/5DC044EA036B4A88A0B133394117C150)

**1.4.1.4 是否可以使用其他品牌镜头？**

如果您需要使用NIR近红外或者Depth活体，则一定要配备支持对应图像格式类型的镜头模组。目前百度离线SDK适配的镜头类型有限，难以覆盖市面上所有双目模组。您可以查看下方的图像适配指标文档，只需满足文档中的图像/数据要求，即可自行进行模组适配。

[[镜头模组图像适配指标\]](https://ai.baidu.com/file/6B38486BE1394F70884EF191925E5665)

我们也诚挚欢迎各镜头模组厂商参与到SDK的合作中来，我们会积极与您进行产品、技术、商务等多方面对接。测评效果较佳的模组，将会作为SDK官方适配模组，并在所有技术资料中优先推荐用户使用。您可以将合作申请发送到下方咨询邮箱，我们接到您的申请后会尽快与您取得联系，感谢您的信任。

**合作邮件：ai#baidu.com（ #替换成@符号 ）**

### 1.4.2 开发板选择

推荐使用RK3399，推荐硬件厂商及型号

- Firefly AIO-3399J，[[产品规格介绍\]](http://www.t-firefly.com/product/industry/aio_3399.html)，[[固件支持\]](http://www.t-firefly.com/doc/download/page/id/31.html)，[联系Firefly](http://www.t-firefly.com/)；联系电话：4001511533

## 1.5 方案选型

离线SDK具备离线人脸检测、跟踪、质量校验、图像采集、RGB/NIR/3D结构光活体、离线对比识别、离线人脸库管理。可基本cover人脸识别所需要的全部能力，仅需一个SDK即可完成业务能力覆盖。但相对来说仍然具备一定的场景及业务使用限制。

目前AI开放平台也同时开放采集SDK和API能力，建议您根据实际的业务需要，选择合适的产品应用方案，以达到最佳的应用效果。

### 1.5.1 使用离线SDK

以下特点及场景，适合仅适用人脸离线SDK

**适用的场景特点**

- 网络条件不稳定
- 无网络
- 数据安全性高，不允许联网
- 人脸库较小，且变更不频繁，如1w人以下
- 单台设备、单人脸检测与识别

> 注意：此版本离线SDK暂不支持多线程处理，主要适用于单人脸核验场景，不建议用于多人脸抓拍识别。

**典型场景及设备类型**

- 人脸门禁
- 人脸闸机
- 人证核验机
- 自助柜机
- 人脸考勤机
- 会场签到

> 提示：对于离线1：N场景，需要您基于SDK构造上层的人脸库数据更新业务逻辑，例如小区门口的闸机为纯离线，但是住户的变更信息，如何同步到每一个大门的闸机中。

### 1.5.2 使用采集SDK+API接口

以下特点及场景，适合使用采集SDK+API接口

**适用的场景特点**

- 网络条件良好
- 人脸库量级庞大
- 需要跨地域同步人脸库
- 人脸库更新频繁
- 用户APP产品形态

> 提示：采集SDK具备本地化的人脸检测跟踪、质量校验、人脸采集等功能，与离线SDK相比，活体和识别操作使用云端服务完成。

**典型场景及设备类型**

- 零售会员识别
- 人脸支付
- 手机APP
- 移动考勤
- 远程开户

### 1.5.3 使用离线SDK+API接口

以下特点及场景，适合使用离线SDK+API接口

**适用的场景特点**

- 网络条件较好
- 人脸库较小，但变更频繁
- 业务常为集中时段的高并发（如考勤）

**典型场景及设备类型**

- 上下班刷脸考勤
- 社区闸机
- 楼宇门禁

离线人脸库处理固定人员的识别请求，将在本地抵消掉很多API请求量；同时API处理变动人员的请求，方便及时同步更新，从而总体节省QPS资源的成本消耗。

# 2、集成指南

## 2.1 准备工作

### 2.1.1 注册开发者

1. STEP1：点击百度AI 开放平台导航右侧的控制台，页面跳转到百度云登录界面，登录完毕后，将会进入到百度云后台，点击「控制台」进入百度云控制台页面；您也可以在官网直接点击免费试用，登录完毕后将自动进入到百度云控制台。
2. STEP2：使用百度账号完成登录，如您还未持有百度账户，可以点击此处注册百度账户。
3. STEP3：进入百度云欢迎页面，填写企业和个人基本信息，注册完毕，至此成为开发者。(如您之前已经是百度云用户或百度开发者中心用户，STEP3 可略过。)
4. STEP4：进入百度云控制台，找到人工智能相关服务面板。
5. STEP5：点击进入「[人脸识别](https://console.bce.baidu.com/ai/?fromai=1#/ai/face/overview/index)」
6. STEP6：点击进入「[离线SDK管理](https://console.bce.baidu.com/ai/#/ai/face/offline/index)」

### 2.1.2 设备激活

首次运行示例工程，会弹出激活窗口。1为设备号，自动读取；2为序列号，手动输入。点击激活（激活需要联网，采用的https请求，https要求设备系统时间跟请求服务器时间差距不大，否则请求授权服务器会失败），激活以后使用不需要在连接网络，一个序列号绑定一台设备，卸载应用后重新安装可能需要重新激活，可以使用同一个序列号。可以在你的控制台查看设备号对应的序列号。

SDK的激活界面如下图所示：

![img](https://ai.baidu.com/file/D08196F89C5A47478E61AF94A5BBE5D9)

## 2.2 代码结构

### 2.2.1 核心库介绍

- lib目录为动态库so和jar包
- assets目录为模型文件
- java目录为用户组管理、人脸SDK操作、视频流、图片等操作辅助类

![img](https://ai.baidu.com/file/47F26DE22FBB423DA2EA6BDB0093F8DE)

### 2.2.2 示例代码介绍

| model名称                      | 功能说明                                                     |
| :----------------------------- | :----------------------------------------------------------- |
| **FeatureSettingActivity**     | 特征抽取模型设置，分为生活照模型和证件照模型。生活照模型适用于生活照图片，手机拍摄图片，镜头实时采集的图片等；证件照模型适用于身份证芯片照，各类证件照（如工卡，学生证，会员卡照片等），带水纹小图等。一经选择一个模型，则所有业务流程的特征抽取处理，都会使用此模型，两个模型不可同时作用。如业务中设计证件照的特征抽取，请务必选择证件照模型。 |
| **LivenessSettingActivity**    | 活体类型设置，分为无活体、RGB活体、RGB+NIR活体、RGB+Depth活体、RGB+NIR+Depth活体。默认为不使用活体。示例工程里面进行活体设置后，后续的人脸注册、人脸1：1，1：n等操作需选择相应Activity。无活体和rgb活体需要使用单目usb摄像头，rgb+ir活体需要使用rgb+ir双目摄像头（如迪威泰、视派尔双目摄像头，具体推荐型号详见上文设备选型介绍）。RGB+Depth需要使用奥比中光mini/mini-s/Pro-S、或华捷艾米摄像头，且目前只能使用RGB+Depth活体功能。RGB+NIR+Depth的活体硬件设备适配还在开发中。 |
| AddGroupActivity               | 添加分组，1：n中的n为某个分组下的人脸特征                    |
| BatchImportActivity            | 提供批量注册人脸到人脸库                                     |
| GroupListActvity               | group列表，正常情况一个分组即可，可以根据业务需求用多个分组管理 |
| ImageMatchImageActivity        | 两张图片进行1：1比对                                         |
| MainActivity                   | 示例主界面入口                                               |
| RegActivity                    | 人脸检测、抽取特征进行注册                                   |
| RgbDetectActivity              | 摄像头视频流人脸检测，提供给注册、图片1：1实时采集人脸图片用。使用uvc免驱USB摄像头 |
| UserActivity                   | 注册用户信息                                                 |
| UserGroupMangerActivity        | 用户组管理                                                   |
| UserListActivity               | 某个分组下用户列表                                           |
| VideoIdentityActivity          | 视频流人脸实时检测，并和某个分组的人脸库进行1：N比对         |
| RgbVideoAttributeTrackActivity | 视频流人脸实时检测，输出人脸的属性信息                       |
| VideoMatchImageActivity        | 视频流人脸实时检测，并和指定的图片进行1：1比对               |
| RgbIrLivenessActivity          | RGB+NIR活体检测，提供给人脸注册、图片1：1实时采集人脸图片用。需要使用RGB+NIR的双目摄像头。如迪威泰、视派尔双目摄像头 |
| RgbIrVideoIdentifyActivity     | 带RGB+NIR活体，视频流人脸实时检测，并和某个分组的人脸库进行1：n比对。需要使用RGB+NIR的双目摄像头。如迪威泰、视派尔双目摄像头。 |
| RgbIrVideoMathImageActivity    | 带RGB+NIR活体，视频流人脸实时检测，并和指定的图片进行1：1比对。需要使用RGB+NIR的双目摄像头。如迪威泰、视派尔双目摄像头。 |
| OrbbecLivenessDetectActivity   | RGB+Depth活体检测，提供给人脸注册、图片1：1实时采集人脸图片用。需要使用RGB+Depth的双目摄像头。如奥比中光mini或mini-s双目摄像头 |
| OrbbecVideoIdentifyActivity    | 带RGB+Depth活体，视频流人脸实时检测，并和某个分组的人脸库进行1：n比对。需要使用RGB+Depth的双目摄像头。如奥比中光mini或mini-s双目摄像头 |
| RgbIrVideoMathImageActivity    | 带RGB+Depth活体，视频流人脸实时检测，并和指定的图片进行1：1比对。需要使用RGB+Depth的双目摄像头。如奥比中光mini或mini-s双目摄像头。 |
| OrbbecProVideoIdentifyActivity | 带RGB+Depth活体，视频流人脸实时检测，并和某个分组的人脸库进行1：n比对。需要使用RGB+Depth的双目摄像头。如奥比中光Pro双目摄像头。 |
| IminectVideoIdentifyActivity   | 带RGB+Depth活体，视频流人脸实时检测，并和某个分组的人脸库进行1：n比对。需要使用RGB+Depth的双目摄像头。如华捷艾米双目摄像头。 |

以上所述文件位置如下图所示：

![img](https://ai.baidu.com/file/533D7F5F7F15469B9356ADB5944B0E4D)

## 2.3 开始集成

接下来我们详细介绍一下集成步骤。

### 2.3.1 人脸库集成

1. 把library库添加到自己的工程中：（1）`settings.gradle` 添加`‘:library’`；（2）app->build.gradle->dependencies->compile project(":library")。
2. 根据需要把app里面的示例代码添加到自己的工程。

### 2.3.2 SDK初始化

**采用默认参数进行初始化：**

![img](https://ai.bdstatic.com/file/6E3D570B53144A4388E41500D2A77D58)

**如果需要设置SDK的具体参数：**

![img](https://ai.bdstatic.com/file/E3829DAE657045EDABCBCC97569DA569)

**详细参数设置参考如下表格所示：**

| 参数                   | 名称                                                   | 默认值 | 取值范围   |
| :--------------------- | :----------------------------------------------------- | :----- | :--------- |
| **brightnessValue**    | 图片爆光度                                             | 40f    | 50~255     |
| **blurnessValue**      | 图像模糊度                                             | 0.7f   | 0~1.0f     |
| **occlusionValue**     | 人脸遮挡阀值                                           | 0.5f   | 0~1.0f     |
| **headPitchValue**     | 低头抬头角度                                           | 15     | 0~45       |
| **headYawValue**       | 左右角度                                               | 15     | 0~45       |
| **headRollValue**      | 偏头角度                                               | 15     | 0~45       |
| **minFaceSize**        | 最小人脸检测值，小于此值的人脸将检测不出来，最小值为80 | 120    | 80~200     |
| **notFaceValue**       | 人脸置信度                                             | 0.8f   | 0~1.0f     |
| **isCheckFaceQuality** | 是否检测人脸质量                                       | False  | True/Flase |

### 2.3.3 按设备授权

SDK初始化的时候会检测设备授权，如果没有授权，会弹出授权框，填入在平台上创建的序列号。授权成功SDK才可初始化成功。

### 2.3.4 多线程说明

此版本离线SDK中支持的多线程是针对多路摄像头而设计的，但因开启多线程，会影响一定的每个线程的实际效果，使用过程中是通过下标来区分线程，不能混用。使用案例可以参考MultiThreadManager，MultiThreadActivity类。Demo中SDK初始化的所有模型数目默认是1，默认的是适用的单个线程，如果要使用多线程需要自行修改，参考下图：

![img](https://ai.baidu.com/file/1DC6AC5D30324A839A455E70CD895AA7)

### 2.3.5 特征模型设置

**模型介绍**

v1.1版本起，SDK提供生活照和证件照两种特征抽取模型，主要适用场景如下:

- **生活照模型**：如手机拍摄的图片、较为清晰的证件照片、USB镜头实时采集的图片、网络摄像头实时采集的图片等。
- **证件照模型**：如身份证芯片照、各类证件照（工卡、学生卡、会员卡照片等）、人脸的像素普遍小于80px的图片等。

**使用方法**

| model名称                  | 功能说明                                       |
| :------------------------- | :--------------------------------------------- |
| **FeatureSettingActivity** | 特征抽取模型设置，分为生活照模型和证件照模型。 |

**注意事项**

温馨提示：一经选择一个模型，则所有业务流程的特征抽取处理，都会使用此模型，两个模型不可同时作用。**如业务中设计证件照的特征抽取，请务必选择使用证件照模型**。

### 2.3.6 活体检测设置

**活体介绍**

详见文档**1.3.2**部分

**使用方法**

| model名称                   | 功能说明                                                     |
| :-------------------------- | :----------------------------------------------------------- |
| **LivenessSettingActivity** | 活体类型设置，分为无活体、RGB活体、RGB+NIR活体、RGB+Depth活体、RGB+NIR+Depth活体。默认为不使用活体。示例工程里面进行活体设置后，后续的人脸注册、人脸1：1，1：n等操作需选择相应Activity。无活体和rgb活体需要使用单目usb摄像头，rgb+ir活体需要使用rgb+ir双目摄像头（如迪威泰、视派尔双目摄像头，具体推荐型号详见上文设备选型介绍）。RGB+Depth需要使用奥比中光mini/mini-s/Pro-S、或华捷艾米摄像头，且目前只能使用RGB+Depth活体功能。RGB+NIR+Depth的活体硬件设备适配还在开发中。 |

温馨提示：业务流程中，只能使用一种活体设置。

### 2.3.7 人脸注册（RegActivity、RgbDetectActivity）

**2.3.7.1 通过视频流实时采集需要注册的人脸图片**

通过`RgbDetectActivity`实时检测获取注册的人脸。注册过程是往人脸库中注册照片，因为该照片做为识别标准所以对质量的要求也更高。为了保证人脸注册图片的质量。Demo中提供了`RgbDetectActivity`，该`Activity`在屏幕上指定了一定的区域，要求用户在屏幕中央，脸正对着摄像头。如果用户的姿势达不到要求，会提示用户，直到符合要求为止。

![img](https://ai.bdstatic.com/file/FE163507AFF14788A04A36D232123956)

下面的代码片段是：检测人脸过程中，根据检测结果值，提示用户进行调整，从而得到高质量的照片。

![img](https://ai.bdstatic.com/file/71651FB7D9FD437F88D84FC1B25726D1)

**2.3.7.2 通过相册获取需要注册的人脸图片**

![img](https://ai.bdstatic.com/file/ED4BC39410F44C518BB6C2C39F03A5E0)

**2.3.7.3 注册人脸到本地人脸库**

![img](https://ai.bdstatic.com/file/9E934790B0FA4D63A80F2ACA7C912445)

### 2.3.8 人脸对比（图片vs图片）

**2.3.8.1 从相册里选择两张图片进行对比**

此种方法无需使用人脸采集及活体等功能。

> 注意：SDK要求图片人脸朝上才能检测人脸.

**2.3.8.2 从视频流中采集两张人脸图片进行对比**

此种方式的人脸图片需要从视频流中实时采集，如果为无人值守情况，还需配备活体检测以保障业务安全。`ImageMacthImageActivity`根据活体策略选择相应的实现，开发者可以根据实际使用的硬件进行选择。

1）获取人脸，可选择一下5种方式返回人脸

- RgbDetectActivity：无活体或RGB活体（活体检测成功后，返回检测到的人脸）
- RgbIrLivenessActivity：进行RGB+NIR活体成功后返回检测到RGB人脸
- OrbbecLivenessDetectActivity：进行RGB+Depth活体成功后返回检测到RGB人脸
- OrbbecProLivenessDetectActivity：进行RGB+Depth活体成功后返回检测到RGB人脸（奥比中光Pro）
- IminectLivenessDetectActivity：进行RGB+Depth活体成功后返回检测到RGB人脸（华捷艾米）

![img](https://ai.baidu.com/file/5D53BEBD63024BBFA4024AEA06AD4A56)

2）根据返回人脸抽取特征

![img](https://ai.bdstatic.com/file/77A06EC93A3B43F7B2B1D5F82DA20878)

3）比对两张人脸图片

![img](https://ai.bdstatic.com/file/30B50F5B405249DEA50139E315C8AE12)

### 2.3.9 人脸对比（视频流vs图片）

您可以根据实际硬件选择活体策略，有下面几种实现：

- VideoMatchImageActivity 无活体或rgb活体
- RgbIrVideoMatchImageActivity rgb+ir活体
- OrbbecVideoMatchImageActivity rgb+depth活体
- IminectVideoMatchImageActivity rgb+depth活体

**2.3.9.1 VideoMatchImageActivity实现**

1）加载一张图片进行人脸检测、特征抽取，待和视频流比对

![img](https://ai.bdstatic.com/file/54652A9F5F184969B43C3E8EA9C9331A)

2）初始化视频流检测

![img](https://ai.bdstatic.com/file/87B1E8257A9741A38F977295529C866D)

3）选择摄像头类型

![img](https://ai.bdstatic.com/file/0CEDC312746349A68103E45ECC8308AD)

4）设置视频流人脸检测回调，在回调进行比对

![img](https://ai.bdstatic.com/file/A10BA6133E9248DD81FAB6345DE86413)

5）视频流与图片人脸比对

![img](https://ai.bdstatic.com/file/A9ACBE497FE747B8AA7CB14DF7E93E84)

**2.3.9.2 RgbIrVideoMatchImageActivity实现**

1）加载一张图片进行人脸检测、特征抽取，待和视频流比对（与VideoMatchImageActivity实现相同）

2）初始化视频流：RGB+NIR双目摄像头通过系统api出来的视频流都是yuv420数据，需要区分出RGB还是NIR数据。通过选取一点数量点的取平均值比较，大的为RGB，小的为NIR。

![img](https://ai.bdstatic.com/file/A01F9C00B1714AC0B29C8AEC352F21AB)

3）人脸检测+活体检测

![img](https://ai.bdstatic.com/file/E0429B1182D04018AF0B8D964AB86793)

![img](https://ai.bdstatic.com/file/E545B614BE7B4658865E39F81CD19D97)

4）视频流与图片人脸比对（与VideoMatchImageActivity实现相同）

**2.3.9.3 OrbbecVideoMatchImageActivity实现**

1）加载一张图片进行人脸检测、特征抽取，待和视频流比对（与VideoMatchImageActivity实现相同）

2）初始化视频流+人脸检测+活体：采用奥比中光双目摄像头，Depth数据为16位数据

![img](https://ai.baidu.com/file/BE3E2E4E5EF440A09C7EB42EFE51C1C1)

![img](https://ai.baidu.com/file/EC02E15EFFD945BBB2015CD133126390)

3）视频流与图片人脸比对（与VideoMatchImageActivity实现相同）

**2.3.9.4 IminectVideoMatchImageActivity实现**

1）加载一张图片进行人脸检测、特征抽取，待和视频流比对（与VideoMatchImageActivity实现相同）

2）初始化视频流+人脸检测+活体：采用华捷艾米双目摄像头，Depth数据为16位数据

![img](https://ai.baidu.com/file/EDAC32D1A6224027B5E6439325FD5A1D)

3）视频流与图片人脸比对（与VideoMatchImageActivity实现相同）

### 2.3.10 人脸搜索（视频流vs人脸库）

您可以根据实际硬件选择活体策略，有下面几种实现：

- VideoIdentityActivity无活体或rgb活体
- RgbIrVideoIdentiffyActivity rgb+ir活体
- OrbbecIdentifyImageActivity rgb+depth活体
- IminectVideoIdentifyActivity rgb+depth活体

**2.3.10.1 VideoIdentityActivity实现**

1）加载人脸库

![img](https://ai.bdstatic.com/file/0E266B73F9D34E54B3B65A4DB4A62772)

2）初始化视频流人脸检测

![img](https://ai.bdstatic.com/file/A2F2F9345E25492E813F9E5D628CC59D)

3）摄像头类型设置

`previewView.getTextureView().setScaleX(-1);` 设置视频镜像，当人脸框和人脸出现镜像时

![img](https://ai.bdstatic.com/file/F556A815871948729A0CBD1606FBE6A6)

4）添加视频流人脸检测回调

![img](https://ai.bdstatic.com/file/2AE309B7D40242E68AEF5BBF8D493DCC)

5）开启视频人脸检测

![img](https://ai.bdstatic.com/file/4A1CAF0445834F1A9B0615C9FE984C58)

6）视频流与人脸库比对（1：N）

![img](https://ai.bdstatic.com/file/63EDAC2EBAA44F0F8309D70E656ADB56)

**2.3.10.2 RgbIrVideoIdentityActivity实现**

1）加载人脸库（与VideoIdentityActivity实现相同）

2）初始化视频流：RGB+NIR双目摄像头通过系统api出来的视频流都是yuv420数据，需要区分出RGB还是NIR数据。通过选取一点数量点的取平均值比较，大的为RGB，小的为NIR。

![img](https://ai.bdstatic.com/file/030951A70917497F9774D5EE1F887B58)

3）人脸检测+活体判断

![img](https://ai.bdstatic.com/file/477A5FAE2CE44F1B8811E1F2B94463B2)

4）视频流与人脸库比对（1：N）（与VideoIdentityActivity实现相同）

**2.3.10.3 OrbbecVideoIdentifyActivity实现**

1）加载人脸库（与VideoIdentityActivity实现相同）

2）初始化视频流+人脸检测+活体：采用奥比中光双目摄像头，Depth数据为16位数据

![img](https://ai.baidu.com/file/B96EF6372E2B495883D5008F566EAAAE)

![img](https://ai.baidu.com/file/EC02E15EFFD945BBB2015CD133126390)

3）视频流与人脸库比对（1：n）（与VideoIdentityActivity实现相同）

**2.3.10.4 IminectVideoIdentifyActivity实现**

1）加载人脸库（与VideoIdentityActivity实现相同）

2）初始化视频流+人脸检测+活体：采用华捷艾米双目摄像头，Depth数据为16位数据

![img](https://ai.baidu.com/file/EDAC32D1A6224027B5E6439325FD5A1D)

3）视频流与人脸库比对（1：n）（与VideoIdentityActivity实现相同）

## 2.4 核心类

### 2.4.1 FaceSDKManager

- 功能：**负责授权激活、初始检测类FaceDetector、FaceFeature、FaceLiveness**
- 位于：`com.baidu.aip.manager`

### 2.4.2 FaceDetector

- 功能：**人脸检测封装类，包含人脸检测功能初始化、人脸检测接口调用**
- 位于：`com.baidu.aip.manager`

### 2.4.3 FaceFeature

- 功能：**人脸特征抽取封装类，包含人脸特征抽取功能初始化、人脸特征抽取接口调用**
- 位于：`com.baidu.aip.manager`

### 2.4.4 FaceLiveness

- 功能：**人脸活体相关操作封装类，包含人脸rgb、ir、depth活体检测**
- 位于：`com.baidu.aip.manager`

### 2.4.5 FaceEnvironment

- 功能：**人脸配置相关操作封装类，包含人脸检测的相关参数及默认值**
- 位于：`com.baidu.aip.manager`

### 2.4.6 FaceDetectManager

- 功能：**人脸图片和视频人脸检测封装类，可以接受CameraImageSource和FileImageSource源**
- 位于：`com.baidu.aip.face`

# 3、常见问题

**Q：提示硬件指纹变化，导致激活失效？**
A：v1.0.1版本以上的SDK，已经修复了硬件指纹变化问题。但由于硬件本身的多样化原因，可能某些情况下，仍会导致指纹变化。

**Q：哪些情况可能导致指纹变化？**
A：刷机、更换硬件设备将会导致指纹变化。但安卓系统升级、APP卸载重装、恢复系统出厂值并不会导致硬件指纹变化。

**Q：同一台设备可以被多个序列号多次激活么？**
A：可以。一台设备可以被多个序列号激活，没有限制。

**Q：调用getFeature接口对图片进行特征提取，经常会出现特征提取失败的情况，错误码为6。**
A：主要可能为在人脸检测的过程中没有检测到人脸，建议调整设置下人脸的大小`set_min_face_size`的值。

**Q：视频流人脸检测和图片检测是否可以同时或间隔进行？**
A：人脸SDK为单例，同一时间只能进行一个图像源。另外进行人脸检测具体追踪功能，视频流进行检测时，不能插入其他图像帧。想`VideoMatchImageActivity`、`RgbIrVideoMatchImageActivity`、`OrbbecVideoMatchImageActivity`，需要先把图片进行人脸检测后，在把打开视频流检测。中间需要使用`FaceSDKManager.getInstance().getFaceDetector().clearTrackedFaces();`清除数据

**Q：人脸检测检测不到人脸？**
A：人脸SDK检测需要传入检测的人脸图片是人脸朝上，预览和实际传给SDK检测的图片方向不一定相同，需要把实际检测的数据转成（**argb->bitmap**）图片，显示确定人脸是否朝上。

**Q：如何调整人脸检测识别距离，以及调节检测的最小人脸？**
A：主要方法有三种，详情如下：

1. 调整`FaceDetector`初始化时最小检测人脸大小（FaceEnvironment VALUE_MIN_FACE_SIZE = 100;），可选范围为：50~200（50*50px-200*200px），最小检测人脸越小，能检测到人脸越小。最小检测人脸越小，性能消耗越大。
2. 调整人脸检测传入的图像分辨率，分辨率越大，能检测越越远。鉴于目前端设备性能，建议选择640*480，1280*720。分辨率越大，性能消耗越大。
3. 选择更大焦距的摄像头，相当于把人脸拉近。同样距离，大焦距的镜头，图像视觉越小，人脸占比越大。通常USB摄像头为3mm、6mm焦距。对性能影响小，调整人脸检测距离明显。

**Q：人脸检测返回值问题？**
A：一般反馈OK(0)表示检测到合格的人脸，当传入检测数据间隔时间较长上，超过了追踪的时间，会返回DATA_HIT_LAST(9)。所有返回9也是检测到了合格的人脸，如下所示：

```
public static enum ErrCode {
    OK,
    PITCH_OUT_OF_DOWN_MAX_RANGE,
    PITCH_OUT_OF_UP_MAX_RANGE,
    YAW_OUT_OF_LEFT_MAX_RANGE,
    YAW_OUT_OF_RIGHT_MAX_RANGE,
    POOR_ILLUMINATION,
    NO_FACE_DETECTED,
    DATA_NOT_READY,
    DATA_HIT_ONE,
    DATA_HIT_LAST,
    IMG_BLURED,
    OCCLUSION_LEFT_EYE,
    OCCLUSION_RIGHT_EYE,
    OCCLUSION_NOSE,
    OCCLUSION_MOUTH,
    OCCLUSION_LEFT_CONTOUR,
    OCCLUSION_RIGHT_CONTOUR,
    OCCLUSION_CHIN_CONTOUR,
    FACE_NOT_COMPLETE,
    UNKNOW_TYPE;

    private ErrCode() {
    }
}
```

**Q：授权失败？**
A：一个序列号只能对应一台设备，一个设备可以绑定多个序列号，测试期间的序列号有使用时间，会过期，过期后需要到AI平台上进行延期，正式使用的序列号是永久授权的。授权不过，人脸SDK将无法返回正确结果。

**Q：so加载问题？**
A：很多开发者反馈找不到so库，原因是前面只提供了`armeabi-v7a`的库，但开发者基本加了其他第三方的库`arm64-v8a`、`armeabi`、`armeabi-v7a`和`x86`等都加进去了。so的加载原理是先加载当前CPU对应的so库，比如64位的手机会先加载`arm64-v8a`，只有在没有`arm64-v8a`目录才会去其他目录（如`armeabi-v7a`）下找，所有就算只留个空`arm64-v8a`目录也不行，因为这样他只会在`arm64-v8a`目录下找，这就要求每个目录下的so齐全一致。同时也不能把`armeabi-v7a`里面的so拷到其他目录，不要看名字一样。同时加入`arm64-v8a`和`armeabi-v7a`库。这样会导致打出来的包大不少。所以如果觉的包太大，只留`armeabi-v7a`是可以，他兼容其他cpu架构。**注意：aar里面可能包含so，注意检查。**