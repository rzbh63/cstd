
# Python和PyTorch对比实现卷积convolution函数及反向传播 - BrightLamp的博客 - CSDN博客


2018年11月28日 17:56:02[BrightLampCsdn](https://me.csdn.net/oBrightLamp)阅读数：316所属专栏：



## 摘要
本文使用纯 Python 和 PyTorch 对比实现 convolution 函数及其反向传播.
## 相关
*原理和详细解释, 请参考文章 :*
卷积convolution函数详解及反向传播中的梯度求导
*系列文章索引 :*
[https://blog.csdn.net/oBrightLamp/article/details/85067981](https://blog.csdn.net/oBrightLamp/article/details/85067981)
## 正文
```python
import
```
```python
torch
```
```python
import
```
```python
numpy
```
```python
as
```
```python
np
```
```python
class
```
```python
Conv2d
```
```python
:
```
```python
def
```
```python
__init__
```
```python
(
```
```python
self
```
```python
,
```
```python
stride
```
```python
=
```
```python
1
```
```python
)
```
```python
:
```
```python
self
```
```python
.
```
```python
weight
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
bias
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
stride
```
```python
=
```
```python
stride
        self
```
```python
.
```
```python
x
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
dw
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
db
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
input_height
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
input_width
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
weight_height
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
weight_width
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
output_height
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
output_width
```
```python
=
```
```python
None
```
```python
def
```
```python
__call__
```
```python
(
```
```python
self
```
```python
,
```
```python
x
```
```python
)
```
```python
:
```
```python
self
```
```python
.
```
```python
x
```
```python
=
```
```python
x
        self
```
```python
.
```
```python
input_height
```
```python
=
```
```python
np
```
```python
.
```
```python
shape
```
```python
(
```
```python
x
```
```python
)
```
```python
[
```
```python
0
```
```python
]
```
```python
self
```
```python
.
```
```python
input_width
```
```python
=
```
```python
np
```
```python
.
```
```python
shape
```
```python
(
```
```python
x
```
```python
)
```
```python
[
```
```python
1
```
```python
]
```
```python
self
```
```python
.
```
```python
weight_height
```
```python
=
```
```python
np
```
```python
.
```
```python
shape
```
```python
(
```
```python
self
```
```python
.
```
```python
weight
```
```python
)
```
```python
[
```
```python
0
```
```python
]
```
```python
self
```
```python
.
```
```python
weight_width
```
```python
=
```
```python
np
```
```python
.
```
```python
shape
```
```python
(
```
```python
self
```
```python
.
```
```python
weight
```
```python
)
```
```python
[
```
```python
1
```
```python
]
```
```python
self
```
```python
.
```
```python
output_height
```
```python
=
```
```python
int
```
```python
(
```
```python
(
```
```python
self
```
```python
.
```
```python
input_height
```
```python
-
```
```python
self
```
```python
.
```
```python
weight_height
```
```python
)
```
```python
/
```
```python
self
```
```python
.
```
```python
stride
```
```python
)
```
```python
+
```
```python
1
```
```python
self
```
```python
.
```
```python
output_width
```
```python
=
```
```python
int
```
```python
(
```
```python
(
```
```python
self
```
```python
.
```
```python
input_width
```
```python
-
```
```python
self
```
```python
.
```
```python
weight_width
```
```python
)
```
```python
/
```
```python
self
```
```python
.
```
```python
stride
```
```python
)
```
```python
+
```
```python
1
```
```python
out
```
```python
=
```
```python
np
```
```python
.
```
```python
zeros
```
```python
(
```
```python
(
```
```python
self
```
```python
.
```
```python
output_height
```
```python
,
```
```python
self
```
```python
.
```
```python
output_width
```
```python
)
```
```python
)
```
```python
for
```
```python
i
```
```python
in
```
```python
range
```
```python
(
```
```python
self
```
```python
.
```
```python
output_height
```
```python
)
```
```python
:
```
```python
for
```
```python
j
```
```python
in
```
```python
range
```
```python
(
```
```python
self
```
```python
.
```
```python
output_width
```
```python
)
```
```python
:
```
```python
for
```
```python
r
```
```python
in
```
```python
range
```
```python
(
```
```python
self
```
```python
.
```
```python
weight_height
```
```python
)
```
```python
:
```
```python
for
```
```python
s
```
```python
in
```
```python
range
```
```python
(
```
```python
self
```
```python
.
```
```python
weight_width
```
```python
)
```
```python
:
```
```python
out
```
```python
[
```
```python
i
```
```python
,
```
```python
j
```
```python
]
```
```python
+=
```
```python
x
```
```python
[
```
```python
i
```
```python
*
```
```python
self
```
```python
.
```
```python
stride
```
```python
+
```
```python
r
```
```python
,
```
```python
j
```
```python
*
```
```python
self
```
```python
.
```
```python
stride
```
```python
+
```
```python
s
```
```python
]
```
```python
*
```
```python
self
```
```python
.
```
```python
weight
```
```python
[
```
```python
r
```
```python
,
```
```python
s
```
```python
]
```
```python
out
```
```python
=
```
```python
out
```
```python
+
```
```python
self
```
```python
.
```
```python
bias
```
```python
return
```
```python
out
```
```python
def
```
```python
backward
```
```python
(
```
```python
self
```
```python
,
```
```python
d_loss
```
```python
)
```
```python
:
```
```python
dx
```
```python
=
```
```python
np
```
```python
.
```
```python
zeros_like
```
```python
(
```
```python
self
```
```python
.
```
```python
x
```
```python
)
```
```python
self
```
```python
.
```
```python
dw
```
```python
=
```
```python
np
```
```python
.
```
```python
zeros_like
```
```python
(
```
```python
self
```
```python
.
```
```python
weight
```
```python
)
```
```python
self
```
```python
.
```
```python
db
```
```python
=
```
```python
np
```
```python
.
```
```python
zeros_like
```
```python
(
```
```python
self
```
```python
.
```
```python
bias
```
```python
)
```
```python
for
```
```python
i
```
```python
in
```
```python
range
```
```python
(
```
```python
self
```
```python
.
```
```python
output_height
```
```python
)
```
```python
:
```
```python
for
```
```python
j
```
```python
in
```
```python
range
```
```python
(
```
```python
self
```
```python
.
```
```python
output_width
```
```python
)
```
```python
:
```
```python
start_i
```
```python
=
```
```python
i
```
```python
*
```
```python
self
```
```python
.
```
```python
stride
                start_j
```
```python
=
```
```python
j
```
```python
*
```
```python
self
```
```python
.
```
```python
stride
                end_i
```
```python
=
```
```python
start_i
```
```python
+
```
```python
self
```
```python
.
```
```python
weight_height
                end_j
```
```python
=
```
```python
start_j
```
```python
+
```
```python
self
```
```python
.
```
```python
weight_width
                dx
```
```python
[
```
```python
start_i
```
```python
:
```
```python
end_i
```
```python
,
```
```python
start_j
```
```python
:
```
```python
end_j
```
```python
]
```
```python
+=
```
```python
d_loss
```
```python
[
```
```python
i
```
```python
,
```
```python
j
```
```python
]
```
```python
*
```
```python
self
```
```python
.
```
```python
weight
```
```python
for
```
```python
u
```
```python
in
```
```python
range
```
```python
(
```
```python
self
```
```python
.
```
```python
weight_height
```
```python
)
```
```python
:
```
```python
for
```
```python
v
```
```python
in
```
```python
range
```
```python
(
```
```python
self
```
```python
.
```
```python
weight_width
```
```python
)
```
```python
:
```
```python
self
```
```python
.
```
```python
dw
```
```python
[
```
```python
u
```
```python
,
```
```python
v
```
```python
]
```
```python
+=
```
```python
d_loss
```
```python
[
```
```python
i
```
```python
,
```
```python
j
```
```python
]
```
```python
*
```
```python
self
```
```python
.
```
```python
x
```
```python
[
```
```python
start_i
```
```python
+
```
```python
u
```
```python
,
```
```python
start_j
```
```python
+
```
```python
v
```
```python
]
```
```python
self
```
```python
.
```
```python
db
```
```python
=
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
d_loss
```
```python
)
```
```python
return
```
```python
dx

np
```
```python
.
```
```python
set_printoptions
```
```python
(
```
```python
precision
```
```python
=
```
```python
8
```
```python
,
```
```python
suppress
```
```python
=
```
```python
True
```
```python
,
```
```python
linewidth
```
```python
=
```
```python
120
```
```python
)
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
seed
```
```python
(
```
```python
123
```
```python
)
```
```python
torch
```
```python
.
```
```python
random
```
```python
.
```
```python
manual_seed
```
```python
(
```
```python
123
```
```python
)
```
```python
x_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
1
```
```python
,
```
```python
3
```
```python
,
```
```python
5
```
```python
,
```
```python
5
```
```python
)
```
```python
)
```
```python
x_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
x_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
conv2d_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
nn
```
```python
.
```
```python
Conv2d
```
```python
(
```
```python
3
```
```python
,
```
```python
1
```
```python
,
```
```python
(
```
```python
3
```
```python
,
```
```python
3
```
```python
)
```
```python
,
```
```python
stride
```
```python
=
```
```python
2
```
```python
)
```
```python
.
```
```python
double
```
```python
(
```
```python
)
```
```python
conv2d_numpy_channel_0
```
```python
=
```
```python
Conv2d
```
```python
(
```
```python
stride
```
```python
=
```
```python
2
```
```python
)
```
```python
conv2d_numpy_channel_0
```
```python
.
```
```python
weight
```
```python
=
```
```python
conv2d_tensor
```
```python
.
```
```python
weight
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
[
```
```python
0
```
```python
,
```
```python
0
```
```python
]
```
```python
conv2d_numpy_channel_0
```
```python
.
```
```python
bias
```
```python
=
```
```python
conv2d_tensor
```
```python
.
```
```python
bias
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
[
```
```python
0
```
```python
]
```
```python
conv2d_numpy_channel_1
```
```python
=
```
```python
Conv2d
```
```python
(
```
```python
stride
```
```python
=
```
```python
2
```
```python
)
```
```python
conv2d_numpy_channel_1
```
```python
.
```
```python
weight
```
```python
=
```
```python
conv2d_tensor
```
```python
.
```
```python
weight
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
[
```
```python
0
```
```python
,
```
```python
1
```
```python
]
```
```python
conv2d_numpy_channel_1
```
```python
.
```
```python
bias
```
```python
=
```
```python
conv2d_tensor
```
```python
.
```
```python
bias
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
[
```
```python
0
```
```python
]
```
```python
conv2d_numpy_channel_2
```
```python
=
```
```python
Conv2d
```
```python
(
```
```python
stride
```
```python
=
```
```python
2
```
```python
)
```
```python
conv2d_numpy_channel_2
```
```python
.
```
```python
weight
```
```python
=
```
```python
conv2d_tensor
```
```python
.
```
```python
weight
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
[
```
```python
0
```
```python
,
```
```python
2
```
```python
]
```
```python
conv2d_numpy_channel_2
```
```python
.
```
```python
bias
```
```python
=
```
```python
conv2d_tensor
```
```python
.
```
```python
bias
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
[
```
```python
0
```
```python
]
```
```python
out_numpy_0
```
```python
=
```
```python
conv2d_numpy_channel_0
```
```python
(
```
```python
x_numpy
```
```python
[
```
```python
0
```
```python
,
```
```python
0
```
```python
]
```
```python
)
```
```python
out_numpy_1
```
```python
=
```
```python
conv2d_numpy_channel_1
```
```python
(
```
```python
x_numpy
```
```python
[
```
```python
0
```
```python
,
```
```python
1
```
```python
]
```
```python
)
```
```python
out_numpy_2
```
```python
=
```
```python
conv2d_numpy_channel_2
```
```python
(
```
```python
x_numpy
```
```python
[
```
```python
0
```
```python
,
```
```python
2
```
```python
]
```
```python
)
```
```python
out_numpy
```
```python
=
```
```python
out_numpy_0
```
```python
+
```
```python
out_numpy_1
```
```python
+
```
```python
out_numpy_2
```
```python
-
```
```python
conv2d_numpy_channel_0
```
```python
.
```
```python
bias
```
```python
*
```
```python
2
```
```python
out_tensor
```
```python
=
```
```python
conv2d_tensor
```
```python
(
```
```python
x_tensor
```
```python
)
```
```python
d_loss_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
out_tensor
```
```python
.
```
```python
shape
```
```python
)
```
```python
d_loss_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
d_loss_numpy
```
```python
)
```
```python
dx_numpy_0
```
```python
=
```
```python
conv2d_numpy_channel_0
```
```python
.
```
```python
backward
```
```python
(
```
```python
d_loss_numpy
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
0
```
```python
]
```
```python
)
```
```python
dx_numpy_1
```
```python
=
```
```python
conv2d_numpy_channel_1
```
```python
.
```
```python
backward
```
```python
(
```
```python
d_loss_numpy
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
0
```
```python
]
```
```python
)
```
```python
dx_numpy_2
```
```python
=
```
```python
conv2d_numpy_channel_2
```
```python
.
```
```python
backward
```
```python
(
```
```python
d_loss_numpy
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
0
```
```python
]
```
```python
)
```
```python
out_tensor
```
```python
.
```
```python
backward
```
```python
(
```
```python
d_loss_tensor
```
```python
)
```
```python
dx_tensor
```
```python
=
```
```python
x_tensor
```
```python
.
```
```python
grad
dw_numpy_0
```
```python
=
```
```python
conv2d_numpy_channel_0
```
```python
.
```
```python
dw
dw_numpy_1
```
```python
=
```
```python
conv2d_numpy_channel_1
```
```python
.
```
```python
dw
dw_numpy_2
```
```python
=
```
```python
conv2d_numpy_channel_2
```
```python
.
```
```python
dw
dw_tensor
```
```python
=
```
```python
conv2d_tensor
```
```python
.
```
```python
weight
```
```python
.
```
```python
grad
db_numpy
```
```python
=
```
```python
conv2d_numpy_channel_0
```
```python
.
```
```python
db
db_tensor
```
```python
=
```
```python
conv2d_tensor
```
```python
.
```
```python
bias
```
```python
.
```
```python
grad
```
```python
print
```
```python
(
```
```python
"out_numpy \n"
```
```python
,
```
```python
out_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
"out_tensor \n"
```
```python
,
```
```python
out_tensor
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"dx_numpy_0 \n"
```
```python
,
```
```python
dx_numpy_0
```
```python
)
```
```python
print
```
```python
(
```
```python
"dx_numpy_1 \n"
```
```python
,
```
```python
dx_numpy_1
```
```python
)
```
```python
print
```
```python
(
```
```python
"dx_numpy_2 \n"
```
```python
,
```
```python
dx_numpy_2
```
```python
)
```
```python
print
```
```python
(
```
```python
"dx_tensor \n"
```
```python
,
```
```python
dx_tensor
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"dw_numpy_0 \n"
```
```python
,
```
```python
dw_numpy_0
```
```python
)
```
```python
print
```
```python
(
```
```python
"dw_numpy_1 \n"
```
```python
,
```
```python
dw_numpy_1
```
```python
)
```
```python
print
```
```python
(
```
```python
"dw_numpy_2 \n"
```
```python
,
```
```python
dw_numpy_2
```
```python
)
```
```python
print
```
```python
(
```
```python
"dw_tensor \n"
```
```python
,
```
```python
dw_tensor
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"db_numpy \n"
```
```python
,
```
```python
db_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
"db_tensor \n"
```
```python
,
```
```python
db_tensor
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
[
```
```python
0
```
```python
]
```
```python
)
```
```python
"""
代码输出 :
out_numpy 
 [[-0.01129476 -0.12804462]
 [-0.04662733 -0.12602237]]
out_tensor 
 [[[[-0.01129476 -0.12804462]
   [-0.04662733 -0.12602237]]]]
dx_numpy_0 
 [[-0.04664896  0.0037894  -0.10051156  0.00354941 -0.05321863]
 [ 0.04314122 -0.09747379  0.1242681  -0.09130056  0.07854812]
 [-0.09562402 -0.08993824 -0.17737642 -0.08421562 -0.08233961]
 [ 0.01153658 -0.0260659   0.03353431 -0.02510021  0.02159433]
 [-0.02223535 -0.02432176 -0.04074214 -0.02342069 -0.0186144 ]]
dx_numpy_1 
 [[ 0.05181031 -0.04226934  0.09133848 -0.03959233  0.04009821]
 [-0.09709334 -0.06940826 -0.13294859 -0.06501248 -0.03934415]
 [-0.00862673 -0.09857383  0.07863871 -0.09262803  0.08118677]
 [-0.02596416 -0.01856077 -0.03623482 -0.01787313 -0.01081643]
 [-0.00601189 -0.02333736  0.01424206 -0.02247276  0.01928911]]
dx_numpy_2 
 [[-0.02697872  0.03672051  0.05562605  0.03439492  0.07577281]
 [ 0.02131312  0.03128234  0.13038743  0.02930116  0.10343071]
 [-0.05880928  0.04605546 -0.08453932  0.04339676 -0.02684292]
 [ 0.00569944  0.00836535  0.03501728  0.00805543  0.02843501]
 [-0.01379719  0.00968999 -0.02689682  0.009331   -0.01310653]]
dx_tensor 
 [[[[-0.04664896  0.0037894  -0.10051156  0.00354941 -0.05321863]
   [ 0.04314122 -0.09747379  0.1242681  -0.09130056  0.07854812]
   [-0.09562402 -0.08993824 -0.17737642 -0.08421562 -0.08233961]
   [ 0.01153658 -0.0260659   0.03353431 -0.02510021  0.02159433]
   [-0.02223535 -0.02432176 -0.04074214 -0.02342069 -0.0186144 ]]
  [[ 0.05181031 -0.04226934  0.09133848 -0.03959233  0.04009821]
   [-0.09709334 -0.06940826 -0.13294859 -0.06501248 -0.03934415]
   [-0.00862673 -0.09857383  0.07863871 -0.09262803  0.08118677]
   [-0.02596416 -0.01856077 -0.03623482 -0.01787313 -0.01081643]
   [-0.00601189 -0.02333736  0.01424206 -0.02247276  0.01928911]]
  [[-0.02697872  0.03672051  0.05562605  0.03439492  0.07577281]
   [ 0.02131312  0.03128234  0.13038743  0.02930116  0.10343071]
   [-0.05880928  0.04605546 -0.08453932  0.04339676 -0.02684292]
   [ 0.00569944  0.00836535  0.03501728  0.00805543  0.02843501]
   [-0.01379719  0.00968999 -0.02689682  0.009331   -0.01310653]]]]
dw_numpy_0 
 [[ 0.66199495  0.60207865  0.66608153]
 [ 0.776979    0.96114693  0.73470673]
 [ 0.65992339  0.69515322  0.70807041]]
dw_numpy_1 
 [[ 0.50545913  0.59089005  0.70583433]
 [ 0.44239851  0.61455868  0.67625654]
 [ 0.87371632  0.93543194  1.06095454]]
dw_numpy_2 
 [[ 0.60952866  0.99110438  0.77759622]
 [ 0.61064005  0.88645726  0.8155419 ]
 [ 0.85702622  0.97542119  0.94264254]]
dw_tensor 
 [[[[ 0.66199495  0.60207865  0.66608153]
   [ 0.776979    0.96114693  0.73470673]
   [ 0.65992339  0.69515322  0.70807041]]
  [[ 0.50545913  0.59089005  0.70583433]
   [ 0.44239851  0.61455868  0.67625654]
   [ 0.87371632  0.93543194  1.06095454]]
  [[ 0.60952866  0.99110438  0.77759622]
   [ 0.61064005  0.88645726  0.8155419 ]
   [ 0.85702622  0.97542119  0.94264254]]]]
db_numpy 
 1.46324723111
db_tensor 
 1.46324723111
"""
```
全文完

