
# PyTorch Kaggle 快速上手(杂草幼苗图片识别) - BrightLamp的博客 - CSDN博客


2018年12月10日 22:51:05[BrightLampCsdn](https://me.csdn.net/oBrightLamp)阅读数：208



## 摘要
原文是我在[www.kaggle.com](http://www.kaggle.com)做的一个示例.
地址:[https://www.kaggle.com/brightlamp/pytorch-kaggle-quick-qtart-guide-on-plantseedlings](https://www.kaggle.com/brightlamp/pytorch-kaggle-quick-qtart-guide-on-plantseedlings)
搬运到这里, 顺便做一点基础汉化.
## 相关
这是系列文章中的其中一篇.
系列文章索引 :
[https://blog.csdn.net/oBrightLamp/article/details/85067981](https://blog.csdn.net/oBrightLamp/article/details/85067981)
## 正文
首先, 需要打开 Kaggle 的 GPU 实例.
导入标准包.
```python
# First, Please turn on the GPU on Kaggle.
```
```python
import
```
```python
os
```
```python
import
```
```python
time
```
```python
import
```
```python
shutil
```
```python
import
```
```python
numpy
```
```python
as
```
```python
np
```
```python
import
```
```python
pandas
```
```python
as
```
```python
pd
```
```python
from
```
```python
tqdm
```
```python
import
```
```python
tqdm
```
```python
import
```
```python
torch
```
```python
import
```
```python
torchvision
```
```python
from
```
```python
torchvision
```
```python
.
```
```python
datasets
```
```python
import
```
```python
ImageFolder
```
```python
%
```
```python
matplotlib inline
if_gpu
```
```python
=
```
```python
torch
```
```python
.
```
```python
cuda
```
```python
.
```
```python
is_available
```
```python
(
```
```python
)
```
```python
print
```
```python
(
```
```python
"GPU is on?"
```
```python
,
```
```python
if_gpu
```
```python
)
```
查看 Kaggle 的 input 文件夹的相关信息.
Kaggle 的 input 文件夹是只读的, 包含相关的数据集.
```python
# Show some information of Kaggle's input folder.
```
```python
print
```
```python
(
```
```python
os
```
```python
.
```
```python
listdir
```
```python
(
```
```python
"../"
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
os
```
```python
.
```
```python
listdir
```
```python
(
```
```python
"../input"
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
os
```
```python
.
```
```python
listdir
```
```python
(
```
```python
"../input/train"
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
os
```
```python
.
```
```python
listdir
```
```python
(
```
```python
"../input/test"
```
```python
)
```
```python
[
```
```python
:
```
```python
6
```
```python
]
```
```python
)
```
PyTorch 的 ImageFolder() 图片读取工具类需要目标文件夹包含子目录.
但 Kaggle 的 Plant Seedlings Classification 比赛中默认的 input 文件夹中, test 图片文件夹并没有子目录.
使用 shutil.copytree() 工具将 test 文件夹拷贝到一个临时文件夹.
```python
# ImageFolder() needs subfolders.
```
```python
# Copy test images of input to temporary folder to avoid train images.
```
```python
def
```
```python
copytree_and_overwrite
```
```python
(
```
```python
from_path
```
```python
,
```
```python
to_path
```
```python
)
```
```python
:
```
```python
if
```
```python
os
```
```python
.
```
```python
path
```
```python
.
```
```python
exists
```
```python
(
```
```python
to_path
```
```python
)
```
```python
:
```
```python
shutil
```
```python
.
```
```python
rmtree
```
```python
(
```
```python
to_path
```
```python
)
```
```python
shutil
```
```python
.
```
```python
copytree
```
```python
(
```
```python
from_path
```
```python
,
```
```python
to_path
```
```python
)
```
```python
return
```
```python
True
```
```python
copytree_and_overwrite
```
```python
(
```
```python
"../input/test"
```
```python
,
```
```python
"../working/tmp/test/test_images"
```
```python
)
```
```python
print
```
```python
(
```
```python
os
```
```python
.
```
```python
listdir
```
```python
(
```
```python
"../working/tmp/test/test_images"
```
```python
)
```
```python
[
```
```python
:
```
```python
6
```
```python
]
```
```python
)
```
本示例打算使用 AlexNet, 需要将图片缩放至标准的 224x224 像素.
```python
# Read and resize images to [224, 224].
```
```python
def
```
```python
read_image_folder
```
```python
(
```
```python
resize_shape
```
```python
,
```
```python
image_folder
```
```python
)
```
```python
:
```
```python
resize
```
```python
=
```
```python
torchvision
```
```python
.
```
```python
transforms
```
```python
.
```
```python
Resize
```
```python
(
```
```python
resize_shape
```
```python
)
```
```python
image_folder
```
```python
=
```
```python
ImageFolder
```
```python
(
```
```python
image_folder
```
```python
,
```
```python
transform
```
```python
=
```
```python
resize
```
```python
)
```
```python
idx_to_class
```
```python
=
```
```python
{
```
```python
value
```
```python
:
```
```python
key
```
```python
for
```
```python
key
```
```python
,
```
```python
value
```
```python
in
```
```python
image_folder
```
```python
.
```
```python
class_to_idx
```
```python
.
```
```python
items
```
```python
(
```
```python
)
```
```python
}
```
```python
image_paths
```
```python
=
```
```python
[
```
```python
item
```
```python
[
```
```python
0
```
```python
]
```
```python
for
```
```python
item
```
```python
in
```
```python
image_folder
```
```python
.
```
```python
imgs
```
```python
]
```
```python
image_shape
```
```python
=
```
```python
np
```
```python
.
```
```python
array
```
```python
(
```
```python
image_folder
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
0
```
```python
]
```
```python
)
```
```python
.
```
```python
shape
    data_length
```
```python
=
```
```python
len
```
```python
(
```
```python
image_folder
```
```python
)
```
```python
data_shape
```
```python
=
```
```python
list
```
```python
(
```
```python
image_shape
```
```python
)
```
```python
data_shape
```
```python
.
```
```python
insert
```
```python
(
```
```python
0
```
```python
,
```
```python
data_length
```
```python
)
```
```python
data
```
```python
=
```
```python
np
```
```python
.
```
```python
zeros
```
```python
(
```
```python
data_shape
```
```python
,
```
```python
dtype
```
```python
=
```
```python
np
```
```python
.
```
```python
uint8
```
```python
)
```
```python
labels
```
```python
=
```
```python
np
```
```python
.
```
```python
zeros
```
```python
(
```
```python
[
```
```python
data_length
```
```python
]
```
```python
,
```
```python
dtype
```
```python
=
```
```python
np
```
```python
.
```
```python
int64
```
```python
)
```
```python
i
```
```python
=
```
```python
0
```
```python
for
```
```python
image
```
```python
,
```
```python
label
```
```python
in
```
```python
tqdm
```
```python
(
```
```python
image_folder
```
```python
,
```
```python
desc
```
```python
=
```
```python
"Reading Images"
```
```python
)
```
```python
:
```
```python
data
```
```python
[
```
```python
i
```
```python
]
```
```python
=
```
```python
np
```
```python
.
```
```python
array
```
```python
(
```
```python
image
```
```python
)
```
```python
labels
```
```python
[
```
```python
i
```
```python
]
```
```python
=
```
```python
label
        i
```
```python
+=
```
```python
1
```
```python
data_dict
```
```python
=
```
```python
{
```
```python
"data"
```
```python
:
```
```python
data
```
```python
,
```
```python
"labels"
```
```python
:
```
```python
labels
```
```python
,
```
```python
'data_shape'
```
```python
:
```
```python
image_shape
```
```python
}
```
```python
info_dict
```
```python
=
```
```python
{
```
```python
"label_names"
```
```python
:
```
```python
idx_to_class
```
```python
,
```
```python
"file_paths"
```
```python
:
```
```python
image_paths
```
```python
}
```
```python
return
```
```python
data_dict
```
```python
,
```
```python
info_dict
train_dict
```
```python
,
```
```python
train_info_dict
```
```python
=
```
```python
read_image_folder
```
```python
(
```
```python
(
```
```python
224
```
```python
,
```
```python
224
```
```python
)
```
```python
,
```
```python
"../input/train"
```
```python
)
```
```python
test_dict
```
```python
,
```
```python
test_info_dict
```
```python
=
```
```python
read_image_folder
```
```python
(
```
```python
(
```
```python
224
```
```python
,
```
```python
224
```
```python
)
```
```python
,
```
```python
"../working/tmp/test/"
```
```python
)
```
分别查看 train 和 test 其中的一张图片.
```python
# Show one of train and test.
```
```python
import
```
```python
matplotlib
```
```python
.
```
```python
pyplot
```
```python
as
```
```python
plt
plt
```
```python
.
```
```python
figure
```
```python
(
```
```python
)
```
```python
plt
```
```python
.
```
```python
imshow
```
```python
(
```
```python
train_dict
```
```python
[
```
```python
"data"
```
```python
]
```
```python
[
```
```python
800
```
```python
]
```
```python
)
```
```python
plt
```
```python
.
```
```python
figure
```
```python
(
```
```python
)
```
```python
plt
```
```python
.
```
```python
imshow
```
```python
(
```
```python
test_dict
```
```python
[
```
```python
"data"
```
```python
]
```
```python
[
```
```python
600
```
```python
]
```
```python
)
```
```python
print
```
```python
(
```
```python
"iamge shape ="
```
```python
,
```
```python
train_dict
```
```python
[
```
```python
"data"
```
```python
]
```
```python
[
```
```python
300
```
```python
]
```
```python
.
```
```python
shape
```
```python
)
```
定义一个 PyTorch 的 Dataset 类.
```python
# Define a dataset
```
```python
class
```
```python
ImageDataset
```
```python
(
```
```python
torch
```
```python
.
```
```python
utils
```
```python
.
```
```python
data
```
```python
.
```
```python
Dataset
```
```python
)
```
```python
:
```
```python
def
```
```python
__init__
```
```python
(
```
```python
self
```
```python
,
```
```python
x_data
```
```python
,
```
```python
y_data
```
```python
)
```
```python
:
```
```python
self
```
```python
.
```
```python
x_data
```
```python
=
```
```python
x_data
        self
```
```python
.
```
```python
y_data
```
```python
=
```
```python
y_data
        self
```
```python
.
```
```python
to_tensor
```
```python
=
```
```python
torchvision
```
```python
.
```
```python
transforms
```
```python
.
```
```python
ToTensor
```
```python
(
```
```python
)
```
```python
def
```
```python
__getitem__
```
```python
(
```
```python
self
```
```python
,
```
```python
index
```
```python
)
```
```python
:
```
```python
return
```
```python
self
```
```python
.
```
```python
to_tensor
```
```python
(
```
```python
self
```
```python
.
```
```python
x_data
```
```python
[
```
```python
index
```
```python
]
```
```python
)
```
```python
,
```
```python
self
```
```python
.
```
```python
y_data
```
```python
[
```
```python
index
```
```python
]
```
```python
def
```
```python
__len__
```
```python
(
```
```python
self
```
```python
)
```
```python
:
```
```python
return
```
```python
len
```
```python
(
```
```python
self
```
```python
.
```
```python
x_data
```
```python
)
```
PyTorch 的 torchvision.transforms.ToTensor() 类会自动的将所有 (高 x 宽 x 通道) 图片数据,
转化为 (通道 x 高 x 宽 ) 数据.
这是 AlexNet 需要的标准数据格式.
读取所有的 train 图片生成图片集.
```python
# Note that torchvision.transforms.ToTensor() will
```
```python
# Converts a PIL Image or numpy.ndarray (H x W x C) in the range
```
```python
# [0, 255] to a torch.FloatTensor of shape (C x H x W) in the range [0.0, 1.0].
```
```python
whole_dataset
```
```python
=
```
```python
ImageDataset
```
```python
(
```
```python
train_dict
```
```python
[
```
```python
"data"
```
```python
]
```
```python
,
```
```python
train_dict
```
```python
[
```
```python
"labels"
```
```python
]
```
```python
)
```
```python
print
```
```python
(
```
```python
whole_dataset
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
0
```
```python
]
```
```python
.
```
```python
shape
```
```python
)
```
```python
print
```
```python
(
```
```python
whole_dataset
```
```python
[
```
```python
4610
```
```python
]
```
```python
)
```
为了在训练的过程中观察过拟合的现象, 我们将 train 数据集分割成训练集和验证集.
```python
# subset the whole train set for accuracy check while training.
```
```python
def
```
```python
array_random_pick
```
```python
(
```
```python
array
```
```python
,
```
```python
pick_num
```
```python
)
```
```python
:
```
```python
index
```
```python
=
```
```python
np
```
```python
.
```
```python
arange
```
```python
(
```
```python
len
```
```python
(
```
```python
array
```
```python
)
```
```python
)
```
```python
pick
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
choice
```
```python
(
```
```python
len
```
```python
(
```
```python
array
```
```python
)
```
```python
,
```
```python
pick_num
```
```python
,
```
```python
replace
```
```python
=
```
```python
False
```
```python
)
```
```python
unpick
```
```python
=
```
```python
np
```
```python
.
```
```python
equal
```
```python
(
```
```python
np
```
```python
.
```
```python
in1d
```
```python
(
```
```python
index
```
```python
,
```
```python
pick
```
```python
)
```
```python
,
```
```python
False
```
```python
)
```
```python
return
```
```python
array
```
```python
[
```
```python
unpick
```
```python
]
```
```python
,
```
```python
array
```
```python
[
```
```python
pick
```
```python
]
```
```python
train_mask
```
```python
,
```
```python
valid_mask
```
```python
=
```
```python
array_random_pick
```
```python
(
```
```python
np
```
```python
.
```
```python
arange
```
```python
(
```
```python
len
```
```python
(
```
```python
whole_dataset
```
```python
)
```
```python
)
```
```python
,
```
```python
500
```
```python
)
```
```python
train_set
```
```python
=
```
```python
torch
```
```python
.
```
```python
utils
```
```python
.
```
```python
data
```
```python
.
```
```python
Subset
```
```python
(
```
```python
whole_dataset
```
```python
,
```
```python
train_mask
```
```python
)
```
```python
valid_set
```
```python
=
```
```python
torch
```
```python
.
```
```python
utils
```
```python
.
```
```python
data
```
```python
.
```
```python
Subset
```
```python
(
```
```python
whole_dataset
```
```python
,
```
```python
valid_mask
```
```python
)
```
```python
print
```
```python
(
```
```python
len
```
```python
(
```
```python
train_set
```
```python
)
```
```python
,
```
```python
len
```
```python
(
```
```python
valid_set
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
train_set
```
```python
[
```
```python
4010
```
```python
]
```
```python
)
```
```python
print
```
```python
(
```
```python
valid_set
```
```python
[
```
```python
401
```
```python
]
```
```python
)
```
使用 PyTorch 的 DataLoader() 类生成 mini-batch 数据.
这里定义每一个 mini-batch 含有 4 图片.
```python
# Use DataLoader to group data batchs. Here use size 4 for a batch.
```
```python
# DataLoader will return a iterator.
```
```python
train_loader
```
```python
=
```
```python
torch
```
```python
.
```
```python
utils
```
```python
.
```
```python
data
```
```python
.
```
```python
DataLoader
```
```python
(
```
```python
train_set
```
```python
,
```
```python
batch_size
```
```python
=
```
```python
5
```
```python
)
```
```python
load_iter
```
```python
=
```
```python
iter
```
```python
(
```
```python
train_loader
```
```python
)
```
```python
one_batch_x
```
```python
,
```
```python
one_batch_y
```
```python
=
```
```python
next
```
```python
(
```
```python
load_iter
```
```python
)
```
```python
print
```
```python
(
```
```python
one_batch_y
```
```python
)
```
```python
print
```
```python
(
```
```python
one_batch_x
```
```python
.
```
```python
shape
```
```python
)
```
使用 PyTorch 的 AlexNet() 类快速生成 AlexNet 模型, 定义分类类别为 12.
如果 AlexNet 模型读入 [4, 3, 224, 224] 的数据, 就会输出 [4, 12] 形状的数据.
```python
# Use PyTorch's built-in model to generate AlexNet with classes 12.
```
```python
# With input data of size [4, 3, 224, 224], AlexNet will output data of size [4, 12].
```
```python
alex
```
```python
=
```
```python
torchvision
```
```python
.
```
```python
models
```
```python
.
```
```python
AlexNet
```
```python
(
```
```python
num_classes
```
```python
=
```
```python
12
```
```python
)
```
```python
alex_out
```
```python
=
```
```python
alex
```
```python
(
```
```python
one_batch_x
```
```python
)
```
```python
print
```
```python
(
```
```python
alex_out
```
```python
.
```
```python
shape
```
```python
)
```
```python
print
```
```python
(
```
```python
alex_out
```
```python
)
```
输出 [4, 12] 形状的数据, 表示共有 4 张图片, 每一张图片共有 12 中分类, 每一行的 12 个数值表示每个分类的可能性概率.
使用概率最大值的索引表示图片的分类.
```python
# We use the max index of alex_out to
```
```python
# evaluate the accuracy of model predict.
```
```python
# Now the accuracy is zero before model train.
```
```python
predict
```
```python
=
```
```python
torch
```
```python
.
```
```python
argmax
```
```python
(
```
```python
alex_out
```
```python
,
```
```python
dim
```
```python
=
```
```python
1
```
```python
)
```
```python
compare
```
```python
=
```
```python
predict
```
```python
==
```
```python
one_batch_y
accuracy
```
```python
=
```
```python
compare
```
```python
.
```
```python
sum
```
```python
(
```
```python
)
```
```python
/
```
```python
len
```
```python
(
```
```python
predict
```
```python
)
```
```python
print
```
```python
(
```
```python
predict
```
```python
)
```
```python
print
```
```python
(
```
```python
one_batch_y
```
```python
)
```
```python
print
```
```python
(
```
```python
compare
```
```python
)
```
```python
print
```
```python
(
```
```python
"accuracy ="
```
```python
,
```
```python
accuracy
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
这是一个通用的模型训练类.
```python
# define a base utility to train a net.
```
```python
class
```
```python
BaseNetPyTorch
```
```python
:
```
```python
def
```
```python
__init__
```
```python
(
```
```python
self
```
```python
)
```
```python
:
```
```python
self
```
```python
.
```
```python
train_loader
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
sub_train_loader
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
valid_loader
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
model
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
optimize_method
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
loss_function
```
```python
=
```
```python
None
```
```python
if_gpu
```
```python
=
```
```python
torch
```
```python
.
```
```python
cuda
```
```python
.
```
```python
is_available
```
```python
(
```
```python
)
```
```python
self
```
```python
.
```
```python
device_gpu
```
```python
=
```
```python
torch
```
```python
.
```
```python
device
```
```python
(
```
```python
"cuda:0"
```
```python
if
```
```python
if_gpu
```
```python
else
```
```python
"cpu"
```
```python
)
```
```python
def
```
```python
train_loss
```
```python
(
```
```python
self
```
```python
)
```
```python
:
```
```python
# "training" mode for Dropout etc.
```
```python
self
```
```python
.
```
```python
model
```
```python
.
```
```python
train
```
```python
(
```
```python
)
```
```python
train_loss
```
```python
=
```
```python
None
```
```python
for
```
```python
(
```
```python
x
```
```python
,
```
```python
y
```
```python
)
```
```python
in
```
```python
self
```
```python
.
```
```python
train_loader
```
```python
:
```
```python
x_gpu
```
```python
=
```
```python
x
```
```python
.
```
```python
to
```
```python
(
```
```python
self
```
```python
.
```
```python
device_gpu
```
```python
)
```
```python
y_gpu
```
```python
=
```
```python
y
```
```python
.
```
```python
long
```
```python
(
```
```python
)
```
```python
.
```
```python
to
```
```python
(
```
```python
self
```
```python
.
```
```python
device_gpu
```
```python
)
```
```python
predict
```
```python
=
```
```python
self
```
```python
.
```
```python
model
```
```python
(
```
```python
x_gpu
```
```python
)
```
```python
train_loss
```
```python
=
```
```python
self
```
```python
.
```
```python
loss_function
```
```python
(
```
```python
predict
```
```python
,
```
```python
y_gpu
```
```python
)
```
```python
self
```
```python
.
```
```python
optimize_method
```
```python
.
```
```python
zero_grad
```
```python
(
```
```python
)
```
```python
train_loss
```
```python
.
```
```python
backward
```
```python
(
```
```python
)
```
```python
self
```
```python
.
```
```python
optimize_method
```
```python
.
```
```python
step
```
```python
(
```
```python
)
```
```python
return
```
```python
train_loss
```
```python
def
```
```python
predict_index
```
```python
(
```
```python
self
```
```python
,
```
```python
check_loader
```
```python
)
```
```python
:
```
```python
predict_list
```
```python
=
```
```python
[
```
```python
]
```
```python
for
```
```python
x
```
```python
,
```
```python
y
```
```python
in
```
```python
check_loader
```
```python
:
```
```python
x_gpu
```
```python
=
```
```python
x
```
```python
.
```
```python
to
```
```python
(
```
```python
self
```
```python
.
```
```python
device_gpu
```
```python
)
```
```python
predict
```
```python
=
```
```python
self
```
```python
.
```
```python
model
```
```python
(
```
```python
x_gpu
```
```python
)
```
```python
max_index
```
```python
=
```
```python
torch
```
```python
.
```
```python
argmax
```
```python
(
```
```python
predict
```
```python
,
```
```python
dim
```
```python
=
```
```python
1
```
```python
)
```
```python
predict_list
```
```python
+=
```
```python
max_index
```
```python
.
```
```python
cpu
```
```python
(
```
```python
)
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
.
```
```python
tolist
```
```python
(
```
```python
)
```
```python
return
```
```python
predict_list
```
```python
def
```
```python
check_accuracy
```
```python
(
```
```python
self
```
```python
,
```
```python
check_set
```
```python
)
```
```python
:
```
```python
num_correct
```
```python
=
```
```python
0
```
```python
num_samples
```
```python
=
```
```python
0
```
```python
# "test" mode for Dropout etc.
```
```python
self
```
```python
.
```
```python
model
```
```python
.
```
```python
eval
```
```python
(
```
```python
)
```
```python
for
```
```python
x
```
```python
,
```
```python
y
```
```python
in
```
```python
check_set
```
```python
:
```
```python
x_gpu
```
```python
=
```
```python
x
```
```python
.
```
```python
to
```
```python
(
```
```python
self
```
```python
.
```
```python
device_gpu
```
```python
)
```
```python
y_gpu
```
```python
=
```
```python
y
```
```python
.
```
```python
to
```
```python
(
```
```python
self
```
```python
.
```
```python
device_gpu
```
```python
)
```
```python
predict
```
```python
=
```
```python
self
```
```python
.
```
```python
model
```
```python
(
```
```python
x_gpu
```
```python
)
```
```python
max_index
```
```python
=
```
```python
torch
```
```python
.
```
```python
argmax
```
```python
(
```
```python
predict
```
```python
,
```
```python
dim
```
```python
=
```
```python
1
```
```python
)
```
```python
num_correct
```
```python
+=
```
```python
(
```
```python
max_index
```
```python
==
```
```python
y_gpu
```
```python
)
```
```python
.
```
```python
sum
```
```python
(
```
```python
)
```
```python
num_samples
```
```python
+=
```
```python
max_index
```
```python
.
```
```python
shape
```
```python
[
```
```python
0
```
```python
]
```
```python
accuracy
```
```python
=
```
```python
float
```
```python
(
```
```python
num_correct
```
```python
)
```
```python
/
```
```python
float
```
```python
(
```
```python
num_samples
```
```python
)
```
```python
return
```
```python
num_correct
```
```python
,
```
```python
num_samples
```
```python
,
```
```python
accuracy
```
```python
def
```
```python
train
```
```python
(
```
```python
self
```
```python
,
```
```python
num_epochs
```
```python
=
```
```python
1
```
```python
)
```
```python
:
```
```python
if
```
```python
self
```
```python
.
```
```python
model
```
```python
is
```
```python
None
```
```python
:
```
```python
raise
```
```python
ValueError
```
```python
(
```
```python
"self.model is None! Please assign it."
```
```python
)
```
```python
if
```
```python
self
```
```python
.
```
```python
optimize_method
```
```python
is
```
```python
None
```
```python
:
```
```python
raise
```
```python
ValueError
```
```python
(
```
```python
"self.optimize_method is None! Please assign it."
```
```python
)
```
```python
if
```
```python
self
```
```python
.
```
```python
loss_function
```
```python
is
```
```python
None
```
```python
:
```
```python
raise
```
```python
ValueError
```
```python
(
```
```python
"self.loss_function is None! Please assign it."
```
```python
)
```
```python
print
```
```python
(
```
```python
"begin training, length_of_one_mini_batch :"
```
```python
,
```
```python
len
```
```python
(
```
```python
self
```
```python
.
```
```python
train_loader
```
```python
)
```
```python
)
```
```python
self
```
```python
.
```
```python
model
```
```python
=
```
```python
self
```
```python
.
```
```python
model
```
```python
.
```
```python
to
```
```python
(
```
```python
self
```
```python
.
```
```python
device_gpu
```
```python
)
```
```python
train_time
```
```python
=
```
```python
time
```
```python
.
```
```python
time
```
```python
(
```
```python
)
```
```python
for
```
```python
epoch
```
```python
in
```
```python
range
```
```python
(
```
```python
num_epochs
```
```python
)
```
```python
:
```
```python
epoch_start
```
```python
=
```
```python
time
```
```python
.
```
```python
time
```
```python
(
```
```python
)
```
```python
loss
```
```python
=
```
```python
self
```
```python
.
```
```python
train_loss
```
```python
(
```
```python
)
```
```python
loss_time
```
```python
=
```
```python
time
```
```python
.
```
```python
time
```
```python
(
```
```python
)
```
```python
train_correct
```
```python
,
```
```python
train_samples
```
```python
,
```
```python
train_acc
```
```python
=
```
```python
self
```
```python
.
```
```python
check_accuracy
```
```python
(
```
```python
self
```
```python
.
```
```python
sub_train_loader
```
```python
)
```
```python
train_acc_time
```
```python
=
```
```python
time
```
```python
.
```
```python
time
```
```python
(
```
```python
)
```
```python
valid_correct
```
```python
,
```
```python
valid_samples
```
```python
,
```
```python
valid_acc
```
```python
=
```
```python
self
```
```python
.
```
```python
check_accuracy
```
```python
(
```
```python
self
```
```python
.
```
```python
valid_loader
```
```python
)
```
```python
valid_acc_time
```
```python
=
```
```python
time
```
```python
.
```
```python
time
```
```python
(
```
```python
)
```
```python
epoch_time
```
```python
=
```
```python
time
```
```python
.
```
```python
time
```
```python
(
```
```python
)
```
```python
print
```
```python
(
```
```python
'epoch:%d/%d'
```
```python
%
```
```python
(
```
```python
epoch
```
```python
+
```
```python
1
```
```python
,
```
```python
num_epochs
```
```python
)
```
```python
,
```
```python
end
```
```python
=
```
```python
" "
```
```python
)
```
```python
print
```
```python
(
```
```python
'loss:%.4f|%ds'
```
```python
%
```
```python
(
```
```python
loss
```
```python
.
```
```python
data
```
```python
,
```
```python
(
```
```python
loss_time
```
```python
-
```
```python
epoch_start
```
```python
)
```
```python
)
```
```python
,
```
```python
end
```
```python
=
```
```python
" "
```
```python
)
```
```python
print
```
```python
(
```
```python
'train_acc:(%d/%d %0.2f%%)|%ds'
```
```python
%
```
```python
(
```
```python
train_correct
```
```python
,
```
```python
train_samples
```
```python
,
```
```python
100
```
```python
*
```
```python
train_acc
```
```python
,
```
```python
train_acc_time
```
```python
-
```
```python
loss_time
```
```python
)
```
```python
,
```
```python
end
```
```python
=
```
```python
' '
```
```python
)
```
```python
print
```
```python
(
```
```python
'valid_acc:(%d/%d %0.2f%%)|%ds'
```
```python
%
```
```python
(
```
```python
valid_correct
```
```python
,
```
```python
valid_samples
```
```python
,
```
```python
100
```
```python
*
```
```python
valid_acc
```
```python
,
```
```python
(
```
```python
valid_acc_time
```
```python
-
```
```python
train_acc_time
```
```python
)
```
```python
)
```
```python
,
```
```python
end
```
```python
=
```
```python
' '
```
```python
)
```
```python
print
```
```python
(
```
```python
"take:%dmin remain:%dmin"
```
```python
%
```
```python
(
```
```python
(
```
```python
epoch_time
```
```python
-
```
```python
train_time
```
```python
)
```
```python
/
```
```python
60
```
```python
,
```
```python
(
```
```python
epoch_time
```
```python
-
```
```python
epoch_start
```
```python
)
```
```python
*
```
```python
(
```
```python
num_epochs
```
```python
-
```
```python
epoch
```
```python
)
```
```python
/
```
```python
60
```
```python
)
```
```python
)
```
```python
if
```
```python
(
```
```python
train_acc
```
```python
-
```
```python
0.3
```
```python
>
```
```python
valid_acc
```
```python
)
```
```python
and
```
```python
(
```
```python
train_acc
```
```python
>
```
```python
0.5
```
```python
)
```
```python
:
```
```python
print
```
```python
(
```
```python
"Model Overfit 30.00%, stopped."
```
```python
)
```
```python
return
```
```python
True
```
```python
return
```
```python
True
```
为模型训练类的参数赋值.
训练集的随机性非常重要, 需要指明 shuffle=True.
```python
# It is very important to turn on shuffle=True of training set
```
```python
train_loader
```
```python
=
```
```python
torch
```
```python
.
```
```python
utils
```
```python
.
```
```python
data
```
```python
.
```
```python
DataLoader
```
```python
(
```
```python
train_set
```
```python
,
```
```python
batch_size
```
```python
=
```
```python
40
```
```python
,
```
```python
shuffle
```
```python
=
```
```python
True
```
```python
)
```
```python
valid_loader
```
```python
=
```
```python
torch
```
```python
.
```
```python
utils
```
```python
.
```
```python
data
```
```python
.
```
```python
DataLoader
```
```python
(
```
```python
valid_set
```
```python
,
```
```python
batch_size
```
```python
=
```
```python
40
```
```python
)
```
```python
net
```
```python
=
```
```python
BaseNetPyTorch
```
```python
(
```
```python
)
```
```python
net
```
```python
.
```
```python
model
```
```python
=
```
```python
torchvision
```
```python
.
```
```python
models
```
```python
.
```
```python
AlexNet
```
```python
(
```
```python
num_classes
```
```python
=
```
```python
12
```
```python
)
```
```python
net
```
```python
.
```
```python
optimize_method
```
```python
=
```
```python
torch
```
```python
.
```
```python
optim
```
```python
.
```
```python
Adam
```
```python
(
```
```python
net
```
```python
.
```
```python
model
```
```python
.
```
```python
parameters
```
```python
(
```
```python
)
```
```python
,
```
```python
lr
```
```python
=
```
```python
0.0001
```
```python
)
```
```python
net
```
```python
.
```
```python
loss_function
```
```python
=
```
```python
torch
```
```python
.
```
```python
nn
```
```python
.
```
```python
CrossEntropyLoss
```
```python
(
```
```python
)
```
```python
net
```
```python
.
```
```python
train_loader
```
```python
=
```
```python
train_loader
net
```
```python
.
```
```python
sub_train_loader
```
```python
=
```
```python
train_loader
net
```
```python
.
```
```python
valid_loader
```
```python
=
```
```python
valid_loader
net
```
```python
.
```
```python
train
```
```python
(
```
```python
30
```
```python
)
```
使用训练好的模型预测图片种类.
```python
# predict test file labels
```
```python
test_set
```
```python
=
```
```python
ImageDataset
```
```python
(
```
```python
test_dict
```
```python
[
```
```python
"data"
```
```python
]
```
```python
,
```
```python
test_dict
```
```python
[
```
```python
"labels"
```
```python
]
```
```python
)
```
```python
test_loader
```
```python
=
```
```python
torch
```
```python
.
```
```python
utils
```
```python
.
```
```python
data
```
```python
.
```
```python
DataLoader
```
```python
(
```
```python
test_set
```
```python
,
```
```python
batch_size
```
```python
=
```
```python
40
```
```python
)
```
```python
label_names
```
```python
=
```
```python
train_info_dict
```
```python
[
```
```python
"label_names"
```
```python
]
```
```python
test_predict
```
```python
=
```
```python
net
```
```python
.
```
```python
predict_index
```
```python
(
```
```python
test_loader
```
```python
)
```
```python
predict_names
```
```python
=
```
```python
[
```
```python
label_names
```
```python
[
```
```python
i
```
```python
]
```
```python
for
```
```python
i
```
```python
in
```
```python
test_predict
```
```python
]
```
```python
print
```
```python
(
```
```python
test_predict
```
```python
[
```
```python
:
```
```python
10
```
```python
]
```
```python
)
```
```python
print
```
```python
(
```
```python
predict_names
```
```python
[
```
```python
:
```
```python
10
```
```python
]
```
```python
)
```
将图片分类至不同的文件夹.
```python
# classify test_files to different sub_folders
```
```python
test_file_paths
```
```python
=
```
```python
test_info_dict
```
```python
[
```
```python
"file_paths"
```
```python
]
```
```python
save_folder
```
```python
=
```
```python
"../working/tmp/predict"
```
```python
def
```
```python
make_dirs
```
```python
(
```
```python
path
```
```python
)
```
```python
:
```
```python
if
```
```python
not
```
```python
os
```
```python
.
```
```python
path
```
```python
.
```
```python
exists
```
```python
(
```
```python
path
```
```python
)
```
```python
:
```
```python
os
```
```python
.
```
```python
makedirs
```
```python
(
```
```python
path
```
```python
)
```
```python
def
```
```python
copy2sub_folders
```
```python
(
```
```python
source_file_paths
```
```python
,
```
```python
sub_folder_names
```
```python
,
```
```python
to_folder
```
```python
)
```
```python
:
```
```python
for
```
```python
i
```
```python
in
```
```python
tqdm
```
```python
(
```
```python
range
```
```python
(
```
```python
len
```
```python
(
```
```python
source_file_paths
```
```python
)
```
```python
)
```
```python
)
```
```python
:
```
```python
file_dir
```
```python
=
```
```python
os
```
```python
.
```
```python
path
```
```python
.
```
```python
join
```
```python
(
```
```python
to_folder
```
```python
,
```
```python
sub_folder_names
```
```python
[
```
```python
i
```
```python
]
```
```python
)
```
```python
make_dirs
```
```python
(
```
```python
file_dir
```
```python
)
```
```python
shutil
```
```python
.
```
```python
copy2
```
```python
(
```
```python
source_file_paths
```
```python
[
```
```python
i
```
```python
]
```
```python
,
```
```python
file_dir
```
```python
)
```
```python
copy2sub_folders
```
```python
(
```
```python
test_file_paths
```
```python
,
```
```python
predict_names
```
```python
,
```
```python
save_folder
```
```python
)
```
```python
print
```
```python
(
```
```python
os
```
```python
.
```
```python
listdir
```
```python
(
```
```python
"../working/tmp/predict"
```
```python
)
```
```python
)
```
生成比赛的预测结果 csv 文件.
```python
# Create a predict submission file.
```
```python
def
```
```python
folder_file_info
```
```python
(
```
```python
root
```
```python
)
```
```python
:
```
```python
folder_file_list
```
```python
=
```
```python
[
```
```python
]
```
```python
path_dirs
```
```python
=
```
```python
os
```
```python
.
```
```python
listdir
```
```python
(
```
```python
root
```
```python
)
```
```python
for
```
```python
folder
```
```python
in
```
```python
path_dirs
```
```python
:
```
```python
dir_files
```
```python
=
```
```python
os
```
```python
.
```
```python
listdir
```
```python
(
```
```python
os
```
```python
.
```
```python
path
```
```python
.
```
```python
join
```
```python
(
```
```python
root
```
```python
,
```
```python
folder
```
```python
)
```
```python
)
```
```python
for
```
```python
file_name
```
```python
in
```
```python
dir_files
```
```python
:
```
```python
folder_file_list
```
```python
.
```
```python
append
```
```python
(
```
```python
[
```
```python
file_name
```
```python
,
```
```python
folder
```
```python
]
```
```python
)
```
```python
return
```
```python
folder_file_list

file_predict_table
```
```python
=
```
```python
folder_file_info
```
```python
(
```
```python
"../working/tmp/predict"
```
```python
)
```
```python
df
```
```python
=
```
```python
pd
```
```python
.
```
```python
DataFrame
```
```python
(
```
```python
file_predict_table
```
```python
,
```
```python
columns
```
```python
=
```
```python
[
```
```python
'file'
```
```python
,
```
```python
'species'
```
```python
]
```
```python
)
```
```python
df
```
```python
.
```
```python
to_csv
```
```python
(
```
```python
"predict_submission.csv"
```
```python
,
```
```python
index
```
```python
=
```
```python
False
```
```python
)
```
```python
print
```
```python
(
```
```python
df
```
```python
)
```
在 working 文件夹中, Kaggle 不允许保存超过 500 个文件.
在保存代码前删除临时文件.
```python
# delect temporary working folder before Kaggle Commit.
```
```python
if
```
```python
os
```
```python
.
```
```python
path
```
```python
.
```
```python
exists
```
```python
(
```
```python
"../working/tmp"
```
```python
)
```
```python
:
```
```python
shutil
```
```python
.
```
```python
rmtree
```
```python
(
```
```python
"../working/tmp"
```
```python
)
```
```python
os
```
```python
.
```
```python
listdir
```
```python
(
```
```python
"../working"
```
```python
)
```
全文完.

