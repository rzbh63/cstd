
# Python和PyTorch对比实现批标准化Batch Normalization函数及反向传播 - BrightLamp的博客 - CSDN博客


2018年11月26日 22:34:21[BrightLampCsdn](https://me.csdn.net/oBrightLamp)阅读数：198所属专栏：



## 摘要
本文使用纯 Python 和 PyTorch 对比实现 Batch Normalization 函数及其反向传播.
## 相关
*原理和详细解释, 请参考文章 :*
Batch Normalization函数详解及反向传播中的梯度求导
*系列文章索引 :*
[https://blog.csdn.net/oBrightLamp/article/details/85067981](https://blog.csdn.net/oBrightLamp/article/details/85067981)
## 正文
```python
import
```
```python
torch
```
```python
import
```
```python
numpy
```
```python
as
```
```python
np
```
```python
class
```
```python
BatchNorm1d
```
```python
:
```
```python
def
```
```python
__init__
```
```python
(
```
```python
self
```
```python
)
```
```python
:
```
```python
self
```
```python
.
```
```python
eps
```
```python
=
```
```python
1e
```
```python
-
```
```python
5
```
```python
self
```
```python
.
```
```python
weight
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
bias
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
num
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
std
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
dw
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
db
```
```python
=
```
```python
None
```
```python
def
```
```python
__call__
```
```python
(
```
```python
self
```
```python
,
```
```python
x
```
```python
)
```
```python
:
```
```python
self
```
```python
.
```
```python
num
```
```python
=
```
```python
np
```
```python
.
```
```python
shape
```
```python
(
```
```python
x
```
```python
)
```
```python
[
```
```python
0
```
```python
]
```
```python
mean
```
```python
=
```
```python
np
```
```python
.
```
```python
mean
```
```python
(
```
```python
x
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
,
```
```python
keepdims
```
```python
=
```
```python
True
```
```python
)
```
```python
var
```
```python
=
```
```python
np
```
```python
.
```
```python
var
```
```python
(
```
```python
x
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
,
```
```python
keepdims
```
```python
=
```
```python
True
```
```python
)
```
```python
self
```
```python
.
```
```python
sqrt
```
```python
=
```
```python
np
```
```python
.
```
```python
sqrt
```
```python
(
```
```python
var
```
```python
+
```
```python
self
```
```python
.
```
```python
eps
```
```python
)
```
```python
self
```
```python
.
```
```python
std
```
```python
=
```
```python
(
```
```python
x
```
```python
-
```
```python
mean
```
```python
)
```
```python
/
```
```python
self
```
```python
.
```
```python
sqrt
        out
```
```python
=
```
```python
self
```
```python
.
```
```python
std
```
```python
*
```
```python
self
```
```python
.
```
```python
weight
```
```python
+
```
```python
self
```
```python
.
```
```python
bias
```
```python
return
```
```python
out
```
```python
def
```
```python
backward
```
```python
(
```
```python
self
```
```python
,
```
```python
d_loss
```
```python
)
```
```python
:
```
```python
std_t
```
```python
=
```
```python
self
```
```python
.
```
```python
std
```
```python
.
```
```python
T
        shape_t
```
```python
=
```
```python
np
```
```python
.
```
```python
shape
```
```python
(
```
```python
std_t
```
```python
)
```
```python
r
```
```python
=
```
```python
np
```
```python
.
```
```python
zeros
```
```python
(
```
```python
[
```
```python
shape_t
```
```python
[
```
```python
0
```
```python
]
```
```python
,
```
```python
shape_t
```
```python
[
```
```python
1
```
```python
]
```
```python
,
```
```python
shape_t
```
```python
[
```
```python
1
```
```python
]
```
```python
]
```
```python
)
```
```python
shift_eye
```
```python
=
```
```python
np
```
```python
.
```
```python
eye
```
```python
(
```
```python
shape_t
```
```python
[
```
```python
1
```
```python
]
```
```python
)
```
```python
*
```
```python
shape_t
```
```python
[
```
```python
1
```
```python
]
```
```python
-
```
```python
1
```
```python
for
```
```python
i
```
```python
in
```
```python
range
```
```python
(
```
```python
shape_t
```
```python
[
```
```python
0
```
```python
]
```
```python
)
```
```python
:
```
```python
r
```
```python
[
```
```python
i
```
```python
]
```
```python
=
```
```python
std_t
```
```python
[
```
```python
i
```
```python
]
```
```python
[
```
```python
:
```
```python
,
```
```python
np
```
```python
.
```
```python
newaxis
```
```python
]
```
```python
*
```
```python
std_t
```
```python
[
```
```python
i
```
```python
]
```
```python
[
```
```python
np
```
```python
.
```
```python
newaxis
```
```python
,
```
```python
:
```
```python
]
```
```python
r
```
```python
[
```
```python
i
```
```python
]
```
```python
=
```
```python
shift_eye
```
```python
-
```
```python
r
```
```python
[
```
```python
i
```
```python
]
```
```python
u
```
```python
=
```
```python
self
```
```python
.
```
```python
weight
```
```python
/
```
```python
shape_t
```
```python
[
```
```python
1
```
```python
]
```
```python
/
```
```python
self
```
```python
.
```
```python
sqrt
        u
```
```python
=
```
```python
u
```
```python
.
```
```python
T
        y
```
```python
=
```
```python
r
```
```python
*
```
```python
u
```
```python
[
```
```python
:
```
```python
,
```
```python
np
```
```python
.
```
```python
newaxis
```
```python
]
```
```python
dx
```
```python
=
```
```python
np
```
```python
.
```
```python
zeros
```
```python
(
```
```python
shape_t
```
```python
)
```
```python
for
```
```python
i
```
```python
in
```
```python
range
```
```python
(
```
```python
shape_t
```
```python
[
```
```python
0
```
```python
]
```
```python
)
```
```python
:
```
```python
dx
```
```python
[
```
```python
i
```
```python
]
```
```python
=
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
d_loss
```
```python
.
```
```python
T
```
```python
[
```
```python
i
```
```python
]
```
```python
,
```
```python
y
```
```python
[
```
```python
i
```
```python
]
```
```python
)
```
```python
dx
```
```python
=
```
```python
dx
```
```python
.
```
```python
T
        self
```
```python
.
```
```python
dw
```
```python
=
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
self
```
```python
.
```
```python
std
```
```python
*
```
```python
d_loss
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
self
```
```python
.
```
```python
db
```
```python
=
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
d_loss
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
return
```
```python
dx

np
```
```python
.
```
```python
set_printoptions
```
```python
(
```
```python
precision
```
```python
=
```
```python
8
```
```python
,
```
```python
suppress
```
```python
=
```
```python
True
```
```python
,
```
```python
linewidth
```
```python
=
```
```python
120
```
```python
)
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
seed
```
```python
(
```
```python
123
```
```python
)
```
```python
torch
```
```python
.
```
```python
random
```
```python
.
```
```python
manual_seed
```
```python
(
```
```python
123
```
```python
)
```
```python
x_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
array
```
```python
(
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
3
```
```python
,
```
```python
5
```
```python
)
```
```python
)
```
```python
,
```
```python
dtype
```
```python
=
```
```python
np
```
```python
.
```
```python
float64
```
```python
)
```
```python
weight_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
array
```
```python
(
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
5
```
```python
,
```
```python
)
```
```python
)
```
```python
,
```
```python
dtype
```
```python
=
```
```python
np
```
```python
.
```
```python
float64
```
```python
)
```
```python
bias_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
array
```
```python
(
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
5
```
```python
,
```
```python
)
```
```python
)
```
```python
,
```
```python
dtype
```
```python
=
```
```python
np
```
```python
.
```
```python
float64
```
```python
)
```
```python
d_loss_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
array
```
```python
(
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
3
```
```python
,
```
```python
5
```
```python
)
```
```python
)
```
```python
,
```
```python
dtype
```
```python
=
```
```python
np
```
```python
.
```
```python
float64
```
```python
)
```
```python
x_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
x_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
weight_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
weight_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
bias_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
bias_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
d_loss_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
d_loss_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
batch_norm_numpy
```
```python
=
```
```python
BatchNorm1d
```
```python
(
```
```python
)
```
```python
batch_norm_numpy
```
```python
.
```
```python
weight
```
```python
=
```
```python
weight_numpy
batch_norm_numpy
```
```python
.
```
```python
bias
```
```python
=
```
```python
bias_numpy
batch_norm_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
nn
```
```python
.
```
```python
BatchNorm1d
```
```python
(
```
```python
5
```
```python
)
```
```python
.
```
```python
double
```
```python
(
```
```python
)
```
```python
batch_norm_tensor
```
```python
.
```
```python
weight
```
```python
=
```
```python
torch
```
```python
.
```
```python
nn
```
```python
.
```
```python
Parameter
```
```python
(
```
```python
weight_tensor
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
batch_norm_tensor
```
```python
.
```
```python
bias
```
```python
=
```
```python
torch
```
```python
.
```
```python
nn
```
```python
.
```
```python
Parameter
```
```python
(
```
```python
bias_tensor
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
output_numpy
```
```python
=
```
```python
batch_norm_numpy
```
```python
(
```
```python
x_numpy
```
```python
)
```
```python
output_tensor
```
```python
=
```
```python
batch_norm_tensor
```
```python
(
```
```python
x_tensor
```
```python
)
```
```python
output_tensor
```
```python
.
```
```python
backward
```
```python
(
```
```python
d_loss_tensor
```
```python
)
```
```python
dx_numpy
```
```python
=
```
```python
batch_norm_numpy
```
```python
.
```
```python
backward
```
```python
(
```
```python
d_loss_numpy
```
```python
)
```
```python
dx_tensor
```
```python
=
```
```python
x_tensor
```
```python
.
```
```python
grad
dw_numpy
```
```python
=
```
```python
batch_norm_numpy
```
```python
.
```
```python
dw
dw_tensor
```
```python
=
```
```python
batch_norm_tensor
```
```python
.
```
```python
weight
```
```python
.
```
```python
grad
db_numpy
```
```python
=
```
```python
batch_norm_numpy
```
```python
.
```
```python
db
db_tensor
```
```python
=
```
```python
batch_norm_tensor
```
```python
.
```
```python
bias
```
```python
.
```
```python
grad
```
```python
print
```
```python
(
```
```python
"output_numpy \n"
```
```python
,
```
```python
output_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
"output_tensor \n"
```
```python
,
```
```python
output_tensor
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"dx_numpy \n"
```
```python
,
```
```python
dx_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
"dx_tensor \n"
```
```python
,
```
```python
dx_tensor
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"dw_numpy \n"
```
```python
,
```
```python
dw_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
"dw_tensor \n"
```
```python
,
```
```python
dw_tensor
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"db_numpy \n"
```
```python
,
```
```python
db_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
"db_tensor \n"
```
```python
,
```
```python
db_tensor
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
"""
代码输出 :
output_numpy 
 [[ 1.65328862  0.60845792  0.51520137  1.06970231  1.47430633]
 [ 0.31989274  1.049903    0.94450061  0.89737849  0.33620922]
 [-0.06997848  0.88993446  0.713664   -0.13401027  0.3568146 ]]
output_tensor 
 [[ 1.65328862  0.60845792  0.51520137  1.06970231  1.47430633]
 [ 0.31989274  1.049903    0.94450061  0.89737849  0.33620922]
 [-0.06997848  0.88993446  0.713664   -0.13401027  0.3568146 ]]
dx_numpy 
 [[ 0.14897849 -0.00280487 -0.19168465 -0.12787269 -0.00214988]
 [-0.65806077 -0.00492716 -0.16475823  0.14902235 -0.12571213]
 [ 0.50908229  0.00773203  0.35644287 -0.02114966  0.127862  ]]
dx_tensor 
 [[ 0.14897849 -0.00280487 -0.19168465 -0.12787269 -0.00214988]
 [-0.65806077 -0.00492716 -0.16475823  0.14902235 -0.12571213]
 [ 0.50908229  0.00773203  0.35644287 -0.02114966  0.127862  ]]
dw_numpy 
 [ 0.10859242  0.09332669  0.21318384 -0.80395148  0.23776771]
dw_tensor 
 [ 0.10859242  0.09332669  0.21318384 -0.80395148  0.23776771]
db_numpy 
 [ 0.72732508  1.22184114  1.55251516  1.73155916  1.55864309]
db_tensor 
 [ 0.72732508  1.22184114  1.55251516  1.73155916  1.55864309]
"""
```

