
# Android Input子系统-含实例源码 - 嵌入式Linux - CSDN博客

2018年09月07日 13:51:53[写代码的篮球球痴](https://me.csdn.net/weiqifa0)阅读数：283



# 1 Input子系统作用
Android很多外设都是用到输入输出设备，比如touchscreen，键盘，音量键等，输入设备对应Android 框架是Android input子系统，像我们定制类比较多的，很多 需要用到输入子系统，比如一键打开相机，一键唤醒，实体按键等。
# 2 Android input子系统框架
Android Input框架讲解最好的一篇文章
[https://blog.csdn.net/mmmccc000/article/details/49756059](https://blog.csdn.net/mmmccc000/article/details/49756059)
Android input框架主要分为三个部分，一个是kernel，一个是kl文件，kl也可
以划分为框架层，Framework层主要做监听、过滤、分发的工作，Android App部
分主要是接收Input子系统发上来的键值做对应的操作。
![这里写图片描述](https://img-blog.csdn.net/20180905111900628?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXFpZmEw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)![这里写图片描述](https://img-blog.csdn.net/20180905164519678?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXFpZmEw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

# 3 kernel input框架
**Kernel主要是涉及Input设备节点的生成，proc文件系统的生成**
![这里写图片描述](https://img-blog.csdn.net/20180905163720549?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXFpZmEw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)[ ](https://img-blog.csdn.net/20180905163720549?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXFpZmEw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)
![这里写图片描述](https://img-blog.csdn.net/20180905163739377?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXFpZmEw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

**有一个文章写Kernel框架非常好的，我就不再讲了，给几个链接**
[https://blog.csdn.net/u013604527/article/details/53432623/](https://blog.csdn.net/u013604527/article/details/53432623/)
[https://blog.csdn.net/jscese/article/details/42123673](https://blog.csdn.net/jscese/article/details/42123673)
[https://blog.csdn.net/xubin341719/article/details/7881735](https://blog.csdn.net/xubin341719/article/details/7881735)
# 4 如何在kernel添加一个新的键值
## 4.1 先在头文件里面添加
找个共用的头文件添加要的key值，正常是在include下面的，我的代码是在这个位
置
```python
diff --git a/include/uapi/linux/input-event-codes.h b/include/uapi/linux/input-event-codes.h
index 87cf351..45a33ab 100644
```
```python
--- a/include/uapi/linux/input-event-codes.h
```
```python
+++ b/include/uapi/linux/input-event-codes.h
```
```python
@@ -335,7 +335,7 @@
```
```python
#define KEY_RFKILL             247     /* Key that controls all radios */
 #define KEY_MICMUTE            248     /* Mute / unmute the microphone */
```
```python
-
```
```python
+#define KEY_WEIQIFA_TEST 249
```
```python
/* Code 255 is reserved for special needs of AT keyboard driver */
```
## 4.2 在kernel对应的位置注册和发送键值
**注册的位置**
```python
/*包含头文件*/
```
```python
#include <linux/input.h>
```
```python
/*声明input设备*/
```
```python
struct
```
```python
input_dev *button_dev;
```
```python
/*注册input 子设备*/
```
```python
printk(KERN_ERR
```
```python
" xxxx_wake_init\n"
```
```python
);
```
```python
if
```
```python
(!(button_dev= input_allocate_device()))
    {   
        printk(KERN_ERR
```
```python
"input_dev: not enough memory\n"
```
```python
);
```
```python
return
```
```python
-ENOMEM;
    }   
    button_dev->name =
```
```python
"xxxx"
```
```python
;
    button_dev->phys =
```
```python
"xxxx/event0"
```
```python
;
    button_dev->
```
```python
id
```
```python
.bustype
```
```python
= BUS_HOST;
    button_dev->
```
```python
id
```
```python
.vendor
```
```python
=
```
```python
0x0001
```
```python
;
    button_dev->
```
```python
id
```
```python
.product
```
```python
=
```
```python
0x0002
```
```python
;
    button_dev->
```
```python
id
```
```python
.version
```
```python
=
```
```python
0x0100
```
```python
;
    button_dev->evbit[
```
```python
0
```
```python
] = BIT(EV_KEY) | BIT(EV_ABS) | BIT(EV_SYN);
    set_bit(KEY_WEIQIFA_TEST,button_dev->keybit);
    err = input_register_device(button_dev);
```
```python
if
```
```python
(err) {
        printk(KERN_ERR
```
```python
" fail to input_register_device\n"
```
```python
);
        input_free_device(button_dev);
```
```python
return
```
```python
err;
    }   
    printk(KERN_ERR
```
```python
"xxxx_wake_init success!!!\n"
```
```python
);
```
```python
return
```
```python
0
```
```python
;
```
**发送键值的位置**
```python
input_report_key(button_dev, KEY_WEIQIFA_TEST,
```
```python
1
```
```python
)
```
```python
;
```
```python
input_sync(button_dev)
```
```python
;
```
```python
input_report_key(button_dev, KEY_WEIQIFA_TEST,
```
```python
0
```
```python
)
```
```python
;
```
```python
input_sync(button_dev)
```
```python
;
```
## 4.3 写一个对应这个kl文件
#### kl文件简单介绍
Kl文件主要是起到了承上启下的作用，kernel发过来的键值主要通过kl文件来映
射，我们来看看kl文件里面的内容把。左边的是对应kernel上报上来的键值，后
面是对应Android Framework上的键值。
```python
22
```
```python
key
```
```python
399
```
```python
GRAVE
```
```python
23
```
```python
key
```
```python
2
```
```python
1
```
```python
...
```
```python
49
```
```python
key
```
```python
103
```
```python
DPAD_UP
```
```python
50
```
```python
key
```
```python
102
```
```python
HOME
```
```python
51
```
```python
key
```
```python
105
```
```python
DPAD_LEFT
```
```python
52
```
```python
key
```
```python
106
```
```python
DPAD_RIGHT
```
```python
53
```
```python
key
```
```python
115
```
```python
VOLUME_UP
```
#### kl文件哪里来的呢
我们看项目配置下面，有很多kl文件，那么是每个input子系统对应一个kl文件，
还是所有的项目共用一个kl文件？
**kl源码位置在**
```python
./frameworks/base/data/keyboards/AVRCP.kl
./frameworks/base/data/keyboards/G
./frameworks/base/data/keyboards/Vendor_0079_Product_0011.kl
./frameworks/base/data/keyboards/Vendor_045e_Product_028e.kl
```
```python
...
```
**在运行的设备里，它的位置如下**
```python
rk3399_mid:/
```
```python
# busybox find / -iname *.kl
```
```python
/system/usr/keylayout/Generic.kl
/system/usr/keylayout/Vendor_0079_Product_0011.kl
/system/usr/keylayout/qwerty.kl
/system/usr/keylayout/rk29-keypad.kl
/system/usr/keylayout/rtkbt_virtual_hid.kl
```
```python
...
```
```python
rk3399_mid:/
```
```python
#
```
#### kl是跟input设备如何对应起来的呢
我们可以用这个命令来看看**cat /proc/bus/input/devices**
kl文件里面的vendor和product分别对应下面的vendor和product
```python
rk3399_mid:
```
```python
/
```
```python
# cat /proc/bus/input/devices
```
```python
I:
```
```python
Bus=
```
```python
0019
```
```python
Vendor=
```
```python
0001
```
```python
Product=
```
```python
0002
```
```python
Version=
```
```python
0100
```
```python
N:
```
```python
Name=
```
```python
"xxxx"
```
```python
P:
```
```python
Phys=iflytek/event0
```
```python
S:
```
```python
Sysfs=/devices/virtual/input/input0
```
```python
U:
```
```python
Uniq=
```
```python
H:
```
```python
Handlers=event0 cpufreq
```
```python
B:
```
```python
PROP=
```
```python
0
```
```python
B:
```
```python
EV=b
```
```python
B:
```
```python
KEY=
```
```python
100000
```
```python
0
```
```python
0
```
```python
0
```
```python
B:
```
```python
ABS=
```
```python
0
```
**添加我们对应的kl文件**
文件命名跟你申请的vendor和product对应 上面的input设备对应的kl文件应该是：**Vendor_0001_Product_0002.kl**
里面的内容如下，当然如果你没有配置kl文件，默认会去Generic.kl找键值映
射，如果里面也没有，就会去其他kl文件继续找。
```python
# OnLive, Inc. OnLive Wireless Controller
```
```python
key
```
```python
249
```
```python
BUTTON_A
```
## 4.4 mtk平台的一个input 子系统驱动例子
上面写的是在rockchip平台做的例子，下面给出一个mtk平台的例子
[mkt平台的input子系统例子]
([https://blog.csdn.net/weiqifa0/article/details/50387504](https://blog.csdn.net/weiqifa0/article/details/50387504))
# 5 Framework input系统介绍
Framework 主要做的事情是监听底层的input，然后分发给上层
下面的这个说的框架非常好，可以看看，我介绍完主要说明如何添加一个新的key
到系统里面
[https://blog.csdn.net/wangkaiblog/article/details/12085183](https://blog.csdn.net/wangkaiblog/article/details/12085183)
[https://blog.csdn.net/mmmccc000/article/details/49756059](https://blog.csdn.net/mmmccc000/article/details/49756059)
![这里写图片描述](https://img-blog.csdn.net/2018090517044410?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXFpZmEw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)[ ](https://img-blog.csdn.net/2018090517044410?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXFpZmEw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)
![这里写图片描述](https://img-blog.csdn.net/20180906100311237?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXFpZmEw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)[ ](https://img-blog.csdn.net/20180906100311237?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXFpZmEw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)
![这里写图片描述](https://img-blog.csdn.net/2018090610032718?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXFpZmEw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)[ ](https://img-blog.csdn.net/2018090610032718?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXFpZmEw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)
![这里写图片描述](https://img-blog.csdn.net/20180906100342966?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXFpZmEw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)


# 6 添加一个新的键值
**主要涉及到几个文件位置**
**下面列出需要修改的文件还有修改的差异点**
base/api/current.txt
base/api/system-current.txt
base/core/java/android/view/KeyEvent.java
base/core/res/res/values/attrs.xml
/*Generic.kl这里也可以根据驱动添加*/
base/data/keyboards/Generic.kl
base/policy/src/com/android/internal/policy/impl/PhoneFallbackEventHandler.java
native/include/android/keycodes.h
native/include/input/InputEventLabels.h
```python
diff --git a/api/current.txt b/api/current.txt
```
```python
index
```
```python
63
```
```python
fa997..a7a4a2b
```
```python
100644
```
```python
--- a/api/current.txt
+++ b/api/current.txt
@@ -
```
```python
41599
```
```python
,
```
```python
6
```
```python
+
```
```python
41599
```
```python
,
```
```python
7
```
```python
@@ package android.view {
     field
```
```python
public
```
```python
static
```
```python
final
```
```python
int
```
```python
KEYCODE_ASSIST =
```
```python
219
```
```python
;
```
```python
// 0xdb
```
```python
field
```
```python
public
```
```python
static
```
```python
final
```
```python
int
```
```python
KEYCODE_AT =
```
```python
77
```
```python
;
```
```python
// 0x4d
```
```python
field
```
```python
public
```
```python
static
```
```python
final
```
```python
int
```
```python
KEYCODE_AUDIO =
```
```python
314
```
```python
;
```
```python
// 0x13a
```
```python
+    field
```
```python
public
```
```python
static
```
```python
final
```
```python
int
```
```python
KEYCODE_WEIQIFA =
```
```python
315
```
```python
;
```
```python
// 0x13B
```
```python
field
```
```python
public
```
```python
static
```
```python
final
```
```python
int
```
```python
KEYCODE_AVR_INPUT =
```
```python
182
```
```python
;
```
```python
// 0xb6
```
```python
field
```
```python
public
```
```python
static
```
```python
final
```
```python
int
```
```python
KEYCODE_AVR_POWER =
```
```python
181
```
```python
;
```
```python
// 0xb5
```
```python
field
```
```python
public
```
```python
static
```
```python
final
```
```python
int
```
```python
KEYCODE_B =
```
```python
30
```
```python
;
```
```python
// 0x1e
```
```python
diff --git a/api/system-current.txt b/api/system-current.txt
```
```python
index
```
```python
19135
```
```python
aa.
```
```python
.956
```
```python
ea3e
```
```python
100644
```
```python
--- a/api/system-current.txt
+++ b/api/system-current.txt
@@ -
```
```python
44781
```
```python
,
```
```python
6
```
```python
+
```
```python
44781
```
```python
,
```
```python
7
```
```python
@@ package android.view {
     field
```
```python
public
```
```python
static
```
```python
final
```
```python
int
```
```python
KEYCODE_ASSIST =
```
```python
219
```
```python
;
```
```python
// 0xdb
```
```python
field
```
```python
public
```
```python
static
```
```python
final
```
```python
int
```
```python
KEYCODE_AT =
```
```python
77
```
```python
;
```
```python
// 0x4d
```
```python
field
```
```python
public
```
```python
static
```
```python
final
```
```python
int
```
```python
KEYCODE_AUDIO =
```
```python
314
```
```python
;
```
```python
// 0x13a
```
```python
+    field
```
```python
public
```
```python
static
```
```python
final
```
```python
int
```
```python
KEYCODE_WEIQIFA =
```
```python
315
```
```python
;
```
```python
// 0x13b
```
```python
field
```
```python
public
```
```python
static
```
```python
final
```
```python
int
```
```python
KEYCODE_AVR_INPUT =
```
```python
182
```
```python
;
```
```python
// 0xb6
```
```python
field
```
```python
public
```
```python
static
```
```python
final
```
```python
int
```
```python
KEYCODE_AVR_POWER =
```
```python
181
```
```python
;
```
```python
// 0xb5
```
```python
field
```
```python
public
```
```python
static
```
```python
final
```
```python
int
```
```python
KEYCODE_B =
```
```python
30
```
```python
;
```
```python
// 0x1e
```
```python
diff --git a/core/java/android/view/KeyEvent.java b/core/java/android/view/KeyEvent.java
```
```python
index
```
```python
056
```
```python
f2c9..f2d5235
```
```python
100755
```
```python
--- a/core/java/android/view/KeyEvent.java
+++ b/core/java/android/view/KeyEvent.java
@@ -
```
```python
832
```
```python
,
```
```python
6
```
```python
+
```
```python
832
```
```python
,
```
```python
7
```
```python
@@
```
```python
public
```
```python
class
```
```python
KeyEvent
```
```python
extends
```
```python
InputEvent
```
```python
implements
```
```python
Parcelable
```
```python
{
```
```python
public
```
```python
static
```
```python
final
```
```python
int
```
```python
KEYCODE_TV_MEDIA_PAUSE =
```
```python
304
```
```python
;
```
```python
public
```
```python
static
```
```python
final
```
```python
int
```
```python
KEYCODE_WLAN           =
```
```python
313
```
```python
;
```
```python
public
```
```python
static
```
```python
final
```
```python
int
```
```python
KEYCODE_AUDIO          =
```
```python
314
```
```python
;
+
```
```python
public
```
```python
static
```
```python
final
```
```python
int
```
```python
KEYCODE_WEIQIFA          =
```
```python
315
```
```python
;
```
```python
//$_rbox_$_modify_$ end
```
```python
private
```
```python
static
```
```python
final
```
```python
int
```
```python
LAST_KEYCODE = KEYCODE_TV_MEDIA_PAUSE;
diff --git a/core/java/com/android/internal/policy/PhoneFallbackEventHandler.java b/core/java/com/android/internal/policy/PhoneFallbackEventHandler.java
```
```python
index
```
```python
e6635a1.
```
```python
.366790
```
```python
c
```
```python
100755
```
```python
--- a/core/java/com/android/internal/policy/PhoneFallbackEventHandler.java
+++ b/core/java/com/android/internal/policy/PhoneFallbackEventHandler.java
@@ -
```
```python
141
```
```python
,
```
```python
7
```
```python
+
```
```python
141
```
```python
,
```
```python
12
```
```python
@@
```
```python
public
```
```python
class
```
```python
PhoneFallbackEventHandler
```
```python
implements
```
```python
FallbackEventHandler
```
```python
{
```
```python
}
```
```python
case
```
```python
KeyEvent.KEYCODE_AUDIO: {
                 Log.i(TAG,
```
```python
"---KEYCODE_AUDIO DOWN---"
```
```python
);
+       
             }
+
```
```python
case
```
```python
KeyEvent.KEYCODE_WEIQIFA: {
+                Log.i(TAG,
```
```python
"KEYCODE_WEIQIFA"
```
```python
);
+            }
+
```
```python
case
```
```python
KeyEvent.KEYCODE_CAMERA: {
```
```python
if
```
```python
(getKeyguardManager().inKeyguardRestrictedInputMode() || dispatcher ==
```
```python
null
```
```python
) {
diff --git a/core/res/res/values/attrs.xml b/core/res/res/values/attrs.xml
```
```python
index
```
```python
93743
```
```python
df.
```
```python
.094e6
```
```python
c2
```
```python
100755
```
```python
--- a/core/res/res/values/attrs.xml
+++ b/core/res/res/values/attrs.xml
@@ -
```
```python
1861
```
```python
,
```
```python
6
```
```python
+
```
```python
1861
```
```python
,
```
```python
7
```
```python
@@ i
         <
```
```python
enum
```
```python
name=
```
```python
"KEYCODE_MICMUTE"
```
```python
value=
```
```python
"312"
```
```python
/>
         <
```
```python
enum
```
```python
name=
```
```python
"KEYCODE_WLAN"
```
```python
value=
```
```python
"313"
```
```python
/>
         <
```
```python
enum
```
```python
name=
```
```python
"KEYCODE_AUDIO"
```
```python
value=
```
```python
"314"
```
```python
/>
+        <
```
```python
enum
```
```python
name=
```
```python
"KEYCODE_WEIQIFA"
```
```python
value=
```
```python
"315"
```
```python
/>
     </attr>
     <!-- ***************************************************************** -->

diff --git a/include/android/keycodes.h b/include/android/keycodes.h
```
```python
index
```
```python
e3586b2..b657424
```
```python
100755
```
```python
--- a/include/android/keycodes.h
+++ b/include/android/keycodes.h
@@ -
```
```python
777
```
```python
,
```
```python
6
```
```python
+
```
```python
777
```
```python
,
```
```python
7
```
```python
@@
```
```python
enum
```
```python
{
     AKEYCODE_MICMUTE            =
```
```python
312
```
```python
,
     AKEYCODE_WLAN               =
```
```python
313
```
```python
,
     AKEYCODE_AUDIO              =
```
```python
314
```
```python
+    AKEYCODE_WEIQIFA              =
```
```python
315
```
```python
// NOTE: If you add a new keycode here you must also add it to several other files.
```
```python
//       Refer to frameworks/base/core/java/android/view/KeyEvent.java for the full list.
```
```python
diff --git a/include/input/InputEventLabels.h b/include/input/InputEventLabels.h
```
```python
index
```
```python
fabf912.
```
```python
.1
```
```python
cd69a2
```
```python
100755
```
```python
--- a/include/input/InputEventLabels.h
+++ b/include/input/InputEventLabels.h
@@ -
```
```python
68
```
```python
,
```
```python
6
```
```python
+
```
```python
68
```
```python
,
```
```python
7
```
```python
@@
```
```python
static
```
```python
const InputEventLabel KEYCODES[] = {
     DEFINE_KEYCODE(POWER),
     DEFINE_KEYCODE(WLAN),
     DEFINE_KEYCODE(AUDIO),
+    DEFINE_KEYCODE(WEIQIFA),
     DEFINE_KEYCODE(CAMERA),
     DEFINE_KEYCODE(CLEAR),
     DEFINE_KEYCODE(A),
```
**如果出现以下编译错误**
```python
out/target/common/obj/PACKAGING/test-api.txt:41961
```
```python
:
```
```python
error 5: Added public field android.view.KeyEvent.KEYCODE_WEIQIFA
```
```python
******************************
You have tried
```
```python
to
```
```python
change
```
```python
the
```
```python
API
```
```python
from
```
```python
what has been previously approved.
To make these errors go away, you have
```
```python
two
```
```python
choices:
```
```python
1
```
```python
) You can
```
```python
add
```
```python
"@hide"
```
```python
javadoc comments
```
```python
to
```
```python
the
```
```python
methods, etc. listed
```
```python
in
```
```python
the
```
```python
errors above.
```
```python
2
```
```python
) You can update current.txt
```
```python
by
```
```python
executing
```
```python
the
```
```python
following
```
```python
command
```
```python
:
```
```python
make update-api
      To submit
```
```python
the
```
```python
revised current.txt
```
```python
to
```
```python
the
```
```python
main Android repository,
      you will need approval.
******************************
```
**提示你运行make update-api，但是要先回退current.txt 和system-current.txt，因为这两个文件就是make update-api生成出来的**
```python
git checkout api/current
```
```python
.txt
```
```python
git checkout api/system-current
```
```python
.txt
```
```python
make update-api
```
**关于make update-api详细看这个**[https://blog.csdn.net/u010229714/article/details/73840014](https://blog.csdn.net/u010229714/article/details/73840014)
**如果需要调试，可以打开下面的调试文件**
```python
--- a/services/core/java/com/android/
```
```python
server
```
```python
/input/InputManagerService.java
+++ b/services/core/java/com/android/
```
```python
server
```
```python
/input/InputManagerService.java
@@ -
```
```python
125
```
```python
,
```
```python
7
```
```python
+
```
```python
125
```
```python
,
```
```python
7
```
```python
@@ import libcore.util.Objects;
```
```python
public
```
```python
class
```
```python
InputManagerService
```
```python
extends
```
```python
IInputManager
```
```python
.
```
```python
Stub
```
```python
implements
```
```python
Watchdog
```
```python
.
```
```python
Monitor
```
```python
{
```
```python
static
```
```python
final
```
```python
String TAG =
```
```python
"InputManager"
```
```python
;
-
```
```python
static
```
```python
final
```
```python
boolean
```
```python
DEBUG =
```
```python
false
```
```python
;
+
```
```python
static
```
```python
final
```
```python
boolean
```
```python
DEBUG =
```
```python
true
```
```python
;
```
```python
private
```
```python
static
```
```python
final
```
```python
String EXCLUDED_DEVICES_PATH =
```
```python
"etc/excluded-input-devices.xml"
```
```python
;
--- a/services/core/java/com/android/
```
```python
server
```
```python
/policy/PhoneWindowManager.java
+++ b/services/core/java/com/android/
```
```python
server
```
```python
/policy/PhoneWindowManager.java
@@ -
```
```python
172
```
```python
,
```
```python
7
```
```python
+
```
```python
172
```
```python
,
```
```python
7
```
```python
@@
```
```python
public
```
```python
class
```
```python
PhoneWindowManager
```
```python
implements
```
```python
WindowManagerPolicy
```
```python
{
```
```python
static
```
```python
final
```
```python
String TAG =
```
```python
"WindowManager"
```
```python
;
```
```python
static
```
```python
final
```
```python
boolean
```
```python
DEBUG =
```
```python
false
```
```python
;
```
```python
static
```
```python
final
```
```python
boolean
```
```python
localLOGV =
```
```python
false
```
```python
;
-
```
```python
static
```
```python
final
```
```python
boolean
```
```python
DEBUG_INPUT =
```
```python
false
```
```python
;
+
```
```python
static
```
```python
final
```
```python
boolean
```
```python
DEBUG_INPUT =
```
```python
true
```
```python
;
```
```python
static
```
```python
final
```
```python
boolean
```
```python
DEBUG_KEYGUARD =
```
```python
false
```
```python
;
```
```python
static
```
```python
final
```
```python
boolean
```
```python
DEBUG_LAYOUT =
```
```python
false
```
```python
;
```
```python
static
```
```python
final
```
```python
boolean
```
```python
DEBUG_STARTING_WINDOW =
```
```python
false
```
```python
;
--- a/services/inputflinger/InputDispatcher.cpp
+++ b/services/inputflinger/InputDispatcher.cpp
@@ -
```
```python
17
```
```python
,
```
```python
31
```
```python
+
```
```python
17
```
```python
,
```
```python
31
```
```python
@@
```
```python
#define LOG_TAG "InputDispatcher"
```
```python
#define ATRACE_TAG ATRACE_TAG_INPUT
```
```python
-
```
```python
//#define LOG_NDEBUG 0
```
```python
+
```
```python
#define LOG_NDEBUG 1
```
```python
// Log detailed debug messages about each inbound event notification to the dispatcher.
```
```python
-
```
```python
#define DEBUG_INBOUND_EVENT_DETAILS 0
```
```python
+
```
```python
#define DEBUG_INBOUND_EVENT_DETAILS 1
```
```python
// Log detailed debug messages about each outbound event processed by the dispatcher.
```
```python
-
```
```python
#define DEBUG_OUTBOUND_EVENT_DETAILS 0
```
```python
+
```
```python
#define DEBUG_OUTBOUND_EVENT_DETAILS 1
```
```python
// Log debug messages about the dispatch cycle.
```
```python
-
```
```python
#define DEBUG_DISPATCH_CYCLE 0
```
```python
+
```
```python
#define DEBUG_DISPATCH_CYCLE 1
```
```python
// Log debug messages about registrations.
```
```python
-
```
```python
#define DEBUG_REGISTRATION 0
```
```python
+
```
```python
#define DEBUG_REGISTRATION 1
```
```python
// Log debug messages about input event injection.
```
```python
-
```
```python
#define DEBUG_INJECTION 0
```
```python
+
```
```python
#define DEBUG_INJECTION 1
```
```python
// Log debug messages about input focus tracking.
```
```python
-
```
```python
#define DEBUG_FOCUS 0
```
```python
+
```
```python
#define DEBUG_FOCUS 1
```
```python
// Log debug messages about the app switch latency optimization.
```
```python
-
```
```python
#define DEBUG_APP_SWITCH 0
```
```python
+
```
```python
#define DEBUG_APP_SWITCH 1
```
```python
// Log debug messages about hover events.
```
```python
-
```
```python
#define DEBUG_HOVER 0
```
```python
+
```
```python
#define DEBUG_HOVER 1
```
```python
#include "InputDispatcher.h"
```
```python
diff --git a/services/inputflinger/InputReader.cpp b/services/inputflinger/InputReader.cpp
```
```python
index
```
```python
c8dc454.
```
```python
.3
```
```python
a622fc
```
```python
100644
```
```python
--- a/services/inputflinger/InputReader.cpp
+++ b/services/inputflinger/InputReader.cpp
@@ -
```
```python
16
```
```python
,
```
```python
10
```
```python
+
```
```python
16
```
```python
,
```
```python
10
```
```python
@@
```
```python
#define LOG_TAG "InputReader"
```
```python
-
```
```python
//#define LOG_NDEBUG 0
```
```python
+
```
```python
#define LOG_NDEBUG 1
```
```python
// Log debug messages for each raw event received from the EventHub.
```
```python
-
```
```python
#define DEBUG_RAW_EVENTS 0
```
```python
+
```
```python
#define DEBUG_RAW_EVENTS 1
```
```python
// Log debug messages about touch screen filtering hacks.
```
```python
#define DEBUG_HACKS 0
```
```python
diff --git a/libs/input/InputTransport.cpp b/libs/input/InputTransport.cpp
```
```python
index
```
```python
2
```
```python
dff4e0.
```
```python
.977
```
```python
aa22
```
```python
100644
```
```python
--- a/libs/input/InputTransport.cpp
+++ b/libs/input/InputTransport.cpp
@@ -
```
```python
5
```
```python
,
```
```python
19
```
```python
+
```
```python
5
```
```python
,
```
```python
19
```
```python
@@
```
```python
//
```
```python
#define LOG_TAG "InputTransport"
```
```python
-
```
```python
//#define LOG_NDEBUG 0
```
```python
+
```
```python
#define LOG_NDEBUG 1
```
```python
// Log debug messages about channel messages (send message, receive message)
```
```python
-
```
```python
#define DEBUG_CHANNEL_MESSAGES 0
```
```python
+
```
```python
#define DEBUG_CHANNEL_MESSAGES 1
```
```python
// Log debug messages whenever InputChannel objects are created/destroyed
```
```python
-
```
```python
#define DEBUG_CHANNEL_LIFECYCLE 0
```
```python
+
```
```python
#define DEBUG_CHANNEL_LIFECYCLE 1
```
```python
// Log debug messages about transport actions
```
```python
-
```
```python
#define DEBUG_TRANSPORT_ACTIONS 0
```
```python
+
```
```python
#define DEBUG_TRANSPORT_ACTIONS 1
```
```python
// Log debug messages about touch event resampling
```
```python
-
```
```python
#define DEBUG_RESAMPLING 0
```
```python
+
```
```python
#define DEBUG_RESAMPLING 1
```
# 7 App接收键值
主要参照这个链接来写
[https://www.cnblogs.com/zhujiabin/p/5915802.html](https://www.cnblogs.com/zhujiabin/p/5915802.html)
例程Android studio源码
[链接：https://pan.baidu.com/s/1hzhQ-dLSRnAbg2Q8w5qKPw 密码：944g](%E9%93%BE%E6%8E%A5%EF%BC%9Ahttps://pan.baidu.com/s/1hzhQ-dLSRnAbg2Q8w5qKPw%20%E5%AF%86%E7%A0%81%EF%BC%9A944g)
```python
@Override
```
```python
public
```
```python
boolean
```
```python
dispatchKeyEvent
```
```python
(KeyEvent
```
```python
event
```
```python
) {
```
```python
if
```
```python
(
```
```python
event
```
```python
.getKeyCode() == KeyEvent.KEYCODE_ENTER){
```
```python
/*隐藏软键盘*/
```
```python
InputMethodManager inputMethodManager = (InputMethodManager) getSystemService(Context.INPUT_METHOD_SERVICE);
```
```python
if
```
```python
(inputMethodManager.isActive()){
                inputMethodManager.hideSoftInputFromWindow(MainActivity.
```
```python
this
```
```python
.getCurrentFocus().getWindowToken(),
```
```python
0
```
```python
);
            }
            edittext.setText(
```
```python
"success"
```
```python
);
            webview.loadUrl(URL);
```
```python
return
```
```python
true
```
```python
;
        }
```
```python
return
```
```python
super.dispatchKeyEvent(
```
```python
event
```
```python
);
    }
```
# 8 命令调试
## 8.1 测试上报时间
**触发Input上报的时间点**
```python
rk3399_mid:/ $ logcat -s
```
```python
"CAE_LOG"
```
```python
|grep -
```
```python
E
```
```python
CAEIvwCb
```
```python
09
```
```python
-
```
```python
06
```
```python
14
```
```python
:
```
```python
10
```
```python
:
```
```python
13.502
```
```python
327
```
```python
436
```
```python
D
```
```python
CAE_LOG : CAEIvwCb angle =
```
```python
23
```
```python
,beam =
```
```python
0
```
```python
CMScore =
```
```python
1643
```
**APK接收到键值的时间点**
```python
09
```
```python
-
```
```python
06
```
```python
14
```
```python
:
```
```python
10
```
```python
:
```
```python
13.518
```
```python
5693
```
```python
-
```
```python
5693
```
```python
/
```
```python
com
```
```python
.hu
```
```python
.audiotest
```
```python
D/audiotest_MainActivity: KeyEvent
```
```python
.KEYCODE
```
```python
_ENTER KeyCode0
```
```python
09
```
```python
-
```
```python
06
```
```python
14
```
```python
:
```
```python
10
```
```python
:
```
```python
13.522
```
```python
5693
```
```python
-
```
```python
5693
```
```python
/
```
```python
com
```
```python
.hu
```
```python
.audiotest
```
```python
D/audiotest_MainActivity: KeyEvent
```
```python
.KEYCODE
```
```python
_ENTER KeyCode0
```
**消耗的时间大概需要16MS，但是触发是通过HAL层触发的，如果从Kerne触发事间会更短一些**
## 8.2 设备文件调试
**我们kernel下面正常用 getevent 来调试**
**getevent -l**
**cat /proc/bus/input/devices**
```python
rk3399_mid:
```
```python
/
```
```python
# getevent -l
```
```python
add
```
```python
device
```
```python
1
```
```python
: /dev/input/event2
  name:
```
```python
"rk29-keypad"
```
```python
add
```
```python
device
```
```python
2
```
```python
: /dev/input/event1
  name:
```
```python
"as9102 Touchscreen"
```
```python
add
```
```python
device
```
```python
3
```
```python
: /dev/input/event0
  name:
```
```python
"iflytek"
```
```python
/dev/input/event0: EV_KEY
```
```python
00
```
```python
f9                 DOWN
/dev/input/event0: EV_SYN       SYN_REPORT
```
```python
00000000
```
```python
/dev/input/event0: EV_KEY
```
```python
00
```
```python
f9                 UP
/dev/input/event0: EV_SYN       SYN_REPORT
```
```python
00000000
```
## 8.3 adb 上报键值调试
我们正常用adb shell input keyevent xx xx代表键值
可以用input来触发touchscreen也是可以的
有个比较好的文章
[https://blog.csdn.net/jlminghui/article/details/39268419](https://blog.csdn.net/jlminghui/article/details/39268419)
大部分支持的键值如下
```python
0
```
```python
-
```
```python
->
```
```python
"KEYCODE_UNKNOWN"
```
```python
1
```
```python
-
```
```python
->
```
```python
"KEYCODE_MENU"
```
```python
2
```
```python
-
```
```python
->
```
```python
"KEYCODE_SOFT_RIGHT"
```
```python
3
```
```python
-
```
```python
->
```
```python
"KEYCODE_HOME"
```
```python
4
```
```python
-
```
```python
->
```
```python
"KEYCODE_BACK"
```
```python
5
```
```python
-
```
```python
->
```
```python
"KEYCODE_CALL"
```
```python
6
```
```python
-
```
```python
->
```
```python
"KEYCODE_ENDCALL"
```
```python
7
```
```python
-
```
```python
->
```
```python
"KEYCODE_0"
```
```python
8
```
```python
-
```
```python
->
```
```python
"KEYCODE_1"
```
```python
9
```
```python
-
```
```python
->
```
```python
"KEYCODE_2"
```
```python
10
```
```python
-
```
```python
->
```
```python
"KEYCODE_3"
```
```python
11
```
```python
-
```
```python
->
```
```python
"KEYCODE_4"
```
```python
12
```
```python
-
```
```python
->
```
```python
"KEYCODE_5"
```
```python
13
```
```python
-
```
```python
->
```
```python
"KEYCODE_6"
```
```python
14
```
```python
-
```
```python
->
```
```python
"KEYCODE_7"
```
```python
15
```
```python
-
```
```python
->
```
```python
"KEYCODE_8"
```
```python
16
```
```python
-
```
```python
->
```
```python
"KEYCODE_9"
```
```python
17
```
```python
-
```
```python
->
```
```python
"KEYCODE_STAR"
```
```python
18
```
```python
-
```
```python
->
```
```python
"KEYCODE_POUND"
```
```python
19
```
```python
-
```
```python
->
```
```python
"KEYCODE_DPAD_UP"
```
```python
20
```
```python
-
```
```python
->
```
```python
"KEYCODE_DPAD_DOWN"
```
```python
21
```
```python
-
```
```python
->
```
```python
"KEYCODE_DPAD_LEFT"
```
```python
22
```
```python
-
```
```python
->
```
```python
"KEYCODE_DPAD_RIGHT"
```
```python
23
```
```python
-
```
```python
->
```
```python
"KEYCODE_DPAD_CENTER"
```
```python
24
```
```python
-
```
```python
->
```
```python
"KEYCODE_VOLUME_UP"
```
```python
25
```
```python
-
```
```python
->
```
```python
"KEYCODE_VOLUME_DOWN"
```
```python
26
```
```python
-
```
```python
->
```
```python
"KEYCODE_POWER"
```
```python
27
```
```python
-
```
```python
->
```
```python
"KEYCODE_CAMERA"
```
```python
28
```
```python
-
```
```python
->
```
```python
"KEYCODE_CLEAR"
```
```python
29
```
```python
-
```
```python
->
```
```python
"KEYCODE_A"
```
```python
30
```
```python
-
```
```python
->
```
```python
"KEYCODE_B"
```
```python
31
```
```python
-
```
```python
->
```
```python
"KEYCODE_C"
```
```python
32
```
```python
-
```
```python
->
```
```python
"KEYCODE_D"
```
```python
33
```
```python
-
```
```python
->
```
```python
"KEYCODE_E"
```
```python
34
```
```python
-
```
```python
->
```
```python
"KEYCODE_F"
```
```python
35
```
```python
-
```
```python
->
```
```python
"KEYCODE_G"
```
```python
36
```
```python
-
```
```python
->
```
```python
"KEYCODE_H"
```
```python
37
```
```python
-
```
```python
->
```
```python
"KEYCODE_I"
```
```python
38
```
```python
-
```
```python
->
```
```python
"KEYCODE_J"
```
```python
39
```
```python
-
```
```python
->
```
```python
"KEYCODE_K"
```
```python
40
```
```python
-
```
```python
->
```
```python
"KEYCODE_L"
```
```python
41
```
```python
-
```
```python
->
```
```python
"KEYCODE_M"
```
```python
42
```
```python
-
```
```python
->
```
```python
"KEYCODE_N"
```
```python
43
```
```python
-
```
```python
->
```
```python
"KEYCODE_O"
```
```python
44
```
```python
-
```
```python
->
```
```python
"KEYCODE_P"
```
```python
45
```
```python
-
```
```python
->
```
```python
"KEYCODE_Q"
```
```python
46
```
```python
-
```
```python
->
```
```python
"KEYCODE_R"
```
```python
47
```
```python
-
```
```python
->
```
```python
"KEYCODE_S"
```
```python
48
```
```python
-
```
```python
->
```
```python
"KEYCODE_T"
```
```python
49
```
```python
-
```
```python
->
```
```python
"KEYCODE_U"
```
```python
50
```
```python
-
```
```python
->
```
```python
"KEYCODE_V"
```
```python
51
```
```python
-
```
```python
->
```
```python
"KEYCODE_W"
```
```python
52
```
```python
-
```
```python
->
```
```python
"KEYCODE_X"
```
```python
53
```
```python
-
```
```python
->
```
```python
"KEYCODE_Y"
```
```python
54
```
```python
-
```
```python
->
```
```python
"KEYCODE_Z"
```
```python
55
```
```python
-
```
```python
->
```
```python
"KEYCODE_COMMA"
```
```python
56
```
```python
-
```
```python
->
```
```python
"KEYCODE_PERIOD"
```
```python
57
```
```python
-
```
```python
->
```
```python
"KEYCODE_ALT_LEFT"
```
```python
58
```
```python
-
```
```python
->
```
```python
"KEYCODE_ALT_RIGHT"
```
```python
59
```
```python
-
```
```python
->
```
```python
"KEYCODE_SHIFT_LEFT"
```
```python
60
```
```python
-
```
```python
->
```
```python
"KEYCODE_SHIFT_RIGHT"
```
```python
61
```
```python
-
```
```python
->
```
```python
"KEYCODE_TAB"
```
```python
62
```
```python
-
```
```python
->
```
```python
"KEYCODE_SPACE"
```
```python
63
```
```python
-
```
```python
->
```
```python
"KEYCODE_SYM"
```
```python
64
```
```python
-
```
```python
->
```
```python
"KEYCODE_EXPLORER"
```
```python
65
```
```python
-
```
```python
->
```
```python
"KEYCODE_ENVELOPE"
```
```python
66
```
```python
-
```
```python
->
```
```python
"KEYCODE_ENTER"
```
```python
67
```
```python
-
```
```python
->
```
```python
"KEYCODE_DEL"
```
```python
68
```
```python
-
```
```python
->
```
```python
"KEYCODE_GRAVE"
```
```python
69
```
```python
-
```
```python
->
```
```python
"KEYCODE_MINUS"
```
```python
70
```
```python
-
```
```python
->
```
```python
"KEYCODE_EQUALS"
```
```python
71
```
```python
-
```
```python
->
```
```python
"KEYCODE_LEFT_BRACKET"
```
```python
72
```
```python
-
```
```python
->
```
```python
"KEYCODE_RIGHT_BRACKET"
```
```python
73
```
```python
-
```
```python
->
```
```python
"KEYCODE_BACKSLASH"
```
```python
74
```
```python
-
```
```python
->
```
```python
"KEYCODE_SEMICOLON"
```
```python
75
```
```python
-
```
```python
->
```
```python
"KEYCODE_APOSTROPHE"
```
```python
76
```
```python
-
```
```python
->
```
```python
"KEYCODE_SLASH"
```
```python
77
```
```python
-
```
```python
->
```
```python
"KEYCODE_AT"
```
```python
78
```
```python
-
```
```python
->
```
```python
"KEYCODE_NUM"
```
```python
79
```
```python
-
```
```python
->
```
```python
"KEYCODE_HEADSETHOOK"
```
```python
80
```
```python
-
```
```python
->
```
```python
"KEYCODE_FOCUS"
```
```python
81
```
```python
-
```
```python
->
```
```python
"KEYCODE_PLUS"
```
```python
82
```
```python
-
```
```python
->
```
```python
"KEYCODE_MENU"
```
```python
83
```
```python
-
```
```python
->
```
```python
"KEYCODE_NOTIFICATION"
```
```python
84
```
```python
-
```
```python
->
```
```python
"KEYCODE_SEARCH"
```
```python
85
```
```python
-
```
```python
->
```
```python
"TAG_LAST_KEYCODE"
```
![这里写图片描述](https://img-blog.csdn.net/20180906115101910?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXFpZmEw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

