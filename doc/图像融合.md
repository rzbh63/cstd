# 图像融合





# （一）-- 概述



　　这是2014年第二部分的内容。关于三光检测融合的一些资料整理，部分内容由于保密原因没有写出来，这里整理的内容都是网上或者文章里可以看到的。

# 一、概述

　　图像融合是图像处理中重要部分，能够协同利用同一场景的多种传感器图像信息，输出一幅更适合于人类视觉感知或计算机进一步处理与分析的融合图像。它可明显的改善单一传感器的不足，提高结果图像的清晰度及信息包含量，有利于更为准确、更为可靠、更为全面地获取目标或场景的信息。

　　图像融合主要应用于军事国防上、遥感方面、医学图像处理、机器人、安全和监控、生物监测等领域。用于较多也较成熟的是红外和可见光的融合，在一副图像上显示多种信息，突出目标。

　　融合过程可以在不同的层次上进行，可分为：信号级、像素级、特征级，决策级。

## 1.1、信号级

​    　在最低层对未经处理的传感器输出在信号域进行混合，产生一个融合后的信号。融合后的信号与源信号形式相同但品质更好，来自传感器的信号可建模为混有不同相关噪声的随机变量。此种情况下，融合可以考虑为一种估计过程，信号级图像融合在很大程度上是信号的最优集中或分布检测问题，对信号时间和空间上的配准要求最高。

## 1.2、像素级

　　像素级图像融合是三个层次中最基本的融合，经过像素级图像融合以后得到的图像具有更多的细节信息，如边缘、纹理的提取，有利于图像的进一步分析、处理与理解，还能够把潜在的目标暴露出来，利于判断识别潜在的目标像素点的操作，这种方法才可以尽可能多的保存源图像中的信息，使得融合后的图片不论是内容还是细节都有所增加，这个优点是独一无二的，仅存在于像素级融合中。但像素级图像融合的局限性也是不能忽视的，由于它是对像素点进行操作，所以计算机就要对大量的数据进行处理，处理时所消耗的时间会比较长，就不能够及时地将融合后图像显示出来，无法实现实时处理；另外在进行数据通信时，信息量较大，容易受到噪声的影响；还有如果没有将图片进行严格的配准就直接参加图像融合，会导致融合后的图像模糊，目标和细节不清楚、不精确。

## 1.3、特征级

​       特征级图像融合是从源图像中将特征信息提取出来，这些特征信息是观察者对源图像中目标或感兴趣的区域，如边缘、人物、建筑或车辆等信息，然后对这些特征信息进行分析、处理与整合从而得到融合后的图像特征。对融合后的特征进行目标识别的精确度明显的高于原始图像的精确度。特征级融合对图像信息进行了压缩，再用计算机分析与处理，所消耗的内存与时间与像素级相比都会减少，所需图像的实时性就会有所提高。特征级图像融合对图像匹配的精确度的要求没有第一层那么高，计算速度也比第一层快，可是它提取图像特征作为融合信息，所以会丢掉很多的细节性特征。

## 1.4、决策级

　　决策级图像融合是以认知为基础的方法，它不仅是最高层次的图像融合方法，抽象等级也是最高的。决策级图像融合是有针对性的，根据所提问题的具体要求，将来自特征级图像所得到的特征信息加以利用，然后根据一定的准则以及每个决策的可信度（目标存在的概率）直接作出最优决策。三个融合层级中，决策级图像融合的计算量是最小的，可是这种方法对前一个层级有很强的依赖性，得到的图像与前两种融合方法相比不是很清晰。将决策级图像融合实现起来比较困难，但图像传输时噪声对它的影响最小。

 

　　综合以上，研究和应用最多的是像数级图像融合，目前提出的绝大多数的图像融合算法均属于该层次上的融合。图像融合狭义上指的就是像数级图像融合。本文研究的也正是像素级图像融合算法。

　　*红外和可见的融合很多文献都是从像素级入手，基于已有的融合算法，根据实际情况，来设立融合规则，得到适合实际应用场景的融合图像。*



# （二）-- 简单加权融合



　　

　　简单加权融合也叫做像素加权平均法（Weighted Averaging，WA）是最简单、直接的图像融合方法。它具有简单易实现、运算速度快的优点，并能提高融合图像的信噪比，但是这种方法削弱了图像中的细节信息，降低了图像的对比度，在一定程度上使得图像中的边缘变模糊，在多数应用场合难以取得满意的融合效果。

​        优化：主成分分析(Principal Component Analysis，PCA)就是一种常用的系数优化方法，利用主成分分析确定的权值可以得到一幅亮度方差最大的融合图像。PCA方法运用于高分辨率全色图像与低分辨率多光谱图像的融合时，通过用高分辨率全色图像替代由低分辨率多光谱图像提取出的第一主成分，得到同时具有高空间分辨率和高光谱分。

　　从性能上讲，主成分分析法更像是对源图像的选择而不是对源图像中显著信息的融和。局限性：以全局方差作为信息显著性度量通常会把较大的权值分配给方差较大的源图像。实际应用中，当某一传感器输出图像对比度较低时，这种权值分配方法效果会比较好，但就一般情况而言，这种分配方法并不科学。此外，主成分分析法对图像中的死点、噪声等干扰信息非常敏感，这些干扰信息会显著的提高图像的全局方差。





# [（三）-- 拉普拉斯金字塔](https://www.cnblogs.com/silence-hust/p/4193208.html)



## 2、拉普拉斯金字塔融合

　　图像金字塔方法的原理是：将参加融合的的每幅图像分解为多尺度的金字塔图像序列，将低分辨率的图像在上层，高分辨率的图像在下层，上层图像的大小为前一层图像大小的1/4。层数为0,1,2……N。将所有图像的金字塔在相应层上以一定的规则融合，就可得到合成金字塔，再将该合成金字塔按照金字塔生成的逆过程进行重构，得到融合金字塔。这个总的思路就是一下所有基于金字塔融合的算法过程，不同点就在于分解构造的金字塔不同，每层的融合规则不一样，重构的方法不同而已。金字塔方法最先实现了这种思想，之后小波方法进一步完善和发展了这种多尺度融和的思想。

### 2.1、原理阐述

#### （1）高斯金字塔

　　高斯金字塔是最基本的图像塔。首先将原图像作为最底层图像G0（高斯金字塔的第0层），利用高斯核（5*5）对其进行卷积，然后对卷积后的图像进行下采样（去除偶数行和列）得到上一层图像G1，将此图像作为输入，重复卷积和下采样操作得到更上一层图像，反复迭代多次，形成一个金字塔形的图像数据结构，即高斯金字塔。

高斯金字塔的构建过程为：假设高斯金字塔的第L层图像为Gl：

![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-lp1.1.jpg)

式中N为高斯金字塔顶层层号，Rl和Cl分别为高斯金字塔第l层的行数和列数W（m，n）是一个二维可分离的5*5窗口函数，表达式为：

![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-lp1.2.jpg)

　　由G0，G1，，，GN，就构成了一个高斯金字塔，其中G0为高斯金字塔的底层（与原图像相同）GN为金字塔的顶层。由此可见高斯金字塔的当前层图像就是对其前一层图像首先进行高斯低通滤波，然后再进行隔行和隔列的降2采样而生成的。前一层图像大小依次为当前层图像大小的4倍。

Opencv中使用pyrdown函数就可以获得高斯金字塔。

#### （2）拉普拉斯金字塔

　　在高斯金字塔的运算过程中，图像经过卷积和下采样操作会丢失部分高频细节信息。为描述这些高频信息，人们定义了拉普拉斯金字塔(Laplacian Pyramid， LP)。用高斯金字塔的每一层图像减去其上一层图像上采样并高斯卷积之后的预测图像，得到一系列的差值图像即为 LP 分解图像。

将Gl内插方法得到放大图像*Gl，使*Gl的尺寸与*Gl-1的尺寸相同，即放大算子Expand

![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-lp1.3.jpg)

该式子实现两个步骤：在偶数行和列插入0，然后使用下采样中的高斯核进行滤波处理，得到和l-1层一样大小的图像。![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-lp1.4.jpg)

 

　　N为拉普拉斯金字塔顶层的层号LPl是拉普拉斯金字塔分解的第L层图像。由LP0，LP1、LP2…LPN构成的金字塔即为拉普拉斯金字塔。它的每一层L0图像是高斯金字塔本层G0图像与其高一层图像G1经内插放大后图像*G1的差，此过程相当于带通滤波，因此拉普拉斯金字塔又称为带通金字塔分解。

　　内插方法：opencv中有实现的函数pyrup。可以得到*G1。然后在两个函数作差，相减就可以得到拉普拉斯金字塔。

　　求得每个图像的拉普拉斯金字塔后需要对相应层次的图像进行融合，具体的融合规则有，取大、取小，等等。

#### （3）重构

​    　对融合后的拉普拉斯金字塔，从其顶层开始逐层从上至下按下式进行递推，可以恢复其对应的高斯金字塔，并最终可得到原图像G0。就是从最高层开始使用内插的方法。

![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-lp1.5.jpg)

### 2.2、融合应用

　　图像拉普拉斯金字塔分解的目的是将源图像分别分解到不同的空间频带上，融合过程是在各空间频率层上分别进行的，这样就可以针对不同分解层的不同频带上的特征与细节，采用不同的融合算子以达到突出特定频带上特征与细节的目的。即有可能将来自不同图像的特征与细节融合在一起。

#### （1）顶层处理

　　设LAl和LBl分别为源图像A,B经过拉普拉斯金字塔分解后得到的第l层图像，融合后的结果为LFl。当l=N时，LAN和LBN分别为源图像A，B经过拉普拉斯金字塔分解后得到的顶层图像。对于顶层图像的融合，首先计算以其各个像素为中心的区域大小为M*N(M、N取奇数且M >= 3、N >= 3)的区域平均梯度：

![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-lp1.6.jpg)

其中，Ix与Iy分别为像素f(x,y)在x与y方向上的一阶差分，定义如下：

![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-lp1.7.jpg)

　　因此对于顶层图像中的每一个像素LAN(i, j)和LBN(i, j)都可以得到与之相对应的区域平均梯度GA(i, j)和GB(i, j)。由于平均梯度反映了图像中的微小细节反差和纹理变化特征，同时也反映出图像的清晰度。一般来说平均梯度越大，图像层次也丰富，则图像越清晰。因此顶层图像的融合结果为：

![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-lp1.8.jpg)

#### （2）各层次处理

　　当0<l<N时，则对于经过拉普拉斯金字塔分解的第l层图像，首先计算其区域能量：

![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-lp1.9.jpg)

 

则其他层次图像的融合结果为：

![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-lp1.10.jpg)

在得到金字塔各个层次的融合图像LF1、LF2、LFN后。通过前面的重构，便可得到最终的融合图像。

　第二种融合规则：

​    采用最高层系数取平均，其余各层系数绝对值取大的融合策略进行融合。融合后图像的系数（灰度值）越接近较清晰图像的灰度值就说明融合效果好。

 





# [（四）-- 对比度金字塔](https://www.cnblogs.com/silence-hust/p/4193398.html)



# 对比度金字塔融合

在考虑人类视觉系统对局部对比度敏感这一视觉特性的基础上，提出了基于对比度金字塔(Contrast Pyramid，CP)分解的图像融合算法。CP 分解类似于 LP 分解，但它的每一层图像是高斯金字塔相邻两层图像的比率。 CP 融合算法应用于合成孔径雷达和前视红外图像融合。

## 1、原理阐述

###        （1）得到高斯金字塔（如上篇）

### 　　（2）对比度金字塔

　　用高斯金字塔得到上采样并高斯卷积之后的预测图像*Gl，*Gl的尺寸和Cl-1相同，即经过放大算子的处理（pyrup）。图像的对比度通常定义为：C = (g -gb)/gb= g/gb-I，这里g为图象某位置处的灰度值、gb为该位置处的背景灰度值、I表示单位灰度值图像。因窗口函数w(m，n)具低通滤波特性，所以G*l+1可以看作是Gl的背景，故可定义图像的对比度金字塔为：

![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-cp1.1.jpg)

　　就是0层的G0除以G1上采样的得到的*G1再减去1，得到的就是对比度金字塔。

### （3）重构

![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-cp1.2.png)

​       从对比度金字塔(CN、CN-1、、、C0)的顶层CN开始、依次令l = N、N-1、、、0逐层由上到下、可依次得到高斯金字塔的各层GN、GN-1、G0。最终精确重构原始图像（高斯金字塔的最底层G0即为原始图象）。

## 2、融合应用

　　这里的应用和上面不同的就是融合规则的不同。

　　设A、B为两幅原始图像，F为融合后的图像。其融合的基本步骤如下：

　　1）对每一源图像分别进行对比度塔形分解，建立各图像的对比度金字塔；

　　2）对图像金字塔的各分解层分别进行融合处理，不同的分解层采用不同的融合算子进行融合处理，最终得到融合后图像的对比度金字塔；

　　3）对融合后所得对比度金字塔进行逆塔形变换（图像重构），所得到的重构图像即为融合图像。

　　*其中一种融合规则为*：采用像素取大的原则。因为对比度大的像素是图像中相对突出和比较重要的像素。即获得两个图像的对比度金字塔后，差值越大就代表处变化越大，存在明显的信息，那么对应的就取该处变化大的值，保留重要的变化信息。

　　*另一种融合规则*：基于区域特性量测的加权平均融合算子，该融合规则及融合算子的确定方法如下：

　　1)分别计算两幅图像相应分解层上对应局部区域的能量：ElA及ElB：

![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-cp1.3.png)

　　式中El(n,m)表示对比度金字塔第l层上，以(n,m)为中心位置的局部区域能量；Ll表示对比度金字塔的第l层图像；wl(n’ ,m’ )为与Ll对应的权系数；j、k定义了局部区域的大小(例如3*3、5*5或7*7等)；n’、m’的变化范围在j、k内。这里不知道w是怎么取值的。

　　*这个算法有点麻烦，具体的见：http://www.docin.com/p-735309332.html*

 

**基于对比度塔形分解的图像融合方法的物理意义**在于：

1）对比度塔形分解将原始图像分别分解到具有不同分辨率、不同空间频率的一系列分解层上（从底层到顶层，空间频率依次降低），同时，每一分解层均反映了相应空间频率上图像的对比度信息。

2）融合过程是在各空间频率层上分别进行的，这样就可能针对不同分解层的不同频带上的特征与细节，采用不同的融合算子，以达到突出特定频带上特征与细节的目的。基于对比度塔形分解的图像融合恰恰是在不同的空间频带上进行融合处理的，因而可能获得与人的视觉特性更为接近的融合效果。





# [（五）-- 梯度金字塔](https://www.cnblogs.com/silence-hust/p/4193430.html)



　　基于梯度金字塔(Gradient Pyramid,GP)分解的图像融合算法。GP 也是一种基于高斯金字塔的多尺度分解算法。通过对高斯金字塔每层图像进行梯度算子运算，便可获得图像的 GP表示。GP 每层分解图像都包含水平、垂直和两个对角线四个方向的细节信息，能更好地提取出图像的边缘信息，提高了稳定性和抗噪性。具有方向性的梯度塔形分解能够很好地提供图像的方向边缘和细节信息。

## 1、原理阐述

（1）得到高斯金字塔（如上）

（2）对图像高斯金字塔的各分解层（最高层除外）分别进行梯度方向滤波，便可得到梯度塔形分解:

![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-gp1.1.png)

这里•为卷积运算，DL K表示第L层第k方向梯度塔形图像，GL 为图像的高斯金字塔的第L层图像，dK表示第k方向梯度滤波算子，定义为：

 ![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-gp1.2.png)

 

![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-gp1.3.png)

 

　　经过 d1、d2、d3、d4对高斯金字塔各层进行方向梯度滤波，在每一分解层上（最高层除外）均可得到包含水平、垂直以及两个对角线方向细节信息的4个分解图像。可见图像的梯度塔形分解不仅是多尺度、多分辨率分解，而且每一分解层（最高层除外）又由分别包含 4个方向细节信息的图像组成。

　　这里跟上面不同的就是每一层是独立的，不需要涉及到上一层的上采样结果。对应层的Gl与3*3的核做卷积，在加上Gl的值之后取相应方向的值，就可以生成对应方向的系数了。

   （3）重构

　　对金字塔图像每一层各方向分别融合后，就需要由梯度金字塔重构原图像，须引入FSD 拉普拉斯金字塔作为中间结果，即将梯度金字塔转换为拉普拉斯金字塔，再由拉普拉斯金字塔重构原图像，其构建过程如下：

　　1、将方向梯度金字塔转换为方向拉普拉斯金字塔（FSD型）filter-subtract-decimate。设 FSD型金字塔的第L层图像为LL， 

![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-gp1.4.png)

 

　　2、将FSD 拉普拉斯金字塔图像变换为拉普拉斯金字塔图像。

![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-gp1.5.png)

 

　　注意I不是单位矩阵，只是中间一个元素为1。（不懂）

　　3、由拉普拉斯金字塔重构原图像将GL内插值进行放大，使放大后的图像尺寸与GL - 1的尺寸相同。这里就和前面的一样（pyrup）。

2、融合应用

　　采用基于区域的融合规则，基于区域的融合方法的基本思想是：在对某一分解层图像进行融合处理时，为了确定融合后图像的像素，不仅要考虑参加融合的源图像中对应的各像素，而且要考虑参加融合的像素的局部领域。即比较源图像的某方面特征，从而动态地选这方面特征突出的源图像组成融合结果。

　　梯度是一个矢量，指向边缘法线方向上取得局部的最大值的方向，和图像的边缘方向总 是正交（垂直）的。所以基于梯度的滤波器，又称边缘算子。图像经梯度滤波器滤波后，突出了相邻点间灰度级的变化，达到增强边缘的目的。以区域各点灰度值之和为特征量，进行源图像分解层的融合时，来自哪个区域的特征的值大，就将该区域中心像素点的灰度值作为融合后图像分解层上该位置的像素灰度值。这样就能很好的提取图像的边缘信息。  

 ![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-gp1.6.png)

 

**融合的基本步骤**为：

1、对每一源图像分别进行梯度塔形分建立图像的梯度金字塔。

2、对图像梯度金字塔的各分解层分别进行融合处理；不同的分解层、不同方向细节图像采用不同的融合算子进行融合处理，最终得到融合后图像的梯度金字塔。

3、对融合后所得梯度金字塔进行逆塔形变换（即进行图像重构），所得到的重构图像即融合图像对于融合规则可以选用基于区域信息的，也可以简单的取最大值的方法。



# [（六）-- 小波融合](https://www.cnblogs.com/silence-hust/p/4193480.html)



## 基于小波的融合（wavelet）

　　小波变换的固有特性使其在图像处理中有如下优点：完善的重构能力，保证信号在分解过程中没有信息损失和冗余信息；把图像分解成平均图像和细节图像的组合，分别代表了图像的不同结构，因此容易提取原始图像的结构信息和细节信息；小波分析提供了与人类视觉系统方向相吻合的选择性图像。

　　离散小波变换(Discrete Wavelet Transform, DWT)。DWT的函数基由一个称为母小波或分析小波的单一函数通过膨胀和平移获得。因而，DWT同时具有时域和频域分析能力，与一般的金字塔分解相比，DWT图像分解具有以下优势：

1）具有方向性，在提取图像低频信息的同时，还可获得了水平、垂直和对角三个方向的高频信息；

2）通过合理的选择母小波，可使DWT在压缩噪声的同时更有效的提取纹理、边缘等显著信息；

3）金字塔分解各尺度之间具有信息的相关性，而DWT在不同尺度上具有更高的独立性。

　　DWT 融合算法基本思想与金字塔算法一致，即：首先对源图像进行小波变换，然后按照一定规则对变换系数进行合并；最后对合并后的系数进行小波逆变换得到融合图像。由于不具有移不变性，基于DWT的标准小波融合算法获取的融合图像通常会存在“振铃”干扰;特别在处理连续的图像序列时，融合结果会出现明显的闪烁和抖动现象。

 **1、原理阐述**

　　（1）小波的简单计算原理

　　[x0，x1，x2，x3]=[90，70，100，70] 为达到压缩 我们可取 (x0+x1)/2  (x0-x1)/2 来代表 x0,x1  这样 [90,70] 可表示为 [80,10] 80即平均数 10是小范围波动数（可想象出一种波的形状） [90,70] --〉[80,10] , [100,70] --〉 [85,15] 可以想象80 和85 都是局部的平均值反映大的总体的状态，是变化相对缓慢的值，可以认为他们是低频部分的值。 而10、15是小范围波动的值局部变换较快，可以认为他们是高频部分的值。

　　1、 FIRST：把[90,70,100,70] 写成 [80,85,10,15] 即把低频部分写在一起（记频率L） 高频部分写在一起（H) 

　　2、 SECOND：而[80,85] 又可经同样的变换--> [82.5, -2.5] 这样 82.5表示更低频的信息(记频率LL) -2.5则表示了频率L上的波动 

　　3、最后[90,70,100,70] --〉[82.5, -2.5, 10, 15] 这样信息就可被压缩了（数字范围小了）

　　现在再来扩展一下  [90,70]---> [80,10] 写成矩阵 [90,70] * [1/2, 1/2] 

​                                                 　　　　　　　　　　　　　　　[1/2 ,-1/2] 

　　矩阵[1,1；1,-1]/2为haar转换矩阵。

　　如果是[90，70,100,70]第一步就可以写成矩阵M1：[0.5,0,0.5,0; 0.5,0,-0.5,0; 0,0.5,0,0.5;0,0.5,0,-0.5]，第二步只对低频L操作，高频不变可写成M2：

　　[1/2,  1/2, 0, 0; 1/2, -1/2, 0, 0; 0,  0,  1, 0 ;0,  0,  0, 1]。另M= M1*M2，可得到4*4的点阵操作。

　　第一步运算后原图像缩小至左边一半了，右边的是对应波动信息；

　　第二步运算后图像又缩小至左边一半了，对应波动信息。

　　对一幅图像先进行行变化，在进行列变化，那么就是小波变化了。

![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-wave1.1.png)

　　LL：水平低频，垂直低频

　　LH：水平低频，垂直高频

　　HL：水平高频，垂直低频

　　HH：水平高频，垂直高频

　　其中，L表示低频，H表示高频，下标1、2表示一级或二级分解。在每一分解层上，图像均被分解为LL，LH，HH和HL四个频带，下一层的分解仅对低频分量LL进行分解。这四个子图像中的每一个都是由原图与一个小波基函数的内积后，再经过在x和y方向都进行2倍的间隔采样而生成的。这是正变换，也就是图像的分解；逆变换，也就是图像的重建。是通过图像的增频采样和卷积来实现的。这里有个问题进过处理后，数据或超出255或者出现负数，需要将其归一化到0-255之间，方可显示图像。这里介绍的只是简单的小波计算，小波计算的而不同就在于选取不同的小波系数，一般有haar小波，sym2小波等。

资料：<http://www.blogbus.com/shijuanfeng-logs/221385402.html>

 

### 2、融合规则

规则一：系数绝对值较大法

　　该融合规则适合高频成分比较丰富，亮度、对比度比较高的源图像，否则在融合图像中只保留一幅源图像的特征，其他的特征被覆盖。小波变换的实际作用是对信号解相关，并将信号的全部信息集中到一部分具有大幅值的小波系数中。这些大的小波系数含有的能量远比小系数含有的能量大，从而在信号的重构中，大的系数比小的系数更重要。

规则二：加权平均法

　　权重系数可调，适用范围广，可消除部分噪声，源图像信息损失较少，但会造成图像对比度的下降，需要增强图像灰度。

规则三：局部方差准则

　　设A(x,y)和B(x,y)分别为高频子图像数据值，F(x,y)为相应高频子图像融合值，将A(x,y)和B(x,y)分成若干个M×N子块图像。对每个子块图像进行数值分布统计，计算其方差。确定A和B图像每个子块图像加权系数K1和K2。如果A图像子块方差大于B图像子块方差,则K1≥K2，否则K1<K2。确定每个子块图像的数据融合数值为：F(i,j)=K1A(i,j)+K2B(i,j)。

### 3、融合应用

　　若对二维图像进行N层的小波分解,最终将有(3N+1)个高低频带，其中包含3N个高频带和一个低频带。图像融合的基本步骤如下。

　　1）对每一源图像分别进行小波分解，建立图像的小波金字塔分解。

　　2）对各分解层分别进行融合处理，采用不同的融合算子对各分解层的不同频率分量进行融合处理，最终得到融合后的小波金字塔。低频：加权平均，高频：绝对值取大。

　　3）对融合后所得的小波金字塔进行小波逆变换，所得到的重构图像即为融合后的图像。

![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-wave1.2.png)

　　**图像的低频部表现的是图像的概貌和平均特性；图像的高频反应的是图像的细节特性，如图像的边缘、区域边界等。**

　　**融合规则**：

　　基于局部方差的融合规则：在邻域W中，图像I在以（i ，j)为中心点的局部方差定义：

![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-wave1.3.png)

　　式中为图像I 的均值，M，N 分别为局部区域的行数和列数，这里取局部区域为3*3，基于局部方差的融合方式常用的方法是选择法，即通常说的局部方差取大法。方差选择法的融合规则：

![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-wave1.4.png)

　　L为分解尺度， 表示图像小波系数，![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-wave1.5.png) 表示图像小波系数， =d=H,V,D分别表示的是水平、垂直、对角高频分量。如果两幅图片直接使用局部方差法进行融合，局部方差相差较大时，采用局部方差取大法能够比较完整的存储图像的微小细节。一旦局部方差相差很小时，局部方差取大法会使图像细节失真。

　　图像融合有一个重要的目的，即将图像的边缘、细节等都包含到融合图像中。一种方法是将图像的边缘提取出来，将它应用到相应的融合算法中。图像边缘检测的最好的算子是 canny 算子，将canny算子和局部方差的融合规则的算法相结合，提出了一种新的改进融合方法。融合步骤如下：

　　（1）小波分解。对于图像 A，B 分别进行 3 层小波分解，得到低频分量AA、AB和高频分量DLH，DLV，DLD。

　　（2）低频融合。对低频分量AA 和AB 所有的像素点计算其局部方差Var(i ,j)AA和 Var(i ,j)BA，然后进行归一化：

![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-wave1.6.png)

　　然后，利用归一化的局部方差，按照如下：

![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-wave1.7.png)

　　（3）高频融合。在图像 A 和 B 的每一个高频分DLA，DLB中，对每一个高频分量用 canny 算子进行边缘提取，再对边缘图像的每一个元素计算局部方差：

![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-wave1.8.png) 

　　其中，![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-wave1.9.png)表示源图像的第l层经 canny 算子处理的高频系数，![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-wave1.10.png)为源图像的第l层经 canny 算子提取后的均值，![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-wave1.11.png)是对源图

像的第l层高频分量进行边缘提取后求得的局部方差。

![img](http://7te8s4.com1.z0.glb.clouddn.com/merge-wave1.12.png)

 

　　（4）小波重构。对融合后的系数进行小波重构，得到融合后的图像。

　　附：这里介绍的小波是最简单的形式，融合规则也比较常用，很多红外和可见的融合也都用到了这里的规则，所以，实现这里面的算法来适用我们的应用。









