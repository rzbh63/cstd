
# Python和PyTorch对比实现池化层MaxPool函数及反向传播 - BrightLamp的博客 - CSDN博客


2018年11月29日 16:28:05[BrightLampCsdn](https://me.csdn.net/oBrightLamp)阅读数：748



## 摘要
本文使用纯 Python 和 PyTorch 对比实现 MaxPool 函数及其反向传播.
## 相关
*原理和详细解释, 请参考文章 :*
池化层MaxPool函数详解及反向传播的公式推导
*系列文章索引 :*
[https://blog.csdn.net/oBrightLamp/article/details/85067981](https://blog.csdn.net/oBrightLamp/article/details/85067981)
## 正文
```python
import
```
```python
torch
```
```python
import
```
```python
numpy
```
```python
as
```
```python
np
```
```python
class
```
```python
MaxPool2D
```
```python
:
```
```python
def
```
```python
__init__
```
```python
(
```
```python
self
```
```python
,
```
```python
kernel_size
```
```python
=
```
```python
(
```
```python
2
```
```python
,
```
```python
2
```
```python
)
```
```python
,
```
```python
stride
```
```python
=
```
```python
2
```
```python
)
```
```python
:
```
```python
self
```
```python
.
```
```python
stride
```
```python
=
```
```python
stride
        self
```
```python
.
```
```python
kernel_size
```
```python
=
```
```python
kernel_size
        self
```
```python
.
```
```python
w_height
```
```python
=
```
```python
kernel_size
```
```python
[
```
```python
0
```
```python
]
```
```python
self
```
```python
.
```
```python
w_width
```
```python
=
```
```python
kernel_size
```
```python
[
```
```python
1
```
```python
]
```
```python
self
```
```python
.
```
```python
x
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
in_height
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
in_width
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
out_height
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
out_width
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
arg_max
```
```python
=
```
```python
None
```
```python
def
```
```python
__call__
```
```python
(
```
```python
self
```
```python
,
```
```python
x
```
```python
)
```
```python
:
```
```python
self
```
```python
.
```
```python
x
```
```python
=
```
```python
x
        self
```
```python
.
```
```python
in_height
```
```python
=
```
```python
np
```
```python
.
```
```python
shape
```
```python
(
```
```python
x
```
```python
)
```
```python
[
```
```python
0
```
```python
]
```
```python
self
```
```python
.
```
```python
in_width
```
```python
=
```
```python
np
```
```python
.
```
```python
shape
```
```python
(
```
```python
x
```
```python
)
```
```python
[
```
```python
1
```
```python
]
```
```python
self
```
```python
.
```
```python
out_height
```
```python
=
```
```python
int
```
```python
(
```
```python
(
```
```python
self
```
```python
.
```
```python
in_height
```
```python
-
```
```python
self
```
```python
.
```
```python
w_height
```
```python
)
```
```python
/
```
```python
self
```
```python
.
```
```python
stride
```
```python
)
```
```python
+
```
```python
1
```
```python
self
```
```python
.
```
```python
out_width
```
```python
=
```
```python
int
```
```python
(
```
```python
(
```
```python
self
```
```python
.
```
```python
in_width
```
```python
-
```
```python
self
```
```python
.
```
```python
w_width
```
```python
)
```
```python
/
```
```python
self
```
```python
.
```
```python
stride
```
```python
)
```
```python
+
```
```python
1
```
```python
out
```
```python
=
```
```python
np
```
```python
.
```
```python
zeros
```
```python
(
```
```python
(
```
```python
self
```
```python
.
```
```python
out_height
```
```python
,
```
```python
self
```
```python
.
```
```python
out_width
```
```python
)
```
```python
)
```
```python
self
```
```python
.
```
```python
arg_max
```
```python
=
```
```python
np
```
```python
.
```
```python
zeros_like
```
```python
(
```
```python
out
```
```python
,
```
```python
dtype
```
```python
=
```
```python
np
```
```python
.
```
```python
int32
```
```python
)
```
```python
for
```
```python
i
```
```python
in
```
```python
range
```
```python
(
```
```python
self
```
```python
.
```
```python
out_height
```
```python
)
```
```python
:
```
```python
for
```
```python
j
```
```python
in
```
```python
range
```
```python
(
```
```python
self
```
```python
.
```
```python
out_width
```
```python
)
```
```python
:
```
```python
start_i
```
```python
=
```
```python
i
```
```python
*
```
```python
self
```
```python
.
```
```python
stride
                start_j
```
```python
=
```
```python
j
```
```python
*
```
```python
self
```
```python
.
```
```python
stride
                end_i
```
```python
=
```
```python
start_i
```
```python
+
```
```python
self
```
```python
.
```
```python
w_height
                end_j
```
```python
=
```
```python
start_j
```
```python
+
```
```python
self
```
```python
.
```
```python
w_width
                out
```
```python
[
```
```python
i
```
```python
,
```
```python
j
```
```python
]
```
```python
=
```
```python
np
```
```python
.
```
```python
max
```
```python
(
```
```python
x
```
```python
[
```
```python
start_i
```
```python
:
```
```python
end_i
```
```python
,
```
```python
start_j
```
```python
:
```
```python
end_j
```
```python
]
```
```python
)
```
```python
self
```
```python
.
```
```python
arg_max
```
```python
[
```
```python
i
```
```python
,
```
```python
j
```
```python
]
```
```python
=
```
```python
np
```
```python
.
```
```python
argmax
```
```python
(
```
```python
x
```
```python
[
```
```python
start_i
```
```python
:
```
```python
end_i
```
```python
,
```
```python
start_j
```
```python
:
```
```python
end_j
```
```python
]
```
```python
)
```
```python
self
```
```python
.
```
```python
arg_max
```
```python
=
```
```python
self
```
```python
.
```
```python
arg_max
```
```python
return
```
```python
out
```
```python
def
```
```python
backward
```
```python
(
```
```python
self
```
```python
,
```
```python
d_loss
```
```python
)
```
```python
:
```
```python
dx
```
```python
=
```
```python
np
```
```python
.
```
```python
zeros_like
```
```python
(
```
```python
self
```
```python
.
```
```python
x
```
```python
)
```
```python
for
```
```python
i
```
```python
in
```
```python
range
```
```python
(
```
```python
self
```
```python
.
```
```python
out_height
```
```python
)
```
```python
:
```
```python
for
```
```python
j
```
```python
in
```
```python
range
```
```python
(
```
```python
self
```
```python
.
```
```python
out_width
```
```python
)
```
```python
:
```
```python
start_i
```
```python
=
```
```python
i
```
```python
*
```
```python
self
```
```python
.
```
```python
stride
                start_j
```
```python
=
```
```python
j
```
```python
*
```
```python
self
```
```python
.
```
```python
stride
                end_i
```
```python
=
```
```python
start_i
```
```python
+
```
```python
self
```
```python
.
```
```python
w_height
                end_j
```
```python
=
```
```python
start_j
```
```python
+
```
```python
self
```
```python
.
```
```python
w_width
                index
```
```python
=
```
```python
np
```
```python
.
```
```python
unravel_index
```
```python
(
```
```python
self
```
```python
.
```
```python
arg_max
```
```python
[
```
```python
i
```
```python
,
```
```python
j
```
```python
]
```
```python
,
```
```python
self
```
```python
.
```
```python
kernel_size
```
```python
)
```
```python
dx
```
```python
[
```
```python
start_i
```
```python
:
```
```python
end_i
```
```python
,
```
```python
start_j
```
```python
:
```
```python
end_j
```
```python
]
```
```python
[
```
```python
index
```
```python
]
```
```python
=
```
```python
d_loss
```
```python
[
```
```python
i
```
```python
,
```
```python
j
```
```python
]
```
```python
return
```
```python
dx

np
```
```python
.
```
```python
set_printoptions
```
```python
(
```
```python
precision
```
```python
=
```
```python
8
```
```python
,
```
```python
suppress
```
```python
=
```
```python
True
```
```python
,
```
```python
linewidth
```
```python
=
```
```python
120
```
```python
)
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
seed
```
```python
(
```
```python
123
```
```python
)
```
```python
x_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
1
```
```python
,
```
```python
1
```
```python
,
```
```python
6
```
```python
,
```
```python
8
```
```python
)
```
```python
)
```
```python
x_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
x_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
max_pool_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
nn
```
```python
.
```
```python
MaxPool2d
```
```python
(
```
```python
(
```
```python
2
```
```python
,
```
```python
2
```
```python
)
```
```python
,
```
```python
2
```
```python
)
```
```python
max_pool_numpy
```
```python
=
```
```python
MaxPool2D
```
```python
(
```
```python
(
```
```python
2
```
```python
,
```
```python
2
```
```python
)
```
```python
,
```
```python
stride
```
```python
=
```
```python
2
```
```python
)
```
```python
out_numpy
```
```python
=
```
```python
max_pool_numpy
```
```python
(
```
```python
x_numpy
```
```python
[
```
```python
0
```
```python
,
```
```python
0
```
```python
]
```
```python
)
```
```python
out_tensor
```
```python
=
```
```python
max_pool_tensor
```
```python
(
```
```python
x_tensor
```
```python
)
```
```python
d_loss_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
out_tensor
```
```python
.
```
```python
shape
```
```python
)
```
```python
d_loss_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
d_loss_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
out_tensor
```
```python
.
```
```python
backward
```
```python
(
```
```python
d_loss_tensor
```
```python
)
```
```python
dx_numpy
```
```python
=
```
```python
max_pool_numpy
```
```python
.
```
```python
backward
```
```python
(
```
```python
d_loss_numpy
```
```python
[
```
```python
0
```
```python
,
```
```python
0
```
```python
]
```
```python
)
```
```python
dx_tensor
```
```python
=
```
```python
x_tensor
```
```python
.
```
```python
grad
```
```python
print
```
```python
(
```
```python
"out_numpy \n"
```
```python
,
```
```python
out_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
"out_tensor \n"
```
```python
,
```
```python
out_tensor
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"dx_numpy \n"
```
```python
,
```
```python
dx_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
"dx_tensor \n"
```
```python
,
```
```python
dx_tensor
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
"""
代码输出:
out_numpy 
 [[ 0.69646919  0.72904971  0.71946897  0.9807642 ]
 [ 0.72244338  0.53182759  0.84943179  0.72445532]
 [ 0.62395295  0.42583029  0.89338916  0.98555979]]
out_tensor 
 [[[[ 0.69646919  0.72904971  0.71946897  0.9807642 ]
   [ 0.72244338  0.53182759  0.84943179  0.72445532]
   [ 0.62395295  0.42583029  0.89338916  0.98555979]]]]
dx_numpy 
 [[ 0.51948512  0.          0.          0.          0.12062867  0.          0.8263408   0.        ]
 [ 0.          0.          0.          0.61289453  0.          0.          0.          0.        ]
 [ 0.          0.          0.          0.54506801  0.          0.34276383  0.30412079  0.        ]
 [ 0.60306013  0.          0.          0.          0.          0.          0.          0.        ]
 [ 0.          0.          0.68130077  0.          0.          0.87545684  0.          0.        ]
 [ 0.41702221  0.          0.          0.          0.          0.          0.          0.51042234]]
dx_tensor 
 [[[[ 0.51948512  0.          0.          0.          0.12062867  0.          0.8263408   0.        ]
   [ 0.          0.          0.          0.61289453  0.          0.          0.          0.        ]
   [ 0.          0.          0.          0.54506801  0.          0.34276383  0.30412079  0.        ]
   [ 0.60306013  0.          0.          0.          0.          0.          0.          0.        ]
   [ 0.          0.          0.68130077  0.          0.          0.87545684  0.          0.        ]
   [ 0.41702221  0.          0.          0.          0.          0.          0.          0.51042234]]]]
"""
```

