
# 纯Python和PyTorch对比实现循环神经网络RNN及反向传播 - BrightLamp的博客 - CSDN博客


2018年12月15日 16:30:52[BrightLampCsdn](https://me.csdn.net/oBrightLamp)阅读数：71



## 摘要
本文使用纯 Python 和 PyTorch 对比实现循环神经网络RNN及其反向传播
## 相关
原理和详细解释, 请参考:
循环神经网络RNNCell单元详解及反向传播的梯度求导
[https://blog.csdn.net/oBrightLamp/article/details/85015325](https://blog.csdn.net/oBrightLamp/article/details/85015325)
## 正文
```python
import
```
```python
torch
```
```python
import
```
```python
numpy
```
```python
as
```
```python
np
```
```python
class
```
```python
RNNCell
```
```python
:
```
```python
def
```
```python
__init__
```
```python
(
```
```python
self
```
```python
,
```
```python
weight_ih
```
```python
,
```
```python
weight_hh
```
```python
,
```
```python
bias_ih
```
```python
,
```
```python
bias_hh
```
```python
)
```
```python
:
```
```python
self
```
```python
.
```
```python
weight_ih
```
```python
=
```
```python
weight_ih
        self
```
```python
.
```
```python
weight_hh
```
```python
=
```
```python
weight_hh
        self
```
```python
.
```
```python
bias_ih
```
```python
=
```
```python
bias_ih
        self
```
```python
.
```
```python
bias_hh
```
```python
=
```
```python
bias_hh
        self
```
```python
.
```
```python
x_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
dx_list
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
dw_ih_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
dw_hh_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
db_ih_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
db_hh_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
prev_hidden_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
next_hidden_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
# temporary cache
```
```python
self
```
```python
.
```
```python
prev_dh
```
```python
=
```
```python
None
```
```python
def
```
```python
__call__
```
```python
(
```
```python
self
```
```python
,
```
```python
x
```
```python
,
```
```python
prev_hidden
```
```python
)
```
```python
:
```
```python
self
```
```python
.
```
```python
x_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
x
```
```python
)
```
```python
next_h
```
```python
=
```
```python
np
```
```python
.
```
```python
tanh
```
```python
(
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
x
```
```python
,
```
```python
self
```
```python
.
```
```python
weight_ih
```
```python
.
```
```python
T
```
```python
)
```
```python
+
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
prev_hidden
```
```python
,
```
```python
self
```
```python
.
```
```python
weight_hh
```
```python
.
```
```python
T
```
```python
)
```
```python
+
```
```python
self
```
```python
.
```
```python
bias_ih
```
```python
+
```
```python
self
```
```python
.
```
```python
bias_hh
```
```python
)
```
```python
self
```
```python
.
```
```python
prev_hidden_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
prev_hidden
```
```python
)
```
```python
self
```
```python
.
```
```python
next_hidden_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
next_h
```
```python
)
```
```python
# clean cache
```
```python
self
```
```python
.
```
```python
prev_dh
```
```python
=
```
```python
np
```
```python
.
```
```python
zeros
```
```python
(
```
```python
next_h
```
```python
.
```
```python
shape
```
```python
)
```
```python
return
```
```python
next_h
```
```python
def
```
```python
backward
```
```python
(
```
```python
self
```
```python
,
```
```python
dh
```
```python
)
```
```python
:
```
```python
x
```
```python
=
```
```python
self
```
```python
.
```
```python
x_stack
```
```python
.
```
```python
pop
```
```python
(
```
```python
)
```
```python
prev_hidden
```
```python
=
```
```python
self
```
```python
.
```
```python
prev_hidden_stack
```
```python
.
```
```python
pop
```
```python
(
```
```python
)
```
```python
next_hidden
```
```python
=
```
```python
self
```
```python
.
```
```python
next_hidden_stack
```
```python
.
```
```python
pop
```
```python
(
```
```python
)
```
```python
d_tanh
```
```python
=
```
```python
(
```
```python
dh
```
```python
+
```
```python
self
```
```python
.
```
```python
prev_dh
```
```python
)
```
```python
*
```
```python
(
```
```python
1
```
```python
-
```
```python
next_hidden
```
```python
**
```
```python
2
```
```python
)
```
```python
self
```
```python
.
```
```python
prev_dh
```
```python
=
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
d_tanh
```
```python
,
```
```python
self
```
```python
.
```
```python
weight_hh
```
```python
)
```
```python
dx
```
```python
=
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
d_tanh
```
```python
,
```
```python
self
```
```python
.
```
```python
weight_ih
```
```python
)
```
```python
self
```
```python
.
```
```python
dx_list
```
```python
.
```
```python
insert
```
```python
(
```
```python
0
```
```python
,
```
```python
dx
```
```python
)
```
```python
dw_ih
```
```python
=
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
d_tanh
```
```python
.
```
```python
T
```
```python
,
```
```python
x
```
```python
)
```
```python
self
```
```python
.
```
```python
dw_ih_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
dw_ih
```
```python
)
```
```python
dw_hh
```
```python
=
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
d_tanh
```
```python
.
```
```python
T
```
```python
,
```
```python
prev_hidden
```
```python
)
```
```python
self
```
```python
.
```
```python
dw_hh_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
dw_hh
```
```python
)
```
```python
self
```
```python
.
```
```python
db_ih_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
d_tanh
```
```python
)
```
```python
self
```
```python
.
```
```python
db_hh_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
d_tanh
```
```python
)
```
```python
return
```
```python
self
```
```python
.
```
```python
dx_list
```
```python
if
```
```python
__name__
```
```python
==
```
```python
'__main__'
```
```python
:
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
seed
```
```python
(
```
```python
123
```
```python
)
```
```python
torch
```
```python
.
```
```python
random
```
```python
.
```
```python
manual_seed
```
```python
(
```
```python
123
```
```python
)
```
```python
np
```
```python
.
```
```python
set_printoptions
```
```python
(
```
```python
precision
```
```python
=
```
```python
6
```
```python
,
```
```python
suppress
```
```python
=
```
```python
True
```
```python
)
```
```python
rnn_PyTorch
```
```python
=
```
```python
torch
```
```python
.
```
```python
nn
```
```python
.
```
```python
RNN
```
```python
(
```
```python
4
```
```python
,
```
```python
5
```
```python
)
```
```python
.
```
```python
double
```
```python
(
```
```python
)
```
```python
rnn_numpy
```
```python
=
```
```python
RNNCell
```
```python
(
```
```python
rnn_PyTorch
```
```python
.
```
```python
all_weights
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
0
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
,
```
```python
rnn_PyTorch
```
```python
.
```
```python
all_weights
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
1
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
,
```
```python
rnn_PyTorch
```
```python
.
```
```python
all_weights
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
2
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
,
```
```python
rnn_PyTorch
```
```python
.
```
```python
all_weights
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
3
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
nums
```
```python
=
```
```python
3
```
```python
x3_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
nums
```
```python
,
```
```python
3
```
```python
,
```
```python
4
```
```python
)
```
```python
)
```
```python
x3_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
x3_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
h3_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
1
```
```python
,
```
```python
3
```
```python
,
```
```python
5
```
```python
)
```
```python
)
```
```python
h3_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
h3_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
dh_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
nums
```
```python
,
```
```python
3
```
```python
,
```
```python
5
```
```python
)
```
```python
)
```
```python
dh_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
dh_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
h3_tensor
```
```python
=
```
```python
rnn_PyTorch
```
```python
(
```
```python
x3_tensor
```
```python
,
```
```python
h3_tensor
```
```python
)
```
```python
h_numpy_list
```
```python
=
```
```python
[
```
```python
]
```
```python
h_numpy
```
```python
=
```
```python
h3_numpy
```
```python
[
```
```python
0
```
```python
]
```
```python
for
```
```python
i
```
```python
in
```
```python
range
```
```python
(
```
```python
nums
```
```python
)
```
```python
:
```
```python
h_numpy
```
```python
=
```
```python
rnn_numpy
```
```python
(
```
```python
x3_numpy
```
```python
[
```
```python
i
```
```python
]
```
```python
,
```
```python
h_numpy
```
```python
)
```
```python
h_numpy_list
```
```python
.
```
```python
append
```
```python
(
```
```python
h_numpy
```
```python
)
```
```python
h3_tensor
```
```python
[
```
```python
0
```
```python
]
```
```python
.
```
```python
backward
```
```python
(
```
```python
dh_tensor
```
```python
)
```
```python
for
```
```python
i
```
```python
in
```
```python
reversed
```
```python
(
```
```python
range
```
```python
(
```
```python
nums
```
```python
)
```
```python
)
```
```python
:
```
```python
rnn_numpy
```
```python
.
```
```python
backward
```
```python
(
```
```python
dh_numpy
```
```python
[
```
```python
i
```
```python
]
```
```python
)
```
```python
print
```
```python
(
```
```python
"numpy_hidden :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
array
```
```python
(
```
```python
h_numpy_list
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"tensor_hidden :\n"
```
```python
,
```
```python
h3_tensor
```
```python
[
```
```python
0
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"dx_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
array
```
```python
(
```
```python
rnn_numpy
```
```python
.
```
```python
dx_list
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"dx_tensor :\n"
```
```python
,
```
```python
x3_tensor
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"dw_ih_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
rnn_numpy
```
```python
.
```
```python
dw_ih_stack
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"dw_ih_tensor :\n"
```
```python
,
```
```python
rnn_PyTorch
```
```python
.
```
```python
all_weights
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
0
```
```python
]
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"dw_hh_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
rnn_numpy
```
```python
.
```
```python
dw_hh_stack
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"dw_hh_tensor :\n"
```
```python
,
```
```python
rnn_PyTorch
```
```python
.
```
```python
all_weights
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
1
```
```python
]
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"db_ih_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
rnn_numpy
```
```python
.
```
```python
db_ih_stack
```
```python
,
```
```python
axis
```
```python
=
```
```python
(
```
```python
0
```
```python
,
```
```python
1
```
```python
)
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"db_ih_tensor :\n"
```
```python
,
```
```python
rnn_PyTorch
```
```python
.
```
```python
all_weights
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
2
```
```python
]
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"db_hh_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
rnn_numpy
```
```python
.
```
```python
db_hh_stack
```
```python
,
```
```python
axis
```
```python
=
```
```python
(
```
```python
0
```
```python
,
```
```python
1
```
```python
)
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"db_hh_tensor :\n"
```
```python
,
```
```python
rnn_PyTorch
```
```python
.
```
```python
all_weights
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
3
```
```python
]
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
"""
    代码输出
    numpy_hidden :
     [[[ 0.4686   -0.298203  0.741399 -0.446474  0.019391]
      [ 0.365172 -0.361254  0.426838 -0.448951  0.331553]
      [ 0.589187 -0.188248  0.684941 -0.45859   0.190099]]
    
     [[ 0.146213 -0.306517  0.297109  0.370957 -0.040084]
      [-0.009201 -0.365735  0.333659  0.486789  0.061897]
      [ 0.030064 -0.282985  0.42643   0.025871  0.026388]]
    
     [[ 0.225432 -0.015057  0.116555  0.080901  0.260097]
      [ 0.368327  0.258664  0.357446  0.177961  0.55928 ]
      [ 0.103317 -0.029123  0.182535  0.216085  0.264766]]]
    tensor_hidden :
     [[[ 0.4686   -0.298203  0.741399 -0.446474  0.019391]
      [ 0.365172 -0.361254  0.426838 -0.448951  0.331553]
      [ 0.589187 -0.188248  0.684941 -0.45859   0.190099]]
    
     [[ 0.146213 -0.306517  0.297109  0.370957 -0.040084]
      [-0.009201 -0.365735  0.333659  0.486789  0.061897]
      [ 0.030064 -0.282985  0.42643   0.025871  0.026388]]
    
     [[ 0.225432 -0.015057  0.116555  0.080901  0.260097]
      [ 0.368327  0.258664  0.357446  0.177961  0.55928 ]
      [ 0.103317 -0.029123  0.182535  0.216085  0.264766]]]
    ------
    dx_numpy :
     [[[-0.643965  0.215931 -0.476378  0.072387]
      [-1.221727  0.221325 -0.757251  0.092991]
      [-0.59872  -0.065826 -0.390795  0.037424]]
    
     [[-0.537631 -0.303022 -0.364839  0.214627]
      [-0.815198  0.392338 -0.564135  0.217464]
      [-0.931365 -0.254144 -0.561227  0.164795]]
    
     [[-1.055966  0.249554 -0.623127  0.009784]
      [-0.45858   0.108994 -0.240168  0.117779]
      [-0.957469  0.315386 -0.616814  0.205634]]]
    dx_tensor :
     [[[-0.643965  0.215931 -0.476378  0.072387]
      [-1.221727  0.221325 -0.757251  0.092991]
      [-0.59872  -0.065826 -0.390795  0.037424]]
    
     [[-0.537631 -0.303022 -0.364839  0.214627]
      [-0.815198  0.392338 -0.564135  0.217464]
      [-0.931365 -0.254144 -0.561227  0.164795]]
    
     [[-1.055966  0.249554 -0.623127  0.009784]
      [-0.45858   0.108994 -0.240168  0.117779]
      [-0.957469  0.315386 -0.616814  0.205634]]]
    ------
    dw_ih_numpy :
     [[ 3.918335  2.958509  3.725173  4.157478]
     [ 1.261197  0.812825  1.10621   0.97753 ]
     [ 2.216469  1.718251  2.366936  2.324907]
     [ 3.85458   3.052212  3.643157  3.845696]
     [ 1.806807  1.50062   1.615917  1.521762]]
    dw_ih_tensor :
     [[ 3.918335  2.958509  3.725173  4.157478]
     [ 1.261197  0.812825  1.10621   0.97753 ]
     [ 2.216469  1.718251  2.366936  2.324907]
     [ 3.85458   3.052212  3.643157  3.845696]
     [ 1.806807  1.50062   1.615917  1.521762]]
    ------
    dw_hh_numpy :
     [[ 2.450078  0.243735  4.269672  0.577224  1.46911 ]
     [ 0.421015  0.372353  0.994656  0.962406  0.518992]
     [ 1.079054  0.042843  2.12169   0.863083  0.757618]
     [ 2.225794  0.188735  3.682347  0.934932  0.955984]
     [ 0.660546 -0.321076  1.554888  0.833449  0.605201]]
    dw_hh_tensor :
     [[ 2.450078  0.243735  4.269672  0.577224  1.46911 ]
     [ 0.421015  0.372353  0.994656  0.962406  0.518992]
     [ 1.079054  0.042843  2.12169   0.863083  0.757618]
     [ 2.225794  0.188735  3.682347  0.934932  0.955984]
     [ 0.660546 -0.321076  1.554888  0.833449  0.605201]]
    ------
    db_ih_numpy :
     [ 7.568411  2.175445  4.335336  6.820628  3.51003 ]
    db_ih_tensor :
     [ 7.568411  2.175445  4.335336  6.820628  3.51003 ]
    ------
    db_hh_numpy :
     [ 7.568411  2.175445  4.335336  6.820628  3.51003 ]
    db_hh_tensor :
     [ 7.568411  2.175445  4.335336  6.820628  3.51003 ]
    """
```

