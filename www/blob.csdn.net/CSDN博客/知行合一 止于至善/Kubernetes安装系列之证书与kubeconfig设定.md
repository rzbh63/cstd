
# Kubernetes安装系列之证书与kubeconfig设定 - 知行合一 止于至善 - CSDN博客

2019年03月28日 05:59:12[liumiaocn](https://me.csdn.net/liumiaocn)阅读数：184所属专栏：[深入浅出kubernetes](https://blog.csdn.net/column/details/12761.html)



这篇文章整理一下node节点所需要的证书创建以及连接时的kubeconfig相关设定。本文以脚本的方式进行固化，内容仍然放在github的easypack上。
# 整体操作
[https://blog.csdn.net/liumiaocn/article/details/88413428](https://blog.csdn.net/liumiaocn/article/details/88413428)
# proxy相关
## csr文件
csr文件详细信息如下所示，指定算法类型和长度以及相关的NAMES设定
```python
[
```
```python
root@host131 k8s
```
```python
]
```
```python
# cat kubeproxy
```
```python
-
```
```python
csr
```
```python
.
```
```python
json
```
```python
{
```
```python
"CN"
```
```python
:
```
```python
"system:kube-proxy"
```
```python
,
```
```python
"hosts"
```
```python
:
```
```python
[
```
```python
]
```
```python
,
```
```python
"key"
```
```python
:
```
```python
{
```
```python
"algo"
```
```python
:
```
```python
"rsa"
```
```python
,
```
```python
"size"
```
```python
:
```
```python
2048
```
```python
}
```
```python
,
```
```python
"names"
```
```python
:
```
```python
[
```
```python
{
```
```python
"C"
```
```python
:
```
```python
"CN"
```
```python
,
```
```python
"ST"
```
```python
:
```
```python
"DaLian"
```
```python
,
```
```python
"L"
```
```python
:
```
```python
"LiaoNing"
```
```python
,
```
```python
"O"
```
```python
:
```
```python
"K8S"
```
```python
,
```
```python
"OU"
```
```python
:
```
```python
"System"
```
```python
}
```
```python
]
```
```python
}
```
```python
[
```
```python
root@host131 k8s
```
```python
]
```
```python
#
```
# 脚本示例
变量部分抽出，形成如下脚本示例
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
# cat step8-1-prepare-node.sh
```
```python
#!/bin/sh
```
```python
.
```
```python
./install.cfg
```
```python
# set cfssl tools in search path
```
```python
chmod
```
```python
755
```
```python
${ENV_HOME_CFSSL}
```
```python
/*
```
```python
if
```
```python
[
```
```python
$?
```
```python
-ne 0
```
```python
]
```
```python
;
```
```python
then
```
```python
echo
```
```python
"prepare downloaded cfssl tools in
```
```python
${ENV_HOME_CFSSL}
```
```python
in advance"
```
```python
exit
```
```python
fi
```
```python
export
```
```python
PATH
```
```python
=
```
```python
${ENV_HOME_CFSSL}
```
```python
:
```
```python
$PATH
```
```python
mkdir
```
```python
-p
```
```python
${ENV_SSL_K8S_DIR}
```
```python
cd
```
```python
${ENV_SSL_K8S_DIR}
```
```python
if
```
```python
[
```
```python
$?
```
```python
-ne 0
```
```python
]
```
```python
;
```
```python
then
```
```python
echo
```
```python
"failed to create dir :
```
```python
${ENV_SSL_K8S_DIR}
```
```python
"
```
```python
exit
```
```python
fi
```
```python
cat
```
```python
>
```
```python
${ENV_SSL_PROXY_CSR}
```
```python
<<
```
```python
EOF
{
  "CN": "
```
```python
${ENV_SSL_PROXY_CSR_CN}
```
```python
",
  "hosts": [],
  "key": {
    "algo": "
```
```python
${ENV_SSL_KEY_ALGO}
```
```python
",
    "size":
```
```python
${ENV_SSL_KEY_SIZE}
```
```python
},
  "names": [
    {
      "C": "
```
```python
${ENV_SSL_NAMES_C}
```
```python
",
      "ST": "
```
```python
${ENV_SSL_NAMES_L}
```
```python
",
      "L": "
```
```python
${ENV_SSL_NAMES_ST}
```
```python
",
      "O": "
```
```python
${ENV_SSL_NAMES_O}
```
```python
",
      "OU": "
```
```python
${ENV_SSL_NAMES_OU}
```
```python
"
    }
  ]
}
EOF
```
```python
cfssl gencert -ca
```
```python
=
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_CA_PEM}
```
```python
\
  -ca-key
```
```python
=
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_CA_KEY}
```
```python
\
  -config
```
```python
=
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_CA_CONFIG}
```
```python
\
  -profile
```
```python
=
```
```python
${ENV_SSL_PROFILE_K8S}
```
```python
${ENV_SSL_PROXY_CSR}
```
```python
|
```
```python
cfssljson -bare
```
```python
${ENV_SSL_PROXY_CERT_PRIFIX}
```
```python
ls
```
```python
${ENV_SSL_K8S_DIR}
```
```python
/
```
```python
${ENV_SSL_PROXY_CERT_PRIFIX}
```
```python
*pem
BOOTSTRAP_TOKEN
```
```python
=
```
```python
`
```
```python
awk
```
```python
-F
```
```python
","
```
```python
'{print
```
```python
$1
```
```python
}'
```
```python
$
```
```python
{
```
```python
ENV_KUBE_DIR_ETC
```
```python
}
```
```python
/$
```
```python
{
```
```python
ENV_KUBE_API_TOKEN
```
```python
}
```
```python
`
```
```python
# set cluster for bootstrap-kubelet
```
```python
kubectl config set-cluster
```
```python
${ENV_KUBECONFIG_CLUSTER}
```
```python
\
  --certificate-authority
```
```python
=
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_CA_PEM}
```
```python
\
  --embed-certs
```
```python
=
```
```python
${ENV_KUBECONFIG_EMBED_CERTS}
```
```python
\
  --server
```
```python
=
```
```python
${ENV_KUBE_MASTER_HTTPS}
```
```python
\
  --kubeconfig
```
```python
=
```
```python
${ENV_KUBECONFIG_BOOTSTRAP}
```
```python
# set client infor by using token for kubelet
```
```python
kubectl config set-credentials
```
```python
${ENV_KUBECONFIG_CLIENT_KUBELET}
```
```python
\
  --token
```
```python
=
```
```python
${BOOTSTRAP_TOKEN}
```
```python
\
  --kubeconfig
```
```python
=
```
```python
${ENV_KUBECONFIG_BOOTSTRAP}
```
```python
# connect client infor with cluster for kubelet
```
```python
kubectl config set-context
```
```python
${ENV_KUBECONFIG_CONTEXT_DEFAULT}
```
```python
\
  --cluster
```
```python
=
```
```python
${ENV_KUBECONFIG_CLUSTER}
```
```python
\
  --user
```
```python
=
```
```python
${ENV_KUBECONFIG_CLIENT_KUBELET}
```
```python
\
  --kubeconfig
```
```python
=
```
```python
${ENV_KUBECONFIG_BOOTSTRAP}
```
```python
# set default context by using bootstrap.kubeconfig
```
```python
kubectl config use-context
```
```python
${ENV_KUBECONFIG_CONTEXT_DEFAULT}
```
```python
--kubeconfig
```
```python
=
```
```python
${ENV_KUBECONFIG_BOOTSTRAP}
```
```python
# Create kube-proxy kubeconfig file.
```
```python
kubectl config set-cluster
```
```python
${ENV_KUBECONFIG_CLUSTER}
```
```python
\
  --certificate-authority
```
```python
=
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_CA_PEM}
```
```python
\
  --embed-certs
```
```python
=
```
```python
${ENV_KUBECONFIG_EMBED_CERTS}
```
```python
\
  --server
```
```python
=
```
```python
${ENV_KUBE_MASTER_HTTPS}
```
```python
\
  --kubeconfig
```
```python
=
```
```python
${ENV_KUBECONFIG_KUBEPROXY}
```
```python
kubectl config set-credentials
```
```python
${ENV_KUBECONFIG_CLIENT_KUBEPROXY}
```
```python
\
  --client-certificate
```
```python
=
```
```python
${ENV_SSL_K8S_DIR}
```
```python
/
```
```python
${ENV_SSL_PROXY_CERT_PRIFIX}
```
```python
.pem \
  --client-key
```
```python
=
```
```python
${ENV_SSL_K8S_DIR}
```
```python
/
```
```python
${ENV_SSL_PROXY_CERT_PRIFIX}
```
```python
-key.pem \
  --embed-certs
```
```python
=
```
```python
${ENV_KUBECONFIG_EMBED_CERTS}
```
```python
\
  --kubeconfig
```
```python
=
```
```python
${ENV_KUBECONFIG_KUBEPROXY}
```
```python
kubectl config set-context
```
```python
${ENV_KUBECONFIG_CONTEXT_DEFAULT}
```
```python
\
  --cluster
```
```python
=
```
```python
${ENV_KUBECONFIG_CLUSTER}
```
```python
\
  --user
```
```python
=
```
```python
${ENV_KUBECONFIG_CLIENT_KUBEPROXY}
```
```python
\
  --kubeconfig
```
```python
=
```
```python
${ENV_KUBECONFIG_KUBEPROXY}
```
```python
kubectl config use-context
```
```python
${ENV_KUBECONFIG_CONTEXT_DEFAULT}
```
```python
--kubeconfig
```
```python
=
```
```python
kube-proxy.kubeconfig
kubectl get clusterrolebinding
```
```python
${ENV_KUBECONFIG_CLIENT_KUBELET}
```
```python
>
```
```python
/dev/null 2
```
```python
>
```
```python
&
```
```python
1
```
```python
if
```
```python
[
```
```python
$?
```
```python
-eq 0
```
```python
]
```
```python
;
```
```python
then
```
```python
kubectl delete clusterrolebinding
```
```python
${ENV_KUBECONFIG_CLIENT_KUBELET}
```
```python
fi
```
```python
# binding kubelet-bootstrap user to system cluster roles.
```
```python
kubectl create clusterrolebinding
```
```python
${ENV_KUBECONFIG_CLIENT_KUBELET}
```
```python
\
  --clusterrole
```
```python
=
```
```python
${ENV_KUBECONFIG_ROLE_BOOTSTRAPPER}
```
```python
\
  --user
```
```python
=
```
```python
${ENV_KUBECONFIG_CLIENT_KUBELET}
```
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
#
```
设定文件install.cfg可参看github的如下路径：
[https://github.com/liumiaocn/easypack/tree/master/k8s/shell](https://github.com/liumiaocn/easypack/tree/master/k8s/shell)
# 执行示例
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
# sh step8-1-prepare-node.sh
```
```python
2019/03/24 19:51:52
```
```python
[
```
```python
INFO
```
```python
]
```
```python
generate received request
2019/03/24 19:51:52
```
```python
[
```
```python
INFO
```
```python
]
```
```python
received CSR
2019/03/24 19:51:52
```
```python
[
```
```python
INFO
```
```python
]
```
```python
generating key: rsa-2048
2019/03/24 19:51:54
```
```python
[
```
```python
INFO
```
```python
]
```
```python
encoded CSR
2019/03/24 19:51:54
```
```python
[
```
```python
INFO
```
```python
]
```
```python
signed certificate with serial number 696296882974787035892630786248589006843759309365
2019/03/24 19:51:54
```
```python
[
```
```python
WARNING
```
```python
]
```
```python
This certificate lacks a
```
```python
"hosts"
```
```python
field. This makes it unsuitable
```
```python
for
```
```python
websites. For
```
```python
more
```
```python
information see the Baseline Requirements
```
```python
for
```
```python
the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum
```
```python
(
```
```python
https://cabforum.org
```
```python
)
```
```python
;
```
```python
specifically, section 10.2.3
```
```python
(
```
```python
"Information Requirements"
```
```python
)
```
```python
.
/etc/ssl/k8s/cert-kubeproxy-key.pem  /etc/ssl/k8s/cert-kubeproxy.pem
Cluster
```
```python
"kubernetes"
```
```python
set.
User
```
```python
"kubelet-bootstrap"
```
```python
set.
Context
```
```python
"default"
```
```python
modified.
Switched to context
```
```python
"default"
```
```python
.
```
```python
Cluster
```
```python
"kubernetes"
```
```python
set.
User
```
```python
"kube-proxy"
```
```python
set.
Context
```
```python
"default"
```
```python
modified.
Switched to context
```
```python
"default"
```
```python
.
```
```python
clusterrolebinding.rbac.authorization.k8s.io/kubelet-bootstrap created
```
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
#
```
这样node上相关的主要准备就基本就绪，接下来就可以启动kube-proxy和kublet了

