# 私有化部署方案 



# 人脸私有化方案介绍

## 产品概述

### 产品定义

人脸识别私有化方案是基于人脸识别模型封装而成的能够本地化部署的方案，可以实现在线API的全部功能。私有化方案是一个纯软件的方案，将此软件包部署包开发者本地的服务器上运行能够得到与在线API功能完全相同的接口（参数有少量区别，请参考接口文档）。

### 方案优势

- 纯离线：满足无网、弱网、专网等多种网络需求，在数据私密的场景下也可以使用
- 纯软件：纯软件方案可以快速测试、快速交付，且不与硬件进行捆绑，更灵活、利润也更高
- 超大人脸库：支持百万级人脸库，毫秒级输出搜索结果，理论上人脸库大小无上限，且搜索响应时间不随人脸库增大而增加

### 适用场景

私有化方案部署至客户本地服务器，可以实现大型人脸库的快速查找，支持百万级人脸库，毫秒级输出搜索结果，提供分布式高并发部署方案，适用于无网、弱网、专网等多种网络需求。可以应用于**楼宇监控、校园安防**等数据私密性要求较高的场景以及**地铁通行**等超大人脸库、高并发场景。

### 产品模式

私有化方案给开发者提供的是包含人脸识别模型的部署包软件，具体的硬件采购和硬件部署需要开发者自己解决，即：百度只提供模型，需要客户自己解决硬件采购和部署开发的问题。 百度在私有化方案中扮演底层模型能力输出者的角色，为集成商提供模型以及模型部署的指导，而不接触最终客户，由集成商与客户签单，负责硬件采购、服务器部署和产品开发。 ![img](https://ai.bdstatic.com/file/900DE4DEBE7C4D52A06C41D375C34876)

## 产品功能

1、人脸检测与属性分析 检测图中的人脸，并为人脸标记出边框。检测出人脸后，可对人脸进行分析，获得眼、口、鼻轮廓等72个关键点定位准确识别多种人脸属性，如性别，年龄，表情等信息。该技术可适应大角度侧脸，遮挡，模糊，表情变化等各种实际环境。

2、活体检测

- 在线图片活体检测 基于图片中人像的破绽（摩尔纹、成像畸形等）来判断目标对象是否为活体，可有效防止屏幕二次翻拍等作弊攻击，可使用单张或多张判断逻辑。
- H5视频活体检测 用户上传一个现场录制的视频，通过分析这个视频的人脸信息，完成活体检测判断。

3、人脸比对

- 生活照 通过提取人脸的特征，计算两张人脸的相似度，从而判断是否同一个人，并给出相似度评分。在已知用户ID的情况下帮助确认是否为用户本人的对比操作，即1：1身份验证。可用于真实身份验证、人证合一验证等场景
- 证件照 在“人脸比对-生护照”的基础上，针对身份证等证件照片的比对进行专项优化

4、人脸搜索

在一个指定人脸库中查找相似的人脸。给定一张照片，与指定人脸库中的N个人脸进行比对，找出最相似的一张脸或多张人脸。 根据待识别人脸与现有人脸库中的人脸匹配程度，返回用户信息和匹配度，即1：N人脸检索。可用于用户身份识别、身份验证相关场景。

5、人脸库管理

提供人脸注册、人脸更新、人脸删除、创建用户组、删除用户组等维度的人脸库管理接口，与在线接口的人脸库管理功能完全相同。

## 服务授权

### 授权方式

私有化方案需要对硬件进行授权，授权前需要开发者在一个物理机上运行百度提供的授权服务，提取硬件指纹（采集指纹的工具由百度提供），将硬件指纹提供给百度员工换取License文件，License文件中会包含**授权数量**以及**授权有效期**。将运行人脸识别模型的GPU与运行授权服务的硬件间建立通信，就能在运行起人脸识别模型了，可运行模型的显卡数量与**授权数量**相同。

> 注：授权服务可以运行在CPU设备上（比如一台固定的PC机），针对这台设备生成license，license文件中包含几个授权，就可以让人脸识别模型在多少个显卡上运行，只要保证被采集了指纹的硬件不被替换，授权也不受影响（即使替换GPU服务器也不会受影响）。

![img](https://ai.bdstatic.com/file/811822D93CB047EBB192C687F85D8E94)

### 授权有效期

授权是永久有效的，且支持部署包升级。百度一直保持授权服务的兼容，只要您之前已经购买过某个模型的授权，那么百度在这个模型上的性能提升后的新版部署包，都可以自助升级。但如果新增功能，形成了一个新的接口，则需要重新购买。

## 服务部署

### 部署环境

```
系统：linux系统
系统架构：x86_64架构
Centos 7.2以上
GPU： GPU需要nvidia版本，驱动版本384.66
docker： 建议版本17.12，docker的容器大小需要配置为30G
nvidia-docker2：建议版本2.02 
CUDA: cuda8.0
CPU：E5-2620V4X2，32线程
内存：无硬性要求，但内存容量会影响可以创建的人脸库的大小：人脸查找时需要将人脸放到内存中（一条人脸占用4k内存）
```

### 部署内容

1、授权服务

部署授权服务是人脸私有化部署的第一步。

运行在CPU硬件上的授权服务主要用于为人脸识别服务进行授权，确定可以连接的GPU数量以及授权的有效期。

2、人脸识别服务

人脸识别服务主要运行人脸识别的算法，运行人脸检测、人脸比对、人脸搜索等功能。此服务需要运行在GPU硬件上，且需要与授权服务保持连接，授权服务决定了人脸识别服务可以运行在多少个GPU上。目前人脸识别服务支持单机单实例、单机多实例、集群部署等三种方式。

- 单机单实例：单机、单实例 一键部署，部署步骤最简单，成功率高。适用于一些Demo、试用场景。
- 单机多实例：支持单机或多机多实例部署，单卡多实例等部署，可以指定服务运行的GPU，需要单独部署mysql，部署相对复杂一些，适用于小规模服务集群，手动维护。
- 集群部署：支持使用集群管理方式，分模块分服务部署。除依赖docker以外需要镜像仓库、分布式文件系统、k8s服务集群 等，部署难度较高，但基于k8s可以做运维工作的标准化自动化，适用于大规模服务集群。

详细部署过程，请参考人脸识别私有化部署说明文档

3、数据库

部署用于存储图片的数据库，也可以方便的进行灾备管理。

## 性能指标

1、单GPU支持QPS数量

单张NVIDIA Tesla p4卡可以达到15~20QPS，理论横向扩展无限制。

注：推荐单机4卡的方式进行部署，单机6卡或更多的情况下，GPU利用率会下降。

2、人脸库查询速度

比对速度和查找速度，可以实现1s以内返回。当人脸底库在100w级别，单核可在1秒内完成一次比对查找，理论上支持无限水平扩展。

3、人脸库大小

人脸库理论上没有上限限制，存储人脸库需要消耗内存，单条人脸消耗 4KB。 人脸库总量大小影响比对速度，主要消耗CPU，单核1：100万 在1秒内完成，如果要在1秒内完成1：1000万需要10个核，理论横向扩展无限制

## 价格策略

私有化方案的计费策略是：按照授权数量计费，且不同功能组合分别计费。

1、人脸检测（检测是否有人脸、人脸属性分析、在线活体检测）：2万元/授权

2、人脸识别（包括人脸检测、人脸比对1：1、人脸查找1：N）：3万元/授权 ![img](https://ai.bdstatic.com/file/68C58BCCE98C46659FA811F095825319)

## 硬件配置

私有化部署包对于硬件没有强制性要求，**推荐使用NVIDIA Tesla p4**，我们会对NVIDIA Tesla p4进行针对性优化，提高GPU利用率，每个硬件对于人脸识别服务的影响如下：

- CPU：人脸库总量大小影响比对速度，主要消耗CPU。 计算方式：所需CPU数量=所需CPU内核数量➗每个CPU的核数=（人脸库大小➗100万）➗每个CPU的核数
- 内存：人脸库 需要消耗内存，单条记录 4KB。 计算方式：所需内存大小=人脸服务所需内存+其他服务所需内存=人脸库大小x4（单位是：kb）+其他服务所需内存 内存建议比计算值大一半以上，保证服务的稳定运行。
- 硬盘：影响能够存储的人脸数量。 计算方式：所需存储空间大小=人脸服务所需存储+其他服务所需存储=人脸图片数量x单张人脸图片大小+其他服务所需存储
- GPU：影响能够处理的并发请求的数量。 计算方式：所需p4显卡的数量=业务并发量➗15（显卡以Nvdia Tesla P4显卡为例）

推荐按照下图搭配： ![img](https://ai.bdstatic.com/file/7366D830D2004B07906BDF830FC476CB)

### 显卡选型建议

- NVDIA Tesla系列：P4、p40 推荐使用P4卡（单张P4卡支持15~20QPS）。 p40显存更大，但运行模型的计算单元并不多，因此运行人脸识别模型的性能与p4基本没差别。
- NVDIA GTX系列：1070、1080、1080Ti，** 显存需要6G以上 ** 百度的人脸识别私有化部署包对于GTX系列的显卡也是兼容的，由于GTX的计算单元比p4更多，因此单卡支持的QPS数量也会更多，但因为GTX并非服务器专用显卡，请大家基于自身业务需求进行选择。

## 部署概述

百度人脸私有化部署方案是一个纯软件方案，需要开发者准备GPU和相关的基础环境，部署成功后，即可获得与百度公有云基本完全相同的接口。 百度人脸私有化方案部署的三个核心环节是：鉴权服务部署，数据库服务部署、人脸识别服务部署

- 鉴权服务部署：鉴权服务用于给人脸识别服务进行认证授权，如果不运行鉴权服务，后续的人脸服务也将无法启动
- 数据库服务部署：多实例部署模式及K8s集群部署模式需要进行数据库服务的安装。数据库服务的安装请参考数据库服务部署流程章节
- 人脸识别服务部署：包含docker等基础环境以及人脸识别的模型，是私有化人脸识别产品的的核心。部署人脸识别服务的前提是部署鉴权服务，识别服务在运行时会实时请求鉴权服务，需要保障两个服务之间能够顺利通信。

具体操作流程请参考：[私有化人脸识别产品](http://ai.baidu.com/docs#/PrivateAI_FaceProducts/top)

### 接口调用文档

请参考[文档中心->视觉技术->人脸识别->私有化部署方案->接口文档](http://ai.baidu.com/docs#/Face_Private_API/top)

## 常见问题

1、 私有化的识别准确率如何？

与公有云在线接口的识别准确率基本相同。

![img](https://ai.bdstatic.com/file/195BCB051E4044FFBE81D4F23A54FBEB)









# 人脸私有化部署文档

## 概述

百度人脸私有化部署方案是一个纯软件方案，需要开发者准备GPU和相关的基础环境，部署成功后，即可获得与百度公有云基本完全相同的接口。 百度人脸私有化方案部署的三个核心环节是：鉴权服务部署，数据库服务部署、人脸识别服务部署

- 鉴权服务部署：鉴权服务用于给人脸识别服务进行认证授权，如果不运行鉴权服务，后续的人脸服务也将无法启动
- 数据库服务部署：多实例部署模式及K8s集群部署模式需要进行数据库服务的安装。数据库服务的安装请参考数据库服务部署流程章节
- 人脸识别服务部署：包含docker等基础环境以及人脸识别的模型，是私有化人脸识别产品的的核心。部署人脸识别服务的前提是部署鉴权服务，识别服务在运行时会实时请求鉴权服务，需要保障两个服务之间能够顺利通信。

具体操作流程请参考：[私有化人脸识别产品](http://ai.baidu.com/docs#/PrivateAI_FaceProducts/top)







# 人脸识别私有化接口文档

## 总体说明

私有化部署包部署成功后，即可获得与公有云基本完全相同的接口，人脸识别的相关接口将会启动，即可开始调用。

在私有化部署包中会提供如下4类接口：

### 人脸检测与属性分析：

**接口能力**

- **人脸检测**：检测图片中的人脸并标记出位置信息;
- **人脸关键点**：展示人脸的核心关键点信息，及72个关键点信息。
- **人脸属性值**：展示人脸属性信息，如年龄、性别等。
- **人脸质量信息**：返回人脸各部分的遮挡、光照、模糊、完整度、置信度等信息。

典型应用场景：如**人脸属性分析**，**基于人脸关键点的加工分析**，**人脸营销活动**等。

### 人脸比对

**接口能力**

- **两张人脸图片相似度对比**：比对两张图片中人脸的相似度，并返回相似度分值；
- **多种图片类型**：支持**生活照**、**证件照**、**身份证芯片照**、**带网纹照**四种类型的人脸对比；
- **活体检测控制**：基于图片中的破绽分析，判断其中的人脸是否为**二次翻拍**（举例：如用户A用手机拍摄了一张包含人脸的图片一，用户B翻拍了图片一得到了图片二，并用图片二伪造成用户A去进行识别操作，这种情况普遍发生在金融开户、实名认证等环节。）；
- **质量检测控制**：分析图片的中人脸的模糊度、角度、光照强度等特征，判断图片质量；

**业务应用**

用于比对多张图片中的人脸相似度并返回两两比对的得分，可用于判断两张脸是否是同一人的可能性大小。

典型应用场景：如**人证合一验证**，**用户认证**等，可与您现有的人脸库进行比对验证。

### 人脸搜索

**业务能力**

- **1：N人脸搜索**：也称为1：N识别，在指定人脸集合中，找到最相似的人脸；
- **1：N人脸认证**：基于uid维度的1：N识别，由于uid已经锁定固定数量的人脸，所以检索范围更聚焦；

> **1：N人脸识别**与**1：N人脸认证**的差别在于：人脸搜索是在指定人脸集合中进行直接地人脸检索操作，而人脸认证是基于uid，先调取这个uid对应的人脸，再在这个uid对应的人脸集合中进行检索（因为每个uid通常对应的只有一张人脸，所以通常也就变为了1：1对比）；实际应用中，人脸认证需要用户或系统先输入id，这增加了验证安全度，但也增加了复杂度，具体使用哪个接口需要视您的业务场景判断。

> 提示：进行人脸查找相关操作前，建议先阅读**人脸库管理**相关内容。

### 人脸库管理

**业务能力**

要完成1：N或者M：N识别，首先需要构建一个人脸库，用于存放所有人脸特征，相关接口如下：

- **人脸注册**：向人脸库中添加人脸
- **人脸更新**：更新人脸库中指定用户下的人脸信息
- **人脸删除**：删除指定用户的某张人脸
- **用户信息查询**：查询人脸库中某个用户的详细信息
- **获取用户人脸列表**：获取某个用户组中的全部人脸列表
- **获取用户列表**：查询指定用户组中的用户列表
- **复制用户**：将指定用户复制到另外的人脸组
- **删除用户**：删除指定用户
- **创建用户组**：创建一个新的用户组
- **删除用户组**：删除指定用户组
- **组列表查询**：查询人脸库中用户组的列表

**人脸库结构**

人脸库、用户组、用户、用户下的人脸**层级关系**如下所示：

```
|- 人脸库(appid)
   |- 用户组一（group_id）
      |- 用户01（uid）
         |- 人脸（faceid）
      |- 用户02（uid）
         |- 人脸（faceid）
         |- 人脸（faceid）
         ....
       ....
   |- 用户组二（group_id）
   |- 用户组三（group_id）
   ....
```

**关于人脸库的设置限制**

- 每个开发者账号可以创建100个appid；
- **每个appid对应一个人脸库，且不同appid之间，人脸库互不相通**；
- 每个人脸库下，可以创建多个用户组，用户组（group）数量**没有限制**；
- 每个用户组（group）下，可添加**无限**个user_id，**无限**张人脸（注：为了保证查询速度，单个group中的人脸容量上限建议为**80万**）；
- 每个用户（user_id）所能注册的最大人脸数量**没有限制**；

> 提醒：每个人脸库对应一个appid，一定不要轻易删除appid，删除后则此人脸库将失效，无法进行查找！

## 接口格式说明

### 变量类型定义

| 类型       | 定义                                                         |
| :--------- | :----------------------------------------------------------- |
| string     | 普通的字符串，可能会有长度要求，具体参见接口说明中的备注     |
| uint32     | 整形数字，最大取值为4字节int。自然数                         |
| int64      | 整形数字，最大取值为8字节int。允许负数                       |
| json       | 无论是request还是response中某个字段定义为json，那么它其实是一个json格式的字符串，需要二次解析 |
| array      | request的query中表示array请使用key[] 。response的json中的array即为jsonArray |
| double     | 双精度，小数点后最大8位四舍五入                              |
| encryption | 加密格式，一般用于人脸服务各模块间交互数据使用。             |

### 注意事项

- 所有ID定义必须为小于等于32字节的数字字母组合，尽量使用无意义的组合，并且不可以使用系统保留关键字：all、self、me、this、next。
- 所有接口POSTDATA 应当小于等于**8M**。
- 单个group中的图片容量上限建议为**80万**
- 人脸图片需要人脸像素在100x100以上，否则可能检测不出来人脸

### 请求方式

请求方式统一使用`application/json`请求

- **直接请求** 直接请求时需要将appid参数拼接在url中，不要放在json body中 注意：如果是直接对线上单台机器发起请求，需要在接口路径前加上`/api`的前缀

### 返回格式

- **error_code**、**error_msg**即错误码和错误描述，详细含义请参考错误码表, **error_code为0代表请求成功**
- **result**是接口返回的详细信息, 格式为数组。
- **log_id**是请求的日志id, **13位长(bigint)**, 用于定位请求。

```
{
    "error_code" : 0,  //错误码 0代表成功
    "error_msg"  : "SUCCESS", //错误信息
    "result" : {...} //返回结果 具体内容详见相关接口
    "log_id" : 3535325235 //请求的日志id
    "timestamp" : 1512391548 //请求到达的时间戳 精确到秒级
    "cached" : 0 //未启用 无需处理
}
```

### 阈值说明

遮挡情况的阈值

| 控制度 | left_eye | right_eye | nose | mouth | left_cheek | right_cheek | chin_contour |
| :----- | :------- | :-------- | :--- | :---- | :--------- | :---------- | :----------- |
| LOW    | 0.8      | 0.8       | 0.8  | 0.8   | 0.8        | 0.8         | 0.8          |
| NORMAL | 0.6      | 0.6       | 0.6  | 0.6   | 0.6        | 0.6         | 0.6          |
| HIGH   | 0.2      | 0.2       | 0.2  | 0.2   | 0.2        | 0.2         | 0.2          |

模糊度、完整度的阈值

| 控制度 | illumination | blurdegree | completeness |
| :----- | :----------- | :--------- | :----------- |
| LOW    | 20           | 0.8        | 0            |
| NORMAL | 40           | 0.6        | 0            |
| HIGH   | 100          | 0.2        | 1            |

**参数说明**

| 参数         | 说明                                                         |
| :----------- | :----------------------------------------------------------- |
| left_eye     | 左眼被遮挡的比例 [0-1] 1表示完全遮挡                         |
| right_eye    | 右眼被遮挡的比例 [0-1] 1表示完全遮挡                         |
| nose         | 鼻子被遮挡的比例 [0-1] 1表示完全遮挡                         |
| mouth        | 嘴巴被遮挡的比例 [0-1] 1表示完全遮挡                         |
| left_cheek   | 左脸颊被遮挡的比例 [0-1] 1表示完全遮挡                       |
| right_cheek  | 右脸颊被遮挡的比例 [0-1] 1表示完全遮挡                       |
| chin_contour | 下巴被遮挡比例 [0-1] 1表示完全遮挡                           |
| illumination | 光照 [0-255] 0表示光照不好                                   |
| blurdegree   | 图片模糊度 [0-1] 1表示完全模糊                               |
| completeness | 人脸完整度（0或1） 0为人脸溢出图像边界，1为人脸都在图像边界内 |

**活体控制阈值**

> 不同的控制度下所对应的活体控制阈值 如果检测出来的活体分数小于控制阈值，则会返回错误。

| 控制度 | 阈值 | 说明                                                        |
| :----- | :--- | :---------------------------------------------------------- |
| LOW    | 0.05 | 0.01%活体误拒率 **对应的通过率为99.99% 攻击拒绝率为63.91%** |
| NORMAL | 0.3  | 0.1%活体误拒率 **对应的通过率为99.9% 攻击拒绝率为90.32%**   |
| HIGH   | 0.9  | 1%活体误拒率 **对应的通过率为99% 攻击拒绝率为97.56%**       |

> 误拒率（FRR）：如0.5%，指1000次真人请求，会有5次因为活体分数低于阈值被错误拒绝。 通过率（TAR）：如99%，指100次真人请求，会有99次因为活体分数高于阈值而通过。 攻击拒绝率（TRR）：如99%，代表100次作弊假体攻击，会有99次被拒绝。 误拒率越高， 其对攻击的防范能力也会越高

## 调用准备

1、调用接口的地址示例：[192.168.0.1]:8300/face-api/v3/face/detect，其中ip需要替换为用户自己服务器的ip，端口固定为：8300，接口地址需要替换为下述接口的地址。

2、调用接口时需要指定appid，此appid为用户自定的id，目前可以通过调用“创建用户组”接口来创建appid

## 接口文档

### 人脸检测

> 检测图片中的人脸并获得位置信息, 属性信息, 质量信息等

- 路径

/face-api/v3/face/detect

- 请求参数

| 参数         | 必选 | 类型   | 说明                                                         |
| :----------- | :--- | :----- | :----------------------------------------------------------- |
| appid        | 是   | string | app标识 （由数字、字母、下划线组成），长度限制48B            |
| image        | 是   | string | 图片信息(**数据大小应小于10M**)                              |
| image_type   | 是   | string | 图片类型 **BASE64**:图片的base64值;**FACE_TOKEN**: 人脸标识  |
| max_face_num | 否   | uint32 | 最多处理人脸的数目. **默认值为1，仅检测图片中面积最大的那个人脸** **最大值10** |
| face_type    | 否   | string | 人脸的类型 **LIVE**表示生活照：通常为手机、相机拍摄的人像图片、或从网络获取的人像图片等, |

**IDCARD**表示身份证芯片照：二代身份证内置芯片中的人像照片 **WATERMARK**表示带水印证件照：一般为带水印的小图，如公安网小图 **CERT**表示证件照片：如拍摄的身份证、工卡、护照、学生证等证件图片 **INFRARED** 表示红外照片：使用红外相机拍摄的照片(此项功能暂未上线) 默认**LIVE** | | face_field | 否 | string | 包括**age,beauty,expression,face_shape,gender,glasses,landmark,race,quality**,**face_type**,**parsing**,**feature**信息，逗号分隔.
**默认只返回face_token、活体数、人脸框、概率和旋转角度** |

- 请求示例

```
  {
      "image": "027d8308a2ec665acb1bdf63e513bcb9",
      "image_type": "FACE_TOKEN",
      "face_field": "faceshape,facetype"
  }
```

- 返回结果

| 字段             | 必选 | 类型   | 说明                                                         |
| :--------------- | :--- | :----- | :----------------------------------------------------------- |
| face_num         | 是   | int    | 图片中的人脸数量                                             |
| face_list        | 是   | array  | 人脸信息列表 字段信息见下                                    |
| face_token       | 是   | string | 人脸标志                                                     |
| location         | 是   | array  | 人脸在图片中的位置                                           |
| +left            | 是   | double | 人脸区域离左边界的距离                                       |
| +top             | 是   | double | 人脸区域离上边界的距离                                       |
| +width           | 是   | double | 人脸区域的宽度                                               |
| +height          | 是   | double | 人脸区域的高度                                               |
| +rotation        | 是   | int64  | 人脸框相对于竖直方向的顺时针旋转角，[-180,180]               |
| face_probability | 是   | double | 人脸置信度，范围0-1                                          |
| angel            | 是   | array  | 人脸旋转参数                                                 |
| +yaw             | 是   | double | 三维旋转之左右旋转角[-90(左), 90(右)]                        |
| +pitch           | 是   | double | 三维旋转之俯仰角度[-90(上), 90(下)]                          |
| +roll            | 是   | double | 平面内旋转角[-180(逆时针), 180(顺时针)]                      |
| age              | 否   | double | 年龄 **face_field包含age时返回**                             |
| beauty           | 否   | int64  | 美丑打分，范围0-100，越大表示越美。**face_fields包含beauty时返回** |
| expression       | 否   | array  | 表情 **face_field包含expression时返回**                      |
| +type            | 否   | string | **none**:不笑；**smile**:微笑；**laugh**:大笑                |
| +probability     | 否   | double | 表情置信度，范围0~1                                          |
| face_shape       | 否   | array  | 脸型 **face_field包含faceshape时返回**                       |
| +type            | 否   | double | **square**: 正方形 **triangle**:三角形 **oval**: 椭圆 **heart**: 心形 **round**: 圆形 |
| +probability     | 否   | double | 置信度 范围0~1                                               |
| gender           | 否   | array  | 性别 **face_field包含gender时返回**                          |
| +type            | 否   | string | male:**男性** female:**女性**                                |
| +probability     | 否   | double | 性别置信度，范围0~1                                          |
| glasses          | 否   | array  | 是否带眼镜 **face_field包含glasses时返回**                   |
| +type            | 否   | string | **none**:无眼镜，**common**:普通眼镜，**sun**:墨镜           |
| +probability     | 否   | double | 眼镜置信度，范围0~1                                          |
| race             | 否   | array  | 人种 **face_field包含race时返回**                            |
| +type            | 否   | string | **yellow**: 黄种人 **white**: 白种人 **black**:黑种人 **arabs**: **阿拉伯人** |
| +probability     | 否   | double | 人种置信度，范围0~1                                          |
| face_type        | 否   | array  | 真实人脸/卡通人脸 **face_field包含facetype时返回**           |
| +type            | 否   | string | **human**: 真实人脸 **cartoon**: 卡通人脸                    |
| +probability     | 否   | double | 置信度，范围0~1                                              |
| landmark         | 否   | array  | 4个关键点位置，左眼中心、右眼中心、鼻尖、嘴中心。**face_field包含landmark时返回** |
| landmark72       | 否   | array  | 72个特征点位置 **face_field包含landmark时返回**              |
| quality          | 否   | array  | 人脸质量信息。**face_field包含quality时返回**                |
| +occlusion       | 否   | array  | 人脸各部分遮挡的概率，范围[0~1]，0表示完整，1表示不完整      |
| ++left_eye       | 否   | double | 左眼遮挡比例                                                 |
| ++right_eye      | 否   | double | 右眼遮挡比例                                                 |
| ++nose           | 否   | double | 鼻子遮挡比例                                                 |
| ++mouth          | 否   | double | 嘴巴遮挡比例                                                 |
| ++left_cheek     | 否   | double | 左脸颊遮挡比例                                               |
| ++right_cheek    | 否   | double | 右脸颊遮挡比例                                               |
| ++chin_contour   | 否   | double | 下巴遮挡比例                                                 |
| +blur            | 否   | double | 人脸模糊程度，范围[0~1]，0表示清晰，1表示模糊                |
| +illumination    | 否   | double | 取值范围在[0~255], 表示脸部区域的光照程度 越大表示光照越好   |
| +completeness    | 否   | int64  | 人脸完整度，0或1, 0为人脸溢出图像边界，1为人脸都在图像边界内 |
| parsing_info     | 否   | string | 人脸分层结果 结果数据是使用gzip压缩后再base64编码 使用前需base64解码后再解压缩 **原数据格式为string 形如0,0,0,0,0,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,…** |

- 返回示例

```
  {
      "error_code": 0,
      "error_msg": "SUCCESS",
      "log_id": 1234567890123,
      "timestamp": 1533094400,
      "cached": 0,
      "result": {
          "face_num": 1,
          "face_list": [
              {
                  "face_token": "35235asfas21421fakghktyfdgh68bio",
                  "location": {
                      "left": 117,
                      "top": 131,
                      "width": 172,
                      "height": 170,
                      "rotation": 4
                  },
                  "face_probability": 1,
                  "angle": {
                      "yaw": -0.34859421849251,
                      "pitch": 1.9135693311691,
                      "roll": 2.3033397197723
                  },
                  "age": 29.298097610474,
                  "beauty": 55.128883361816,
                  "expression": {
                      "type": "smile",
                      "probability": 0.5543018579483
                  },
                  "gender": {
                      "type": "male",
                      "probability": 0.99979132413864
                  },
                  "glasses": {
                      "type": "sun",
                      "probability": 0.99999964237213
                  },
                  "eye_status": {
                      "left_eye": 0.9999974966,
                      "right_eye": 0.9999724627
                  },
                  "race": {
                      "type": "yellow",
                      "probability": 0.99999976158142
                  },
                  "face_shape": {
                      "type": "triangle",
                      "probability": 0.5543018579483
                  },
                  "quality": {
                      "occlusion": {
                          "left_eye": 0,
                          "right_eye": 0.015625,
                          "nose": 0,
                          "mouth": 0,
                          "left_cheek": 0.03078358248,
                          "right_cheek": 0.03356481344,
                          "chin_contour": 0.006372549105
                      },
                      "blur": 5.188863383e-7,
                      "illumination": 131,
                      "completeness": 1
                  }
              }
          ]
      }
 }
```

### 活体检测

> 多图活体检测接口，支持1、3、8图片检测

- 路径

/face-api/v3/face/liveness

- 请求参数

| 参数名     | 必选 | 类型   | 说明                                                         |
| :--------- | :--- | :----- | :----------------------------------------------------------- |
| appid      | 是   | string | app标识 （由数字、字母、下划线组成）， 长度限制48B(需要通过query的形式传入) |
| image      | 是   | string | 图片信息(**总数据大小应小于10M**), 具体信息内容是根据image_type来判断 |
| image_type | 是   | string | 图片类型 BASE64:图片的base64值, FACE_TOKEN: 人脸标识         |
| face_field | 否   | string | 包括**age,beauty,expression,face_shape,gender,glasses,landmark,race,quality**,**face_type**,**parsing**,**feature**信息，逗号分隔. **默认只返回face_token、活体数、人脸框、概率和旋转角度** |

> **feature**参数的作用是预先提取人脸特征，如果后续需要使用face_token进行人脸注册、人脸对比或人脸搜索操作，推荐使用此参数

- 请求示例

```
  [
        {
            "image": "sfasq35sadvsvqwr5q...",
            "image_type": "BASE64",
            "face_field": "age,beauty,expression"
        },
        {
            "image": "http://xxx.baidu.com/image1.png",
            "image_type": "URL",
            "face_field": "age,beauty"
        }
  ]
```

- 返回结果

| 字段             | 必选 | 类型   | 说明                                                         |
| :--------------- | :--- | :----- | :----------------------------------------------------------- |
| face_liveness    | 是   | float  | 所有图片的总体活体打分 范围[0~1]                             |
| thresholds       | 是   | array  | 由服务端返回最新的阈值数据（随着模型的优化，阈值可能会变化），将此参数与返回的face_liveness进行比较，可以作为活体判断的依据。 frr_1e-4：万分之一误识率的阈值；frr_1e-3：千分之一误识率的阈值；frr_1e-2：百分之一误识率的阈值。误识率越低，准确率越高，相应的拒绝率也越高 |
| face_list        | 是   | array  | 人脸信息列表 字段信息见下                                    |
| face_token       | 是   | string | 人脸标志                                                     |
| location         | 是   | array  | 人脸在图片中的位置                                           |
| +left            | 是   | double | 人脸区域离左边界的距离                                       |
| +top             | 是   | double | 人脸区域离上边界的距离                                       |
| +width           | 是   | double | 人脸区域的宽度                                               |
| +height          | 是   | double | 人脸区域的高度                                               |
| +rotation        | 是   | int64  | 人脸框相对于竖直方向的顺时针旋转角，[-180,180]               |
| face_probability | 是   | double | 人脸置信度，范围0-1                                          |
| angel            | 是   | array  | 人脸旋转参数                                                 |
| +yaw             | 是   | double | 三维旋转之左右旋转角[-90(左), 90(右)]                        |
| +pitch           | 是   | double | 三维旋转之俯仰角度[-90(上), 90(下)]                          |
| +roll            | 是   | double | 平面内旋转角[-180(逆时针), 180(顺时针)]                      |
| age              | 否   | double | 年龄 **face_field包含age时返回**                             |
| beauty           | 否   | int64  | 美丑打分，范围0-100，越大表示越美。**face_fields包含beauty时返回** |
| expression       | 否   | array  | 表情 **face_field包含expression时返回**                      |
| +type            | 否   | string | **none**:不笑；**smile**:微笑；**laugh**:大笑                |
| +probability     | 否   | double | 表情置信度，范围0~1                                          |
| face_shape       | 否   | array  | 脸型 **face_field包含faceshape时返回**                       |
| +type            | 否   | double | **square**: 正方形 **triangle**:三角形 **oval**: 椭圆 **heart**: 心形 **round**: 圆形 |
| +probability     | 否   | double | 置信度 范围0~1                                               |
| gender           | 否   | array  | 性别 **face_field包含gender时返回**                          |
| +type            | 否   | string | male:**男性** female:**女性**                                |
| +probability     | 否   | double | 性别置信度，范围0~1                                          |
| glasses          | 否   | array  | 是否带眼镜 **face_field包含glasses时返回**                   |
| +type            | 否   | string | **none**:无眼镜，**common**:普通眼镜，**sun**:墨镜           |
| +probability     | 否   | double | 眼镜置信度，范围0~1                                          |
| race             | 否   | array  | 人种 **face_field包含race时返回**                            |
| +type            | 否   | string | **yellow**: 黄种人 **white**: 白种人 **black**:黑种人 **arabs**: **阿拉伯人** |
| +probability     | 否   | double | 人种置信度，范围0~1                                          |
| face_type        | 否   | array  | 真实人脸/卡通人脸 **face_field包含facetype时返回**           |
| +type            | 否   | string | **human**: 真实人脸 **cartoon**: 卡通人脸                    |
| +probability     | 否   | double | 置信度，范围0~1                                              |
| landmark         | 否   | array  | 4个关键点位置，左眼中心、右眼中心、鼻尖、嘴中心。**face_field包含landmark时返回** |
| landmark72       | 否   | array  | 72个特征点位置 **face_field包含landmark时返回**              |
| quality          | 否   | array  | 人脸质量信息。**face_field包含quality时返回**                |
| +occlusion       | 否   | array  | 人脸各部分遮挡的概率，范围[0~1]，0表示完整，1表示不完整      |
| ++left_eye       | 否   | double | 左眼遮挡比例                                                 |
| ++right_eye      | 否   | double | 右眼遮挡比例                                                 |
| ++nose           | 否   | double | 鼻子遮挡比例                                                 |
| ++mouth          | 否   | double | 嘴巴遮挡比例                                                 |
| ++left_cheek     | 否   | double | 左脸颊遮挡比例                                               |
| ++right_cheek    | 否   | double | 右脸颊遮挡比例                                               |
| ++chin_contour   | 否   | double | 下巴遮挡比例                                                 |
| +blur            | 否   | double | 人脸模糊程度，范围[0~1]，0表示清晰，1表示模糊                |
| +illumination    | 否   | double | 取值范围在[0~255], 表示脸部区域的光照程度 越大表示光照越好   |
| +completeness    | 否   | int64  | 人脸完整度，0或1, 0为人脸溢出图像边界，1为人脸都在图像边界内 |
| liveness         | 否   | array  | 单张图片活体检测结果                                         |
| +faceliveness    | 否   | double | 单张图片的活体原始值(需要对单张图片做活体判断时，请使用**livemapscore**) 范围[0~1] |
| +livemapscore    | 否   | double | 单张图片的活体打分 范围[0~1]                                 |
| parsing_info     | 否   | string | 人脸分层结果 结果数据是使用gzip压缩后再base64编码 使用前需base64解码后再解压缩 **原数据格式为string 形如0,0,0,0,0,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,…** |

- 返回示例

```
{
    "error_code": 0,
    "error_msg": "SUCCESS",
    "log_id": 1234567890123,
    "timestamp": 1533094517,
    "cached": 0,
    "result": {
        "thresholds": {
            "frr_1e-4": 0.05,  //万分之一误拒率的阈值
        	"frr_1e-3": 0.3,   //千分之一误拒率的阈值
       	    "frr_1e-2": 0.9    //百分之一误拒率的阈值
        },
        "face_liveness": 0.05532243927,
        "face_list": [
            {
                "face_token": "df46f7c7db4aa09a093c26fb8d1a8d44",
                "location": {
                    "left": 328.9026489,
                    "top": 97.16340637,
                    "width": 162,
                    "height": 154,
                    "rotation": 32
                },
                "face_probability": 1,
                "angle": {
                    "yaw": 10.16196251,
                    "pitch": 2.244354248,
                    "roll": 33.82199097
                },
                "liveness": {
                    "livemapscore": 0.04492170034
                },
                "age": 23,
                "beauty": 20.23693275
            },
            {
                "face_token": "901d2c64274fccd687d311a6e6110a01",
                "location": {
                    "left": 411.4876404,
                    "top": 166.3593445,
                    "width": 329,
                    "height": 308,
                    "rotation": 45
                },
                "face_probability": 0.9194830656,
                "angle": {
                    "yaw": -1.716423035,
                    "pitch": 7.344647408,
                    "roll": 45.79914856
                },
                "liveness": {
                    "livemapscore": 0.001787073661
                },
                "age": 23,
                "beauty": 12.6438179
            },
            {
                "face_token": "7d57e36981c48b4946eb97c8d838b02a",
                "location": {
                    "left": 161.4559937,
                    "top": 199.8726501,
                    "width": 218,
                    "height": 201,
                    "rotation": -1
                },
                "face_probability": 1,
                "angle": {
                    "yaw": -8.187754631,
                    "pitch": 6.973727226,
                    "roll": -1.25429821
                },
                "liveness": {
                    "livemapscore": 0.05532243927
                },
                "age": 23,
                "beauty": 8.20657444
            }
        ]
    }
}
```

- 活体阈值说明

| 阈值 | 误拒率 | 通过率 | 攻击拒绝率 |
| :--- | :----- | :----- | :--------- |
| 0.05 | 0.01%  | 99.99% | 63.91%     |
| 0.3  | 0.1%   | 99.9%  | 90.33%     |
| 0.9  | 1%     | 99%    | 97.56%     |

- 阈值（Threshold）：高于此数值，则可判断为活体。（视用户的业务场景需求，选用合适的阈值）
- 误拒率（FRR）：如0.5%，指1000次真人请求，会有5次因为活体分数低于阈值被错误拒绝。
- 通过率（TAR）：如99%，指100次真人请求，会有99次因为活体分数高于阈值而通过。
- 攻击拒绝率（TRR）：如99%，代表100次作弊假体攻击，会有99次被拒绝。

### 人脸对比

> 两张人脸图片相似度对比：比对两张图片中人脸的相似度，并返回相似度分值

- 路径

/v3/face/match

- 请求参数

| 参数             | 必选 | 类型   | 说明                                                         |
| :--------------- | :--- | :----- | :----------------------------------------------------------- |
| appid            | 是   | string | app标识 （由数字、字母、下划线组成），长度限制48B(需要通过query的形式传入) |
| image            | 是   | string | 图片信息(**数据大小应小于10M**)                              |
| image_type       | 是   | string | 图片类型 **BASE64**:图片的base64值; **FACE_TOKEN**: 人脸标识 |
| face_type        | 否   | string | 人脸的类型 **LIVE**表示生活照：通常为手机、相机拍摄的人像图片、或从网络获取的人像图片等 **IDCARD**表示身份证芯片照：二代身份证内置芯片中的人像照片 **WATERMARK**表示带水印证件照：一般为带水印的小图，如公安网小图 **CERT**表示证件照片：如拍摄的身份证、工卡、护照、学生证等证件图片 **INFRARED** 表示红外照片：使用红外相机拍摄的照片(此项功能暂未上线) 默认**LIVE** |
| quality_control  | 否   | string | 质量控制 **NONE**: 不进行控制 **LOW**:较低的质量要求 **NORMAL**: 一般的质量要求 **HIGH**: 较高的质量要求 **默认NONE** |
| liveness_control | 否   | string | 活体控制 **NONE**: 不进行控制 **LOW**:较低的活体要求(高通过率 低攻击拒绝率) **NORMAL**: 一般的活体要求(平衡的攻击拒绝率, 通过率) **HIGH**: 较高的活体要求(高攻击拒绝率 低通过率) **默认NONE** |

- 请求示例

```
  [
        {
            "image": "sfasq35sadvsvqwr5q...",
            "image_type": "BASE64",
            "face_type": "LIVE",
            "quality_control": "LOW",
            "liveness_control": "HIGH"
        },
        {
            "image": "sfasq35sadvsvqwr5q...",
            "image_type": "BASE64",
            "face_type": "IDCARD",
            "quality_control": "LOW",
            "liveness_control": "HIGH"
        }
  ]
```

- 返回结果

| 参数名      | 必选 | 类型   | 说明                                                         |
| :---------- | :--- | :----- | :----------------------------------------------------------- |
| score       | 是   | float  | 人脸相似度得分 80分以上可以判断为同一人， 此分值对应万分之一误识率 |
| face_list   | 是   | array  | 人脸信息列表                                                 |
| +face_token | 是   | string | 人脸标志                                                     |

- 返回示例

```
  {
      "error_code": 0,
      "error_msg": "SUCCESS",
      "log_id": 1234567890123,
      "timestamp": 1533094576,
      "cached": 0,
      "result": {
          "score": 44.3,
          "face_list": [
              {
                  "face_token": "fid1"
              },
              {
                  "face_token": "fid2"
              }
          ]
      }
  }
```

### 人脸认证

> 在指定人脸集合中，找到最相似的人脸

- 路径

/face-api/v3/face/identify

- 请求参数

| 参数             | 必选 | 类型   | 说明                                                         |
| :--------------- | :--- | :----- | :----------------------------------------------------------- |
| appid            | 是   | string | app标识 （由数字、字母、下划线组成），长度限制48B            |
| image            | 是   | string | 图片信息(**数据大小应小于10M**)                              |
| image_type       | 是   | string | 图片类型 **BASE64**:图片的base64值; **FACE_TOKEN**: face_token 人脸标识 |
| group_id_list    | 是   | string | 从指定的group中进行查找 用逗号分隔，**上限10个**             |
| user_id          | 否   | string | 指定user_id进行匹配                                          |
| match_threshold  | 否   | int    | 匹配阈值（设置阈值后，score低于此阈值的用户信息将不会返回） 最大100 最小0 默认0 **此阈值设置得越高，检索速度将会越快，推荐使用80的阈值** |
| quality_control  | 否   | string | 质量控制 **NONE**: 不进行控制 **LOW**:较低的质量要求 **NORMAL**: 一般的质量要求 **HIGH**: 较高的质量要求 **默认NONE** |
| liveness_control | 否   | string | 活体控制 **NONE**: 不进行控制 **LOW**:较低的活体要求(高通过率 低攻击拒绝率) **NORMAL**: 一般的活体要求(平衡的攻击拒绝率, 通过率) **HIGH**: 较高的活体要求(高攻击拒绝率 低通过率) **默认NONE** |
| max_user_num     | 否   | unit32 | 识别后返回的最大用户数，默认为1，最多返回20个                |

- 请求示例

```
  {
      "image": "027d8308a2ec665acb1bdf63e513bcb9",
      "image_type": "FACE_TOKEN",
      "group_id_list": "group_repeat,group_233",
      "quality_control": "LOW",
      "liveness_control": "NORMAL"
  }
```

- 返回结果

| 字段       | 必选 | 类型   | 说明                                                         |
| :--------- | :--- | :----- | :----------------------------------------------------------- |
| face_token | 是   | string | 人脸标志                                                     |
| user_list  | 是   | array  | 匹配的用户信息列表                                           |
| +group_id  | 是   | string | 用户所属的group_id                                           |
| +user_id   | 是   | string | 用户的user_id                                                |
| +user_info | 是   | string | 注册用户时携带的user_info                                    |
| +score     | 是   | float  | 用户的匹配得分 80分以上可以判断为同一人， 此分值对应万分之一误识率 |

```
{
  "error_code": 0,
  "error_msg": "SUCCESS",
  "log_id": 1234567890123,
  "timestamp": 1533094591,
  "cached": 0,
  "result": {
      "face_token": "fid",
      "user_list": [
          {
              "group_id": "test1",
              "user_id": "u333333",
              "user_info": "Test User",
              "score": 99.3
          }
      ]
  }
}
```

### 人脸注册

> 向人脸库中添加人脸(如果group,uid不存在, 则会自动创建用户组和注册用户) **一个用户组中只能有一个唯一的face_token**

- 路径:

/face-api/v3/face/add

- 请求参数

| 参数             | 必选 | 类型   | 说明                                                         |
| :--------------- | :--- | :----- | :----------------------------------------------------------- |
| appid            | 是   | string | app标识 （由数字、字母、下划线组成），长度限制48B            |
| user_id          | 是   | string | 用户id（由数字、字母、下划线组成），长度限制48B              |
| group_id         | 是   | string | 用户组id，标识一组用户（由数字、字母、下划线组成）， 长度限制48B |
| image            | 是   | string | 图片信息(**数据大小应小于10M**)                              |
| image_type       | 是   | string | 图片类型 **BASE64**:图片的base64值; **FACE_TOKEN**: 人脸标识 |
| user_info        | 否   | string | 用户资料，长度限制256B                                       |
| quality_control  | 否   | string | 质量控制 **NONE**: 不进行控制 **LOW**:较低的质量要求 **NORMAL**: 一般的质量要求 **HIGH**: 较高的质量要求 **默认NONE** |
| liveness_control | 否   | string | 活体控制 **NONE**: 不进行控制 **LOW**:较低的活体要求(高通过率 低攻击拒绝率) **NORMAL**: 一般的活体要求(平衡的攻击拒绝率, 通过率) **HIGH**: 较高的活体要求(高攻击拒绝率 低通过率) **默认NONE** |

- 请求示例

```
  {
      "image": "027d8308a2ec665acb1bdf63e513bcb9",
      "image_type": "FACE_TOKEN",
      "group_id": "group_repeat",
      "user_id" : "user1",
      "user_info" : "abc"
      "quality_control": "LOW",
      "liveness_control": "NORMAL"
  }
```

- 返回结果

| 字段       | 必选 | 类型   | 说明                                           |
| :--------- | :--- | :----- | :--------------------------------------------- |
| face_token | 是   | string | 人脸标志                                       |
| location   | 是   | array  | 人脸在图片中的位置信息                         |
| +left      | 是   | double | 人脸区域离左边界的距离                         |
| +top       | 是   | double | 人脸区域离上边界的距离                         |
| +width     | 是   | double | 人脸区域的宽度                                 |
| +height    | 是   | double | 人脸区域的高度                                 |
| +rotation  | 是   | int64  | 人脸框相对于竖直方向的顺时针旋转角，[-180,180] |

> **每个face_token在用户组下都是唯一的，即同一张人脸无法在同一个用户组下注册多次**

- 返回示例

```
  {
      "error_code": 0,
      "error_msg": "SUCCESS",
      "log_id": 1234567890123,
      "timestamp": 1533094602,
      "cached": 0,
      "result": {
          "face_token": "2fa64a88a9d5118916f9a303782a97d3",
          "location": {
              "left": 117,
              "top": 131,
              "width": 172,
              "height": 170,
              "rotation": 4
          }
      }
  }
```

### 人脸更新

> 用于对人脸库中指定用户，更新其下的人脸图像。 **说明**：针对一个user_id执行更新操作，新上传的人脸图像将覆盖该group_id中user_id的原有所有图像。

- 路径:

/face-api/v3/face/update

- 请求参数

| 参数             | 必选 | 类型   | 说明                                                         |
| :--------------- | :--- | :----- | :----------------------------------------------------------- |
| appid            | 是   | string | app标识 （由数字、字母、下划线组成），长度限制48B            |
| user_id          | 是   | string | 用户id（由数字、字母、下划线组成），长度限制48B              |
| group_id         | 是   | string | 用户组id，标识一组用户（由数字、字母、下划线组成）， 长度限制48B |
| image            | 是   | string | 图片信息(**数据大小应小于10M**)                              |
| image_type       | 是   | string | 图片类型 **BASE64**:图片的base64值; **FACE_TOKEN**: 人脸标识 |
| user_info        | 否   | string | 用户资料，长度限制256B                                       |
| quality_control  | 否   | string | 质量控制 **NONE**: 不进行控制 **LOW**:较低的质量要求 **NORMAL**: 一般的质量要求 **HIGH**: 较高的质量要求 **默认NONE** |
| liveness_control | 否   | string | 活体控制 **NONE**: 不进行控制 **LOW**:较低的活体要求(高通过率 低攻击拒绝率) **NORMAL**: 一般的活体要求(平衡的攻击拒绝率, 通过率) **HIGH**: 较高的活体要求(高攻击拒绝率 低通过率) **默认NONE** |

- 请求示例

```
  {
      "image": "027d8308a2ec665acb1bdf63e513bcb9",
      "image_type": "FACE_TOKEN",
      "group_id": "group_repeat",
      "user_id" : "user1",
      "user_info" : "cba"
      "quality_control": "LOW",
      "liveness_control": "NORMAL"
  }
```

- 返回结果

| 参数       | 必选 | 类型   | 说明                                           |
| :--------- | :--- | :----- | :--------------------------------------------- |
| face_token | 是   | string | 人脸标志                                       |
| location   | 是   | array  | 人脸在图片中的位置信息                         |
| +left      | 是   | double | 人脸区域离左边界的距离                         |
| +top       | 是   | double | 人脸区域离上边界的距离                         |
| +width     | 是   | double | 人脸区域的宽度                                 |
| +height    | 是   | double | 人脸区域的高度                                 |
| +rotation  | 是   | int64  | 人脸框相对于竖直方向的顺时针旋转角，[-180,180] |

- 返回示例

```
  {
      "error_code": 0,
      "error_msg": "SUCCESS",
      "log_id": 1234567890123,
      "timestamp": 1533094612,
      "cached": 0,
      "result": {
          "face_token": "2fa64a88a9d5118916f9a303782a97d3",
          "location": {
              "left": 117,
              "top": 131,
              "width": 172,
              "height": 170,
              "rotation": 4
          }
      }
  }
```

### 人脸列表

> 获取一个用户下的人脸列表

- 路径

/face-api/v3/face/list

- 请求参数

| 参数     | 必选 | 类型   | 说明                                              |
| :------- | :--- | :----- | :------------------------------------------------ |
| appid    | 是   | string | app标识 （由数字、字母、下划线组成），长度限制48B |
| user_id  | 是   | string | 用户id（由数字、字母、下划线组成），长度限制128B  |
| group_id | 是   | string | 用户组id（由数字、字母、下划线组成） 长度限制48B  |

- 请求示例

```
  {
      "user_id": "user1",
      "group_id": "group1"
  }
```

- 返回结果

| 字段        | 必选 | 类型   | 说明         |
| :---------- | :--- | :----- | :----------- |
| face_list   | 是   | array  | 人脸信息列表 |
| +face_token | 是   | string | 人脸标志     |
| +ctime      | 是   | string | 人脸创建时间 |

- 返回示例

```
  {
      "error_code": 0,
      "error_msg": "SUCCESS",
      "log_id": 1234567890123,
      "timestamp": 1533094619,
      "cached": 0,
      "result": {
          "face_list": [
              {
                  "face_token": "fid1",
                  "ctime": "2018-01-01 00:00:00"
              },
              {
                  "face_token": "fid2",
                  "ctime": "2018-01-01 10:00:00"
              }
          ]
      }
  }
```

### 删除人脸

> 删除用户下的某一张人脸 如果该用户下没有其他人脸了则同时删除用户

- 路径

/face-api/v3/face/delete

- 请求参数

| 参数       | 必选 | 类型   | 说明                                              |
| :--------- | :--- | :----- | :------------------------------------------------ |
| appid      | 是   | string | app标识 （由数字、字母、下划线组成），长度限制48B |
| user_id    | 是   | string | 用户id（由数字、字母、下划线组成），长度限制128B  |
| group_id   | 是   | string | 用户组id（由数字、字母、下划线组成） 长度限制48B  |
| face_token | 是   | string | 人脸id（由数字、字母、下划线组成）长度限制64B     |

- 请求示例

```
  {
      "user_id": "user1",
      "group_id": "group1",
      "face_token": "2fa64a88a9d5118916f9a303782a97d3"
  }
```

- 返回结果 通过返回的error_code判断是否成功 如失败则查看error_msg获得具体错误信息
- 通过返回的error_code判断是否成功 如失败则查看error_msg获得具体错误信息

```
  {
      "error_code": 0,
      "error_msg": "SUCCESS",
      "log_id": 1234567890123,
      "timestamp": 1533094650,
      "cached": 0,
      "result": null
  }
```

### 复制用户

> 将已经存在于人脸库中的用户复制到一个新的组

- 路径

/face-api/v3/user/copy

- 请求参数

| 参数         | 必选 | 类型   | 说明                                              |
| :----------- | :--- | :----- | :------------------------------------------------ |
| appid        | 是   | string | app标识 （由数字、字母、下划线组成），长度限制48B |
| user_id      | 是   | string | 用户id                                            |
| src_group_id | 是   | string | 从指定group里复制 长度限制48B                     |
| dst_group_id | 是   | string | 需要添加用户的组id 长度限制48B                    |

- 请求示例

```
  {
      "user_id": "user1",
      "src_group_id": "group1",
      "dst_group_id": "group2"
  }
```

- 返回结果 通过返回的error_code判断是否成功 如失败则查看error_msg获得具体错误信息

```
  {
      "error_code": 0,
      "error_msg": "SUCCESS",
      "log_id": 1234567890123,
      "timestamp": 1533094714,
      "cached": 0,
      "result": null
  }
```

### 获取用户信息

> 获取人脸库中某个用户的信息(user_info信息和用户所属的组)

- 路径

/face-api/v3/user/get

- 请求参数

| 参数     | 必选 | 类型   | 说明                                                         |
| :------- | :--- | :----- | :----------------------------------------------------------- |
| appid    | 是   | string | app标识 （由数字、字母、下划线组成），长度限制48B            |
| user_id  | 是   | string | 用户id（由数字、字母、下划线组成），长度限制128B             |
| group_id | 是   | string | 用户组id(由数字、字母、下划线组成，长度限制48B) 如传入**@ALL**则从所有组中查询用户信息 |

- 请求示例

```
  {
      "user_id": "user1",
      "group_id": "group1"
  }
```

- 返回结果

| 字段       | 必选 | 类型   | 说明                     |
| :--------- | :--- | :----- | :----------------------- |
| user_list  | 是   | array  | 用户信息列表             |
| +user_info | 是   | string | 用户注册时携带的用户信息 |
| +group_id  | 是   | string | 用户所属的group_id       |

- 返回示例

```
  {
      "error_code": 0,
      "error_msg": "SUCCESS",
      "log_id": 1234567890123,
      "timestamp": 1533094729,
      "cached": 0,
      "result": {
          "user_list": [
              {
                  "user_info": "user info ...",
                  "group_id": "gid1"
              },
              {
                  "user_info": "user info2 ...",
                  "group_id": "gid2"
              }
          ]
      }
  }
```

### 用户列表

> 获取用户组中的用户列表

- 路径

/face-api/v3/user/list

- 请求参数

| 参数     | 必选 | 类型   | 说明                                              |
| :------- | :--- | :----- | :------------------------------------------------ |
| appid    | 是   | string | app标识 （由数字、字母、下划线组成），长度限制48B |
| group_id | 是   | string | 用户组id                                          |
| start    | 否   | uint32 | 默认值0，起始序号                                 |
| length   | 否   | uint32 | 返回数量，默认值100，最大值1000                   |

- 请求示例

```
  {
   	"group_id": "group1"   
  }
```

- 返回结果

| 字段         | 必选 | 类型  | 说明       |
| :----------- | :--- | :---- | :--------- |
| user_id_list | 是   | array | 用户ID列表 |

- 返回示例

```
  {
      "error_code": 0,
      "error_msg": "SUCCESS",
      "log_id": 1234567890123,
      "timestamp": 1533094739,
      "cached": 0,
      "result": {
          "user_id_list": [
              "uid1",
              "uid2"
          ]
      }
  }
```

### 删除用户

> 将用户从某个组中删除

- 路径

/face-api/v3/user/delete

- 请求参数

| 参数     | 必选 | 类型   | 说明                                                         |
| :------- | :--- | :----- | :----------------------------------------------------------- |
| appid    | 是   | string | app标识 （由数字、字母、下划线组成），长度限制48B            |
| group_id | 是   | string | 用户组id(由数字、字母、下划线组成，长度限制48B) 如传入**@ALL**则从所有组中删除用户 |
| user_id  | 是   | string | 用户id(由数字、字母、下划线组成，长度限制128B)               |

- 请求示例

```
  {
      "user_id": "user1",
      "group_id": "group1"
  }
```

- 返回结果 通过返回的error_code判断是否成功 如失败则查看error_msg获得具体错误信息

```
  {
      "error_code": 0,
      "error_msg": "SUCCESS",
      "log_id": 1234567890123,
      "timestamp": 1533094766,
      "cached": 0,
      "result": null
  }
```

### 创建用户组

> 创建一个空的用户组 **如果用户组已存在 则返回错误**

- 路径

/face-api/v3/group/add

- 请求参数

| 参数     | 必选 | 类型   | 说明                                                |
| :------- | :--- | :----- | :-------------------------------------------------- |
| appid    | 是   | string | app标识 （由数字、字母、下划线组成），长度限制48B   |
| group_id | 是   | string | group标识 （由数字、字母、下划线组成），长度限制48B |

- 请求示例

  ```
  {
      "group_id": "group1"
  }
  ```

- 返回结果 通过返回的error_code判断是否成功 如失败则查看error_msg获得具体错误信息

```
{
    "error_code": 0,
    "error_msg": "SUCCESS",
    "log_id": 1234567890123,
    "timestamp": 1533094781,
    "cached": 0,
    "result": null
}
```

### 删除用户组

> 删除用户组下所有的用户信息及人脸信息 **如果组不存在 则返回错误** 注：使用**删除组接口**前需要先绑定定时脚本

```
#组删除脚本(部署目录如果不是`/home/work`, 记得修改到部署目录下)
*/10 * * * * cd /home/work/odp && ./hhvm/bin/hhvm app/face-api/script/DeleteGroup.php 
```

- 路径

/face-api/v3/group/delete

- 请求参数

| 请求参数 | 必选 | 类型   | 说明                                                |
| :------- | :--- | :----- | :-------------------------------------------------- |
| appid    | 是   | string | app标识 （由数字、字母、下划线组成），长度限制48B   |
| group_id | 是   | string | group标识 （由数字、字母、下划线组成），长度限制48B |

- 返回结果 通过返回的error_code判断是否成功 如失败则查看error_msg获得具体错误信息

  ```
  {
      "error_code": 0,
      "error_msg": "SUCCESS",
      "log_id": 1234567890123,
      "timestamp": 1533094791,
      "cached": 0,
      "result": null
  }
  ```

### 组列表

> 获取人脸库中用户组的列表

- 路径

/v3/group/list

- 请求参数

| 参数   | 必选 | 类型   | 说明                                              |
| :----- | :--- | :----- | :------------------------------------------------ |
| appid  | 是   | string | app标识 （由数字、字母、下划线组成），长度限制48B |
| start  | 否   | uint32 | 默认值0，起始序号                                 |
| length | 否   | uint32 | 返回数量，默认值100，最大值1000                   |

- 请求示例

```
  {
      "start": 0,
      "length": 100
  }
```

- 返回结果

| 字段          | 必选 | 类型  | 说明  |
| :------------ | :--- | :---- | :---- |
| group_id_list | 是   | array | group |

- 返回示例

```
  {
      "error_code": 0,
      "error_msg": "SUCCESS",
      "log_id": 1234567890123,
      "timestamp": 1533094800,
      "cached": 0,
      "result": {
          "group_id_list": [
              "gid1",
              "gid2"
          ]
      }
  }
```

### H5活体检测

> 对输入的视频进行活体检测, 返回活体分数和解析出来的图片信息

- 路径

/face-api/face/liveness

- 请求参数

| 参数         | 必选 | 类型   | 说明                                                         |
| :----------- | :--- | :----- | :----------------------------------------------------------- |
| video_base64 | 否   | string | base64编码后的视频数据 （视频限制：最佳为上传5-15s的mp4文件。 视频编码方式：h264编码； 音频编码格式：aac，pcm均可。） |
| video        | 否   | file   | 视频文件 需要用post multipart/form-data的方式上传            |

> video/video_base64必需选一个传入, 如同时传入时video字段优先

请求示例

```
curl -F "session_id=S59faeeebb9111890355690" -F "video=@test.mp4" http://10.155.236.31:8080/face-api/face/liveness
curl -D "session_id=S59faeeebb9111890355690&video_base64=视频数据的base64值"  http://10.155.236.31:8080/face-api/face/liveness
```

**返回参数**

| 字段                | 必选 | 类型              | 说明                                                         |
| :------------------ | :--- | :---------------- | :----------------------------------------------------------- |
| score               | 是   | float             | 活体检测分数。此分数为视频分析结果， 不包含语音验证结果，语音验证 需开发基于自己的业务需求做判断。 |
| thresholds          | 是   | array             | 阈值参考，实际业务应用中， 请以score>阈值判定通过， 可直接选择不同误识别率的阈值， 无需对应具体的分值， 选择阈值参数即可。 |
| code                | 是   | array             | 语音校验码信息                                               |
| create              | 是   | string            | 生成的校验码                                                 |
| identify            | 是   | string            | 语音识别出来的校验码, 通过`create`和`identify`两个字段的对比， 可以判断上传的视频是否为现成录制。 `create`和`identify`两个字段的对比 逻辑需要开发者基于自身业务逻辑进行判断和开发。 |
| pic_list            | 是   | array             | 抽取图片信息列表                                             |
| pic_list[i].face_id | 是   | string            | face唯一ID                                                   |
| pic_list[i].pic     | 是   | string/encryption | base64编码后的图片信息                                       |

**返回示例**

```
{
	err_no:0,
	err_msg: 'success',
	result: {
		score: 0.984654366,
		thresholds: {
			"frr_1e-4": 0.05, //万分之一误识别率的阈值
			"frr_1e-3": 0.3,  //千分之一误识别率的阈值
			"frr_1e-2": 0.9   //百分之一误识别率的阈值
   		},
   		code: {
     		"create": "5789",
     		"identify": "5789"
   		},
   		pic_list: [
   			{
     			"face_id": 5745745747,
     			"pic": "gsagaheryzxv..."
   			},
   			{
     			"face_id": 5745745747,
     			"pic": "gsagaheryzxv..."
   			}
   		]
 	},
 	"timestamp": 1509611848,
 	"cached": 0,
 	"serverlogid": "2248375729"
}
```

**关于活体检测faceliveness的判断阈值选择，可参考以下数值信息**：

| 拒绝率（TRR） | 误拒率（FRR） | 通过率（TAR） | 阈值（Threshold）    |
| :------------ | :------------ | :------------ | :------------------- |
| 0.90325733    | 0.1%          | 99.9%         | 0.022403             |
| 0.96254072    | 0.5%          | 99.5%         | 0.393241（**推荐**） |
| 0.97557003    | 1%            | 99%           | 0.649192             |
| 0.98990228    | 2%            | 98%           | 0.933801             |
| 0.99446254    | 3%            | 97%           | 0.973637             |
| 0.99641694    | 4%            | 96%           | 0.988479             |
| 0.99739414    | 5%            | 95%           | 0.994058             |

**关于以上数值的概念介绍**：

- **拒绝率（TRR）**：如99%，代表100次作弊假体攻击，会有99次被拒绝。
- **误拒率（FRR）**：如0.5%，指1000次真人请求，会有5次因为活体分数低于阈值被错误拒绝。
- **通过率（TAR）**：如99%，指100次真人请求，会有99次因为活体分数高于阈值而通过。
- **阈值（Threshold）**：高于此数值，则可判断为活体。

## 错误码

| **错误码** | **错误信息**                         | **说明**                         | **处理建议**                                 |
| :--------- | :----------------------------------- | :------------------------------- | :------------------------------------------- |
| 222001     | param[] is null                      | 必要参数未传入                   | 参考API说明文档，修改参数                    |
| 222002     | param[start] format error            | 参数格式错误                     | 参考API说明文档，修改参数                    |
| 222003     | param[length] format error           | 参数格式错误                     | 参考API说明文档，修改参数                    |
| 222004     | param[op_app_id_list] format error   | 参数格式错误                     | 参考API说明文档，修改参数                    |
| 222005     | param[group_id_list] format error    | 参数格式错误                     | 参考API说明文档，修改参数                    |
| 222006     | group_id format error                | 参数格式错误                     | 参考API说明文档，修改参数                    |
| 222007     | uid format error                     | 参数格式错误                     | 参考API说明文档，修改参数                    |
| 222008     | face_id format error                 | 参数格式错误                     | 参考API说明文档，修改参数                    |
| 222009     | quality_conf format error            | 参数格式错误                     | 参考API说明文档，修改参数                    |
| 222010     | user_info format error               | 参数格式错误                     | 参考API说明文档，修改参数                    |
| 222011     | param[uid_list] format error         | 参数格式错误                     | 参考API说明文档，修改参数                    |
| 222012     | param[op_app_id] format error        | 参数格式错误                     | 参考API说明文档，修改参数                    |
| 222013     | param[image] format error            | 参数格式错误                     | 参考API说明文档，修改参数                    |
| 222014     | param[app_id] format error           | 参数格式错误                     | 参考API说明文档，修改参数                    |
| 222015     | param[image_type] format error       | 参数格式错误                     | 参考API说明文档，修改参数                    |
| 222016     | param[max_face_num] format error     | 参数格式错误                     | 参考API说明文档，修改参数                    |
| 222017     | param[face_field] format error       | 参数格式错误                     | 参考API说明文档，修改参数                    |
| 222018     | param[user_id] format error          | 参数格式错误                     | 参考API说明文档，修改参数                    |
| 222019     | param[quality_control] format error  | 参数格式错误                     | 参考API说明文档，修改参数                    |
| 222020     | param[liveness_control] format error | 参数格式错误                     | 参考API说明文档，修改参数                    |
| 222021     | param[max_user_num] format error     | 参数格式错误                     | 参考API说明文档，修改参数                    |
| 222022     | param[id_card_number] format error   | 参数格式错误                     | 参考API说明文档，修改参数                    |
| 222023     | param[name] format error             | 参数格式错误                     | 参考API说明文档，修改参数                    |
| 222024     | param[face_type] format error        | 参数格式错误                     | 参考API说明文档，修改参数                    |
| 222025     | param[face_token] format error       | 参数格式错误                     | 参考API说明文档，修改参数                    |
| 222026     | param[max_star_num] format error     | 参数格式错误                     | 参考API说明文档，修改参数                    |
| 222201     | network not available                | 服务端请求失败                   | 重新尝试                                     |
| 222202     | pic not has face                     | 图片中没有人脸                   | 检查图片质量                                 |
| 222203     | image check fail                     | 无法解析人脸                     | 检查图片质量                                 |
| 222204     | image_url_download_fail              | 从图片的url下载 图片失败         | 请确认url可公网访问                          |
| 222205     | network not availablel               | 服务端请求失败                   | 重新尝试                                     |
| 222206     | rtse service return fail             | 服务端请求失败                   | 重新尝试                                     |
| 222207     | match user is not found              | 未找到匹配的用户                 |                                              |
| 222208     | the number of image is incorrect     | 图片的数量错误                   | 多张图片请使用json格式传输                   |
| 222209     | face token not exist                 | face token不存在                 | 检查face_token                               |
| 222300     | add face fail                        | 人脸图片添加失败                 | 重新尝试                                     |
| 222301     | get face fail                        | 获取人脸图片失败                 |                                              |
| 222302     | system error                         | 服务端请求失败                   | 重新尝试                                     |
| 222303     | get face fail                        | 获取人脸图片失败                 |                                              |
| 223100     | group is not exist                   | 操作的用户组不存在               |                                              |
| 223101     | group is already exist               | 该用户组已存在                   |                                              |
| 223102     | user is already exist                | 该用户已存在                     |                                              |
| 223103     | user is not exist                    | 找不到该用户                     |                                              |
| 223104     | group_list is too large              | group_list包含组 数量过多        |                                              |
| 223105     | face is already exist                | 该人脸已存在                     |                                              |
| 223106     | face is not exist                    | 该人脸不存在                     |                                              |
| 223110     | uid_list is too large                | uid_list包含数量过多             |                                              |
| 223111     | dst group is not exist               | 目标用户组不存在                 |                                              |
| 223112     | quality_conf format error            | quality_conf格式不正确           |                                              |
| 223113     | face is covered                      | 人脸有被遮挡                     | 提示用户请勿遮挡面部                         |
| 223114     | face is fuzzy                        | 人脸模糊                         |                                              |
| 223115     | face light is not good               | 人脸光照不好                     | 提示用户到光线适宜的地方拍摄                 |
| 223116     | incomplete face                      | 人脸不完整                       | 提示用户请勿遮挡面部                         |
| 223117     | app_list is too large                | app_list包含app数量 过多         |                                              |
| 223118     | quality control error                | 质量控制项错误                   |                                              |
| 223119     | liveness control item error          | 活体控制项错误                   |                                              |
| 223120     | liveness check fail                  | 活体检测未通过                   |                                              |
| 223121     | left eye is occlusion                | 质量检测未通过 左眼 遮挡程度过高 | 提示用户请勿遮挡左眼                         |
| 223122     | right eye is occlusion               | 质量检测未通过 右眼 遮挡程度过高 | 提示用户请勿遮挡右眼                         |
| 223123     | left cheek is occlusion              | 质量检测未通过 左脸 遮挡程度过高 | 提示用户请勿遮挡左脸颊                       |
| 223124     | right cheek is occlusion             | 质量检测未通过 右脸 遮挡程度过高 | 提示用户请勿遮挡右脸颊                       |
| 223125     | chin contour is occlusion            | 质量检测未通过 下巴遮挡程度过高  | 提示用户请勿遮挡下巴                         |
| 223126     | nose is occlusion                    | 质量检测未通过 鼻子遮挡程度过高  | 提示用户请勿遮挡鼻子                         |
| 223127     | mouth is occlusion                   | 质量检测未通过 嘴巴 遮挡程度过高 | 提示用户请勿遮挡嘴巴                         |
| 222901     | system busy                          | 系统繁忙                         | 请重新尝试， 若尝试多次无效， 请提交工单咨询 |
| 222902     | system busy                          | 系统繁忙                         | 请重新尝试， 若尝试多次无效， 请提交工单咨询 |
| 222903     | system busy                          | 系统繁忙                         | 请重新尝试， 若尝试多次无效， 请提交工单咨询 |
| 222904     | system busy                          | 系统繁忙                         | 请重新尝试， 若尝试多次无效， 请提交工单咨询 |
| 222905     | system busy                          | 系统繁忙                         | 请重新尝试， 若尝试多次无效， 请提交工单咨询 |
| 222906     | system busy                          | 系统繁忙                         | 请重新尝试， 若尝试多次无效， 请提交工单咨询 |
| 222907     | system busy                          | 系统繁忙                         | 请重新尝试， 若尝试多次无效， 请提交工单咨询 |
| 222908     | system busy                          | 系统繁忙                         | 请重新尝试， 若尝试多次无效， 请提交工单咨询 |
| 222909     | system busy                          | 系统繁忙                         | 请重新尝试， 若尝试多次无效， 请提交工单咨询 |
| 222910     | system busy                          | 系统繁忙                         | 请重新尝试， 若尝试多次无效， 请提交工单咨询 |
| 222911     | system busy                          | 系统繁忙                         | 请重新尝试， 若尝试多次无效， 请提交工单咨询 |
| 222912     | system busy                          | 系统繁忙                         | 请重新尝试， 若尝试多次无效， 请提交工单咨询 |
| 222913     | system busy                          | 系统繁忙                         | 请重新尝试， 若尝试多次无效， 请提交工单咨询 |
| 222914     | system busy                          | 系统繁忙                         | 请重新尝试， 若尝试多次无效， 请提交工单咨询 |
| 222915     | system busy                          | 系统繁忙                         | 请重新尝试， 若尝试多次无效， 请提交工单咨询 |
| 222916     | system busy                          | 系统繁忙                         | 请重新尝试， 若尝试多次无效， 请提交工单咨询 |
| 222304     | image size is too large              | 图片尺寸太大                     | 请确保图片尺寸在1920x1080以下下              |
| 223128     | group was deleting                   | 正在清理该用户组的数据           | 请等该用户组清理完毕后再对该组进行操作       |
| 222361     | system busy                          | 系统繁忙                         | 请重新尝试， 若尝试多次无效， 请提交工单咨询 |





