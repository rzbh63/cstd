
# Kubernetes安装系列之ETCD安装 - 知行合一 止于至善 - CSDN博客

2019年03月23日 14:39:36[liumiaocn](https://me.csdn.net/liumiaocn)阅读数：234所属专栏：[深入浅出kubernetes](https://blog.csdn.net/column/details/12761.html)



这篇文章整理以下ETCD的安装与设定方法，本文以脚本的方式进行固化，内容仍然放在github的easypack上。
# 整体操作
[https://blog.csdn.net/liumiaocn/article/details/88413428](https://blog.csdn.net/liumiaocn/article/details/88413428)
# ETCD设定文件
```python
[
```
```python
root@host131 ~
```
```python
]
```
```python
# cat /etc/etcd/etcd.conf
```
```python
#[ETCD Member Settings]
```
```python
ETCD_NAME
```
```python
=
```
```python
"etcd-01"
```
```python
ETCD_DATA_DIR
```
```python
=
```
```python
"/var/lib/etcd//default.etcd"
```
```python
ETCD_LISTEN_PEER_URLS
```
```python
=
```
```python
"https://192.168.163.131:2380"
```
```python
ETCD_LISTEN_CLIENT_URLS
```
```python
=
```
```python
"https://192.168.163.131:2379"
```
```python
#[ETCD Clustering Settings]
```
```python
ETCD_INITIAL_ADVERTISE_PEER_URLS
```
```python
=
```
```python
"https://192.168.163.131:2380"
```
```python
ETCD_ADVERTISE_CLIENT_URLS
```
```python
=
```
```python
"https://192.168.163.131:2379"
```
```python
ETCD_INITIAL_CLUSTER
```
```python
=
```
```python
"etcd-01=https://192.168.163.131:2380"
```
```python
ETCD_INITIAL_CLUSTER_TOKEN
```
```python
=
```
```python
"etcd-cluster"
```
```python
ETCD_INITIAL_CLUSTER_STATE
```
```python
=
```
```python
"new"
```
```python
#[ETCD TLS Certificate Settings]
```
```python
ETCD_CERT_FILE
```
```python
=
```
```python
"/etc/ssl/etcd/cert-etcd.pem"
```
```python
ETCD_KEY_FILE
```
```python
=
```
```python
"/etc/ssl/etcd/cert-etcd-key.pem"
```
```python
ETCD_PEER_CERT_FILE
```
```python
=
```
```python
"/etc/ssl/etcd/cert-etcd.pem"
```
```python
ETCD_PEER_KEY_FILE
```
```python
=
```
```python
"/etc/ssl/etcd/cert-etcd-key.pem"
```
```python
ETCD_TRUSTED_CA_FILE
```
```python
=
```
```python
"/etc/ssl/ca/ca.pem"
```
```python
ETCD_PEER_TRUSTED_CA_FILE
```
```python
=
```
```python
"/etc/ssl/ca/ca.pem"
```
```python
#[ETCD Other Settings]
```
```python
ETCD_LOCALHOST_CLIENT
```
```python
=
```
```python
"http://127.0.0.1:2379"
```
```python
[
```
```python
root@host131 ~
```
```python
]
```
```python
#
```
# Systemd服务配置文件
```python
[
```
```python
root@host131 ~
```
```python
]
```
```python
# cat /usr/lib/systemd/system/etcd.service
```
```python
[
```
```python
Unit
```
```python
]
```
```python
Description
```
```python
=
```
```python
Etcd Server
After
```
```python
=
```
```python
network.target
After
```
```python
=
```
```python
network-online.target
Wants
```
```python
=
```
```python
network-online.target
Documentation
```
```python
=
```
```python
https://github.com/coreos
```
```python
[
```
```python
Service
```
```python
]
```
```python
Type
```
```python
=
```
```python
notify
EnvironmentFile
```
```python
=
```
```python
-/etc/etcd/etcd.conf
WorkingDirectory
```
```python
=
```
```python
/var/lib/etcd/
ExecStart
```
```python
=
```
```python
/usr/local/bin/etcd \
--name
```
```python
=
```
```python
${ETCD_NAME}
```
```python
\
--data-dir
```
```python
=
```
```python
${ETCD_DATA_DIR}
```
```python
\
--listen-peer-urls
```
```python
=
```
```python
${ETCD_LISTEN_PEER_URLS}
```
```python
\
--listen-client-urls
```
```python
=
```
```python
${ETCD_LISTEN_CLIENT_URLS}
```
```python
,
```
```python
${ETCD_LOCALHOST_CLIENT}
```
```python
\
--advertise-client-urls
```
```python
=
```
```python
${ETCD_ADVERTISE_CLIENT_URLS}
```
```python
\
--initial-advertise-peer-urls
```
```python
=
```
```python
${ETCD_INITIAL_ADVERTISE_PEER_URLS}
```
```python
\
--initial-cluster
```
```python
=
```
```python
${ETCD_INITIAL_CLUSTER}
```
```python
\
--initial-cluster-token
```
```python
=
```
```python
${ETCD_INITIAL_CLUSTER_TOKEN}
```
```python
\
--initial-cluster-state
```
```python
=
```
```python
new \
--cert-file
```
```python
=
```
```python
${ETCD_CERT_FILE}
```
```python
\
--key-file
```
```python
=
```
```python
${ETCD_KEY_FILE}
```
```python
\
--peer-cert-file
```
```python
=
```
```python
${ETCD_PEER_CERT_FILE}
```
```python
\
--peer-key-file
```
```python
=
```
```python
${ETCD_PEER_KEY_FILE}
```
```python
\
--trusted-ca-file
```
```python
=
```
```python
${ETCD_TRUSTED_CA_FILE}
```
```python
\
--peer-trusted-ca-file
```
```python
=
```
```python
${ETCD_PEER_TRUSTED_CA_FILE}
```
```python
Restart
```
```python
=
```
```python
on-failure
LimitNOFILE
```
```python
=
```
```python
65536
```
```python
[
```
```python
Install
```
```python
]
```
```python
WantedBy
```
```python
=
```
```python
multi-user.target
```
```python
[
```
```python
root@host131 ~
```
```python
]
```
```python
#
```
# 脚本示例
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
# cat step2-install-etcd.sh
```
```python
#!/bin/sh
```
```python
.
```
```python
./install.cfg
```
```python
echo
```
```python
-e
```
```python
"\n##  stop etcd service"
```
```python
systemctl stop etcd 2
```
```python
>
```
```python
/dev/null
```
```python
echo
```
```python
"## are you sure to delete
```
```python
${ENV_ETCD_DATA_DIR}
```
```python
with all files in it ? "
```
```python
read
```
```python
answers
```
```python
if
```
```python
[
```
```python
_
```
```python
"
```
```python
${answers}
```
```python
"
```
```python
=
```
```python
_
```
```python
"y"
```
```python
-o _
```
```python
"
```
```python
${answers}
```
```python
"
```
```python
=
```
```python
_
```
```python
"Y"
```
```python
]
```
```python
;
```
```python
then
```
```python
rm
```
```python
-rf
```
```python
"
```
```python
${ENV_ETCD_DATA_DIR}
```
```python
/default.etcd"
```
```python
fi
```
```python
mkdir
```
```python
-p
```
```python
${ENV_ETCD_DIR_BIN}
```
```python
chmod
```
```python
755
```
```python
${ENV_HOME_ETCD}
```
```python
/etc*
```
```python
cp
```
```python
-p
```
```python
${ENV_HOME_ETCD}
```
```python
/etc*
```
```python
${ENV_ETCD_DIR_BIN}
```
```python
if
```
```python
[
```
```python
$?
```
```python
-ne 0
```
```python
]
```
```python
;
```
```python
then
```
```python
echo
```
```python
"please check etcd binary files existed in
```
```python
${ENV_HOME_ETCD}
```
```python
/ or not"
```
```python
exit
```
```python
fi
```
```python
# create etcd config dir when needed
```
```python
mkdir
```
```python
-p
```
```python
`
```
```python
dirname
```
```python
$
```
```python
{
```
```python
ENV_ETCD_CONF
```
```python
}
```
```python
`
```
```python
# The etcd configuration file.
```
```python
cat
```
```python
<<
```
```python
EOF
```
```python
>
```
```python
${ENV_ETCD_CONF}
```
```python
#[ETCD Member Settings]
```
```python
ETCD_NAME
```
```python
=
```
```python
"
```
```python
${ENV_ETCD_CURRENT_NAME}
```
```python
"
```
```python
ETCD_DATA_DIR
```
```python
=
```
```python
"
```
```python
${ENV_ETCD_DATA_DIR}
```
```python
/default.etcd"
```
```python
ETCD_LISTEN_PEER_URLS
```
```python
=
```
```python
"https://
```
```python
${ENV_CURRENT_HOSTIP}
```
```python
:
```
```python
${ENV_ETCD_PEER_PORT}
```
```python
"
```
```python
ETCD_LISTEN_CLIENT_URLS
```
```python
=
```
```python
"https://
```
```python
${ENV_CURRENT_HOSTIP}
```
```python
:
```
```python
${ENV_ETCD_CLIENT_PORT}
```
```python
"
```
```python
#[ETCD Clustering Settings]
```
```python
ETCD_INITIAL_ADVERTISE_PEER_URLS
```
```python
=
```
```python
"https://
```
```python
${ENV_CURRENT_HOSTIP}
```
```python
:
```
```python
${ENV_ETCD_PEER_PORT}
```
```python
"
```
```python
ETCD_ADVERTISE_CLIENT_URLS
```
```python
=
```
```python
"https://
```
```python
${ENV_CURRENT_HOSTIP}
```
```python
:
```
```python
${ENV_ETCD_CLIENT_PORT}
```
```python
"
```
```python
EOF
```
```python
echo
```
```python
${ENV_ETCD_HOSTS}
```
```python
|
```
```python
awk
```
```python
-v etcd_names
```
```python
=
```
```python
"
```
```python
${ENV_ETCD_NAMES}
```
```python
"
```
```python
\
-v port
```
```python
=
```
```python
${ENV_ETCD_PEER_PORT}
```
```python
-F
```
```python
" "
```
```python
'BEGIN{
    split(etcd_names,names);
    printf("ETCD_INITIAL_CLUSTER=\"");
}
{
    for(cnt=1; cnt<NF; cnt++){
        printf("%s=https://%s:%s,",names[cnt],
```
```python
$cnt
```
```python
,port);
    }
    printf("%s=https://%s:%s\"\n",names[cnt],
```
```python
$cnt
```
```python
,port);
}'
```
```python
>>
```
```python
${ENV_ETCD_CONF}
```
```python
cat
```
```python
<<
```
```python
EOF
```
```python
>>
```
```python
${ENV_ETCD_CONF}
```
```python
ETCD_INITIAL_CLUSTER_TOKEN
```
```python
=
```
```python
"
```
```python
${ENV_ETCD_INITIAL_CLUSTER_TOKEN}
```
```python
"
```
```python
ETCD_INITIAL_CLUSTER_STATE
```
```python
=
```
```python
"
```
```python
${ENV_ETCD_INITIAL_CLUSTER_STATE}
```
```python
"
```
```python
#[ETCD TLS Certificate Settings]
```
```python
ETCD_CERT_FILE
```
```python
=
```
```python
"
```
```python
${ENV_SSL_ETCD_DIR}
```
```python
/
```
```python
${ENV_SSL_ETCD_CERT_PRIFIX}
```
```python
.pem"
```
```python
ETCD_KEY_FILE
```
```python
=
```
```python
"
```
```python
${ENV_SSL_ETCD_DIR}
```
```python
/
```
```python
${ENV_SSL_ETCD_CERT_PRIFIX}
```
```python
-key.pem"
```
```python
ETCD_PEER_CERT_FILE
```
```python
=
```
```python
"
```
```python
${ENV_SSL_ETCD_DIR}
```
```python
/
```
```python
${ENV_SSL_ETCD_CERT_PRIFIX}
```
```python
.pem"
```
```python
ETCD_PEER_KEY_FILE
```
```python
=
```
```python
"
```
```python
${ENV_SSL_ETCD_DIR}
```
```python
/
```
```python
${ENV_SSL_ETCD_CERT_PRIFIX}
```
```python
-key.pem"
```
```python
ETCD_TRUSTED_CA_FILE
```
```python
=
```
```python
"
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_CA_PEM}
```
```python
"
```
```python
ETCD_PEER_TRUSTED_CA_FILE
```
```python
=
```
```python
"
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_CA_PEM}
```
```python
"
```
```python
#[ETCD Other Settings]
```
```python
ETCD_LOCALHOST_CLIENT
```
```python
=
```
```python
"
```
```python
${ENV_ETCD_LOCALHOST_CLIENT}
```
```python
"
```
```python
EOF
```
```python
mkdir
```
```python
-p
```
```python
${ENV_ETCD_DATA_DIR}
```
```python
# The etcd servcie configuration file.
```
```python
cat
```
```python
<<
```
```python
EOF
```
```python
>
```
```python
${ENV_ETCD_SERVICE}
```
```python
[
```
```python
Unit
```
```python
]
```
```python
Description
```
```python
=
```
```python
Etcd Server
After
```
```python
=
```
```python
network.target
After
```
```python
=
```
```python
network-online.target
Wants
```
```python
=
```
```python
network-online.target
Documentation
```
```python
=
```
```python
https://github.com/coreos
```
```python
[
```
```python
Service
```
```python
]
```
```python
Type
```
```python
=
```
```python
notify
EnvironmentFile
```
```python
=
```
```python
-
```
```python
${ENV_ETCD_CONF}
```
```python
WorkingDirectory
```
```python
=
```
```python
${ENV_ETCD_DATA_DIR}
```
```python
ExecStart
```
```python
=
```
```python
${ENV_ETCD_DIR_BIN}
```
```python
/etcd \\
EOF
```
```python
cat
```
```python
<<
```
```python
"EOF"
```
```python
>>
```
```python
${ENV_ETCD_SERVICE}
```
```python
--name
```
```python
=
```
```python
${ETCD_NAME}
```
```python
\
--data-dir
```
```python
=
```
```python
${ETCD_DATA_DIR}
```
```python
\
--listen-peer-urls
```
```python
=
```
```python
${ETCD_LISTEN_PEER_URLS}
```
```python
\
--listen-client-urls
```
```python
=
```
```python
${ETCD_LISTEN_CLIENT_URLS}
```
```python
,
```
```python
${ETCD_LOCALHOST_CLIENT}
```
```python
\
--advertise-client-urls
```
```python
=
```
```python
${ETCD_ADVERTISE_CLIENT_URLS}
```
```python
\
--initial-advertise-peer-urls
```
```python
=
```
```python
${ETCD_INITIAL_ADVERTISE_PEER_URLS}
```
```python
\
--initial-cluster
```
```python
=
```
```python
${ETCD_INITIAL_CLUSTER}
```
```python
\
--initial-cluster-token
```
```python
=
```
```python
${ETCD_INITIAL_CLUSTER_TOKEN}
```
```python
\
--initial-cluster-state
```
```python
=
```
```python
new \
--cert-file
```
```python
=
```
```python
${ETCD_CERT_FILE}
```
```python
\
--key-file
```
```python
=
```
```python
${ETCD_KEY_FILE}
```
```python
\
--peer-cert-file
```
```python
=
```
```python
${ETCD_PEER_CERT_FILE}
```
```python
\
--peer-key-file
```
```python
=
```
```python
${ETCD_PEER_KEY_FILE}
```
```python
\
--trusted-ca-file
```
```python
=
```
```python
${ETCD_TRUSTED_CA_FILE}
```
```python
\
--peer-trusted-ca-file
```
```python
=
```
```python
${ETCD_PEER_TRUSTED_CA_FILE}
```
```python
Restart
```
```python
=
```
```python
on-failure
LimitNOFILE
```
```python
=
```
```python
65536
```
```python
[
```
```python
Install
```
```python
]
```
```python
WantedBy
```
```python
=
```
```python
multi-user.target
EOF
```
```python
echo
```
```python
-e
```
```python
"\n##  daemon reload service "
```
```python
systemctl daemon-reload
```
```python
echo
```
```python
-e
```
```python
"\n##  start etcd service "
```
```python
systemctl start etcd
```
```python
echo
```
```python
-e
```
```python
"\n##  enable etcd service "
```
```python
systemctl
```
```python
enable
```
```python
etcd
```
```python
echo
```
```python
-e
```
```python
"\n##  check  etcd status"
```
```python
systemctl status etcd
```
```python
echo
```
```python
-e
```
```python
"\n##  etcd version"
```
```python
etcd --version
```
```python
echo
```
```python
-e
```
```python
"\n##  etcd cluster health"
```
```python
export
```
```python
ETCDCTL_API
```
```python
=
```
```python
3
```
```python
for
```
```python
etcd_member
```
```python
in
```
```python
${ENV_ETCD_HOSTS}
```
```python
do
```
```python
etcdctl --endpoints
```
```python
=
```
```python
https://
```
```python
${etcd_member}
```
```python
:2379 --cacert
```
```python
=
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_CA_PEM}
```
```python
--cert
```
```python
=
```
```python
${ENV_SSL_ETCD_DIR}
```
```python
/
```
```python
${ENV_SSL_ETCD_CERT_PRIFIX}
```
```python
.pem --key
```
```python
=
```
```python
${ENV_SSL_ETCD_DIR}
```
```python
/
```
```python
${ENV_SSL_ETCD_CERT_PRIFIX}
```
```python
-key.pem endpoint health
```
```python
done
```
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
#
```
# 执行示例
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
# sh step2-install-etcd.sh
```
```python
##  stop etcd service
```
```python
## are you sure to delete /var/lib/etcd/ with all files in it ?
```
```python
y
```
```python
##  daemon reload service
```
```python
##  start etcd service
```
```python
##  enable etcd service
```
```python
##  check  etcd status
```
```python
● etcd.service - Etcd Server
   Loaded: loaded
```
```python
(
```
```python
/usr/lib/systemd/system/etcd.service
```
```python
;
```
```python
enabled
```
```python
;
```
```python
vendor preset: disabled
```
```python
)
```
```python
Active: active
```
```python
(
```
```python
running
```
```python
)
```
```python
since Sat 2019-03-23 12:06:36 CST
```
```python
;
```
```python
164ms ago
     Docs: https://github.com/coreos
 Main PID: 8451
```
```python
(
```
```python
etcd
```
```python
)
```
```python
CGroup: /system.slice/etcd.service
           └─8451 /usr/local/bin/etcd --name
```
```python
=
```
```python
etcd-01 --data-dir
```
```python
=
```
```python
/var/lib/etcd//default.etcd --listen-peer-urls
```
```python
=
```
```python
https://192.168.163.13
```
```python
..
```
```python
.
Mar 23 12:06:36 host131 etcd
```
```python
[
```
```python
8451
```
```python
]
```
```python
: raft.node: 4d54a02094212b0 elected leader 4d54a02094212b0 at term 2
Mar 23 12:06:36 host131 etcd
```
```python
[
```
```python
8451
```
```python
]
```
```python
: setting up the initial cluster version to 3.3
Mar 23 12:06:36 host131 etcd
```
```python
[
```
```python
8451
```
```python
]
```
```python
: published
```
```python
{
```
```python
Name:etcd-01 ClientURLs:
```
```python
[
```
```python
https://192.168.163.131:2379
```
```python
]
```
```python
}
```
```python
to cluster cbd0f7b15d201540
Mar 23 12:06:36 host131 etcd
```
```python
[
```
```python
8451
```
```python
]
```
```python
: ready to serve client requests
Mar 23 12:06:36 host131 etcd
```
```python
[
```
```python
8451
```
```python
]
```
```python
: serving insecure client requests on 127.0.0.1:2379, this is strongly discouraged
```
```python
!
```
```python
Mar 23 12:06:36 host131 etcd
```
```python
[
```
```python
8451
```
```python
]
```
```python
: ready to serve client requests
Mar 23 12:06:36 host131 etcd
```
```python
[
```
```python
8451
```
```python
]
```
```python
: serving client requests on 192.168.163.131:2379
Mar 23 12:06:36 host131 systemd
```
```python
[
```
```python
1
```
```python
]
```
```python
: Started Etcd Server.
Mar 23 12:06:36 host131 etcd
```
```python
[
```
```python
8451
```
```python
]
```
```python
:
```
```python
set
```
```python
the initial cluster version to 3.3
Mar 23 12:06:36 host131 etcd
```
```python
[
```
```python
8451
```
```python
]
```
```python
: enabled capabilities
```
```python
for
```
```python
version 3.3
```
```python
##  etcd version
```
```python
etcd Version: 3.3.12
Git SHA: d57e8b8
Go Version: go1.10.8
Go OS/Arch: linux/amd64
```
```python
##  etcd cluster health
```
```python
https://192.168.163.131:2379 is healthy: successfully committed proposal: took
```
```python
=
```
```python
1.290479ms
```
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
#
```
这样以HTTPS方式启动的ETCD服务就就绪了，接下来就可以设定和配置K8S的Master节点的APIServer服务了。
# 参考文章
[https://github.com/etcd-io/etcd/blob/master/Documentation/op-guide/configuration.md](https://github.com/etcd-io/etcd/blob/master/Documentation/op-guide/configuration.md)

