
# Python和PyTorch对比实现dropout函数及反向传播 - BrightLamp的博客 - CSDN博客


2018年11月21日 17:02:39[BrightLampCsdn](https://me.csdn.net/oBrightLamp)阅读数：169所属专栏：



## 摘要
本文使用纯 Python 和 PyTorch 对比 dropout 函数及其反向传播.
## 相关
*原理和详细解释, 请参考文章 :*
dropout函数详解及反向传播中的梯度求导
*系列文章索引 :*
[https://blog.csdn.net/oBrightLamp/article/details/85067981](https://blog.csdn.net/oBrightLamp/article/details/85067981)
## 正文
```python
import
```
```python
torch
```
```python
import
```
```python
numpy
```
```python
as
```
```python
np
```
```python
class
```
```python
Dropout
```
```python
:
```
```python
"""
    http://arxiv.org/abs/1207.0580
    """
```
```python
def
```
```python
__init__
```
```python
(
```
```python
self
```
```python
,
```
```python
dropout_ratio
```
```python
=
```
```python
0.5
```
```python
)
```
```python
:
```
```python
self
```
```python
.
```
```python
dropout_ratio
```
```python
=
```
```python
dropout_ratio
        self
```
```python
.
```
```python
train_flg
```
```python
=
```
```python
True
```
```python
self
```
```python
.
```
```python
mask
```
```python
=
```
```python
None
```
```python
def
```
```python
__call__
```
```python
(
```
```python
self
```
```python
,
```
```python
x
```
```python
,
```
```python
manual_mask
```
```python
=
```
```python
None
```
```python
,
```
```python
train_flg
```
```python
=
```
```python
True
```
```python
)
```
```python
:
```
```python
if
```
```python
train_flg
```
```python
:
```
```python
if
```
```python
manual_mask
```
```python
is
```
```python
None
```
```python
:
```
```python
self
```
```python
.
```
```python
mask
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
rand
```
```python
(
```
```python
*
```
```python
x
```
```python
.
```
```python
shape
```
```python
)
```
```python
>
```
```python
self
```
```python
.
```
```python
dropout_ratio
```
```python
else
```
```python
:
```
```python
self
```
```python
.
```
```python
mask
```
```python
=
```
```python
manual_mask
            out
```
```python
=
```
```python
x
```
```python
*
```
```python
self
```
```python
.
```
```python
mask
```
```python
/
```
```python
(
```
```python
1.0
```
```python
-
```
```python
self
```
```python
.
```
```python
dropout_ratio
```
```python
)
```
```python
return
```
```python
out
```
```python
else
```
```python
:
```
```python
return
```
```python
x
```
```python
def
```
```python
backward
```
```python
(
```
```python
self
```
```python
,
```
```python
d_loss
```
```python
)
```
```python
:
```
```python
dx
```
```python
=
```
```python
d_loss
```
```python
*
```
```python
self
```
```python
.
```
```python
mask
```
```python
/
```
```python
(
```
```python
1.0
```
```python
-
```
```python
self
```
```python
.
```
```python
dropout_ratio
```
```python
)
```
```python
return
```
```python
dx

np
```
```python
.
```
```python
set_printoptions
```
```python
(
```
```python
precision
```
```python
=
```
```python
6
```
```python
,
```
```python
suppress
```
```python
=
```
```python
True
```
```python
,
```
```python
linewidth
```
```python
=
```
```python
120
```
```python
)
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
seed
```
```python
(
```
```python
12
```
```python
)
```
```python
torch
```
```python
.
```
```python
random
```
```python
.
```
```python
manual_seed
```
```python
(
```
```python
3
```
```python
)
```
```python
x_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
3
```
```python
,
```
```python
7
```
```python
)
```
```python
)
```
```python
x_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
x_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
drop_out_numpy
```
```python
=
```
```python
Dropout
```
```python
(
```
```python
dropout_ratio
```
```python
=
```
```python
0.45
```
```python
)
```
```python
drop_out_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
nn
```
```python
.
```
```python
Dropout
```
```python
(
```
```python
p
```
```python
=
```
```python
0.45
```
```python
)
```
```python
print
```
```python
(
```
```python
"\n----- 训练阶段 -----"
```
```python
)
```
```python
train_flag
```
```python
=
```
```python
True
```
```python
drop_out_tensor
```
```python
.
```
```python
train
```
```python
(
```
```python
)
```
```python
out_tensor
```
```python
=
```
```python
drop_out_tensor
```
```python
(
```
```python
x_tensor
```
```python
)
```
```python
mask
```
```python
=
```
```python
out_tensor
```
```python
>
```
```python
0
```
```python
mask
```
```python
=
```
```python
mask
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
out_numpy
```
```python
=
```
```python
drop_out_numpy
```
```python
(
```
```python
x_numpy
```
```python
,
```
```python
mask
```
```python
,
```
```python
train_flg
```
```python
=
```
```python
train_flag
```
```python
)
```
```python
print
```
```python
(
```
```python
"train mask : \n"
```
```python
,
```
```python
mask
```
```python
)
```
```python
print
```
```python
(
```
```python
"train x : \n"
```
```python
,
```
```python
x_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
"numpy out : \n"
```
```python
,
```
```python
out_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
"tensor out : \n"
```
```python
,
```
```python
out_tensor
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"\n----- 反向传播 -----"
```
```python
)
```
```python
d_loss_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
3
```
```python
,
```
```python
7
```
```python
)
```
```python
)
```
```python
d_loss_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
d_loss_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
dx_numpy
```
```python
=
```
```python
drop_out_numpy
```
```python
.
```
```python
backward
```
```python
(
```
```python
d_loss_numpy
```
```python
)
```
```python
out_tensor
```
```python
.
```
```python
backward
```
```python
(
```
```python
d_loss_tensor
```
```python
)
```
```python
dx_tensor
```
```python
=
```
```python
x_tensor
```
```python
.
```
```python
grad
```
```python
print
```
```python
(
```
```python
"dx_numpy : \n"
```
```python
,
```
```python
dx_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
"dx_tensor : \n"
```
```python
,
```
```python
dx_tensor
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"\n----- 测试阶段 -----"
```
```python
)
```
```python
train_flag
```
```python
=
```
```python
False
```
```python
drop_out_tensor
```
```python
.
```
```python
eval
```
```python
(
```
```python
)
```
```python
out_tensor
```
```python
=
```
```python
drop_out_tensor
```
```python
(
```
```python
x_tensor
```
```python
)
```
```python
mask
```
```python
=
```
```python
out_tensor
```
```python
>
```
```python
0
```
```python
mask
```
```python
=
```
```python
mask
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
out_numpy
```
```python
=
```
```python
drop_out_numpy
```
```python
(
```
```python
x_numpy
```
```python
,
```
```python
mask
```
```python
,
```
```python
train_flg
```
```python
=
```
```python
train_flag
```
```python
)
```
```python
print
```
```python
(
```
```python
"test mask : \n"
```
```python
,
```
```python
mask
```
```python
)
```
```python
print
```
```python
(
```
```python
"test x : \n"
```
```python
,
```
```python
x_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
"numpy out : \n"
```
```python
,
```
```python
out_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
"tensor out : \n"
```
```python
,
```
```python
out_tensor
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
"""
代码输出 :
----- 训练阶段 -----
train mask : 
 [[1 0 1 0 1 0 0]
 [0 0 1 1 1 0 1]
 [1 1 0 0 0 1 0]]
train x : 
 [[ 0.154163  0.74005   0.263315  0.533739  0.014575  0.918747  0.900715]
 [ 0.033421  0.956949  0.137209  0.283828  0.606083  0.944225  0.852736]
 [ 0.002259  0.521226  0.552038  0.485377  0.768134  0.160717  0.76456 ]]
numpy out : 
 [[ 0.280296  0.        0.478755  0.        0.0265    0.        0.      ]
 [ 0.        0.        0.249471  0.516052  1.101969  0.        1.550428]
 [ 0.004108  0.947684  0.        0.        0.        0.292212  0.      ]]
tensor out : 
 [[ 0.280296  0.        0.478755  0.        0.0265    0.        0.      ]
 [ 0.        0.        0.249471  0.516052  1.101969  0.        1.550428]
 [ 0.004108  0.947684  0.        0.        0.        0.292212  0.      ]]
----- 反向传播 -----
dx_numpy : 
 [[ 0.037836  0.        0.211405  0.        1.220823  0.        0.      ]
 [ 0.        0.        1.277495  0.595581  0.60845   0.        1.135604]
 [ 1.727843  1.39541   0.        0.        0.        0.728421  0.      ]]
dx_tensor : 
 [[ 0.037836  0.        0.211405  0.        1.220823  0.        0.      ]
 [ 0.        0.        1.277495  0.595581  0.60845   0.        1.135604]
 [ 1.727843  1.39541   0.        0.        0.        0.728421  0.      ]]
----- 测试阶段 -----
test mask : 
 [[1 1 1 1 1 1 1]
 [1 1 1 1 1 1 1]
 [1 1 1 1 1 1 1]]
test x : 
 [[ 0.154163  0.74005   0.263315  0.533739  0.014575  0.918747  0.900715]
 [ 0.033421  0.956949  0.137209  0.283828  0.606083  0.944225  0.852736]
 [ 0.002259  0.521226  0.552038  0.485377  0.768134  0.160717  0.76456 ]]
numpy out : 
 [[ 0.154163  0.74005   0.263315  0.533739  0.014575  0.918747  0.900715]
 [ 0.033421  0.956949  0.137209  0.283828  0.606083  0.944225  0.852736]
 [ 0.002259  0.521226  0.552038  0.485377  0.768134  0.160717  0.76456 ]]
tensor out : 
 [[ 0.154163  0.74005   0.263315  0.533739  0.014575  0.918747  0.900715]
 [ 0.033421  0.956949  0.137209  0.283828  0.606083  0.944225  0.852736]
 [ 0.002259  0.521226  0.552038  0.485377  0.768134  0.160717  0.76456 ]]
"""
```

