
# Python和PyTorch对比实现affine-linear(仿射-线性)变换函数及全连接层的反向传播 - BrightLamp的博客 - CSDN博客


2018年11月24日 22:04:58[BrightLampCsdn](https://me.csdn.net/oBrightLamp)阅读数：139所属专栏：



## 摘要
本文使用纯 Python 和 PyTorch 对比实现affine/linear(仿射/线性)变换函数及其反向传播.
## 相关
*原理和详细解释, 请参考文章 :*
affine/linear(仿射/线性)变换函数详解及全连接层反向传播的梯度求导
*系列文章索引 :*
[https://blog.csdn.net/oBrightLamp/article/details/85067981](https://blog.csdn.net/oBrightLamp/article/details/85067981)
## 正文
```python
import
```
```python
torch
```
```python
import
```
```python
numpy
```
```python
as
```
```python
np
```
```python
class
```
```python
Affine
```
```python
:
```
```python
def
```
```python
__init__
```
```python
(
```
```python
self
```
```python
)
```
```python
:
```
```python
self
```
```python
.
```
```python
x
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
weight
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
bias
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
dx
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
dw
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
db
```
```python
=
```
```python
None
```
```python
def
```
```python
__call__
```
```python
(
```
```python
self
```
```python
,
```
```python
x
```
```python
)
```
```python
:
```
```python
self
```
```python
.
```
```python
x
```
```python
=
```
```python
x
        out
```
```python
=
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
self
```
```python
.
```
```python
x
```
```python
,
```
```python
self
```
```python
.
```
```python
weight
```
```python
.
```
```python
T
```
```python
)
```
```python
+
```
```python
self
```
```python
.
```
```python
bias
```
```python
return
```
```python
out
```
```python
def
```
```python
backward
```
```python
(
```
```python
self
```
```python
,
```
```python
d_loss
```
```python
)
```
```python
:
```
```python
self
```
```python
.
```
```python
dx
```
```python
=
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
d_loss
```
```python
,
```
```python
self
```
```python
.
```
```python
weight
```
```python
)
```
```python
self
```
```python
.
```
```python
dw
```
```python
=
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
d_loss
```
```python
.
```
```python
T
```
```python
,
```
```python
self
```
```python
.
```
```python
x
```
```python
)
```
```python
self
```
```python
.
```
```python
db
```
```python
=
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
d_loss
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
return
```
```python
self
```
```python
.
```
```python
dx

np
```
```python
.
```
```python
random
```
```python
.
```
```python
seed
```
```python
(
```
```python
123
```
```python
)
```
```python
np
```
```python
.
```
```python
set_printoptions
```
```python
(
```
```python
precision
```
```python
=
```
```python
6
```
```python
,
```
```python
suppress
```
```python
=
```
```python
True
```
```python
,
```
```python
linewidth
```
```python
=
```
```python
120
```
```python
)
```
```python
x_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
3
```
```python
,
```
```python
4
```
```python
)
```
```python
)
```
```python
w_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
5
```
```python
,
```
```python
4
```
```python
)
```
```python
)
```
```python
b_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
5
```
```python
,
```
```python
)
```
```python
)
```
```python
x_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
x_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
w_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
w_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
b_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
b_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
affine_numpy
```
```python
=
```
```python
Affine
```
```python
(
```
```python
)
```
```python
affine_numpy
```
```python
.
```
```python
weight
```
```python
=
```
```python
w_numpy
affine_numpy
```
```python
.
```
```python
bias
```
```python
=
```
```python
b_numpy
affine_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
nn
```
```python
.
```
```python
Linear
```
```python
(
```
```python
3
```
```python
,
```
```python
7
```
```python
,
```
```python
bias
```
```python
=
```
```python
True
```
```python
)
```
```python
affine_tensor
```
```python
.
```
```python
weight
```
```python
=
```
```python
torch
```
```python
.
```
```python
nn
```
```python
.
```
```python
Parameter
```
```python
(
```
```python
w_tensor
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
affine_tensor
```
```python
.
```
```python
bias
```
```python
=
```
```python
torch
```
```python
.
```
```python
nn
```
```python
.
```
```python
Parameter
```
```python
(
```
```python
b_tensor
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
out_numpy
```
```python
=
```
```python
affine_numpy
```
```python
(
```
```python
x_numpy
```
```python
)
```
```python
out_tensor
```
```python
=
```
```python
affine_tensor
```
```python
(
```
```python
x_tensor
```
```python
)
```
```python
d_loss_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
out_numpy
```
```python
.
```
```python
shape
```
```python
)
```
```python
d_loss_tensor
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
d_loss_numpy
```
```python
)
```
```python
out_tensor
```
```python
.
```
```python
backward
```
```python
(
```
```python
d_loss_tensor
```
```python
)
```
```python
dx_numpy
```
```python
=
```
```python
affine_numpy
```
```python
.
```
```python
backward
```
```python
(
```
```python
d_loss_numpy
```
```python
)
```
```python
dw_numpy
```
```python
=
```
```python
affine_numpy
```
```python
.
```
```python
dw
db_numpy
```
```python
=
```
```python
affine_numpy
```
```python
.
```
```python
db
dx_tensor
```
```python
=
```
```python
x_tensor
```
```python
.
```
```python
grad
dw_tensor
```
```python
=
```
```python
affine_tensor
```
```python
.
```
```python
weight
```
```python
.
```
```python
grad
db_tensor
```
```python
=
```
```python
affine_tensor
```
```python
.
```
```python
bias
```
```python
.
```
```python
grad
```
```python
print
```
```python
(
```
```python
"--- 对比变换结果 ---"
```
```python
)
```
```python
print
```
```python
(
```
```python
out_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
out_tensor
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"--- 对比 dx ---"
```
```python
)
```
```python
print
```
```python
(
```
```python
dx_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
dx_tensor
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"--- 对比 dw ---"
```
```python
)
```
```python
print
```
```python
(
```
```python
dw_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
dw_tensor
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"--- 对比 db ---"
```
```python
)
```
```python
print
```
```python
(
```
```python
db_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
db_tensor
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
"""
代码输出
--- 对比变换结果 ---
[[ 1.250556  1.084776  1.611937  1.115749  1.071461]
 [ 1.667441  1.584755  2.370629  1.479834  1.291984]
 [ 1.339822  1.220394  1.758095  1.076918  1.162823]]
[[ 1.250556  1.084776  1.611937  1.115749  1.071461]
 [ 1.667441  1.584755  2.370629  1.479834  1.291984]
 [ 1.339822  1.220394  1.758095  1.076918  1.162823]]
--- 对比 dx ---
[[ 1.367212  0.91971   1.457424  1.660651]
 [ 1.087256  1.213257  1.109499  1.250769]
 [ 1.245717  1.230932  1.232196  1.764028]]
[[ 1.367212  0.91971   1.457424  1.660651]
 [ 1.087256  1.213257  1.109499  1.250769]
 [ 1.245717  1.230932  1.232196  1.764028]]
--- 对比 dw ---
[[ 1.324482  0.776335  0.852071  1.428347]
 [ 1.20587   0.649376  0.799307  1.183345]
 [ 1.267557  0.750463  1.173819  1.316775]
 [ 0.672773  0.331807  0.428579  0.603458]
 [ 0.825466  0.561481  0.783553  0.996982]]
[[ 1.324482  0.776335  0.852071  1.428347]
 [ 1.20587   0.649376  0.799307  1.183345]
 [ 1.267557  0.750463  1.173819  1.316775]
 [ 0.672773  0.331807  0.428579  0.603458]
 [ 0.825466  0.561481  0.783553  0.996982]]
--- 对比 db ---
[ 2.196234  1.878471  1.98104   0.995037  1.424993]
[ 2.196234  1.878471  1.98104   0.995037  1.424993]
"""
```

