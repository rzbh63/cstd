
# Spring Boot中的事务管理与手把手实战 - bitcarmanlee的博客 - CSDN博客


2018年06月04日 18:25:26[bitcarmanlee](https://me.csdn.net/bitcarmanlee)阅读数：997



## 1.数据库中的事务
如果一个数据库声称支持事务的操作，那么该数据库必须要具备以下四个特性：
1.原子性（Atomicity）
原子性是指事务包含的所有操作要么全部成功，要么全部失败回滚，这和前面两篇博客介绍事务的功能是一样的概念，因此事务的操作如果成功就必须要完全应用到数据库，如果操作失败则不能对数据库有任何影响。
2.一致性（Consistency）
一致性是指事务必须使数据库从一个一致性状态变换到另一个一致性状态，也就是说一个事务执行之前和执行之后都必须处于一致性状态。
拿转账来说，假设用户A和用户B两者的钱加起来一共是5000，那么不管A和B之间如何转账，转几次账，事务结束后两个用户的钱相加起来应该还得是5000，这就是事务的一致性。
3.隔离性（Isolation）
隔离性是当多个用户并发访问数据库时，比如操作同一张表时，数据库为每一个用户开启的事务，不能被其他事务的操作所干扰，多个并发事务之间要相互隔离。
即要达到这么一种效果：对于任意两个并发的事务T1和T2，在事务T1看来，T2要么在T1开始之前就已经结束，要么在T1结束之后才开始，这样每个事务都感觉不到有其他事务在并发地执行。
4.持久性（Durability）
持久性是指一个事务一旦被提交了，那么对数据库中的数据的改变就是永久性的，即便是在数据库系统遇到故障的情况下也不会丢失提交事务的操作。
## 2.事务的特点
数据库事务的特点，用一个最简单的词来形容，则是”同生共死”。
事务指访问并可能更新数据库中各种数据项的一个程序执行单元。一般来说，都是由多个sql语句组成，并且作为一个整体执行。
以经典的账户转账为例，如果要将用户A的钱转给用户B，至少需要两部：
1.A账户中的资金减少。
2.B账户中的资金增加。
那么转账过程中，需要这两个步骤都同时执行成功，转账过程才能执行。
事务的一般语法步骤为：
开始事务：BEGIN TRANSACTION       开启事务
事务提交：COMMIT TRANSACTION   –提交操作
事务回滚：ROLLBACK TRANSACTION –取消操作
## 3.Spring中的事务管理
Spring 事务管理分为编码式和声明式的两种方式。编程式事务指的是通过编码方式实现事务；声明式事务基于 AOP,将具体业务逻辑与事务处理解耦。声明式事务管理使业务代码逻辑不受污染, 因此在实际使用中声明式事务用的比较多。声明式事务有两种方式，一种是在配置文件（xml）中做相关的事务规则声明，另一种是基于@Transactional 注解的方式。@Transactional注解的使用方式非常简单明了，所以我们来实验一下这种方式。
## 4.Spring事务管理实战
上面说了这么多理论，肯定不是我们的风格，下面我们以一个实际的场景来说明Spring中怎么用注解的方式来处理事务。
假设我们有个打球报名的需求，具体的需求如下：
1.用户以某个userId报名参加某个场地courtId的打球活动。
2.某个场地courtId的报名人数不能超过一定的总量。
当然实际的需求比这个更发杂，我们先把问题简单化，假设先只要满足上述的条件。
### 4.1　在mysql中创建两张表:user与court
假设本机已经装好了mysql数据库的server并已经成功启动mysql服务。
```python
create
```
```python
table
```
```python
user
```
```python
(
```
```python
`id`
```
```python
INT
```
```python
NOT
```
```python
NULL
```
```python
AUTO_INCREMENT,
```
```python
`court_id`
```
```python
INT
```
```python
NOT
```
```python
NULL
```
```python
DEFAULT
```
```python
1
```
```python
,
```
```python
`user_id`
```
```python
INT
```
```python
NOT
```
```python
NULL
```
```python
DEFAULT
```
```python
0
```
```python
,
```
```python
PRIMARY
```
```python
KEY
```
```python
(
```
```python
`id`
```
```python
)
)
  ENGINE = InnoDB
```
```python
DEFAULT
```
```python
CHARSET = utf8;
```
```python
create
```
```python
table
```
```python
court(
```
```python
`court_id`
```
```python
INT
```
```python
NOT
```
```python
NULL
```
```python
,
```
```python
`num`
```
```python
INT
```
```python
NOT
```
```python
NULL
```
```python
DEFAULT
```
```python
0
```
```python
,
```
```python
PRIMARY
```
```python
KEY
```
```python
(
```
```python
`court_id`
```
```python
)
)
  ENGINE = InnoDB
```
```python
DEFAULT
```
```python
CHARSET = utf8;
```
其中user表存用户的报名信息，id为自增主键，某个用户报一次名就往该表插入一条数据。
而court表存储的是某个courtId的报名人数。
### 2.项目中的pom依赖
新建一个maven web项目，其中pom.xml将spring jpa相关的依赖引入：
```python
<
```
```python
dependencies
```
```python
>
```
```python
<
```
```python
dependency
```
```python
>
```
```python
<
```
```python
groupId
```
```python
>
```
```python
org.springframework.boot
```
```python
</
```
```python
groupId
```
```python
>
```
```python
<
```
```python
artifactId
```
```python
>
```
```python
spring-boot-starter-data-jpa
```
```python
</
```
```python
artifactId
```
```python
>
```
```python
</
```
```python
dependency
```
```python
>
```
```python
<
```
```python
dependency
```
```python
>
```
```python
<
```
```python
groupId
```
```python
>
```
```python
org.springframework.boot
```
```python
</
```
```python
groupId
```
```python
>
```
```python
<
```
```python
artifactId
```
```python
>
```
```python
spring-boot-starter-web
```
```python
</
```
```python
artifactId
```
```python
>
```
```python
</
```
```python
dependency
```
```python
>
```
```python
<
```
```python
dependency
```
```python
>
```
```python
<
```
```python
groupId
```
```python
>
```
```python
mysql
```
```python
</
```
```python
groupId
```
```python
>
```
```python
<
```
```python
artifactId
```
```python
>
```
```python
mysql-connector-java
```
```python
</
```
```python
artifactId
```
```python
>
```
```python
</
```
```python
dependency
```
```python
>
```
```python
<
```
```python
dependency
```
```python
>
```
```python
<
```
```python
groupId
```
```python
>
```
```python
org.springframework.boot
```
```python
</
```
```python
groupId
```
```python
>
```
```python
<
```
```python
artifactId
```
```python
>
```
```python
spring-boot-starter-jdbc
```
```python
</
```
```python
artifactId
```
```python
>
```
```python
</
```
```python
dependency
```
```python
>
```
```python
<
```
```python
dependency
```
```python
>
```
```python
<
```
```python
groupId
```
```python
>
```
```python
org.hibernate
```
```python
</
```
```python
groupId
```
```python
>
```
```python
<
```
```python
artifactId
```
```python
>
```
```python
hibernate-validator
```
```python
</
```
```python
artifactId
```
```python
>
```
```python
<
```
```python
version
```
```python
>
```
```python
6.0.2.Final
```
```python
</
```
```python
version
```
```python
>
```
```python
</
```
```python
dependency
```
```python
>
```
```python
<
```
```python
dependency
```
```python
>
```
```python
<
```
```python
groupId
```
```python
>
```
```python
org.apache.commons
```
```python
</
```
```python
groupId
```
```python
>
```
```python
<
```
```python
artifactId
```
```python
>
```
```python
commons-lang3
```
```python
</
```
```python
artifactId
```
```python
>
```
```python
<
```
```python
version
```
```python
>
```
```python
3.3.2
```
```python
</
```
```python
version
```
```python
>
```
```python
</
```
```python
dependency
```
```python
>
```
```python
</
```
```python
dependencies
```
```python
>
```
简单起见，只将dependency部分贴出来，分别是mysql, spring, hibernate的一些配置
### 3.将mysql表对应到model层
user表对应的model:
```python
import
```
```python
javax.persistence.*;
```
```python
import
```
```python
javax.validation.constraints.NotNull;
```
```python
/**
 * Created by WangLei on 18-6-4.
 */
```
```python
@Entity
```
```python
@Table
```
```python
(name =
```
```python
"user"
```
```python
)
```
```python
public
```
```python
class
```
```python
User
```
```python
{
```
```python
@Id
```
```python
@GeneratedValue
```
```python
(strategy = GenerationType.AUTO)
```
```python
@NotNull
```
```python
private
```
```python
int
```
```python
id;
```
```python
@NotNull
```
```python
private
```
```python
int
```
```python
courtId;
```
```python
@NotNull
```
```python
private
```
```python
int
```
```python
userId;
```
```python
public
```
```python
User
```
```python
() {}
```
```python
public
```
```python
User
```
```python
(
```
```python
int
```
```python
courtId,
```
```python
int
```
```python
userId) {
```
```python
this
```
```python
.courtId = courtId;
```
```python
this
```
```python
.userId = userId;
    }
```
```python
public
```
```python
int
```
```python
getId
```
```python
() {
```
```python
return
```
```python
id;
    }
```
```python
public
```
```python
void
```
```python
setId
```
```python
(
```
```python
int
```
```python
id) {
```
```python
this
```
```python
.id = id;
    }
```
```python
public
```
```python
int
```
```python
getCourtId
```
```python
() {
```
```python
return
```
```python
courtId;
    }
```
```python
public
```
```python
void
```
```python
setCourtId
```
```python
(
```
```python
int
```
```python
courtId) {
```
```python
this
```
```python
.courtId = courtId;
    }
```
```python
public
```
```python
int
```
```python
getUserId
```
```python
() {
```
```python
return
```
```python
userId;
    }
```
```python
public
```
```python
void
```
```python
setUserId
```
```python
(
```
```python
int
```
```python
userId) {
```
```python
this
```
```python
.userId = userId;
    }
}
```
court表对应的model:
```python
import
```
```python
javax.persistence.*;
```
```python
import
```
```python
javax.validation.constraints.NotNull;
```
```python
/**
 * Created by WangLei on 18-6-4.
 */
```
```python
@Entity
```
```python
@Table
```
```python
(name =
```
```python
"court"
```
```python
)
```
```python
public
```
```python
class
```
```python
Court
```
```python
{
```
```python
@Id
```
```python
@NotNull
```
```python
private
```
```python
int
```
```python
courtId;
```
```python
@NotNull
```
```python
private
```
```python
int
```
```python
num;
```
```python
public
```
```python
Court
```
```python
() {
    }
```
```python
public
```
```python
Court
```
```python
(
```
```python
int
```
```python
courtId,
```
```python
int
```
```python
num) {
```
```python
this
```
```python
.courtId = courtId;
```
```python
this
```
```python
.num = num;
    }
```
```python
public
```
```python
int
```
```python
getCourtId
```
```python
() {
```
```python
return
```
```python
courtId;
    }
```
```python
public
```
```python
void
```
```python
setCourtId
```
```python
(
```
```python
int
```
```python
courtId) {
```
```python
this
```
```python
.courtId = courtId;
    }
```
```python
public
```
```python
int
```
```python
getNum
```
```python
() {
```
```python
return
```
```python
num;
    }
```
```python
public
```
```python
void
```
```python
setNum
```
```python
(
```
```python
int
```
```python
num) {
```
```python
this
```
```python
.num = num;
    }
}
```
顺便解释一下Spring中的这几个注解：
@Entity:对实体注释。任何Hibernate映射对象都要有这个注释
@Table: 声明此对象映射到数据库的数据表，通过它可以为实体指定表(talbe),目录(Catalog)和schema的名字。该注释不是必须的，如果没有则系统使用默认值(实体的短类名)。不过一般我还是习惯指定表名，这样出错的可能性更小。
@Id:声明此属性为主键。该属性值可以通过应该自身创建，但是Hibernate推荐通过Hibernate生成。
### 4.dao层(spring中也叫Repository，不过咱们还是叫dao)
user对应的dao
```python
import
```
```python
com
```
```python
.xiaomi
```
```python
.xxx
```
```python
.model
```
```python
.User
```
```python
;
```
```python
import org
```
```python
.springframework
```
```python
.data
```
```python
.jpa
```
```python
.repository
```
```python
.JpaRepository
```
```python
;
```
```python
import org
```
```python
.springframework
```
```python
.stereotype
```
```python
.Repository
```
```python
;
```
```python
import org
```
```python
.springframework
```
```python
.transaction
```
```python
.annotation
```
```python
.Transactional
```
```python
;
```
```python
/**
 * Created by WangLei on 18-6-4.
 */
```
```python
@Transactional
@Repository
public interface UserDao  extends JpaRepository<User, Integer> {
}
```
court对应的dao:
```python
import
```
```python
com
```
```python
.xiaomi
```
```python
.xxx
```
```python
.model
```
```python
.Court
```
```python
;
```
```python
import org
```
```python
.springframework
```
```python
.data
```
```python
.jpa
```
```python
.repository
```
```python
.JpaRepository
```
```python
;
```
```python
import org
```
```python
.springframework
```
```python
.data
```
```python
.jpa
```
```python
.repository
```
```python
.Modifying
```
```python
;
```
```python
import org
```
```python
.springframework
```
```python
.data
```
```python
.jpa
```
```python
.repository
```
```python
.Query
```
```python
;
```
```python
import org
```
```python
.springframework
```
```python
.stereotype
```
```python
.Repository
```
```python
;
```
```python
import org
```
```python
.springframework
```
```python
.transaction
```
```python
.annotation
```
```python
.Transactional
```
```python
;
```
```python
/**
 * Created by WangLei on 18-6-4.
 */
```
```python
@Transactional
@Repository
public interface CourtDao extends JpaRepository<Court, Integer> {
    @Query(value =
```
```python
"select c from Court c where c.courtId = ?1"
```
```python
)
    Court findByCourtId(int courtId)
```
```python
;
```
```python
@Modifying
    @Query(value =
```
```python
"update Court c set c.num = c.num + 1 where c.courtId = ?1"
```
```python
)
    int updateCourt(int courtId)
```
```python
;
```
```python
}
```
注意dao类都继承了`JpaRepository`，JpaRepository里面就封装了数据库的CRUD操作。
### 5.service层
将更新操作的业务逻辑封装到service层中
```python
import
```
```python
com.xiaomi.xxx.dao.CourtDao;
```
```python
import
```
```python
com.xiaomi.xxx.dao.UserDao;
```
```python
import
```
```python
com.xiaomi.xxx.model.Court;
```
```python
import
```
```python
com.xiaomi.xxx.model.User;
```
```python
import
```
```python
org.springframework.beans.factory.annotation.Autowired;
```
```python
import
```
```python
org.springframework.stereotype.Service;
```
```python
/**
 * Created by WangLei on 18-6-4.
 */
```
```python
@Service
```
```python
public
```
```python
class
```
```python
UserService
```
```python
{
```
```python
// 每个场地对多10人
```
```python
private
```
```python
int
```
```python
COURT_MAX_NUM =
```
```python
10
```
```python
;
```
```python
@Autowired
```
```python
private
```
```python
UserDao userDao;
```
```python
@Autowired
```
```python
private
```
```python
CourtDao courtDao;
```
```python
public
```
```python
String
```
```python
addUser
```
```python
(
```
```python
int
```
```python
courtId,
```
```python
int
```
```python
userId) {
        Court court = courtDao.findByCourtId(courtId);
```
```python
if
```
```python
(court.getNum() == COURT_MAX_NUM) {
```
```python
return
```
```python
"场地报名超过限制!"
```
```python
;
        }
```
```python
if
```
```python
(court ==
```
```python
null
```
```python
) {
            courtDao.save(
```
```python
new
```
```python
Court(courtId,
```
```python
1
```
```python
));
        }
```
```python
else
```
```python
{
            courtDao.updateCourt(courtId);
        }
        User result = userDao.save(
```
```python
new
```
```python
User(courtId, userId));
```
```python
return
```
```python
"add user "
```
```python
+ result.getUserId() +
```
```python
" success!"
```
```python
;
    }
}
```
### 6.contoller层
```python
import
```
```python
com.xiaomi.xxx.service.UserService;
```
```python
import
```
```python
org.springframework.beans.factory.annotation.Autowired;
```
```python
import
```
```python
org.springframework.web.bind.annotation.RequestMapping;
```
```python
import
```
```python
org.springframework.web.bind.annotation.RestController;
```
```python
/**
 * Created by WangLei on 18-6-4.
 */
```
```python
@RestController
```
```python
public
```
```python
class
```
```python
UserController
```
```python
{
```
```python
@Autowired
```
```python
private
```
```python
UserService userService;
```
```python
@RequestMapping
```
```python
(value =
```
```python
"/addUser"
```
```python
)
```
```python
public
```
```python
String
```
```python
addUser
```
```python
(
```
```python
int
```
```python
courtId,
```
```python
int
```
```python
userId) {
```
```python
return
```
```python
userService.addUser(courtId, userId);
    }
}
```
### 7.Appliction入口
整个项目的入口类:
```python
import
```
```python
org.springframework.boot.SpringApplication;
```
```python
import
```
```python
org.springframework.boot.autoconfigure.SpringBootApplication;
```
```python
import
```
```python
org.springframework.stereotype.Controller;
```
```python
import
```
```python
org.springframework.web.bind.annotation.RequestMapping;
```
```python
import
```
```python
org.springframework.web.bind.annotation.ResponseBody;
```
```python
/**
 * Created by WangLei on 18-5-29.
 */
```
```python
@SpringBootApplication
```
```python
@Controller
```
```python
public
```
```python
class
```
```python
Application
```
```python
{
```
```python
@RequestMapping
```
```python
(
```
```python
"/hello"
```
```python
)
```
```python
@ResponseBody
```
```python
public
```
```python
String
```
```python
index
```
```python
() {
```
```python
return
```
```python
"hello world!"
```
```python
;
    }
```
```python
public
```
```python
static
```
```python
void
```
```python
main
```
```python
(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```
### 8.将整个项目run起来
在intellij点击开始按钮，将整个项目启动
```python
...
```
```python
2018
```
```python
-
```
```python
06
```
```python
-
```
```python
04
```
```python
18
```
```python
:
```
```python
31
```
```python
:
```
```python
56.320
```
```python
INFO
```
```python
20697
```
```python
--- [           main] s
```
```python
.w
```
```python
.s
```
```python
.m
```
```python
.m
```
```python
.a
```
```python
.RequestMappingHandlerMapping
```
```python
: Mapped
```
```python
"{[/error],produces=[text/html]}"
```
```python
onto public org
```
```python
.springframework
```
```python
.web
```
```python
.servlet
```
```python
.ModelAndView
```
```python
org
```
```python
.springframework
```
```python
.boot
```
```python
.autoconfigure
```
```python
.web
```
```python
.BasicErrorController
```
```python
.errorHtml
```
```python
(javax
```
```python
.servlet
```
```python
.http
```
```python
.HttpServletRequest
```
```python
,javax
```
```python
.servlet
```
```python
.http
```
```python
.HttpServletResponse
```
```python
)
```
```python
2018
```
```python
-
```
```python
06
```
```python
-
```
```python
04
```
```python
18
```
```python
:
```
```python
31
```
```python
:
```
```python
56.320
```
```python
INFO
```
```python
20697
```
```python
--- [           main] s
```
```python
.w
```
```python
.s
```
```python
.m
```
```python
.m
```
```python
.a
```
```python
.RequestMappingHandlerMapping
```
```python
: Mapped
```
```python
"{[/error]}"
```
```python
onto public org
```
```python
.springframework
```
```python
.http
```
```python
.ResponseEntity
```
```python
<java
```
```python
.util
```
```python
.Map
```
```python
<java
```
```python
.lang
```
```python
.String
```
```python
, java
```
```python
.lang
```
```python
.Object
```
```python
>> org
```
```python
.springframework
```
```python
.boot
```
```python
.autoconfigure
```
```python
.web
```
```python
.BasicErrorController
```
```python
.error
```
```python
(javax
```
```python
.servlet
```
```python
.http
```
```python
.HttpServletRequest
```
```python
)
```
```python
2018
```
```python
-
```
```python
06
```
```python
-
```
```python
04
```
```python
18
```
```python
:
```
```python
31
```
```python
:
```
```python
56.336
```
```python
INFO
```
```python
20697
```
```python
--- [           main] o
```
```python
.s
```
```python
.w
```
```python
.s
```
```python
.handler
```
```python
.SimpleUrlHandlerMapping
```
```python
: Mapped URL path [/webjars
```
```python
/**] onto handler of type [class org.springframework.web.servlet.resource.ResourceHttpRequestHandler]
2018-06-04 18:31:56.336  INFO 20697 --- [           main] o.s.w.s.handler.SimpleUrlHandlerMapping  : Mapped URL path [/**] onto handler of type [class org.springframework.web.servlet.resource.ResourceHttpRequestHandler]
2018-06-04 18:31:56.354  INFO 20697 --- [           main] o.s.w.s.handler.SimpleUrlHandlerMapping  : Mapped URL path [/**/
```
```python
favicon
```
```python
.ico
```
```python
] onto handler of type [class org
```
```python
.springframework
```
```python
.web
```
```python
.servlet
```
```python
.resource
```
```python
.ResourceHttpRequestHandler
```
```python
]
```
```python
2018
```
```python
-
```
```python
06
```
```python
-
```
```python
04
```
```python
18
```
```python
:
```
```python
31
```
```python
:
```
```python
56.472
```
```python
INFO
```
```python
20697
```
```python
--- [           main] o
```
```python
.s
```
```python
.j
```
```python
.e
```
```python
.a
```
```python
.AnnotationMBeanExporter
```
```python
: Registering beans for JMX exposure on startup
```
```python
2018
```
```python
-
```
```python
06
```
```python
-
```
```python
04
```
```python
18
```
```python
:
```
```python
31
```
```python
:
```
```python
56.537
```
```python
INFO
```
```python
20697
```
```python
--- [           main] s
```
```python
.b
```
```python
.c
```
```python
.e
```
```python
.t
```
```python
.TomcatEmbeddedServletContainer
```
```python
: Tomcat started on port(s):
```
```python
8080
```
```python
(http)
```
```python
2018
```
```python
-
```
```python
06
```
```python
-
```
```python
04
```
```python
18
```
```python
:
```
```python
31
```
```python
:
```
```python
56.540
```
```python
INFO
```
```python
20697
```
```python
--- [           main]
```
```python
com
```
```python
.xiaomi
```
```python
.xxx
```
```python
.Application
```
```python
: Started Application
```
```python
in
```
```python
7.032
```
```python
seconds (JVM running for
```
```python
10.144
```
```python
)
```
这个时候说明整个项目已经启动成功！
## 5.添加用户
项目成功run起来以后，我们开始在浏览器中发起http请求:
```python
http://localhost:8080/addUser?courtId
```
```python
=
```
```python
1&userId=1000
```
点击确认，这个时候浏览器会返回如下结果：
```python
add
```
```python
user
```
```python
1000
```
```python
success!
```
在去我们本地数据库中查看一下数据库中表的结果：
```python
mysql> select * from court;
+----------+-----+
```
```python
| court_id | num |
+----------+-----+
```
```python
|        1 |   1 |
+----------+-----+
```
```python
1 row in set (0.00 sec)
```
```python
mysql> select * from user;
+----+----------+---------+
```
```python
| id | court_id | user_id |
+----+----------+---------+
```
```python
|  1 |        1 |    1000 |
+----+----------+---------+
```
```python
1 row in set (0.00 sec)
```
此时user表中已经插入一条数据，表示user_id为1000的用户报名了1号场活动，而1号场已经有一个人报名，符合我们的预期！
## 6.上面的代码没有事务管理
上面的代码存在有一个很严重的问题，那就是service里的addUser方法，需要执行两条sql:
```python
if
```
```python
(court ==
```
```python
null
```
```python
) {
            courtDao.save(
```
```python
new
```
```python
Court(courtId,
```
```python
1
```
```python
));
        }
```
```python
else
```
```python
{
            courtDao.updateCourt(courtId);
        }
        User result = userDao.save(
```
```python
new
```
```python
User(courtId, userId));
```
这两个sql针对两个表执行:
1.先对court表进行加1的操作。
2.再对user表进行插入一条数据的操作。
很明显，这两条sql就是一个典型的事务。如果第一条sql执行成功，而第二条sql执行失败，此时会对court表进行加1的操作。很明显，这跟我们的业务需求是完全不吻合的。此时我们需要做的，是对第一条sql进行回滚操作，保证整个事务没有执行成功。
我们现在来模拟一下第一条sql执行，然后执行到第二条sql出现异常的情况。
首先将service部分的代码稍作修改：
```python
if
```
```python
(court ==
```
```python
null
```
```python
) {
            courtDao.save(
```
```python
new
```
```python
Court(courtId,
```
```python
1
```
```python
));
        }
```
```python
else
```
```python
{
            courtDao.updateCourt(courtId);
        }
```
```python
int
```
```python
div
```
```python
=
```
```python
1
```
```python
/
```
```python
0
```
```python
;
        User result = userDao.save(
```
```python
new
```
```python
User(courtId, userId));
```
```python
return
```
```python
"add user "
```
```python
+ result.getUserId() +
```
```python
" success!"
```
```python
;
```
div那行，0不能当除数，所以代码运行到这一行会有异常退出。
重新将服务起来，然后在浏览器中继续发起一个请求：
```python
http://localhost:8080/addUser?courtId
```
```python
=
```
```python
1&userId=1001
```
这个时候IDE里会爆出如下异常：
```python
2018
```
```python
-
```
```python
06
```
```python
-
```
```python
05
```
```python
09
```
```python
:
```
```python
37
```
```python
:
```
```python
31.063
```
```python
ERROR
```
```python
31697
```
```python
--- [nio-
```
```python
8080
```
```python
-exec-
```
```python
1
```
```python
] o.a.c.c.C.[.[.[/].[dispatcherServlet]    : Servlet.service()
```
```python
for
```
```python
servlet [dispatcherServlet]
```
```python
in
```
```python
context with path [] threw exception [Request processing failed; nested exception is java.lang.ArithmeticException: / by zero] with root cause
java.lang.ArithmeticException: / by zero
```
```python
...
```
此时我们再查一下数据库：
```python
mysql> select * from court;
+----------+-----+
```
```python
| court_id | num |
+----------+-----+
```
```python
|        1 |   2 |
+----------+-----+
```
```python
1 row in set (0.00 sec)
```
```python
mysql> select * from user;
+----+----------+---------+
```
```python
| id | court_id | user_id |
+----+----------+---------+
```
```python
|  1 |        1 |    1000 |
+----+----------+---------+
```
```python
1 row in set (0.00 sec)
```
此时court表已经进行了update操作，而user表没有插入新的数据行！
## 7.在Spring中使用Transactional来进行事务管理
那么我们怎么进行事务管理呢？根据第二部分的描述，最简单的方式是使用@Transactional注解的方式。
在addUser方法前面加上@Transactional注解：
```python
@Transactional
```
```python
public
```
```python
String
```
```python
addUser
```
```python
(
```
```python
int
```
```python
courtId,
```
```python
int
```
```python
userId)
```
然后重新启动服务，在浏览器中再发起一次请求：
```python
http://localhost:8080/addUser?courtId
```
```python
=
```
```python
1&userId=1001
```
会报同样的除数为0的异常。
再去数据库里看一把：
```python
mysql> select * from court;
+----------+-----+
```
```python
| court_id | num |
+----------+-----+
```
```python
|        1 |   2 |
+----------+-----+
```
```python
1 row in set (0.00 sec)
```
```python
mysql> select * from user;
+----+----------+---------+
```
```python
| id | court_id | user_id |
+----+----------+---------+
```
```python
|  1 |        1 |    1000 |
+----+----------+---------+
```
```python
1 row in set (0.00 sec)
```
很明显，此时court表没有进行update操作，user表也没有新插入数据，达到了我们进行事务控制的目的。

