
# mnist example for lstm in caffe - 机器学习的小学生 - CSDN博客


2019年03月15日 21:01:07[机器学习的小学生](https://me.csdn.net/xuluhui123)阅读数：64个人分类：[Caffe																](https://blog.csdn.net/xuluhui123/article/category/6777566)[LSTM																](https://blog.csdn.net/xuluhui123/article/category/8739928)[
							](https://blog.csdn.net/xuluhui123/article/category/6777566)



下面给出在caffe中使用lstm的一个例子，其中数据集采用mnist。
为了实现mnist数据的序列话，将mnist的每一行看成一帧，每一列则就是该帧的特征矢量。
在使用lstm时，一定要注意clip_markers，每个序列以0开始，后面接1保持为当前序列。
损失的计算有两种方式，每个序列的最后一帧参加到损失的计算，或者每个序列中所有帧都参加损失的计算。注意下面代码中最后全连接fc1和损失层中的axis参数，采用第二种方式时，需要将这两个层的axis设置为2。
为了方便测试，这里分享代码和数据：
**链接**：[https://pan.baidu.com/s/1grTdZhP4pqZmDzs7-WB31w](https://pan.baidu.com/s/1grTdZhP4pqZmDzs7-WB31w)
**提取码**：rxyn
训练代码为：
train_mnist_classification.py
```python
#coding=gbk
```
```python
import
```
```python
numpy
```
```python
as
```
```python
np
```
```python
import
```
```python
matplotlib
```
```python
.
```
```python
pyplot
```
```python
as
```
```python
plt
```
```python
import
```
```python
scipy
```
```python
.
```
```python
io
```
```python
as
```
```python
sio
```
```python
# loadmat
```
```python
from
```
```python
scipy
```
```python
.
```
```python
misc
```
```python
.
```
```python
pilutil
```
```python
import
```
```python
*
```
```python
import
```
```python
h5py
```
```python
from
```
```python
os
```
```python
.
```
```python
path
```
```python
import
```
```python
join
```
```python
,
```
```python
realpath
```
```python
,
```
```python
dirname
```
```python
from
```
```python
caffe
```
```python
import
```
```python
layers
```
```python
as
```
```python
L
```
```python
,
```
```python
params
```
```python
as
```
```python
P
```
```python
import
```
```python
sys
```
```python
,
```
```python
os
```
```python
from
```
```python
caffe
```
```python
.
```
```python
_caffe
```
```python
import
```
```python
Solver
```
```python
import
```
```python
scipy
```
```python
.
```
```python
io
```
```python
as
```
```python
io
```
```python
import
```
```python
time
```
```python
import
```
```python
caffe
```
```python
from
```
```python
caffe
```
```python
.
```
```python
proto
```
```python
import
```
```python
caffe_pb2
```
```python
# enum Engine { DEFAULT = 0; CAFFE = 1; CUDNN = 2; }
```
```python
# enum NormRegion { ACROSS_CHANNELS = 0; WITHIN_CHANNEL = 1; }
```
```python
# mnist 10class
```
```python
def
```
```python
make_lstm
```
```python
(
```
```python
trainSource
```
```python
,
```
```python
batchSize
```
```python
,
```
```python
nframe
```
```python
,
```
```python
cross_id
```
```python
,
```
```python
nclass
```
```python
,
```
```python
type1
```
```python
)
```
```python
:
```
```python
n
```
```python
=
```
```python
caffe
```
```python
.
```
```python
NetSpec
```
```python
(
```
```python
)
```
```python
n
```
```python
.
```
```python
data
```
```python
,
```
```python
n
```
```python
.
```
```python
labels
```
```python
,
```
```python
n
```
```python
.
```
```python
clip_markers
```
```python
=
```
```python
L
```
```python
.
```
```python
Python
```
```python
(
```
```python
name
```
```python
=
```
```python
'data'
```
```python
,
```
```python
ntop
```
```python
=
```
```python
3
```
```python
,
```
```python
python_param
```
```python
=
```
```python
dict
```
```python
(
```
```python
module
```
```python
=
```
```python
'python_read_data_for_mnist'
```
```python
,
```
```python
layer
```
```python
=
```
```python
'AllDataLayer'
```
```python
,
```
```python
param_str
```
```python
=
```
```python
'{\'phase\': \'train\', \'dataset_name\': \'mnist\', \'data_type\': \'image\',\'batch_size\': '
```
```python
+
```
```python
str
```
```python
(
```
```python
batchSize
```
```python
)
```
```python
+
```
```python
',\'cross_id\':'
```
```python
+
```
```python
str
```
```python
(
```
```python
cross_id
```
```python
)
```
```python
+
```
```python
'}'
```
```python
)
```
```python
,
```
```python
)
```
```python
n
```
```python
.
```
```python
fc0
```
```python
=
```
```python
L
```
```python
.
```
```python
InnerProduct
```
```python
(
```
```python
n
```
```python
.
```
```python
data
```
```python
,
```
```python
name
```
```python
=
```
```python
'fc0'
```
```python
,
```
```python
num_output
```
```python
=
```
```python
128
```
```python
,
```
```python
weight_filler
```
```python
=
```
```python
dict
```
```python
(
```
```python
type
```
```python
=
```
```python
'xavier'
```
```python
,
```
```python
std
```
```python
=
```
```python
0.005
```
```python
)
```
```python
,
```
```python
bias_filler
```
```python
=
```
```python
dict
```
```python
(
```
```python
type
```
```python
=
```
```python
'constant'
```
```python
,
```
```python
value
```
```python
=
```
```python
0.1
```
```python
)
```
```python
,
```
```python
param
```
```python
=
```
```python
[
```
```python
dict
```
```python
(
```
```python
lr_mult
```
```python
=
```
```python
1
```
```python
,
```
```python
decay_mult
```
```python
=
```
```python
1
```
```python
)
```
```python
,
```
```python
dict
```
```python
(
```
```python
lr_mult
```
```python
=
```
```python
2
```
```python
,
```
```python
decay_mult
```
```python
=
```
```python
0
```
```python
)
```
```python
]
```
```python
)
```
```python
n
```
```python
.
```
```python
reshape_data
```
```python
=
```
```python
L
```
```python
.
```
```python
Reshape
```
```python
(
```
```python
n
```
```python
.
```
```python
fc0
```
```python
,
```
```python
name
```
```python
=
```
```python
'reshape_data'
```
```python
,
```
```python
reshape_param
```
```python
=
```
```python
{
```
```python
'shape'
```
```python
:
```
```python
{
```
```python
'dim'
```
```python
:
```
```python
[
```
```python
nframe
```
```python
,
```
```python
batchSize
```
```python
,
```
```python
128
```
```python
]
```
```python
}
```
```python
}
```
```python
)
```
```python
n
```
```python
.
```
```python
reshape_labels
```
```python
=
```
```python
L
```
```python
.
```
```python
Reshape
```
```python
(
```
```python
n
```
```python
.
```
```python
labels
```
```python
,
```
```python
name
```
```python
=
```
```python
'reshape_labels'
```
```python
,
```
```python
reshape_param
```
```python
=
```
```python
{
```
```python
'shape'
```
```python
:
```
```python
{
```
```python
'dim'
```
```python
:
```
```python
[
```
```python
nframe
```
```python
,
```
```python
batchSize
```
```python
]
```
```python
}
```
```python
}
```
```python
)
```
```python
n
```
```python
.
```
```python
reshape_clipmarkers
```
```python
=
```
```python
L
```
```python
.
```
```python
Reshape
```
```python
(
```
```python
n
```
```python
.
```
```python
clip_markers
```
```python
,
```
```python
name
```
```python
=
```
```python
'reshape_clipmarkers'
```
```python
,
```
```python
reshape_param
```
```python
=
```
```python
{
```
```python
'shape'
```
```python
:
```
```python
{
```
```python
'dim'
```
```python
:
```
```python
[
```
```python
nframe
```
```python
,
```
```python
batchSize
```
```python
]
```
```python
}
```
```python
}
```
```python
)
```
```python
n
```
```python
.
```
```python
lstm1
```
```python
=
```
```python
L
```
```python
.
```
```python
LSTM
```
```python
(
```
```python
n
```
```python
.
```
```python
reshape_data
```
```python
,
```
```python
n
```
```python
.
```
```python
reshape_clipmarkers
```
```python
,
```
```python
name
```
```python
=
```
```python
'lstm1'
```
```python
,
```
```python
recurrent_param
```
```python
=
```
```python
{
```
```python
'num_output'
```
```python
:
```
```python
64
```
```python
,
```
```python
'weight_filler'
```
```python
:
```
```python
{
```
```python
'type'
```
```python
:
```
```python
'uniform'
```
```python
,
```
```python
'min'
```
```python
:
```
```python
-
```
```python
0.01
```
```python
,
```
```python
'max'
```
```python
:
```
```python
0.01
```
```python
}
```
```python
,
```
```python
'bias_filler'
```
```python
:
```
```python
{
```
```python
'type'
```
```python
:
```
```python
'constant'
```
```python
,
```
```python
'value'
```
```python
:
```
```python
0
```
```python
}
```
```python
}
```
```python
)
```
```python
# the output of lstm convert to
```
```python
if
```
```python
type1
```
```python
==
```
```python
'using_last_frame_compute_loss'
```
```python
:
```
```python
n
```
```python
.
```
```python
last_frame_data
```
```python
=
```
```python
L
```
```python
.
```
```python
Python
```
```python
(
```
```python
n
```
```python
.
```
```python
lstm1
```
```python
,
```
```python
name
```
```python
=
```
```python
'last_frame_data'
```
```python
,
```
```python
ntop
```
```python
=
```
```python
1
```
```python
,
```
```python
python_param
```
```python
=
```
```python
dict
```
```python
(
```
```python
module
```
```python
=
```
```python
'data_separate_for_mnist'
```
```python
,
```
```python
layer
```
```python
=
```
```python
'data_separate'
```
```python
)
```
```python
,
```
```python
propagate_down
```
```python
=
```
```python
[
```
```python
1
```
```python
]
```
```python
)
```
```python
# for main tasks
```
```python
n
```
```python
.
```
```python
last_frame_label
```
```python
=
```
```python
L
```
```python
.
```
```python
Python
```
```python
(
```
```python
n
```
```python
.
```
```python
reshape_labels
```
```python
,
```
```python
name
```
```python
=
```
```python
'last_frame_label'
```
```python
,
```
```python
ntop
```
```python
=
```
```python
1
```
```python
,
```
```python
python_param
```
```python
=
```
```python
dict
```
```python
(
```
```python
module
```
```python
=
```
```python
'label_separate_for_mnist'
```
```python
,
```
```python
layer
```
```python
=
```
```python
'label_separate'
```
```python
)
```
```python
,
```
```python
propagate_down
```
```python
=
```
```python
[
```
```python
0
```
```python
]
```
```python
)
```
```python
# for main tasks
```
```python
n
```
```python
.
```
```python
fc1
```
```python
=
```
```python
L
```
```python
.
```
```python
InnerProduct
```
```python
(
```
```python
n
```
```python
.
```
```python
last_frame_data
```
```python
,
```
```python
name
```
```python
=
```
```python
'fc1'
```
```python
,
```
```python
num_output
```
```python
=
```
```python
nclass
```
```python
,
```
```python
weight_filler
```
```python
=
```
```python
dict
```
```python
(
```
```python
type
```
```python
=
```
```python
'xavier'
```
```python
,
```
```python
std
```
```python
=
```
```python
0.005
```
```python
)
```
```python
,
```
```python
bias_filler
```
```python
=
```
```python
dict
```
```python
(
```
```python
type
```
```python
=
```
```python
'constant'
```
```python
,
```
```python
value
```
```python
=
```
```python
0.1
```
```python
)
```
```python
,
```
```python
param
```
```python
=
```
```python
[
```
```python
dict
```
```python
(
```
```python
lr_mult
```
```python
=
```
```python
1
```
```python
,
```
```python
decay_mult
```
```python
=
```
```python
1
```
```python
)
```
```python
,
```
```python
dict
```
```python
(
```
```python
lr_mult
```
```python
=
```
```python
2
```
```python
,
```
```python
decay_mult
```
```python
=
```
```python
0
```
```python
)
```
```python
]
```
```python
)
```
```python
n
```
```python
.
```
```python
loss
```
```python
=
```
```python
L
```
```python
.
```
```python
SoftmaxWithLoss
```
```python
(
```
```python
n
```
```python
.
```
```python
fc1
```
```python
,
```
```python
n
```
```python
.
```
```python
last_frame_label
```
```python
,
```
```python
name
```
```python
=
```
```python
'loss'
```
```python
,
```
```python
ntop
```
```python
=
```
```python
1
```
```python
)
```
```python
elif
```
```python
type1
```
```python
==
```
```python
'using_all_frame_compute_loss'
```
```python
:
```
```python
n
```
```python
.
```
```python
fc1
```
```python
=
```
```python
L
```
```python
.
```
```python
InnerProduct
```
```python
(
```
```python
n
```
```python
.
```
```python
lstm1
```
```python
,
```
```python
name
```
```python
=
```
```python
'fc1'
```
```python
,
```
```python
num_output
```
```python
=
```
```python
nclass
```
```python
,
```
```python
weight_filler
```
```python
=
```
```python
dict
```
```python
(
```
```python
type
```
```python
=
```
```python
'xavier'
```
```python
,
```
```python
std
```
```python
=
```
```python
0.005
```
```python
)
```
```python
,
```
```python
bias_filler
```
```python
=
```
```python
dict
```
```python
(
```
```python
type
```
```python
=
```
```python
'constant'
```
```python
,
```
```python
value
```
```python
=
```
```python
0.1
```
```python
)
```
```python
,
```
```python
param
```
```python
=
```
```python
[
```
```python
dict
```
```python
(
```
```python
lr_mult
```
```python
=
```
```python
1
```
```python
,
```
```python
decay_mult
```
```python
=
```
```python
1
```
```python
)
```
```python
,
```
```python
dict
```
```python
(
```
```python
lr_mult
```
```python
=
```
```python
2
```
```python
,
```
```python
decay_mult
```
```python
=
```
```python
0
```
```python
)
```
```python
]
```
```python
,
```
```python
axis
```
```python
=
```
```python
2
```
```python
)
```
```python
n
```
```python
.
```
```python
loss
```
```python
=
```
```python
L
```
```python
.
```
```python
SoftmaxWithLoss
```
```python
(
```
```python
n
```
```python
.
```
```python
fc1
```
```python
,
```
```python
n
```
```python
.
```
```python
reshape_labels
```
```python
,
```
```python
name
```
```python
=
```
```python
'loss'
```
```python
,
```
```python
ntop
```
```python
=
```
```python
1
```
```python
,
```
```python
softmax_param
```
```python
=
```
```python
{
```
```python
'axis'
```
```python
:
```
```python
2
```
```python
}
```
```python
)
```
```python
return
```
```python
n
```
```python
.
```
```python
to_proto
```
```python
(
```
```python
)
```
```python
def
```
```python
make_solver
```
```python
(
```
```python
train_net
```
```python
,
```
```python
snapshot
```
```python
,
```
```python
snapshot_prefix
```
```python
)
```
```python
:
```
```python
maxIter
```
```python
=
```
```python
20000
```
```python
s
```
```python
=
```
```python
caffe_pb2
```
```python
.
```
```python
SolverParameter
```
```python
(
```
```python
)
```
```python
s
```
```python
.
```
```python
random_seed
```
```python
=
```
```python
0xCAFFE
```
```python
#s.type = 'Adam'
```
```python
s
```
```python
.
```
```python
type
```
```python
=
```
```python
'SGD'
```
```python
s
```
```python
.
```
```python
display
```
```python
=
```
```python
20
```
```python
s
```
```python
.
```
```python
iter_size
```
```python
=
```
```python
1
```
```python
s
```
```python
.
```
```python
base_lr
```
```python
=
```
```python
0.01
```
```python
# 0.0005 for customs, 0.0001 for mean3
```
```python
s
```
```python
.
```
```python
lr_policy
```
```python
=
```
```python
"step"
```
```python
s
```
```python
.
```
```python
gamma
```
```python
=
```
```python
0.1
```
```python
s
```
```python
.
```
```python
momentum
```
```python
=
```
```python
0.9
```
```python
s
```
```python
.
```
```python
stepsize
```
```python
=
```
```python
5000
```
```python
s
```
```python
.
```
```python
max_iter
```
```python
=
```
```python
maxIter
    s
```
```python
.
```
```python
weight_decay
```
```python
=
```
```python
0.0005
```
```python
s
```
```python
.
```
```python
snapshot
```
```python
=
```
```python
snapshot
    s
```
```python
.
```
```python
snapshot_prefix
```
```python
=
```
```python
snapshot_prefix
    s
```
```python
.
```
```python
train_net
```
```python
=
```
```python
train_net
```
```python
return
```
```python
s
ncross
```
```python
=
```
```python
1
```
```python
# 仅进行一次实验。
```
```python
for
```
```python
nc
```
```python
in
```
```python
range
```
```python
(
```
```python
ncross
```
```python
)
```
```python
:
```
```python
print
```
```python
(
```
```python
'cross_id: '
```
```python
,
```
```python
str
```
```python
(
```
```python
nc
```
```python
+
```
```python
1
```
```python
)
```
```python
)
```
```python
##########################
```
```python
nclass
```
```python
=
```
```python
10
```
```python
# for caspeal: 21 ,for pointing04: 93 , cmupie: 13
```
```python
zoo_path
```
```python
=
```
```python
'ZOO_lstm/'
```
```python
snap_path
```
```python
=
```
```python
'snapshots_lstm_for_mnist_all/'
```
```python
pretrained_weight
```
```python
=
```
```python
None
```
```python
debug_suf
```
```python
=
```
```python
''
```
```python
trainSource
```
```python
=
```
```python
None
```
```python
snapshot
```
```python
=
```
```python
1000000
```
```python
# not use
```
```python
niter
```
```python
=
```
```python
10000
```
```python
#5000
```
```python
snap_interval
```
```python
=
```
```python
2000
```
```python
isShow
```
```python
=
```
```python
True
```
```python
batchSize
```
```python
=
```
```python
256
```
```python
nframe
```
```python
=
```
```python
28
```
```python
# imgSize[0]
```
```python
type1
```
```python
=
```
```python
'using_last_frame_compute_loss'
```
```python
# using_last_frame_compute_loss, using_all_frame_compute_loss
```
```python
##########################
```
```python
nstep
```
```python
=
```
```python
0
```
```python
if
```
```python
not
```
```python
os
```
```python
.
```
```python
path
```
```python
.
```
```python
exists
```
```python
(
```
```python
snap_path
```
```python
)
```
```python
:
```
```python
os
```
```python
.
```
```python
mkdir
```
```python
(
```
```python
snap_path
```
```python
)
```
```python
file_path
```
```python
=
```
```python
snap_path
```
```python
+
```
```python
'/cross'
```
```python
+
```
```python
str
```
```python
(
```
```python
nc
```
```python
+
```
```python
1
```
```python
)
```
```python
if
```
```python
not
```
```python
os
```
```python
.
```
```python
path
```
```python
.
```
```python
exists
```
```python
(
```
```python
file_path
```
```python
)
```
```python
:
```
```python
os
```
```python
.
```
```python
mkdir
```
```python
(
```
```python
file_path
```
```python
)
```
```python
with
```
```python
open
```
```python
(
```
```python
zoo_path
```
```python
+
```
```python
'train.prototxt'
```
```python
,
```
```python
'w'
```
```python
)
```
```python
as
```
```python
f
```
```python
:
```
```python
f
```
```python
.
```
```python
write
```
```python
(
```
```python
str
```
```python
(
```
```python
make_lstm
```
```python
(
```
```python
trainSource
```
```python
,
```
```python
batchSize
```
```python
,
```
```python
nframe
```
```python
,
```
```python
nc
```
```python
,
```
```python
nclass
```
```python
,
```
```python
type1
```
```python
)
```
```python
)
```
```python
)
```
```python
# 这里的 nc不需要加1
```
```python
caffe
```
```python
.
```
```python
set_device
```
```python
(
```
```python
0
```
```python
)
```
```python
caffe
```
```python
.
```
```python
set_mode_gpu
```
```python
(
```
```python
)
```
```python
#caffe.set_mode_cpu()
```
```python
train_net
```
```python
=
```
```python
zoo_path
```
```python
+
```
```python
'train.prototxt'
```
```python
snapshot_prefix
```
```python
=
```
```python
snap_path
```
```python
+
```
```python
'cross'
```
```python
+
```
```python
str
```
```python
(
```
```python
nc
```
```python
+
```
```python
1
```
```python
)
```
```python
+
```
```python
debug_suf
```
```python
+
```
```python
'/vgg_'
```
```python
print
```
```python
(
```
```python
snapshot_prefix
```
```python
)
```
```python
print
```
```python
(
```
```python
train_net
```
```python
)
```
```python
solver_pro
```
```python
=
```
```python
zoo_path
```
```python
+
```
```python
'solver.prototxt'
```
```python
with
```
```python
open
```
```python
(
```
```python
solver_pro
```
```python
,
```
```python
'w'
```
```python
)
```
```python
as
```
```python
f
```
```python
:
```
```python
f
```
```python
.
```
```python
write
```
```python
(
```
```python
str
```
```python
(
```
```python
make_solver
```
```python
(
```
```python
train_net
```
```python
,
```
```python
snapshot
```
```python
,
```
```python
snapshot_prefix
```
```python
)
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
solver_pro
```
```python
)
```
```python
mysolver
```
```python
=
```
```python
caffe
```
```python
.
```
```python
get_solver
```
```python
(
```
```python
solver_pro
```
```python
)
```
```python
loss1
```
```python
=
```
```python
np
```
```python
.
```
```python
zeros
```
```python
(
```
```python
niter
```
```python
)
```
```python
disp_interval
```
```python
=
```
```python
1
```
```python
isPrint
```
```python
=
```
```python
True
```
```python
if
```
```python
isShow
```
```python
:
```
```python
plt
```
```python
.
```
```python
ion
```
```python
(
```
```python
)
```
```python
#plt.axis([0,niter,0,1])
```
```python
#fig = plt.figure()
```
```python
#pass
```
```python
for
```
```python
it
```
```python
in
```
```python
range
```
```python
(
```
```python
niter
```
```python
)
```
```python
:
```
```python
mysolver
```
```python
.
```
```python
step
```
```python
(
```
```python
1
```
```python
)
```
```python
loss1
```
```python
[
```
```python
it
```
```python
]
```
```python
=
```
```python
mysolver
```
```python
.
```
```python
net
```
```python
.
```
```python
blobs
```
```python
[
```
```python
'loss'
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
copy
```
```python
(
```
```python
)
```
```python
if
```
```python
it
```
```python
%
```
```python
disp_interval
```
```python
==
```
```python
0
```
```python
or
```
```python
it
```
```python
+
```
```python
1
```
```python
==
```
```python
niter
```
```python
:
```
```python
print
```
```python
(
```
```python
'it:'
```
```python
,
```
```python
it
```
```python
,
```
```python
' loss1:'
```
```python
,
```
```python
loss1
```
```python
[
```
```python
it
```
```python
]
```
```python
)
```
```python
if
```
```python
isShow
```
```python
and
```
```python
it
```
```python
>=
```
```python
1
```
```python
:
```
```python
plt
```
```python
.
```
```python
plot
```
```python
(
```
```python
[
```
```python
it
```
```python
-
```
```python
1
```
```python
,
```
```python
it
```
```python
]
```
```python
,
```
```python
[
```
```python
loss1
```
```python
[
```
```python
it
```
```python
-
```
```python
1
```
```python
]
```
```python
,
```
```python
loss1
```
```python
[
```
```python
it
```
```python
]
```
```python
]
```
```python
,
```
```python
'r-'
```
```python
)
```
```python
plt
```
```python
.
```
```python
show
```
```python
(
```
```python
)
```
```python
plt
```
```python
.
```
```python
pause
```
```python
(
```
```python
0.00001
```
```python
)
```
```python
if
```
```python
(
```
```python
it
```
```python
+
```
```python
1
```
```python
)
```
```python
%
```
```python
snap_interval
```
```python
==
```
```python
0
```
```python
:
```
```python
plt
```
```python
.
```
```python
savefig
```
```python
(
```
```python
snap_path
```
```python
+
```
```python
str
```
```python
(
```
```python
it
```
```python
+
```
```python
1
```
```python
)
```
```python
+
```
```python
'.pdf'
```
```python
)
```
```python
mysolver
```
```python
.
```
```python
net
```
```python
.
```
```python
save
```
```python
(
```
```python
snapshot_prefix
```
```python
+
```
```python
'iter_'
```
```python
+
```
```python
str
```
```python
(
```
```python
it
```
```python
+
```
```python
1
```
```python
)
```
```python
+
```
```python
'.caffemodel'
```
```python
)
```
![在这里插入图片描述](https://img-blog.csdnimg.cn/2019031521142549.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3h1bHVodWkxMjM=,size_16,color_FFFFFF,t_70)
预测代码为：
```python
#coding=gbk
```
```python
import
```
```python
numpy
```
```python
as
```
```python
np
```
```python
import
```
```python
matplotlib
```
```python
.
```
```python
pyplot
```
```python
as
```
```python
plt
```
```python
import
```
```python
scipy
```
```python
.
```
```python
io
```
```python
as
```
```python
sio
```
```python
# loadmat
```
```python
from
```
```python
scipy
```
```python
.
```
```python
misc
```
```python
.
```
```python
pilutil
```
```python
import
```
```python
*
```
```python
import
```
```python
h5py
```
```python
from
```
```python
os
```
```python
.
```
```python
path
```
```python
import
```
```python
join
```
```python
,
```
```python
realpath
```
```python
,
```
```python
dirname
```
```python
from
```
```python
caffe
```
```python
import
```
```python
layers
```
```python
as
```
```python
L
```
```python
,
```
```python
params
```
```python
as
```
```python
P
```
```python
import
```
```python
sys
```
```python
,
```
```python
os
```
```python
from
```
```python
caffe
```
```python
.
```
```python
_caffe
```
```python
import
```
```python
Solver
```
```python
import
```
```python
scipy
```
```python
.
```
```python
io
```
```python
as
```
```python
io
```
```python
import
```
```python
time
```
```python
import
```
```python
caffe
```
```python
from
```
```python
caffe
```
```python
.
```
```python
proto
```
```python
import
```
```python
caffe_pb2
```
```python
import
```
```python
mnist_version2_for_caffe_lstm
```
```python
as
```
```python
mnist
```
```python
from
```
```python
numpy
```
```python
import
```
```python
*
```
```python
# enum Engine { DEFAULT = 0; CAFFE = 1; CUDNN = 2; }
```
```python
# enum NormRegion { ACROSS_CHANNELS = 0; WITHIN_CHANNEL = 1; }
```
```python
# mnist 10class
```
```python
def
```
```python
make_lstm_deploy
```
```python
(
```
```python
batchSize
```
```python
,
```
```python
nframe
```
```python
,
```
```python
feat_len
```
```python
,
```
```python
nclass
```
```python
,
```
```python
type1
```
```python
)
```
```python
:
```
```python
n
```
```python
=
```
```python
caffe
```
```python
.
```
```python
NetSpec
```
```python
(
```
```python
)
```
```python
n
```
```python
.
```
```python
data
```
```python
=
```
```python
L
```
```python
.
```
```python
Input
```
```python
(
```
```python
name
```
```python
=
```
```python
'data'
```
```python
,
```
```python
ntop
```
```python
=
```
```python
1
```
```python
,
```
```python
input_param
```
```python
=
```
```python
dict
```
```python
(
```
```python
shape
```
```python
=
```
```python
dict
```
```python
(
```
```python
dim
```
```python
=
```
```python
[
```
```python
batchSize
```
```python
*
```
```python
nframe
```
```python
,
```
```python
feat_len
```
```python
]
```
```python
)
```
```python
)
```
```python
)
```
```python
n
```
```python
.
```
```python
labels
```
```python
=
```
```python
L
```
```python
.
```
```python
Input
```
```python
(
```
```python
name
```
```python
=
```
```python
'labels'
```
```python
,
```
```python
ntop
```
```python
=
```
```python
1
```
```python
,
```
```python
input_param
```
```python
=
```
```python
dict
```
```python
(
```
```python
shape
```
```python
=
```
```python
dict
```
```python
(
```
```python
dim
```
```python
=
```
```python
[
```
```python
batchSize
```
```python
*
```
```python
nframe
```
```python
,
```
```python
1
```
```python
]
```
```python
)
```
```python
)
```
```python
)
```
```python
n
```
```python
.
```
```python
clip_markers
```
```python
=
```
```python
L
```
```python
.
```
```python
Input
```
```python
(
```
```python
name
```
```python
=
```
```python
'clip_markers'
```
```python
,
```
```python
ntop
```
```python
=
```
```python
1
```
```python
,
```
```python
input_param
```
```python
=
```
```python
dict
```
```python
(
```
```python
shape
```
```python
=
```
```python
dict
```
```python
(
```
```python
dim
```
```python
=
```
```python
[
```
```python
batchSize
```
```python
*
```
```python
nframe
```
```python
,
```
```python
1
```
```python
]
```
```python
)
```
```python
)
```
```python
)
```
```python
n
```
```python
.
```
```python
fc0
```
```python
=
```
```python
L
```
```python
.
```
```python
InnerProduct
```
```python
(
```
```python
n
```
```python
.
```
```python
data
```
```python
,
```
```python
name
```
```python
=
```
```python
'fc0'
```
```python
,
```
```python
num_output
```
```python
=
```
```python
128
```
```python
,
```
```python
weight_filler
```
```python
=
```
```python
dict
```
```python
(
```
```python
type
```
```python
=
```
```python
'xavier'
```
```python
,
```
```python
std
```
```python
=
```
```python
0.005
```
```python
)
```
```python
,
```
```python
bias_filler
```
```python
=
```
```python
dict
```
```python
(
```
```python
type
```
```python
=
```
```python
'constant'
```
```python
,
```
```python
value
```
```python
=
```
```python
0.1
```
```python
)
```
```python
,
```
```python
param
```
```python
=
```
```python
[
```
```python
dict
```
```python
(
```
```python
lr_mult
```
```python
=
```
```python
1
```
```python
,
```
```python
decay_mult
```
```python
=
```
```python
1
```
```python
)
```
```python
,
```
```python
dict
```
```python
(
```
```python
lr_mult
```
```python
=
```
```python
2
```
```python
,
```
```python
decay_mult
```
```python
=
```
```python
0
```
```python
)
```
```python
]
```
```python
)
```
```python
n
```
```python
.
```
```python
reshape_data
```
```python
=
```
```python
L
```
```python
.
```
```python
Reshape
```
```python
(
```
```python
n
```
```python
.
```
```python
fc0
```
```python
,
```
```python
name
```
```python
=
```
```python
'reshape_data'
```
```python
,
```
```python
reshape_param
```
```python
=
```
```python
{
```
```python
'shape'
```
```python
:
```
```python
{
```
```python
'dim'
```
```python
:
```
```python
[
```
```python
nframe
```
```python
,
```
```python
batchSize
```
```python
,
```
```python
128
```
```python
]
```
```python
}
```
```python
}
```
```python
)
```
```python
n
```
```python
.
```
```python
reshape_labels
```
```python
=
```
```python
L
```
```python
.
```
```python
Reshape
```
```python
(
```
```python
n
```
```python
.
```
```python
labels
```
```python
,
```
```python
name
```
```python
=
```
```python
'reshape_labels'
```
```python
,
```
```python
reshape_param
```
```python
=
```
```python
{
```
```python
'shape'
```
```python
:
```
```python
{
```
```python
'dim'
```
```python
:
```
```python
[
```
```python
nframe
```
```python
,
```
```python
batchSize
```
```python
]
```
```python
}
```
```python
}
```
```python
)
```
```python
n
```
```python
.
```
```python
reshape_clipmarkers
```
```python
=
```
```python
L
```
```python
.
```
```python
Reshape
```
```python
(
```
```python
n
```
```python
.
```
```python
clip_markers
```
```python
,
```
```python
name
```
```python
=
```
```python
'reshape_clipmarkers'
```
```python
,
```
```python
reshape_param
```
```python
=
```
```python
{
```
```python
'shape'
```
```python
:
```
```python
{
```
```python
'dim'
```
```python
:
```
```python
[
```
```python
nframe
```
```python
,
```
```python
batchSize
```
```python
]
```
```python
}
```
```python
}
```
```python
)
```
```python
n
```
```python
.
```
```python
lstm1
```
```python
=
```
```python
L
```
```python
.
```
```python
LSTM
```
```python
(
```
```python
n
```
```python
.
```
```python
reshape_data
```
```python
,
```
```python
n
```
```python
.
```
```python
reshape_clipmarkers
```
```python
,
```
```python
name
```
```python
=
```
```python
'lstm1'
```
```python
,
```
```python
recurrent_param
```
```python
=
```
```python
{
```
```python
'num_output'
```
```python
:
```
```python
64
```
```python
,
```
```python
'weight_filler'
```
```python
:
```
```python
{
```
```python
'type'
```
```python
:
```
```python
'uniform'
```
```python
,
```
```python
'min'
```
```python
:
```
```python
-
```
```python
0.01
```
```python
,
```
```python
'max'
```
```python
:
```
```python
0.01
```
```python
}
```
```python
,
```
```python
'bias_filler'
```
```python
:
```
```python
{
```
```python
'type'
```
```python
:
```
```python
'constant'
```
```python
,
```
```python
'value'
```
```python
:
```
```python
0
```
```python
}
```
```python
}
```
```python
)
```
```python
# the output of lstm convert to
```
```python
if
```
```python
type1
```
```python
==
```
```python
'using_last_frame_compute_loss'
```
```python
:
```
```python
n
```
```python
.
```
```python
last_frame_data
```
```python
=
```
```python
L
```
```python
.
```
```python
Python
```
```python
(
```
```python
n
```
```python
.
```
```python
lstm1
```
```python
,
```
```python
name
```
```python
=
```
```python
'last_frame_data'
```
```python
,
```
```python
ntop
```
```python
=
```
```python
1
```
```python
,
```
```python
python_param
```
```python
=
```
```python
dict
```
```python
(
```
```python
module
```
```python
=
```
```python
'data_separate_for_mnist'
```
```python
,
```
```python
layer
```
```python
=
```
```python
'data_separate'
```
```python
)
```
```python
,
```
```python
propagate_down
```
```python
=
```
```python
[
```
```python
1
```
```python
]
```
```python
)
```
```python
# for main tasks
```
```python
n
```
```python
.
```
```python
last_frame_label
```
```python
=
```
```python
L
```
```python
.
```
```python
Python
```
```python
(
```
```python
n
```
```python
.
```
```python
reshape_labels
```
```python
,
```
```python
name
```
```python
=
```
```python
'last_frame_label'
```
```python
,
```
```python
ntop
```
```python
=
```
```python
1
```
```python
,
```
```python
python_param
```
```python
=
```
```python
dict
```
```python
(
```
```python
module
```
```python
=
```
```python
'label_separate_for_mnist'
```
```python
,
```
```python
layer
```
```python
=
```
```python
'label_separate'
```
```python
)
```
```python
,
```
```python
propagate_down
```
```python
=
```
```python
[
```
```python
0
```
```python
]
```
```python
)
```
```python
# for main tasks
```
```python
n
```
```python
.
```
```python
fc1
```
```python
=
```
```python
L
```
```python
.
```
```python
InnerProduct
```
```python
(
```
```python
n
```
```python
.
```
```python
last_frame_data
```
```python
,
```
```python
name
```
```python
=
```
```python
'fc1'
```
```python
,
```
```python
num_output
```
```python
=
```
```python
nclass
```
```python
,
```
```python
weight_filler
```
```python
=
```
```python
dict
```
```python
(
```
```python
type
```
```python
=
```
```python
'xavier'
```
```python
,
```
```python
std
```
```python
=
```
```python
0.005
```
```python
)
```
```python
,
```
```python
bias_filler
```
```python
=
```
```python
dict
```
```python
(
```
```python
type
```
```python
=
```
```python
'constant'
```
```python
,
```
```python
value
```
```python
=
```
```python
0.1
```
```python
)
```
```python
,
```
```python
param
```
```python
=
```
```python
[
```
```python
dict
```
```python
(
```
```python
lr_mult
```
```python
=
```
```python
1
```
```python
,
```
```python
decay_mult
```
```python
=
```
```python
1
```
```python
)
```
```python
,
```
```python
dict
```
```python
(
```
```python
lr_mult
```
```python
=
```
```python
2
```
```python
,
```
```python
decay_mult
```
```python
=
```
```python
0
```
```python
)
```
```python
]
```
```python
)
```
```python
n
```
```python
.
```
```python
prob
```
```python
=
```
```python
L
```
```python
.
```
```python
Softmax
```
```python
(
```
```python
n
```
```python
.
```
```python
fc1
```
```python
,
```
```python
name
```
```python
=
```
```python
'prob'
```
```python
,
```
```python
)
```
```python
#n.loss = L.SoftmaxWithLoss(n.fc1,n.last_frame_label,
```
```python
#                                   name='loss',ntop=1)
```
```python
elif
```
```python
type1
```
```python
==
```
```python
'using_all_frame_compute_loss'
```
```python
:
```
```python
n
```
```python
.
```
```python
fc1
```
```python
=
```
```python
L
```
```python
.
```
```python
InnerProduct
```
```python
(
```
```python
n
```
```python
.
```
```python
lstm1
```
```python
,
```
```python
name
```
```python
=
```
```python
'fc1'
```
```python
,
```
```python
num_output
```
```python
=
```
```python
nclass
```
```python
,
```
```python
weight_filler
```
```python
=
```
```python
dict
```
```python
(
```
```python
type
```
```python
=
```
```python
'xavier'
```
```python
,
```
```python
std
```
```python
=
```
```python
0.005
```
```python
)
```
```python
,
```
```python
bias_filler
```
```python
=
```
```python
dict
```
```python
(
```
```python
type
```
```python
=
```
```python
'constant'
```
```python
,
```
```python
value
```
```python
=
```
```python
0.1
```
```python
)
```
```python
,
```
```python
param
```
```python
=
```
```python
[
```
```python
dict
```
```python
(
```
```python
lr_mult
```
```python
=
```
```python
1
```
```python
,
```
```python
decay_mult
```
```python
=
```
```python
1
```
```python
)
```
```python
,
```
```python
dict
```
```python
(
```
```python
lr_mult
```
```python
=
```
```python
2
```
```python
,
```
```python
decay_mult
```
```python
=
```
```python
0
```
```python
)
```
```python
]
```
```python
,
```
```python
axis
```
```python
=
```
```python
2
```
```python
)
```
```python
n
```
```python
.
```
```python
prob
```
```python
=
```
```python
L
```
```python
.
```
```python
Softmax
```
```python
(
```
```python
n
```
```python
.
```
```python
fc1
```
```python
,
```
```python
name
```
```python
=
```
```python
'prob'
```
```python
,
```
```python
softmax_param
```
```python
=
```
```python
{
```
```python
'axis'
```
```python
:
```
```python
2
```
```python
}
```
```python
)
```
```python
#n.loss = L.SoftmaxWithLoss(n.fc1,n.reshape_labels,
```
```python
#                                   name='loss',ntop=1,softmax_param={'axis':2})
```
```python
return
```
```python
n
```
```python
.
```
```python
to_proto
```
```python
(
```
```python
)
```
```python
###########################################################
```
```python
nclass
```
```python
=
```
```python
10
```
```python
# mnist
```
```python
zoo_path
```
```python
=
```
```python
'ZOO_lstm/'
```
```python
model_root
```
```python
=
```
```python
'snapshots_lstm_for_mnist/'
```
```python
pretrained_weight
```
```python
=
```
```python
None
```
```python
trainSource
```
```python
=
```
```python
None
```
```python
snapshot
```
```python
=
```
```python
1000000
```
```python
# not use
```
```python
niter
```
```python
=
```
```python
10000
```
```python
#5000
```
```python
snap_interval
```
```python
=
```
```python
2000
```
```python
isShow
```
```python
=
```
```python
True
```
```python
batchSize
```
```python
=
```
```python
100
```
```python
nframe
```
```python
=
```
```python
28
```
```python
# imgSize[0]
```
```python
feat_len
```
```python
=
```
```python
28
```
```python
# imgSize[1]
```
```python
type1
```
```python
=
```
```python
'using_last_frame_compute_loss'
```
```python
# using_last_frame_compute_loss, using_all_frame_compute_loss
```
```python
##########################
```
```python
nstep
```
```python
=
```
```python
0
```
```python
with
```
```python
open
```
```python
(
```
```python
zoo_path
```
```python
+
```
```python
'deploy.prototxt'
```
```python
,
```
```python
'w'
```
```python
)
```
```python
as
```
```python
f
```
```python
:
```
```python
f
```
```python
.
```
```python
write
```
```python
(
```
```python
str
```
```python
(
```
```python
make_lstm_deploy
```
```python
(
```
```python
batchSize
```
```python
,
```
```python
nframe
```
```python
,
```
```python
feat_len
```
```python
,
```
```python
nclass
```
```python
,
```
```python
type1
```
```python
)
```
```python
)
```
```python
)
```
```python
ncross
```
```python
=
```
```python
1
```
```python
for
```
```python
nc
```
```python
in
```
```python
range
```
```python
(
```
```python
ncross
```
```python
)
```
```python
:
```
```python
test_sample_num
```
```python
=
```
```python
0
```
```python
data_obj
```
```python
=
```
```python
mnist
```
```python
.
```
```python
Mnist
```
```python
(
```
```python
nc
```
```python
)
```
```python
test_data
```
```python
=
```
```python
data_obj
```
```python
.
```
```python
test_data    
    ntest
```
```python
=
```
```python
data_obj
```
```python
.
```
```python
ntest
    
    labels
```
```python
=
```
```python
test_data
```
```python
[
```
```python
'labels'
```
```python
]
```
```python
datas
```
```python
=
```
```python
test_data
```
```python
[
```
```python
'datas'
```
```python
]
```
```python
test_sample_num
```
```python
=
```
```python
ntest
```
```python
assert
```
```python
(
```
```python
ntest
```
```python
==
```
```python
10000
```
```python
)
```
```python
iter_num
```
```python
=
```
```python
range
```
```python
(
```
```python
10000
```
```python
,
```
```python
10001
```
```python
,
```
```python
1000
```
```python
)
```
```python
# trained model
```
```python
iter_result
```
```python
=
```
```python
np
```
```python
.
```
```python
zeros
```
```python
(
```
```python
shape
```
```python
=
```
```python
(
```
```python
1
```
```python
,
```
```python
len
```
```python
(
```
```python
iter_num
```
```python
)
```
```python
)
```
```python
)
```
```python
inum
```
```python
=
```
```python
0
```
```python
for
```
```python
im
```
```python
in
```
```python
iter_num
```
```python
:
```
```python
#===========================================================================#
```
```python
weight_file
```
```python
=
```
```python
model_root
```
```python
+
```
```python
'cross'
```
```python
+
```
```python
str
```
```python
(
```
```python
nc
```
```python
+
```
```python
1
```
```python
)
```
```python
+
```
```python
'/vgg_iter_'
```
```python
+
```
```python
str
```
```python
(
```
```python
im
```
```python
)
```
```python
+
```
```python
'.caffemodel'
```
```python
deploy_pro
```
```python
=
```
```python
zoo_path
```
```python
+
```
```python
'/deploy.prototxt'
```
```python
#===========================================================================#
```
```python
print
```
```python
(
```
```python
'deploy_pro: '
```
```python
,
```
```python
deploy_pro
```
```python
)
```
```python
net
```
```python
=
```
```python
caffe
```
```python
.
```
```python
Net
```
```python
(
```
```python
deploy_pro
```
```python
,
```
```python
weight_file
```
```python
,
```
```python
caffe
```
```python
.
```
```python
TEST
```
```python
)
```
```python
cnt_num
```
```python
=
```
```python
0
```
```python
result_number
```
```python
=
```
```python
np
```
```python
.
```
```python
zeros
```
```python
(
```
```python
test_sample_num
```
```python
)
```
```python
result_number_probs
```
```python
=
```
```python
np
```
```python
.
```
```python
zeros
```
```python
(
```
```python
(
```
```python
test_sample_num
```
```python
,
```
```python
nclass
```
```python
)
```
```python
)
```
```python
count
```
```python
=
```
```python
0
```
```python
test_patchSize
```
```python
=
```
```python
batchSize
```
```python
#
```
```python
test_times
```
```python
=
```
```python
int32
```
```python
(
```
```python
ceil
```
```python
(
```
```python
datas
```
```python
.
```
```python
shape
```
```python
[
```
```python
0
```
```python
]
```
```python
/
```
```python
float32
```
```python
(
```
```python
test_patchSize
```
```python
)
```
```python
)
```
```python
)
```
```python
# true label
```
```python
for
```
```python
c
```
```python
in
```
```python
range
```
```python
(
```
```python
test_times
```
```python
)
```
```python
:
```
```python
start_ind
```
```python
=
```
```python
c
```
```python
*
```
```python
test_patchSize
```
```python
if
```
```python
c
```
```python
==
```
```python
test_times
```
```python
-
```
```python
1
```
```python
:
```
```python
end_ind
```
```python
=
```
```python
datas
```
```python
.
```
```python
shape
```
```python
[
```
```python
0
```
```python
]
```
```python
else
```
```python
:
```
```python
end_ind
```
```python
=
```
```python
(
```
```python
c
```
```python
+
```
```python
1
```
```python
)
```
```python
*
```
```python
test_patchSize 
            batchSize2
```
```python
=
```
```python
len
```
```python
(
```
```python
range
```
```python
(
```
```python
start_ind
```
```python
,
```
```python
end_ind
```
```python
)
```
```python
)
```
```python
true_labels
```
```python
=
```
```python
labels
```
```python
[
```
```python
start_ind
```
```python
:
```
```python
end_ind
```
```python
,
```
```python
.
```
```python
.
```
```python
.
```
```python
]
```
```python
test_features
```
```python
=
```
```python
datas
```
```python
[
```
```python
start_ind
```
```python
:
```
```python
end_ind
```
```python
,
```
```python
.
```
```python
.
```
```python
.
```
```python
]
```
```python
testLabels
```
```python
=
```
```python
np
```
```python
.
```
```python
zeros
```
```python
(
```
```python
shape
```
```python
=
```
```python
(
```
```python
batchSize2
```
```python
*
```
```python
nframe
```
```python
,
```
```python
1
```
```python
)
```
```python
,
```
```python
dtype
```
```python
=
```
```python
np
```
```python
.
```
```python
float32
```
```python
)
```
```python
# train_features.shape = [T,N,H,W]
```
```python
testFeatures
```
```python
=
```
```python
np
```
```python
.
```
```python
zeros
```
```python
(
```
```python
shape
```
```python
=
```
```python
(
```
```python
batchSize2
```
```python
*
```
```python
nframe
```
```python
,
```
```python
feat_len
```
```python
)
```
```python
,
```
```python
dtype
```
```python
=
```
```python
np
```
```python
.
```
```python
float32
```
```python
)
```
```python
# train_clipmarks.shape = [T,N,H,W]
```
```python
testClipmarks
```
```python
=
```
```python
np
```
```python
.
```
```python
ones
```
```python
(
```
```python
shape
```
```python
=
```
```python
(
```
```python
batchSize2
```
```python
*
```
```python
nframe
```
```python
,
```
```python
1
```
```python
)
```
```python
,
```
```python
dtype
```
```python
=
```
```python
np
```
```python
.
```
```python
float32
```
```python
)
```
```python
for
```
```python
i
```
```python
in
```
```python
range
```
```python
(
```
```python
nframe
```
```python
)
```
```python
:
```
```python
for
```
```python
j
```
```python
in
```
```python
range
```
```python
(
```
```python
batchSize2
```
```python
)
```
```python
:
```
```python
# the first img 28 * 28  H, W
```
```python
img
```
```python
=
```
```python
test_features
```
```python
[
```
```python
j
```
```python
,
```
```python
:
```
```python
,
```
```python
:
```
```python
]
```
```python
label
```
```python
=
```
```python
true_labels
```
```python
[
```
```python
j
```
```python
,
```
```python
:
```
```python
]
```
```python
frame
```
```python
=
```
```python
img
```
```python
[
```
```python
i
```
```python
,
```
```python
:
```
```python
]
```
```python
testFeatures
```
```python
[
```
```python
i
```
```python
*
```
```python
batchSize2
```
```python
+
```
```python
j
```
```python
,
```
```python
:
```
```python
]
```
```python
=
```
```python
frame
                    testLabels
```
```python
[
```
```python
i
```
```python
*
```
```python
batchSize2
```
```python
+
```
```python
j
```
```python
,
```
```python
:
```
```python
]
```
```python
=
```
```python
label
```
```python
if
```
```python
j
```
```python
==
```
```python
0
```
```python
:
```
```python
testClipmarks
```
```python
[
```
```python
i
```
```python
*
```
```python
batchSize2
```
```python
+
```
```python
j
```
```python
,
```
```python
:
```
```python
]
```
```python
=
```
```python
0
```
```python
# forward net
```
```python
net
```
```python
.
```
```python
blobs
```
```python
[
```
```python
'data'
```
```python
]
```
```python
.
```
```python
reshape
```
```python
(
```
```python
batchSize2
```
```python
*
```
```python
nframe
```
```python
,
```
```python
feat_len
```
```python
)
```
```python
net
```
```python
.
```
```python
blobs
```
```python
[
```
```python
'clip_markers'
```
```python
]
```
```python
.
```
```python
reshape
```
```python
(
```
```python
batchSize2
```
```python
*
```
```python
nframe
```
```python
,
```
```python
1
```
```python
)
```
```python
net
```
```python
.
```
```python
blobs
```
```python
[
```
```python
'data'
```
```python
]
```
```python
.
```
```python
data
```
```python
[
```
```python
.
```
```python
.
```
```python
.
```
```python
]
```
```python
=
```
```python
testFeatures
            net
```
```python
.
```
```python
blobs
```
```python
[
```
```python
'clip_markers'
```
```python
]
```
```python
.
```
```python
data
```
```python
[
```
```python
.
```
```python
.
```
```python
.
```
```python
]
```
```python
=
```
```python
testClipmarks
```
```python
#plt.imshow(testFeatures)
```
```python
#plt.show()
```
```python
output
```
```python
=
```
```python
net
```
```python
.
```
```python
forward
```
```python
(
```
```python
)
```
```python
probs
```
```python
=
```
```python
output
```
```python
[
```
```python
'prob'
```
```python
]
```
```python
# get predict labels
```
```python
if
```
```python
type1
```
```python
!=
```
```python
'using_all_frame_compute_loss'
```
```python
and
```
```python
type1
```
```python
!=
```
```python
'using_last_frame_compute_loss'
```
```python
:
```
```python
raise
```
```python
Exception
```
```python
(
```
```python
'please input correct type1...'
```
```python
)
```
```python
if
```
```python
type1
```
```python
==
```
```python
'using_all_frame_compute_loss'
```
```python
:
```
```python
probs
```
```python
=
```
```python
probs
```
```python
[
```
```python
nframe
```
```python
-
```
```python
1
```
```python
,
```
```python
:
```
```python
,
```
```python
:
```
```python
]
```
```python
predict_labels
```
```python
=
```
```python
probs
```
```python
.
```
```python
argmax
```
```python
(
```
```python
1
```
```python
)
```
```python
#
```
```python
i
```
```python
=
```
```python
0
```
```python
isShow
```
```python
=
```
```python
False
```
```python
for
```
```python
j
```
```python
in
```
```python
arange
```
```python
(
```
```python
start_ind
```
```python
,
```
```python
end_ind
```
```python
)
```
```python
:
```
```python
predict_label
```
```python
=
```
```python
predict_labels
```
```python
[
```
```python
i
```
```python
]
```
```python
true_label
```
```python
=
```
```python
true_labels
```
```python
[
```
```python
i
```
```python
]
```
```python
result_number
```
```python
[
```
```python
count
```
```python
]
```
```python
=
```
```python
predict_label
```
```python
print
```
```python
(
```
```python
'headpose: '
```
```python
,
```
```python
predict_label
```
```python
,
```
```python
true_label
```
```python
)
```
```python
#
```
```python
if
```
```python
predict_label
```
```python
==
```
```python
true_label
```
```python
:
```
```python
cnt_num
```
```python
+=
```
```python
1
```
```python
i
```
```python
+=
```
```python
1
```
```python
count
```
```python
+=
```
```python
1
```
```python
print
```
```python
(
```
```python
"iter"
```
```python
,
```
```python
c
```
```python
,
```
```python
'predict over...'
```
```python
)
```
```python
print
```
```python
(
```
```python
'cnt_mnist: '
```
```python
,
```
```python
cnt_num
```
```python
,
```
```python
';total:'
```
```python
,
```
```python
test_sample_num
```
```python
)
```
```python
print
```
```python
(
```
```python
'the accuracy: '
```
```python
,
```
```python
cnt_num
```
```python
*
```
```python
1.0
```
```python
/
```
```python
test_sample_num
```
```python
)
```
```python
iter_result
```
```python
[
```
```python
0
```
```python
,
```
```python
inum
```
```python
]
```
```python
=
```
```python
cnt_num
```
```python
*
```
```python
1.0
```
```python
/
```
```python
test_sample_num 
        inum
```
```python
+=
```
```python
1
```
```python
#统计测试模型的次数
```
```python
ir
```
```python
=
```
```python
0
```
```python
for
```
```python
im
```
```python
in
```
```python
iter_num
```
```python
:
```
```python
print
```
```python
(
```
```python
'mnist: '
```
```python
,
```
```python
str
```
```python
(
```
```python
im
```
```python
)
```
```python
,
```
```python
' :'
```
```python
,
```
```python
iter_result
```
```python
[
```
```python
0
```
```python
,
```
```python
ir
```
```python
]
```
```python
)
```
```python
ir
```
```python
+=
```
```python
1
```
![在这里插入图片描述](https://img-blog.csdnimg.cn/20190315211551980.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3h1bHVodWkxMjM=,size_16,color_FFFFFF,t_70)
**结果**：我们训练模型10k次，在10000个测试样本上的识别为：91.33%。

