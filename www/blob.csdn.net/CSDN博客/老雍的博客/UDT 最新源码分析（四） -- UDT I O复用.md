
# UDT 最新源码分析（四） -- UDT I-O复用 - 老雍的博客 - CSDN博客


2019年01月28日 23:00:28[老雍](https://me.csdn.net/yongkai0214)阅读数：110



### UDT 最新源码分析 -- UDT I/O复用
[UDT I/O 复用](#UDT_IO__1)
[传统的网络I/O复用机制](#IO_7)
[UDT epoll 方法](#UDT_epoll__79)
[UDT epoll 在流程中使用](#UDT_epoll__212)
[总结](#_345)

# UDT I/O 复用
在前一篇文章中描述 UDT socket 的最前面提到了 UDT epoll，但是并没有分析其源码。在这篇文章中将集中分析 UDT 中的网络I/O复用的源码，看看与传统的 select 和 epoll 是否有什么不同。
I/O 复用的文章与例子很多，有时间可以再写介绍。常见的I/O多路复用技术有 select 和 epoll，还有 windows 中常用的 IOCP，它们的的出现的唯一目的就是解决大量I/O操作时的阻塞问题，使得可以在 I/O 可用时及时得到通知，例如服务器上大量并发连接进行网络通信场景。
## 传统的网络I/O复用机制
Select 的问题有两点，一是连接具有数量上限，二是轮询带来的循环开销，更重要的问题是每次调用 select 都需要向操作系统传递监视对象信息。为了解决每次调用都需要系统中断的问题，才有了更进一步的解决方案，比如 windows 下的 IOCP, linux 下的 epoll等，这种处理方式必须操作系统支持，支持的方式与力度不同也带来不同的方案，当然其中 IOCP 属于更彻底的异步方式。
Select 在连接数量较少，或者需要程序保持跨平台的兼容性时其实也是具有优势的。select 为 POSIX 标准中的，而 epoll 为 linux 所特有的。不管是 select 还是 epoll 使用I/O复用也并非是提高每路连接的效率，更多的是为了支持大量连接的并发处理。
Epoll 中最重要的三个函数，
> epoll_create: 创建保存 epoll 文件描述符空间；

> epoll_ctl: 向空间注册并操作文件描述符；

> epoll_wait: 等待文件描述符发生变化。
Select 中直接声明了 fd_set，用来保存监视对象文件描述符。epoll 则通过epoll_create 向操作系统申请创建保存文件描述符的空间。为了添加或删除监视对象文件描述符，select 通过 FD_SET，FD_CLR 函数实现，epoll 则通过 epoll_ctl 实现，通过操作符请求操作系统完成操作。select 通过遍历 fd_set 变量查看监视对象是否有事件发生，epoll 则是通过 epoll_event 汇聚发生变化的文件描述符。
epoll event op:
> EPOLL_CTL_ADD
> Register the target file descriptor fd on the epoll instance referred to by the file descriptor epfd and associate the event event with the internal file linked to fd.

> EPOLL_CTL_MOD
> Change the event event associated with the target file descriptor fd.

> EPOLL_CTL_DEL
> Remove (deregister) the target file descriptor fd from the epoll instance referred to by epfd.  The event is ignored and can be NULL (but see BUGS below).

使用示例：
```python
#
```
```python
define
```
```python
MAX_EVENTS 10
```
```python
struct
```
```python
epoll_event ev
```
```python
,
```
```python
events
```
```python
[
```
```python
MAX_EVENTS
```
```python
]
```
```python
;
```
```python
int
```
```python
listen_sock
```
```python
,
```
```python
conn_sock
```
```python
,
```
```python
nfds
```
```python
,
```
```python
epollfd
```
```python
;
```
```python
/* Code to set up listening socket, 'listen_sock',
(socket(), bind(), listen()) omitted */
```
```python
epollfd
```
```python
=
```
```python
epoll_create1
```
```python
(
```
```python
0
```
```python
)
```
```python
;
```
```python
if
```
```python
(
```
```python
epollfd
```
```python
==
```
```python
-
```
```python
1
```
```python
)
```
```python
{
```
```python
perror
```
```python
(
```
```python
"epoll_create1"
```
```python
)
```
```python
;
```
```python
exit
```
```python
(
```
```python
EXIT_FAILURE
```
```python
)
```
```python
;
```
```python
}
```
```python
ev
```
```python
.
```
```python
events
```
```python
=
```
```python
EPOLLIN
```
```python
;
```
```python
ev
```
```python
.
```
```python
data
```
```python
.
```
```python
fd
```
```python
=
```
```python
listen_sock
```
```python
;
```
```python
if
```
```python
(
```
```python
epoll_ctl
```
```python
(
```
```python
epollfd
```
```python
,
```
```python
EPOLL_CTL_ADD
```
```python
,
```
```python
listen_sock
```
```python
,
```
```python
&
```
```python
ev
```
```python
)
```
```python
==
```
```python
-
```
```python
1
```
```python
)
```
```python
{
```
```python
perror
```
```python
(
```
```python
"epoll_ctl: listen_sock"
```
```python
)
```
```python
;
```
```python
exit
```
```python
(
```
```python
EXIT_FAILURE
```
```python
)
```
```python
;
```
```python
}
```
```python
for
```
```python
(
```
```python
;
```
```python
;
```
```python
)
```
```python
{
```
```python
nfds
```
```python
=
```
```python
epoll_wait
```
```python
(
```
```python
epollfd
```
```python
,
```
```python
events
```
```python
,
```
```python
MAX_EVENTS
```
```python
,
```
```python
-
```
```python
1
```
```python
)
```
```python
;
```
```python
if
```
```python
(
```
```python
nfds
```
```python
==
```
```python
-
```
```python
1
```
```python
)
```
```python
{
```
```python
perror
```
```python
(
```
```python
"epoll_wait"
```
```python
)
```
```python
;
```
```python
exit
```
```python
(
```
```python
EXIT_FAILURE
```
```python
)
```
```python
;
```
```python
}
```
```python
for
```
```python
(
```
```python
n
```
```python
=
```
```python
0
```
```python
;
```
```python
n
```
```python
<
```
```python
nfds
```
```python
;
```
```python
++
```
```python
n
```
```python
)
```
```python
{
```
```python
if
```
```python
(
```
```python
events
```
```python
[
```
```python
n
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
fd
```
```python
==
```
```python
listen_sock
```
```python
)
```
```python
{
```
```python
conn_sock
```
```python
=
```
```python
accept
```
```python
(
```
```python
listen_sock
```
```python
,
```
```python
(
```
```python
struct
```
```python
sockaddr
```
```python
*
```
```python
)
```
```python
&
```
```python
addr
```
```python
,
```
```python
&
```
```python
addrlen
```
```python
)
```
```python
;
```
```python
if
```
```python
(
```
```python
conn_sock
```
```python
==
```
```python
-
```
```python
1
```
```python
)
```
```python
{
```
```python
perror
```
```python
(
```
```python
"accept"
```
```python
)
```
```python
;
```
```python
exit
```
```python
(
```
```python
EXIT_FAILURE
```
```python
)
```
```python
;
```
```python
}
```
```python
setnonblocking
```
```python
(
```
```python
conn_sock
```
```python
)
```
```python
;
```
```python
ev
```
```python
.
```
```python
events
```
```python
=
```
```python
EPOLLIN
```
```python
|
```
```python
EPOLLET
```
```python
;
```
```python
ev
```
```python
.
```
```python
data
```
```python
.
```
```python
fd
```
```python
=
```
```python
conn_sock
```
```python
;
```
```python
if
```
```python
(
```
```python
epoll_ctl
```
```python
(
```
```python
epollfd
```
```python
,
```
```python
EPOLL_CTL_ADD
```
```python
,
```
```python
conn_sock
```
```python
,
```
```python
&
```
```python
ev
```
```python
)
```
```python
==
```
```python
-
```
```python
1
```
```python
)
```
```python
{
```
```python
perror
```
```python
(
```
```python
"epoll_ctl: conn_sock"
```
```python
)
```
```python
;
```
```python
exit
```
```python
(
```
```python
EXIT_FAILURE
```
```python
)
```
```python
;
```
```python
}
```
```python
}
```
```python
else
```
```python
{
```
```python
do_use_fd
```
```python
(
```
```python
events
```
```python
[
```
```python
n
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
fd
```
```python
)
```
```python
;
```
```python
}
```
```python
}
```
```python
}
```
## UDT epoll 方法
> UDT::epoll_create -> CUDT::epoll_create -> CUDTUnited::epoll_create -> CEPoll::create
UDT epoll 的创建实际上就是系统的 epoll_create 函数，每次创建会生成一个 epoll 的描述结构，存入一个map中。其中有epoll本身的描述符，以及 epoll 的id，也是在map中的key。
```python
int
```
```python
CEPoll
```
```python
::
```
```python
create
```
```python
(
```
```python
)
```
```python
{
```
```python
CGuard
```
```python
pg
```
```python
(
```
```python
m_EPollLock
```
```python
)
```
```python
;
```
```python
int
```
```python
localid
```
```python
=
```
```python
0
```
```python
;
```
```python
#
```
```python
ifdef
```
```python
LINUX
```
```python
localid
```
```python
=
```
```python
epoll_create
```
```python
(
```
```python
1024
```
```python
)
```
```python
;
```
```python
//创建 epoll 例程
```
```python
if
```
```python
(
```
```python
localid
```
```python
<
```
```python
0
```
```python
)
```
```python
throw
```
```python
CUDTException
```
```python
(
```
```python
-
```
```python
1
```
```python
,
```
```python
0
```
```python
,
```
```python
errno
```
```python
)
```
```python
;
```
```python
#
```
```python
else
```
```python
// on BSD, use kqueue
```
```python
// on Solaris, use /dev/poll
```
```python
// on Windows, select
```
```python
#
```
```python
endif
```
```python
if
```
```python
(
```
```python
++
```
```python
m_iIDSeed
```
```python
>=
```
```python
0x7FFFFFFF
```
```python
)
```
```python
//每次累加，实际就是后面的 m_iID
```
```python
m_iIDSeed
```
```python
=
```
```python
0
```
```python
;
```
```python
CEPollDesc desc
```
```python
;
```
```python
desc
```
```python
.
```
```python
m_iID
```
```python
=
```
```python
m_iIDSeed
```
```python
;
```
```python
desc
```
```python
.
```
```python
m_iLocalID
```
```python
=
```
```python
localid
```
```python
;
```
```python
//epoll 的文件描述符
```
```python
m_mPolls
```
```python
[
```
```python
desc
```
```python
.
```
```python
m_iID
```
```python
]
```
```python
=
```
```python
desc
```
```python
;
```
```python
//保存epoll信息存入map，非指针
```
```python
return
```
```python
desc
```
```python
.
```
```python
m_iID
```
```python
;
```
```python
}
```
> CUDT::epoll_add_usock -> CUDTUnited::epoll_add_usock -> CEPoll::add_usock

> CUDT::epoll_add_ssock -> CUDTUnited::epoll_add_ssock -> CEPoll::add_ssock

> CUDT::epoll_remove_ssock -> CUDTUnited::epoll_remove_ssock -> CEPoll::remove_ssock

> CUDT::epoll_remove_ssock -> CUDTUnited::epoll_remove_ssock -> CEPoll::remove_ssock
UDT epoll 中有系统 socket 与 UDT socket 两种，分别进行处理。ssock 与传统的 epoll 一致，所以这里主要针对 usock。remove 是 add 的逆操作，也不再描述。
```python
int
```
```python
CUDTUnited
```
```python
::
```
```python
epoll_add_usock
```
```python
(
```
```python
const
```
```python
int
```
```python
eid
```
```python
,
```
```python
const
```
```python
UDTSOCKET u
```
```python
,
```
```python
const
```
```python
int
```
```python
*
```
```python
events
```
```python
)
```
```python
{
```
```python
CUDTSocket
```
```python
*
```
```python
s
```
```python
=
```
```python
locate
```
```python
(
```
```python
u
```
```python
)
```
```python
;
```
```python
int
```
```python
ret
```
```python
=
```
```python
-
```
```python
1
```
```python
;
```
```python
if
```
```python
(
```
```python
NULL
```
```python
!=
```
```python
s
```
```python
)
```
```python
{
```
```python
ret
```
```python
=
```
```python
m_EPoll
```
```python
.
```
```python
add_usock
```
```python
(
```
```python
eid
```
```python
,
```
```python
u
```
```python
,
```
```python
events
```
```python
)
```
```python
;
```
```python
s
```
```python
-
```
```python
>
```
```python
m_pUDT
```
```python
-
```
```python
>
```
```python
addEPoll
```
```python
(
```
```python
eid
```
```python
)
```
```python
;
```
```python
}
```
```python
else
```
```python
{
```
```python
throw
```
```python
CUDTException
```
```python
(
```
```python
5
```
```python
,
```
```python
4
```
```python
)
```
```python
;
```
```python
}
```
```python
return
```
```python
ret
```
```python
;
```
```python
}
```
add_usock 根据事件的类型决定加入哪一个集合。
```python
int
```
```python
CEPoll
```
```python
::
```
```python
add_usock
```
```python
(
```
```python
const
```
```python
int
```
```python
eid
```
```python
,
```
```python
const
```
```python
UDTSOCKET
```
```python
&
```
```python
u
```
```python
,
```
```python
const
```
```python
int
```
```python
*
```
```python
events
```
```python
)
```
```python
{
```
```python
CGuard
```
```python
pg
```
```python
(
```
```python
m_EPollLock
```
```python
)
```
```python
;
```
```python
map
```
```python
<
```
```python
int
```
```python
,
```
```python
CEPollDesc
```
```python
>
```
```python
::
```
```python
iterator p
```
```python
=
```
```python
m_mPolls
```
```python
.
```
```python
find
```
```python
(
```
```python
eid
```
```python
)
```
```python
;
```
```python
if
```
```python
(
```
```python
p
```
```python
==
```
```python
m_mPolls
```
```python
.
```
```python
end
```
```python
(
```
```python
)
```
```python
)
```
```python
throw
```
```python
CUDTException
```
```python
(
```
```python
5
```
```python
,
```
```python
13
```
```python
)
```
```python
;
```
```python
if
```
```python
(
```
```python
!
```
```python
events
```
```python
||
```
```python
(
```
```python
*
```
```python
events
```
```python
&
```
```python
UDT_EPOLL_IN
```
```python
)
```
```python
)
```
```python
p
```
```python
-
```
```python
>
```
```python
second
```
```python
.
```
```python
m_sUDTSocksIn
```
```python
.
```
```python
insert
```
```python
(
```
```python
u
```
```python
)
```
```python
;
```
```python
if
```
```python
(
```
```python
!
```
```python
events
```
```python
||
```
```python
(
```
```python
*
```
```python
events
```
```python
&
```
```python
UDT_EPOLL_OUT
```
```python
)
```
```python
)
```
```python
p
```
```python
-
```
```python
>
```
```python
second
```
```python
.
```
```python
m_sUDTSocksOut
```
```python
.
```
```python
insert
```
```python
(
```
```python
u
```
```python
)
```
```python
;
```
```python
return
```
```python
0
```
```python
;
```
```python
}
```
addEPoll 首先将epool 的 id 插入 m_sPollID map, 根据 buffer 中的数据更新事件。
```python
void
```
```python
CUDT
```
```python
::
```
```python
addEPoll
```
```python
(
```
```python
const
```
```python
int
```
```python
eid
```
```python
)
```
```python
{
```
```python
CGuard
```
```python
::
```
```python
enterCS
```
```python
(
```
```python
s_UDTUnited
```
```python
.
```
```python
m_EPoll
```
```python
.
```
```python
m_EPollLock
```
```python
)
```
```python
;
```
```python
m_sPollID
```
```python
.
```
```python
insert
```
```python
(
```
```python
eid
```
```python
)
```
```python
;
```
```python
CGuard
```
```python
::
```
```python
leaveCS
```
```python
(
```
```python
s_UDTUnited
```
```python
.
```
```python
m_EPoll
```
```python
.
```
```python
m_EPollLock
```
```python
)
```
```python
;
```
```python
if
```
```python
(
```
```python
!
```
```python
m_bConnected
```
```python
||
```
```python
m_bBroken
```
```python
||
```
```python
m_bClosing
```
```python
)
```
```python
return
```
```python
;
```
```python
if
```
```python
(
```
```python
(
```
```python
(
```
```python
UDT_STREAM
```
```python
==
```
```python
m_iSockType
```
```python
)
```
```python
&&
```
```python
(
```
```python
m_pRcvBuffer
```
```python
-
```
```python
>
```
```python
getRcvDataSize
```
```python
(
```
```python
)
```
```python
>
```
```python
0
```
```python
)
```
```python
)
```
```python
||
```
```python
(
```
```python
(
```
```python
UDT_DGRAM
```
```python
==
```
```python
m_iSockType
```
```python
)
```
```python
&&
```
```python
(
```
```python
m_pRcvBuffer
```
```python
-
```
```python
>
```
```python
getRcvMsgNum
```
```python
(
```
```python
)
```
```python
>
```
```python
0
```
```python
)
```
```python
)
```
```python
)
```
```python
{
```
```python
s_UDTUnited
```
```python
.
```
```python
m_EPoll
```
```python
.
```
```python
update_events
```
```python
(
```
```python
m_SocketID
```
```python
,
```
```python
m_sPollID
```
```python
,
```
```python
UDT_EPOLL_IN
```
```python
,
```
```python
true
```
```python
)
```
```python
;
```
```python
}
```
```python
if
```
```python
(
```
```python
m_iSndBufSize
```
```python
>
```
```python
m_pSndBuffer
```
```python
-
```
```python
>
```
```python
getCurrBufSize
```
```python
(
```
```python
)
```
```python
)
```
```python
{
```
```python
s_UDTUnited
```
```python
.
```
```python
m_EPoll
```
```python
.
```
```python
update_events
```
```python
(
```
```python
m_SocketID
```
```python
,
```
```python
m_sPollID
```
```python
,
```
```python
UDT_EPOLL_OUT
```
```python
,
```
```python
true
```
```python
)
```
```python
;
```
```python
}
```
```python
}
```
UDT 的 update_events 更新事件实际上就是根据事件的类型，在 CEPollDesc 内部对应的 socket set 中对应插入。比如 UDT_EPOLL_IN 对应 m_sUDTReads，UDT_EPOLL_OUT 对应 m_sUDTWrites， UDT_EPOLL_ERR 对应 m_sUDTExcepts。 enable 如果为真，则插入，否则删除。
```python
int
```
```python
CEPoll
```
```python
::
```
```python
update_events
```
```python
(
```
```python
const
```
```python
UDTSOCKET
```
```python
&
```
```python
uid
```
```python
,
```
```python
std
```
```python
::
```
```python
set
```
```python
<
```
```python
int
```
```python
>
```
```python
&
```
```python
eids
```
```python
,
```
```python
int
```
```python
events
```
```python
,
```
```python
bool
```
```python
enable
```
```python
)
```
```python
{
```
```python
CGuard
```
```python
pg
```
```python
(
```
```python
m_EPollLock
```
```python
)
```
```python
;
```
```python
map
```
```python
<
```
```python
int
```
```python
,
```
```python
CEPollDesc
```
```python
>
```
```python
::
```
```python
iterator p
```
```python
;
```
```python
vector
```
```python
<
```
```python
int
```
```python
>
```
```python
lost
```
```python
;
```
```python
for
```
```python
(
```
```python
set
```
```python
<
```
```python
int
```
```python
>
```
```python
::
```
```python
iterator i
```
```python
=
```
```python
eids
```
```python
.
```
```python
begin
```
```python
(
```
```python
)
```
```python
;
```
```python
i
```
```python
!=
```
```python
eids
```
```python
.
```
```python
end
```
```python
(
```
```python
)
```
```python
;
```
```python
++
```
```python
i
```
```python
)
```
```python
{
```
```python
p
```
```python
=
```
```python
m_mPolls
```
```python
.
```
```python
find
```
```python
(
```
```python
*
```
```python
i
```
```python
)
```
```python
;
```
```python
if
```
```python
(
```
```python
p
```
```python
==
```
```python
m_mPolls
```
```python
.
```
```python
end
```
```python
(
```
```python
)
```
```python
)
```
```python
{
```
```python
lost
```
```python
.
```
```python
push_back
```
```python
(
```
```python
*
```
```python
i
```
```python
)
```
```python
;
```
```python
}
```
```python
else
```
```python
{
```
```python
if
```
```python
(
```
```python
(
```
```python
events
```
```python
&
```
```python
UDT_EPOLL_IN
```
```python
)
```
```python
!=
```
```python
0
```
```python
)
```
```python
update_epoll_sets
```
```python
(
```
```python
uid
```
```python
,
```
```python
p
```
```python
-
```
```python
>
```
```python
second
```
```python
.
```
```python
m_sUDTSocksIn
```
```python
,
```
```python
p
```
```python
-
```
```python
>
```
```python
second
```
```python
.
```
```python
m_sUDTReads
```
```python
,
```
```python
enable
```
```python
)
```
```python
;
```
```python
if
```
```python
(
```
```python
(
```
```python
events
```
```python
&
```
```python
UDT_EPOLL_OUT
```
```python
)
```
```python
!=
```
```python
0
```
```python
)
```
```python
update_epoll_sets
```
```python
(
```
```python
uid
```
```python
,
```
```python
p
```
```python
-
```
```python
>
```
```python
second
```
```python
.
```
```python
m_sUDTSocksOut
```
```python
,
```
```python
p
```
```python
-
```
```python
>
```
```python
second
```
```python
.
```
```python
m_sUDTWrites
```
```python
,
```
```python
enable
```
```python
)
```
```python
;
```
```python
if
```
```python
(
```
```python
(
```
```python
events
```
```python
&
```
```python
UDT_EPOLL_ERR
```
```python
)
```
```python
!=
```
```python
0
```
```python
)
```
```python
update_epoll_sets
```
```python
(
```
```python
uid
```
```python
,
```
```python
p
```
```python
-
```
```python
>
```
```python
second
```
```python
.
```
```python
m_sUDTSocksEx
```
```python
,
```
```python
p
```
```python
-
```
```python
>
```
```python
second
```
```python
.
```
```python
m_sUDTExcepts
```
```python
,
```
```python
enable
```
```python
)
```
```python
;
```
```python
}
```
```python
}
```
```python
for
```
```python
(
```
```python
vector
```
```python
<
```
```python
int
```
```python
>
```
```python
::
```
```python
iterator i
```
```python
=
```
```python
lost
```
```python
.
```
```python
begin
```
```python
(
```
```python
)
```
```python
;
```
```python
i
```
```python
!=
```
```python
lost
```
```python
.
```
```python
end
```
```python
(
```
```python
)
```
```python
;
```
```python
++
```
```python
i
```
```python
)
```
```python
eids
```
```python
.
```
```python
erase
```
```python
(
```
```python
*
```
```python
i
```
```python
)
```
```python
;
```
```python
return
```
```python
0
```
```python
;
```
```python
}
```
## UDT epoll 在流程中使用
新建立一个连接，把监听的 socket 加入 UDT socket 中 UDT 实例的  m_sPollID 中，等待连接到来。
```python
int
```
```python
CUDTUnited
```
```python
::
```
```python
newConnection
```
```python
(
```
```python
const
```
```python
UDTSOCKET listen
```
```python
,
```
```python
const
```
```python
sockaddr
```
```python
*
```
```python
peer
```
```python
,
```
```python
CHandShake
```
```python
*
```
```python
hs
```
```python
)
```
```python
{
```
```python
CUDTSocket
```
```python
*
```
```python
ns
```
```python
=
```
```python
NULL
```
```python
;
```
```python
CUDTSocket
```
```python
*
```
```python
ls
```
```python
=
```
```python
locate
```
```python
(
```
```python
listen
```
```python
)
```
```python
;
```
```python
.
```
```python
.
```
```python
.
```
```python
CGuard
```
```python
::
```
```python
enterCS
```
```python
(
```
```python
ls
```
```python
-
```
```python
>
```
```python
m_AcceptLock
```
```python
)
```
```python
;
```
```python
ls
```
```python
-
```
```python
>
```
```python
m_pQueuedSockets
```
```python
-
```
```python
>
```
```python
insert
```
```python
(
```
```python
ns
```
```python
-
```
```python
>
```
```python
m_SocketID
```
```python
)
```
```python
;
```
```python
CGuard
```
```python
::
```
```python
leaveCS
```
```python
(
```
```python
ls
```
```python
-
```
```python
>
```
```python
m_AcceptLock
```
```python
)
```
```python
;
```
```python
// acknowledge users waiting for new connections on the listening socket
```
```python
m_EPoll
```
```python
.
```
```python
update_events
```
```python
(
```
```python
listen
```
```python
,
```
```python
ls
```
```python
-
```
```python
>
```
```python
m_pUDT
```
```python
-
```
```python
>
```
```python
m_sPollID
```
```python
,
```
```python
UDT_EPOLL_IN
```
```python
,
```
```python
true
```
```python
)
```
```python
;
```
```python
CTimer
```
```python
::
```
```python
triggerEvent
```
```python
(
```
```python
)
```
```python
;
```
```python
return
```
```python
1
```
```python
;
```
```python
}
```
监听端口
Lisenter 在收到连接包以后，且验证通过，会建立新连接。建立连接后会通过 update_events 更新 m_sUDTWrites。
```python
int
```
```python
CUDT
```
```python
::
```
```python
listen
```
```python
(
```
```python
sockaddr
```
```python
*
```
```python
addr
```
```python
,
```
```python
CPacket
```
```python
&
```
```python
packet
```
```python
)
```
```python
{
```
```python
int32_t
```
```python
id
```
```python
=
```
```python
hs
```
```python
.
```
```python
m_iID
```
```python
;
```
```python
// When a peer side connects in...
```
```python
if
```
```python
(
```
```python
(
```
```python
1
```
```python
==
```
```python
packet
```
```python
.
```
```python
getFlag
```
```python
(
```
```python
)
```
```python
)
```
```python
&&
```
```python
(
```
```python
0
```
```python
==
```
```python
packet
```
```python
.
```
```python
getType
```
```python
(
```
```python
)
```
```python
)
```
```python
)
```
```python
{
```
```python
if
```
```python
(
```
```python
(
```
```python
hs
```
```python
.
```
```python
m_iVersion
```
```python
!=
```
```python
m_iVersion
```
```python
)
```
```python
||
```
```python
(
```
```python
hs
```
```python
.
```
```python
m_iType
```
```python
!=
```
```python
m_iSockType
```
```python
)
```
```python
)
```
```python
{
```
```python
.
```
```python
.
```
```python
.
```
```python
}
```
```python
else
```
```python
{
```
```python
int
```
```python
result
```
```python
=
```
```python
s_UDTUnited
```
```python
.
```
```python
newConnection
```
```python
(
```
```python
m_SocketID
```
```python
,
```
```python
addr
```
```python
,
```
```python
&
```
```python
hs
```
```python
)
```
```python
;
```
```python
if
```
```python
(
```
```python
result
```
```python
==
```
```python
-
```
```python
1
```
```python
)
```
```python
hs
```
```python
.
```
```python
m_iReqType
```
```python
=
```
```python
1002
```
```python
;
```
```python
// send back a response if connection failed or connection already existed
```
```python
// new connection response should be sent in connect()
```
```python
if
```
```python
(
```
```python
result
```
```python
!=
```
```python
1
```
```python
)
```
```python
{
```
```python
.
```
```python
.
```
```python
.
```
```python
}
```
```python
else
```
```python
{
```
```python
// a new connection has been created, enable epoll for write
```
```python
s_UDTUnited
```
```python
.
```
```python
m_EPoll
```
```python
.
```
```python
update_events
```
```python
(
```
```python
m_SocketID
```
```python
,
```
```python
m_sPollID
```
```python
,
```
```python
UDT_EPOLL_OUT
```
```python
,
```
```python
true
```
```python
)
```
```python
;
```
```python
}
```
```python
}
```
```python
}
```
```python
.
```
```python
.
```
```python
.
```
```python
}
```
connect
如果处于汇合模式或者连接已经成功，会转入 POST_CONNECT。
```python
int
```
```python
CUDT
```
```python
::
```
```python
connect
```
```python
(
```
```python
const
```
```python
CPacket
```
```python
&
```
```python
response
```
```python
)
```
```python
throw
```
```python
(
```
```python
)
```
```python
{
```
```python
// this is the 2nd half of a connection request. If the connection is setup successfully this returns 0.
```
```python
// returning -1 means there is an error.
```
```python
// returning 1 or 2 means the connection is in process and needs more handshake
```
```python
if
```
```python
(
```
```python
m_bRendezvous
```
```python
&&
```
```python
(
```
```python
(
```
```python
0
```
```python
==
```
```python
response
```
```python
.
```
```python
getFlag
```
```python
(
```
```python
)
```
```python
)
```
```python
||
```
```python
(
```
```python
1
```
```python
==
```
```python
response
```
```python
.
```
```python
getType
```
```python
(
```
```python
)
```
```python
)
```
```python
)
```
```python
&&
```
```python
(
```
```python
0
```
```python
!=
```
```python
m_ConnRes
```
```python
.
```
```python
m_iType
```
```python
)
```
```python
)
```
```python
{
```
```python
//a data packet or a keep-alive packet comes, which means the peer side is already connected
```
```python
// in this situation, the previously recorded response will be used
```
```python
goto
```
```python
POST_CONNECT
```
```python
;
```
```python
}
```
```python
.
```
```python
.
```
```python
.
```
```python
POST_CONNECT
```
```python
:
```
```python
.
```
```python
.
```
```python
.
```
```python
// And, I am connected too.
```
```python
m_bConnecting
```
```python
=
```
```python
false
```
```python
;
```
```python
m_bConnected
```
```python
=
```
```python
true
```
```python
;
```
```python
// register this socket for receiving data packets
```
```python
m_pRNode
```
```python
-
```
```python
>
```
```python
m_bOnList
```
```python
=
```
```python
true
```
```python
;
```
```python
m_pRcvQueue
```
```python
-
```
```python
>
```
```python
setNewEntry
```
```python
(
```
```python
this
```
```python
)
```
```python
;
```
```python
// acknowledge the management module.
```
```python
s_UDTUnited
```
```python
.
```
```python
connect_complete
```
```python
(
```
```python
m_SocketID
```
```python
)
```
```python
;
```
```python
// acknowledde any waiting epolls to write
```
```python
s_UDTUnited
```
```python
.
```
```python
m_EPoll
```
```python
.
```
```python
update_events
```
```python
(
```
```python
m_SocketID
```
```python
,
```
```python
m_sPollID
```
```python
,
```
```python
UDT_EPOLL_OUT
```
```python
,
```
```python
true
```
```python
)
```
```python
;
```
```python
return
```
```python
0
```
```python
;
```
```python
}
```
accept
如果连接请求被接收，将读取新的到来的数据，需要将 socket 加入到 m_sUDTReads 。
```python
UDTSOCKET CUDTUnited
```
```python
::
```
```python
accept
```
```python
(
```
```python
const
```
```python
UDTSOCKET listen
```
```python
,
```
```python
sockaddr
```
```python
*
```
```python
addr
```
```python
,
```
```python
int
```
```python
*
```
```python
addrlen
```
```python
)
```
```python
{
```
```python
bool
```
```python
accepted
```
```python
=
```
```python
false
```
```python
;
```
```python
// !!only one conection can be set up each time!!
```
```python
.
```
```python
.
```
```python
.
```
```python
while
```
```python
(
```
```python
!
```
```python
accepted
```
```python
)
```
```python
{
```
```python
if
```
```python
(
```
```python
!
```
```python
accepted
```
```python
&&
```
```python
(
```
```python
LISTENING
```
```python
==
```
```python
ls
```
```python
-
```
```python
>
```
```python
m_Status
```
```python
)
```
```python
)
```
```python
pthread_cond_wait
```
```python
(
```
```python
&
```
```python
(
```
```python
ls
```
```python
-
```
```python
>
```
```python
m_AcceptCond
```
```python
)
```
```python
,
```
```python
&
```
```python
(
```
```python
ls
```
```python
-
```
```python
>
```
```python
m_AcceptLock
```
```python
)
```
```python
)
```
```python
;
```
```python
if
```
```python
(
```
```python
ls
```
```python
-
```
```python
>
```
```python
m_pQueuedSockets
```
```python
-
```
```python
>
```
```python
empty
```
```python
(
```
```python
)
```
```python
)
```
```python
m_EPoll
```
```python
.
```
```python
update_events
```
```python
(
```
```python
listen
```
```python
,
```
```python
ls
```
```python
-
```
```python
>
```
```python
m_pUDT
```
```python
-
```
```python
>
```
```python
m_sPollID
```
```python
,
```
```python
UDT_EPOLL_IN
```
```python
,
```
```python
false
```
```python
)
```
```python
;
```
```python
}
```
```python
.
```
```python
.
```
```python
.
```
```python
}
```
send / sendmsg / sendCtrl / sendfile
```python
// write is not available any more
```
```python
s_UDTUnited
```
```python
.
```
```python
m_EPoll
```
```python
.
```
```python
update_events
```
```python
(
```
```python
m_SocketID
```
```python
,
```
```python
m_sPollID
```
```python
,
```
```python
UDT_EPOLL_OUT
```
```python
,
```
```python
false
```
```python
)
```
```python
;
```
recv / recvmsg / recvCtrl /recvfile
```python
// read is not available any more
```
```python
s_UDTUnited
```
```python
.
```
```python
m_EPoll
```
```python
.
```
```python
update_events
```
```python
(
```
```python
m_SocketID
```
```python
,
```
```python
m_sPollID
```
```python
,
```
```python
UDT_EPOLL_IN
```
```python
,
```
```python
false
```
```python
)
```
```python
;
```
# 总结
从代码来看，epoll 的使用主要存在代码例子中，用于C/S模式。对于 UDT 来说，参与到了所有的网络连接建立于收发过程，UDT 增加了 socket 的管理，以便更好进行读写等。

