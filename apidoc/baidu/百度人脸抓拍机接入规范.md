# 百度人脸抓拍机接入规范

# 一 方案概述

​	为了更好地满足集成商使用人脸抓拍机进行项目落地的需求，解决市场上的人脸抓拍机与百度人脸识别API集成不方便的问题，百度设计了一套标准的抓拍机接入协议，此协议可以让抓拍机采集人脸图片到调用人脸识别API之间的过程更简单。

​	目前，此协议已经正式开放给所有的抓拍机生产商，只要接入此协议的抓拍机，通过百度的评测（有抓拍机接入平台，提供可视化的接入和评测功能），就有机会入驻百度AI市场，成为百度官方推荐的抓拍机、享受免费的推广资源。



# 二 抓拍机接入流程讲解

抓拍机接入的流程可以分为4部分：

> 1、按照接入协议开发相应数据传输接口，保证与百度侧数据通信。
>
> 2、修改抓拍机的web view页面，**给用户提供填写activekey（激活码）的页面**，用来激活设备，保证该抓拍机的图片能够被百度的云端服务接收。
>
> 3、使用百度抓拍机接入平台进行抓拍机评测，百度侧按照抓拍机准入标准进评测，并反馈评测结果（评测内容包括：抓拍机基本功能评测、抓拍效果评测），评测通过后即可入住AI市场。
>
> 4、入驻百度AI市场，成为官方推荐抓拍机，进行售卖。

​	下面将介绍成为百度官方推荐抓拍机的两个前提条件：

> 1、摄像头需要满足的基本要求。
> 2、接入百度抓拍机协议并完成评测。

# 三 抓拍机基本要求

想要成为百度官方推荐抓拍摄像头，页需要满足传统摄像头行业的基本要求：

（1）硬件本身

- 网络支持DHCP：局域网情况下需要支持获取自动分配的IP
- 摄像头指示灯：开机或关机状态可以通过指示灯显示出来

（2）web view页面工具

- 支持拍照功能：在web view页面可以保留当前图片
- 支持人脸检测画框开关：用来控制是否在web view页面显示摄像头拍摄的信息

（3）百度接入协议相关web view功能（**重要**）

- 在web view上为重点用户提供管理员权限，可以手动配置抓拍机对接百度平台的URL地址，以免后续百度侧更新服务地址导致抓拍机不可用。

  > 注：默认地址为：https://ai.baidu.com/edgecloud/api/capture/upload
  >
  > **协议类型**：http或https
  >
  > **推送地址**：可配置IP或域名
  >
  > **推送PORT**：抓拍机推送到的服务端端口
  >
  > **推送URI**：抓拍机推送到的服务端的路径

- web view页面，**给用户提供填写activekey（激活码）的页面**，用来激活设备，保证该抓拍机的图片能够被百度的云端服务接收。

  > 注：activekey（激活码）的定义请参考“抓拍机接入协议”的2.3 公共请求头的参数说明

（4）更详细的抓拍机评测标准请查看【百度抓拍机评测标准文档】。

# 四 抓拍机接入协议

# 1 概述

抓拍机接入协议为标准协议，摄像头生产商可以按照下述文档内容接入百度协议，成为百度官方推荐抓拍机。

# 2 接口设计

## 2.1 鉴权认证

接口鉴权统一采用https协议头部签名串验证，认证字符串生成规则参照接口定义公共部分。

## 2.2 公共定义

系统鉴权相关字段在请求头中（http header）；

业务逻辑相关的字段在请求体内（http body）；

请求的内容类型（Content-Type）为application/json，请求体以json字符串的传递。

下面分别介绍请求头的公共头部和公共响应。具体的接口描述将不再重复描述这些公共部分。

## 2.3 公共请求头

| 头域(Header)     | 说明                                                         |
| :--------------- | :----------------------------------------------------------- |
| **Content-Type** | application/json;charset=UTF-8                               |
| **activeKey**    | 19位激活字符串，String类型，由百度人脸采集平台分发， 在抓拍机配置用于人脸采集平台鉴权。 例如：I3GZ-KKQE-ZJNR-R0M1。 抓拍机使用者在百度抓拍机接入平台中 申请后填写至抓拍机控制台。 |
| **token**        | 此字段标识一个抓拍机型号， token值和activeKey保持一致， 抓拍机生产时此字段必填并固定不变。 |
| **deviceId**     | 抓拍机设备ID，String类型。例如： 6B725AF84E053E67BB7D341E806B5E3C |
| **captureTime**  | 人脸图抓拍时间毫秒值， 用于判断人脸采集时间， Long型数值。例如：1490986000000 |
| **requestTime**  | 请求时间当前毫秒值，用于判断网络时延， Long型数值。例如：1490987000000 |
| **signature**    | 用于信息防篡改。 MD5(${activeKey}${token}${deviceId}${captureTime}${requestTime}${requestBody}) 签名生成规则参考下面注释。 |

> 注：signature参数的签名生成规则如下：
>
> 1. ${ activeKey }19位激活字符串，由百度人脸采集平台分发，在抓拍机配置用于人脸采集平台鉴权。例如：I3GZ-KKQE-ZJNR-R0M1。
> 2. ${token}19位token字符串，此字段标识一个抓拍机型号，对抓拍机厂商而言token值和activeKey保持一致。例如：I3GZ-KKQE-ZJNR-R0M1。
> 3. ${deviceId}设备唯一ID，String类型。
> 4. ${captureTime} 人脸抓拍时间毫秒值，Long型数值。
> 5. ${requestTime} 请求时间当前毫秒值，Long型数值。
> 6. ${requestBody}为请求的消息体，为json字符串形式。 生成签名时，按照以上顺序拼接生成，然后以utf8模式生成字节序列后再md5。

## 2.4 公共响应头

| 头域(Header)     | 说明                           |
| :--------------- | :----------------------------- |
| **Content-Type** | application/json;charset=UTF-8 |
| **Accept**       | application/json;charset=UTF-8 |

## 2.5 公共响应体

| 消息体(Body)   | 数据类型 | 说明                                     |
| :------------- | :------- | :--------------------------------------- |
| **log_id**     | Long     | 调用唯一ID                               |
| **error_code** | Int      | 服务调用提示码，失败才返回，成功不返回   |
| **error_msg**  | String   | 服务调用提示信息，失败才返回，成功不返回 |

## 2.6 公共错误码

| 错误码     | 错误信息             | 中文描述                                                     |
| :--------- | :------------------- | :----------------------------------------------------------- |
| **216101** | not enough param     | 请求参数不足                                                 |
| **216200** | empty image          | 图片为空                                                     |
| **216201** | image format error   | 图片格式错误                                                 |
| **216202** | image size error     | 图片尺寸错误，请按照提示尺寸剪裁， 图片最大尺寸为：1920x1080，图片大小不能超过2M |
| **283000** | logic internal error | 未知错误                                                     |
| **283001** | activekey incorrect  | 序列码错误                                                   |
| **283002** | deviceId incorrect   | 设备ID错误                                                   |
| **283003** | data format error    | 数据格式错误                                                 |
| **283004** | MD5 signature error  | MD5校验和校验失败                                            |

# 3 接口列表

## 3.1 人脸上传接口

**接口地址：**https://ai.baidu.com/edgecloud/api/capture/upload

**请求方式：**POST

**请求格式：**application/json;charset=UTF-8

**请求参数说明：**

| 参数名称  | 数据类型 | 是否必需 | 说明                                                         |
| :-------- | :------- | :------- | :----------------------------------------------------------- |
| **image** | String   | 是       | 图片base64编码字符串，base64编码后的图片数据， 编码后的图片大小不超过2M； |
| **ext**   | String   | 否       | 用户自定义信息，JsonObject格式， 例如：{“address”: “设备部署地址”,“system”：“设备所属系统”} |

**请求示例：**

{

 "image": "ABCEDFG……",

 "ext": {

 "address": "设备部署地址",

 "system": "设备所属系统"

 }

}

返回结果说明：

| 参数名称      | 数据类型 | 说明       |
| :------------ | :------- | :--------- |
| **logId**     | Long     | 调用唯一ID |
| **errorCode** | String   | 错误编码   |
| **result**    | JSON     | JSON字符串 |

**返回结果示例：**

{

 "log_id": 1234567890,

 "errorCode":0,

 "result": null

}

# 4 抓拍机管理后台配置

由于客户使用抓拍机的应用场景分为在线（将抓拍到的人脸推送到百度云服务器）与离线（将抓拍到的人脸直接推送至客户自主部署的服务端）两种形式，所以需要抓拍机提供商在抓拍机管理后台提供灵活的推送地址配置入口。具体配置项包括：

**协议类型**：http或https

**推送地址**：可配置IP或域名

**推送PORT**：抓拍机推送到的服务端端口

**推送URI**：抓拍机推送到的服务端的路径

综上，需要在抓拍机管理端提供可配置的推送地址，默认地址为：https://ai.baidu.com/edgecloud/api/capture/upload