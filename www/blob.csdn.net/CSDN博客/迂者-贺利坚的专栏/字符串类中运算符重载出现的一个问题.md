
# 字符串类中运算符重载出现的一个问题 - 迂者-贺利坚的专栏 - CSDN博客

2016年05月26日 15:09:35[迂者-贺利坚](https://me.csdn.net/sxhelijian)阅读数：4867所属专栏：[代码侦探](https://blog.csdn.net/column/details/bugkiller.html)



上机辅导。学生的一个程序莫名出问题。她是在做一个String类，主要是要实现字符串的连接。
程序是这样的，请读者将其拷到IDE，边看边调：
```python
#include <iostream>
```
```python
#include <cassert>
```
```python
#include <cstring>
```
```python
using
```
```python
namespace
```
```python
std
```
```python
;
```
```python
class
```
```python
String
{
```
```python
private
```
```python
:
```
```python
char
```
```python
* p;
```
```python
int
```
```python
len;
```
```python
public
```
```python
:
    String();
    String(
```
```python
const
```
```python
char
```
```python
* s);
    String(
```
```python
const
```
```python
String& s);
    ~String();
```
```python
//问题出现在这儿
```
```python
void
```
```python
show();
```
```python
friend
```
```python
String
```
```python
operator
```
```python
+(
```
```python
const
```
```python
String& s1,
```
```python
const
```
```python
String& s2);
```
```python
friend
```
```python
String
```
```python
operator
```
```python
-(
```
```python
const
```
```python
String& s1,
```
```python
const
```
```python
String& s2);
};
String::String()
{
    len=
```
```python
0
```
```python
;
    p=NULL;
}
String::String(
```
```python
const
```
```python
char
```
```python
* s)
{
    len=
```
```python
strlen
```
```python
(s);
    p=
```
```python
new
```
```python
char
```
```python
[len+
```
```python
1
```
```python
];
```
```python
strcpy
```
```python
(p,s);
}
String::String(
```
```python
const
```
```python
String& s)
{
    len=s.len;
```
```python
if
```
```python
(p!=NULL)
```
```python
delete
```
```python
[]p;
    p=
```
```python
new
```
```python
char
```
```python
[len+
```
```python
1
```
```python
];
```
```python
strcpy
```
```python
(p,s.p);
}
String
```
```python
operator
```
```python
+(
```
```python
const
```
```python
String& s1,
```
```python
const
```
```python
String& s2)
{
    String total;
    total.len=s1.len+s2.len;
    total.p=
```
```python
new
```
```python
char
```
```python
[total.len+
```
```python
1
```
```python
];
```
```python
strcpy
```
```python
(total.p,s1.p);
```
```python
strcat
```
```python
(total.p,s2.p);
```
```python
return
```
```python
total;
}
String
```
```python
operator
```
```python
-(
```
```python
const
```
```python
String& s1,
```
```python
const
```
```python
String& s2)
{
```
```python
char
```
```python
* c1=
```
```python
new
```
```python
char
```
```python
[s1.len+
```
```python
1
```
```python
];
```
```python
strcpy
```
```python
(c1,s1.p);
```
```python
int
```
```python
i=s1.len-
```
```python
1
```
```python
;
```
```python
while
```
```python
(s1.p[i]!=
```
```python
' '
```
```python
&&i>=
```
```python
0
```
```python
)--i;
    c1[i+
```
```python
1
```
```python
]=
```
```python
'\0'
```
```python
;
```
```python
char
```
```python
* c2=
```
```python
new
```
```python
char
```
```python
[s2.len+
```
```python
1
```
```python
];
```
```python
strcpy
```
```python
(c2,s2.p);
    i=
```
```python
0
```
```python
;
```
```python
while
```
```python
(i<s2.len&&c2[i]==
```
```python
' '
```
```python
)++i;
```
```python
int
```
```python
j=
```
```python
0
```
```python
;
```
```python
while
```
```python
(c2[i]!=
```
```python
'\0'
```
```python
&&i<s2.len)
    {
        c2[j]=c2[i];
        ++i;
        ++j;
    }
    c2[j]=
```
```python
'\0'
```
```python
;
    String s;
    s.len=s1.len+s2.len;
    s.p=
```
```python
new
```
```python
char
```
```python
[s.len];
```
```python
strcpy
```
```python
(s.p,c1);
```
```python
strcat
```
```python
(s.p,c2);
```
```python
delete
```
```python
c1;
```
```python
delete
```
```python
c2;
```
```python
return
```
```python
s;
}
```
```python
void
```
```python
String::show()
{
```
```python
cout
```
```python
<<p<<endl;
}
String::~String()
{
```
```python
delete
```
```python
[]p;
}
```
```python
int
```
```python
main()
{
    String str1(
```
```python
"123"
```
```python
),str2(
```
```python
"456"
```
```python
),str3;
    str3=str1+str2;
    str3.show();
    str3=str1-str2;
    str3.show();
```
```python
return
```
```python
0
```
```python
;
}
```
问题的表现是，`str3.show();`的输出是几个莫名的符号！
我让她单步跟踪一下，却发现无论断点设在哪里，总是要进到析构函数~String()中去！
恰其他同学的问题不少，我让她将这个程序给我发邮件，她不要在此纠缠。我清楚，这里有指针成员。祸水应该与此相关。
学习越来越深入，学生出问题的程序，常需要仔细阅读后才能给指导意见了。
午睡后，打开邮件。将程序拷入IDE，已经注意到了执行`str3=str1+str2;`时，需要有的赋值运算符=的重载。试图找一下单步时进入~String()时的场景，却未遂。
在我的IDE下，`str3=str1+str2;`的结果正常，`str3=str1-str2;`的结果却异常。野指针的表征，真伪混杂最头疼。
重载赋值运算=，在类声明中加：
```python
String
```
```python
&
```
```python
operator
```
```python
=(
```
```python
const
```
```python
String
```
```python
& s1);
```
实现为：
```python
String
```
```python
&
```
```python
String
```
```python
::operator=(
```
```python
const
```
```python
String
```
```python
&s1)
{
```
```python
if
```
```python
(!
```
```python
this
```
```python
->p)
```
```python
delete
```
```python
[]p;
    p=
```
```python
new
```
```python
char(s1.len+
```
```python
1
```
```python
);
    strcpy(p,s1.p);
    len=s1.len;
```
```python
return
```
```python
*
```
```python
this
```
```python
;
}
```
先向学生交作业。进入~String()的问题是否还在？暂时放下，待回音。

