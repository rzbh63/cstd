
# 纯Python和PyTorch对比实现循环神经网络LSTM及反向传播 - BrightLamp的博客 - CSDN博客


2018年12月18日 16:44:45[BrightLampCsdn](https://me.csdn.net/oBrightLamp)阅读数：88



## 摘要
本文使用纯 Python 和 PyTorch 对比实现循环神经网络LSTM及其反向传播.
## 相关
配套代码, 请参考文章 :
*长短期记忆网络LSTMCell单元详解及反向传播的梯度求导*
文章索引 :
[https://blog.csdn.net/oBrightLamp/article/details/85067981](https://blog.csdn.net/oBrightLamp/article/details/85067981)
## 正文
## 1. LSTMCell 类
文件目录 : vanilla_nn/lstmcell.py
```python
import
```
```python
numpy
```
```python
as
```
```python
np
```
```python
def
```
```python
sigmoid
```
```python
(
```
```python
x
```
```python
)
```
```python
:
```
```python
return
```
```python
1
```
```python
/
```
```python
(
```
```python
1
```
```python
+
```
```python
np
```
```python
.
```
```python
exp
```
```python
(
```
```python
-
```
```python
x
```
```python
)
```
```python
)
```
```python
class
```
```python
LSTMCell
```
```python
:
```
```python
def
```
```python
__init__
```
```python
(
```
```python
self
```
```python
,
```
```python
weight_ih
```
```python
,
```
```python
weight_hh
```
```python
,
```
```python
bias_ih
```
```python
,
```
```python
bias_hh
```
```python
)
```
```python
:
```
```python
self
```
```python
.
```
```python
weight_ih
```
```python
=
```
```python
weight_ih
        self
```
```python
.
```
```python
weight_hh
```
```python
=
```
```python
weight_hh
        self
```
```python
.
```
```python
bias_ih
```
```python
=
```
```python
bias_ih
        self
```
```python
.
```
```python
bias_hh
```
```python
=
```
```python
bias_hh
        self
```
```python
.
```
```python
dc_prev
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
dh_prev
```
```python
=
```
```python
None
```
```python
self
```
```python
.
```
```python
weight_ih_grad_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
weight_hh_grad_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
bias_ih_grad_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
bias_hh_grad_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
x_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
dx_list
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
dh_prev_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
h_prev_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
c_prev_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
h_next_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
c_next_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
input_gate_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
forget_gate_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
output_gate_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
self
```
```python
.
```
```python
cell_memory_stack
```
```python
=
```
```python
[
```
```python
]
```
```python
def
```
```python
__call__
```
```python
(
```
```python
self
```
```python
,
```
```python
x
```
```python
,
```
```python
h_prev
```
```python
,
```
```python
c_prev
```
```python
)
```
```python
:
```
```python
a_vector
```
```python
=
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
x
```
```python
,
```
```python
self
```
```python
.
```
```python
weight_ih
```
```python
.
```
```python
T
```
```python
)
```
```python
+
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
h_prev
```
```python
,
```
```python
self
```
```python
.
```
```python
weight_hh
```
```python
.
```
```python
T
```
```python
)
```
```python
a_vector
```
```python
+=
```
```python
self
```
```python
.
```
```python
bias_ih
```
```python
+
```
```python
self
```
```python
.
```
```python
bias_hh
        h_size
```
```python
=
```
```python
np
```
```python
.
```
```python
shape
```
```python
(
```
```python
h_prev
```
```python
)
```
```python
[
```
```python
1
```
```python
]
```
```python
a_i
```
```python
=
```
```python
a_vector
```
```python
[
```
```python
:
```
```python
,
```
```python
h_size
```
```python
*
```
```python
0
```
```python
:
```
```python
h_size
```
```python
*
```
```python
1
```
```python
]
```
```python
a_f
```
```python
=
```
```python
a_vector
```
```python
[
```
```python
:
```
```python
,
```
```python
h_size
```
```python
*
```
```python
1
```
```python
:
```
```python
h_size
```
```python
*
```
```python
2
```
```python
]
```
```python
a_c
```
```python
=
```
```python
a_vector
```
```python
[
```
```python
:
```
```python
,
```
```python
h_size
```
```python
*
```
```python
2
```
```python
:
```
```python
h_size
```
```python
*
```
```python
3
```
```python
]
```
```python
a_o
```
```python
=
```
```python
a_vector
```
```python
[
```
```python
:
```
```python
,
```
```python
h_size
```
```python
*
```
```python
3
```
```python
:
```
```python
]
```
```python
input_gate
```
```python
=
```
```python
sigmoid
```
```python
(
```
```python
a_i
```
```python
)
```
```python
forget_gate
```
```python
=
```
```python
sigmoid
```
```python
(
```
```python
a_f
```
```python
)
```
```python
cell_memory
```
```python
=
```
```python
np
```
```python
.
```
```python
tanh
```
```python
(
```
```python
a_c
```
```python
)
```
```python
output_gate
```
```python
=
```
```python
sigmoid
```
```python
(
```
```python
a_o
```
```python
)
```
```python
c_next
```
```python
=
```
```python
(
```
```python
forget_gate
```
```python
*
```
```python
c_prev
```
```python
)
```
```python
+
```
```python
(
```
```python
input_gate
```
```python
*
```
```python
cell_memory
```
```python
)
```
```python
h_next
```
```python
=
```
```python
output_gate
```
```python
*
```
```python
np
```
```python
.
```
```python
tanh
```
```python
(
```
```python
c_next
```
```python
)
```
```python
self
```
```python
.
```
```python
x_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
x
```
```python
)
```
```python
self
```
```python
.
```
```python
h_prev_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
h_prev
```
```python
)
```
```python
self
```
```python
.
```
```python
c_prev_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
c_prev
```
```python
)
```
```python
self
```
```python
.
```
```python
c_next_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
c_next
```
```python
)
```
```python
self
```
```python
.
```
```python
h_next_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
h_next
```
```python
)
```
```python
self
```
```python
.
```
```python
input_gate_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
input_gate
```
```python
)
```
```python
self
```
```python
.
```
```python
forget_gate_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
forget_gate
```
```python
)
```
```python
self
```
```python
.
```
```python
output_gate_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
output_gate
```
```python
)
```
```python
self
```
```python
.
```
```python
cell_memory_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
cell_memory
```
```python
)
```
```python
self
```
```python
.
```
```python
dc_prev
```
```python
=
```
```python
np
```
```python
.
```
```python
zeros_like
```
```python
(
```
```python
c_next
```
```python
)
```
```python
self
```
```python
.
```
```python
dh_prev
```
```python
=
```
```python
np
```
```python
.
```
```python
zeros_like
```
```python
(
```
```python
h_next
```
```python
)
```
```python
return
```
```python
h_next
```
```python
,
```
```python
c_next
```
```python
def
```
```python
backward
```
```python
(
```
```python
self
```
```python
,
```
```python
dh_next
```
```python
)
```
```python
:
```
```python
x_stack
```
```python
=
```
```python
self
```
```python
.
```
```python
x_stack
```
```python
.
```
```python
pop
```
```python
(
```
```python
)
```
```python
h_prev
```
```python
=
```
```python
self
```
```python
.
```
```python
h_prev_stack
```
```python
.
```
```python
pop
```
```python
(
```
```python
)
```
```python
c_prev
```
```python
=
```
```python
self
```
```python
.
```
```python
c_prev_stack
```
```python
.
```
```python
pop
```
```python
(
```
```python
)
```
```python
c_next
```
```python
=
```
```python
self
```
```python
.
```
```python
c_next_stack
```
```python
.
```
```python
pop
```
```python
(
```
```python
)
```
```python
input_gate
```
```python
=
```
```python
self
```
```python
.
```
```python
input_gate_stack
```
```python
.
```
```python
pop
```
```python
(
```
```python
)
```
```python
forget_gate
```
```python
=
```
```python
self
```
```python
.
```
```python
forget_gate_stack
```
```python
.
```
```python
pop
```
```python
(
```
```python
)
```
```python
output_gate
```
```python
=
```
```python
self
```
```python
.
```
```python
output_gate_stack
```
```python
.
```
```python
pop
```
```python
(
```
```python
)
```
```python
cell_memory
```
```python
=
```
```python
self
```
```python
.
```
```python
cell_memory_stack
```
```python
.
```
```python
pop
```
```python
(
```
```python
)
```
```python
dh
```
```python
=
```
```python
dh_next
```
```python
+
```
```python
self
```
```python
.
```
```python
dh_prev
        d_tanh_c
```
```python
=
```
```python
dh
```
```python
*
```
```python
output_gate
```
```python
*
```
```python
(
```
```python
1
```
```python
-
```
```python
np
```
```python
.
```
```python
square
```
```python
(
```
```python
np
```
```python
.
```
```python
tanh
```
```python
(
```
```python
c_next
```
```python
)
```
```python
)
```
```python
)
```
```python
dc
```
```python
=
```
```python
d_tanh_c
```
```python
+
```
```python
self
```
```python
.
```
```python
dc_prev
        dc_prev
```
```python
=
```
```python
dc
```
```python
*
```
```python
forget_gate
        self
```
```python
.
```
```python
dc_prev
```
```python
=
```
```python
dc_prev
        d_input_gate
```
```python
=
```
```python
dc
```
```python
*
```
```python
cell_memory
        d_forget_gate
```
```python
=
```
```python
dc
```
```python
*
```
```python
c_prev
        d_cell_memory
```
```python
=
```
```python
dc
```
```python
*
```
```python
input_gate
        d_output_gate
```
```python
=
```
```python
dh
```
```python
*
```
```python
np
```
```python
.
```
```python
tanh
```
```python
(
```
```python
c_next
```
```python
)
```
```python
d_ai
```
```python
=
```
```python
d_input_gate
```
```python
*
```
```python
input_gate
```
```python
*
```
```python
(
```
```python
1
```
```python
-
```
```python
input_gate
```
```python
)
```
```python
d_af
```
```python
=
```
```python
d_forget_gate
```
```python
*
```
```python
forget_gate
```
```python
*
```
```python
(
```
```python
1
```
```python
-
```
```python
forget_gate
```
```python
)
```
```python
d_ao
```
```python
=
```
```python
d_output_gate
```
```python
*
```
```python
output_gate
```
```python
*
```
```python
(
```
```python
1
```
```python
-
```
```python
output_gate
```
```python
)
```
```python
d_ac
```
```python
=
```
```python
d_cell_memory
```
```python
*
```
```python
(
```
```python
1
```
```python
-
```
```python
np
```
```python
.
```
```python
square
```
```python
(
```
```python
cell_memory
```
```python
)
```
```python
)
```
```python
da
```
```python
=
```
```python
np
```
```python
.
```
```python
concatenate
```
```python
(
```
```python
(
```
```python
d_ai
```
```python
,
```
```python
d_af
```
```python
,
```
```python
d_ac
```
```python
,
```
```python
d_ao
```
```python
)
```
```python
,
```
```python
axis
```
```python
=
```
```python
1
```
```python
)
```
```python
dx
```
```python
=
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
da
```
```python
,
```
```python
self
```
```python
.
```
```python
weight_ih
```
```python
)
```
```python
dh_prev
```
```python
=
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
da
```
```python
,
```
```python
self
```
```python
.
```
```python
weight_hh
```
```python
)
```
```python
self
```
```python
.
```
```python
dh_prev
```
```python
=
```
```python
dh_prev
        self
```
```python
.
```
```python
dx_list
```
```python
.
```
```python
insert
```
```python
(
```
```python
0
```
```python
,
```
```python
dx
```
```python
)
```
```python
self
```
```python
.
```
```python
dh_prev_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
dh_prev
```
```python
)
```
```python
self
```
```python
.
```
```python
weight_ih_grad_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
da
```
```python
.
```
```python
T
```
```python
,
```
```python
x_stack
```
```python
)
```
```python
)
```
```python
self
```
```python
.
```
```python
weight_hh_grad_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
np
```
```python
.
```
```python
dot
```
```python
(
```
```python
da
```
```python
.
```
```python
T
```
```python
,
```
```python
h_prev
```
```python
)
```
```python
)
```
```python
db
```
```python
=
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
da
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
self
```
```python
.
```
```python
bias_ih_grad_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
db
```
```python
)
```
```python
self
```
```python
.
```
```python
bias_hh_grad_stack
```
```python
.
```
```python
append
```
```python
(
```
```python
db
```
```python
)
```
```python
return
```
```python
dh_prev
```
## 2. LSTMCell 测试
```python
import
```
```python
torch
```
```python
import
```
```python
numpy
```
```python
as
```
```python
np
```
```python
from
```
```python
vanilla_nn
```
```python
.
```
```python
lstmcell
```
```python
import
```
```python
LSTMCell
np
```
```python
.
```
```python
random
```
```python
.
```
```python
seed
```
```python
(
```
```python
123
```
```python
)
```
```python
torch
```
```python
.
```
```python
random
```
```python
.
```
```python
manual_seed
```
```python
(
```
```python
123
```
```python
)
```
```python
np
```
```python
.
```
```python
set_printoptions
```
```python
(
```
```python
precision
```
```python
=
```
```python
6
```
```python
,
```
```python
suppress
```
```python
=
```
```python
True
```
```python
)
```
```python
lstm_torch
```
```python
=
```
```python
torch
```
```python
.
```
```python
nn
```
```python
.
```
```python
LSTMCell
```
```python
(
```
```python
2
```
```python
,
```
```python
3
```
```python
)
```
```python
.
```
```python
double
```
```python
(
```
```python
)
```
```python
lstm_numpy
```
```python
=
```
```python
LSTMCell
```
```python
(
```
```python
lstm_torch
```
```python
.
```
```python
weight_ih
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
,
```
```python
lstm_torch
```
```python
.
```
```python
weight_hh
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
,
```
```python
lstm_torch
```
```python
.
```
```python
bias_ih
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
,
```
```python
lstm_torch
```
```python
.
```
```python
bias_hh
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
x_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
4
```
```python
,
```
```python
2
```
```python
)
```
```python
)
```
```python
x_torch
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
x_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
h_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
4
```
```python
,
```
```python
3
```
```python
)
```
```python
)
```
```python
h_torch
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
h_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
c_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
4
```
```python
,
```
```python
3
```
```python
)
```
```python
)
```
```python
c_torch
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
c_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
dh_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
4
```
```python
,
```
```python
3
```
```python
)
```
```python
)
```
```python
dh_torch
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
dh_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
h_numpy
```
```python
,
```
```python
c_numpy
```
```python
=
```
```python
lstm_numpy
```
```python
(
```
```python
x_numpy
```
```python
,
```
```python
h_numpy
```
```python
,
```
```python
c_numpy
```
```python
)
```
```python
h_torch
```
```python
,
```
```python
c_torch
```
```python
=
```
```python
lstm_torch
```
```python
(
```
```python
x_torch
```
```python
,
```
```python
(
```
```python
h_torch
```
```python
,
```
```python
c_torch
```
```python
)
```
```python
)
```
```python
h_torch
```
```python
.
```
```python
backward
```
```python
(
```
```python
dh_torch
```
```python
)
```
```python
dh_numpy
```
```python
=
```
```python
lstm_numpy
```
```python
.
```
```python
backward
```
```python
(
```
```python
dh_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
"--- 代码输出 ---"
```
```python
)
```
```python
print
```
```python
(
```
```python
"h_numpy :\n"
```
```python
,
```
```python
h_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
"h_torch :\n"
```
```python
,
```
```python
h_torch
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"---------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"c_numpy :\n"
```
```python
,
```
```python
c_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
"c_torch :\n"
```
```python
,
```
```python
c_torch
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"---------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"dx_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
lstm_numpy
```
```python
.
```
```python
dx_list
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"dx_torch :\n"
```
```python
,
```
```python
x_torch
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"---------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"w_ih_grad_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
lstm_numpy
```
```python
.
```
```python
weight_ih_grad_stack
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"w_ih_grad_torch :\n"
```
```python
,
```
```python
lstm_torch
```
```python
.
```
```python
weight_ih
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"---------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"w_hh_grad_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
lstm_numpy
```
```python
.
```
```python
weight_hh_grad_stack
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"w_hh_grad_torch :\n"
```
```python
,
```
```python
lstm_torch
```
```python
.
```
```python
weight_hh
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"---------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"b_ih_grad_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
lstm_numpy
```
```python
.
```
```python
bias_ih_grad_stack
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"b_ih_grad_torch :\n"
```
```python
,
```
```python
lstm_torch
```
```python
.
```
```python
bias_ih
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"---------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"b_hh_grad_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
lstm_numpy
```
```python
.
```
```python
bias_hh_grad_stack
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"b_hh_grad_torch :\n"
```
```python
,
```
```python
lstm_torch
```
```python
.
```
```python
bias_hh
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
"""
--- 代码输出 ---
--- 代码输出 ---
h_numpy :
 [[ 0.055856  0.234159  0.138457]
 [ 0.094461  0.245843  0.224411]
 [ 0.020396  0.086745  0.082545]
 [-0.003794  0.040677  0.063094]]
h_torch :
 [[ 0.055856  0.234159  0.138457]
 [ 0.094461  0.245843  0.224411]
 [ 0.020396  0.086745  0.082545]
 [-0.003794  0.040677  0.063094]]
---------
c_numpy :
 [[ 0.092093  0.384992  0.213364]
 [ 0.151362  0.424671  0.318313]
 [ 0.033245  0.141979  0.120822]
 [-0.0061    0.062946  0.094999]]
c_torch :
 [[ 0.092093  0.384992  0.213364]
 [ 0.151362  0.424671  0.318313]
 [ 0.033245  0.141979  0.120822]
 [-0.0061    0.062946  0.094999]]
---------
dx_numpy :
 [[-0.144016  0.029775]
 [-0.229789  0.140921]
 [-0.246041 -0.009354]
 [-0.088844  0.036652]]
dx_torch :
 [[-0.144016  0.029775]
 [-0.229789  0.140921]
 [-0.246041 -0.009354]
 [-0.088844  0.036652]]
---------
w_ih_grad_numpy :
 [[-0.056788 -0.036448]
 [ 0.018742  0.014428]
 [ 0.007827  0.024828]
 [ 0.07856   0.05437 ]
 [ 0.061267  0.045952]
 [ 0.083886  0.0655  ]
 [ 0.229755  0.156008]
 [ 0.345218  0.251984]
 [ 0.430385  0.376664]
 [ 0.014239  0.011767]
 [ 0.054866  0.044531]
 [ 0.04654   0.048565]]
w_ih_grad_torch :
 [[-0.056788 -0.036448]
 [ 0.018742  0.014428]
 [ 0.007827  0.024828]
 [ 0.07856   0.05437 ]
 [ 0.061267  0.045952]
 [ 0.083886  0.0655  ]
 [ 0.229755  0.156008]
 [ 0.345218  0.251984]
 [ 0.430385  0.376664]
 [ 0.014239  0.011767]
 [ 0.054866  0.044531]
 [ 0.04654   0.048565]]
---------
w_hh_grad_numpy :
 [[-0.037698 -0.048568 -0.021069]
 [ 0.016749  0.016277  0.007556]
 [ 0.035743  0.02156   0.000111]
 [ 0.060824  0.069505  0.029101]
 [ 0.060402  0.051634  0.025643]
 [ 0.068116  0.06966   0.035544]
 [ 0.168965  0.217076  0.075904]
 [ 0.248277  0.290927  0.138279]
 [ 0.384974  0.401949  0.167006]
 [ 0.015448  0.0139    0.005158]
 [ 0.057147  0.048975  0.022261]
 [ 0.057297  0.048308  0.017745]]
w_hh_grad_torch :
 [[-0.037698 -0.048568 -0.021069]
 [ 0.016749  0.016277  0.007556]
 [ 0.035743  0.02156   0.000111]
 [ 0.060824  0.069505  0.029101]
 [ 0.060402  0.051634  0.025643]
 [ 0.068116  0.06966   0.035544]
 [ 0.168965  0.217076  0.075904]
 [ 0.248277  0.290927  0.138279]
 [ 0.384974  0.401949  0.167006]
 [ 0.015448  0.0139    0.005158]
 [ 0.057147  0.048975  0.022261]
 [ 0.057297  0.048308  0.017745]]
---------
b_ih_grad_numpy :
 [-0.084682  0.032588  0.046412  0.126449  0.111421  0.139337  0.361956
  0.539519  0.761838  0.027649  0.103695  0.099405]
b_ih_grad_torch :
 [-0.084682  0.032588  0.046412  0.126449  0.111421  0.139337  0.361956
  0.539519  0.761838  0.027649  0.103695  0.099405]
---------
b_hh_grad_numpy :
 [-0.084682  0.032588  0.046412  0.126449  0.111421  0.139337  0.361956
  0.539519  0.761838  0.027649  0.103695  0.099405]
b_hh_grad_torch :
 [-0.084682  0.032588  0.046412  0.126449  0.111421  0.139337  0.361956
  0.539519  0.761838  0.027649  0.103695  0.099405]
"""
```
## 3. LSTM 测试
```python
import
```
```python
torch
```
```python
import
```
```python
numpy
```
```python
as
```
```python
np
```
```python
from
```
```python
vanilla_nn
```
```python
.
```
```python
lstmcell
```
```python
import
```
```python
LSTMCell
np
```
```python
.
```
```python
random
```
```python
.
```
```python
seed
```
```python
(
```
```python
123
```
```python
)
```
```python
torch
```
```python
.
```
```python
random
```
```python
.
```
```python
manual_seed
```
```python
(
```
```python
123
```
```python
)
```
```python
np
```
```python
.
```
```python
set_printoptions
```
```python
(
```
```python
precision
```
```python
=
```
```python
6
```
```python
,
```
```python
suppress
```
```python
=
```
```python
True
```
```python
)
```
```python
lstm_torch
```
```python
=
```
```python
torch
```
```python
.
```
```python
nn
```
```python
.
```
```python
LSTM
```
```python
(
```
```python
2
```
```python
,
```
```python
3
```
```python
,
```
```python
1
```
```python
)
```
```python
.
```
```python
double
```
```python
(
```
```python
)
```
```python
lstm_numpy
```
```python
=
```
```python
LSTMCell
```
```python
(
```
```python
lstm_torch
```
```python
.
```
```python
all_weights
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
0
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
,
```
```python
lstm_torch
```
```python
.
```
```python
all_weights
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
1
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
,
```
```python
lstm_torch
```
```python
.
```
```python
all_weights
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
2
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
,
```
```python
lstm_torch
```
```python
.
```
```python
all_weights
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
3
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
x_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
3
```
```python
,
```
```python
4
```
```python
,
```
```python
2
```
```python
)
```
```python
)
```
```python
x_torch
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
x_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
h_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
1
```
```python
,
```
```python
4
```
```python
,
```
```python
3
```
```python
)
```
```python
)
```
```python
h_torch
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
h_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
c_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
1
```
```python
,
```
```python
4
```
```python
,
```
```python
3
```
```python
)
```
```python
)
```
```python
c_torch
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
c_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
dh_numpy
```
```python
=
```
```python
np
```
```python
.
```
```python
random
```
```python
.
```
```python
random
```
```python
(
```
```python
(
```
```python
3
```
```python
,
```
```python
4
```
```python
,
```
```python
3
```
```python
)
```
```python
)
```
```python
dh_torch
```
```python
=
```
```python
torch
```
```python
.
```
```python
tensor
```
```python
(
```
```python
dh_numpy
```
```python
,
```
```python
requires_grad
```
```python
=
```
```python
True
```
```python
)
```
```python
out_torch
```
```python
,
```
```python
(
```
```python
h_torch
```
```python
,
```
```python
c_torch
```
```python
)
```
```python
=
```
```python
lstm_torch
```
```python
(
```
```python
x_torch
```
```python
,
```
```python
(
```
```python
h_torch
```
```python
,
```
```python
c_torch
```
```python
)
```
```python
)
```
```python
out_torch
```
```python
.
```
```python
backward
```
```python
(
```
```python
dh_torch
```
```python
)
```
```python
h0_numpy
```
```python
,
```
```python
c0_numpy
```
```python
=
```
```python
h_numpy
```
```python
[
```
```python
0
```
```python
]
```
```python
,
```
```python
c_numpy
```
```python
[
```
```python
0
```
```python
]
```
```python
for
```
```python
i
```
```python
in
```
```python
range
```
```python
(
```
```python
3
```
```python
)
```
```python
:
```
```python
h0_numpy
```
```python
,
```
```python
c0_numpy
```
```python
=
```
```python
lstm_numpy
```
```python
(
```
```python
x_numpy
```
```python
[
```
```python
i
```
```python
]
```
```python
,
```
```python
h0_numpy
```
```python
,
```
```python
c0_numpy
```
```python
)
```
```python
for
```
```python
i
```
```python
in
```
```python
reversed
```
```python
(
```
```python
range
```
```python
(
```
```python
3
```
```python
)
```
```python
)
```
```python
:
```
```python
lstm_numpy
```
```python
.
```
```python
backward
```
```python
(
```
```python
dh_numpy
```
```python
[
```
```python
i
```
```python
]
```
```python
)
```
```python
print
```
```python
(
```
```python
"--- 代码输出 ---"
```
```python
)
```
```python
print
```
```python
(
```
```python
"out_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
array
```
```python
(
```
```python
lstm_numpy
```
```python
.
```
```python
h_next_stack
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"out_torch :\n"
```
```python
,
```
```python
out_torch
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"---------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"c_numpy :\n"
```
```python
,
```
```python
c0_numpy
```
```python
)
```
```python
print
```
```python
(
```
```python
"c_torch :\n"
```
```python
,
```
```python
c_torch
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"---------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"dx_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
array
```
```python
(
```
```python
lstm_numpy
```
```python
.
```
```python
dx_list
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"dx_torch :\n"
```
```python
,
```
```python
x_torch
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"---------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"w_ih_grad_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
lstm_numpy
```
```python
.
```
```python
weight_ih_grad_stack
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"w_ih_grad_torch :\n"
```
```python
,
```
```python
lstm_torch
```
```python
.
```
```python
all_weights
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
0
```
```python
]
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"---------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"w_hh_grad_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
lstm_numpy
```
```python
.
```
```python
weight_hh_grad_stack
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"w_hh_grad_torch :\n"
```
```python
,
```
```python
lstm_torch
```
```python
.
```
```python
all_weights
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
1
```
```python
]
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"---------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"b_ih_grad_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
lstm_numpy
```
```python
.
```
```python
bias_ih_grad_stack
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"b_ih_grad_torch :\n"
```
```python
,
```
```python
lstm_torch
```
```python
.
```
```python
all_weights
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
2
```
```python
]
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"---------"
```
```python
)
```
```python
print
```
```python
(
```
```python
"b_hh_grad_numpy :\n"
```
```python
,
```
```python
np
```
```python
.
```
```python
sum
```
```python
(
```
```python
lstm_numpy
```
```python
.
```
```python
bias_hh_grad_stack
```
```python
,
```
```python
axis
```
```python
=
```
```python
0
```
```python
)
```
```python
)
```
```python
print
```
```python
(
```
```python
"b_hh_grad_torch :\n"
```
```python
,
```
```python
lstm_torch
```
```python
.
```
```python
all_weights
```
```python
[
```
```python
0
```
```python
]
```
```python
[
```
```python
3
```
```python
]
```
```python
.
```
```python
grad
```
```python
.
```
```python
data
```
```python
.
```
```python
numpy
```
```python
(
```
```python
)
```
```python
)
```
```python
"""
--- 代码输出 ---
out_numpy :
 [[[ 0.006445  0.235999  0.221529]
  [ 0.034874  0.218051  0.077521]
  [-0.030951  0.145011  0.123065]
  [-0.077813  0.132753  0.223936]]
 [[-0.090284  0.172555  0.01114 ]
  [-0.098488  0.1853    0.012856]
  [-0.082339  0.141583 -0.048317]
  [-0.142443  0.124778  0.034696]]
 [[-0.086721  0.170245 -0.067097]
  [-0.138738  0.147207 -0.077025]
  [-0.161773  0.112377 -0.097439]
  [-0.166661  0.101749 -0.087182]]]
out_torch :
 [[[ 0.006445  0.235999  0.221529]
  [ 0.034874  0.218051  0.077521]
  [-0.030951  0.145011  0.123065]
  [-0.077813  0.132753  0.223936]]
 [[-0.090284  0.172555  0.01114 ]
  [-0.098488  0.1853    0.012856]
  [-0.082339  0.141583 -0.048317]
  [-0.142443  0.124778  0.034696]]
 [[-0.086721  0.170245 -0.067097]
  [-0.138738  0.147207 -0.077025]
  [-0.161773  0.112377 -0.097439]
  [-0.166661  0.101749 -0.087182]]]
---------
c_numpy :
 [[-0.15123   0.267693 -0.113416]
 [-0.242806  0.216831 -0.118585]
 [-0.281794  0.158563 -0.139627]
 [-0.296978  0.143559 -0.132519]]
c_torch :
 [[[-0.15123   0.267693 -0.113416]
  [-0.242806  0.216831 -0.118585]
  [-0.281794  0.158563 -0.139627]
  [-0.296978  0.143559 -0.132519]]]
---------
dx_numpy :
 [[[-0.233995 -0.015056]
  [-0.314481 -0.021608]
  [-0.176089  0.00849 ]
  [-0.314323  0.070071]]
 [[-0.207276 -0.014927]
  [-0.176493 -0.061383]
  [-0.139164 -0.051902]
  [-0.209488  0.068137]]
 [[-0.104086 -0.052976]
  [-0.087995 -0.03669 ]
  [-0.094893 -0.003202]
  [-0.091384 -0.030927]]]
dx_torch :
 [[[-0.233995 -0.015056]
  [-0.314481 -0.021608]
  [-0.176089  0.00849 ]
  [-0.314323  0.070071]]
 [[-0.207276 -0.014927]
  [-0.176493 -0.061383]
  [-0.139164 -0.051902]
  [-0.209488  0.068137]]
 [[-0.104086 -0.052976]
  [-0.087995 -0.03669 ]
  [-0.094893 -0.003202]
  [-0.091384 -0.030927]]]
---------
w_ih_grad_numpy :
 [[-0.309665 -0.286389]
 [ 0.119474  0.1197  ]
 [-0.060895 -0.053575]
 [ 0.081656  0.069246]
 [ 0.343434  0.306735]
 [ 0.238902  0.180056]
 [ 0.799281  0.762242]
 [ 1.66807   1.574547]
 [ 0.878086  0.861914]
 [-0.134765 -0.128521]
 [ 0.202337  0.194739]
 [ 0.043419  0.034041]]
w_ih_grad_torch :
 [[-0.309665 -0.286389]
 [ 0.119474  0.1197  ]
 [-0.060895 -0.053575]
 [ 0.081656  0.069246]
 [ 0.343434  0.306735]
 [ 0.238902  0.180056]
 [ 0.799281  0.762242]
 [ 1.66807   1.574547]
 [ 0.878086  0.861914]
 [-0.134765 -0.128521]
 [ 0.202337  0.194739]
 [ 0.043419  0.034041]]
---------
w_hh_grad_numpy :
 [[-0.080813 -0.141149 -0.13131 ]
 [ 0.031354  0.062847  0.063331]
 [ 0.011833 -0.017525 -0.007764]
 [ 0.082655  0.059767  0.089204]
 [ 0.154359  0.176164  0.180268]
 [ 0.096947  0.111974  0.105654]
 [ 0.185689  0.399495  0.394687]
 [ 0.454164  0.778306  0.671739]
 [ 0.22264   0.398373  0.417446]
 [ 0.006327 -0.046814 -0.022775]
 [ 0.070304  0.103367  0.09488 ]
 [ 0.029992  0.027785  0.034   ]]
w_hh_grad_torch :
 [[-0.080813 -0.141149 -0.13131 ]
 [ 0.031354  0.062847  0.063331]
 [ 0.011833 -0.017525 -0.007764]
 [ 0.082655  0.059767  0.089204]
 [ 0.154359  0.176164  0.180268]
 [ 0.096947  0.111974  0.105654]
 [ 0.185689  0.399495  0.394687]
 [ 0.454164  0.778306  0.671739]
 [ 0.22264   0.398373  0.417446]
 [ 0.006327 -0.046814 -0.022775]
 [ 0.070304  0.103367  0.09488 ]
 [ 0.029992  0.027785  0.034   ]]
---------
b_ih_grad_numpy :
 [-0.545791  0.260244 -0.103962  0.141001  0.622189  0.328654  1.623599
  3.035249  1.506    -0.245668  0.394114  0.060554]
b_ih_grad_torch :
 [-0.545791  0.260244 -0.103962  0.141001  0.622189  0.328654  1.623599
  3.035249  1.506    -0.245668  0.394114  0.060554]
---------
b_hh_grad_numpy :
 [-0.545791  0.260244 -0.103962  0.141001  0.622189  0.328654  1.623599
  3.035249  1.506    -0.245668  0.394114  0.060554]
b_hh_grad_torch :
 [-0.545791  0.260244 -0.103962  0.141001  0.622189  0.328654  1.623599
  3.035249  1.506    -0.245668  0.394114  0.060554]
"""
```

