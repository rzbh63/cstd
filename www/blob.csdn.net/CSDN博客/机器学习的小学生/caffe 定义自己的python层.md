
# caffe 定义自己的python层 - 机器学习的小学生 - CSDN博客


2017年06月14日 16:19:22[机器学习的小学生](https://me.csdn.net/xuluhui123)阅读数：2166


因为caffe底层是用c++编写的，所以我们有的时候想要添加某一个最新文献出来的新算法，正常的方法是直接编写c++网络层，然而这个有个前提条件是必须对caffe的底层非常熟悉，c++的编写达到一定的境界，才可灵活应用caffe，搞深度学习，走这条路对于菜鸟来说无疑很有难度。
好在caffe为我们提供了一个可以用python编写新的网络层的方法，直接用python语言编写新的网络层，然后在caffe的网络配置文件，稍作修改，就可以轻松容易创建新的网络层。
## 简单的示例：
为了方便测试，除了输入层，测试网络仅定义了两个操作层：Pool层和 自定义的Python 层。自定义层完成的功能仅是在数据上加上了一个常数。因此仅需要定义前向传播即可。
**test_pro.prototxt :**
```python
name:
```
```python
"poolnet"
```
```python
layer {
  name:
```
```python
"data"
```
```python
type:
```
```python
"Input"
```
```python
top:
```
```python
"data"
```
```python
input_param { shape: { dim:
```
```python
1
```
```python
dim:
```
```python
3
```
```python
dim:
```
```python
512
```
```python
dim:
```
```python
512
```
```python
} }
}
layer {
  name:
```
```python
"pool1"
```
```python
type:
```
```python
"Pooling"
```
```python
bottom:
```
```python
"data"
```
```python
top:
```
```python
"pool1"
```
```python
pooling_param {
    pool: MAX
    kernel_size:
```
```python
2
```
```python
stride:
```
```python
2
```
```python
}
}
layer {
  name:
```
```python
'MyPythonLayer'
```
```python
type:
```
```python
'Python'
```
```python
top:
```
```python
'output'
```
```python
bottom:
```
```python
'pool1'
```
```python
python_param {
    module:
```
```python
'mypythonlayer'
```
```python
#mypythonlayer.py
```
```python
layer:
```
```python
'MyLayer'
```
```python
# 层的类名和mypythonlayer.py中一致
```
```python
param_str:
```
```python
"'num': 10,'name':gyl"
```
```python
#层参数
```
```python
}
}
```
**mypythonlayer.py**
yaml的作用仅是从str类型的`'num: 10'`中解析出10，当然也可以通过其他方法。
```python
# coding=gbk
```
```python
import
```
```python
caffe
```
```python
import
```
```python
numpy
```
```python
as
```
```python
np
```
```python
import
```
```python
yaml
```
```python
class
```
```python
MyLayer
```
```python
(caffe.Layer)
```
```python
:
```
```python
def
```
```python
setup
```
```python
(self,bottom,top)
```
```python
:
```
```python
self.num = yaml.load(self.param_str)[
```
```python
"num"
```
```python
]
```
```python
# 或者使用下面的形式解析：
```
```python
# params = eval(self.param_str)
```
```python
# self.num = params['num']
```
```python
# self.name = params['name']
```
```python
print
```
```python
'Parameter num :'
```
```python
,self.num
```
```python
def
```
```python
reshape
```
```python
(self,bottom,up)
```
```python
:
```
```python
pass
```
```python
;
```
```python
def
```
```python
forward
```
```python
(self,bottom,top)
```
```python
:
```
```python
top[
```
```python
0
```
```python
].reshape(*bottom[
```
```python
0
```
```python
].shape)
        top[
```
```python
0
```
```python
].data[...] = bottom[
```
```python
0
```
```python
].data + self.num
```
```python
def
```
```python
backward
```
```python
(self,top,propagate_down,bottom)
```
```python
:
```
```python
pass
```
**test_newaddlayer.py**
```python
# coding=gbk
```
```python
from
```
```python
scipy.misc.pilutil
```
```python
import
```
```python
*
```
```python
# read image
```
```python
import
```
```python
matplotlib.pyplot
```
```python
as
```
```python
plt
```
```python
# show image
```
```python
import
```
```python
numpy
```
```python
as
```
```python
np
```
```python
# 两个方法都用
```
```python
from
```
```python
numpy
```
```python
import
```
```python
*
```
```python
import
```
```python
tempfile
```
```python
import
```
```python
caffe
```
```python
from
```
```python
caffe
```
```python
import
```
```python
layers
```
```python
as
```
```python
L
```
```python
from
```
```python
caffe
```
```python
import
```
```python
params
```
```python
as
```
```python
P
```
```python
from
```
```python
caffe
```
```python
import
```
```python
*
```
```python
import
```
```python
os
```
```python
import
```
```python
h5py
```
```python
# hdf5
```
```python
import
```
```python
scipy.io
```
```python
as
```
```python
sio
```
```python
# load .mat file 会按照原样导入到matlab,即行列不发生变化。
```
```python
from
```
```python
mat4py
```
```python
import
```
```python
*
```
```python
#  loadmat
```
```python
net = caffe.Net(
```
```python
'test_pro.prototxt'
```
```python
,caffe.TEST)
im = np.array(imread(
```
```python
'lena.jpg'
```
```python
))
```
```python
print
```
```python
im.shape
```
```python
#
```
```python
im = im[:,:,(
```
```python
2
```
```python
,
```
```python
1
```
```python
,
```
```python
0
```
```python
)] 
im = np.transpose(im,(
```
```python
2
```
```python
,
```
```python
0
```
```python
,
```
```python
1
```
```python
))
```
```python
# h*w*c to c * h * w
```
```python
net.blobs[
```
```python
'data'
```
```python
].reshape(
```
```python
1
```
```python
,
```
```python
3
```
```python
,
```
```python
512
```
```python
,
```
```python
512
```
```python
)
```
```python
# channels height width
```
```python
net.blobs[
```
```python
'data'
```
```python
].data[...] = im
net.forward()
```
```python
### check result
```
```python
pool_img = net.blobs[
```
```python
'pool1'
```
```python
].data
output   = net.blobs[
```
```python
'output'
```
```python
].data
```
```python
print
```
```python
sum(abs(pool_img-output))
pool_img = pool_img +
```
```python
10
```
```python
print
```
```python
sum(abs(pool_img-output))
```
```python
# result =0
```
测试过程为，我们输入一幅图像，然后进行一次前向传播，将采样层的结果和最后输出的结果直接是不是相差一个常数。
## 一个学习示例：
Fully Convolutional Networks for Semantic Segmentation 论文中公布的[代码](https://github.com/shelhamer/fcn.berkeleyvision.org)作为示例：
1. 可以学习一下如何自定义python层。
2. 可以学习一下如何 利用：
```python
from
```
```python
caffe import layers
```
```python
as
```
```python
L,
```
```python
params
```
```python
as
```
```python
P
```
用代码创建prototxt协议。这对程序过程中需要修改协议的内容很重要。
代码也可以从网盘中下载：
[http://pan.baidu.com/s/1bpB5w79](http://pan.baidu.com/s/1bpB5w79)
参考文献:
1.[http://christopher5106.github.io/deep/learning/2015/09/04/Deep-learning-tutorial-on-Caffe-Technology.html](http://christopher5106.github.io/deep/learning/2015/09/04/Deep-learning-tutorial-on-Caffe-Technology.html)
2.[http://blog.csdn.net/hjimce/article/details/51884024?locationNum=12&fps=1](http://blog.csdn.net/hjimce/article/details/51884024?locationNum=12&fps=1)
3.E:\caffe-windows-lib\examples\pycaffe\layers [pycaffe 例子]

