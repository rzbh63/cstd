
# lstm in caffe - 机器学习的小学生 - CSDN博客


2019年03月06日 21:28:36[机器学习的小学生](https://me.csdn.net/xuluhui123)阅读数：45个人分类：[Caffe																](https://blog.csdn.net/xuluhui123/article/category/6777566)[LSTM																](https://blog.csdn.net/xuluhui123/article/category/8739928)[
							](https://blog.csdn.net/xuluhui123/article/category/6777566)



```python
// Message that stores parameters used by RecurrentLayer
```
```python
message RecurrentParameter
```
```python
{
```
```python
// The dimension of the output (and usually hidden state) representation --
```
```python
// must be explicitly set to non-zero.
```
```python
optional uint32 num_output
```
```python
=
```
```python
1
```
```python
[
```
```python
default
```
```python
=
```
```python
0
```
```python
]
```
```python
;
```
```python
optional FillerParameter weight_filler
```
```python
=
```
```python
2
```
```python
;
```
```python
// The filler for the weight
```
```python
optional FillerParameter bias_filler
```
```python
=
```
```python
3
```
```python
;
```
```python
// The filler for the bias
```
```python
// Whether to enable displaying debug_info in the unrolled recurrent net.
```
```python
optional bool debug_info
```
```python
=
```
```python
4
```
```python
[
```
```python
default
```
```python
=
```
```python
false
```
```python
]
```
```python
;
```
```python
// Whether to add as additional inputs (bottoms) the initial hidden state
```
```python
// blobs, and add as additional outputs (tops) the final timestep hidden state
```
```python
// blobs.  The number of additional bottom/top blobs required depends on the
```
```python
// recurrent architecture -- e.g., 1 for RNNs, 2 for LSTMs.
```
```python
optional bool expose_hidden
```
```python
=
```
```python
5
```
```python
[
```
```python
default
```
```python
=
```
```python
false
```
```python
]
```
```python
;
```
```python
}
```
```python
from
```
```python
caffe
```
```python
import
```
```python
layers
```
```python
as
```
```python
L
```
```python
,
```
```python
params
```
```python
as
```
```python
P
```
```python
,
```
```python
to_proto
```
```python
import
```
```python
caffe
```
```python
# some utility functions
```
```python
def
```
```python
add_layer_to_net_spec
```
```python
(
```
```python
ns
```
```python
,
```
```python
caffe_layer
```
```python
,
```
```python
name
```
```python
,
```
```python
*
```
```python
args
```
```python
,
```
```python
**
```
```python
kwargs
```
```python
)
```
```python
:
```
```python
kwargs
```
```python
.
```
```python
update
```
```python
(
```
```python
{
```
```python
'name'
```
```python
:
```
```python
name
```
```python
}
```
```python
)
```
```python
l
```
```python
=
```
```python
caffe_layer
```
```python
(
```
```python
*
```
```python
args
```
```python
,
```
```python
**
```
```python
kwargs
```
```python
)
```
```python
ns
```
```python
.
```
```python
__setattr__
```
```python
(
```
```python
name
```
```python
,
```
```python
l
```
```python
)
```
```python
return
```
```python
ns
```
```python
.
```
```python
__getattr__
```
```python
(
```
```python
name
```
```python
)
```
```python
def
```
```python
add_layer_with_multiple_tops
```
```python
(
```
```python
ns
```
```python
,
```
```python
caffe_layer
```
```python
,
```
```python
lname
```
```python
,
```
```python
ntop
```
```python
,
```
```python
*
```
```python
args
```
```python
,
```
```python
**
```
```python
kwargs
```
```python
)
```
```python
:
```
```python
kwargs
```
```python
.
```
```python
update
```
```python
(
```
```python
{
```
```python
'name'
```
```python
:
```
```python
lname
```
```python
,
```
```python
'ntop'
```
```python
:
```
```python
ntop
```
```python
}
```
```python
)
```
```python
num_in
```
```python
=
```
```python
len
```
```python
(
```
```python
args
```
```python
)
```
```python
-
```
```python
ntop
```
```python
# number of input blobs
```
```python
tops
```
```python
=
```
```python
caffe_layer
```
```python
(
```
```python
*
```
```python
args
```
```python
[
```
```python
:
```
```python
num_in
```
```python
]
```
```python
,
```
```python
**
```
```python
kwargs
```
```python
)
```
```python
for
```
```python
i
```
```python
in
```
```python
range
```
```python
(
```
```python
ntop
```
```python
)
```
```python
:
```
```python
ns
```
```python
.
```
```python
__setattr__
```
```python
(
```
```python
args
```
```python
[
```
```python
num_in
```
```python
+
```
```python
i
```
```python
]
```
```python
,
```
```python
tops
```
```python
[
```
```python
i
```
```python
]
```
```python
)
```
```python
return
```
```python
tops
```
```python
# implement single time step LSTM unit
```
```python
def
```
```python
single_time_step_lstm
```
```python
(
```
```python
ns
```
```python
,
```
```python
h0
```
```python
,
```
```python
c0
```
```python
,
```
```python
x
```
```python
,
```
```python
prefix
```
```python
,
```
```python
num_output
```
```python
,
```
```python
weight_names
```
```python
=
```
```python
None
```
```python
)
```
```python
:
```
```python
"""
    see arXiv:1511.04119v1
    """
```
```python
if
```
```python
weight_names
```
```python
is
```
```python
None
```
```python
:
```
```python
weight_names
```
```python
=
```
```python
[
```
```python
'w_'
```
```python
+
```
```python
prefix
```
```python
+
```
```python
nm
```
```python
for
```
```python
nm
```
```python
in
```
```python
[
```
```python
'Mxw'
```
```python
,
```
```python
'Mxb'
```
```python
,
```
```python
'Mhw'
```
```python
]
```
```python
]
```
```python
# full InnerProduct (incl. bias) for x input
```
```python
Mx
```
```python
=
```
```python
add_layer_to_net_spec
```
```python
(
```
```python
ns
```
```python
,
```
```python
L
```
```python
.
```
```python
InnerProduct
```
```python
,
```
```python
prefix
```
```python
+
```
```python
'lstm/Mx'
```
```python
,
```
```python
x
```
```python
,
```
```python
inner_product_param
```
```python
=
```
```python
{
```
```python
'num_output'
```
```python
:
```
```python
4
```
```python
*
```
```python
num_output
```
```python
,
```
```python
'axis'
```
```python
:
```
```python
2
```
```python
,
```
```python
'weight_filler'
```
```python
:
```
```python
{
```
```python
'type'
```
```python
:
```
```python
'uniform'
```
```python
,
```
```python
'min'
```
```python
:
```
```python
-
```
```python
0.05
```
```python
,
```
```python
'max'
```
```python
:
```
```python
0.05
```
```python
}
```
```python
,
```
```python
'bias_filler'
```
```python
:
```
```python
{
```
```python
'type'
```
```python
:
```
```python
'constant'
```
```python
,
```
```python
'value'
```
```python
:
```
```python
0
```
```python
}
```
```python
}
```
```python
,
```
```python
param
```
```python
=
```
```python
[
```
```python
{
```
```python
'lr_mult'
```
```python
:
```
```python
1
```
```python
,
```
```python
'decay_mult'
```
```python
:
```
```python
1
```
```python
,
```
```python
'name'
```
```python
:
```
```python
weight_names
```
```python
[
```
```python
0
```
```python
]
```
```python
}
```
```python
,
```
```python
{
```
```python
'lr_mult'
```
```python
:
```
```python
2
```
```python
,
```
```python
'decay_mult'
```
```python
:
```
```python
0
```
```python
,
```
```python
'name'
```
```python
:
```
```python
weight_names
```
```python
[
```
```python
1
```
```python
]
```
```python
}
```
```python
]
```
```python
)
```
```python
Mh
```
```python
=
```
```python
add_layer_to_net_spec
```
```python
(
```
```python
ns
```
```python
,
```
```python
L
```
```python
.
```
```python
InnerProduct
```
```python
,
```
```python
prefix
```
```python
+
```
```python
'lstm/Mh'
```
```python
,
```
```python
h0
```
```python
,
```
```python
inner_product_param
```
```python
=
```
```python
{
```
```python
'num_output'
```
```python
:
```
```python
4
```
```python
*
```
```python
num_output
```
```python
,
```
```python
'axis'
```
```python
:
```
```python
2
```
```python
,
```
```python
'bias_term'
```
```python
:
```
```python
False
```
```python
,
```
```python
'weight_filler'
```
```python
:
```
```python
{
```
```python
'type'
```
```python
:
```
```python
'uniform'
```
```python
,
```
```python
'min'
```
```python
:
```
```python
-
```
```python
0.05
```
```python
,
```
```python
'max'
```
```python
:
```
```python
0.05
```
```python
}
```
```python
,
```
```python
'bias_filler'
```
```python
:
```
```python
{
```
```python
'type'
```
```python
:
```
```python
'constant'
```
```python
,
```
```python
'value'
```
```python
:
```
```python
0
```
```python
}
```
```python
}
```
```python
,
```
```python
param
```
```python
=
```
```python
{
```
```python
'lr_mult'
```
```python
:
```
```python
1
```
```python
,
```
```python
'decay_mult'
```
```python
:
```
```python
1
```
```python
,
```
```python
'name'
```
```python
:
```
```python
weight_names
```
```python
[
```
```python
2
```
```python
]
```
```python
}
```
```python
)
```
```python
M
```
```python
=
```
```python
add_layer_to_net_spec
```
```python
(
```
```python
ns
```
```python
,
```
```python
L
```
```python
.
```
```python
Eltwise
```
```python
,
```
```python
prefix
```
```python
+
```
```python
'lstm/Mx+Mh'
```
```python
,
```
```python
Mx
```
```python
,
```
```python
Mh
```
```python
,
```
```python
eltwise_param
```
```python
=
```
```python
{
```
```python
'operation'
```
```python
:
```
```python
P
```
```python
.
```
```python
Eltwise
```
```python
.
```
```python
SUM
```
```python
}
```
```python
)
```
```python
raw_i1
```
```python
,
```
```python
raw_f1
```
```python
,
```
```python
raw_o1
```
```python
,
```
```python
raw_g1
```
```python
=
```
```python
\
    add_layer_with_multiple_tops
```
```python
(
```
```python
ns
```
```python
,
```
```python
L
```
```python
.
```
```python
Slice
```
```python
,
```
```python
prefix
```
```python
+
```
```python
'lstm/slice'
```
```python
,
```
```python
4
```
```python
,
```
```python
M
```
```python
,
```
```python
prefix
```
```python
+
```
```python
'lstm/raw_i'
```
```python
,
```
```python
prefix
```
```python
+
```
```python
'lstm/raw_f'
```
```python
,
```
```python
prefix
```
```python
+
```
```python
'lstm/raw_o'
```
```python
,
```
```python
prefix
```
```python
+
```
```python
'lstm/raw_g'
```
```python
,
```
```python
slice_param
```
```python
=
```
```python
{
```
```python
'axis'
```
```python
:
```
```python
2
```
```python
,
```
```python
'slice_point'
```
```python
:
```
```python
[
```
```python
num_output
```
```python
,
```
```python
2
```
```python
*
```
```python
num_output
```
```python
,
```
```python
3
```
```python
*
```
```python
num_output
```
```python
]
```
```python
}
```
```python
)
```
```python
i1
```
```python
=
```
```python
add_layer_to_net_spec
```
```python
(
```
```python
ns
```
```python
,
```
```python
L
```
```python
.
```
```python
Sigmoid
```
```python
,
```
```python
prefix
```
```python
+
```
```python
'lstm/i'
```
```python
,
```
```python
raw_i1
```
```python
,
```
```python
in_place
```
```python
=
```
```python
True
```
```python
)
```
```python
f1
```
```python
=
```
```python
add_layer_to_net_spec
```
```python
(
```
```python
ns
```
```python
,
```
```python
L
```
```python
.
```
```python
Sigmoid
```
```python
,
```
```python
prefix
```
```python
+
```
```python
'lstm/f'
```
```python
,
```
```python
raw_f1
```
```python
,
```
```python
in_place
```
```python
=
```
```python
True
```
```python
)
```
```python
o1
```
```python
=
```
```python
add_layer_to_net_spec
```
```python
(
```
```python
ns
```
```python
,
```
```python
L
```
```python
.
```
```python
Sigmoid
```
```python
,
```
```python
prefix
```
```python
+
```
```python
'lstm/o'
```
```python
,
```
```python
raw_o1
```
```python
,
```
```python
in_place
```
```python
=
```
```python
True
```
```python
)
```
```python
g1
```
```python
=
```
```python
add_layer_to_net_spec
```
```python
(
```
```python
ns
```
```python
,
```
```python
L
```
```python
.
```
```python
TanH
```
```python
,
```
```python
prefix
```
```python
+
```
```python
'lstm/g'
```
```python
,
```
```python
raw_g1
```
```python
,
```
```python
in_place
```
```python
=
```
```python
True
```
```python
)
```
```python
c1_f
```
```python
=
```
```python
add_layer_to_net_spec
```
```python
(
```
```python
ns
```
```python
,
```
```python
L
```
```python
.
```
```python
Eltwise
```
```python
,
```
```python
prefix
```
```python
+
```
```python
'lstm/c_f'
```
```python
,
```
```python
f1
```
```python
,
```
```python
c0
```
```python
,
```
```python
eltwise_param
```
```python
=
```
```python
{
```
```python
'operation'
```
```python
:
```
```python
P
```
```python
.
```
```python
Eltwise
```
```python
.
```
```python
PROD
```
```python
}
```
```python
)
```
```python
c1_i
```
```python
=
```
```python
add_layer_to_net_spec
```
```python
(
```
```python
ns
```
```python
,
```
```python
L
```
```python
.
```
```python
Eltwise
```
```python
,
```
```python
prefix
```
```python
+
```
```python
'lstm/c_i'
```
```python
,
```
```python
i1
```
```python
,
```
```python
g1
```
```python
,
```
```python
eltwise_param
```
```python
=
```
```python
{
```
```python
'operation'
```
```python
:
```
```python
P
```
```python
.
```
```python
Eltwise
```
```python
.
```
```python
PROD
```
```python
}
```
```python
)
```
```python
c1
```
```python
=
```
```python
add_layer_to_net_spec
```
```python
(
```
```python
ns
```
```python
,
```
```python
L
```
```python
.
```
```python
Eltwise
```
```python
,
```
```python
prefix
```
```python
+
```
```python
'lstm/c'
```
```python
,
```
```python
c1_f
```
```python
,
```
```python
c1_i
```
```python
,
```
```python
eltwise_param
```
```python
=
```
```python
{
```
```python
'operation'
```
```python
:
```
```python
P
```
```python
.
```
```python
Eltwise
```
```python
.
```
```python
SUM
```
```python
}
```
```python
)
```
```python
act_c
```
```python
=
```
```python
add_layer_to_net_spec
```
```python
(
```
```python
ns
```
```python
,
```
```python
L
```
```python
.
```
```python
TanH
```
```python
,
```
```python
prefix
```
```python
+
```
```python
'lstm/act_c'
```
```python
,
```
```python
c1
```
```python
,
```
```python
in_place
```
```python
=
```
```python
False
```
```python
)
```
```python
# cannot override c - it MUST be preserved for next time step!!!
```
```python
h1
```
```python
=
```
```python
add_layer_to_net_spec
```
```python
(
```
```python
ns
```
```python
,
```
```python
L
```
```python
.
```
```python
Eltwise
```
```python
,
```
```python
prefix
```
```python
+
```
```python
'lstm/h'
```
```python
,
```
```python
o1
```
```python
,
```
```python
act_c
```
```python
,
```
```python
eltwise_param
```
```python
=
```
```python
{
```
```python
'operation'
```
```python
:
```
```python
P
```
```python
.
```
```python
Eltwise
```
```python
.
```
```python
PROD
```
```python
}
```
```python
)
```
```python
return
```
```python
c1
```
```python
,
```
```python
h1
```
```python
,
```
```python
weight_names
```
```python
def
```
```python
exmaple_use_of_lstm
```
```python
(
```
```python
)
```
```python
:
```
```python
T
```
```python
=
```
```python
3
```
```python
# number of time steps
```
```python
B
```
```python
=
```
```python
10
```
```python
# batch size
```
```python
lstm_output
```
```python
=
```
```python
500
```
```python
# dimension of LSTM unit
```
```python
# use net spec
```
```python
ns
```
```python
=
```
```python
caffe
```
```python
.
```
```python
NetSpec
```
```python
(
```
```python
)
```
```python
# we need initial values for h and c
```
```python
ns
```
```python
.
```
```python
h0
```
```python
=
```
```python
L
```
```python
.
```
```python
DummyData
```
```python
(
```
```python
name
```
```python
=
```
```python
'h0'
```
```python
,
```
```python
dummy_data_param
```
```python
=
```
```python
{
```
```python
'shape'
```
```python
:
```
```python
{
```
```python
'dim'
```
```python
:
```
```python
[
```
```python
1
```
```python
,
```
```python
B
```
```python
,
```
```python
lstm_output
```
```python
]
```
```python
}
```
```python
,
```
```python
'data_filler'
```
```python
:
```
```python
{
```
```python
'type'
```
```python
:
```
```python
'constant'
```
```python
,
```
```python
'value'
```
```python
:
```
```python
0
```
```python
}
```
```python
}
```
```python
)
```
```python
ns
```
```python
.
```
```python
c0
```
```python
=
```
```python
L
```
```python
.
```
```python
DummyData
```
```python
(
```
```python
name
```
```python
=
```
```python
'c0'
```
```python
,
```
```python
dummy_data_param
```
```python
=
```
```python
{
```
```python
'shape'
```
```python
:
```
```python
{
```
```python
'dim'
```
```python
:
```
```python
[
```
```python
1
```
```python
,
```
```python
B
```
```python
,
```
```python
lstm_output
```
```python
]
```
```python
}
```
```python
,
```
```python
'data_filler'
```
```python
:
```
```python
{
```
```python
'type'
```
```python
:
```
```python
'constant'
```
```python
,
```
```python
'value'
```
```python
:
```
```python
0
```
```python
}
```
```python
}
```
```python
)
```
```python
# simulate input X over T time steps and B sequences (batch size)
```
```python
ns
```
```python
.
```
```python
X
```
```python
=
```
```python
L
```
```python
.
```
```python
DummyData
```
```python
(
```
```python
name
```
```python
=
```
```python
'X'
```
```python
,
```
```python
dummy_data_param
```
```python
=
```
```python
{
```
```python
'shape'
```
```python
:
```
```python
{
```
```python
'dim'
```
```python
:
```
```python
[
```
```python
T
```
```python
,
```
```python
B
```
```python
,
```
```python
128
```
```python
,
```
```python
10
```
```python
,
```
```python
10
```
```python
]
```
```python
}
```
```python
}
```
```python
)
```
```python
# slice X for T time steps
```
```python
xt
```
```python
=
```
```python
L
```
```python
.
```
```python
Slice
```
```python
(
```
```python
ns
```
```python
.
```
```python
X
```
```python
,
```
```python
name
```
```python
=
```
```python
'slice_X'
```
```python
,
```
```python
ntop
```
```python
=
```
```python
T
```
```python
,
```
```python
slice_param
```
```python
=
```
```python
{
```
```python
'axis'
```
```python
:
```
```python
0
```
```python
,
```
```python
'slice_point'
```
```python
:
```
```python
list
```
```python
(
```
```python
range
```
```python
(
```
```python
1
```
```python
,
```
```python
T
```
```python
)
```
```python
)
```
```python
}
```
```python
)
```
```python
# unroling
```
```python
h
```
```python
=
```
```python
ns
```
```python
.
```
```python
h0
    c
```
```python
=
```
```python
ns
```
```python
.
```
```python
c0
    lstm_weights
```
```python
=
```
```python
None
```
```python
tops
```
```python
=
```
```python
[
```
```python
]
```
```python
for
```
```python
t
```
```python
in
```
```python
range
```
```python
(
```
```python
T
```
```python
)
```
```python
:
```
```python
c
```
```python
,
```
```python
h
```
```python
,
```
```python
lstm_weights
```
```python
=
```
```python
single_time_step_lstm
```
```python
(
```
```python
ns
```
```python
,
```
```python
h
```
```python
,
```
```python
c
```
```python
,
```
```python
xt
```
```python
[
```
```python
t
```
```python
]
```
```python
,
```
```python
't'
```
```python
+
```
```python
str
```
```python
(
```
```python
t
```
```python
)
```
```python
+
```
```python
'/'
```
```python
,
```
```python
lstm_output
```
```python
,
```
```python
lstm_weights
```
```python
)
```
```python
tops
```
```python
.
```
```python
append
```
```python
(
```
```python
h
```
```python
)
```
```python
ns
```
```python
.
```
```python
__setattr__
```
```python
(
```
```python
'c'
```
```python
+
```
```python
str
```
```python
(
```
```python
t
```
```python
)
```
```python
,
```
```python
c
```
```python
)
```
```python
ns
```
```python
.
```
```python
__setattr__
```
```python
(
```
```python
'h'
```
```python
+
```
```python
str
```
```python
(
```
```python
t
```
```python
)
```
```python
,
```
```python
h
```
```python
)
```
```python
# concat all LSTM tops (h[t]) to a single layer
```
```python
ns
```
```python
.
```
```python
H
```
```python
=
```
```python
L
```
```python
.
```
```python
Concat
```
```python
(
```
```python
*
```
```python
tops
```
```python
,
```
```python
name
```
```python
=
```
```python
'concat_h'
```
```python
,
```
```python
concat_param
```
```python
=
```
```python
{
```
```python
'axis'
```
```python
:
```
```python
0
```
```python
}
```
```python
)
```
```python
return
```
```python
ns 
ns
```
```python
=
```
```python
exmaple_use_of_lstm
```
```python
(
```
```python
)
```
```python
with
```
```python
open
```
```python
(
```
```python
'lstm_demo.prototxt'
```
```python
,
```
```python
'w'
```
```python
)
```
```python
as
```
```python
W
```
```python
:
```
```python
W
```
```python
.
```
```python
write
```
```python
(
```
```python
'name: "LSTM using NetSpec example"\n'
```
```python
)
```
```python
W
```
```python
.
```
```python
write
```
```python
(
```
```python
'%s\n'
```
```python
%
```
```python
ns
```
```python
.
```
```python
to_proto
```
```python
(
```
```python
)
```
```python
)
```
lisa-caffe-public-lstm_video_deploy.zip
```python
name: "lstm_joints"
layer {
  name: "data"
  type: "Python"
  top: "data"
  top: "label"
  top: "clip_markers"
  python_param {
    module: "sequence_input_layer"
    layer: "videoReadTrain_RGB"
  }
}
layer {
  name: "conv1"
  type: "Convolution"
  bottom: "data"
  top: "conv1"
  param {
    lr_mult: 1
    decay_mult: 1
  }
  param {
    lr_mult: 2
    decay_mult: 0
  }
  convolution_param {
    num_output: 96
    kernel_size: 7
    stride: 2
    weight_filler {
      type: "gaussian"
      std: 0.01
    }
    bias_filler {
      type: "constant"
      value: 0.1
    }
  }
}
layer {
  name: "relu1"
  type: "ReLU"
  bottom: "conv1"
  top: "conv1"
}
layer {
  name: "pool1"
  type: "Pooling"
  bottom: "conv1"
  top: "pool1"
  pooling_param {
    pool: MAX
    kernel_size: 3
    stride: 2
  }
}
layer {
  name: "norm1"
  type: "LRN"
  bottom: "pool1"
  top: "norm1"
  lrn_param {
    local_size: 5
    alpha: 0.0001
    beta: 0.75
  }
}
layer {
  name: "conv2"
  type: "Convolution"
  bottom: "norm1"
  top: "conv2"
  param {
    lr_mult: 1
    decay_mult: 1
  }
  param {
    lr_mult: 2
    decay_mult: 0
  }
  convolution_param {
    num_output: 384
    kernel_size: 5
    group: 2
    stride: 2
    weight_filler {
      type: "gaussian"
      std: 0.01
    }
    bias_filler {
      type: "constant"
      value: 0.1
    }
  }
}
layer {
  name: "relu2"
  type: "ReLU"
  bottom: "conv2"
  top: "conv2"
}
layer {
  name: "pool2"
  type: "Pooling"
  bottom: "conv2"
  top: "pool2"
  pooling_param {
    pool: MAX
    kernel_size: 3
    stride: 2
  }
}
layer {
  name: "norm2"
  type: "LRN"
  bottom: "pool2"
  top: "norm2"
  lrn_param {
    local_size: 5
    alpha: 0.0001
    beta: 0.75
  }
}
layer {
  name: "conv3"
  type: "Convolution"
  bottom: "norm2"
  top: "conv3"
  param {
    lr_mult: 1
    decay_mult: 1
  }
  param {
    lr_mult: 2
    decay_mult: 0
  }
  convolution_param {
    num_output: 512
    pad: 1
    kernel_size: 3
    weight_filler {
      type: "gaussian"
      std: 0.01
    }
    bias_filler {
      type: "constant"
      value: 0.1
    }
  }
}
layer {
  name: "relu3"
  type: "ReLU"
  bottom: "conv3"
  top: "conv3"
}
layer {
  name: "conv4"
  type: "Convolution"
  bottom: "conv3"
  top: "conv4"
  param {
    lr_mult: 1
    decay_mult: 1
  }
  param {
    lr_mult: 2
    decay_mult: 0
  }
  convolution_param {
    num_output: 512
    pad: 1
    kernel_size: 3
    group: 2
    weight_filler {
      type: "gaussian"
      std: 0.01
    }
    bias_filler {
      type: "constant"
      value: 0.1
    }
  }
}
layer {
  name: "relu4"
  type: "ReLU"
  bottom: "conv4"
  top: "conv4"
}
layer {
  name: "conv5"
  type: "Convolution"
  bottom: "conv4"
  top: "conv5"
  param {
    lr_mult: 1
    decay_mult: 1
  }
  param {
    lr_mult: 2
    decay_mult: 0
  }
  convolution_param {
    num_output: 384
    pad: 1
    kernel_size: 3
    group: 2
    weight_filler {
      type: "gaussian"
      std: 0.01
    }
    bias_filler {
      type: "constant"
      value: 0.1
    }
  }
}
layer {
  name: "relu5"
  type: "ReLU"
  bottom: "conv5"
  top: "conv5"
}
layer {
  name: "pool5"
  type: "Pooling"
  bottom: "conv5"
  top: "pool5"
  pooling_param {
    pool: MAX
    kernel_size: 3
    stride: 2
  }
}
layer {
  name: "fc6"
  type: "InnerProduct"
  bottom: "pool5"
  top: "fc6"
  param {
    lr_mult: 1
    decay_mult: 1
  }
  param {
    lr_mult: 2
    decay_mult: 0
  }
  inner_product_param {
    num_output: 4096
    weight_filler {
      type: "gaussian"
      std: 0.01
    }
    bias_filler {
      type: "constant"
      value: 0.1
    }
  }
}
layer {
  name: "relu6"
  type: "ReLU"
  bottom: "fc6"
  top: "fc6"
}
layer {
  name: "drop6"
  type: "Dropout"
  bottom: "fc6"
  top: "fc6"
  dropout_param {
    dropout_ratio: 0.9
  }
}
layer{
  name: "reshape-data"
  type: "Reshape"
  bottom: "fc6"
  top: "fc6-reshape"
  reshape_param{
    shape{
      dim: 16
      dim: 24
      dim: 4096
    }
  }
}
layer{
  name: "reshape-label"
  type: "Reshape"
  bottom: "label"
  top: "reshape-label"
  reshape_param{
    shape{
      dim: 16
      dim: 24
    }
  }
}
layer{
  name: "reshape-cm"
  type: "Reshape"
  bottom: "clip_markers"
  top: "reshape-cm"
  reshape_param{
    shape{
      dim: 16
      dim: 24
    }
  }
}
layer {
  name: "lstm1"
  type: "LSTM"
  bottom: "fc6-reshape"
  bottom: "reshape-cm"
  top: "lstm1"
  recurrent_param {
    num_output: 256
    weight_filler {
      type: "uniform"
      min: -0.01
      max: 0.01
    }
    bias_filler {
      type: "constant"
      value: 0
    }
  }
}
layer {
  name: "lstm1-drop"
  type: "Dropout"
  bottom: "lstm1"
  top: "lstm1-drop"
  dropout_param {
    dropout_ratio: 0.5
  }
}
layer {
  name: "fc8-final"
  type: "InnerProduct"
  bottom: "lstm1-drop"
  top: "fc8-final"
  param {
    lr_mult: 10
    decay_mult: 1
  }
  param {
    lr_mult: 20
    decay_mult: 0
  }
  inner_product_param {
    num_output: 101
    weight_filler {
      type: "gaussian"
      std: 0.01
    }
    bias_filler {
      type: "constant"
      value: 0
    }
    axis: 2
  }
}
layer {
  name: "loss"
  type: "SoftmaxWithLoss"
  bottom: "fc8-final"
  bottom: "reshape-label"
  top: "loss"
  softmax_param {
    axis: 2
  }
}
```
需要注意的是：fc8-final 和 loss层有个axis=2的参数。
prototxt可视化：
![在这里插入图片描述](https://img-blog.csdnimg.cn/20190309140120914.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3h1bHVodWkxMjM=,size_16,color_FFFFFF,t_70)
检查协议中的blobs形状：
[
](https://img-blog.csdnimg.cn/20190309140120914.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3h1bHVodWkxMjM=,size_16,color_FFFFFF,t_70)
```python
loss1
```
```python
[
```
```python
it
```
```python
]
```
```python
=
```
```python
mysolver
```
```python
.
```
```python
net
```
```python
.
```
```python
blobs
```
```python
[
```
```python
'loss'
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
copy
```
```python
(
```
```python
)
```
```python
data
```
```python
=
```
```python
mysolver
```
```python
.
```
```python
net
```
```python
.
```
```python
blobs
```
```python
[
```
```python
'data'
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
copy
```
```python
(
```
```python
)
```
```python
fc6
```
```python
=
```
```python
mysolver
```
```python
.
```
```python
net
```
```python
.
```
```python
blobs
```
```python
[
```
```python
'fc6'
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
copy
```
```python
(
```
```python
)
```
```python
label
```
```python
=
```
```python
mysolver
```
```python
.
```
```python
net
```
```python
.
```
```python
blobs
```
```python
[
```
```python
'label'
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
copy
```
```python
(
```
```python
)
```
```python
clip_markers
```
```python
=
```
```python
mysolver
```
```python
.
```
```python
net
```
```python
.
```
```python
blobs
```
```python
[
```
```python
'clip_markers'
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
copy
```
```python
(
```
```python
)
```
```python
fc6_reshape
```
```python
=
```
```python
mysolver
```
```python
.
```
```python
net
```
```python
.
```
```python
blobs
```
```python
[
```
```python
'fc6-reshape'
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
copy
```
```python
(
```
```python
)
```
```python
reshape_label
```
```python
=
```
```python
mysolver
```
```python
.
```
```python
net
```
```python
.
```
```python
blobs
```
```python
[
```
```python
'reshape-label'
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
copy
```
```python
(
```
```python
)
```
```python
reshape_cm
```
```python
=
```
```python
mysolver
```
```python
.
```
```python
net
```
```python
.
```
```python
blobs
```
```python
[
```
```python
'reshape-cm'
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
copy
```
```python
(
```
```python
)
```
```python
lstm1
```
```python
=
```
```python
mysolver
```
```python
.
```
```python
net
```
```python
.
```
```python
blobs
```
```python
[
```
```python
'lstm1'
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
copy
```
```python
(
```
```python
)
```
```python
fc8_final
```
```python
=
```
```python
mysolver
```
```python
.
```
```python
net
```
```python
.
```
```python
blobs
```
```python
[
```
```python
'fc8-final'
```
```python
]
```
```python
.
```
```python
data
```
```python
.
```
```python
copy
```
```python
(
```
```python
)
```
```python
# 24 the number of video , train_buffer
```
```python
# 16 the length of processed clip, train_frames
```
```python
print
```
```python
(
```
```python
'data: '
```
```python
,
```
```python
data
```
```python
.
```
```python
shape
```
```python
)
```
```python
print
```
```python
(
```
```python
'fc6: '
```
```python
,
```
```python
fc6
```
```python
.
```
```python
shape
```
```python
)
```
```python
print
```
```python
(
```
```python
'label: '
```
```python
,
```
```python
label
```
```python
.
```
```python
shape
```
```python
)
```
```python
print
```
```python
(
```
```python
'clip_markers: '
```
```python
,
```
```python
clip_markers
```
```python
.
```
```python
shape
```
```python
)
```
```python
print
```
```python
(
```
```python
'fc6_reshape: '
```
```python
,
```
```python
fc6_reshape
```
```python
.
```
```python
shape
```
```python
)
```
```python
print
```
```python
(
```
```python
'reshape_cm: '
```
```python
,
```
```python
reshape_cm
```
```python
.
```
```python
shape
```
```python
)
```
```python
print
```
```python
(
```
```python
'lstm1: '
```
```python
,
```
```python
lstm1
```
```python
.
```
```python
shape
```
```python
)
```
```python
print
```
```python
(
```
```python
'reshape_label: '
```
```python
,
```
```python
reshape_label
```
```python
.
```
```python
shape
```
```python
)
```
```python
print
```
```python
(
```
```python
'fc8-final: '
```
```python
,
```
```python
fc8_final
```
```python
.
```
```python
shape
```
```python
)
```
```python
print
```
```python
(
```
```python
'shape over...'
```
```python
)
```
```python
exit
```
```python
(
```
```python
-
```
```python
1
```
```python
)
```
[
](https://img-blog.csdnimg.cn/20190309140120914.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3h1bHVodWkxMjM=,size_16,color_FFFFFF,t_70)输出结果：
[
](https://img-blog.csdnimg.cn/20190309140120914.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3h1bHVodWkxMjM=,size_16,color_FFFFFF,t_70)
```python
(
```
```python
'data: '
```
```python
,
```
```python
(
```
```python
384L
```
```python
,
```
```python
3L
```
```python
,
```
```python
227L
```
```python
,
```
```python
227L
```
```python
)
```
```python
)
```
```python
(
```
```python
'fc6: '
```
```python
,
```
```python
(
```
```python
384L
```
```python
,
```
```python
4096L
```
```python
)
```
```python
)
```
```python
(
```
```python
'label: '
```
```python
,
```
```python
(
```
```python
384L
```
```python
,
```
```python
)
```
```python
)
```
```python
(
```
```python
'clip_markers: '
```
```python
,
```
```python
(
```
```python
384L
```
```python
,
```
```python
)
```
```python
)
```
```python
(
```
```python
'fc6_reshape: '
```
```python
,
```
```python
(
```
```python
16L
```
```python
,
```
```python
24L
```
```python
,
```
```python
4096L
```
```python
)
```
```python
)
```
```python
(
```
```python
'reshape_cm: '
```
```python
,
```
```python
(
```
```python
16L
```
```python
,
```
```python
24L
```
```python
)
```
```python
)
```
```python
(
```
```python
'lstm1: '
```
```python
,
```
```python
(
```
```python
16L
```
```python
,
```
```python
24L
```
```python
,
```
```python
256L
```
```python
)
```
```python
)
```
```python
(
```
```python
'reshape_label: '
```
```python
,
```
```python
(
```
```python
16L
```
```python
,
```
```python
24L
```
```python
)
```
```python
)
```
```python
(
```
```python
'fc8-final: '
```
```python
,
```
```python
(
```
```python
16L
```
```python
,
```
```python
24L
```
```python
,
```
```python
101L
```
```python
)
```
```python
)
```
```python
shape over
```
```python
.
```
```python
.
```
```python
.
```
[
](https://img-blog.csdnimg.cn/20190309140120914.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3h1bHVodWkxMjM=,size_16,color_FFFFFF,t_70)参考文献：
[
](https://img-blog.csdnimg.cn/20190309140120914.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3h1bHVodWkxMjM=,size_16,color_FFFFFF,t_70)[https://blog.csdn.net/mounty_fsc/article/details/53114698](https://blog.csdn.net/mounty_fsc/article/details/53114698)[（Caffe）LSTM层分析]
[https://stackoverflow.com/questions/32225388/lstm-module-for-caffe\#](https://stackoverflow.com/questions/32225388/lstm-module-for-caffe#)[代码来自于该网址]
[
            ](https://img-blog.csdnimg.cn/20190309140120914.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3h1bHVodWkxMjM=,size_16,color_FFFFFF,t_70)

