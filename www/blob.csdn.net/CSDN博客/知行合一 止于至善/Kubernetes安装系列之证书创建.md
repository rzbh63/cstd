
# Kubernetes安装系列之证书创建 - 知行合一 止于至善 - CSDN博客

2019年03月23日 08:10:35[liumiaocn](https://me.csdn.net/liumiaocn)阅读数：222所属专栏：[深入浅出kubernetes](https://blog.csdn.net/column/details/12761.html)



这篇文章整理以下证书的创建方法，本文以脚本的方式进行固化，内容仍然放在github的easypack上。
# 整体操作
[https://blog.csdn.net/liumiaocn/article/details/88413428](https://blog.csdn.net/liumiaocn/article/details/88413428)
# CA相关
## ca-config.json
ca-config这里直接创建用于etcd和k8s的profile，详细内容如下所示
```python
[
```
```python
root@host131 ca
```
```python
]
```
```python
# cat ca
```
```python
-
```
```python
config
```
```python
.
```
```python
json
```
```python
{
```
```python
"signing"
```
```python
:
```
```python
{
```
```python
"default"
```
```python
:
```
```python
{
```
```python
"expiry"
```
```python
:
```
```python
"87600h"
```
```python
}
```
```python
,
```
```python
"profiles"
```
```python
:
```
```python
{
```
```python
"etcd"
```
```python
:
```
```python
{
```
```python
"expiry"
```
```python
:
```
```python
"87600h"
```
```python
,
```
```python
"usages"
```
```python
:
```
```python
[
```
```python
"signing"
```
```python
,
```
```python
"key encipherment"
```
```python
,
```
```python
"server auth"
```
```python
,
```
```python
"client auth"
```
```python
]
```
```python
}
```
```python
,
```
```python
"kubernetes"
```
```python
:
```
```python
{
```
```python
"expiry"
```
```python
:
```
```python
"87600h"
```
```python
,
```
```python
"usages"
```
```python
:
```
```python
[
```
```python
"signing"
```
```python
,
```
```python
"key encipherment"
```
```python
,
```
```python
"server auth"
```
```python
,
```
```python
"client auth"
```
```python
]
```
```python
}
```
```python
}
```
```python
}
```
```python
}
```
```python
[
```
```python
root@host131 ca
```
```python
]
```
```python
#
```
## ca-csr.json
csr文件详细信息如下所示，指定算法类型和长度以及相关的NAMES设定
```python
[
```
```python
root@host131 ca
```
```python
]
```
```python
# cat ca
```
```python
-
```
```python
csr
```
```python
.
```
```python
json
```
```python
{
```
```python
"CN"
```
```python
:
```
```python
"Common CA"
```
```python
,
```
```python
"key"
```
```python
:
```
```python
{
```
```python
"algo"
```
```python
:
```
```python
"rsa"
```
```python
,
```
```python
"size"
```
```python
:
```
```python
2048
```
```python
}
```
```python
,
```
```python
"names"
```
```python
:
```
```python
[
```
```python
{
```
```python
"C"
```
```python
:
```
```python
"CN"
```
```python
,
```
```python
"L"
```
```python
:
```
```python
"DaLian"
```
```python
,
```
```python
"ST"
```
```python
:
```
```python
"LiaoNing"
```
```python
,
```
```python
"O"
```
```python
:
```
```python
"K8S"
```
```python
,
```
```python
"OU"
```
```python
:
```
```python
"System"
```
```python
}
```
```python
]
```
```python
}
```
```python
[
```
```python
root@host131 ca
```
```python
]
```
```python
#
```
# ETCD相关
使用HTTPS方式etcd同样需要证书的设定，因为profile已经在设定，这里只需要csr即可
## csr.json
```python
[
```
```python
root@host131 etcd
```
```python
]
```
```python
# cat cert
```
```python
-
```
```python
etcd
```
```python
-
```
```python
csr
```
```python
.
```
```python
json
```
```python
{
```
```python
"CN"
```
```python
:
```
```python
"etcd"
```
```python
,
```
```python
"hosts"
```
```python
:
```
```python
[
```
```python
""
```
```python
]
```
```python
,
```
```python
"key"
```
```python
:
```
```python
{
```
```python
"algo"
```
```python
:
```
```python
"rsa"
```
```python
,
```
```python
"size"
```
```python
:
```
```python
2048
```
```python
}
```
```python
,
```
```python
"names"
```
```python
:
```
```python
[
```
```python
{
```
```python
"C"
```
```python
:
```
```python
"CN"
```
```python
,
```
```python
"L"
```
```python
:
```
```python
"DaLian"
```
```python
,
```
```python
"ST"
```
```python
:
```
```python
"LiaoNing"
```
```python
}
```
```python
]
```
```python
}
```
```python
[
```
```python
root@host131 etcd
```
```python
]
```
```python
#
```
# K8S
## csr.json
```python
[
```
```python
root@host131 k8s
```
```python
]
```
```python
# cat k8s
```
```python
-
```
```python
csr
```
```python
.
```
```python
json
```
```python
{
```
```python
"CN"
```
```python
:
```
```python
"kubernetes"
```
```python
,
```
```python
"hosts"
```
```python
:
```
```python
[
```
```python
"10.0.0.1"
```
```python
,
```
```python
"127.0.0.1"
```
```python
,
```
```python
"192.168.163.131"
```
```python
,
```
```python
"kubernetes"
```
```python
,
```
```python
"kubernetes.default"
```
```python
,
```
```python
"kubernetes.default.svc"
```
```python
,
```
```python
"kubernetes.default.svc.cluster"
```
```python
,
```
```python
"kubernetes.default.svc.cluster.local"
```
```python
]
```
```python
,
```
```python
"key"
```
```python
:
```
```python
{
```
```python
"algo"
```
```python
:
```
```python
"rsa"
```
```python
,
```
```python
"size"
```
```python
:
```
```python
2048
```
```python
}
```
```python
,
```
```python
"names"
```
```python
:
```
```python
[
```
```python
{
```
```python
"C"
```
```python
:
```
```python
"CN"
```
```python
,
```
```python
"L"
```
```python
:
```
```python
"DaLian"
```
```python
,
```
```python
"ST"
```
```python
:
```
```python
"LiaoNing"
```
```python
,
```
```python
"O"
```
```python
:
```
```python
"K8S"
```
```python
,
```
```python
"OU"
```
```python
:
```
```python
"System"
```
```python
}
```
```python
]
```
```python
}
```
```python
[
```
```python
root@host131 k8s
```
```python
]
```
```python
#
```
# 脚本示例
变量部分抽出，形成如下脚本示例
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
# cat step1-prepare-cert.sh
```
```python
#!/bin/sh
```
```python
.
```
```python
./install.cfg
```
```python
# set cfssl tools in search path
```
```python
chmod
```
```python
755
```
```python
${ENV_HOME_CFSSL}
```
```python
/*
```
```python
if
```
```python
[
```
```python
$?
```
```python
-ne 0
```
```python
]
```
```python
;
```
```python
then
```
```python
echo
```
```python
"prepare downloaded cfssl tools in
```
```python
${ENV_HOME_CFSSL}
```
```python
in advance"
```
```python
exit
```
```python
fi
```
```python
export
```
```python
PATH
```
```python
=
```
```python
${ENV_HOME_CFSSL}
```
```python
:
```
```python
$PATH
```
```python
# create dir for certs when not existing
```
```python
mkdir
```
```python
-p
```
```python
${ENV_SSL_CA_DIR}
```
```python
${ENV_SSL_K8S_DIR}
```
```python
${ENV_SSL_ETCD_DIR}
```
```python
# create ca-config file for etc and k8s profiles
```
```python
cat
```
```python
<<
```
```python
EOF
```
```python
>
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_CA_CONFIG}
```
```python
{
```
```python
"signing"
```
```python
:
```
```python
{
```
```python
"default"
```
```python
:
```
```python
{
```
```python
"expiry"
```
```python
:
```
```python
"
```
```python
${ENV_SSL_DEFAULT_EXPIRY}
```
```python
"
```
```python
}
```
```python
,
```
```python
"profiles"
```
```python
:
```
```python
{
```
```python
"
```
```python
${ENV_SSL_PROFILE_ETCD}
```
```python
"
```
```python
:
```
```python
{
```
```python
"expiry"
```
```python
:
```
```python
"
```
```python
${ENV_SSL_PROFILE_ETCD_EXPIRY}
```
```python
"
```
```python
,
```
```python
"usages"
```
```python
:
```
```python
[
```
```python
"signing"
```
```python
,
```
```python
"key encipherment"
```
```python
,
```
```python
"server auth"
```
```python
,
```
```python
"client auth"
```
```python
]
```
```python
}
```
```python
,
```
```python
"
```
```python
${ENV_SSL_PROFILE_K8S}
```
```python
"
```
```python
:
```
```python
{
```
```python
"expiry"
```
```python
:
```
```python
"
```
```python
${ENV_SSL_PROFILE_K8S_EXPIRY}
```
```python
"
```
```python
,
```
```python
"usages"
```
```python
:
```
```python
[
```
```python
"signing"
```
```python
,
```
```python
"key encipherment"
```
```python
,
```
```python
"server auth"
```
```python
,
```
```python
"client auth"
```
```python
]
```
```python
}
```
```python
}
```
```python
}
```
```python
}
```
```python
EOF
```
```python
# create csr files of ca
```
```python
cat
```
```python
<<
```
```python
EOF
```
```python
>
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_CA_CSR}
```
```python
{
```
```python
"CN"
```
```python
:
```
```python
"
```
```python
${ENV_SSL_CN}
```
```python
"
```
```python
,
```
```python
"key"
```
```python
:
```
```python
{
```
```python
"algo"
```
```python
:
```
```python
"
```
```python
${ENV_SSL_KEY_ALGO}
```
```python
"
```
```python
,
```
```python
"size"
```
```python
:
```
```python
${ENV_SSL_KEY_SIZE}
```
```python
}
```
```python
,
```
```python
"names"
```
```python
:
```
```python
[
```
```python
{
```
```python
"C"
```
```python
:
```
```python
"
```
```python
${ENV_SSL_NAMES_C}
```
```python
"
```
```python
,
```
```python
"L"
```
```python
:
```
```python
"
```
```python
${ENV_SSL_NAMES_L}
```
```python
"
```
```python
,
```
```python
"ST"
```
```python
:
```
```python
"
```
```python
${ENV_SSL_NAMES_ST}
```
```python
"
```
```python
,
```
```python
"O"
```
```python
:
```
```python
"
```
```python
${ENV_SSL_NAMES_O}
```
```python
"
```
```python
,
```
```python
"OU"
```
```python
:
```
```python
"
```
```python
${ENV_SSL_NAMES_OU}
```
```python
"
```
```python
}
```
```python
]
```
```python
}
```
```python
EOF
```
```python
# create csr files of etcd
```
```python
cat
```
```python
<<
```
```python
EOF
```
```python
>
```
```python
${ENV_SSL_ETCD_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_ETCD_CSR}
```
```python
{
```
```python
"CN"
```
```python
:
```
```python
"
```
```python
${ENV_SSL_ETCD_CSR_CN}
```
```python
"
```
```python
,
```
```python
"hosts"
```
```python
:
```
```python
[
```
```python
"127.0.0.1"
```
```python
,
EOF
```
```python
# append etcd hosts list
```
```python
echo
```
```python
${ENV_ETCD_HOSTS}
```
```python
|
```
```python
awk
```
```python
-F
```
```python
" "
```
```python
'{
    for(cnt=1; cnt<NF; cnt++){
        printf("    \"%s\",\n",
```
```python
$cnt
```
```python
);
    }
    printf("    \"%s\"\n",
```
```python
$NF
```
```python
);
}'
```
```python
>>
```
```python
${ENV_SSL_ETCD_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_ETCD_CSR}
```
```python
# append csr files of etcd
```
```python
cat
```
```python
<<
```
```python
EOF
```
```python
>>
```
```python
${ENV_SSL_ETCD_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_ETCD_CSR}
```
```python
]
```
```python
,
```
```python
"key"
```
```python
:
```
```python
{
```
```python
"algo"
```
```python
:
```
```python
"
```
```python
${ENV_SSL_KEY_ALGO}
```
```python
"
```
```python
,
```
```python
"size"
```
```python
:
```
```python
${ENV_SSL_KEY_SIZE}
```
```python
}
```
```python
,
```
```python
"names"
```
```python
:
```
```python
[
```
```python
{
```
```python
"C"
```
```python
:
```
```python
"
```
```python
${ENV_SSL_NAMES_C}
```
```python
"
```
```python
,
```
```python
"L"
```
```python
:
```
```python
"
```
```python
${ENV_SSL_NAMES_L}
```
```python
"
```
```python
,
```
```python
"ST"
```
```python
:
```
```python
"
```
```python
${ENV_SSL_NAMES_ST}
```
```python
"
```
```python
}
```
```python
]
```
```python
}
```
```python
EOF
ODIR
```
```python
=
```
```python
`
```
```python
pwd
```
```python
`
```
```python
cd
```
```python
${ENV_SSL_CA_DIR}
```
```python
cfssl gencert -initca
```
```python
${ENV_SSL_FILE_CA_CSR}
```
```python
|
```
```python
cfssljson -bare ca -
```
```python
# confirm ca pem: ca-key.pem  ca.pem
```
```python
ls
```
```python
${ENV_SSL_CA_DIR}
```
```python
/*.pem
```
```python
echo
```
```python
cd
```
```python
${ENV_SSL_ETCD_DIR}
```
```python
cfssl gencert -ca
```
```python
=
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_CA_PEM}
```
```python
-ca-key
```
```python
=
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_CA_KEY}
```
```python
-config
```
```python
=
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_CA_CONFIG}
```
```python
-profile
```
```python
=
```
```python
${ENV_SSL_PROFILE_ETCD}
```
```python
${ENV_SSL_FILE_ETCD_CSR}
```
```python
|
```
```python
cfssljson -bare
```
```python
${ENV_SSL_ETCD_CERT_PRIFIX}
```
```python
# confirm cert pem: cert-etcd-key.pem  cert-etcd.pem
```
```python
ls
```
```python
${ENV_SSL_ETCD_DIR}
```
```python
/*.pem
```
```python
# Deploy the master node.
```
```python
mkdir
```
```python
-p
```
```python
${ENV_SSL_K8S_DIR}
```
```python
cat
```
```python
>
```
```python
${ENV_SSL_K8S_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_K8S_CSR}
```
```python
<<
```
```python
EOF
{
    "CN": "
```
```python
${ENV_SSL_K8S_CSR_CN}
```
```python
",
    "hosts": [
      "
```
```python
${ENV_SSL_CSR_HOSTS_SRV}
```
```python
",
      "127.0.0.1",
      "
```
```python
${ENV_CURRENT_HOSTIP}
```
```python
",
      "kubernetes",
      "kubernetes.default",
      "kubernetes.default.svc",
      "kubernetes.default.svc.cluster",
      "kubernetes.default.svc.cluster.local"
    ],
    "key": {
        "algo": "
```
```python
${ENV_SSL_KEY_ALGO}
```
```python
",
        "size":
```
```python
${ENV_SSL_KEY_SIZE}
```
```python
},
    "names": [
        {
            "C": "
```
```python
${ENV_SSL_NAMES_C}
```
```python
",
            "L": "
```
```python
${ENV_SSL_NAMES_L}
```
```python
",
            "ST": "
```
```python
${ENV_SSL_NAMES_ST}
```
```python
",
            "O": "
```
```python
${ENV_SSL_NAMES_O}
```
```python
",
            "OU": "
```
```python
${ENV_SSL_NAMES_OU}
```
```python
"
        }
    ]
}
EOF
```
```python
cd
```
```python
${ENV_SSL_K8S_DIR}
```
```python
cfssl gencert -ca
```
```python
=
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_CA_PEM}
```
```python
-ca-key
```
```python
=
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_CA_KEY}
```
```python
-config
```
```python
=
```
```python
${ENV_SSL_CA_DIR}
```
```python
/
```
```python
${ENV_SSL_FILE_CA_CONFIG}
```
```python
-profile
```
```python
=
```
```python
${ENV_SSL_PROFILE_K8S}
```
```python
${ENV_SSL_FILE_K8S_CSR}
```
```python
|
```
```python
cfssljson -bare
```
```python
${ENV_SSL_K8S_CERT_PRIFIX}
```
```python
# confirm cert pem: cert-k8s.pem cert-k8s-key.pem
```
```python
ls
```
```python
${ENV_SSL_K8S_DIR}
```
```python
/*.pem
```
```python
cd
```
```python
$ODIR
```
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
#
```
设定文件install.cfg可参看github的如下路径：
[https://github.com/liumiaocn/easypack/tree/master/k8s/shell](https://github.com/liumiaocn/easypack/tree/master/k8s/shell)
# 执行示例
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
# sh step1-prepare-cert.sh
```
```python
2019/03/23 12:52:59
```
```python
[
```
```python
INFO
```
```python
]
```
```python
generating a new CA key and certificate from CSR
2019/03/23 12:52:59
```
```python
[
```
```python
INFO
```
```python
]
```
```python
generate received request
2019/03/23 12:52:59
```
```python
[
```
```python
INFO
```
```python
]
```
```python
received CSR
2019/03/23 12:52:59
```
```python
[
```
```python
INFO
```
```python
]
```
```python
generating key: rsa-2048
2019/03/23 12:53:00
```
```python
[
```
```python
INFO
```
```python
]
```
```python
encoded CSR
2019/03/23 12:53:00
```
```python
[
```
```python
INFO
```
```python
]
```
```python
signed certificate with serial number 522594825973552740551393335387122698230383282060
/etc/ssl/ca/ca-key.pem	/etc/ssl/ca/ca.pem
2019/03/23 12:53:00
```
```python
[
```
```python
INFO
```
```python
]
```
```python
generate received request
2019/03/23 12:53:00
```
```python
[
```
```python
INFO
```
```python
]
```
```python
received CSR
2019/03/23 12:53:00
```
```python
[
```
```python
INFO
```
```python
]
```
```python
generating key: rsa-2048
2019/03/23 12:53:00
```
```python
[
```
```python
INFO
```
```python
]
```
```python
encoded CSR
2019/03/23 12:53:00
```
```python
[
```
```python
INFO
```
```python
]
```
```python
signed certificate with serial number 534636580185093522229184995802052292016915923665
2019/03/23 12:53:00
```
```python
[
```
```python
WARNING
```
```python
]
```
```python
This certificate lacks a
```
```python
"hosts"
```
```python
field. This makes it unsuitable
```
```python
for
```
```python
websites. For
```
```python
more
```
```python
information see the Baseline Requirements
```
```python
for
```
```python
the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum
```
```python
(
```
```python
https://cabforum.org
```
```python
)
```
```python
;
```
```python
specifically, section 10.2.3
```
```python
(
```
```python
"Information Requirements"
```
```python
)
```
```python
.
/etc/ssl/etcd/cert-etcd-key.pem  /etc/ssl/etcd/cert-etcd.pem
2019/03/23 12:53:00
```
```python
[
```
```python
INFO
```
```python
]
```
```python
generate received request
2019/03/23 12:53:00
```
```python
[
```
```python
INFO
```
```python
]
```
```python
received CSR
2019/03/23 12:53:00
```
```python
[
```
```python
INFO
```
```python
]
```
```python
generating key: rsa-2048
2019/03/23 12:53:01
```
```python
[
```
```python
INFO
```
```python
]
```
```python
encoded CSR
2019/03/23 12:53:01
```
```python
[
```
```python
INFO
```
```python
]
```
```python
signed certificate with serial number 165868783423405993533080348760179682687893058976
2019/03/23 12:53:01
```
```python
[
```
```python
WARNING
```
```python
]
```
```python
This certificate lacks a
```
```python
"hosts"
```
```python
field. This makes it unsuitable
```
```python
for
```
```python
websites. For
```
```python
more
```
```python
information see the Baseline Requirements
```
```python
for
```
```python
the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum
```
```python
(
```
```python
https://cabforum.org
```
```python
)
```
```python
;
```
```python
specifically, section 10.2.3
```
```python
(
```
```python
"Information Requirements"
```
```python
)
```
```python
.
/etc/ssl/k8s/cert-k8s-key.pem  /etc/ssl/k8s/cert-k8s.pem
```
```python
[
```
```python
root@host131 shell
```
```python
]
```
```python
#
```
这样后续安装的TLS证书的主要部分就准备好了，希望修改内容的比如NAMES的信息或者算法以及长度等信息直接调节install.cfg即可。

