
# lstm in pytorch - 机器学习的小学生 - CSDN博客


2019年03月09日 14:43:41[机器学习的小学生](https://me.csdn.net/xuluhui123)阅读数：32


下面是lstm进行手写字符分类示例，将大小为28×28的图像，每一列或者每一行看作是特征维度，那么其对应的每一行或者每一列就是“视频序列帧”。例如看作：28个视频帧，每个视频帧的长度为28维。最后损失函数采用：整个“视频序列帧”即28×28大小的图像，对应单个类别，具体实现为最后一个“视频帧”对应的隐含状态进行后续损失计算（直接参加）。与lstm in caffe中的“ lisa-caffe-public-lstm_video_deploy” 中视频行为识别不一样，在其中将视频序列中的每个图像，都对应一个类别，然后参加损失函数的计算，具体实现是每个“视频帧”对应的隐含状态都参加到后续损失的计算（直接参加）。
```python
import
```
```python
torch
```
```python
import
```
```python
torch
```
```python
.
```
```python
nn
```
```python
as
```
```python
nn
```
```python
import
```
```python
torchvision
```
```python
.
```
```python
transforms
```
```python
as
```
```python
transforms
```
```python
import
```
```python
torchvision
```
```python
.
```
```python
datasets
```
```python
as
```
```python
dsets
```
```python
from
```
```python
torch
```
```python
.
```
```python
autograd
```
```python
import
```
```python
Variable
```
```python
'''
STEP 1: LOADING DATASET
'''
```
```python
train_dataset
```
```python
=
```
```python
dsets
```
```python
.
```
```python
MNIST
```
```python
(
```
```python
root
```
```python
=
```
```python
'./data'
```
```python
,
```
```python
train
```
```python
=
```
```python
True
```
```python
,
```
```python
transform
```
```python
=
```
```python
transforms
```
```python
.
```
```python
ToTensor
```
```python
(
```
```python
)
```
```python
,
```
```python
download
```
```python
=
```
```python
True
```
```python
)
```
```python
test_dataset
```
```python
=
```
```python
dsets
```
```python
.
```
```python
MNIST
```
```python
(
```
```python
root
```
```python
=
```
```python
'./data'
```
```python
,
```
```python
train
```
```python
=
```
```python
False
```
```python
,
```
```python
transform
```
```python
=
```
```python
transforms
```
```python
.
```
```python
ToTensor
```
```python
(
```
```python
)
```
```python
)
```
```python
'''
STEP 2: MAKING DATASET ITERABLE
'''
```
```python
batch_size
```
```python
=
```
```python
64
```
```python
n_iters
```
```python
=
```
```python
3000
```
```python
num_epochs
```
```python
=
```
```python
n_iters
```
```python
/
```
```python
(
```
```python
len
```
```python
(
```
```python
train_dataset
```
```python
)
```
```python
/
```
```python
batch_size
```
```python
)
```
```python
num_epochs
```
```python
=
```
```python
int
```
```python
(
```
```python
num_epochs
```
```python
)
```
```python
train_loader
```
```python
=
```
```python
torch
```
```python
.
```
```python
utils
```
```python
.
```
```python
data
```
```python
.
```
```python
DataLoader
```
```python
(
```
```python
dataset
```
```python
=
```
```python
train_dataset
```
```python
,
```
```python
batch_size
```
```python
=
```
```python
batch_size
```
```python
,
```
```python
shuffle
```
```python
=
```
```python
True
```
```python
)
```
```python
test_loader
```
```python
=
```
```python
torch
```
```python
.
```
```python
utils
```
```python
.
```
```python
data
```
```python
.
```
```python
DataLoader
```
```python
(
```
```python
dataset
```
```python
=
```
```python
test_dataset
```
```python
,
```
```python
batch_size
```
```python
=
```
```python
batch_size
```
```python
,
```
```python
shuffle
```
```python
=
```
```python
False
```
```python
)
```
```python
'''
STEP 3: CREATE MODEL CLASS
'''
```
```python
class
```
```python
LSTMModel
```
```python
(
```
```python
nn
```
```python
.
```
```python
Module
```
```python
)
```
```python
:
```
```python
def
```
```python
__init__
```
```python
(
```
```python
self
```
```python
,
```
```python
input_dim
```
```python
,
```
```python
hidden_dim
```
```python
,
```
```python
layer_dim
```
```python
,
```
```python
output_dim
```
```python
)
```
```python
:
```
```python
super
```
```python
(
```
```python
LSTMModel
```
```python
,
```
```python
self
```
```python
)
```
```python
.
```
```python
__init__
```
```python
(
```
```python
)
```
```python
# Hidden dimensions
```
```python
self
```
```python
.
```
```python
hidden_dim
```
```python
=
```
```python
hidden_dim
```
```python
# Number of hidden layers
```
```python
self
```
```python
.
```
```python
layer_dim
```
```python
=
```
```python
layer_dim
```
```python
# Building your LSTM
```
```python
# batch_first=True causes input/output tensors to be of shape
```
```python
# (batch_dim, seq_dim, feature_dim)
```
```python
self
```
```python
.
```
```python
lstm
```
```python
=
```
```python
nn
```
```python
.
```
```python
LSTM
```
```python
(
```
```python
input_dim
```
```python
,
```
```python
hidden_dim
```
```python
,
```
```python
layer_dim
```
```python
,
```
```python
batch_first
```
```python
=
```
```python
True
```
```python
)
```
```python
# Readout layer
```
```python
self
```
```python
.
```
```python
fc
```
```python
=
```
```python
nn
```
```python
.
```
```python
Linear
```
```python
(
```
```python
hidden_dim
```
```python
,
```
```python
output_dim
```
```python
)
```
```python
def
```
```python
forward
```
```python
(
```
```python
self
```
```python
,
```
```python
x
```
```python
)
```
```python
:
```
```python
# Initialize hidden state with zeros
```
```python
#######################
```
```python
#  USE GPU FOR MODEL  #
```
```python
#######################
```
```python
if
```
```python
torch
```
```python
.
```
```python
cuda
```
```python
.
```
```python
is_available
```
```python
(
```
```python
)
```
```python
:
```
```python
h0
```
```python
=
```
```python
Variable
```
```python
(
```
```python
torch
```
```python
.
```
```python
zeros
```
```python
(
```
```python
self
```
```python
.
```
```python
layer_dim
```
```python
,
```
```python
x
```
```python
.
```
```python
size
```
```python
(
```
```python
0
```
```python
)
```
```python
,
```
```python
self
```
```python
.
```
```python
hidden_dim
```
```python
)
```
```python
.
```
```python
cuda
```
```python
(
```
```python
)
```
```python
)
```
```python
else
```
```python
:
```
```python
h0
```
```python
=
```
```python
Variable
```
```python
(
```
```python
torch
```
```python
.
```
```python
zeros
```
```python
(
```
```python
self
```
```python
.
```
```python
layer_dim
```
```python
,
```
```python
x
```
```python
.
```
```python
size
```
```python
(
```
```python
0
```
```python
)
```
```python
,
```
```python
self
```
```python
.
```
```python
hidden_dim
```
```python
)
```
```python
)
```
```python
# Initialize cell state
```
```python
if
```
```python
torch
```
```python
.
```
```python
cuda
```
```python
.
```
```python
is_available
```
```python
(
```
```python
)
```
```python
:
```
```python
c0
```
```python
=
```
```python
Variable
```
```python
(
```
```python
torch
```
```python
.
```
```python
zeros
```
```python
(
```
```python
self
```
```python
.
```
```python
layer_dim
```
```python
,
```
```python
x
```
```python
.
```
```python
size
```
```python
(
```
```python
0
```
```python
)
```
```python
,
```
```python
self
```
```python
.
```
```python
hidden_dim
```
```python
)
```
```python
.
```
```python
cuda
```
```python
(
```
```python
)
```
```python
)
```
```python
else
```
```python
:
```
```python
c0
```
```python
=
```
```python
Variable
```
```python
(
```
```python
torch
```
```python
.
```
```python
zeros
```
```python
(
```
```python
self
```
```python
.
```
```python
layer_dim
```
```python
,
```
```python
x
```
```python
.
```
```python
size
```
```python
(
```
```python
0
```
```python
)
```
```python
,
```
```python
self
```
```python
.
```
```python
hidden_dim
```
```python
)
```
```python
)
```
```python
# One time step
```
```python
out
```
```python
,
```
```python
(
```
```python
hn
```
```python
,
```
```python
cn
```
```python
)
```
```python
=
```
```python
self
```
```python
.
```
```python
lstm
```
```python
(
```
```python
x
```
```python
,
```
```python
(
```
```python
h0
```
```python
,
```
```python
c0
```
```python
)
```
```python
)
```
```python
# Index hidden state of last time step
```
```python
# out.size() --> 100, 28, 100
```
```python
# out[:, -1, :] --> 100, 100 --> just want last time step hidden states!
```
```python
out
```
```python
=
```
```python
self
```
```python
.
```
```python
fc
```
```python
(
```
```python
out
```
```python
[
```
```python
:
```
```python
,
```
```python
-
```
```python
1
```
```python
,
```
```python
:
```
```python
]
```
```python
)
```
```python
# out.size() --> 100, 10
```
```python
return
```
```python
out
```
```python
'''
STEP 4: INSTANTIATE MODEL CLASS
'''
```
```python
input_dim
```
```python
=
```
```python
28
```
```python
hidden_dim
```
```python
=
```
```python
100
```
```python
layer_dim
```
```python
=
```
```python
3
```
```python
# ONLY CHANGE IS HERE FROM ONE LAYER TO TWO LAYER
```
```python
output_dim
```
```python
=
```
```python
10
```
```python
model
```
```python
=
```
```python
LSTMModel
```
```python
(
```
```python
input_dim
```
```python
,
```
```python
hidden_dim
```
```python
,
```
```python
layer_dim
```
```python
,
```
```python
output_dim
```
```python
)
```
```python
#######################
```
```python
#  USE GPU FOR MODEL  #
```
```python
#######################
```
```python
if
```
```python
torch
```
```python
.
```
```python
cuda
```
```python
.
```
```python
is_available
```
```python
(
```
```python
)
```
```python
:
```
```python
model
```
```python
.
```
```python
cuda
```
```python
(
```
```python
)
```
```python
'''
STEP 5: INSTANTIATE LOSS CLASS
'''
```
```python
criterion
```
```python
=
```
```python
nn
```
```python
.
```
```python
CrossEntropyLoss
```
```python
(
```
```python
)
```
```python
'''
STEP 6: INSTANTIATE OPTIMIZER CLASS
'''
```
```python
learning_rate
```
```python
=
```
```python
0.1
```
```python
optimizer
```
```python
=
```
```python
torch
```
```python
.
```
```python
optim
```
```python
.
```
```python
SGD
```
```python
(
```
```python
model
```
```python
.
```
```python
parameters
```
```python
(
```
```python
)
```
```python
,
```
```python
lr
```
```python
=
```
```python
learning_rate
```
```python
)
```
```python
'''
STEP 7: TRAIN THE MODEL
'''
```
```python
# Number of steps to unroll
```
```python
seq_dim
```
```python
=
```
```python
28
```
```python
iter
```
```python
=
```
```python
0
```
```python
for
```
```python
epoch
```
```python
in
```
```python
range
```
```python
(
```
```python
num_epochs
```
```python
)
```
```python
:
```
```python
for
```
```python
i
```
```python
,
```
```python
(
```
```python
images
```
```python
,
```
```python
labels
```
```python
)
```
```python
in
```
```python
enumerate
```
```python
(
```
```python
train_loader
```
```python
)
```
```python
:
```
```python
# Load images as Variable
```
```python
#######################
```
```python
#  USE GPU FOR MODEL  #
```
```python
#######################
```
```python
print
```
```python
(
```
```python
'orginal shape: '
```
```python
)
```
```python
print
```
```python
(
```
```python
images
```
```python
.
```
```python
shape
```
```python
)
```
```python
print
```
```python
(
```
```python
labels
```
```python
.
```
```python
shape
```
```python
)
```
```python
if
```
```python
torch
```
```python
.
```
```python
cuda
```
```python
.
```
```python
is_available
```
```python
(
```
```python
)
```
```python
:
```
```python
images
```
```python
=
```
```python
Variable
```
```python
(
```
```python
images
```
```python
.
```
```python
view
```
```python
(
```
```python
-
```
```python
1
```
```python
,
```
```python
seq_dim
```
```python
,
```
```python
input_dim
```
```python
)
```
```python
.
```
```python
cuda
```
```python
(
```
```python
)
```
```python
)
```
```python
#print(images.shape)
```
```python
labels
```
```python
=
```
```python
Variable
```
```python
(
```
```python
labels
```
```python
.
```
```python
cuda
```
```python
(
```
```python
)
```
```python
)
```
```python
else
```
```python
:
```
```python
images
```
```python
=
```
```python
Variable
```
```python
(
```
```python
images
```
```python
.
```
```python
view
```
```python
(
```
```python
-
```
```python
1
```
```python
,
```
```python
seq_dim
```
```python
,
```
```python
input_dim
```
```python
)
```
```python
)
```
```python
labels
```
```python
=
```
```python
Variable
```
```python
(
```
```python
labels
```
```python
)
```
```python
print
```
```python
(
```
```python
'after shape: '
```
```python
)
```
```python
print
```
```python
(
```
```python
images
```
```python
.
```
```python
shape
```
```python
)
```
```python
print
```
```python
(
```
```python
labels
```
```python
.
```
```python
shape
```
```python
)
```
```python
# Clear gradients w.r.t. parameters
```
```python
optimizer
```
```python
.
```
```python
zero_grad
```
```python
(
```
```python
)
```
```python
# Forward pass to get output/logits
```
```python
# outputs.size() --> 100, 10
```
```python
outputs
```
```python
=
```
```python
model
```
```python
(
```
```python
images
```
```python
)
```
```python
print
```
```python
(
```
```python
outputs
```
```python
.
```
```python
shape
```
```python
)
```
```python
# Calculate Loss: softmax --> cross entropy loss
```
```python
loss
```
```python
=
```
```python
criterion
```
```python
(
```
```python
outputs
```
```python
,
```
```python
labels
```
```python
)
```
```python
# Getting gradients w.r.t. parameters
```
```python
loss
```
```python
.
```
```python
backward
```
```python
(
```
```python
)
```
```python
# Updating parameters
```
```python
optimizer
```
```python
.
```
```python
step
```
```python
(
```
```python
)
```
```python
iter
```
```python
+=
```
```python
1
```
```python
if
```
```python
iter
```
```python
%
```
```python
500
```
```python
==
```
```python
0
```
```python
:
```
```python
# Calculate Accuracy
```
```python
correct
```
```python
=
```
```python
0
```
```python
total
```
```python
=
```
```python
0
```
```python
# Iterate through test dataset
```
```python
for
```
```python
images
```
```python
,
```
```python
labels
```
```python
in
```
```python
test_loader
```
```python
:
```
```python
#######################
```
```python
#  USE GPU FOR MODEL  #
```
```python
#######################
```
```python
if
```
```python
torch
```
```python
.
```
```python
cuda
```
```python
.
```
```python
is_available
```
```python
(
```
```python
)
```
```python
:
```
```python
images
```
```python
=
```
```python
Variable
```
```python
(
```
```python
images
```
```python
.
```
```python
view
```
```python
(
```
```python
-
```
```python
1
```
```python
,
```
```python
seq_dim
```
```python
,
```
```python
input_dim
```
```python
)
```
```python
.
```
```python
cuda
```
```python
(
```
```python
)
```
```python
)
```
```python
else
```
```python
:
```
```python
images
```
```python
=
```
```python
Variable
```
```python
(
```
```python
images
```
```python
.
```
```python
view
```
```python
(
```
```python
-
```
```python
1
```
```python
,
```
```python
seq_dim
```
```python
,
```
```python
input_dim
```
```python
)
```
```python
)
```
```python
# Forward pass only to get logits/output
```
```python
outputs
```
```python
=
```
```python
model
```
```python
(
```
```python
images
```
```python
)
```
```python
# Get predictions from the maximum value
```
```python
_
```
```python
,
```
```python
predicted
```
```python
=
```
```python
torch
```
```python
.
```
```python
max
```
```python
(
```
```python
outputs
```
```python
.
```
```python
data
```
```python
,
```
```python
1
```
```python
)
```
```python
# Total number of labels
```
```python
total
```
```python
+=
```
```python
labels
```
```python
.
```
```python
size
```
```python
(
```
```python
0
```
```python
)
```
```python
# Total correct predictions
```
```python
#######################
```
```python
#  USE GPU FOR MODEL  #
```
```python
#######################
```
```python
if
```
```python
torch
```
```python
.
```
```python
cuda
```
```python
.
```
```python
is_available
```
```python
(
```
```python
)
```
```python
:
```
```python
correct
```
```python
+=
```
```python
(
```
```python
predicted
```
```python
.
```
```python
cpu
```
```python
(
```
```python
)
```
```python
==
```
```python
labels
```
```python
.
```
```python
cpu
```
```python
(
```
```python
)
```
```python
)
```
```python
.
```
```python
sum
```
```python
(
```
```python
)
```
```python
else
```
```python
:
```
```python
correct
```
```python
+=
```
```python
(
```
```python
predicted
```
```python
==
```
```python
labels
```
```python
)
```
```python
.
```
```python
sum
```
```python
(
```
```python
)
```
```python
accuracy
```
```python
=
```
```python
100
```
```python
*
```
```python
correct
```
```python
/
```
```python
total
```
```python
# Print Loss
```
```python
print
```
```python
(
```
```python
'Iteration: {}. Loss: {}. Accuracy: {}'
```
```python
.
```
```python
format
```
```python
(
```
```python
iter
```
```python
,
```
```python
loss
```
```python
.
```
```python
data
```
```python
[
```
```python
0
```
```python
]
```
```python
,
```
```python
accuracy
```
```python
)
```
```python
)
```
输出测试形状：
```python
orginal shape
```
```python
:
```
```python
torch
```
```python
.
```
```python
Size
```
```python
(
```
```python
[
```
```python
64
```
```python
,
```
```python
1
```
```python
,
```
```python
28
```
```python
,
```
```python
28
```
```python
]
```
```python
)
```
```python
#images
```
```python
torch
```
```python
.
```
```python
Size
```
```python
(
```
```python
[
```
```python
64
```
```python
]
```
```python
)
```
```python
#labels
```
```python
after shape
```
```python
:
```
```python
torch
```
```python
.
```
```python
Size
```
```python
(
```
```python
[
```
```python
64
```
```python
,
```
```python
28
```
```python
,
```
```python
28
```
```python
]
```
```python
)
```
```python
#images
```
```python
torch
```
```python
.
```
```python
Size
```
```python
(
```
```python
[
```
```python
64
```
```python
]
```
```python
)
```
```python
#labels
```
```python
torch
```
```python
.
```
```python
Size
```
```python
(
```
```python
[
```
```python
64
```
```python
,
```
```python
10
```
```python
]
```
```python
)
```
```python
#outputs
```
参考文献：
[https://github.com/MagaliDrumare/How-to-learn-PyTorch-NN-CNN-RNN-LSTM](https://github.com/MagaliDrumare/How-to-learn-PyTorch-NN-CNN-RNN-LSTM)

