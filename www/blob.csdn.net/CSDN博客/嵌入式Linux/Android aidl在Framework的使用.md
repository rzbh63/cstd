
# Android aidl在Framework的使用 - 嵌入式Linux - CSDN博客

2016年01月14日 19:51:21[写代码的篮球球痴](https://me.csdn.net/weiqifa0)阅读数：2139



## 为何要做这个
**我要在framework的PhoneWindowManager.java里面调用LightService.java里面的函数，用来做灯光的提示之类的，为何我要在PhoneWindowManager.java里面加这个呢，这里就不做讨论了，但是直接调用哪些接口是不行的，所以就引进了ipc通信，所以就有了我这篇博客，这其中有个安卓的大神朋友帮我解惑了很多问题**
**Aidl 和ipc通信之类的我就不讲了，我永远都是实践家，而且我的专长是linux驱动，这个东西也是现在慢慢负责公司产品framework 需要做的才去学习的**
要做的文件修改如下：
[补丁链接 说明一下是Android 4.4的](http://download.csdn.net/detail/weiqifa0/9404413)
```python
Changes not staged
```
```python
for
```
```python
commit:
  (
```
```python
use
```
```python
"git add <file>..."
```
```python
to
```
```python
update what will be committed)
  (
```
```python
use
```
```python
"git checkout -- <file>..."
```
```python
to
```
```python
discard changes
```
```python
in
```
```python
working directory)
    modified:   frameworks/
```
```python
base
```
```python
/Android.mk
    modified:   frameworks/
```
```python
base
```
```python
/core/java/android/app/ContextImpl.java
    modified:   frameworks/
```
```python
base
```
```python
/core/java/android/content/Context.java
    modified:   frameworks/
```
```python
base
```
```python
/core/java/android/content/ContextWrapper.java
    modified:   frameworks/
```
```python
base
```
```python
/policy/src/com/android/
```
```python
internal
```
```python
/policy/impl/PhoneWindowManager.java
    modified:   frameworks/
```
```python
base
```
```python
/services/java/com/android/server/SystemServer.java
    modified:   frameworks/
```
```python
base
```
```python
/test-runner/src/android/test/mock/MockContext.java
    modified:   frameworks/
```
```python
base
```
```python
/tools/layoutlib/bridge/src/com/android/layoutlib/bridge/android/BridgeContext.java
    modified:   kernel/mediatek/custom/out
    modified:   mediatek/misc/ota_scatter.txt
Untracked files:
  (
```
```python
use
```
```python
"git add <file>..."
```
```python
to
```
```python
include
```
```python
in
```
```python
what will be committed)
    bootable/bootloader/lk/out
    frameworks/
```
```python
base
```
```python
/core/java/android/content/pm/ILightManager.aidl
    frameworks/
```
```python
base
```
```python
/core/java/android/content/pm/LightManager.java
    frameworks/
```
```python
base
```
```python
/services/java/com/android/server/LightManagerService.java
```
## 第一步：加入aidl文件
```python
frameworks/
```
```python
base
```
```python
/core/java/android/content/pm/ILightManager.aidl
    frameworks/
```
```python
base
```
```python
/core/java/android/content/pm/LightManager.java
```
```python
//在app里面这个东西是自动生成的，但是这个这个是手动写出来的
```
## 第二步：加入service相关的文件还有
```python
frameworks/base/services/java/
```
```python
com
```
```python
/android/server/LightManagerService
```
```python
.java
```
## 第三步：加入注册需要的一些代码
```python
modified
```
```python
:
```
```python
frameworks/base/Android.mk
```
```python
modified
```
```python
:
```
```python
frameworks/base/core/java/android/app/ContextImpl.java
```
```python
modified
```
```python
:
```
```python
frameworks/base/core/java/android/content/Context.java
```
```python
modified
```
```python
:
```
```python
frameworks/base/core/java/android/content/ContextWrapper.java
```
```python
modified
```
```python
:
```
```python
frameworks/base/policy/src/com/android/internal/policy/impl/PhoneWindowManager.java
```
```python
modified
```
```python
:
```
```python
frameworks/base/services/java/com/android/server/SystemServer.java
```
```python
modified
```
```python
:
```
```python
frameworks/base/test-runner/src/android/test/mock/MockContext.java
```
```python
modified
```
```python
:
```
```python
frameworks/base/tools/layoutlib/bridge/src/com/android/layoutlib/bridge/android/BridgeContext.java
```
## 第四步：在PhoneWindowManager.java加入调用代码
```python
--- a/frameworks/base/policy/src/com/android/internal/policy/impl/PhoneWindowManager.java
+++ b/frameworks/base/policy/src/com/android/internal/policy/impl/PhoneWindowManager.java
@@ -
```
```python
37
```
```python
,
```
```python
6
```
```python
+
```
```python
37
```
```python
,
```
```python
7
```
```python
@@
```
```python
import
```
```python
android.content.IntentFilter;
```
```python
import
```
```python
android.content.ServiceConnection;
```
```python
import
```
```python
android.content.pm.ApplicationInfo;
```
```python
import
```
```python
android.content.pm.ActivityInfo;
+
```
```python
import
```
```python
android.content.pm.LightManager;
```
```python
import
```
```python
android.content.pm.PackageManager;
```
```python
import
```
```python
android.content.pm.ResolveInfo;
```
```python
import
```
```python
android.content.res.CompatibilityInfo;
@@ -
```
```python
252
```
```python
,
```
```python
6
```
```python
+
```
```python
253
```
```python
,
```
```python
7
```
```python
@@
```
```python
public
```
```python
class
```
```python
PhoneWindowManager
```
```python
implements
```
```python
WindowManagerPolicy
```
```python
{
```
```python
IWindowManager mWindowManager;
     WindowManagerFuncs mWindowManagerFuncs;
     PowerManager mPowerManager;
+
```
```python
//AlarmManagerService mAlarmManagerService;//weiqifa
```
```python
IStatusBarService mStatusBarService;
```
```python
boolean
```
```python
mPreloadedRecentApps;
```
```python
final
```
```python
Object mServiceAquireLock =
```
```python
new
```
```python
Object();
@@ -
```
```python
1019
```
```python
,
```
```python
8
```
```python
+
```
```python
1021
```
```python
,
```
```python
6
```
```python
@@
```
```python
public
```
```python
class
```
```python
PhoneWindowManager
```
```python
implements
```
```python
WindowManagerPolicy
```
```python
{
```
```python
mPowerManager = (PowerManager)context.getSystemService(Context.POWER_SERVICE);
-                               
-
         mBroadcastWakeLock = mPowerManager.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK,
```
```python
"PhoneWindowManager.mBroadcastWakeLock"
```
```python
);
         mEnableShiftMenuBugReports =
```
```python
"1"
```
```python
.equals(SystemProperties.get(
```
```python
"ro.debuggable"
```
```python
));
@@ -
```
```python
2256
```
```python
,
```
```python
41
```
```python
+
```
```python
2256
```
```python
,
```
```python
19
```
```python
@@
```
```python
public
```
```python
class
```
```python
PhoneWindowManager
```
```python
implements
```
```python
WindowManagerPolicy
```
```python
{
```
```python
}
```
```python
if
```
```python
(keyCode == KeyEvent.KEYCODE_HDYRODENT)
         {
-
```
```python
if
```
```python
(down)
-            {
+
```
```python
if
```
```python
(down){
+                LightManager a = mContext.getLightManager();
+                a.addStudent(
```
```python
"12312345678"
```
```python
);
+                Log.d(TAG,
```
```python
"--------------------------->mLightManager is null "
```
```python
);
                 Log.d(TAG,
```
```python
"key mode m is pressed!!!!"
```
```python
);
                 Intent intent =
```
```python
new
```
```python
Intent(
```
```python
"com.key.android.KEY_M_ACTION_DOWM"
```
```python
);
                 mContext.sendBroadcast(intent);
-            }
-
```
```python
else
```
```python
-            {
+            }
```
```python
else
```
```python
{
                 Log.d(TAG,
```
```python
"key mode m is released!!!!"
```
```python
);
                 Intent intent =
```
```python
new
```
```python
Intent(
```
```python
"com.key.android.KEY_M_ACTION_UP"
```
```python
);
                 mContext.sendBroadcast(intent);
             }
         }
```
## 第五步：查看日志
```python
D/ADB_SERVICES(
```
```python
222):
```
```python
read_data=8892
```
```python
W/LightManagerService(
```
```python
597):
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
>
```
```python
testLightManagerService
```
```python
<
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
12312345678
```
```python
D/ADB_SERVICES(
```
```python
222):
```
```python
max_read_time=0
```
```python
.
```
```python
000265
```
```python
max_send_time=0
```
```python
.
```
```python
001093
```
```python
W/LightManagerService(
```
```python
597):
```
```python
<
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
>
```
```python
testLightManagerService
```
```python
<
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
-
```
```python
>
```
```python
12312345678
```

